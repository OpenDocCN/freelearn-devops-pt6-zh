<html><head></head><body>
		<div id="_idContainer037">
			<h1 id="_idParaDest-48" class="chapter-number"><a id="_idTextAnchor047"/>3</h1>
			<h1 id="_idParaDest-49"><a id="_idTextAnchor048"/>Building Your First EKS Cluster</h1>
			<p>In the previous chapters, we talked about Kubernetes and EKS in detail. In this chapter, we will begin to explore how to configure and build a <span class="No-Break">basic cluster.</span></p>
			<p>Although EKS is a managed service from AWS, there are a number of ways you can create the cluster, using the console, <strong class="bold">Command-Line Interface</strong> (<strong class="bold">CLI</strong>), and <strong class="bold">Infrastructure as Code</strong> (<strong class="bold">IaC</strong>). There are also different configurations that can be applied to a cluster, including networking, storage, and application configurations. This chapter will focus on the prerequisites for building a cluster along with the basic configuration you need to build a cluster. Specifically, we will cover the <span class="No-Break">following topics:</span></p>
			<ul>
				<li>Understanding the prerequisites for building an <span class="No-Break">EKS cluster</span></li>
				<li>Understanding the different configuration options for an <span class="No-Break">EKS cluster</span></li>
				<li>Enumerating the <span class="No-Break">automation options</span></li>
				<li>Creating your first <span class="No-Break">EKS cluster</span></li>
			</ul>
			<p>Let’s begin by looking at what needs to be done before creating your <span class="No-Break">first cluster.</span></p>
			<h1 id="_idParaDest-50"><a id="_idTextAnchor049"/>Technical requirements</h1>
			<p>You should have a familiarity with cloud automation, ideally CloudFormation, and some experience with programming languages or <span class="No-Break">software development.</span></p>
			<p>In order to follow along, you will also need an AWS account to be able to launch EKS resources. If you don’t have an account, please go to AWS and create <span class="No-Break">one: </span><a href="https://aws.amazon.com/"><span class="No-Break">https://aws.amazon.com/</span></a><span class="No-Break">.</span></p>
			<p class="callout-heading">Important note</p>
			<p class="callout">These activities will result in AWS charges, so please make sure to delete all resources after you have <span class="No-Break">built them.</span></p>
			<h1 id="_idParaDest-51"><a id="_idTextAnchor050"/>Understanding the prerequisites for building an EKS cluster</h1>
			<p>By default, the email <a id="_idIndexMarker089"/>address and password used to create the AWS account are the root user’s, and they have privileges to do everything in the AWS Account. AWS best practice is to <a id="_idIndexMarker090"/>enable <strong class="bold">Multi-Factor Authentication</strong> (<strong class="bold">MFA</strong>) on this account and <em class="italic">never</em> use this account other than in <span class="No-Break">an emergency.</span></p>
			<p>The following list of activities need to be performed once you have an AWS account and the root user access credentials prior to creating an <span class="No-Break">EKS cluster:</span></p>
			<ol>
				<li>Configure your AWS CLI environment with temporary <span class="No-Break">root credentials.</span></li>
				<li>As the root user, <span class="No-Break">you should:</span><ol><li>Create an EKS admin policy, using the least privileges that can be used to deploy and manage <span class="No-Break">EKS clusters</span></li><li>Create an EKS cluster Admin group and assign the EKS Admin role to <span class="No-Break">that group</span></li><li>Create a new user and add them to the EKS cluster <span class="No-Break">Admin group</span></li><li>Create the access credentials and add them to your AWS <span class="No-Break">CLI configuration</span></li></ol></li>
				<li>Install kubectl on your workstation using the following <span class="No-Break">guide: </span><a href="https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html"><span class="No-Break">https://docs.aws.amazon.com/eks/latest/userguide/install-kubectl.html</span></a><span class="No-Break">.</span></li>
			</ol>
			<h2 id="_idParaDest-52"><a id="_idTextAnchor051"/>Configure your AWS CLI environment with temporary root credentials</h2>
			<p>Normally<a id="_idIndexMarker091"/> you <a id="_idIndexMarker092"/>would <a id="_idIndexMarker093"/>simply run the <strong class="source-inline">$ aws configure</strong> command, which will ask you for the default access credentials, region, and output format, but we don’t want to persist the root credentials, so we will use environment variables to hold <span class="No-Break">them temporarily:</span></p>
			<pre class="console">
export AWS_ACCESS_KEY_ID=&lt;root access key&gt;
export AWS_SECRET_ACCESS_KEY=&lt;root secret access key&gt;
export AWS_DEFAULT_REGION=&lt;working region&gt;</pre>
			<h2 id="_idParaDest-53"><a id="_idTextAnchor052"/>Create the EKS Admin policy</h2>
			<p>The easiest<a id="_idIndexMarker094"/> way to provide the right permissions to the EKS <a id="_idIndexMarker095"/>administrator is to grant them access to the AWS-managed <strong class="source-inline">AdministratorAccess</strong> managed role. You can get the unique identity for the<a id="_idIndexMarker096"/> role <strong class="bold">AWS Resource Name</strong> (<strong class="bold">ARN</strong>) using the <span class="No-Break">following command:</span></p>
			<pre class="console">
$ export EKSARN=$(aws iam list-policies --query 'Policies[?PolicyName==`AdministratorAccess`].{ARN:Arn}' --output text)</pre>
			<p>The <strong class="source-inline">AdministratorAccess</strong> role is very broad and allows the resource assigned the permission, the principal, with a lot of privileges that are not needed. Ideally, the EKS admin role that is created has reduced permissions, defined in the least-privilege security model. Creating this role is quite complex as it requires multiple resource permissions. The following table lists the minimum permissions you need for EC2, EKS, KMS, and IAM. However, you may need to add permissions to this role if you need to create a VPC/subnets, <span class="No-Break">for example.</span></p>
			<table id="table001-2" class="No-Table-Style _idGenTablePara-1">
				<colgroup>
					<col/>
					<col/>
				</colgroup>
				<thead>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><strong class="bold">AWS </strong><span class="No-Break"><strong class="bold">Resource</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p><strong class="bold">Minimal </strong><span class="No-Break"><strong class="bold">Permission Set</strong></span></p>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">EC2 API</span></p>
						</td>
						<td class="No-Table-Style">
							<p><strong class="source-inline">"ec2:RunInstances"</strong>, <strong class="source-inline">"ec2:RevokeSecurityGroupIngress"</strong>,<strong class="source-inline"> "ec2:RevokeSecurityGroupEgress"</strong>,<strong class="source-inline"> "ec2:DescribeRegions"</strong>, <strong class="source-inline">"ec2:DescribeVpcs"</strong>,<strong class="source-inline"> "ec2:DescribeTags"</strong>, <strong class="source-inline">"ec2:DescribeSubnets"</strong>, <strong class="source-inline">"ec2:DescribeSecurityGroups"</strong>, <strong class="source-inline">"ec2:DescribeRouteTables"</strong>,<strong class="source-inline">"ec2:DescribeLaunchTemplateVersions"</strong>, <strong class="source-inline">"ec2:DescribeLaunchTemplates"</strong>, <strong class="source-inline">"ec2:DescribeKeyPairs"</strong>, <strong class="source-inline">"ec2:DescribeInternetGateways"</strong>, <strong class="source-inline">"ec2:DescribeImages"</strong>, <strong class="source-inline">"ec2:DescribeAvailabilityZones"</strong>, <strong class="source-inline">"ec2:DescribeAccountAttributes"</strong>, <strong class="source-inline">"ec2:DeleteTags","ec2:DeleteSecurityGroup"</strong>, <strong class="source-inline">"ec2:DeleteKeyPair"</strong>, <strong class="source-inline">"ec2:CreateTags"</strong>, <strong class="source-inline">"ec2:CreateSecurityGroup"</strong>, <strong class="source-inline">"ec2:CreateLaunchTemplateVersion"</strong>, <strong class="source-inline">"ec2:CreateLaunchTemplate"</strong>, <strong class="source-inline">"ec2:CreateKeyPair"</strong>, <strong class="source-inline">"</strong><span class="No-Break"><strong class="source-inline">ec2:AuthorizeSecurityGroupIngress"</strong></span><span class="No-Break">, </span><span class="No-Break"><strong class="source-inline">"ec2:AuthorizeSecurity</strong></span><strong class="source-inline">
</strong><span class="No-Break"><strong class="source-inline">GroupEgress"</strong></span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">EKS API</span></p>
						</td>
						<td class="No-Table-Style">
							<p><strong class="source-inline">"eks:UpdateNodegroupVersion"</strong>, <strong class="source-inline">"eks:UpdateNodegroupConfig"</strong>, <strong class="source-inline">"eks:UpdateClusterVersion"</strong>, <strong class="source-inline">"eks:UpdateClusterConfig"</strong>, <strong class="source-inline">"eks:UntagResource"</strong>, <strong class="source-inline">"eks:TagResource"</strong>, <strong class="source-inline">"eks:ListUpdates"</strong>,<strong class="source-inline"> "eks:ListTagsForResource"</strong>, <strong class="source-inline">"eks:ListNodegroups"</strong>, <strong class="source-inline">"eks:ListFargateProfiles"</strong>, <strong class="source-inline">"eks:ListClusters"</strong>, <strong class="source-inline">"eks:DescribeUpdate"</strong>, <strong class="source-inline">"eks:DescribeNodegroup"</strong>,<strong class="source-inline"> "eks:DescribeFargateProfile"</strong>, <strong class="source-inline">"eks:DescribeCluster"</strong>, <strong class="source-inline">"eks:DeleteNodegroup"</strong>, <strong class="source-inline">"eks:DeleteFargateProfile"</strong>, <strong class="source-inline">"eks:DeleteCluster"</strong>, <strong class="source-inline">"eks:CreateNodegroup"</strong>, <strong class="source-inline">"</strong><span class="No-Break"><strong class="source-inline">eks:CreateFargateProfile"</strong></span><span class="No-Break">, </span><span class="No-Break"><strong class="source-inline">"eks:CreateCluster"</strong></span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">KMS API</span></p>
						</td>
						<td class="No-Table-Style">
							<p><strong class="source-inline">"</strong><span class="No-Break"><strong class="source-inline">kms:ListKeys"</strong></span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">IAM API</span></p>
						</td>
						<td class="No-Table-Style">
							<p><strong class="source-inline">"iam:PassRole"</strong>, <strong class="source-inline">"iam:ListRoles"</strong>, <strong class="source-inline">"iam:ListRoleTags"</strong>, <strong class="source-inline">"iam:ListInstanceProfilesForRole"</strong>, <strong class="source-inline">"iam:ListInstanceProfiles"</strong>, <strong class="source-inline">"iam:ListAttachedRolePolicies"</strong>, <strong class="source-inline">"iam:GetRole"</strong>, <strong class="source-inline">"iam:GetInstanceProfile"</strong>, <strong class="source-inline">"iam:DetachRolePolicy"</strong>, <strong class="source-inline">"iam:DeleteRole"</strong>, <strong class="source-inline">"</strong><span class="No-Break"><strong class="source-inline">iam:CreateRole"</strong></span><span class="No-Break">, </span><span class="No-Break"><strong class="source-inline">"iam:AttachRolePolicy"</strong></span></p>
						</td>
					</tr>
				</tbody>
			</table>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 3.1 – EKS Admin example privileges</p>
			<p>Once you have<a id="_idIndexMarker097"/> the desired permissions set, you can create a <a id="_idIndexMarker098"/>policy document. A JSON example is shown in the following snippet with just the KMS permission included <span class="No-Break">for simplicity:</span></p>
			<pre class="source-code">
{    "Version": "2012-10-17",
    "Statement": [
        {"Sid": "KMSPermisssions",
            "Effect": "Allow",
            "Action": ["kms:ListKeys"],
            "Resource": "*"
        }]}</pre>
			<p>Using the <strong class="source-inline">aws iam create-policy --policy-name bespoke-eks-policy --policy-document file://&lt;mypolicyfile.json&gt;</strong> command to create the IAM policy based on the JSON file you have created, you can then retrieve<a id="_idIndexMarker099"/> the <a id="_idIndexMarker100"/>ARN using the <span class="No-Break">following command:</span></p>
			<pre class="console">
$ export EKSARN=$(aws iam list-policies --query 'Policies[?PolicyName==`bespoke-eks-policy`].{ARN:Arn}' --output text)</pre>
			<h2 id="_idParaDest-54"><a id="_idTextAnchor053"/>Create the EKS Admin group</h2>
			<p>Creating <a id="_idIndexMarker101"/>the<a id="_idIndexMarker102"/> group using the CLI is pretty straightforward, <span class="No-Break">using this:</span></p>
			<pre class="console">
$ aws iam create-group --group-name EKS-Admins.</pre>
			<p>You then need to attach the policy created in the previous step <span class="No-Break">using this:</span></p>
			<pre class="console">
$ aws iam attach-group-policy --policy-arn $EKSARN --group-name EKS-Admins.</pre>
			<h2 id="_idParaDest-55"><a id="_idTextAnchor054"/>Create a new user</h2>
			<p>Now we have<a id="_idIndexMarker103"/> the permissions, and the group has been created, we can create a new user and assign it to the group using the <span class="No-Break">following command:</span></p>
			<pre class="console">
$ aws iam create-user --user-name &lt;MYUSERNAME&gt;</pre>
			<p>You can then add the user you just created to the group <span class="No-Break">using this:</span></p>
			<pre class="console">
$ aws iam add-user-to-group --user-name &lt;MYUSERNAME&gt; --group-name EKS-Admins</pre>
			<p>You will also need to create a password <span class="No-Break">using this:</span></p>
			<pre class="console">
$ aws iam update-login-profile --user-name &lt;MYUSERNAME&gt; --password &lt;password&gt;</pre>
			<p>You now need to create access credentials and store them using <span class="No-Break">the following:</span></p>
			<pre class="console">
$ aws iam create-access-key --user-name &lt;MYUSERNAME&gt;
{ "AccessKey": {
        "UserName": "&lt;MYUSERNAME&gt;",
        "Status": "Active",
        "CreateDate": "2022-08-19T11:01:07Z",
        "SecretAccessKey": "67ghjghjhjihk",
        "AccessKeyId": "hgjgjgjhgjhgj"}}</pre>
			<p>You should copy the credentials (<strong class="source-inline">SecretAccessKey</strong> and <strong class="source-inline">AccessKeyId</strong>) output from this command, add them to your CLI configuration using the <strong class="source-inline">$aws configure</strong> command, and use this account/credentials for the remainder of <span class="No-Break">the examples.</span></p>
			<p class="callout-heading">Important note</p>
			<p class="callout">You still need to grant console access. Please refer to this <span class="No-Break">link: </span><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/console_controlling-access.html"><span class="No-Break">https://docs.aws.amazon.com/IAM/latest/UserGuide/console_controlling-access.html</span></a><span class="No-Break">.</span></p>
			<p class="callout">You should also enable MFA. Please refer to this <span class="No-Break">link: </span><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html"><span class="No-Break">https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html</span></a><span class="No-Break">.</span></p>
			<p>Now that we have<a id="_idIndexMarker104"/> all the prerequisites in place, we need to consider how we configure the <span class="No-Break">EKS cluster.</span></p>
			<h1 id="_idParaDest-56"><a id="_idTextAnchor055"/>Understanding the different configuration options for an EKS cluster</h1>
			<p>Kubernetes is <a id="_idIndexMarker105"/>extensible by default, which is one of the reasons it has become so popular. As well as the standard API objects we’ve already discussed such as <strong class="bold">Pods</strong> <a id="_idIndexMarker106"/>and <strong class="bold">Services</strong>, you can extend the API to support custom resources, controllers, operators, and standard plugins for networking and storage. All of these elements can be added to an EKS cluster as part of the cluster creation process; however, in this chapter, we will cover the basic configuration to get a simple cluster up and running. The following table defines what will be configured as well as providing a <a id="_idIndexMarker107"/>map to other chapters that show additional <span class="No-Break">configuration steps:</span></p>
			<table id="table002" class="No-Table-Style _idGenTablePara-1">
				<colgroup>
					<col/>
					<col/>
				</colgroup>
				<thead>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><strong class="bold">EKS </strong><span class="No-Break"><strong class="bold">Configuration Domain</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break"><strong class="bold">Description</strong></span></p>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Control plane</span></p>
						</td>
						<td class="No-Table-Style">
							<p>As we have mentioned, EKS is really a managed control plane, so this must always be done, and the next sections will focus on <span class="No-Break">creating this.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Basic networking</span></p>
						</td>
						<td class="No-Table-Style">
							<p>We will cover this briefly in this section using the default AWS EKS VPC plugin (CNI), but it’s covered in more detail in <a href="B18129_07.xhtml#_idTextAnchor107"><span class="No-Break"><em class="italic">Chapter 7</em></span></a><span class="No-Break">.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p>Base <span class="No-Break">node group</span></p>
						</td>
						<td class="No-Table-Style">
							<p>In the next section, we will create a small node group on EC2 resources to host key cluster resources such as the VPC <span class="No-Break">network plugin.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p>Pod <span class="No-Break">storage services</span></p>
						</td>
						<td class="No-Table-Style">
							<p>We won’t cover this in this section but will go into more detail in <a href="B18129_12.xhtml#_idTextAnchor175"><span class="No-Break"><em class="italic">Chapter 12</em></span></a><span class="No-Break">.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p>Additional <span class="No-Break">node groups</span></p>
						</td>
						<td class="No-Table-Style">
							<p>We won’t cover this in this section but will go into more detail in <a href="B18129_08.xhtml#_idTextAnchor123"><span class="No-Break"><em class="italic">Chapter 8</em></span></a><span class="No-Break">.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Fargate profiles</span></p>
						</td>
						<td class="No-Table-Style">
							<p>We won’t cover this in this section but will go into more detail in <a href="B18129_15.xhtml#_idTextAnchor220"><span class="No-Break"><em class="italic">Chapter 15</em></span></a><span class="No-Break">.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Kubernetes applications</span></p>
						</td>
						<td class="No-Table-Style">
							<p>We won’t cover this in this section but will go into more detail in <em class="italic">Chapters 11</em>, <em class="italic">13</em>, <span class="No-Break">and </span><span class="No-Break"><em class="italic">14</em></span><span class="No-Break">.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p>Advanced <span class="No-Break">networking concepts</span></p>
						</td>
						<td class="No-Table-Style">
							<p>We won’t cover this in this section but will go into more detail in <a href="B18129_08.xhtml#_idTextAnchor123"><span class="No-Break"><em class="italic">Chapter 8</em></span></a><span class="No-Break">.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break">Service mesh</span></p>
						</td>
						<td class="No-Table-Style">
							<p>We won’t cover this in this section but will go into more detail in <a href="B18129_16.xhtml#_idTextAnchor232"><span class="No-Break"><em class="italic">Chapter 16</em></span></a><span class="No-Break">.</span></p>
						</td>
					</tr>
				</tbody>
			</table>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 3.2 – EKS configuration areas</p>
			<p>Before we actually create a cluster that is composed of a managed control plane, basic networking, and a base node group, let’s review the different ways we can approach deploying and <a id="_idIndexMarker108"/>automating it and why you would choose one over <span class="No-Break">the others.</span></p>
			<h1 id="_idParaDest-57"><a id="_idTextAnchor056"/>Enumerating the automation options</h1>
			<p>The following<a id="_idIndexMarker109"/> diagram (<span class="No-Break"><em class="italic">Figure 3</em></span><em class="italic">.1</em>) illustrates the evolution of infrastructure automation in AWS. Most users start off with manual configuration using playbooks or wikis and the AWS console. The challenge with this is it’s difficult to repeat, and if you need to change or add something, you need to do <span class="No-Break">it manually.</span></p>
			<p>The next step is to then use shell scripts to automate the deployment of AWS resources using, for example, the AWS CLI. This is not perfect because if you run the same command twice you can get different results. Thus, the AWS CLI is not (necessarily) idempotent. So, in 2011, AWS released CloudFormation, an IaC framework that can safely create <span class="No-Break">infrastructure resources.</span></p>
			<div>
				<div id="_idContainer022" class="IMG---Figure">
					<img src="image/B18129_03_01.jpg" alt="Figure 3.1 ﻿– Automation options"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.1 – Automation options</p>
			<p>IaC has become best practice for deploying AWS resources, and in 2014 HashiCorp released Terraform, which has become very popular and again allows you to automate and deploy AWS resources safely. The challenge with both CloudFormation and Terraform is they have their own markup language that must be learned and can <span class="No-Break">be complex.</span></p>
			<p>Over the years, various generators have been produced that allow you to create CloudFormation and Terraform scripts without needing to understand how to write them. This concept has further been extended with abstractions such as AWS <strong class="bold">Cloud Development Kit</strong> (<strong class="bold">CDK</strong>), which <a id="_idIndexMarker110"/>allows you to generate and deploy CloudFormation using regular programming languages such as Python, Typeset, and <span class="No-Break">so on.</span></p>
			<p>In Kubernetes, this additional layer abstraction is part of the cluster with manifest, Helm charts, and Kustomize being used to abstract Kubernetes resources, and tools such as eksctl providing a simple<a id="_idIndexMarker111"/> interface for provisioning <span class="No-Break">EKS clusters.</span></p>
			<h2 id="_idParaDest-58"><a id="_idTextAnchor057"/>Which automation tool/framework should I use?</h2>
			<p>A general rule of<a id="_idIndexMarker112"/> thumb for any automation<a id="_idIndexMarker113"/> is <strong class="bold">Don’t Repeat Yourself</strong> (<strong class="bold">DRY</strong>), so if you are going to create or delete clusters on a regular basis, use automation and use the highest level of abstraction you can. Tools such as the CDK and eksctl mean you don’t have to learn CloudFormation but can still rely on <em class="italic">safe</em> deployment practices such as declarative configurations and <span class="No-Break">idempotent operations.</span></p>
			<p>Terraform supports these <em class="italic">safe</em> operations, which in addition means you can support other clouds such as Microsoft Azure and Google Cloud Platform, as well as other <span class="No-Break">on-premises resources.</span></p>
			<p>In the next section, we will show you how you can create a basic cluster using the console and AWS CLI and then simplify the operation using the following IaC Tools: Terraform, eksctl, and the <span class="No-Break">AWS CDK.</span></p>
			<h1 id="_idParaDest-59"><a id="_idTextAnchor058"/>Creating your first EKS cluster</h1>
			<p>Please verify <a id="_idIndexMarker114"/>you are using the credentials for the username you created as part of the prerequisites using the <span class="No-Break">following command:</span></p>
			<pre class="console">
$ aws sts get-caller-identity
{    "UserId": &lt;MYUSERNAME&gt;",
    "Account": "11112222333",
    "Arn": "arn:aws:sts::11112222333&lt;MYUSERNAME&gt;/IAM_ROLE&gt;"}</pre>
			<h2 id="_idParaDest-60"><a id="_idTextAnchor059"/>Option 1: Creating your EKS cluster with the AWS console</h2>
			<p>To start this <a id="_idIndexMarker115"/>exercise, open <a id="_idIndexMarker116"/>a browser, go to the URL <a href="https://aws.amazon.com/">https://aws.amazon.com/</a>, and sign in to your account using the username/credentials you created as part of <span class="No-Break">the prerequisites.</span></p>
			<p>Once you have logged in, complete the <span class="No-Break">following steps:</span></p>
			<ol>
				<li>Type <strong class="source-inline">IAM</strong> in the search bar and select <strong class="bold">IAM</strong> | <strong class="bold">Roles</strong> from the resulting <span class="No-Break">search results.</span></li>
				<li>You should now create a cluster Service role by clicking on the <strong class="bold">Create Role</strong> button, which will allow the cluster to make calls to other AWS Services. It’s a simple policy, is defined at <a href="https://docs.aws.amazon.com/eks/latest/userguide/service_IAM_role.html">https://docs.aws.amazon.com/eks/latest/userguide/service_IAM_role.html</a>, and should be linked to the AmazonEKSClusterPolicy <span class="No-Break">managed policy.</span></li>
				<li>Once the Service role has been created, select the region that you would like to launch the Amazon EKS cluster in, type <strong class="source-inline">EKS</strong> in the search bar, and select <strong class="bold">Elastic </strong><span class="No-Break"><strong class="bold">Kubernetes Service</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer023" class="IMG---Figure">
					<img src="image/B18129_03_02.jpg" alt="Figure 3.2 ﻿– Select EKS"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.2 – Select EKS</p>
			<ol>
				<li value="4">On the EKS launch screen, click on the <strong class="bold">Add cluster</strong> | <span class="No-Break"><strong class="bold">Create</strong></span><span class="No-Break"> button.</span></li>
			</ol>
			<div>
				<div id="_idContainer024" class="IMG---Figure">
					<img src="image/B18129_03_03.jpg" alt="Figure 3.3 ﻿– Add cluster"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.3 – Add cluster</p>
			<ol>
				<li value="5">On the resulting screen, enter the cluster name in the <strong class="bold">Name</strong> field, select the version of Kubernetes you want to deploy from the <strong class="bold">Kubernetes version</strong> field, select the <a id="_idIndexMarker117"/>Service<a id="_idIndexMarker118"/> role created in <em class="italic">step 2</em>, and <span class="No-Break">click </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer025" class="IMG---Figure">
					<img src="image/B18129_03_04.jpg" alt="Figure 3.3 ﻿– Configure cluster"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.3 – Configure cluster</p>
			<ol>
				<li value="6">In the first panel of the EKS networking screen, you need to select the VPC and subnets that the control plane will use as well as the security group used by any worker nodes. If these resources don’t exist, you can add them using the VPC console link (make sure you open the link in a browser tab <span class="No-Break">or window).</span></li>
			</ol>
			<div>
				<div id="_idContainer026" class="IMG---Figure">
					<img src="image/B18129_03_05.jpg" alt="Figure 3.4 ﻿– Enter VPC and security group details"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.4 – Enter VPC and security group details</p>
			<ol>
				<li value="7">In the <a id="_idIndexMarker119"/>next panel, select the type of cluster <a id="_idIndexMarker120"/>endpoint. In this example, we will keep the <strong class="bold">Public</strong> default, which means the cluster API is accessible from <span class="No-Break">the internet.</span></li>
			</ol>
			<div>
				<div id="_idContainer027" class="IMG---Figure">
					<img src="image/B18129_03_06.jpg" alt="Figure 3.5 ﻿– Cluster endpoints"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.5 – Cluster endpoints</p>
			<ol>
				<li value="8">In the final networking panel, you can leave the defaults, which relate to the Kubernetes <a id="_idIndexMarker121"/>version chosen in <em class="italic">step 5</em> and <a id="_idIndexMarker122"/><span class="No-Break">click </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer028" class="IMG---Figure">
					<img src="image/B18129_03_07.jpg" alt="Figure 3.6 ﻿– Complete networking section"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.6 – Complete networking section</p>
			<ol>
				<li value="9">Enable <strong class="bold">Audit</strong> logging to CloudWatch logs by selecting the button and <span class="No-Break">clicking </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer029" class="IMG---Figure">
					<img src="image/B18129_03_08.jpg" alt="Figure 3.7 ﻿– Control plane logging"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.7 – Control plane logging</p>
			<ol>
				<li value="10">Review<a id="_idIndexMarker123"/> your <a id="_idIndexMarker124"/>cluster settings and click the <strong class="bold">Create</strong> button. This will now take 20-30 minutes to complete and involves setting up the control plane (API and etcd servers) in an AWS-owned VPC and connecting it through <strong class="bold">Elastic Network Interfaces</strong> (<strong class="bold">ENIs</strong>) to your VPC. When it completes, you will <a id="_idIndexMarker125"/>see a new cluster with a status of <strong class="bold">Active</strong>, as shown in the <span class="No-Break">following screenshot:</span></li>
			</ol>
			<div>
				<div id="_idContainer030" class="IMG---Figure">
					<img src="image/B18129_03_09.jpg" alt="Figure 3.8 ﻿– An active cluster"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.8 – An active cluster</p>
			<ol>
				<li value="11">As this is a public cluster, you can run the <strong class="source-inline">aws eks update-kubeconfig --cluster &lt;CLUSTERNAME&gt; --region &lt;YOURREGION&gt;</strong> command to update your <strong class="source-inline">kubeconfig</strong> file. We have created an EKS control plane and set up networking but currently, we don’t have any nodes attached to it. We can validate this by using the <strong class="source-inline">kubectl get nodes</strong> command. You should get a <strong class="bold">No resources </strong><span class="No-Break"><strong class="bold">found</strong></span><span class="No-Break"> message.</span></li>
				<li>If you click on the name link of your cluster (this is <strong class="bold">mycluster</strong> in <em class="italic">step 10</em>), you will be taken to the cluster configuration screen shown in the following screenshot. Click the <strong class="bold">Compute</strong> tab, and then click on the <strong class="bold">Add node </strong><span class="No-Break"><strong class="bold">group</strong></span><span class="No-Break"> button.</span></li>
			</ol>
			<div>
				<div id="_idContainer031" class="IMG---Figure">
					<img src="image/B18129_03_10.jpg" alt="Figure 3.9 ﻿– Compute"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.9 – Compute</p>
			<ol>
				<li value="13">In the <a id="_idIndexMarker126"/>first <strong class="bold">Node group configuration</strong> panel, enter<a id="_idIndexMarker127"/> a name for the node group and an EC2 worker IAM role. If this role doesn’t exist, you can add it using the VPC console link (make sure you open the link in a browser tab or window). The role should be created in line with this <span class="No-Break">link: </span><a href="https://docs.aws.amazon.com/eks/latest/userguide/create-node-role.html"><span class="No-Break">https://docs.aws.amazon.com/eks/latest/userguide/create-node-role.html</span></a><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer032" class="IMG---Figure">
					<img src="image/B18129_03_11.jpg" alt="Figure 3.10 ﻿– Node group configuration"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.10 – Node group configuration</p>
			<ol>
				<li value="14">You can<a id="_idIndexMarker128"/> accept <a id="_idIndexMarker129"/>all the defaults in the <strong class="bold">Set compute and scaling configuration</strong> window, which will create two <strong class="source-inline">t3.medium</strong> EC2 instances in an autoscaling group <a id="_idIndexMarker130"/>using an EKS-optimized Amazon Linux <strong class="bold">operating system</strong> (<strong class="bold">OS</strong>) image. Click <span class="No-Break">on </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">.</span></li>
				<li>Select the subnets you will use for the EC2 worker nodes in your VPC; you should select at least two subnets/availability zones. <span class="No-Break">Click </span><span class="No-Break"><strong class="bold">Next</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer033" class="IMG---Figure">
					<img src="image/B18129_03_12.jpg" alt="Figure 3.11 ﻿– Node group networking"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.11 – Node group networking</p>
			<ol>
				<li value="16">Review<a id="_idIndexMarker131"/> your <a id="_idIndexMarker132"/>node group settings and click the <strong class="bold">Create</strong> button. This will now take 10-20 minutes and will create two EC2 instances and configure the Kubernetes agents (<strong class="source-inline">kubelet</strong> and <strong class="source-inline">kubeproxy</strong>) and connect back to the control plane. Once the job completes, the node group should be <strong class="bold">Active</strong> and the two EC2 instances should <span class="No-Break">be </span><span class="No-Break"><strong class="bold">Ready</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer034" class="IMG---Figure">
					<img src="image/B18129_03_13.jpg" alt="Figure 3.12 — Active node group"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.12 — Active node group</p>
			<ol>
				<li value="17">We can validate this by using the <strong class="source-inline">kubectl get nodes</strong> command. The output should now show the two nodes you have <span class="No-Break">just created.</span></li>
				<li>Once you have finished with the cluster, delete the node group, and then you can delete <span class="No-Break">the cluster.</span></li>
			</ol>
			<p class="callout-heading">Important note</p>
			<p class="callout">As the AWS console interface may be changed, if you have questions, you can always check the AWS documentation for creating the EKS cluster (<a href="https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html">https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html</a>) and for creating managed node groups (<a href="https://docs.aws.amazon.com/eks/latest/userguide/create-managed-node-group.html">https://docs.aws.amazon.com/eks/latest/userguide/create-managed-node-group.html</a>) to get the latest <span class="No-Break">updated steps.</span></p>
			<p>In this subsection, we have created a basic cluster with a managed control plane, an AWS VPC<a id="_idIndexMarker133"/> network, and a basic node group with two <a id="_idIndexMarker134"/>EC2 workers. In the next subsection, we will see how we can create the same cluster using the <span class="No-Break">AWS CLI.</span></p>
			<h2 id="_idParaDest-61"><a id="_idTextAnchor060"/>Option 2: Creating your EKS cluster with the AWS CLI</h2>
			<p>The AWS CLI is a<a id="_idIndexMarker135"/> tool for managing your AWS resources. It <a id="_idIndexMarker136"/>can be installed using this <span class="No-Break">link: </span><a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html"><span class="No-Break">https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html</span></a><span class="No-Break">.</span></p>
			<p>To create an EKS cluster using the AWS CLI, you should follow the steps <span class="No-Break">detailed here:</span></p>
			<ol>
				<li>We will reuse the cluster Service role and the same subnets used in <em class="italic">Option 1</em>. If they don’t exist, create them using the steps in <span class="No-Break"><em class="italic">Option 1</em></span><span class="No-Break">.</span></li>
				<li>You can then create the managed control plane in your account using the following commands with the username/credentials you created as part of the prerequisites. The subnets and security group can be the same ones used in <span class="No-Break"><em class="italic">Option 1</em></span><span class="No-Break">:</span><pre class="source-code">
<strong class="bold">$ aws eks create-cluster --region &lt;MYREGION&gt; --name mycluster --kubernetes-version 1.22 --role-arn &lt;MYSERVICEROLEARN&gt; --resources-vpc-config subnetIds=subnet-1,subnet-2,securityGroupIds=sg-a</strong></pre></li>
				<li>This will now take 20-30 minutes to complete and involves setting up the control plane (API and etcd<a id="_idTextAnchor061"/> servers) in an AWS-owned VPC and connecting it through ENIs to your VPC. When it completes, you will see a new cluster with a status of <strong class="bold">Active, as</strong> shown in the <span class="No-Break">following screenshot.</span></li>
			</ol>
			<div>
				<div id="_idContainer035" class="IMG---Figure">
					<img src="image/B18129_03_14.jpg" alt="Figure 3.13 ﻿– Active cluster"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.13 – Active cluster</p>
			<ol>
				<li value="4">Again, we have created an EKS control plane and set up networking but currently, we don’t have any nodes attached to it. We can validate this by using the <strong class="source-inline">kubectl get nodes</strong> command, after updating the <strong class="source-inline">kubeconfig</strong> file. You should get a <strong class="bold">No resources </strong><span class="No-Break"><strong class="bold">found</strong></span><span class="No-Break"> message.</span></li>
				<li>You can create the basic node group using the following command, which will create two t3.medium EC2 instances in an autoscaling group using an EKS-optimized <a id="_idIndexMarker137"/>Amazon Linux OS image using <a id="_idIndexMarker138"/>the EC2 role created in <span class="No-Break"><em class="italic">Option 1</em></span><span class="No-Break">.</span><pre class="source-code">
<strong class="bold">$ aws eks create-nodegroup --region &lt;MYREGION&gt;   --cluster-name mycluster --nodegroup-name basicCLI --scaling-config minSize=2,maxSize=2,desiredSize=2 --subnets subnet-1  subnet-2 --ami-type AL2_x86_64 --node-role &lt;EKSWORKERNODEROLEARN&gt;</strong></pre></li>
				<li>This will now take 10-20 minutes and will create two EC2 instances and configure the Kubernetes agents (<strong class="source-inline">kubelet</strong> and <strong class="source-inline">kubeproxy</strong>) and connect back to the control plane. Once the job completes, the node group should be <strong class="bold">Active</strong> and the two EC2 instances should <span class="No-Break">be </span><span class="No-Break"><strong class="bold">Ready</strong></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer036" class="IMG---Figure">
					<img src="image/B18129_03_15.jpg" alt="Figure 3.14 ﻿– A CLI node group"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 3.14 – A CLI node group</p>
			<ol>
				<li value="7">We can validate this by using the <strong class="source-inline">kubectl get nodes</strong> command. The output should now show the two nodes you have <span class="No-Break">just created.</span></li>
				<li>Once you have finished with the cluster, delete the node group, and then you can delete the cluster using the <span class="No-Break">following commands:</span><pre class="source-code">
<strong class="bold">$ aws eks delete-nodegroup --cluster-name &lt;CLUSTER_NAME&gt; --nodegroup-name &lt;NODEGROUP_NAME&gt; --region &lt;REGION&gt;</strong>
<strong class="bold">$aws eks delete-cluster --name &lt;CLUSTER_NAME&gt; --region &lt;REGION&gt;</strong></pre></li>
			</ol>
			<p>As you can see, this process is much simpler than clicking through the AWS console. These commands can be placed in a shell script, and you can use environment variables to parameterize the input, changing the cluster name, for example. However, it’s not guaranteed <a id="_idIndexMarker139"/>that every command is <em class="italic">safe</em> to run repeatedly, and <a id="_idIndexMarker140"/>script execution can be problematic if there are any failures. A better way is to use IaC and we will explore that over the <span class="No-Break">next subsections.</span></p>
			<h2 id="_idParaDest-62"><a id="_idTextAnchor062"/>Option 3: Creating your EKS cluster with Terraform</h2>
			<p>Terraform is <a id="_idIndexMarker141"/>an open <a id="_idIndexMarker142"/>source project created by HashiCorp and is composed of a single binary that can be used to validate, deploy, and delete (destroy) AWS infrastructure resources. You can install Terraform by following the instructions shown <span class="No-Break">at </span><a href="https://learn.hashicorp.com/tutorials/terraform/install-cli"><span class="No-Break">https://learn.hashicorp.com/tutorials/terraform/install-cli</span></a><span class="No-Break">.</span></p>
			<p>To create your first EKS cluster using Terraform, we will clone the official example containing the configuration file for creating an EKS cluster provided by HashiCorp. This is a very complete solution (creating 53 resources) and will create a new VPC, two managed worker node groups, and all the associated roles and permissions. Use the following commands to clone and change into the <span class="No-Break">cloned directory:</span></p>
			<pre class="console">
$ git clone <strong class="source-inline">https://github.com/hashicorp/learn-terraform-provision-eks-cluster</strong>
$ cd learn-terraform-provision-eks-cluster</pre>
			<p>Terraform works by aggregating all <strong class="source-inline">.tf</strong> files into a single configuration and then deploying it to AWS using your local credentials. You will need to modify certain <strong class="source-inline">.tf</strong> files for your<a id="_idIndexMarker143"/> AWS account; the following table explains<a id="_idIndexMarker144"/> <span class="No-Break">which ones:</span></p>
			<table id="table003" class="No-Table-Style _idGenTablePara-1">
				<colgroup>
					<col/>
					<col/>
				</colgroup>
				<thead>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><strong class="bold">Terraform (.</strong><span class="No-Break"><strong class="bold">tf) file</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break"><strong class="bold">Changes</strong></span></p>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><strong class="source-inline">./</strong><span class="No-Break"><strong class="source-inline">vpc.tf</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p>Change the region variable to the region you want to use, <span class="No-Break">for example:</span></p>
							<p><strong class="source-inline">variable "</strong><span class="No-Break"><strong class="source-inline">region" {</strong></span></p>
							<p>  <strong class="source-inline">default</strong>     <strong class="source-inline">= "</strong><span class="No-Break"><strong class="source-inline">eu-central-1"</strong></span></p>
							<p>  <strong class="source-inline">description = "</strong><span class="No-Break"><strong class="source-inline">AWS region"</strong></span></p>
							<p><strong class="source-inline">}</strong></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><strong class="source-inline">./</strong><span class="No-Break"><strong class="source-inline">eks-cluster.tf</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p>Change the EKS version to the desired version, <span class="No-Break">for example:</span></p>
							<p><strong class="source-inline">module "</strong><span class="No-Break"><strong class="source-inline">eks" {</strong></span></p>
							<p>        <strong class="source-inline">cluster_version = "</strong><span class="No-Break"><strong class="source-inline">1.22" }</strong></span></p>
						</td>
					</tr>
				</tbody>
			</table>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 3.3 – Terraform changes</p>
			<p>Now that you have made the changes to the Terraform files, you can create an EKS cluster and environment using Terraform. You should follow the steps <span class="No-Break">detailed here:</span></p>
			<ol>
				<li>Run the <strong class="source-inline">$ terraform init</strong> command to create the local state and download all the remote module files such as the VPC module used to create the new VPC. It can take some time to download all the module files. If this command is successful, you will see the <strong class="bold">Terraform has been successfully </strong><span class="No-Break"><strong class="bold">initialized!</strong></span><span class="No-Break"> message.</span></li>
				<li>Run the <strong class="source-inline">$ terraform plan</strong> command to see what resources will be created before actually deploying them. This is a major advantage over the console and CLI methods, as you can also use this to see what will change when you make a change to the <strong class="source-inline">.</strong><span class="No-Break"><strong class="source-inline">tf</strong></span><span class="No-Break"> files.</span></li>
				<li>Run the <strong class="source-inline">$ terraform apply -auto-approve</strong> command to create/deploy the resources. This will take 20-30 minutes to complete (so take a seat). At the end of it, you will have a new IAM role, an EKS cluster in a new VPC, new internet and NAT gateways, and two managed node groups with three <span class="No-Break">EC2 instances.</span></li>
				<li>In this option, we have actually created managed node groups, which we can validate by using the <strong class="source-inline">$ kubectl get nodes</strong> command. After updating the <strong class="source-inline">kubeconfig</strong> file, you will see three <span class="No-Break">worker nodes.</span></li>
				<li>Once you have finished with the cluster, use the <strong class="source-inline">$ terraform destroy -auto-approve</strong> command to delete all resources. Terraform will automatically figure out the order <span class="No-Break">of deletion.</span></li>
			</ol>
			<p>As you can see, Terraform is a very powerful tool and simplifies the way you configure and deploy <a id="_idIndexMarker145"/>resources. You still have to configure or<a id="_idIndexMarker146"/> create the Terraform modules, which in turn requires you to learn the Terraform syntax and <span class="No-Break">markup language.</span></p>
			<p>In the next subsection, we will see how you can use eksctl to create an EKS cluster using CloudFormation under the covers without learning any <span class="No-Break">CloudFormation syntax.</span></p>
			<h2 id="_idParaDest-63"><a id="_idTextAnchor063"/>Option 4: Creating your EKS cluster with eksctl</h2>
			<p>eksctl is an <a id="_idIndexMarker147"/>open source<a id="_idIndexMarker148"/> project on GitHub (<a href="https://github.com/weaveworks/eksctl">https://github.com/weaveworks/eksctl</a>) co-developed between Weaveworks and AWS. It’s similar to Terraform in that it runs as a single binary and creates AWS resources; however, it can only be used to create, update, and manage EKS clusters (and any <span class="No-Break">associated resources).</span></p>
			<p>You can install eksctl by following the instructions shown at <a href="https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html">https://docs.aws.amazon.com/eks/latest/userguide/eksctl.html</a>. After you install the binary on your workstation, you can test the install using the <strong class="source-inline">eksctl info</strong> command. The easiest way to create a cluster is to run the <span class="No-Break">following command:</span></p>
			<pre class="console">
$ eksctl create cluster --name mycluster --region eu-central-1</pre>
			<p>This works in a similar way to Terraform in that it will create the VPC, EKS cluster, a node group, and all the associated resources, such as IAM roles. In the background, eksctl uses CloudFormation and will create two CloudFormation stacks that will create (29+) AWS resources. If you run the <strong class="source-inline">$ aws cloudformation list-stacks</strong> command, you will see stacks called <em class="italic">eksctl-xx</em>, which deploy all the EKS resources: one for the main resources, including the VPC, and one specifically for the node group. The CloudFormation stacks manage the state of the resources and can also be used to detect drift and <span class="No-Break">make changes.</span></p>
			<p>Again, using this<a id="_idIndexMarker149"/> option, we have created managed node<a id="_idIndexMarker150"/> groups, which we can validate by using the <strong class="source-inline">kubectl get nodes</strong> command. After updating the <strong class="source-inline">kubeconfig</strong> file, you will see two <span class="No-Break">worker nodes.</span></p>
			<p>You can also modify the default configuration by adding command-line options. The following command will change the type and number of instances that are being deployed as part of the default <span class="No-Break">node group:</span></p>
			<pre class="console">
$ eksctl create cluster --name mycluster --instance-types m5.xlarge --nodes 2 --region eu-central-1</pre>
			<p>eksctl supports different options for your cluster creation. You can list other supported options by using the flag <strong class="source-inline">--help</strong> to get <span class="No-Break">more details.</span></p>
			<p>Once you have finished with the cluster, you can use the <strong class="source-inline">$ eksctl delete cluster --name mycluster --region eu-central-1</strong> command to remove all the resources. As eksctl is a specific EKS provisioning tool, it does have some built-in features, such as <span class="No-Break">node draining.</span></p>
			<p>As you can see, eksctl provides a higher level of abstraction to Terraform, but it is not as versatile as it is an EKS tool. In the next subsection, we will briefly look at the AWS CDK, which uses programming languages such as Python to move completely away from any IaC <span class="No-Break">markup languages.</span></p>
			<h2 id="_idParaDest-64"><a id="_idTextAnchor064"/>Option 5: Creating your EKS cluster with the CDK</h2>
			<p>The AWS CDK is <a id="_idIndexMarker151"/>similar to Terraform and eksctl in that <a id="_idIndexMarker152"/>you end up with a set of binaries that can deploy AWS infrastructures. It uses CloudFormation under the cover, but it has four main advantages <span class="No-Break">over eksctl:</span></p>
			<ul>
				<li>The IaC code is written in standard programming languages such as Python, TypeScript, Golang, and so on, so developers can build code without learning Terraform or <span class="No-Break">CloudFormation markup.</span></li>
				<li>You can leverage existing language control constructs, <strong class="source-inline">IF-THEN-ELSE</strong>, <strong class="source-inline">FOR</strong> loops, and so on, as well as existing libraries to build complex logic into your <span class="No-Break">IaC scripts.</span></li>
				<li>You can create non-EKS-related resources such <span class="No-Break">as DynamoDB.</span></li>
				<li>Templates can be tested and linted using standard language tools such as pylint <span class="No-Break">or pytest.</span></li>
			</ul>
			<p>A detailed exploration of the CDK is out of the scope of this book (in fact, it could be a whole new book). If you want to really get to grips with the CDK, <a href="https://cdkworkshop.com/">https://cdkworkshop.com/</a> is a great resource. Instead, the following table shows the basic commands needed to create an <span class="No-Break">EKS cluster:</span></p>
			<table id="table004" class="No-Table-Style _idGenTablePara-1">
				<colgroup>
					<col/>
					<col/>
				</colgroup>
				<thead>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break"><strong class="bold">Python Line</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p><span class="No-Break"><strong class="bold">Description</strong></span></p>
						</td>
					</tr>
				</thead>
				<tbody>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><strong class="source-inline">my_vpc = </strong><span class="No-Break"><strong class="source-inline">ec2.Vpc.from_lookup(self,"clusterVPC",vpc_id=params['VPC'])</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p>This line uses the CDK <strong class="source-inline">ec2.Vpc</strong> object to retrieve VPC details from your AWS account using the <span class="No-Break"><strong class="source-inline">params['VPC']</strong></span><span class="No-Break"> dictionary.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><strong class="source-inline">eks_master_role = </strong><span class="No-Break"><strong class="source-inline">iam.Role.from_role_arn(self,"iderole",params['IDEROLE'])</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p>This line uses the CDK <strong class="source-inline">iam.Role</strong> object to retrieve role details from your AWS account using the <strong class="source-inline">params['IDEROLE']</strong> dictionary, used as the main admin role for <span class="No-Break">the cluster.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><strong class="source-inline">security_group = </strong><span class="No-Break"><strong class="source-inline">ec2.SecurityGroup.from_lookup_by_id(self,"idesg",params['IDESG'])</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p>This line uses the CDK <strong class="source-inline">iam.SecurityGroup</strong> object to retrieve an existing security group from your AWS account using the <strong class="source-inline">params['IDESG']</strong> dictionary, used as an additional security group for <span class="No-Break">the cluster.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break"><strong class="source-inline">my_subnets=[]</strong></span></p>
							<p><strong class="source-inline">for subnet </strong><span class="No-Break"><strong class="source-inline">in params['SUBID']:</strong></span></p>
							<p><span class="No-Break"><strong class="source-inline">my_subnets.append(ec2.Subnet.from_subnet_id(self,f"1{subnet.split('-')[1]}",subnet_id=subnet))</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p>These lines create a blank subnet list, then use a standard <strong class="source-inline">FOR</strong> loop to iterate over a list or subnet IDs stored in <strong class="source-inline">params['SUBID']</strong>, create a subnet object using the CDK <strong class="source-inline">ec2.Subnet</strong> object, and append it to the <span class="No-Break">subnet list.</span></p>
						</td>
					</tr>
					<tr class="No-Table-Style">
						<td class="No-Table-Style">
							<p><span class="No-Break"><strong class="source-inline">eks.Cluster(self,params['CLUSTERNAME'],</strong></span></p>
							<p><span class="No-Break"><strong class="source-inline">masters_role=eks_master_role,</strong></span></p>
							<p><span class="No-Break"><strong class="source-inline">security_group=security_group,</strong></span></p>
							<p><span class="No-Break"><strong class="source-inline">version=eval(f"eks.KubernetesVersion.{params['VERSION']}"),vpc=my_vpc,</strong></span></p>
							<p><span class="No-Break"><strong class="source-inline">vpc_subnets=my_subnets,</strong></span></p>
							<p><span class="No-Break"><strong class="source-inline">endpoint_access= eval(f"eks.EndpointAccess.{params['CLUSTERTYPE']}"))</strong></span></p>
						</td>
						<td class="No-Table-Style">
							<p>This line will create a cluster using the role, VPC, and subnets retrieved in the previous lines and also set the endpoint type and version from the params Python dictionary, which has all the <span class="No-Break">configuration information.</span></p>
						</td>
					</tr>
				</tbody>
			</table>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Table 3.4 – Python EKS CDK example</p>
			<p>Once the<a id="_idIndexMarker153"/> code <a id="_idIndexMarker154"/>has been written, the CDK binary can be used to do <span class="No-Break">the following:</span></p>
			<ul>
				<li>Initialize the AWS region for CDK deployments using the <strong class="source-inline">cdk </strong><span class="No-Break"><strong class="source-inline">bootstrap</strong></span><span class="No-Break"> command</span></li>
				<li>Create CloudFormation templates using the <strong class="source-inline">cdk </strong><span class="No-Break"><strong class="source-inline">synth</strong></span><span class="No-Break"> command</span></li>
				<li>Understand what will be deployed or changed using the <strong class="source-inline">cdk </strong><span class="No-Break"><strong class="source-inline">diff</strong></span><span class="No-Break"> command</span></li>
				<li>Create and deploy CloudFormation templates using the <strong class="source-inline">cdk </strong><span class="No-Break"><strong class="source-inline">deploy</strong></span><span class="No-Break"> command</span></li>
			</ul>
			<p>The CDK provides the highest level of abstraction of all the deployment tools and, as such, should be considered a good starting point for EKS automation and deployment, but tools such as eksctl and Terraform (Terraform also has a CDK variant) provide good options as <a id="_idIndexMarker155"/>well. This section has given an overview of the<a id="_idIndexMarker156"/> different ways a basic EKS cluster can <span class="No-Break">be deployed.</span></p>
			<h1 id="_idParaDest-65"><a id="_idTextAnchor065"/>Summary</h1>
			<p>In this chapter, we examined the prerequisites needed before the configuration and deployment of a basic Amazon EKS cluster, such as setting up a deployment user . We reviewed the different EKS configuration and automation options that need configuring in EKS and what frameworks and tools are available <span class="No-Break">to you.</span></p>
			<p>We then stepped through five options, from using the AWS console and CLI to different IaC frameworks to create a basic <span class="No-Break">EKS cluster.</span></p>
			<p>After completing this lesson, you learned how to provision your EKS cluster and have a running cluster under your AWS account, as well as have kubectl and the AWS CLI installed to enable interaction with your <span class="No-Break">EKS cluster.</span></p>
			<p>In the next chapter, we are going to move on to the topic of learning how to deploy and run your containerized application on <span class="No-Break">Amazon EKS.</span></p>
			<h1 id="_idParaDest-66"><a id="_idTextAnchor066"/>Further reading</h1>
			<ul>
				<li>Making AWS API calls <span class="No-Break">safely: </span><a href="https://docs.aws.amazon.com/AWSEC2/latest/APIReference/Run_Instance_Idempotency.html"><span class="No-Break">https://docs.aws.amazon.com/AWSEC2/latest/APIReference/Run_Instance_Idempotency.html</span></a></li>
				<li>CDK deep <span class="No-Break">dive: </span><a href="https://cdkworkshop.com/"><span class="No-Break">https://cdkworkshop.com/</span></a></li>
				<li>CloudFormation <span class="No-Break">overview: </span><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html"><span class="No-Break">https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/Welcome.html</span></a></li>
				<li>Terraform <span class="No-Break">overview: </span><a href="https://www.terraform.io/intro"><span class="No-Break">https://www.terraform.io/intro</span></a></li>
				<li>Getting started with <span class="No-Break">eksctl: </span><a href="https://eksctl.io/"><span class="No-Break">https://eksctl.io/</span></a></li>
			</ul>
		</div>
	</body></html>