<html><head></head><body>
		<div id="_idContainer052">
			<h1 id="_idParaDest-83" class="chapter-number"><a id="_idTextAnchor082"/>4</h1>
			<h1 id="_idParaDest-84"><a id="_idTextAnchor083"/>k3OS Installation and Configurations</h1>
			<p>In edge computing contexts, companies are looking to simplify their tasks while using edge devices. Talking about the success of the K3s adoption, some industries need a ready-to-use operating system that can include an edge Kubernetes distribution. This is where k3OS fits the industry's needs. k3OS was designed to speed up the installation of K3s on edge devices. </p>
			<p>k3OS packages all the necessary software to install K3s. This chapter explores how to use the k3OS ISO image to install K3s on x86_64 devices and how to use configuration files. You will learn from different configuration examples how to customize your K3s installations, from single node to multi-node. Finally, you will learn how to install k3OS on ARM devices using the overlay installation, taking in detailed configurations such as networking, the hostname that you would need when installing k3OS on edge devices, especially when you use ARM devices.</p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>k3OS installation for x86_64 devices using an ISO image</li>
				<li>Advanced installations of k3OS using config files</li>
				<li>Multi-node ARM overlay installation</li>
			</ul>
			<h1 id="_idParaDest-85"><a id="_idTextAnchor084"/>Technical requirements</h1>
			<p>For this chapter, you need one of the following VMs or devices:</p>
			<ul>
				<li>A Raspberry Pi 4B model with 4 GB RAM (minimum suggested)</li>
				<li>A cloud server or VM with <strong class="bold">Ubuntu 20.04 LTS</strong></li>
				<li>A VM created using VirtualBox or other software for virtualization</li>
			</ul>
			<p>In addition, you need a cloud storage service such as Amazon S3, Google Cloud Storage, or similar, to upload the configuration file for k3OS. </p>
			<p>With this, we are ready to learn how to install k3OS in your preferred edge device. So, let's get started.</p>
			<p>For more detail and code snippets, check out this resource on GitHub: <a href="https://github.com/PacktPublishing/Edge-Computing-Systems-with-Kubernetes/tree/main/ch4">https://github.com/PacktPublishing/Edge-Computing-Systems-with-Kubernetes/tree/main/ch4</a></p>
			<h1 id="_idParaDest-86"><a id="_idTextAnchor085"/>k3OS – the Kubernetes operating system</h1>
			<p>k3OS is a Linux distribution that includes the minimal kernel, drivers, and binaries that you <a id="_idIndexMarker223"/>need to install Kubernetes at the edge. It features a lightweight distribution of Kubernetes called K3s. k3OS could be used as a fast operating system solution to install a lightweight Kubernetes cluster; this means that the k3OS image could be used to install master and agent nodes. k3OS uses K3s as the main software to create a single or multi-cluster node for the edge. So, with k3OS, you are ready to run your edge clusters without spending a lot of time. </p>
			<p>k3OS can <a id="_idIndexMarker224"/>be installed using the following methods:</p>
			<ul>
				<li><strong class="bold">ISO image</strong></li>
				<li><strong class="bold">Overlay installation</strong></li>
			</ul>
			<p>There are other methods to install a K3s cluster, but this is an easier way to get started fast. At this moment, k3OS is under development but supports a lot of features for ARM devices. So, let's move on to learn how to install your lightweight Kubernetes cluster using k3OS in the next section.</p>
			<h1 id="_idParaDest-87"><a id="_idTextAnchor086"/>k3OS installation for x86_64 devices using an ISO image </h1>
			<p>We are <a id="_idIndexMarker225"/>going to install k3OS in a VM created using VirtualBox and an ISO <a id="_idIndexMarker226"/>image for a x86_64 architecture using a Macintosh. To do this, follow these steps:</p>
			<ol>
				<li>Download the <strong class="source-inline">k3OS x86_64 v0.20.7 ISO</strong> image from this link:</li>
			</ol>
			<p><a href="https://github.com/rancher/k3os/releases">https://github.com/rancher/k3os/releases</a></p>
			<ol>
				<li value="2">Open your VirtualBox. The main window will appear, as shown in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer030" class="IMG---Figure">
					<img src="image/B16945_Figure_4.1.jpg" alt="Figure 4.1 – VirtualBox main window"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.1 – VirtualBox main window</p>
			<ol>
				<li value="3">Enter <a id="_idIndexMarker227"/>the name to identify the VM – in this case, <strong class="source-inline">k3OS</strong> – and <a id="_idIndexMarker228"/>choose the type of VM as <strong class="bold">Linux</strong> and the<strong class="bold"> version</strong> as <strong class="bold">Other Linux (64 bit)</strong>. Then, click on <strong class="bold">Continue</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer031" class="IMG---Figure">
					<img src="image/B16945_Figure_4.2.jpg" alt="Figure 4.2 – Name and operating system dialog&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.2 – Name and operating system dialog</p>
			<ol>
				<li value="4">Choose <a id="_idIndexMarker229"/>at least <strong class="bold">2048 MB</strong> of RAM memory for the Live CD and <a id="_idIndexMarker230"/>interactive installation. Then, click on <strong class="bold">Continue</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer032" class="IMG---Figure">
					<img src="image/B16945_Figure_4.3.jpg" alt="Figure 4.3 – Memory size dialog&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.3 – Memory size dialog</p>
			<ol>
				<li value="5">Now <a id="_idIndexMarker231"/>let's create the hard disk; choose <strong class="bold">Create a virtual hard disk now</strong> and <a id="_idIndexMarker232"/>click on <strong class="bold">Create</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer033" class="IMG---Figure">
					<img src="image/B16945_Figure_4.4.jpg" alt="Figure 4.4 – Hard disk dialog&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.4 – Hard disk dialog</p>
			<ol>
				<li value="6">Choose <strong class="bold">VDI</strong> for <strong class="bold">Hard disk file type</strong> and <a id="_idIndexMarker233"/>click <strong class="bold">Continue</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer034" class="IMG---Figure">
					<img src="image/B16945_Figure_4.5.jpg" alt="Figure 4.5 – Hard disk file type dialog"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.5 – Hard disk file type dialog</p>
			<ol>
				<li value="7">Choose <strong class="bold">Dynamically allocated</strong> for physical storage, as this will dynamically allocate <a id="_idIndexMarker234"/>the space for your hard disk. Then, click <strong class="bold">Continue</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer035" class="IMG---Figure">
					<img src="image/B16945_Figure_4.6.jpg" alt="Figure 4.6 – Hard disk type dialog&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.6 – Hard disk type dialog</p>
			<ol>
				<li value="8">Choose <a id="_idIndexMarker235"/>at least <strong class="bold">4.00 GB</strong> of disk space for your installation; it could be more, depending on your own requirements. Then, click on <strong class="bold">Create</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer036" class="IMG---Figure">
					<img src="image/B16945_Figure_4.7.jpg" alt="Figure 4.7 – Disk space dialog&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.7 – Disk space dialog</p>
			<ol>
				<li value="9">VirtualBox <a id="_idIndexMarker236"/>is going to <a id="_idIndexMarker237"/>move you to the <strong class="bold">main window</strong>; click on the <strong class="bold">Settings</strong> icon.</li>
			</ol>
			<div>
				<div id="_idContainer037" class="IMG---Figure">
					<img src="image/B16945_Figure_4.8.jpg" alt="Figure 4.8 – Main window and Settings icon&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.8 – Main window and Settings icon</p>
			<ol>
				<li value="10">Click on <strong class="bold">Storage</strong> and choose the <strong class="bold">Empty</strong> drive icon. Now, click on the small CD icon (<img src="image/B16945_04_icon1.png" alt=""/>) next <a id="_idIndexMarker238"/>to the <strong class="bold">Optical Drive</strong> combo box. </li>
			</ol>
			<div>
				<div id="_idContainer039" class="IMG---Figure">
					<img src="image/B16945_Figure_4.9.jpg" alt="Figure 4.9 – Storage dialog&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.9 – Storage dialog</p>
			<ol>
				<li value="11">Choose <a id="_idIndexMarker239"/>the <strong class="bold">Choose a disk file...</strong> menu.</li>
			</ol>
			<div>
				<div id="_idContainer040" class="IMG---Figure">
					<img src="image/B16945_Figure_4.10.jpg" alt="Figure 4.10 – Optical drive options&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.10 – Optical drive options</p>
			<ol>
				<li value="12">Now <a id="_idIndexMarker240"/>find your <strong class="bold">k3OS ISO image</strong> and click <strong class="bold">Open</strong>:</li>
			</ol>
			<div>
				<div id="_idContainer041" class="IMG---Figure">
					<img src="image/B16945_Figure_4.11.jpg" alt="Figure 4.11 – Open ISO dialog"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.11 – Open ISO dialog</p>
			<ol>
				<li value="13">Click <a id="_idIndexMarker241"/>on the <strong class="bold">Live CD/DVD</strong> checkbox and then click <strong class="bold">OK</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer042" class="IMG---Figure">
					<img src="image/B16945_Figure_4.12.jpg" alt="Figure 4.12 – Activating the Live CD/DVD feature&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.12 – Activating the Live CD/DVD feature</p>
			<ol>
				<li value="14">Now <a id="_idIndexMarker242"/>click on <strong class="bold">Network</strong>, and under <strong class="bold">Adapter 1</strong>, change the <strong class="bold">Attached to</strong>: combo <a id="_idIndexMarker243"/>box to <strong class="bold">Bridged Adapter</strong> for your VM to get an IP inside your local network. This is useful to access the VM remotely. Then, click <strong class="bold">OK</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer043" class="IMG---Figure">
					<img src="image/B16945_Figure_4.13.jpg" alt="Figure 4.13 – Network configuration dialog&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.13 – Network configuration dialog</p>
			<ol>
				<li value="15">VirtualBox <a id="_idIndexMarker244"/>is going to return to the main window again; now click on the <strong class="bold">Start</strong> icon.</li>
				<li>Now, you <a id="_idIndexMarker245"/>should wait for the process of loading the k3OS distribution. At the end, you are going to see a login prompt. Use <strong class="source-inline">rancher</strong> as both the username and password. For newer versions, you don't have to enter any password.</li>
			</ol>
			<div>
				<div id="_idContainer044" class="IMG---Figure">
					<img src="image/B16945_Figure_4.14.jpg" alt="Figure 4.14 – k3OS live CD first-time login&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.14 – k3OS live CD first-time login</p>
			<ol>
				<li value="17">Then, execute <strong class="source-inline">sudo k3os install</strong> to <a id="_idIndexMarker246"/>start the interactive script <a id="_idIndexMarker247"/>to install k3OS in your VM:</li>
			</ol>
			<div>
				<div id="_idContainer045" class="IMG---Figure">
					<img src="image/B16945_Figure_4.15.jpg" alt="Figure 4.15 – k3OS starting the interactive installation&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.15 – k3OS starting the interactive installation</p>
			<ol>
				<li value="18">Complete <a id="_idIndexMarker248"/>the script installation with the following values:<ul><li>Install to disk with key <strong class="source-inline">1</strong>.</li><li>Config <a id="_idIndexMarker249"/>system with cloud-init with <strong class="source-inline">N</strong>.</li><li>Authorize the GitHub user to SSH with <strong class="source-inline">N</strong>.</li><li>Set up and confirm your new password for the rancher user with <strong class="source-inline">YOUR_PASSWORD</strong>.</li><li>Configure Wi-Fi with <strong class="source-inline">N</strong>.</li><li>Run as a server or agent with <strong class="source-inline">1</strong>.</li><li>Token or cluster secret – leave it empty and then press <em class="italic">Enter</em>.</li><li>Your disk will be formatted with <strong class="source-inline">y</strong>.</li></ul></li>
			</ol>
			<p>The dialog will resemble the following screenshot:</p>
			<div>
				<div id="_idContainer046" class="IMG---Figure">
					<img src="image/B16945_Figure_4.16.jpg" alt="Figure 4.16 – Installation of the CLI dialog&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.16 – Installation of the CLI dialog</p>
			<ol>
				<li value="19">After <a id="_idIndexMarker250"/>that, the VM is going to reboot; when starting to load, close the VM <a id="_idIndexMarker251"/>window, and the dialog from <em class="italic">Figure 4.17</em> will appear. Choose <strong class="bold">Power off the machine</strong> and then click <strong class="bold">OK</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer047" class="IMG---Figure">
					<img src="image/B16945_Figure_4.17.jpg" alt="Figure 4.17 – Power off the VM&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.17 – Power off the VM</p>
			<ol>
				<li value="20">Once <a id="_idIndexMarker252"/>the VM is stopped, go to <strong class="bold">Settings</strong> and move to the <strong class="bold">System</strong> section <a id="_idIndexMarker253"/>under the <strong class="bold">Motherboard</strong> tab. Choose the <strong class="bold">Boot order</strong> section and select the <strong class="bold">Hard Disk</strong> option to prevent the optical disk from not loading again and prevent the launching of the installation script when the VM boots.</li>
			</ol>
			<div>
				<div id="_idContainer048" class="IMG---Figure">
					<img src="image/B16945_Figure_4.18.jpg" alt="Figure 4.18 – Reconfiguring to boot on disk&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.18 – Reconfiguring to boot on disk</p>
			<ol>
				<li value="21">Now, VirtualBox <a id="_idIndexMarker254"/>is going to return to the main window, so click on <strong class="bold">Start</strong> to <a id="_idIndexMarker255"/>start your VM again and your fresh k3OS installation will be loaded.</li>
				<li>Now, your k3OS installation is running. You have to enter the <strong class="source-inline">rancher</strong> username and your new password to log in.</li>
			</ol>
			<div>
				<div id="_idContainer049" class="IMG---Figure">
					<img src="image/B16945_Figure_4.19.jpg" alt="Figure 4.19 – k3OS first-time boot from disk&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.19 – k3OS first-time boot from disk</p>
			<p>Now, you <a id="_idIndexMarker256"/>have a fresh installation of k3OS that is ready to use.</p>
			<p>In the <a id="_idIndexMarker257"/>next section, you are going to learn how to do more advanced configurations using the same steps of creating a VM for k3OS, so let's move on to the next section.</p>
			<h1 id="_idParaDest-88"><a id="_idTextAnchor087"/>Advanced installations of k3OS using config files</h1>
			<p>Now, we <a id="_idIndexMarker258"/>are ready to learn how to use config files to install k3OS; for this, you need a public <a id="_idIndexMarker259"/>GitHub repository where you can push these files. Before creating a <strong class="source-inline">config.yaml</strong> file to install k3OS, let's understand the different sections of this file. You are going to need a file for your master node and one for your agent node.</p>
			<h2 id="_idParaDest-89"><a id="_idTextAnchor088"/>k3OS config file sections</h2>
			<p>Let's begin <a id="_idIndexMarker260"/>with an explanation of the sections to configure the host. These are as follows:</p>
			<ul>
				<li><strong class="bold">Hostname section</strong>:<p class="source-code"><strong class="bold">hostname: master</strong></p></li>
			</ul>
			<p>Here is where you set the hostname – in this case, <strong class="source-inline">master</strong>.</p>
			<ul>
				<li><strong class="bold">SSH section</strong>:<p class="source-code"><strong class="bold">ssh_authorized_keys: </strong></p><p class="source-code"><strong class="bold">- ssh-rsa YOUR_KEY</strong></p></li>
			</ul>
			<p>This section is used to set the default SSH public key that can access the node using SSH. You have to replace <strong class="source-inline">YOUR_KEY</strong> with your own public key.</p>
			<ul>
				<li><strong class="bold">Write files section</strong>:<p class="source-code"><strong class="bold">write_files: </strong></p><p class="source-code"><strong class="bold">  - path: /var/lib/connman/default.config </strong></p><p class="source-code"><strong class="bold">    content: |- </strong></p><p class="source-code"><strong class="bold">      [service_eth0] </strong></p><p class="source-code"><strong class="bold">      Type=ethernet </strong></p><p class="source-code"><strong class="bold">      IPv4=192.168.0.11/255.255.255.0/192.168.0.1 </strong></p><p class="source-code"><strong class="bold">      IPv6=off </strong></p><p class="source-code"><strong class="bold">      Nameservers=8.8.8.8</strong></p></li>
			</ul>
			<p>This section defines your network configuration. In this case, we have connected our Raspberry Pi to an ethernet connection with the internet. The IP of this node is set to <strong class="source-inline">192.168.0.11</strong>, the mask to <strong class="source-inline">255.255.255.0</strong>, and the gateway to <strong class="source-inline">192.168.0.1</strong>, and this connection is going to use the <strong class="source-inline">8.8.8.8</strong> nameserver. Remember that you can customize these values as per your internet provider.</p>
			<p>Now, let's <a id="_idIndexMarker261"/>explore the sections to configure K3s. These are as follows:</p>
			<ul>
				<li><strong class="bold">k3OS DNS nameservers section</strong>:<p class="source-code"><strong class="bold">k3os: </strong></p><p class="source-code"><strong class="bold">  dns_nameservers: </strong></p><p class="source-code"><strong class="bold">  - 8.8.8.8 </strong></p><p class="source-code"><strong class="bold">  - 1.1.1.1</strong></p></li>
			</ul>
			<p>This section sets the default DNS for the pods in the cluster; in this case, it is set to <strong class="source-inline">8.8.8.8</strong> and <strong class="source-inline">1.1.1.1</strong>.</p>
			<ul>
				<li><strong class="bold">NTP servers section</strong>:<p class="source-code"><strong class="bold">  ntp_servers: </strong></p><p class="source-code"><strong class="bold">  - 0.us.pool.ntp.org </strong></p><p class="source-code"><strong class="bold">  - 1.us.pool.ntp.org</strong></p></li>
			</ul>
			<p>This section sets the NTP servers to synchronize the time; in this case, it is set to <strong class="source-inline">0.us.pool.ntp.org</strong> and <strong class="source-inline">1.us.pool.ntp.org</strong>.</p>
			<ul>
				<li><strong class="bold">Password section</strong>:<p class="source-code"><strong class="bold">  password: rancher</strong></p></li>
			</ul>
			<p>Here is where you set the password to access the host with k3OS.</p>
			<ul>
				<li><strong class="bold">Labels section</strong>:<p class="source-code"><strong class="bold">  labels: </strong></p><p class="source-code"><strong class="bold">    region: america-central-1  </strong></p></li>
			</ul>
			<p>This section configures the labels of the node; this is equivalent to using the <strong class="source-inline">kubectl labels</strong> command.</p>
			<p>We have explained the common sections for the master and agent nodes. Now, let's continue with the sections that are different for the master and agent nodes.</p>
			<h2 id="_idParaDest-90"><a id="_idTextAnchor089"/>Configurations for master and agent nodes</h2>
			<p>This <a id="_idIndexMarker262"/>section describes <a id="_idIndexMarker263"/>the specific sections that you have to use to configure a master or agent node. Let's get started with the master node:</p>
			<ul>
				<li>This is an example of a specific configuration for a master node:<p class="source-code"><strong class="bold">k3os: </strong></p><p class="source-code"><strong class="bold">  token: myclustersecret</strong></p><p class="source-code"><strong class="bold">  password: rancher</strong></p><p class="source-code"><strong class="bold">  k3s_args: </strong></p><p class="source-code"><strong class="bold">  - server </strong></p><p class="source-code"><strong class="bold">  - "--write-kubeconfig-mode" </strong></p><p class="source-code"><strong class="bold">  - "644" </strong></p></li>
			</ul>
			<p>This k3OS configuration sets the master node, including the token that will be used to add new agent nodes, the password for the node, and parameters to send to the server binary. In this case, only modify the installation to execute <strong class="source-inline">kubectl</strong> without using <strong class="source-inline">sudo</strong>.</p>
			<ul>
				<li>This is an example of a specific configuration for an agent node:<p class="source-code"><strong class="bold">k3os: </strong></p><p class="source-code"><strong class="bold">  server_url: https://192.168.0.11:6443 </strong></p><p class="source-code"><strong class="bold">  token: myclustersecret</strong></p><p class="source-code"><strong class="bold">  password: rancher</strong></p></li>
			</ul>
			<p>This k3OS configuration sets an agent node to connect to the master node defined in <strong class="source-inline">server_url</strong>, using the token defined to be added to the cluster, and uses the defined password to access the node.</p>
			<p class="callout-heading">Important Note</p>
			<p class="callout">For more options or arguments, you can check the next link: <a href="https://rancher.com/docs/k3s">https://rancher.com/docs/k3s</a>.</p>
			<p>We <a id="_idIndexMarker264"/>have explained <a id="_idIndexMarker265"/>all the basic sections to create your cluster using config files. In the next section, we are going to create basic configuration files to create a multi-node cluster. So, let's get started.</p>
			<h2 id="_idParaDest-91"><a id="_idTextAnchor090"/>Multi-node cluster creation using config files</h2>
			<p>Now is <a id="_idIndexMarker266"/>time to configure your cluster <a id="_idIndexMarker267"/>using config files, so let's put all the pieces together; the file for a master node will look like the following:</p>
			<p class="source-code">hostname: master</p>
			<p class="source-code">ssh_authorized_keys:</p>
			<p class="source-code">- ssh-rsa YOUR_PUBLIC_SSH_KEY</p>
			<p class="source-code">write_files:</p>
			<p class="source-code">  - path: /var/lib/connman/default.config</p>
			<p class="source-code">    content: |-</p>
			<p class="source-code">      [service_eth0]</p>
			<p class="source-code">      Type=ethernet</p>
			<p class="source-code">      IPv4=192.168.0.11/255.255.255.0/192.168.0.1</p>
			<p class="source-code">      IPv6=off</p>
			<p class="source-code">      Nameservers=8.8.8.8</p>
			<p class="source-code">k3os:</p>
			<p class="source-code">  dns_nameservers:</p>
			<p class="source-code">  - 8.8.8.8</p>
			<p class="source-code">  ntp_servers:</p>
			<p class="source-code">  - 0.us.pool.ntp.org</p>
			<p class="source-code">  password: rancher</p>
			<p class="source-code">  token: myclustersecret</p>
			<p class="source-code">  k3s_args:</p>
			<p class="source-code">  - server</p>
			<p class="source-code">  - "--write-kubeconfig-mode"</p>
			<p class="source-code">  - "644</p>
			<p>The <a id="_idIndexMarker268"/>configuration file for an agent node <a id="_idIndexMarker269"/>will look like this:</p>
			<p class="source-code">hostname: node01</p>
			<p class="source-code">ssh_authorized_keys:</p>
			<p class="source-code">- ssh-rsa YOUR_PUBLIC_SSH_KEY</p>
			<p class="source-code">write_files:</p>
			<p class="source-code">  - path: /var/lib/connman/default.config</p>
			<p class="source-code">    content: |-</p>
			<p class="source-code">      [service_eth0]</p>
			<p class="source-code">      Type=ethernet</p>
			<p class="source-code">      IPv4=192.168.0.12/255.255.255.0/192.168.0.1</p>
			<p class="source-code">      IPv6=off</p>
			<p class="source-code">      Nameservers=8.8.8.8</p>
			<p class="source-code">k3os:</p>
			<p class="source-code">  server_url: https://192.168.0.11:6443</p>
			<p class="source-code">  token: myclustersecret</p>
			<p class="source-code">  dns_nameservers:</p>
			<p class="source-code">  - 8.8.8.8</p>
			<p class="source-code">  ntp_servers:</p>
			<p class="source-code">  - 0.us.pool.ntp.org</p>
			<p class="source-code">  password: rancher</p>
			<p>Now that we <a id="_idIndexMarker270"/>have the basic configuration <a id="_idIndexMarker271"/>files for master and agent nodes, it is time to use these files to deploy your multi-node cluster, as discussed in the following section.</p>
			<h2 id="_idParaDest-92"><a id="_idTextAnchor091"/>Creating a multi-node K3s cluster using config files</h2>
			<p>Before <a id="_idIndexMarker272"/>you start creating the multi-node <a id="_idIndexMarker273"/>cluster, you must be equipped with the following requirements:</p>
			<ul>
				<li>1 VM for the master node.</li>
				<li>1 VM for the agent node.</li>
				<li>Your <strong class="source-inline">master_example.yaml</strong> master config file uploaded to a cloud storage service, such as Amazon S3, Google Cloud Storage, or similar. For example, if you use Google Storage, the URL for your file will be like this: <a href="https://storage.googleapis.com/k3s/master_example.yaml">https://storage.googleapis.com/k3s/master_example.yaml</a>.</li>
				<li>Your <strong class="source-inline">agent_example.yaml</strong> agent config file uploaded to a cloud storage service, such as Amazon S3, Google Cloud Storage, or similar. For example, if you use Google Storage, the URL for your file will be like this: <a href="https://storage.googleapis.com/k3s/agent_example.yaml">https://storage.googleapis.com/k3s/agent_example.yaml</a>. </li>
			</ul>
			<p class="callout-heading">Important Note</p>
			<p class="callout">The VM for the master and agent nodes must be configured to boot using the k3OS ISO image; in the next section, we will explain how to run the installation for master and agent nodes.</p>
			<p>Now, we <a id="_idIndexMarker274"/>are ready to create our K3s <a id="_idIndexMarker275"/>cluster using config files. The next section explains how to use the k3OS ISO image to install a multi-node cluster. So, let's get started.</p>
			<h3>Creating a master node with config files</h3>
			<p>To <a id="_idIndexMarker276"/>create a master node, follow these steps:</p>
			<ol>
				<li value="1">Load <a id="_idIndexMarker277"/>your VM and then log in.</li>
				<li>Log in to the VM with the <strong class="source-inline">rancher</strong> username and password. </li>
				<li>Run the following command to start the k3OS installation:<p class="source-code"><strong class="bold">$ sudo k3os install</strong></p></li>
				<li>Follow the installation script using the following options:<p class="source-code"><strong class="bold">Choose Operation</strong></p><p class="source-code"><strong class="bold">1. Install to disk</strong></p><p class="source-code"><strong class="bold">2. Configure server or agent node</strong></p><p class="source-code"><strong class="bold">Select number [1]: 1 </strong></p><p class="source-code"><strong class="bold">Config system with cloud-init file? [y/N] </strong>y</p><p class="source-code"><strong class="bold">cloud-init file location (file PATH or http URL): </strong>https://storage.googleapis.com/k3s/master_example.yaml</p><p class="source-code"><strong class="bold">Your disk will be formatted and k3OS will be installed with the above configuration. </strong></p><p class="source-code"><strong class="bold">Continue? [y/N] </strong><strong class="source-inline">y</strong></p></li>
			</ol>
			<p>Remember to boot from the disk the next time to load your k3OS installation, following the last steps of the <em class="italic">k3OS installation for x86_64 devices using an ISO image</em> section. Now, let's move on to agent node creation.</p>
			<h3>Creating an agent node with config files</h3>
			<p>Now, follow <a id="_idIndexMarker278"/>the next steps to create an agent node:</p>
			<ol>
				<li value="1">Load <a id="_idIndexMarker279"/>your VM and then log in.</li>
				<li>Log in to the VM with the <strong class="source-inline">rancher</strong> username and password. </li>
				<li>Run the following command to start the k3OS installation:<p class="source-code"><strong class="bold">sudo k3os install</strong></p></li>
				<li>Follow the installation script using the following options:<p class="source-code"><strong class="bold">Choose Operation</strong></p><p class="source-code"><strong class="bold">1. Install to disk</strong></p><p class="source-code"><strong class="bold">2. Configure server or agent node</strong></p><p class="source-code"><strong class="bold">Select number [1]: 1</strong></p><p class="source-code"><strong class="bold">Config system with cloud-init file? [y/N] y</strong></p><p class="source-code"><strong class="bold">cloud-init file location (file PATH or http URL): https://storage.googleapis.com/k3s/agent_example.yaml</strong></p><p class="source-code"><strong class="bold">Your disk will be formatted and k3OS will be installed with the above configuration. Continue? [y/N] y</strong></p></li>
			</ol>
			<p>Remember to boot from the disk as you did with your master node. Now that your cluster is ready to be used, try to run <strong class="source-inline">kubectl get nodes</strong>. To verify whether your node was added, the output of the command should display the node name and the <strong class="source-inline">Ready</strong> status.</p>
			<p>You have installed a multi-node cluster with master and agent nodes using VMs. Now it's time to install a multi-node cluster using ARM devices; in the next section, we are going to explore this kind of setup.</p>
			<h1 id="_idParaDest-93"><a id="_idTextAnchor092"/>Multi-node ARM overlay installation</h1>
			<p>An overlay installation replaces some parts of your current OS installation or some parts of your <a id="_idIndexMarker280"/>system. In this case, when you use the <strong class="bold">rootfs k3OS</strong> file to perform <a id="_idIndexMarker281"/>this kind of installation, you will overwrite the <strong class="source-inline">/sbin/init</strong> file. Then, when you reboot your ARM device, the user space will be initialized and k3OS will be loaded. This kind of installation is supported for ARMv7 and ARM64 devices. One important thing is that you can customize this installation using the config YAML files, which must be stored on <strong class="source-inline">/k3os/system/config.yaml</strong>.</p>
			<p>Before <a id="_idIndexMarker282"/>performing this overlay installation, you need the following:</p>
			<ul>
				<li>An <a id="_idIndexMarker283"/>ARMv7 or ARM64 device, such as a Raspberry PI with <strong class="bold">Ubuntu 20.04 LTS</strong> installed (you <a id="_idIndexMarker284"/>can use <strong class="bold">Raspberry PI Imager </strong>or <strong class="bold">balenaEtcher</strong>; check <a href="B16945_03_Final_PG.xhtml#_idTextAnchor056"><em class="italic">Chapter 3</em></a>, <em class="italic">K3s Advanced Configurations and Management</em>, for reference)</li>
				<li>A network <a id="_idIndexMarker285"/>device connection with access to the internet and <strong class="bold">Dynamic Host Configuration Protocol</strong> (<strong class="bold">DHCP</strong>) to auto-assign an IP to your device</li>
				<li>An HDMI port connected to your monitor</li>
				<li>A keyboard connected</li>
				<li>Raspberry Pi Imager installed on your Macintosh or PC</li>
			</ul>
			<p>In this case, we are going to use a Raspberry Pi 4B with 8 GB of RAM and a 64 GB Micro SD card for the master node, and 4 GB of RAM and a 32 GB Micro SD card for storage for the agent node. So, let's get started with the overlay installation for the master node first.</p>
			<h2 id="_idParaDest-94"><a id="_idTextAnchor093"/>Master node overlay installation</h2>
			<p>Follow <a id="_idIndexMarker286"/>these steps to install the master node overlay:</p>
			<ol>
				<li value="1">Install Ubuntu 20.04 LTS with ARM64 by navigating to <strong class="bold">Operating System</strong> | <strong class="bold">Other general purpose OS</strong> | <strong class="bold">Ubuntu </strong> | <strong class="bold">Ubuntu 20.04.2 LTS (RPi 3/4/400)</strong>. Insert your Micro SD card and choose it in <strong class="bold">Storage</strong>; then click on <strong class="bold">WRITE</strong>, as shown <a id="_idIndexMarker287"/>in the following screenshot:</li>
			</ol>
			<div>
				<div id="_idContainer050" class="IMG---Figure">
					<img src="image/B16945_Figure_4.20.jpg" alt="Figure 4.20 – Ubuntu server installation using Raspberry Pi Imager&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.20 – Ubuntu server installation using Raspberry Pi Imager</p>
			<p>This is going to ask for your credentials to start the installation; when the process finishes, it will show the following screen:</p>
			<div>
				<div id="_idContainer051" class="IMG---Figure">
					<img src="image/B16945_Figure_4.21.jpg" alt="Figure 4.21 – Write Successful dialog&#13;&#10;"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.21 – Write Successful dialog</p>
			<p>Now, extract your MicroSD card and insert it into your SD slot in your Raspberry Pi.</p>
			<ol>
				<li value="2">Turn on your Raspberry Pi.</li>
				<li>Log in to <a id="_idIndexMarker288"/>your ARM device. The default user/password for Ubuntu is <strong class="source-inline">ubuntu</strong>; the system will ask you to set a new password. Set your desired password.</li>
				<li>Install the <strong class="source-inline">net-tools</strong> package to see which IP has your ARM device with the following command:<p class="source-code"><strong class="bold">$ sudo apt-get update</strong></p><p class="source-code"><strong class="bold">$ sudo apt-get install –y net-tools</strong></p></li>
				<li>Check for your IP with the following command:<p class="source-code"><strong class="bold">$ sudo ifconfig</strong></p></li>
				<li>Log in to your device using SSH, the <strong class="source-inline">ubuntu</strong> username, and the password that you set when logging in to your Ubuntu device for the first time. <strong class="source-inline">DEVICE_IP</strong> is the IP that <strong class="source-inline">ifconfig</strong> returned. Run this on your laptop to log in:<p class="source-code"><strong class="bold">$ ssh ubuntu@DEVICE_IP</strong></p></li>
				<li>Add the <strong class="source-inline">cgroup_memory=1 cgroup_enable=memory</strong> options to your kernel parameters in the <strong class="source-inline">/boot/firmware/cmdline.txt</strong> file with the following command:<p class="source-code"><strong class="bold">$ sed 's/$/cgroup_memory=1 cgroup_enable=memory/' /boot/firmware/cmdline.txt | sudo tee /boot/firmware/cmdline.txt</strong></p></li>
			</ol>
			<p>Alternatively, you can <a id="_idIndexMarker289"/>use any editor to add this text at the end of the <strong class="source-inline">cmdline.txt</strong> file.</p>
			<ol>
				<li value="8">Run the following commands to install k3OS; this will unpack the <strong class="source-inline">tar.gz</strong> file into the <strong class="source-inline">/ folder</strong>:<p class="source-code"><strong class="bold">$ curl -sfL https://github.com/rancher/k3os/releases/download/v0.20.7-k3s1r0/k3os-rootfs-arm.tar.gz | sudo tar zxvf - --strip-components=1 -C /</strong></p></li>
			</ol>
			<p>If you want to configure a master node, follow these steps:</p>
			<ol>
				<li value="1">Download or copy a config into your local directory; let's use our previous master configuration using <strong class="source-inline">wget</strong>, plus the URL:<p class="source-code"><strong class="bold">$ wget https://storage.googleapis.com/k3s/master_example.yaml</strong></p></li>
				<li>Copy the configuration to /<strong class="source-inline">k3os/system/config</strong> using the following command:<p class="source-code"><strong class="bold">$ sudo cp master_example.yaml /k3os/system/config.yaml</strong></p></li>
			</ol>
			<p>You can customize these files as you need; remember that this example uses an SSH key that you can use to log in to your node remotely.</p>
			<p>(<em class="italic">Optional</em>) If you want to configure an <strong class="bold">agent node</strong>, follow the next steps:</p>
			<ol>
				<li value="1">Download or copy a config in your local directory, let's use our previous master configuration using <strong class="source-inline">wget</strong> plus the URL:<p class="source-code"><strong class="bold">$ wget https://storage.googleapis.com/k3s/agent_example.yaml</strong></p></li>
				<li>Copy the configuration to <strong class="source-inline">/k3os/system/config</strong> using the following command:<p class="source-code"><strong class="bold">$ sudo cp agent_example.yaml /k3os/system/config.yaml</strong></p></li>
			</ol>
			<p>You can customize these files as you need; remember that this example uses an SSH key that you can use to log in to your node remotely.</p>
			<ol>
				<li value="3">Sync the <a id="_idIndexMarker290"/>filesystem for each node with the following command:<p class="source-code"><strong class="bold">$ sudo sync</strong></p></li>
				<li>Reboot the system:<p class="source-code"><strong class="bold">$ sudo reboot -f</strong></p></li>
				<li>Log in to your device:<p class="source-code"><strong class="bold">$ sudo rancher@DEVICE_IP</strong></p></li>
			</ol>
			<p>Remember that this configuration has set a static IP for your node.</p>
			<ol>
				<li value="6">If you are logged in to the master node, you can run the following command to check whether all the nodes were detected:<p class="source-code"><strong class="bold">$ kubectl get nodes</strong></p></li>
			</ol>
			<p>Now, your K3s cluster has been installed and is ready to be used. You now know how to configure the cluster using the overlay installation, which is quicker compared to the execution of the default K3s script found on the K3s official website.</p>
			<h1 id="_idParaDest-95"><a id="_idTextAnchor094"/>Summary</h1>
			<p>In this chapter, we learned how to install K3s using the k3OS, a production-ready Linux distribution, covering how to prepare your VMs in case that you want to create a cluster for x86_64 architectures. Then, we moved on to explain how configuration files are used to perform advanced and custom cluster installations, and how you can configure them to create a multi-node cluster using the ISO image or the overlay installation. Finally, we covered how to create a multi-node cluster using the overlay installation, to reduce the manual configurations to install K3s using the k3OS potential. Now, we are close to starting use cases and real configuration in the coming chapters. In the next chapter, we are going to create a production-ready cluster using all the things that we learned in the previous chapters.</p>
			<h1 id="_idParaDest-96"><a id="_idTextAnchor095"/>Questions</h1>
			<p>Here are a few questions to validate your new knowledge:</p>
			<ol>
				<li value="1">What kind of k3OS installations are available if you are using x86 or x86_64 devices?</li>
				<li>How do you install k3OS using an ISO image?</li>
				<li>What kind of k3OS installations are available if you are using ARMv7 or ARM64 devices?</li>
				<li>How do you install k3OS using overlay installation?</li>
				<li>How can I use configuration files to customize my cluster installations?</li>
				<li>How can I send parameters to my master or agent node using the k3OS arguments section?</li>
				<li>How can I create a multi-node cluster using the k3OS ISO image or the overlay installation?</li>
				<li>Where can I find more information about available parameters for K3s?</li>
				<li>What are the other types of installations available for k3OS?</li>
			</ol>
			<h1 id="_idParaDest-97"><a id="_idTextAnchor096"/>Further reading</h1>
			<p>You can refer to the following references for more information on the topics covered in this chapter:</p>
			<ul>
				<li>Official k3OS documentation: <a href="https://github.com/rancher/k3os">https://github.com/rancher/k3os</a></li>
				<li>Available releases for k3OS: <a href="https://github.com/rancher/k3os/releases">https://github.com/rancher/k3os/releases</a></li>
				<li>K3s installation options to add custom parameters to your config files: <a href="https://rancher.com/docs/k3s/latest/en/installation/install-options">https://rancher.com/docs/k3s/latest/en/installation/install-options</a></li>
				<li>k3OS image generator: <a href="https://github.com/sgielen/picl-k3OS-image-generator">https://github.com/sgielen/picl-k3OS-image-generator</a></li>
				<li><em class="italic">Installing k3s with Alpine Linux on Raspberry Pi 3B+</em>: <a href="https://blog.jiayihu.net/install-k3s-with-alpine-linux-on-raspberry-pi-3b">https://blog.jiayihu.net/install-k3s-with-alpine-linux-on-raspberry-pi-3b</a></li>
				<li>k3OS configuration file examples: <a href="https://www.chriswoolum.dev/k3s-cluster-on-raspberry-pi">https://www.chriswoolum.dev/k3s-cluster-on-raspberry-pi</a></li>
				<li><em class="italic">How to launch ARM aarch64 VM with QEMU from scratch</em>: <a href="https://futurewei-cloud.github.io/ARM-Datacenter/qemu/how-to-launch-aarch64-vm">https://futurewei-cloud.github.io/ARM-Datacenter/qemu/how-to-launch-aarch64-vm</a></li>
				<li>k3sup for K3s cluster creation: <a href="https://blog.alexellis.io/test-drive-k3s-on-raspberry-pi">https://blog.alexellis.io/test-drive-k3s-on-raspberry-pi</a></li>
			</ul>
		</div>
	</body></html>