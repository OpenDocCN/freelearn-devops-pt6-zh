<html><head></head><body>
		<div>
			<div id="_idContainer410" class="Content">
			</div>
		</div>
		<div id="_idContainer411" class="Content">
			<h1 id="_idParaDest-153">13. <a id="_idTextAnchor158"/>Azure Security Center for Kubernetes</h1>
		</div>
		<div id="_idContainer451" class="Content">
			<p>Kubernetes is a very powerful platform with a lot of configuration options. Configuring your workload the right way and making sure you follow best practices can be difficult. There are industry benchmarks that you can follow to get guidelines for how to deploy your workloads securely, such as the <strong class="bold">Center for Internet Security</strong> (<strong class="bold">CIS</strong>) Benchmarks for Kubernetes: <a href="">https://www.cisecurity.org/benchmark/kubernetes/</a>.</p>
			<p>Azure Security Center is a unified infrastructure security management platform. It provides continuous security monitoring and alerting for resources in Azure as well as for hybrid workloads. It offers protection for many Azure resources, including Kubernetes clusters. This will allow you to ensure your workloads are configured securely and protected.</p>
			<p>Azure Security Center offers two types of protection. First, it monitors your resource configuration and compares it to security best practices, and then gives you actionable recommendations to improve your security posture. Second, it also does threat protection by assessing your workloads and raising alerts when a potential threat is identified. This threat detection capability is part of a feature called Azure Defender within Azure Security Center.</p>
			<p>When it comes to monitoring Kubernetes workloads, Azure Security Center can monitor both your cluster configuration as well as the configuration of the workloads running in your cluster. To monitor the configuration of the workloads in your cluster, Azure Security Center uses Microsoft Azure Policy for Kubernetes. This free add-on for <strong class="bold">Azure Kubernetes Service</strong> (<strong class="bold">AKS</strong>) will enable Azure Security Center to compare the configuration of your workloads against known best practices.</p>
			<p>Azure Defender also has specific threat detection capabilities for Kubernetes. It monitors a combination of Kubernetes audit logs, node logs, as well as cluster and workload configuration to identify potential threats. Examples of threats that can be discovered are crypto-miners, the creation of high-privileged roles, or exposing the Kubernetes dashboard.</p>
			<p>In this chapter, you'll enable Azure Security Center, Azure Policy for Kubernetes, and Azure Defender for Kubernetes and monitor several sample applications against threats.</p>
			<p>In this chapter, we will cover the following topics:</p>
			<ul>
				<li>Azure Security Center for Kubernetes</li>
				<li>Azure Defender for Kubernetes</li>
				<li>Deploying offending workloads</li>
				<li>Analyzing configuration using Azure Secure Score</li>
				<li>Neutralizing threats using Azure Defender</li>
			</ul>
			<p>Let's start by setting up Azure Security Center for Kubernetes.</p>
			<h2 id="_idParaDest-154"><a id="_idTextAnchor159"/>Setting up Azure Security Center for Kubernetes</h2>
			<p>We'll start this chapter by setting up Azure Security Center for Kubernetes. To enable Azure Security Center for Kubernetes, you need to enable Azure Policy for AKS on your cluster. This will enable Azure Security to monitor your workload configuration. To benefit from Azure Defender's threat protection, you will also need to enable Azure Defender for Kubernetes on your subscription.</p>
			<p>Let's get started.</p>
			<ol>
				<li>Search for your AKS cluster in the Azure search bar, as shown in <em class="italics">Figure 13.1</em>:<div id="_idContainer412" class="IMG---Figure"><img src="image/B17338_13_01.jpg" alt="Looking for your cluster in the Azure search bar"/></div><p class="figure">Figure 13.1: Looking for your cluster in the Azure search bar</p></li>
				<li>You will now enable Azure Policy for AKS. To enable this, click the <span class="P---Screen-Text">Policies</span> button on the left-hand side and on the resulting pane, click on <span class="P---Screen-Text">Enable add-on</span>, as shown in <em class="italics">Figure 13.2</em>:<div id="_idContainer413" class="IMG---Figure"><img src="image/B17338_13_02.jpg" alt="Enabling Azure Policy for your AKS cluster"/></div><p class="figure">Figure 13.2: Enabling Azure Policy for AKS</p><p>Enabling the add-on will take a couple of minutes to complete. After a while, you should see a message saying that the service is now enabled, as shown in <em class="italics">Figure 13.3</em>:</p><div id="_idContainer414" class="IMG---Figure"><img src="image/B17338_13_03.jpg" alt="Notification stating that Azure Policy is enabled for your AKS cluster"/></div><p class="figure">Figure 13.3: Azure Policy for AKS is now enabled</p></li>
				<li>This has enabled Azure Policy for AKS. Next, you will enable Azure Defender to get the threat prevention ability from Azure Security Center. To do so, look up <strong class="inline">security center</strong> in the Azure portal's search bar, as shown in <em class="italics">Figure 13.4</em>:<div id="_idContainer415" class="IMG---Figure"><img src="image/B17338_13_04.jpg" alt="Searching for security center in the Azure search bar"/></div><p class="figure">Figure 13.4: Searching for security center in the Azure portal search bar</p></li>
				<li>If this is the first time you are accessing Azure Security Center in your subscription, you'll be greeted with a message as shown in <em class="italics">Figure 13.5</em>. To enable Azure Defender, click on <span class="P---Screen-Text">Upgrade</span> at the bottom of the screen:</li>
			</ol>
			<div>
				<div id="_idContainer416" class="IMG---Figure">
					<img src="image/B17338_13_05.jpg" alt="Enabling Azure Defender for your subscription"/>
				</div>
			</div>
			<p class="figure">Figure 13.5: Upgrading to Azure Defender</p>
			<p>If you're not accessing Azure Security Center in your subscription for the first time, you might not be greeted with this message to enable Azure Defender. To enable it, click on <span class="P---Screen-Text">Pricing &amp; settings</span> on the left-hand side and select your subscription, as shown in <em class="italics">Figure 13.6</em>:</p>
			<div>
				<div id="_idContainer417" class="IMG---Figure">
					<img src="image/B17338_13_06.jpg" alt="Turning on Azure Defender for your subscription"/>
				</div>
			</div>
			<p class="figure">Figure 13.6: Manually upgrading to Azure Defender</p>
			<p>In the resulting pane, select the right box with the title <span class="P---Screen-Text">Azure Defender on</span> and click the <span class="P---Screen-Text">Save</span> button at the top of the screen to enable Azure Defender. Optionally, you could tune which service you want to enable/disable Azure Defender for, as shown in <em class="italics">Figure 13.7</em>:</p>
			<div>
				<div id="_idContainer418" class="IMG---Figure">
					<img src="image/B17338_13_07.jpg" alt="Selecting the Azure Defender plan for your subscription"/>
				</div>
			</div>
			<p class="figure">Figure 13.7: Turning on Azure Defender for your subscription</p>
			<p>Now that you have enabled Azure Security Center and Azure Defender, it will take up to 30 minutes for the system to configure the default policy and start detections.</p>
			<p>While you are waiting for this configuration to become effective, you will deploy several offending workloads on your cluster, which will trigger alerts in Azure Defender.</p>
			<h2 id="_idParaDest-155"><a id="_idTextAnchor160"/>Deploying offending workloads</h2>
			<p>To trigger recommendations and threat alerts in Azure Security Center, you will need to have offending workloads deployed on your cluster. In this section, you will deploy a number of workloads to your cluster that are either not configured according to best practices or even contain potentially malicious software such as crypto-miners. Let's have a look at the examples of offending workloads you can find in the code samples for this chapter:</p>
			<ul>
				<li><strong class="inline">crypto-miner.yaml</strong>: This file contains a deployment that will create a crypto-miner on your cluster.<p class="snippet">1   apiVersion: apps/v1</p><p class="snippet">2   kind: Deployment</p><p class="snippet">3   metadata:</p><p class="snippet">4     name: crypto-miner</p><p class="snippet">5     labels:</p><p class="snippet">6       app: mining</p><p class="snippet">7   spec:</p><p class="snippet">8     replicas: 1</p><p class="snippet">9     selector:</p><p class="snippet">10      matchLabels:</p><p class="snippet">11        app: mining</p><p class="snippet">12    template:</p><p class="snippet">13      metadata:</p><p class="snippet">14        labels:</p><p class="snippet">15          app: mining</p><p class="snippet">16      spec:</p><p class="snippet">17        containers:</p><p class="snippet">18        - name: mining</p><p class="snippet">19          image: kannix/monero-miner:latest</p></li>
			</ul>
			<p>This file is a regular deployment in Kubernetes. As you can see on <em class="italics">line 19</em>, the container image for this deployment will be a crypto-miner.</p>
			<h4>Note</h4>
			<p class="callout">Make sure to stop running the crypto-miner as soon as you are done with this chapter, as explained in the Neutralizing threats using Azure Defender section. There is no point in running the crypto-miner any longer than this example requires.</p>
			<ul>
				<li><strong class="inline">escalation.yaml</strong>: This file contains a deployment that allows privilege escalations in the container. This means that a process in the container can get access to the host operating system. There are cases where this is desired behavior, but typically you don't want this configuration.<p class="snippet">1   apiVersion: apps/v1</p><p class="snippet">2   kind: Deployment</p><p class="snippet">3   metadata:</p><p class="snippet">4     name: escalation</p><p class="snippet">5     labels:</p><p class="snippet">6       app: nginx-escalation</p><p class="snippet">7   spec:</p><p class="snippet">8     replicas: 1</p><p class="snippet">9     selector:</p><p class="snippet">10      matchLabels:</p><p class="snippet">11        app: nginx-escalation</p><p class="snippet">12    template:</p><p class="snippet">13      metadata:</p><p class="snippet">14        labels:</p><p class="snippet">15          app: nginx-escalation</p><p class="snippet">16      spec:</p><p class="snippet">17        containers:</p><p class="snippet">18        - name: nginx-escalation</p><p class="snippet">19          image: nginx:alpine</p><p class="snippet">20          securityContext:</p><p class="snippet">21            allowPrivilegeEscalation: true</p></li>
			</ul>
			<p>As you can see in the preceding code sample, on <em class="italics">lines 20–21</em>, you configure the security context of the container with <strong class="inline">securityContext</strong>. You allow privilege escalation on <em class="italics">line 21</em>.</p>
			<ul>
				<li><strong class="inline">host-volume.yaml</strong>: This file contains a deployment with a directory on the host mounted in the container. This is not recommended because this way, the container can get access to the host.<p class="snippet">1   apiVersion: apps/v1</p><p class="snippet">2   kind: Deployment</p><p class="snippet">3   metadata:</p><p class="snippet">4     name: host-volume</p><p class="snippet">5     labels:</p><p class="snippet">6       app: nginx-host-volume</p><p class="snippet">7   spec:</p><p class="snippet">8     replicas: 1</p><p class="snippet">9     selector:</p><p class="snippet">10      matchLabels:</p><p class="snippet">11        app: nginx-host-volume</p><p class="snippet">12    template:</p><p class="snippet">13      metadata:</p><p class="snippet">14        labels:</p><p class="snippet">15          app: nginx-host-volume</p><p class="snippet">16      spec:</p><p class="snippet">17        containers:</p><p class="snippet">18        - name: nginx-host-volume</p><p class="snippet">19          image: nginx:alpine</p><p class="snippet">20          volumeMounts:</p><p class="snippet">21          - mountPath: /test-pd</p><p class="snippet">22            name: test-volume</p><p class="snippet">23            readOnly: true</p><p class="snippet">24        volumes:</p><p class="snippet">25        - name: test-volume</p><p class="snippet">26          hostPath:</p><p class="snippet">27            # Directory on host</p><p class="snippet">28            path: /tmp</p></li>
			</ul>
			<p>This code sample contains a <strong class="inline">volumeMount</strong> field and a volume. As you can see in <em class="italics">lines 24–28</em>, the volume is using <strong class="inline">hostPath</strong>, meaning it mounts a volume on the node running the container.</p>
			<ul>
				<li><strong class="inline">role.yaml</strong>: A role with very broad permissions. It is recommended to approach roles in Kubernetes with the principle of least privilege to ensure permissions are tightly controlled. A role with broad permissions is first and foremost a bad configuration, but worse, could be a sign of compromise on your cluster.<p class="snippet">1   apiVersion: rbac.authorization.k8s.io/v1</p><p class="snippet">2   kind: ClusterRole</p><p class="snippet">3   metadata:</p><p class="snippet">4     name: super-admin</p><p class="snippet">5   rules:</p><p class="snippet">6   - apiGroups: ["*" ]</p><p class="snippet">7     resources: ["*"]</p><p class="snippet">8     verbs: ["*"]</p></li>
			</ul>
			<p>This instance of <strong class="inline">ClusterRole</strong> gives very broad permissions, as you can see in <em class="italics">lines 6–8</em>. This configuration gives anybody who gets assigned this role all permissions on all resources on all APIs in Kubernetes.</p>
			<p>None of the deployments in these code samples contain resource requests and limits. As explained in <em class="italics">Chapter 3</em>, <em class="italics">Application deployment on AKS</em>, it is recommended to configure resource requests and limits, as these can prevent a workload from consuming too many resources.</p>
			<p>Finally, you will also deploy the Kubernetes dashboard on a public service. This is also highly discouraged, as this might inadvertently give attackers access to your cluster. You will see how Azure Defender detects this.</p>
			<p>Let's start deploying these files.</p>
			<ol>
				<li value="1">Open Cloud Shell in the Azure portal and navigating to the code samples for this chapter.</li>
				<li>Once there, execute the following commands to create the offending workloads.<p class="snippet">kubectl create -f crypto-miner.yaml</p><p class="snippet">kubectl create -f escalation.yaml</p><p class="snippet">kubectl create -f host-volume.yaml</p><p class="snippet">kubectl create -f role.yaml</p><p>This will create an output similar to <em class="italics">Figure 13.8</em>:</p><div id="_idContainer419" class="IMG---Figure"><img src="image/B17338_13_08.jpg" alt="Creating offending workloads to trigger recommendations and threat alerts in Azure Security Center"/></div><p class="figure">Figure 13.8: Creating the offending workload</p></li>
				<li>Now, deploy the Kubernetes dashboard using the following command:<p class="snippet">kubectl apply -f <a href=""><strong class="inline">https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</strong></a></p><p>This will create an output similar to <em class="italics">Figure 13.9</em>:</p><div id="_idContainer420" class="IMG---Figure"><img src="image/B17338_13_09.jpg" alt="Deploying the Kubernetes dashboard"/></div><p class="figure">Figure 13.9: Creating the Kubernetes dashboard</p></li>
				<li>By default, the Kubernetes dashboard is not exposed through a load balancer. This is also the recommended configuration, because the dashboard gives broad access to your cluster. In this chapter, however, you will create this discouraged configuration to trigger a security alert in Azure Defender. To add a load balancer to the Kubernetes dashboard, use the following command:<p class="snippet">kubectl patch service \</p><p class="snippet">  kubernetes-dashboard -n kubernetes-dashboard \</p><p class="snippet">  -p '{"spec": {"type": "LoadBalancer"}}'</p><p>This will patch the service and turn it into a service of the <strong class="inline">LoadBalancer</strong> type. Verify that this was patched successfully and get the public IP address of the service using the following command:</p><p class="snippet">kubectl get service -n kubernetes-dashboard</p><p>This will generate an output similar to <em class="italics">Figure 13.10</em>:</p><div id="_idContainer421" class="IMG---Figure"><img src="image/B17338_13_10.jpg" alt="Adding a load balancer to the Kubernetes-dashboard service and fetching its public IP"/></div><p class="figure">Figure 13.10: Getting the public IP of the kubernetes-dashboard service</p></li>
				<li>Verify that you can access this service by browsing to <strong class="inline">https://&lt;public IP&gt;</strong>. Depending on your browser configuration, you might get a certificate error, which you can bypass by selecting <span class="P---Screen-Text">Continue to &lt;public IP&gt; (unsafe)</span>, as shown in <em class="italics">Figure 13.11</em>:</li>
			</ol>
			<div>
				<div id="_idContainer422" class="IMG---Figure">
					<img src="image/B17338_13_11.jpg" alt="Navigating to the Kubernetes dashboard service and verifying that the connection isn’t secure"/>
				</div>
			</div>
			<p class="figure">Figure 13.11: Security warning about the certificate on the Kubernetes dashboard service</p>
			<p>Once you have continued to the dashboard, you should get a sign-in screen as shown in <em class="italics">Figure 13.12</em>:</p>
			<div>
				<div id="_idContainer423" class="IMG---Figure">
					<img src="image/B17338_13_12.jpg" alt="The Kubernetes dashboard login"/>
				</div>
			</div>
			<p class="figure">Figure 13.12: The exposed Kubernetes dashboard</p>
			<p>You won't sign in to the dashboard here, but if you wish to explore its capabilities, please refer to the Kubernetes documentation at <a href="">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a>.</p>
			<p>You now have five offending workloads running on your cluster. Some of these will cause configuration warnings in Azure Security Center; some others will even trigger a security alert. You will explore those in the next two sections of this chapter.</p>
			<h2 id="_idParaDest-156"><a id="_idTextAnchor161"/>Analyzing configuration using Azure Secure Score</h2>
			<p>In the previous section, you created several workloads that are purposefully misconfigured. In this section, you'll review the recommendations in Azure Security Center related to these workloads.</p>
			<h4>Note</h4>
			<p class="callout">It can take up to 30 minutes after the workloads have been created for recommendations and alerts to show up. </p>
			<ol>
				<li value="1">After you have created the offending workloads, you will get security recommendations in Azure Security Center. To start, click on <span class="P---Screen-Text">Secure Score</span> in the left-hand navigation within Azure Security Center. This will show you a pane similar to <em class="italics">Figure 13.13</em>:<div id="_idContainer424" class="IMG---Figure"><img src="image/B17338_13_13.jpg" alt="Checking your Secure Score in Azure Security Center after creating offending workloads"/></div><p class="figure">Figure 13.13: Secure Score in Azure Security Center</p><p>What you see here is a summary of the security posture of your environment. In the example shown in <em class="italics">Figure 13.13</em>, you see that the overall secure score was <span class="P---Screen-Text">32%</span>. If you manage multiple Azure subscriptions, this view can give you a quick bird's-eye view of the security configuration of your environment.</p></li>
				<li>Let's drill down into the configuration of the Kubernetes cluster by clicking on the <span class="P---Screen-Text">Azure subscription 1</span> subscription at the bottom of <em class="italics">Figure 13.13</em>. This will bring you to a pane similar to <em class="italics">Figure 13.14</em>: <div id="_idContainer425" class="IMG---Figure"><img src="image/B17338_13_14.jpg" alt="Secure Score and security recommendations for your Azure subscription"/></div><p class="figure">Figure 13.14: Secure Score details for the subscription</p><p>This view contains more details about the secure score for this subscription. It again shows you the secure score, as well as the recommendation status and resource health. The bottom of the screen contains more details about the specific recommendations.</p></li>
				<li>Tune this screen to get more insight into the Kubernetes recommendations. To do this, disable the <span class="P---Screen-Text">Group by controls</span> option on the right-hand side of the screen, and set the <span class="P---Screen-Text">Resource type</span> filter to <span class="P---Screen-Text">managed cluster</span>, as shown in <em class="italics">Figure 13.15</em>:<div id="_idContainer426" class="IMG---Figure"><img src="image/B17338_13_15.jpg" alt="Azure provides security recommendations and shows the health of the resource for your Kubernetes clusters"/></div><p class="figure">Figure 13.15: Kubernetes recommendations in Azure Security Center</p><p>You are now looking at a list of Kubernetes security recommendations recommended by Azure Security Center. The list is too exhaustive to cover completely in this chapter, but if you want to see more details about each recommendation, please refer to the AKS documentation for more detailed descriptions: <a href="">https://docs.microsoft.com/azure/aks/policy-reference</a>.</p></li>
				<li>Let's, however, explore a number of the recommendations that were caused by the offending workloads you created earlier. Start by clicking on the recommendation called <span class="P---Screen-Text">Container with privilege escalation should be avoided</span>. This will bring you to a view similar to <em class="italics">Figure 13.16</em>:<div id="_idContainer427" class="IMG---Figure"><img src="image/B17338_13_16.jpg" alt="Exploring the Container with privilege escalation should be avoided recommendation"/></div><p class="figure">Figure 13.16: Details of the Container with privilege escalation should be avoided recommendation</p><p>As you can see, this recommendation contains a description of the recommendation itself, as well as a number of remediation steps to follow this recommendation. It also shows you the affected resource, which in this case is an AKS cluster. If you click on the cluster, you will even get more details about the offending workload, as shown in <em class="italics">Figure 13.17</em>:</p><div id="_idContainer428" class="IMG---Figure"><img src="image/B17338_13_17.jpg" alt="Clicking on the cluster on the recommendation page gives you further details about the affected components"/></div><p class="figure"> </p><p class="figure">Figure 13.17: Pods affected by the privilege escalation recommendation</p><p>In this case, each of the pods you created triggered this recommendation, not just the one where privilege escalation was allowed. This shows you that Kubernetes allows this privilege escalation by default and you should implement the safeguard in all your deployments. This shows you the benefit of a security monitoring solution such as Azure Security Center, to monitor against potential side effects of the default configuration.</p></li>
				<li>Let's apply the suggested remediation to this issue. To solve the privilege escalation, you will need to configure the security context of the container to no longer allow privilege escalation. This can be done by updating each deployment using the following commands:<p class="snippet">kubectl patch deployment crypto-miner -p '</p><p class="snippet">  {</p><p class="snippet">    "spec": {</p><p class="snippet">      "template": {</p><p class="snippet">        "spec": {</p><p class="snippet">          "containers": [</p><p class="snippet">            {</p><p class="snippet">              "name": "mining",</p><p class="snippet">              "securityContext": {</p><p class="snippet">                "allowPrivilegeEscalation": false</p><p class="snippet">              }</p><p class="snippet">            }</p><p class="snippet">          ]</p><p class="snippet">        }</p><p class="snippet">      }</p><p class="snippet">    }</p><p class="snippet">  }</p><p class="snippet">  '</p><p class="snippet">kubectl patch deployment escalation -p '</p><p class="snippet">  {</p><p class="snippet">    "spec": {</p><p class="snippet">      "template": {</p><p class="snippet">        "spec": {</p><p class="snippet">          "containers": [</p><p class="snippet">            {</p><p class="snippet">              "name": "nginx-escalation",</p><p class="snippet">              "securityContext": {</p><p class="snippet">                "allowPrivilegeEscalation": false</p><p class="snippet">              }</p><p class="snippet">            }</p><p class="snippet">          ]</p><p class="snippet">        }</p><p class="snippet">      }</p><p class="snippet">    }</p><p class="snippet">  }</p><p class="snippet">  '</p><p class="snippet">kubectl patch deployment host-volume -p '</p><p class="snippet">  {</p><p class="snippet">    "spec": {</p><p class="snippet">      "template": {</p><p class="snippet">        "spec": {</p><p class="snippet">          "containers": [</p><p class="snippet">            {</p><p class="snippet">              "name": "nginx-host-volume",</p><p class="snippet">              "securityContext": {</p><p class="snippet">                "allowPrivilegeEscalation": false</p><p class="snippet">              }</p><p class="snippet">            }</p><p class="snippet">          ]</p><p class="snippet">        }</p><p class="snippet">      }</p><p class="snippet">    }</p><p class="snippet">  }</p><p class="snippet">  '</p><p>As you can see in the command, you are patching each deployment. In each patch, you are configuring the <strong class="inline">securityContext</strong> field and setting the <strong class="inline">allowPrivilegeEscalation</strong> field to <strong class="inline">false</strong>.</p><p>After you have applied the patch, it will take Azure Security Center up to 30 minutes to refresh the security recommendation. After that time passes, your cluster should show up as a healthy resource for this recommendation, as shown in <em class="italics">Figure 13.18</em>:</p><div id="_idContainer429" class="IMG---Figure"><img src="image/B17338_13_18.jpg" alt="After following the remediation steps the cluster if now listed as a healthy resource for this condition"/></div><p class="figure">Figure 13.18: Cluster is now healthy for the privilege escalation recommendation</p></li>
				<li>Let's investigate another recommendation, namely the one called <span class="P---Screen-Text">Usage of pod HostPath volume mounts should be restricted to a known list to restrict node access from compromised containers</span>. Click on this recommendation to be shown more details, as shown in <em class="italics">Figure 13.19</em>:<div id="_idContainer430" class="IMG---Figure"><img src="image/B17338_13_19.jpg" alt="Investigating the recommendation called “Usage of pod HostPath volume mounts should be restricted to a known list to restrict node access from compromised containers“"/></div><p class="figure">Figure 13.19: More details about the HostPath recommendation</p><p>This recommendation shows you similar information to the previous one. However, the policy that triggered this recommendation can be tuned to allow certain <strong class="inline">HostPath</strong> to be accessed. Let's explore how to edit the policy to allow this.</p></li>
				<li>Go back to the Azure Security Center main pane and click on <span class="P---Screen-Text">Security policy</span> on the left-hand side. In the resulting pane, click on your subscription and then click on the <span class="P---Screen-Text">ASC Default </span>assignment shown in <em class="italics">Figure 13.20</em>:<div id="_idContainer431" class="IMG---Figure"><img src="image/B17338_13_20.jpg" alt="Navigating to the security policy of your Azure subscription "/></div><p class="figure">Figure 13.20: ASC default policy assignment</p></li>
				<li>In the resulting pane, click on <span class="P---Screen-Text">Parameters</span> at the top of the screen. Look for <span class="P---Screen-Text">Allowed host paths</span> in the list of parameters and change that parameter to the following:<p class="snippet">{  "paths": ["/tmp"]}</p><p>The result is shown in <em class="italics">Figure 13.21</em>:</p><div id="_idContainer432" class="IMG---Figure"><img src="image/B17338_13_21.jpg" alt="Modifying the allowed host path for the ASC Default assignment"/></div><p class="figure">Figure 13.21: Adding a path to the allowed host paths</p><p>To apply the changes, click <span class="P---Screen-Text">Review + save</span> at the bottom of the screen and then click <span class="P---Screen-Text">Save</span> on the final screen:</p><div id="_idContainer433" class="IMG---Figure"><img src="image/B17338_13_22.jpg" alt="Clicking Save to confirm the modifications"/></div><p class="figure">Figure 13.22: Clicking Save to confirm the policy change</p><p>It will now take about 30 minutes for the recommendation to be refreshed. After 30 minutes, this recommendation will no longer be active, since you configured the <strong class="inline">/tmp</strong> path to be allowed.</p></li>
				<li>There's one final recommendation worth highlighting in this list. That is <span class="P---Screen-Text">Kubernetes Services Management API server should be configured with restricted access</span>. If you remember, in <em class="italics">Chapter 11</em>, <em class="italics">Network security in AKS</em>, you configured authorized IP ranges on your cluster. This is recommended by Microsoft, and also shows up as an Azure Security Center recommendation. Click on that recommendation to get more details, as shown in <em class="italics">Figure 13.23</em>:</li>
			</ol>
			<div>
				<div id="_idContainer434" class="IMG---Figure">
					<img src="image/B17338_13_23.jpg" alt="Investigating the Kubernetes Services Management API server should be configured with restricted access recommendation"/>
				</div>
			</div>
			<p class="figure">Figure 13.23: Details explaining that authorized IP ranges should be enabled</p>
			<p>As you can see, again you get a description of the recommendation and remediation steps. The reason this recommendation is worth highlighting is that it contains a quick fix remediation within Azure Security Center. To quickly remediate this recommendation, select your AKS cluster and click <span class="P---Screen-Text">Remediate</span> at the bottom of the screen, as shown in <em class="italics">Figure 13.24</em>:</p>
			<div>
				<div id="_idContainer435" class="IMG---Figure">
					<img src="image/B17338_13_24.jpg" alt="Remediating the authorized IP recommendation using the quick-fix Remediate button"/>
				</div>
			</div>
			<p class="figure">Figure 13.24: Remediating the authorized IP recommendation</p>
			<p>This will show you a view similar to <em class="italics">Figure 13.25</em> where you could input the IP ranges you need to authorize access from.</p>
			<div>
				<div id="_idContainer436" class="IMG---Figure">
					<img src="image/B17338_13_25.jpg" alt="Setting up authorized IP ranges through Azure Security Center"/>
				</div>
			</div>
			<p class="figure">Figure 13.25: Setting up authorized IP ranges through Azure Security Center</p>
			<p>You could configure this configuration from within Azure Security Center. Since you'll be using Cloud Shell in the next steps and next chapters and Cloud Shell does not have a fixed IP, it's not recommended to apply the remediation while working through this book. It is, however, worthwhile to show that Azure Security Center allows you to remediate certain configuration recommendations directly from within Security Center.</p>
			<p>You have now explored the recommendations and the secure score in Azure Security Center. If you want to learn more about this, please refer to the Azure documentation, which contains a YAML deployment example fully configured with all the recommendations: <a href="">https://docs.microsoft.com/azure/security-center/kubernetes-workload-protections</a>.</p>
			<h2 id="_idParaDest-157"><a id="_idTextAnchor162"/>Neutralizing threats using Azure Defender</h2>
			<p>Now that you've explored the configuration best practices using Azure Security Center and Secure Score, you will explore how to investigate and deal with security alerts and active threats. Some of the workloads you created should have triggered security alerts by now, which you can investigate in Azure Defender.</p>
			<p>Specifically, in the <em class="italics">Deploying offending workloads</em> section, you created three workloads that trigger security alerts in Azure Defender:</p>
			<ul>
				<li><strong class="inline">crypto-miner.yaml</strong>: By deploying this file, you created a crypto-miner on your cluster. This crypto-miner will generate two security alerts in Azure Defender as you will see in this section. One alert will be generated by monitoring the Kubernetes cluster itself, while another alert will be generated based on DNS traffic.</li>
				<li><strong class="inline">role.yaml</strong>: This file contained a cluster-wide role with very broad permissions. This will generate a security alert in Azure Defender notifying you of the risk.</li>
				<li>Kubernetes dashboard: You also created the Kubernetes dashboard and exposed this publicly. Azure Defender will also generate a security alert based on this.</li>
			</ul>
			<p>Let's explore each of these security alerts in details:</p>
			<ol>
				<li value="1">To start, in Azure Security Center, click on <span class="P---Screen-Text">Azure Defender</span> in the left-hand navigation bar. This will open the Azure Defender pane in Azure Security Center. This shows you your coverage, your security alerts, and the advanced protection options, as shown in <em class="italics">Figure 13.26</em>. In this section, you will focus on the four security alerts that were generated.<div id="_idContainer437" class="IMG---Figure"><img src="image/B17338_13_26.jpg" alt="Azure Defender overview pane"/></div><p class="figure">Figure 13.26: Azure Defender - Overview pane</p></li>
				<li>To get more details about the security alerts, click anywhere on the <span class="P---Screen-Text">Security alerts</span> bar chart in the middle of the screen. That will take you to a new pane, as shown in <em class="italics">Figure 13.27</em>:<div id="_idContainer438" class="IMG---Figure"><img src="image/B17338_13_27.jpg" alt="Clicking on the Security alerts bar chart provides details about the severity of the alert, their status, and the affected resource"/></div><p class="figure"> Figure 13.27: Security alerts in Azure Defender</p><p>As you can see in <em class="italics">Figure 13.27</em>, four security alerts have been triggered: one for the exposed Kubernetes dashboard, two for the crypto-miner, and one for the high-privileged roles. Let's explore each one in more detail.</p></li>
				<li>Let's start by exploring the <span class="P---Screen-Text">Exposed Kubernetes dashboard detected</span> alert. Click on the alert title to get more details. To see all the details, click on <span class="P---Screen-Text">View full details</span> in the resulting pane, as shown in <em class="italics">Figure 13.28</em>:<div id="_idContainer439" class="IMG---Figure"><img src="image/B17338_13_28.jpg" alt="Clicking on View full details after selecting an alert will provide the details of the alert"/></div><p class="figure">Figure 13.28: Getting full details of the alert</p><p>This will take you to a new pane, as shown in <em class="italics">Figure 13.29</em>:</p><div id="_idContainer440" class="IMG---Figure"><img src="image/B17338_13_29.jpg" alt="Details of the Exposed Kubernetes Dashboard detected alert"/></div><p class="figure">Figure 13.29: Details of the Exposed Kubernetes dashboard detected alert</p><p>This shows you a couple of information points. First, it classifies this alert as high severity, marks it as active, and also marks when it was first encountered. Next, you get a description of the alert, which in this case explains that the dashboard should not be exposed publicly. It also shows you the affected resource. Finally, you see which stage of the MITRE ATT&amp;CK® tactics framework this attack targets. The MITRE ATT&amp;CK® tactics framework is a framework describing multiple stages in a cyber-attack. For more information on MITRE ATT&amp;CK® tactics, please refer to <a href="https://attack.mitre.org/versions/v7/">https://attack.mitre.org/versions/v7/</a>.</p><p>On the right-hand side of the screen, you get more details about the alert. This contains the service name, the namespace, the port of the service, the target port exposed on the backend pods, and the affected Azure resource ID and subscription ID. If you click the <span class="P---Screen-Text">Next: Take Action &gt;&gt;</span> button at the bottom of the screen, you'll be taken to a new pane, as shown in <em class="italics">Figure 13.30</em>:</p><div id="_idContainer441" class="IMG---Figure"><img src="image/B17338_13_30.jpg" alt="The Take action pane provides information on how to mitigate the threat and how to prevent future attacks"/></div><p class="figure">Figure 13.30: Security recommendations on the dashboard alert</p><p>In the <span class="P---Screen-Text">Take action</span> pane, you get information on how to mitigate the threat and how to prevent future attacks like this. Notice how the<span class="P---Screen-Text"> Prevent future attacks </span>section contains a link to the security recommendations you reviewed in the previous section.</p></li>
				<li>Let's take the suggested action and update the Kubernetes dashboard service so it is no longer of the <strong class="inline">LoadBalancer</strong> type using the following command. This command will remove the <strong class="inline">nodePort</strong> that Kubernetes set up to expose the service through the load balancer and change the type of the service back to the <strong class="inline">ClusterIP</strong> type, which is only available from within the cluster.<p class="snippet">kubectl patch service \</p><p class="snippet">  kubernetes-dashboard -n kubernetes-dashboard \</p><p class="snippet">  -p '{</p><p class="snippet">        "spec": {</p><p class="snippet">          "ports": [</p><p class="snippet">            {</p><p class="snippet">              "nodePort": null,</p><p class="snippet">              "port": 443</p><p class="snippet">            }</p><p class="snippet">          ],</p><p class="snippet">          "type": "ClusterIP"</p><p class="snippet">        }</p><p class="snippet">      }'</p><p>Finally, you see that you can optionally trigger automated responses or suppress similar alerts in the future in case this alert is a false positive.</p></li>
				<li>Now that you have mitigated the threat, you can dismiss the alert. That way, others using the same subscription don't see this same alert. To dismiss the alert, click on the status on the left-hand side of the screen, select <span class="P---Screen-Text">Dismissed</span>, and click <span class="P---Screen-Text">OK</span>, as shown in <em class="italics">Figure 13.31</em>:<div id="_idContainer442" class="IMG---Figure"><img src="image/B17338_13_31.jpg" alt="Dismissing the dashboard alert after the threat has been mitigated"/></div><p class="figure">Figure 13.31: Dismissing the dashboard alert</p></li>
				<li>Let's move on to the next alert. Close the detail panes for the dashboard alert by pressing the <span class="P---Screen-Text">X</span> at the top of the screen. Let's now focus on the first <span class="P---Screen-Text">Digital currency mining container detected</span> alert. Select that alert and click on <span class="P---Screen-Text">View full details</span> as you did with the previous alert. This will take you to a pane similar to <em class="italics">Figure 13.32</em>:<div id="_idContainer443" class="IMG---Figure"><img src="image/B17338_13_32.jpg" alt="Investigating the Digital currency mining container detected alert"/></div><p class="figure">Figure 13.32: Details of the Digital currency mining container detected alert</p><p>This view contains similar details to the previous alert. As you can see, this alert is part of the Execution phase of the MITRE ATT&amp;CK® tactics framework. On the right-hand side of the pane, you now see the name of the offending container, the image it's using, its namespace, and the name of the offending pod.</p><p>If you press the <span class="P---Screen-Text">Next: Take Action &gt;&gt;</span> button at the bottom of the screen, you'll be taken to the <span class="P---Screen-Text">Take action</span> view on this alert, as shown in <em class="italics">Figure 13.33</em>:</p><div id="_idContainer444" class="IMG---Figure"><img src="image/B17338_13_33.jpg" alt="The Take action pane provides information on how to mitigate the threat and how to prevent future attacks"/></div><p class="figure">Figure 13.33: Security recommendations on the Digital currency mining container detected alert</p><p>Here, again, you see similar details to the previous alert. In the <span class="P---Screen-Text">Mitigate the threat</span> section, you get a different description of how to mitigate this ongoing threat. Don't take any mitigating action yet, since you'll need to explore one more alert related to the crypto-miner.</p></li>
				<li>To explore that alert, close the detailed pane for the first crypto-miner alert by pressing the <span class="P---Screen-Text">X</span> at the top of the screen. Now select the second alert, which is called <span class="P---Screen-Text">Digital currency mining activity (Preview)</span>. This is actually not a Kubernetes alert, but an alert based on DNS, as you can see in <em class="italics">Figure 13.34</em>:<h4>Note</h4><p class="callout">This alert will only show up if you enabled Azure Defender for DNS. If you did not enable this, you will not get this alert.</p><div id="_idContainer445" class="IMG---Figure"><img src="image/B17338_13_34.jpg" alt="Investigating the Digital currency mining activity (Preview) alert"/></div><p class="figure">Figure 13.34: Details of the Digital currency mining activity alert</p><p>This alert was generated by Azure Defender for DNS. It shows you a number of details about the attack itself. On the right-hand side of the pane, you see more details about the attack, showing you the domain name and the IP addresses used. If you have a look at the <span class="P---Screen-Text">Take action</span> pane, you get more information about potential next steps for this attack, as shown in <em class="italics">Figure 13.35</em>:</p><div id="_idContainer446" class="IMG---Figure"><img src="image/B17338_13_35.jpg" alt="The Take action pane provides information on how to mitigate the threat and how to prevent future attacks"/></div><p class="figure">Figure 13.35: Security recommendations on the curreny mining alert</p><p>Since this is a DNS-based alert, there are limited specifics here on which processes to inspect. However, Azure still provides you with a number of steps to run through to mitigate this threat. As you already know the process that is running this crypto-miner, you can mitigate the threat using the following command:</p><p class="snippet">kubectl delete -f crypto-miner.yaml</p></li>
				<li>This will resolve the alert. To actually mark it as resolved, you can dismiss the alert in the Azure portal. To do this, click on the status on the left-hand side of the screen, select the <span class="P---Screen-Text">Dismissed</span> status, and click <span class="P---Screen-Text">OK</span>, as shown in <em class="italics">Figure 13.36</em>:<div id="_idContainer447" class="IMG---Figure"><img src="image/B17338_13_36.jpg" alt="Dismissing the Digital currency mining activity (Preview) alert after the threat has been mitigated"/></div><p class="figure">Figure 13.36: Dismissing the digital currency DNS alert</p></li>
				<li>From the <span class="P---Screen-Text">Security alerts</span> pane, click on the last alert, which is called <span class="P---Screen-Text">New high privileges role detected</span>, and click on <span class="P---Screen-Text">View full details</span> in the resulting pane. This will bring you to a pane similar to <em class="italics">Figure 13.37</em>:</li>
			</ol>
			<div>
				<div id="_idContainer448" class="IMG---Figure">
					<img src="image/B17338_13_37.jpg" alt="Exploring the New high privileges role detected alert"/>
				</div>
			</div>
			<p class="figure">Figure 13.37: New high privileges role detected alert</p>
			<p>This is a low-severity alert. As with the previous alerts, you get the description, the affected resource, and the phase in the MITRE ATT&amp;CK® tactics framework, which is persistence in this case. This means that this potential attack is used by attackers to gain persistent access to your environment.</p>
			<p>On the right-hand side, you also get the alert details, with the role name, the namespace (which in this case is the whole cluster since it is a <strong class="inline">ClusterRole</strong>), and the rules this role gives access to. If you click the <span class="P---Screen-Text">Next: Take Action &gt;&gt;</span> button, you'll get more information about the mitigation as well, as shown in <em class="italics">Figure 13.38</em>:</p>
			<div>
				<div id="_idContainer449" class="IMG---Figure">
					<img src="image/B17338_13_38.jpg" alt="The Take action pane provides information on how to mitigate the threat and how to prevent future attacks"/>
				</div>
			</div>
			<p class="figure">Figure 13.38: Security recommendations on the new high privileges alert</p>
			<p>As you can see here, Azure recommends you review the role in the alerts and check any role bindings linked to this role. It is also recommended to grant more restricted privileges than the open permissions as provided in this role. Let's also remove this threat from the cluster using the following command:</p>
			<p class="snippet">kubectl delete -f role.yaml</p>
			<p>This will delete the role from the cluster. You can also dismiss this alert, by clicking on the status on the left-hand side of the screen, selecting the <span class="P---Screen-Text">Dismissed</span> state, and clicking <span class="P---Screen-Text">OK</span>, as shown in <em class="italics">Figure 13.39</em>:</p>
			<div>
				<div id="_idContainer450" class="IMG---Figure">
					<img src="image/B17338_13_39.jpg" alt="Dismissing the high privileges role alert after the threat has been mitigated"/>
				</div>
			</div>
			<p class="figure">Figure 13.39: Dismissing the New high privileges alert</p>
			<p>This covers all the alerts that were generated by the resources you created earlier in this chapter. The resources linked to the alerts were already deleted as part of the remediation, but let's also delete the other resources that were created in this chapter:</p>
			<p class="snippet">kubectl delete -f escalation.yaml</p>
			<p class="snippet">kubectl delete -f host-volume.yaml</p>
			<p class="snippet">kubectl delete -f <a href="">https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</a></p>
			<p>And that concludes this chapter.</p>
			<h2 id="_idParaDest-158"><a id="_idTextAnchor163"/>Summary</h2>
			<p>In this chapter, you explored Azure Security Center and Azure Defender. Azure Security Center is an infrastructure security monitoring platform. It provides both monitoring of security configuration as well as monitoring of any potential ongoing threats. To monitor workloads in a Kubernetes cluster, Azure Security Center makes use of Azure Policy for AKS.</p>
			<p>To start, you enabled Azure Policy for AKS. You then enabled Azure Security Center and Azure Defender on your subscription.</p>
			<p>You then created five harmful workloads on your cluster. Some of those caused configuration recommendations in Azure Security Center. Some others even caused security alerts to be triggered in Azure Defender. You explored four security alerts and followed the mitigation steps recommended to resolve these alerts.</p>
		</div>
	</body></html>