<html><head></head><body>
<div id="_idContainer023">
<h1 class="chapter-number" id="_idParaDest-64"><a id="_idTextAnchor064"/><span class="koboSpan" id="kobo.1.1">3</span></h1>
<h1 id="_idParaDest-65"><a id="_idTextAnchor065"/><span class="koboSpan" id="kobo.2.1">Encrypting Secrets the Kubernetes-Native Way</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In the previous two chapters, we have reviewed together the foundational knowledge regarding the architecture, implementation, and usage of </span><strong class="source-inline"><span class="koboSpan" id="kobo.4.1">Secret</span></strong><span class="koboSpan" id="kobo.5.1"> objects within the Kubernetes architecture and design. </span><span class="koboSpan" id="kobo.5.2">We also established that </span><strong class="source-inline"><span class="koboSpan" id="kobo.6.1">Secret</span></strong><span class="koboSpan" id="kobo.7.1"> objects are not safe as-is within Kubernetes platforms due to their unencrypted nature, both in terms of key-value pair and the etcd data file, resulting in major security exposures for </span><span class="No-Break"><span class="koboSpan" id="kobo.8.1">your business.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">In this chapter, we will get closer to both Kubernetes and etcd, understanding their associated security weaknesses and how we can mitigate or reduce them. </span><span class="koboSpan" id="kobo.9.2">While these responses could be considered tightly coupled with the container platform deployment, thanks to the open source nature of the operating system and Kubernetes distribution, most if not all can be </span><span class="No-Break"><span class="koboSpan" id="kobo.10.1">applied widely.</span></span></p>
<p><span class="koboSpan" id="kobo.11.1">This chapter focuses on an in-platform approach, starting with the Kubernetes-native encryption design, including the possibility to connect with a </span><strong class="bold"><span class="koboSpan" id="kobo.12.1">Key Management Service</span></strong><span class="koboSpan" id="kobo.13.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.14.1">KMS</span></strong><span class="koboSpan" id="kobo.15.1">), and </span><a id="_idIndexMarker120"/><span class="koboSpan" id="kobo.16.1">concluding with an etcd </span><span class="No-Break"><span class="koboSpan" id="kobo.17.1">hardening overview.</span></span></p>
<p><span class="koboSpan" id="kobo.18.1">In this chapter, we will cover the </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.20.1">Native encryption without any </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">external components</span></span></li>
<li><span class="koboSpan" id="kobo.22.1">Native encryption with an </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">external component</span></span></li>
<li><span class="koboSpan" id="kobo.24.1">Encryption at rest of etcd and </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">other components</span></span></li>
</ul>
<h1 id="_idParaDest-66"><a id="_idTextAnchor066"/><span class="koboSpan" id="kobo.26.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.27.1">To link concepts with hands-on examples, we are leveraging a series of tools and platforms commonly used to interact with containers, Kubernetes, and Secrets management. </span><span class="koboSpan" id="kobo.27.2">For this chapter, we are continuing with the same set of tools used in the </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">earlier chapters:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.29.1">Docker</span></strong><span class="koboSpan" id="kobo.30.1"> (</span><a href="https://docker.com"><span class="koboSpan" id="kobo.31.1">https://docker.com</span></a><span class="koboSpan" id="kobo.32.1">) and Podman (</span><a href="https://podman.io"><span class="koboSpan" id="kobo.33.1">https://podman.io</span></a><span class="koboSpan" id="kobo.34.1">) can both be used as a container engine. </span><span class="koboSpan" id="kobo.34.2">Both</span><a id="_idIndexMarker121"/><span class="koboSpan" id="kobo.35.1"> are OK, although I do have a personal preference for Podman as </span><a id="_idIndexMarker122"/><span class="koboSpan" id="kobo.36.1">it offers benefits such as being daemonless for easy installation, rootless for added security, fully OCI compliant, and Kubernetes-ready, and it integrates with </span><strong class="source-inline"><span class="koboSpan" id="kobo.37.1">systemd</span></strong><span class="koboSpan" id="kobo.38.1"> at the user level to </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">autostart containers/Pods.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.40.1">Podman Desktop</span></strong><span class="koboSpan" id="kobo.41.1"> (</span><a href="https://podman-desktop.io"><span class="koboSpan" id="kobo.42.1">https://podman-desktop.io</span></a><span class="koboSpan" id="kobo.43.1">) is an open source software providing a graphical</span><a id="_idIndexMarker123"/><span class="koboSpan" id="kobo.44.1"> user interface to build, start, and debug containers, run local Kubernetes instances, ease the migration from container to Pod, and even connect with remote platforms such as Red Hat OpenShift, Azure Kubernetes Engine, </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">and more.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.46.1">Golang</span></strong><span class="koboSpan" id="kobo.47.1"> (</span><a href="https://go.dev"><span class="koboSpan" id="kobo.48.1">https://go.dev</span></a><span class="koboSpan" id="kobo.49.1">) or Go is a programming language used within our examples. </span><span class="koboSpan" id="kobo.49.2">Note</span><a id="_idIndexMarker124"/><span class="koboSpan" id="kobo.50.1"> that Kubernetes and most of its third-party components are written </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">in Go.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.52.1">Git</span></strong><span class="koboSpan" id="kobo.53.1"> (</span><a href="https://git-scm.com"><span class="koboSpan" id="kobo.54.1">https://git-scm.com</span></a><span class="koboSpan" id="kobo.55.1">) is a </span><a id="_idIndexMarker125"/><span class="koboSpan" id="kobo.56.1">version control system that we will be using to recover the book examples and also leverage in our discovery of Secrets </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">management solutions.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.58.1">In addition, the following tools will be </span><span class="No-Break"><span class="koboSpan" id="kobo.59.1">looked at:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.60.1">HashiCorp Vault</span></strong><span class="koboSpan" id="kobo.61.1"> (</span><a href="https://www.vaultproject.io/community"><span class="koboSpan" id="kobo.62.1">https://www.vaultproject.io/community</span></a><span class="koboSpan" id="kobo.63.1">) is a community vault with an enterprise</span><a id="_idIndexMarker126"/><span class="koboSpan" id="kobo.64.1"> offering to safely store credentials, tokens, </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">and more</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.66.1">Trousseau</span></strong><span class="koboSpan" id="kobo.67.1"> (</span><a href="https://trousseau.io"><span class="koboSpan" id="kobo.68.1">https://trousseau.io</span></a><span class="koboSpan" id="kobo.69.1">) is a KMS provider plugin to leverage external KMSs such as </span><a id="_idIndexMarker127"/><span class="koboSpan" id="kobo.70.1">HashiCorp Vault, Azure Key Vault, or an </span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">AWS equivalent</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.72.1">The following link gives you access to the digital material linked to </span><span class="No-Break"><span class="koboSpan" id="kobo.73.1">this book:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.74.1">The GitHub </span><span class="No-Break"><span class="koboSpan" id="kobo.75.1">repository: </span></span><a href="https://github.com/PacktPublishing/Kubernetes-Secrets-Handbook"><span class="No-Break"><span class="koboSpan" id="kobo.76.1">https://github.com/PacktPublishing/Kubernetes-Secrets-Handbook</span></span></a></li>
</ul>
<h1 id="_idParaDest-67"><a id="_idTextAnchor067"/><span class="koboSpan" id="kobo.77.1">Kubernetes-native encryption</span></h1>
<p><em class="italic"><span class="koboSpan" id="kobo.78.1">Data in payloads written in etcd is not encrypted but encoded in base64, which is almost equivalent to clear text. </span><span class="koboSpan" id="kobo.78.2">Encrypting the data contained in the payload will protect from the aforementioned protection mechanisms, but not </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.79.1">replace them!</span></em></span></p>
<p><span class="koboSpan" id="kobo.80.1">Interestingly </span><a id="_idIndexMarker128"/><span class="koboSpan" id="kobo.81.1">enough, we have established that our Kubernetes key-value store, also known as etcd, does not provide any encryption capabilities except for the networking part, nor does Kubernetes provide advanced KMS capabilities as HashiCorp Vault or Azure Key </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">Vault would.</span></span></p>
<p><span class="koboSpan" id="kobo.83.1">However, the Kubernetes project has designed a KMS framework within </span><strong class="source-inline"><span class="koboSpan" id="kobo.84.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.85.1">, the service validating and configuring data for the API objects, to leverage one of the following </span><span class="No-Break"><span class="koboSpan" id="kobo.86.1">encryption providers:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.87.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.88.1">identity</span></strong><span class="koboSpan" id="kobo.89.1"> provider</span><a id="_idIndexMarker129"/><span class="koboSpan" id="kobo.90.1"> is the default configuration, meaning no encryption is applied to the data field encoded </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">in base64</span></span></li>
<li><span class="koboSpan" id="kobo.92.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.93.1">aes</span></strong><span class="koboSpan" id="kobo.94.1"> provider, with</span><a id="_idIndexMarker130"/><span class="koboSpan" id="kobo.95.1"> two options being </span><strong class="source-inline"><span class="koboSpan" id="kobo.96.1">aesgcm</span></strong><span class="koboSpan" id="kobo.97.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.98.1">aescbc</span></strong><span class="koboSpan" id="kobo.99.1">, leverages the local encryption capabilities with a random encryption key generated by </span><span class="No-Break"><span class="koboSpan" id="kobo.100.1">the user</span></span></li>
<li><span class="koboSpan" id="kobo.101.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.102.1">kms</span></strong><span class="koboSpan" id="kobo.103.1"> provider plugin</span><a id="_idIndexMarker131"/><span class="koboSpan" id="kobo.104.1"> connects </span><strong class="source-inline"><span class="koboSpan" id="kobo.105.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.106.1"> with an external KMS to leverage an envelope </span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">encryption principle</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.108.1">The way the KMS provider framework is configured is by enabling its capability at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.109.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.110.1"> Pod’s (</span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">re)start time.</span></span></p>
<p><span class="koboSpan" id="kobo.112.1">We enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.113.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.114.1"> with this capability </span><span class="No-Break"><span class="koboSpan" id="kobo.115.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.116.1">We reference </span><strong class="source-inline"><span class="koboSpan" id="kobo.117.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.118.1"> with two configuration flags; one to enable the capability and reference a configuration file, and one to enable auto-reload when the changes are applied to the </span><span class="No-Break"><span class="koboSpan" id="kobo.119.1">configuration file</span></span></li>
<li><span class="koboSpan" id="kobo.120.1">A configuration file is to be deployed on every control plane node where the path and the name are defined within the configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">flag itself</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.122.1">Let’s start with the configuration file, which is based on a YAML manifest referencing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.123.1">EncryptionConfiguration</span></strong><span class="koboSpan" id="kobo.124.1"> API object and looks </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.126.1">
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - Secrets
      - ConfigMap
    providers:
      - identity: {}</span></pre> <p><span class="koboSpan" id="kobo.127.1">This YAML manifest is an actual explicit version of what </span><strong class="source-inline"><span class="koboSpan" id="kobo.128.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.129.1"> is configured with by default, even when the capability is disabled. </span><span class="koboSpan" id="kobo.129.2">The manifest can be read </span><span class="No-Break"><span class="koboSpan" id="kobo.130.1">as </span></span><span class="No-Break"><a id="_idIndexMarker132"/></span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.132.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.133.1">resources</span></strong><span class="koboSpan" id="kobo.134.1"> list; a reference to the Kubernetes API objects to encrypt being either </span><strong class="source-inline"><span class="koboSpan" id="kobo.135.1">Secrets</span></strong><span class="koboSpan" id="kobo.136.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.137.1">ConfigMap</span></strong><span class="koboSpan" id="kobo.138.1">, or custom resources starting within Kubernetes </span><span class="No-Break"><span class="koboSpan" id="kobo.139.1">version 1.25</span></span></li>
<li><span class="koboSpan" id="kobo.140.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.141.1">providers</span></strong><span class="koboSpan" id="kobo.142.1"> list with precedence; a reference to the encryption mechanism being either </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">identity</span></strong><span class="koboSpan" id="kobo.144.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.145.1">aesgcm</span></strong><span class="koboSpan" id="kobo.146.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.147.1">aescbc</span></strong><span class="koboSpan" id="kobo.148.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.149.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.150.1">kms</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.151.1">As mentioned, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.152.1">providers</span></strong><span class="koboSpan" id="kobo.153.1"> list has a precedence construct. </span><span class="koboSpan" id="kobo.153.2">This means that </span><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.155.1"> will parse the list in a sequential way, which could have an impact on your operations. </span><span class="koboSpan" id="kobo.155.2">This will be illustrated within the </span><span class="No-Break"><span class="koboSpan" id="kobo.156.1">hands-on examples.</span></span></p>
<p><span class="koboSpan" id="kobo.157.1">The easiest way, to begin with, is to use the preceding default definition to set up our first </span><strong class="source-inline"><span class="koboSpan" id="kobo.158.1">EncryptionConfiguration</span></strong><span class="koboSpan" id="kobo.159.1"> file and to make sure that it is properly deployed on every control </span><span class="No-Break"><span class="koboSpan" id="kobo.160.1">plane node.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.161.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.162.1">This deployment, apart from the location and method, is heavily dependent on your Kubernetes distribution and we strongly invite you to verify the respective </span><span class="No-Break"><span class="koboSpan" id="kobo.163.1">project/vendor documentation.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.164.1">When using Kind from the Kubernetes projects, it can be simply referenced with an extra volume definition that we will illustrate within the hands-on examples. </span><span class="koboSpan" id="kobo.164.2">To ease this process, the file will be called </span><strong class="source-inline"><span class="koboSpan" id="kobo.165.1">configuration.yaml</span></strong><span class="koboSpan" id="kobo.166.1"> and deployed within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.167.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.168.1">etc/kubernetes/encryption</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.169.1"> folder.</span></span></p>
<p><span class="koboSpan" id="kobo.170.1">Now </span><a id="_idIndexMarker133"/><span class="koboSpan" id="kobo.171.1">that we’ve had a look at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.172.1">EncryptionConfiguration</span></strong><span class="koboSpan" id="kobo.173.1"> file, let’s have a look at the flags to enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.174.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.175.1"> with the provider(s) referenced within our </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">configuration file.</span></span></p>
<p><span class="koboSpan" id="kobo.177.1">Here is an overview of the flags to enable the </span><strong class="source-inline"><span class="koboSpan" id="kobo.178.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.179.1"> Pod with </span><span class="No-Break"><span class="koboSpan" id="kobo.180.1">encryption capabilities:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.181.1">The flag to enable and reference the configuration file is </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.183.1">
--encryption-provider-config=/etc/kubernetes/encryption/configuration.yaml</span></pre></li> <li><span class="koboSpan" id="kobo.184.1">The flag, available since Kubernetes 1.26, to automatically reload the changes applied to the configuration file without restarting </span><strong class="source-inline"><span class="koboSpan" id="kobo.185.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.186.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.187.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.188.1">
--encryption-provider-config-automatic-reload=true</span></pre></li> </ul>
<p><span class="koboSpan" id="kobo.189.1">The following Pod definition snippet shows where to place these </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">two flags:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.191.1">
apiVersion: v1
kind: Pod
...
</span><span class="koboSpan" id="kobo.191.2">spec:
  containers:
  - command:
    - kube-apiserver
    - --advertise-address=10.89.0.2
    - --allow-privileged=true
...
</span><span class="koboSpan" id="kobo.191.3">    - --encryption-provider-config=/etc/kubernetes/encryption/configuration.yaml
    - --encryption-provider-config-automatic-reload=true</span></pre> <p><span class="koboSpan" id="kobo.192.1">Now that we have taken a look at how to enable these capabilities, let’s deep dive into the </span><span class="No-Break"><span class="koboSpan" id="kobo.193.1">provider options.</span></span></p>
<h2 id="_idParaDest-68"><a id="_idTextAnchor068"/><span class="koboSpan" id="kobo.194.1">Standalone native encryption</span></h2>
<p><span class="koboSpan" id="kobo.195.1">The </span><a id="_idIndexMarker134"/><span class="koboSpan" id="kobo.196.1">native encryption can be enabled without the need for any</span><a id="_idIndexMarker135"/><span class="koboSpan" id="kobo.197.1"> additional software, either on the control plane or externally to the </span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">Kubernetes cluster.</span></span></p>
<h3><span class="koboSpan" id="kobo.199.1">identity</span></h3>
<p><span class="koboSpan" id="kobo.200.1">This </span><a id="_idIndexMarker136"/><span class="koboSpan" id="kobo.201.1">provider is the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.202.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.203.1"> configuration, which is </span><a id="_idIndexMarker137"/><span class="koboSpan" id="kobo.204.1">equivalent to not transforming any data field payload to an encrypted one before storing it </span><span class="No-Break"><span class="koboSpan" id="kobo.205.1">within etcd.</span></span></p>
<p><span class="koboSpan" id="kobo.206.1">The following diagram provides an overview of the </span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">encryption workflow:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer018">
<span class="koboSpan" id="kobo.208.1"><img alt="Figure 3.1 – Kubernetes workflow for the KMS identity provider" src="image/B20970_03_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.209.1">Figure 3.1 – Kubernetes workflow for the KMS identity provider</span></p>
<p><span class="koboSpan" id="kobo.210.1">The diagram flow can be read </span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.212.1">A user creates a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">Secret</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.214.1"> object.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.216.1"> checks the </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">EncryptionConfiguration</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.218.1">provider list.</span></span></li>
<li><span class="koboSpan" id="kobo.219.1">The provider refers </span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.221.1">identity</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.223.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.224.1"> stores the base64-encoded </span><strong class="source-inline"><span class="koboSpan" id="kobo.225.1">Secret</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.226.1">in etcd.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.227.1">This</span><a id="_idIndexMarker138"/><span class="koboSpan" id="kobo.228.1"> provider </span><a id="_idIndexMarker139"/><span class="koboSpan" id="kobo.229.1">doesn’t encrypt any of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.230.1">Secret</span></strong><span class="koboSpan" id="kobo.231.1"> data field payload and is the default Kubernetes behavior at installation time. </span><span class="koboSpan" id="kobo.231.2">It can also be used to replace any encrypted Secrets with the following providers </span><span class="No-Break"><span class="koboSpan" id="kobo.232.1">if needed.</span></span></p>
<h3><span class="koboSpan" id="kobo.233.1">aesgcm and aescbc</span></h3>
<p><span class="koboSpan" id="kobo.234.1">This </span><a id="_idIndexMarker140"/><span class="koboSpan" id="kobo.235.1">provider uses the </span><a id="_idIndexMarker141"/><span class="koboSpan" id="kobo.236.1">Golang AES encryption</span><a id="_idIndexMarker142"/><span class="koboSpan" id="kobo.237.1"> libraries to transform the data field</span><a id="_idIndexMarker143"/><span class="koboSpan" id="kobo.238.1"> payload of the listed resources to an </span><span class="No-Break"><span class="koboSpan" id="kobo.239.1">encrypted one.</span></span></p>
<p><span class="koboSpan" id="kobo.240.1">The provider</span><a id="_idIndexMarker144"/><span class="koboSpan" id="kobo.241.1"> leverages the </span><strong class="bold"><span class="koboSpan" id="kobo.242.1">Advanced Encryption Standard</span></strong><span class="koboSpan" id="kobo.243.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.244.1">AES</span></strong><span class="koboSpan" id="kobo.245.1">) and offers </span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">two modes:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.247.1">CBC, considered weak </span><span class="No-Break"><span class="koboSpan" id="kobo.248.1">but fast</span></span></li>
<li><span class="koboSpan" id="kobo.249.1">GCM, considered faster and less weak when key rotation </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">is implemented</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.251.1">From an implementation perspective, we follow the same principles </span><span class="No-Break"><span class="koboSpan" id="kobo.252.1">with both:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.253.1">Generate a 32-byte (or more) random encryption key encoded </span><span class="No-Break"><span class="koboSpan" id="kobo.254.1">in base64</span></span></li>
<li><span class="koboSpan" id="kobo.255.1">Set up the provider of your choice, </span><strong class="source-inline"><span class="koboSpan" id="kobo.256.1">aescbc</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.257.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.258.1">aesgcm</span></strong></span></li>
<li><span class="koboSpan" id="kobo.259.1">Reference the key within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">EncryptionConfiguration</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.261.1">configuration file</span></span></li>
<li><span class="koboSpan" id="kobo.262.1">Restart </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.264.1"> if auto-reload is </span><span class="No-Break"><span class="koboSpan" id="kobo.265.1">not enabled</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.266.1">This is fairly simple, both from a process and a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">configuration.yaml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.268.1"> perspective:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.269.1">
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - secrets
    providers:
      - aesgcm:
          keys:
            - name: key-20230616
              secret: DlZbD9Vc9ADLjAxKBaWxoevlKdsMMIY68DxQZVabJM8=
      - identity: {}</span></pre> <p><span class="koboSpan" id="kobo.270.1">The</span><a id="_idIndexMarker145"/><span class="koboSpan" id="kobo.271.1"> following </span><a id="_idIndexMarker146"/><span class="koboSpan" id="kobo.272.1">diagram provides an overview </span><a id="_idIndexMarker147"/><span class="koboSpan" id="kobo.273.1">of the encryption workflow</span><a id="_idIndexMarker148"/><span class="koboSpan" id="kobo.274.1"> when a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">Secret</span></strong><span class="koboSpan" id="kobo.276.1"> object is </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">being created:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer019">
<span class="koboSpan" id="kobo.278.1"><img alt="Figure 3.2 – Kubernetes workflow for the KMS aesgcm/aescbc provider" src="image/B20970_03_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.279.1">Figure 3.2 – Kubernetes workflow for the KMS aesgcm/aescbc provider</span></p>
<p><span class="koboSpan" id="kobo.280.1">The diagram flow can be read </span><span class="No-Break"><span class="koboSpan" id="kobo.281.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.282.1">A user creates a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.283.1">Secret</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.284.1"> object.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.285.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.286.1"> checks the </span><strong class="source-inline"><span class="koboSpan" id="kobo.287.1">EncryptionConfiguration</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.288.1">provider list.</span></span></li>
<li><span class="koboSpan" id="kobo.289.1">The provider refers </span><span class="No-Break"><span class="koboSpan" id="kobo.290.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.291.1">aesgcm</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.292.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.293.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.294.1"> encrypts the data field payload with the provided key within the </span><span class="No-Break"><span class="koboSpan" id="kobo.295.1">provider definition.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.297.1"> stores the encrypted </span><strong class="source-inline"><span class="koboSpan" id="kobo.298.1">Secret</span></strong><span class="koboSpan" id="kobo.299.1"> object </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">in etcd.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.301.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">aesgcm</span></strong><span class="koboSpan" id="kobo.303.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">aescbc</span></strong><span class="koboSpan" id="kobo.305.1"> providers</span><a id="_idIndexMarker149"/><span class="koboSpan" id="kobo.306.1"> are easy-to-implement solutions</span><a id="_idIndexMarker150"/><span class="koboSpan" id="kobo.307.1"> to encrypt the data </span><a id="_idIndexMarker151"/><span class="koboSpan" id="kobo.308.1">field payload </span><a id="_idIndexMarker152"/><span class="koboSpan" id="kobo.309.1">from the </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">listed resources.</span></span></p>
<p><span class="koboSpan" id="kobo.311.1">However, this simplicity comes with a trade-off; this solution leverages an encryption key that is again encoded in base64, referenced in a YAML manifest file, and stored on the local filesystem of each control plane node. </span><span class="koboSpan" id="kobo.311.2">With a system or a disk/filesystem breach, a malicious hacker can retrieve the encryption key and decrypt the payloads within the etcd </span><span class="No-Break"><span class="koboSpan" id="kobo.312.1">data file.</span></span></p>
<p><span class="koboSpan" id="kobo.313.1">Finally, these providers are subject to multiple vulnerabilities, ranging from padding oracle attacks to birthday attacks or the ability to </span><em class="italic"><span class="koboSpan" id="kobo.314.1">guess</span></em><span class="koboSpan" id="kobo.315.1"> encryption keys based on the number of times that keys have been used to write encrypted payloads, enhancing the need for a proper automated key </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">rotation strategy.</span></span></p>
<h2 id="_idParaDest-69"><a id="_idTextAnchor069"/><span class="koboSpan" id="kobo.317.1">Native encryption with an external component</span></h2>
<p><span class="koboSpan" id="kobo.318.1">The native encryption can</span><a id="_idIndexMarker153"/><span class="koboSpan" id="kobo.319.1"> be enabled by</span><a id="_idIndexMarker154"/><span class="koboSpan" id="kobo.320.1"> leveraging additional software, either on the control plane or externally to the </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">Kubernetes cluster.</span></span></p>
<h3><span class="koboSpan" id="kobo.322.1">kms</span></h3>
<p><span class="koboSpan" id="kobo.323.1">The </span><a id="_idIndexMarker155"/><span class="koboSpan" id="kobo.324.1">Kubernetes </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">kms</span></strong><span class="koboSpan" id="kobo.326.1"> provider</span><a id="_idIndexMarker156"/><span class="koboSpan" id="kobo.327.1"> is a response to the security key exposure from the previous </span><strong class="source-inline"><span class="koboSpan" id="kobo.328.1">aescbc</span></strong><span class="koboSpan" id="kobo.329.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">aesgcm</span></strong><span class="koboSpan" id="kobo.331.1"> encryption providers by calling for </span><span class="No-Break"><span class="koboSpan" id="kobo.332.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.333.1">An external KMS, such as Azure Key Vault, HashiCorp Vault, or AWS Vault, to leverage the construct of the envelope </span><span class="No-Break"><span class="koboSpan" id="kobo.334.1">encryption scheme.</span></span></li>
<li><span class="koboSpan" id="kobo.335.1">A plugin, called Kubernetes KMS provider plugin, to interconnect </span><strong class="source-inline"><span class="koboSpan" id="kobo.336.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.337.1"> with one or multiple external KMSs. </span><span class="koboSpan" id="kobo.337.2">This approach reduces the </span><strong class="source-inline"><span class="koboSpan" id="kobo.338.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.339.1"> development, integration, and maintenance that would be required to support every </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">KMS vendor.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.341.1">The </span><a id="_idIndexMarker157"/><span class="koboSpan" id="kobo.342.1">KMS encryption is</span><a id="_idIndexMarker158"/><span class="koboSpan" id="kobo.343.1"> designed with an envelope encryption scheme using a </span><span class="No-Break"><span class="koboSpan" id="kobo.344.1">two-key approach:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.345.1">A </span><strong class="bold"><span class="koboSpan" id="kobo.346.1">data encryption key</span></strong><span class="koboSpan" id="kobo.347.1">, also </span><a id="_idIndexMarker159"/><span class="koboSpan" id="kobo.348.1">known as a </span><strong class="bold"><span class="koboSpan" id="kobo.349.1">DEK</span></strong><span class="koboSpan" id="kobo.350.1">, to encrypt the data field payloads from the listed resources. </span><span class="koboSpan" id="kobo.350.2">DEKs are generated locally by </span><strong class="source-inline"><span class="koboSpan" id="kobo.351.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.352.1"> and linked to the </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">Kubernetes clusters.</span></span></li>
<li><span class="koboSpan" id="kobo.354.1">A </span><strong class="bold"><span class="koboSpan" id="kobo.355.1">key encryption key</span></strong><span class="koboSpan" id="kobo.356.1">, also </span><a id="_idIndexMarker160"/><span class="koboSpan" id="kobo.357.1">known as a </span><strong class="bold"><span class="koboSpan" id="kobo.358.1">KEK</span></strong><span class="koboSpan" id="kobo.359.1">, to encrypt the DEK. </span><span class="koboSpan" id="kobo.359.2">A KEK is generated and hosted remotely on </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1">the KMS.</span></span></li>
</ul>
<p class="callout-heading"><span class="koboSpan" id="kobo.361.1">Important notes</span></p>
<p class="callout"><span class="koboSpan" id="kobo.362.1">While it is possible to have a single KEK hosted on a remote KMS to address multiple Kubernetes clusters, this is not recommended as it would become a single point of failure and security exposure if the remote KMS was compromised. </span><span class="koboSpan" id="kobo.362.2">It is advised to consider one dedicated KEK per Kubernetes cluster and potentially multiple </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">remote KMSs.</span></span></p>
<p class="callout"><span class="koboSpan" id="kobo.364.1">Thinking about the multi-tenancy requirement, it would make sense to even have a dedicated KEK per tenant, a feature that is currently not (yet) implemented at the time </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">of writing.</span></span></p>
<p><span class="koboSpan" id="kobo.366.1">At the time of writing, the Kubernetes project has introduced KMSv2, the latest implementation of the KMS provider </span><span class="No-Break"><span class="koboSpan" id="kobo.367.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.368.1">kube-apiserver</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.369.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.370.1">While the high-level functional purpose is identical, the design and implementation are slightly different. </span><span class="koboSpan" id="kobo.370.2">These differences could be impacting your compliance and </span><span class="No-Break"><span class="koboSpan" id="kobo.371.1">regulation needs:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.372.1">In KMSv1, each </span><strong class="source-inline"><span class="koboSpan" id="kobo.373.1">Secret</span></strong><span class="koboSpan" id="kobo.374.1"> object creation generates a dedicated DEK during the transaction with each DEK being encrypted with the KEK calling the KMS, which impacts the performance when operating a large Kubernetes </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">cluster environment.</span></span></li>
<li><span class="koboSpan" id="kobo.376.1">In KMSv2, </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.378.1"> generates a DEK at startup (or at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">EncryptionConfiguration</span></strong><span class="koboSpan" id="kobo.380.1"> reload time), calls the KMS plugin to encrypt it using the remote KEK from the KMS server, caches the DEK, performs the encryption and decryption from memory, and will call the KMS for encryption only at restart or during key rotation. </span><span class="koboSpan" id="kobo.380.2">This redesign greatly improves the performance and resilience at a </span><span class="No-Break"><span class="koboSpan" id="kobo.381.1">large scale.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.382.1">The following </span><a id="_idIndexMarker161"/><span class="koboSpan" id="kobo.383.1">diagram provides </span><a id="_idIndexMarker162"/><span class="koboSpan" id="kobo.384.1">an overview of the encryption workflow </span><span class="No-Break"><span class="koboSpan" id="kobo.385.1">for KMSv1:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer020">
<span class="koboSpan" id="kobo.386.1"><img alt="Figure 3.3 – Kubernetes workflow for the KMS plugin v1 provider" src="image/B20970_03_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.387.1">Figure 3.3 – Kubernetes workflow for the KMS plugin v1 provider</span></p>
<p><span class="koboSpan" id="kobo.388.1">The diagram flow can be read </span><span class="No-Break"><span class="koboSpan" id="kobo.389.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.390.1">A user creates a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">Secret</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.392.1"> object.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.394.1"> checks the </span><strong class="source-inline"><span class="koboSpan" id="kobo.395.1">EncryptionConfiguration</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.396.1">provider list.</span></span></li>
<li><span class="koboSpan" id="kobo.397.1">The provider refers </span><span class="No-Break"><span class="koboSpan" id="kobo.398.1">to KMSv1.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.399.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.400.1"> generates </span><span class="No-Break"><span class="koboSpan" id="kobo.401.1">a DEK.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.403.1"> encrypts the data field payload with </span><span class="No-Break"><span class="koboSpan" id="kobo.404.1">the DEK.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.405.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.406.1"> requests the DEK encryption to the </span><span class="No-Break"><span class="koboSpan" id="kobo.407.1">KMS plugin.</span></span></li>
<li><span class="koboSpan" id="kobo.408.1">The KMS plugin requests the KMS to encrypt the DEK with </span><span class="No-Break"><span class="koboSpan" id="kobo.409.1">the KEK.</span></span></li>
<li><span class="koboSpan" id="kobo.410.1">The KMS encrypts the DEK with </span><span class="No-Break"><span class="koboSpan" id="kobo.411.1">the KEK.</span></span></li>
<li><span class="koboSpan" id="kobo.412.1">The KMS plugin returns the encrypted DEK </span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">kube-apiserver</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.417.1"> stores the encrypted </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">Secret</span></strong><span class="koboSpan" id="kobo.419.1"> and DEK </span><span class="No-Break"><span class="koboSpan" id="kobo.420.1">in etcd.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.421.1">The </span><a id="_idIndexMarker163"/><span class="koboSpan" id="kobo.422.1">following </span><a id="_idIndexMarker164"/><span class="koboSpan" id="kobo.423.1">diagram provides an overview of the encryption workflow </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">for KMSv2:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer021">
<span class="koboSpan" id="kobo.425.1"><img alt="Figure 3.4 – Kubernetes workflow for the KMS plugin v2 provider" src="image/B20970_03_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.426.1">Figure 3.4 – Kubernetes workflow for the KMS plugin v2 provider</span></p>
<p><span class="koboSpan" id="kobo.427.1">The diagram flow can be read </span><span class="No-Break"><span class="koboSpan" id="kobo.428.1">as follows:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.429.1">A user creates a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.430.1">Secret</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.431.1"> object.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.432.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.433.1"> checks the </span><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">EncryptionConfiguration</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.435.1">provider list.</span></span></li>
<li><span class="koboSpan" id="kobo.436.1">The provider refers </span><span class="No-Break"><span class="koboSpan" id="kobo.437.1">to KMSv2.</span></span></li>
<li><span class="koboSpan" id="kobo.438.1">If there is no existing DEK, </span><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.440.1"> will </span><span class="No-Break"><span class="koboSpan" id="kobo.441.1">generate one.</span></span></li>
<li><span class="koboSpan" id="kobo.442.1">If a DEK was generated, </span><strong class="source-inline"><span class="koboSpan" id="kobo.443.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.444.1"> requests the DEK encryption to the </span><span class="No-Break"><span class="koboSpan" id="kobo.445.1">KMS plugin.</span></span></li>
<li><span class="koboSpan" id="kobo.446.1">The KMS plugin requests the KMS to encrypt the DEK with </span><span class="No-Break"><span class="koboSpan" id="kobo.447.1">the KEK.</span></span></li>
<li><span class="koboSpan" id="kobo.448.1">The KMS encrypts the DEK with </span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">the KEK.</span></span></li>
<li><span class="koboSpan" id="kobo.450.1">The KMS plugin returns the encrypted DEK </span><span class="No-Break"><span class="koboSpan" id="kobo.451.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.452.1">kube-apiserver</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.453.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.454.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.455.1"> stores the encrypted DEK </span><span class="No-Break"><span class="koboSpan" id="kobo.456.1">in etcd.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.457.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.458.1"> encrypts the data field payload with </span><span class="No-Break"><span class="koboSpan" id="kobo.459.1">the DEK.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.461.1"> stores the encrypted </span><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">Secret</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.463.1">in etcd.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.464.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">kms</span></strong><span class="koboSpan" id="kobo.466.1"> provider</span><a id="_idIndexMarker165"/><span class="koboSpan" id="kobo.467.1"> adds complexity in terms of configuration. </span><span class="koboSpan" id="kobo.467.2">This method complies</span><a id="_idIndexMarker166"/><span class="koboSpan" id="kobo.468.1"> with all regulations requiring external key management while addressing most if not all of our </span><span class="No-Break"><span class="koboSpan" id="kobo.469.1">onion layers.</span></span></p>
<h4><span class="koboSpan" id="kobo.470.1">KMS provider plugin example</span></h4>
<p><span class="koboSpan" id="kobo.471.1">As described </span><a id="_idIndexMarker167"/><span class="koboSpan" id="kobo.472.1">earlier, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.473.1">kms</span></strong><span class="koboSpan" id="kobo.474.1"> provider requires an additional third-party software called a </span><strong class="source-inline"><span class="koboSpan" id="kobo.475.1">kms</span></strong><span class="koboSpan" id="kobo.476.1"> provider plugin to connect </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.478.1"> with an external KMS, such as HashiCorp Vault or any other KMS supported by the plugin </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">being used.</span></span></p>
<p><span class="koboSpan" id="kobo.480.1">The plugin will be deployed on the control plane nodes as a local UNIX socket to interact directly with </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.482.1"> without going through the network, which could be a potential </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">security exposure.</span></span></p>
<p><span class="koboSpan" id="kobo.484.1">A community project such </span><a id="_idIndexMarker168"/><span class="koboSpan" id="kobo.485.1">as </span><em class="italic"><span class="koboSpan" id="kobo.486.1">Trousseau</span></em><span class="koboSpan" id="kobo.487.1"> (</span><a href="https://trousseau.io"><span class="koboSpan" id="kobo.488.1">https://trousseau.io</span></a><span class="koboSpan" id="kobo.489.1">), among others, provides this capability to extend the </span><strong class="source-inline"><span class="koboSpan" id="kobo.490.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.491.1"> capabilities with HashiCorp Vault, Azure Key Vault, and </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">AWS KMS.</span></span></p>
<h4><span class="koboSpan" id="kobo.493.1">Getting hands-on with key-value data</span></h4>
<p><span class="koboSpan" id="kobo.494.1">Within the Git</span><a id="_idIndexMarker169"/><span class="koboSpan" id="kobo.495.1"> repository, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.496.1">ch03</span></strong><span class="koboSpan" id="kobo.497.1"> folder, you will find a walkthrough to deploy a new Kind cluster using Podman or Docker, using a specific cluster configuration file to get a ready-to-use instance with the default </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.498.1">EncryptionConfiguration</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.499.1"> configuration.</span></span></p>
<p><span class="koboSpan" id="kobo.500.1">The how-to includes a quick intro to the Kind configuration file allowing us to enable specific flags for </span><strong class="source-inline"><span class="koboSpan" id="kobo.501.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.502.1">, and explains how to mount a specific folder to the Pod with a configuration file. </span><span class="koboSpan" id="kobo.502.2">This will help you in the future to interact with other Kubernetes distributions leveraging the </span><span class="No-Break"><span class="koboSpan" id="kobo.503.1">same principles.</span></span></p>
<p><span class="koboSpan" id="kobo.504.1">From there, you will have a chance to implement each provider and create and replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.505.1">Secret</span></strong><span class="koboSpan" id="kobo.506.1"> objects with their new revisions being encrypted with the provider in question. </span><span class="koboSpan" id="kobo.506.2">This approach will highlight the capability to move from one provider to another without a major </span><span class="No-Break"><span class="koboSpan" id="kobo.507.1">operational burden.</span></span></p>
<p><span class="koboSpan" id="kobo.508.1">Finally, the hands-on examples will help you to verify that each </span><strong class="source-inline"><span class="koboSpan" id="kobo.509.1">Secret</span></strong><span class="koboSpan" id="kobo.510.1"> object has been encrypted with the appropriate combination of provider, key, and version if applied by dumping the entries directly from the etcd </span><span class="No-Break"><span class="koboSpan" id="kobo.511.1">data store.</span></span></p>
<h4><span class="koboSpan" id="kobo.512.1">Precedence</span></h4>
<p><span class="koboSpan" id="kobo.513.1">As previously mentioned, the provider list has </span><a id="_idIndexMarker170"/><span class="koboSpan" id="kobo.514.1">a precedence evaluation or, in other words, a sequential order to consider </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">during implementation:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.516.1">When creating a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.517.1">Secret</span></strong><span class="koboSpan" id="kobo.518.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.519.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.520.1"> will use the first provider listed to encrypt or not, if the provider is </span><strong class="source-inline"><span class="koboSpan" id="kobo.521.1">identity</span></strong><span class="koboSpan" id="kobo.522.1">, the data field payload for the </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">listed resources.</span></span></li>
<li><span class="koboSpan" id="kobo.524.1">When reading an existing </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">Secret</span></strong><span class="koboSpan" id="kobo.526.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">kube-apiserver</span></strong><span class="koboSpan" id="kobo.528.1"> will check the Secret header to define the KMS provider, its version, and the </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">associated key:</span></span><ul><li><span class="koboSpan" id="kobo.530.1">If there is a match, it will try to decrypt the </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">Secret</span></strong><span class="koboSpan" id="kobo.532.1"> data </span><span class="No-Break"><span class="koboSpan" id="kobo.533.1">field payload</span></span></li><li><span class="koboSpan" id="kobo.534.1">If there is no match, an error will </span><span class="No-Break"><span class="koboSpan" id="kobo.535.1">be returned</span></span></li></ul></li>
<li><span class="koboSpan" id="kobo.536.1">All existing Secrets could be replaced with a newer revision by changing the provider list order. </span><span class="koboSpan" id="kobo.536.2">The most common example would be to introduce a new KMS provider, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">aesgcm</span></strong><span class="koboSpan" id="kobo.538.1">, and replace all unencrypted Secrets with a newer revision that will be encrypted with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.539.1">aesgcm</span></strong><span class="koboSpan" id="kobo.540.1"> provider. </span><span class="koboSpan" id="kobo.540.2">This particular case is illustrated within the </span><span class="No-Break"><span class="koboSpan" id="kobo.541.1">hands-on example.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.542.1">This implementation</span><a id="_idIndexMarker171"/><span class="koboSpan" id="kobo.543.1"> example of a </span><strong class="source-inline"><span class="koboSpan" id="kobo.544.1">kms</span></strong><span class="koboSpan" id="kobo.545.1"> provider showcases the usage of an external KMS service. </span><span class="koboSpan" id="kobo.545.2">Note that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.546.1">kms</span></strong><span class="koboSpan" id="kobo.547.1"> v1 provider is deprecated with version 1.28 of Kubernetes in favor of a more resilient </span><strong class="source-inline"><span class="koboSpan" id="kobo.548.1">kms</span></strong><span class="koboSpan" id="kobo.549.1"> v2 that’s capable of sustaining </span><span class="No-Break"><span class="koboSpan" id="kobo.550.1">network partitioning.</span></span></p>
<h1 id="_idParaDest-70"><a id="_idTextAnchor070"/><span class="koboSpan" id="kobo.551.1">Going further with securing etcd</span></h1>
<p><span class="koboSpan" id="kobo.552.1">The previous</span><a id="_idIndexMarker172"/><span class="koboSpan" id="kobo.553.1"> section described the native encryption capabilities provided by Kubernetes at the application layer or, in other words, how to secure sensitive data from </span><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">Secret</span></strong><span class="koboSpan" id="kobo.555.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">ConfigMap</span></strong><span class="koboSpan" id="kobo.557.1"> objects being processed by the Kubernetes </span><span class="No-Break"><span class="koboSpan" id="kobo.558.1">API server.</span></span></p>
<p><span class="koboSpan" id="kobo.559.1">Depending on the deployment type, whether on-premises or in the cloud, other layers can benefit from encryption to avoid or reduce </span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">security exposures:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.561.1">When self-deploying on-premises or in the cloud using physical or virtual machines, the Kubernetes </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">EncryptionConfiguration</span></strong><span class="koboSpan" id="kobo.563.1"> API object is stored as a file on disk; accessing this configuration file, as well as the etcd data file, will compromise all sensitive data recorded as part of the API objects </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">in etcd.</span></span></li>
<li><span class="koboSpan" id="kobo.565.1">When consuming a managed Kubernetes instance from a cloud provider, the control plane becomes their responsibility. </span><span class="koboSpan" id="kobo.565.2">However, not all services are equal and some require a thorough review of the configuration to ensure that the cloud provider you are selecting is handling the encryption at rest on its infrastructure level and allows you to enable the Kubernetes </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">native encryption.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.567.1">Considering the following onion diagram, we can list the illustrated components as potential exposure points to be addressed to mitigate unauthorized access to the data within etcd, including Secrets and ConfigMaps. </span><span class="koboSpan" id="kobo.567.2">This section provides you with an analysis of each component in terms of security risk and </span><span class="No-Break"><span class="koboSpan" id="kobo.568.1">related mitigation(s):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer022">
<span class="koboSpan" id="kobo.569.1"><img alt="Figure 3.5 – The etcd security exposure presented as onion layers" src="image/B20970_03_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.570.1">Figure 3.5 – The etcd security exposure presented as onion layers</span></p>
<p><span class="koboSpan" id="kobo.571.1">Due to the</span><a id="_idIndexMarker173"/><span class="koboSpan" id="kobo.572.1"> numerous combinations of Linux and Kubernetes distributions, not to even mention the extensive cloud provider offerings, this chapter provides an extensive hands-on section on the key-value data while sharing guidance on all other components, for which the following references will help you with implementing a security and hardening prof</span><a id="_idTextAnchor071"/><span class="koboSpan" id="kobo.573.1">ile for </span><span class="No-Break"><span class="koboSpan" id="kobo.574.1">your systems:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.575.1">Tevault, Donald A. </span><span class="koboSpan" id="kobo.575.2">(2023). </span><em class="italic"><span class="koboSpan" id="kobo.576.1">Mastering Linux Security and Hardening: A Practical Guide to Protecting Your Linux System from Cyber Attac</span><a id="_idTextAnchor072"/><span class="koboSpan" id="kobo.577.1">ks</span></em><span class="koboSpan" id="kobo.578.1"> by </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.579.1">Packt Publishing</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.580.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.581.1">Kalsi, Tajinder. </span><span class="koboSpan" id="kobo.581.2">(2018). </span><em class="italic"><span class="koboSpan" id="kobo.582.1">Practical Linux Security Cookbook: Secure Your Linux Environment from Modern-Day Attacks with Practical Recipes</span></em><span class="koboSpan" id="kobo.583.1"> by </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.584.1">Packt Publishing</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.585.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.586.1">It is also </span><a id="_idIndexMarker174"/><span class="koboSpan" id="kobo.587.1">worth noting that cloud providers are doing most of the heavy lifting to encrypt at-rest disks and filesystems to mitigate related attack vectors. </span><span class="koboSpan" id="kobo.587.2">However, all of them advise leveraging the Kubernetes </span><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">EncryptionConfiguration</span></strong><span class="koboSpan" id="kobo.589.1"> API server configuration for </span><span class="No-Break"><span class="koboSpan" id="kobo.590.1">end-to-end encryption.</span></span></p>
<h2 id="_idParaDest-71"><a id="_idTextAnchor073"/><span class="koboSpan" id="kobo.591.1">Linux system hardening</span></h2>
<p><em class="italic"><span class="koboSpan" id="kobo.592.1">The art of operating system hardening is to reduce the access breach exploits to zero. </span><span class="koboSpan" id="kobo.592.2">From our context, it means no remote access via the operating system to the etcd </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.593.1">data file.</span></em></span></p>
<p><span class="koboSpan" id="kobo.594.1">It is </span><a id="_idIndexMarker175"/><span class="koboSpan" id="kobo.595.1">important to appreciate the effort from Linux distributions to include the concept of security profiles, leveraging standards such as SCAP at the early stage of system installation, and helping with relevant and consistent hardening based on your organization’s needs. </span><span class="koboSpan" id="kobo.595.2">A series of industry-specific profiles, such as CIS Benchmarking and NIST, are offered at the deployment time, helping to configure the operating system with the necessary rules to comply with the chosen regulation. </span><span class="koboSpan" id="kobo.595.3">These rules are explained when using the graphical user interface or can be found within the vendor documentation. </span><span class="koboSpan" id="kobo.595.4">No matter your preferred installation method – text, graphical, or kickstart – all can benefit from such </span><span class="No-Break"><span class="koboSpan" id="kobo.596.1">hardening automation.</span></span></p>
<p><span class="koboSpan" id="kobo.597.1">This approach helps to reduce the pressure on the Ops team. </span><span class="koboSpan" id="kobo.597.2">By automating the relevant 100+ specific configuration rules, complying with a regulatory profile such as PCI-DSS can easily be achieved without reading its 360 pages of requirements. </span><span class="koboSpan" id="kobo.597.3">This would complement the 190+ pages of the Red Hat Security Hardening </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">reference guide.</span></span></p>
<p><span class="koboSpan" id="kobo.599.1">Once the system has been deployed with the appropriate security policy relevant to your organization’s industry, the OpenSCAP bench toolset can be used to scan your entire install base to provide you with </span><span class="No-Break"><span class="koboSpan" id="kobo.600.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.601.1">A tailor-fit audit per </span><span class="No-Break"><span class="koboSpan" id="kobo.602.1">Linux distribution</span></span></li>
<li><span class="koboSpan" id="kobo.603.1">A shareable audit file including a </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">risk-scoring system</span></span></li>
<li><span class="koboSpan" id="kobo.605.1">A mitigation strategy with the most common toolsets (Shell script, Puppet, Ansible, and </span><span class="No-Break"><span class="koboSpan" id="kobo.606.1">so on)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.607.1">See the following</span><a id="_idIndexMarker176"/> <span class="No-Break"><span class="koboSpan" id="kobo.608.1">for reference:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.609.1">OpenSCAP: </span></span><a href="https://www.open-scap.org/"><span class="No-Break"><span class="koboSpan" id="kobo.610.1">https://www.open-scap.org/</span></span></a></li>
<li><span class="koboSpan" id="kobo.611.1">OpenSCAP PCI-DSS</span><a id="_idIndexMarker177"/> <span class="No-Break"><span class="koboSpan" id="kobo.612.1">rules: </span></span><a href="http://static.open-scap.org/ssg-guides/ssg-rhel9-guide-pci-dss.html"><span class="No-Break"><span class="koboSpan" id="kobo.613.1">http://static.open-scap.org/ssg-guides/ssg-rhel9-guide-pci-dss.html</span></span></a></li>
<li><span class="koboSpan" id="kobo.614.1">Red Hat Enterprise Linux security </span><span class="No-Break"><span class="koboSpan" id="kobo.615.1">hardening: </span></span><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html-single/security_hardening"><span class="No-Break"><span class="koboSpan" id="kobo.616.1">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html-single/security_hardening</span></span></a></li>
</ul>
<p><span class="koboSpan" id="kobo.617.1">Hardening a Linux system includes tasks pre- and post-installation. </span><span class="koboSpan" id="kobo.617.2">To avoid redeploying your operating system, enable the appropriate security profile and disk encryption during the installation process. </span><span class="koboSpan" id="kobo.617.3">Most Linux distributions, such as the Red Hat Enterprise Linux 9, have a graphical user interface to set a specific security profile and provide you with a list of mandatory configuration changes to comply with the </span><span class="No-Break"><span class="koboSpan" id="kobo.618.1">chosen profile.</span></span></p>
<p><span class="koboSpan" id="kobo.619.1">The </span><a id="_idIndexMarker178"/><span class="koboSpan" id="kobo.620.1">GitHub repository has two examples within the </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">ch03</span></strong><span class="koboSpan" id="kobo.622.1"> folder demonstrating the hardening of a Linux system using the installer graphical interface and a </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">kickstart file.</span></span></p>
<h2 id="_idParaDest-72"><a id="_idTextAnchor074"/><span class="koboSpan" id="kobo.624.1">Linux data encryption</span></h2>
<p><em class="italic"><span class="koboSpan" id="kobo.625.1">Stealing a disk or a server is a serious concern, and it happens more often than we could believe. </span><span class="koboSpan" id="kobo.625.2">But it is not only for on-premises infrastructure; cloud virtual disks could be stolen too thanks to hypervisor exploits that could leak the disk file, which means all your business-critical systems have their credentials </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.626.1">leaked too.</span></em></span></p>
<p><span class="koboSpan" id="kobo.627.1">Since</span><a id="_idIndexMarker179"/><span class="koboSpan" id="kobo.628.1"> etcd does not offer any encryption capabilities (at the time of writing), the data file that will be stored on the control plane node filesystem can be accessed and easily read to recover our </span><strong class="source-inline"><span class="koboSpan" id="kobo.629.1">Secret</span></strong><span class="koboSpan" id="kobo.630.1"> object payload, as shown in </span><a href="B20970_01.xhtml#_idTextAnchor015"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.631.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.632.1">, </span><em class="italic"><span class="koboSpan" id="kobo.633.1">Understanding Kubernetes Secrets Management</span></em><span class="koboSpan" id="kobo.634.1">. </span><span class="koboSpan" id="kobo.634.2">This means that any physical deployment scenarios colocated on-premises and with edge computing would result in security exposures when an attacker steals the disk(s) </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">or node(s).</span></span></p>
<p><span class="koboSpan" id="kobo.636.1">To address this concern, the disk and filesystem will need to be encrypted. </span><span class="koboSpan" id="kobo.636.2">Why both, you ask? </span><span class="koboSpan" id="kobo.636.3">While a </span><strong class="bold"><span class="koboSpan" id="kobo.637.1">full disk encryption</span></strong><span class="koboSpan" id="kobo.638.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.639.1">FDE</span></strong><span class="koboSpan" id="kobo.640.1">) might</span><a id="_idIndexMarker180"/><span class="koboSpan" id="kobo.641.1"> seem to be an easy solution to tick the box, a diverse range of attacks has been proven successful in accessing data both with and without stealing the entire system. </span><span class="koboSpan" id="kobo.641.2">Adding a filesystem encryption will reduce the chances of a data leak including </span><strong class="source-inline"><span class="koboSpan" id="kobo.642.1">Secret</span></strong><span class="koboSpan" id="kobo.643.1"> objects used to access your cloud, application, and </span><span class="No-Break"><span class="koboSpan" id="kobo.644.1">storage accounts.</span></span></p>
<h3><span class="koboSpan" id="kobo.645.1">Disk encryption</span></h3>
<p><span class="koboSpan" id="kobo.646.1">FDE, sometimes </span><a id="_idIndexMarker181"/><span class="koboSpan" id="kobo.647.1">referred to as </span><strong class="bold"><span class="koboSpan" id="kobo.648.1">self-encrypting disk</span></strong><span class="koboSpan" id="kobo.649.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.650.1">SED</span></strong><span class="koboSpan" id="kobo.651.1">), is an</span><a id="_idIndexMarker182"/><span class="koboSpan" id="kobo.652.1"> interesting starting point to provide a fully offloaded encryption process from the host, reducing the attack surface. </span><span class="koboSpan" id="kobo.652.2">It is transparent to both the operating system and the applications (no drivers or libraries to maintain). </span><span class="koboSpan" id="kobo.652.3">FDE guarantees a high level of compatibility, supportability, and portability across different hardware and </span><span class="No-Break"><span class="koboSpan" id="kobo.653.1">software combinations.</span></span></p>
<p><span class="koboSpan" id="kobo.654.1">All FDE/SED disks are delivered with a zero-length authentication key/password to ease the initial setup, especially if there is no user requirement to do so. </span><span class="koboSpan" id="kobo.654.2">When defining an authentication key or password, the DEK is stored on the disk and protected with the defined custom </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">user key.</span></span></p>
<p><span class="koboSpan" id="kobo.656.1">The benefits of this workflow are </span><span class="No-Break"><span class="koboSpan" id="kobo.657.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.658.1">Protection from physical theft of </span><span class="No-Break"><span class="koboSpan" id="kobo.659.1">the disk(s)</span></span></li>
<li><span class="koboSpan" id="kobo.660.1">Protecting the data even before </span><span class="No-Break"><span class="koboSpan" id="kobo.661.1">boot time</span></span></li>
<li><span class="koboSpan" id="kobo.662.1">Enabling re-key options for compelling events and </span><span class="No-Break"><span class="koboSpan" id="kobo.663.1">compliance purposes</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.664.1">The pitfalls are </span><span class="No-Break"><span class="koboSpan" id="kobo.665.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.666.1">Booting requires user interaction to input the </span><span class="No-Break"><span class="koboSpan" id="kobo.667.1">authentication key</span></span></li>
<li><span class="koboSpan" id="kobo.668.1">Losing the key means losing </span><span class="No-Break"><span class="koboSpan" id="kobo.669.1">the data</span></span></li>
<li><span class="koboSpan" id="kobo.670.1">Hacking is still </span><span class="No-Break"><span class="koboSpan" id="kobo.671.1">a possibility</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.672.1">Indeed, the effectiveness of these disks could be challenged, with different approaches demonstrating how to access and compromise the data on these disks provided by these </span><span class="No-Break"><span class="koboSpan" id="kobo.673.1">two references:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.674.1">Hardware-based Full Disk Encryption (In)Security</span></em><span class="koboSpan" id="kobo.675.1"> by Tilo Müller, Tobias Latzo, and Felix C. </span><span class="koboSpan" id="kobo.675.2">Freilling from System Security Group at Friedrich-Alexander </span><span class="No-Break"><span class="koboSpan" id="kobo.676.1">Universität: </span></span><a href="https://www.cs1.tf.fau.de/research/system-security-group/sed-insecurity/"><span class="No-Break"><span class="koboSpan" id="kobo.677.1">https://www.cs1.tf.fau.de/research/system-security-group/sed-insecurity/</span></span></a></li>
<li><span class="koboSpan" id="kobo.678.1">Perform</span><a id="_idIndexMarker183"/><span class="koboSpan" id="kobo.679.1"> an internet</span><a id="_idIndexMarker184"/><span class="koboSpan" id="kobo.680.1"> search with the following terms: </span><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">NSA disk </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.682.1">firmware hack</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.683.1">Note that most professional-grade disks (mechanical or chip-based) offered in servers and storage arrays are delivered with such technology. </span><span class="koboSpan" id="kobo.683.2">This is the first hardware layer of protection </span><span class="No-Break"><span class="koboSpan" id="kobo.684.1">to consider.</span></span></p>
<h3><span class="koboSpan" id="kobo.685.1">Filesystem encryption</span></h3>
<p><span class="koboSpan" id="kobo.686.1">When</span><a id="_idIndexMarker185"/><span class="koboSpan" id="kobo.687.1"> it comes to encrypting a Linux filesystem, multiple approaches</span><a id="_idIndexMarker186"/><span class="koboSpan" id="kobo.688.1"> could be considered, including both open source and proprietary options. </span><span class="koboSpan" id="kobo.688.2">For this section, we will have a look at three open source solutions, from easy to complex, from the perspective </span><span class="No-Break"><span class="koboSpan" id="kobo.689.1">of requirements.</span></span></p>
<h4><span class="koboSpan" id="kobo.690.1">Plain device-mapper encryption</span></h4>
<p><span class="koboSpan" id="kobo.691.1">The usage of </span><a id="_idIndexMarker187"/><span class="koboSpan" id="kobo.692.1">device-mapper encryption with </span><strong class="source-inline"><span class="koboSpan" id="kobo.693.1">dm-crypt</span></strong><span class="koboSpan" id="kobo.694.1"> is an obvious </span><a id="_idIndexMarker188"/><span class="koboSpan" id="kobo.695.1">and simple choice as it performs a block-level encryption on an unpartitioned disk. </span><span class="koboSpan" id="kobo.695.2">This technique provides disk-level encryption that could be accessible with a so-called garbage random data introducing a deniable </span><span class="No-Break"><span class="koboSpan" id="kobo.696.1">encryption method.</span></span></p>
<p><span class="koboSpan" id="kobo.697.1">The benefits</span><a id="_idIndexMarker189"/><span class="koboSpan" id="kobo.698.1"> of using device-mapper encryption are </span><span class="No-Break"><span class="koboSpan" id="kobo.699.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.700.1">Full disk encryption </span><span class="No-Break"><span class="koboSpan" id="kobo.701.1">is provided</span></span></li>
<li><span class="koboSpan" id="kobo.702.1">No partition tables are exposed, nor are the UUID </span><span class="No-Break"><span class="koboSpan" id="kobo.703.1">or LABEL</span></span></li>
<li><span class="koboSpan" id="kobo.704.1">It provides a robust solution in case of a disaster (in a LUKS setup, if the header is destroyed, the data </span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">is lost)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.706.1">The pitfalls</span><a id="_idIndexMarker190"/><span class="koboSpan" id="kobo.707.1"> are </span><span class="No-Break"><span class="koboSpan" id="kobo.708.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.709.1">A high level of mastery of device mapping is required to ensure </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">proper configurations</span></span></li>
<li><span class="koboSpan" id="kobo.711.1">A single passphrase with no key rotation is a potential issue with specific </span><span class="No-Break"><span class="koboSpan" id="kobo.712.1">compliance/regulation requirements</span></span></li>
<li><span class="koboSpan" id="kobo.713.1">There is no key derivation function that would reduce the vulnerability to brute-force attacks when passphrases are generated with a lack </span><span class="No-Break"><span class="koboSpan" id="kobo.714.1">of entropy</span></span></li>
<li><span class="koboSpan" id="kobo.715.1">There is</span><a id="_idIndexMarker191"/><span class="koboSpan" id="kobo.716.1"> no support for the TRIM command on </span><span class="No-Break"><span class="koboSpan" id="kobo.717.1">solid-state drives</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.718.1">See the following </span><span class="No-Break"><span class="koboSpan" id="kobo.719.1">for reference:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.720.1">Project: </span></span><a href="https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/dm-crypt.html"><span class="No-Break"><span class="koboSpan" id="kobo.721.1">https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/dm-crypt.html</span></span></a></li>
<li><span class="koboSpan" id="kobo.722.1">Implementation on Arch </span><span class="No-Break"><span class="koboSpan" id="kobo.723.1">Linux: </span></span><a href="https://wiki.archlinux.org/title/Dm-crypt"><span class="No-Break"><span class="koboSpan" id="kobo.724.1">https://wiki.archlinux.org/title/Dm-crypt</span></span></a></li>
</ul>
<h4><span class="koboSpan" id="kobo.725.1">Linux Unified Key Setup (LUKS)</span></h4>
<p><span class="koboSpan" id="kobo.726.1">LUKS can be </span><a id="_idIndexMarker192"/><span class="koboSpan" id="kobo.727.1">considered as a universal disk encryption software with </span><a id="_idIndexMarker193"/><span class="koboSpan" id="kobo.728.1">secure password management implemented in its core. </span><span class="koboSpan" id="kobo.728.2">This allows us to overcome some if not all of the pitfalls linked to key derivation, rotation, and multiple passphrase capabilities. </span><span class="koboSpan" id="kobo.728.3">Along with these, LUKS is compatible with the </span><strong class="bold"><span class="koboSpan" id="kobo.729.1">logical volume management</span></strong><span class="koboSpan" id="kobo.730.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.731.1">LVM</span></strong><span class="koboSpan" id="kobo.732.1">) and </span><a id="_idIndexMarker194"/><span class="koboSpan" id="kobo.733.1">software RAID scenario for interesting solutions that would address different needs and compliance/regulation requirements. </span><span class="koboSpan" id="kobo.733.2">Here are a few examples where LUKS can be integrated with </span><span class="No-Break"><span class="koboSpan" id="kobo.734.1">other solutions:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.735.1">LUKS on </span><span class="No-Break"><span class="koboSpan" id="kobo.736.1">a partition</span></span></li>
<li><span class="koboSpan" id="kobo.737.1">LVM </span><span class="No-Break"><span class="koboSpan" id="kobo.738.1">on LUKS</span></span></li>
<li><span class="koboSpan" id="kobo.739.1">LUKS </span><span class="No-Break"><span class="koboSpan" id="kobo.740.1">on LVM</span></span></li>
<li><span class="koboSpan" id="kobo.741.1">LUKS with </span><span class="No-Break"><span class="koboSpan" id="kobo.742.1">software RAID</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.743.1">LUKS can also be complementary to other solutions to provide additional security responses. </span><span class="koboSpan" id="kobo.743.2">A plain device mapper and a headerless LUKS implementation would set up a deniable encrypted device (no header). </span><span class="koboSpan" id="kobo.743.3">This method would also address the key rotation requirement with capabilites for key derivation and multiple passphrases. </span><span class="koboSpan" id="kobo.743.4">This could be the best of both worlds, a solution that I would appreciate the most when no external KMS </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">is required.</span></span></p>
<p><span class="koboSpan" id="kobo.745.1">See the following </span><span class="No-Break"><span class="koboSpan" id="kobo.746.1">for reference:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.747.1">Project: </span></span><a href="https://gitlab.com/cryptsetup/cryptsetup/blob/master/README.md"><span class="No-Break"><span class="koboSpan" id="kobo.748.1">https://gitlab.com/cryptsetup/cryptsetup/blob/master/README.md</span></span></a></li>
<li><span class="koboSpan" id="kobo.749.1">Implementation on Red Hat Enterprise </span><span class="No-Break"><span class="koboSpan" id="kobo.750.1">Linux: </span></span><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/encrypting-block-devices-using-luks_security-hardening"><span class="No-Break"><span class="koboSpan" id="kobo.751.1">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/encrypting-block-devices-using-luks_security-hardening</span></span></a></li>
</ul>
<h4><span class="koboSpan" id="kobo.752.1">Device mapper with LVM and LUKS</span></h4>
<p><span class="koboSpan" id="kobo.753.1">As listed in the LUKS </span><a id="_idIndexMarker195"/><span class="koboSpan" id="kobo.754.1">section, there are multiple combinations to implement disk encryption using LUKS. </span><span class="koboSpan" id="kobo.754.2">However, each setup comes with benefits and trade-offs, sometimes major ones, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.755.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.756.1">LVM on LUKS would ease the partitioning and protect the volume layout when locked, but relies on a single encryption key with all volumes </span><span class="No-Break"><span class="koboSpan" id="kobo.757.1">being encrypted</span></span></li>
<li><span class="koboSpan" id="kobo.758.1">LUKS on LVM provides flexibility to support un/encrypted volumes while being complex to maintain and less secure by exposing the </span><span class="No-Break"><span class="koboSpan" id="kobo.759.1">volume layout</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.760.1">For both the device mapper and LUKS solutions, the usage of TRIM with solid-state drives could be a security exposure or a </span><span class="No-Break"><span class="koboSpan" id="kobo.761.1">security response.</span></span></p>
<p><span class="koboSpan" id="kobo.762.1">With a plain mode </span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">dm-crypt</span></strong><span class="koboSpan" id="kobo.764.1">, if TRIM is enabled, it will eventually expose the encryption and could leak enough data from freed blocks to discover the encryption pattern. </span><span class="koboSpan" id="kobo.764.2">However, if there is no hard requirement for both data and deniable encryption, then it can be safely enabled as there will be a significant </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">performance improvement.</span></span></p>
<p><span class="koboSpan" id="kobo.766.1">With LUKS, the header is stored at the beginning of the device. </span><span class="koboSpan" id="kobo.766.2">If there is a passphrase rotation, the previous one will be revoked and TRIM will help to free the blocks. </span><span class="koboSpan" id="kobo.766.3">If not, then an attacker could research the device to get the old header and decrypt </span><span class="No-Break"><span class="koboSpan" id="kobo.767.1">the disk.</span></span></p>
<p><span class="koboSpan" id="kobo.768.1">For increased security with LUKS, the usage of a (virtual) </span><strong class="bold"><span class="koboSpan" id="kobo.769.1">Trusted Platform Module</span></strong><span class="koboSpan" id="kobo.770.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.771.1">TPM</span></strong><span class="koboSpan" id="kobo.772.1">) can be</span><a id="_idIndexMarker196"/><span class="koboSpan" id="kobo.773.1"> leveraged to store and handle the automatic unlocking of the drives while booting. </span><span class="koboSpan" id="kobo.773.2">This removes the manual typing of the passphrase but could expose the key and thus the data if the server </span><span class="No-Break"><span class="koboSpan" id="kobo.774.1">is stolen.</span></span></p>
<p><span class="koboSpan" id="kobo.775.1">To avoid complexity, rely on the risk analysis approach to define the needs regarding your specific environment and how to comply with your regulations. </span><span class="koboSpan" id="kobo.775.2">Then, select a filesystem</span><a id="_idIndexMarker197"/><span class="koboSpan" id="kobo.776.1"> encryption method that addresses your requirements and the operational </span><span class="No-Break"><span class="koboSpan" id="kobo.777.1">team’s skills.</span></span></p>
<h4><span class="koboSpan" id="kobo.778.1">Network-bound disk encryption (NBDE)</span></h4>
<p><span class="koboSpan" id="kobo.779.1">Key management </span><a id="_idIndexMarker198"/><span class="koboSpan" id="kobo.780.1">services, also called key escrow in this context, offload the encryption key to a remote service to avoid some of the pitfalls listed in the previous solutions. </span><span class="koboSpan" id="kobo.780.2">Keys are stored in a vault-like data store and thus require high availability and backup strategies to guarantee the availability and survival of the encryption keys. </span><span class="koboSpan" id="kobo.780.3">If not, the data on the disk will be lost forever. </span><span class="koboSpan" id="kobo.780.4">Note that backups also need to be secured to avoid any key leaks from side channels or </span><span class="No-Break"><span class="koboSpan" id="kobo.781.1">opportunistic hacks.</span></span></p>
<p><span class="koboSpan" id="kobo.782.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.783.1">network-bound disk encryption</span></strong><span class="koboSpan" id="kobo.784.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.785.1">NBDE</span></strong><span class="koboSpan" id="kobo.786.1">) solution</span><a id="_idIndexMarker199"/><span class="koboSpan" id="kobo.787.1"> solves these challenges by introducing a multilayering </span><span class="No-Break"><span class="koboSpan" id="kobo.788.1">of security:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.789.1">It uses the HTTP/HTTPS protocol to ease the </span><span class="No-Break"><span class="koboSpan" id="kobo.790.1">network configuration.</span></span></li>
<li><span class="koboSpan" id="kobo.791.1">A set of servers created with a predefined quorum to provide encryption/decryption capabilities. </span><span class="koboSpan" id="kobo.791.2">If the quorum is not met, the decryption will not happen until that instance is back online. </span><span class="koboSpan" id="kobo.791.3">This creates the notion of network dependencies, or the network on which the disk should be connected to access all NBDE servers before allowing the exposure of </span><span class="No-Break"><span class="koboSpan" id="kobo.792.1">its content.</span></span></li>
<li><span class="koboSpan" id="kobo.793.1">Symmetric encryption keys being split across all the NBDE servers with an easy-to-(re)distribute </span><span class="No-Break"><span class="koboSpan" id="kobo.794.1">public key.</span></span></li>
<li><span class="koboSpan" id="kobo.795.1">Reduce key management, no vault, and no high availability and </span><span class="No-Break"><span class="koboSpan" id="kobo.796.1">backup necessary.</span></span></li>
<li><span class="koboSpan" id="kobo.797.1">Allow transparent reboot when all conditions </span><span class="No-Break"><span class="koboSpan" id="kobo.798.1">are met.</span></span></li>
<li><span class="koboSpan" id="kobo.799.1">Protect against a disk or server and its disks being stolen, unless the entire NBDE setup </span><span class="No-Break"><span class="koboSpan" id="kobo.800.1">is stolen.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.801.1">This solution is not as hard as it sounds to implement. </span><span class="koboSpan" id="kobo.801.2">Such implementation can be put in place in no time while addressing the most rigid compliance and </span><span class="No-Break"><span class="koboSpan" id="kobo.802.1">regulation requirements.</span></span></p>
<p><span class="koboSpan" id="kobo.803.1">See the following </span><span class="No-Break"><span class="koboSpan" id="kobo.804.1">for reference:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.805.1">Example of a </span><a id="_idIndexMarker200"/><span class="koboSpan" id="kobo.806.1">project for a resilient KMS for </span><span class="No-Break"><span class="koboSpan" id="kobo.807.1">NBDE: </span></span><a href="https://github.com/latchset/tang"><span class="No-Break"><span class="koboSpan" id="kobo.808.1">https://github.com/latchset/tang</span></span></a></li>
<li><span class="koboSpan" id="kobo.809.1">Example of an NBDE implementation on Red Hat Enterprise </span><span class="No-Break"><span class="koboSpan" id="kobo.810.1">Linux: </span></span><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/configuring-automated-unlocking-of-encrypted-volumes-using-policy-based-decryption_security-hardening"><span class="No-Break"><span class="koboSpan" id="kobo.811.1">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/security_hardening/configuring-automated-unlocking-of-encrypted-volumes-using-policy-based-decryption_security-hardening</span></span></a></li>
<li><span class="koboSpan" id="kobo.812.1">Example of NBDE with Tang server implementation on Red Hat </span><span class="No-Break"><span class="koboSpan" id="kobo.813.1">OpenShift: </span></span><a href="https://docs.openshift.com/container-platform/4.13/security/network_bound_disk_encryption/nbde-about-disk-encryption-technology.html"><span class="No-Break"><span class="koboSpan" id="kobo.814.1">https://docs.openshift.com/container-platform/4.13/security/network_bound_disk_encryption/nbde-about-disk-encryption-technology.html</span></span></a></li>
</ul>
<h2 id="_idParaDest-73"><a id="_idTextAnchor075"/><span class="koboSpan" id="kobo.815.1">Transport</span></h2>
<p><em class="italic"><span class="koboSpan" id="kobo.816.1">The entire Kubernetes design is based on API-driven architecture. </span><span class="koboSpan" id="kobo.816.2">This means that any exchange of payloads needs to be done through a secure channel using Transport Layer Security (TLS). </span><span class="koboSpan" id="kobo.816.3">If not, exchanges with etcd will be readable from the wire, including sensitive data from </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.817.1">the Secrets.</span></em></span></p>
<p><span class="koboSpan" id="kobo.818.1">Most Kubernetes</span><a id="_idIndexMarker201"/><span class="koboSpan" id="kobo.819.1"> distributions have TLS enabled by default and provide Ops with TLS security profile options to guarantee compatibility between services and applications interacting with each other. </span><span class="koboSpan" id="kobo.819.2">In Red Hat OpenShift, a granular approach allows the Ops to configure a specific TLS security profile for the ingress, the kubelet, and the control plane components, the latter </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">including etcd.</span></span></p>
<p><span class="koboSpan" id="kobo.821.1">Note that the service endpoint could also be enforced with a TLS termination handled by external network equipment or software, such as a load balancer. </span><span class="koboSpan" id="kobo.821.2">While this approach would secure network flow from the end user accessing the API server with a fully qualified domain name, this will not protect the internal Kubernetes network flow if left without any TLS termination. </span><span class="koboSpan" id="kobo.821.3">Both should be considered to guarantee an improved </span><span class="No-Break"><span class="koboSpan" id="kobo.822.1">security posture.</span></span></p>
<p><span class="koboSpan" id="kobo.823.1">See the following </span><span class="No-Break"><span class="koboSpan" id="kobo.824.1">for reference:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.825.1">etcd transport </span><a id="_idIndexMarker202"/><span class="koboSpan" id="kobo.826.1">security </span><span class="No-Break"><span class="koboSpan" id="kobo.827.1">model: </span></span><a href="https://etcd.io/docs/v3.5/op-guide/security/"><span class="No-Break"><span class="koboSpan" id="kobo.828.1">https://etcd.io/docs/v3.5/op-guide/security/</span></span></a></li>
<li><span class="koboSpan" id="kobo.829.1">Red Hat </span><a id="_idIndexMarker203"/><span class="No-Break"><span class="koboSpan" id="kobo.830.1">OpenShift: </span></span><a href="https://docs.openshift.com/container-platform/4.13/security/tls-security-profiles.html#tls-profiles-kubernetes-configuring_tls-security-profiles"><span class="No-Break"><span class="koboSpan" id="kobo.831.1">https://docs.openshift.com/container-platform/4.13/security/tls-security-profiles.html#tls-profiles-kubernetes-configuring_tls-security-profiles</span></span></a></li>
</ul>
<h1 id="_idParaDest-74"><a id="_idTextAnchor076"/><span class="koboSpan" id="kobo.832.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.833.1">While security measures depend on the organization’s compliance and regulation requirements, a risk-based assessment will define the appropriate actions to harden your information systems. </span><span class="koboSpan" id="kobo.833.2">However, securing Kubernetes Secrets is not optional but </span><span class="No-Break"><span class="koboSpan" id="kobo.834.1">a must.</span></span></p>
<p><span class="koboSpan" id="kobo.835.1">Given the current trend of adopting hybrid multi-cloud patterns, having one cluster’s etcd compromised, whether it is on the cloud or self-managed, could lead to compromising the entire environment. </span><span class="koboSpan" id="kobo.835.2">These types of attack leverage in-cluster network connections or a fleet management tool for which the token would be recorded within the compromised etcd. </span><span class="koboSpan" id="kobo.835.3">Such a scenario would lead to a viral attack infecting every </span><span class="No-Break"><span class="koboSpan" id="kobo.836.1">connected endpoint.</span></span></p>
<p><span class="koboSpan" id="kobo.837.1">As a remediation, the native Kubernetes encryption – more specifically, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.838.1">kms</span></strong><span class="koboSpan" id="kobo.839.1"> provider – is a best practice security pattern supported by all the major cloud and </span><span class="No-Break"><span class="koboSpan" id="kobo.840.1">software providers.</span></span></p>
<p><span class="koboSpan" id="kobo.841.1">Remember, security is not a finite game but a continuous effort. </span><span class="koboSpan" id="kobo.841.2">Regular audits and scans of your ever-changing environment will provide you with the most current state of compliance. </span><span class="koboSpan" id="kobo.841.3">They will also help to build a backlog of tasks to mitigate known vulnerabilities </span><span class="No-Break"><span class="koboSpan" id="kobo.842.1">and misconfigurations.</span></span></p>
<p><span class="koboSpan" id="kobo.843.1">In the next chapter, we will look at the debugging and troubleshooting techniques to analyze unexpected behaviors when configuring and consuming </span><span class="No-Break"><span class="koboSpan" id="kobo.844.1">Kubernetes Secrets.</span></span></p>
</div>
</body></html>