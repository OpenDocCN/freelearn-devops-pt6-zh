<html><head></head><body>
		<div id="_idContainer079">
			<h1 id="_idParaDest-199"><em class="italic"><a id="_idTextAnchor198"/>Chapter 12</em>: Security and Compliance Using OPA Gatekeeper</h1>
			<p>In this chapter, we'll cover bringing security and compliance to our Kubernetes clusters using <strong class="bold">OPA Gatekeeper</strong> and why it is needed to manage a cluster at scale. (OPA stands for <strong class="bold">Open Policy Agent</strong>.) With so many different teams deploying their applications on your clusters, enforcing standards in your environment (for example, blocking public image registries and blocking deployments that don't follow the rules, such as setting CPU and memory limits on Pods) becomes extremely hard. We'll also cover Rancher's <strong class="bold">Center for Internet Security</strong> (<strong class="bold">CIS</strong>) scanner, which is required to scan a Kubernetes cluster for known vulnerabilities, along with Rancher's hardening guides applying changes to RKE and RKE2 clusters that enforce extra security standards as defined in the CIS benchmark. We'll also look at how to maintain the cluster on an ongoing basis, and enterprise solutions such as NeuVector.</p>
			<p>In this chapter, we're going to cover the following main topics:</p>
			<ul>
				<li>Why should I care about security in Kubernetes?</li>
				<li>How do I enforce standards and security policies in Kubernetes?</li>
				<li>What is OPA Gatekeeper?</li>
				<li> How do I install OPA Gatekeeper from the marketplace?</li>
				<li>Best practices and standard policies.</li>
				<li>How do I scan my cluster for security issues?</li>
				<li>How do I lock down my cluster?</li>
				<li>Deploying the Rancher CIS scan.</li>
				<li>Additional security tools for protecting a cluster.</li>
			</ul>
			<h1 id="_idParaDest-200"><a id="_idTextAnchor199"/>Why should I care about security in Kubernetes?</h1>
			<p>One <a id="_idIndexMarker855"/>of the questions I get asked a lot is <em class="italic">Why should I care about security? Doesn't containerization fix this?</em> The short answer is no. Containerization<a id="_idIndexMarker856"/> does not solve every IT security problem, but it does change the game if we look back at how we traditionally handled security with servers. </p>
			<p>First, we would deploy <strong class="bold">antivirus</strong> (<strong class="bold">AV</strong>) software on all our servers to detect and block malware, worms, and Trojan horses, for example, from attacking our servers and stealing our data. Now, containerization throws a big wrench into the works because we virtualize our applications inside another server, and most AV software does not understand nor support running on a server with Docker. This is even discussed in the official<a id="_idIndexMarker857"/> Docker documentation at <a href="https://docs.docker.com/engine/security/antivirus/">https://docs.docker.com/engine/security/antivirus/</a> that recommends excluding the Docker process and its directories from being scanned. In addition, most of the popular AV vendors, such as Symantec Endpoint Protection, block Docker from running altogether. It is important to note that security software, such as Aqua, supports running AV scans at the host level. We'll talk more about this topic later in this chapter.</p>
			<p>Second, we would create firewall rules between our servers, giving only the bare minimum access. For example, you might only <a id="_idIndexMarker858"/>allow a <strong class="bold">Secure Shell</strong> (<strong class="bold">SSH</strong>) protocol from a limited number of jump servers so that if someone compromised a public-facing web server and gained remote access, they wouldn't be able to SSH into other servers, such as the database server. Kubernetes changed this because <a id="_idIndexMarker859"/>most <strong class="bold">Container Network Interface</strong> (<strong class="bold">CNI</strong>) providers, such as Canal, Calico, and Weave, are open by default, meaning any pod in the cluster can directly connect to any other pod in the cluster. This means if someone compromised the pod running your web server, they could now start directly attacking other pods in the same cluster. It is essential to note that Kubernetes has NetworkPolicies that allow you to bring firewall-like rules into your cluster. However, not all CNI providers support NetworkPolicies. You can find a list of the different CNIs that <a id="_idIndexMarker860"/>Rancher supports located at https://rancher.com/docs/rancher/v2.6/en/faq/networking/cni-providers/#cni-features-by-provider. This table includes the ones that support the NetworkPolicies resource type as not all CNI providers support this feature.</p>
			<p>Third is control over what software is allowed to be installed in your environment. Most enterprise environments do not allow application teams to directly access production servers. They require application teams to document how to install their application and how this process is being reviewed by outside teams such as security and compliance. This was mainly to prevent application teams from making changes to the server that could be a security issue. For example, without controls in place, an application team might just disable the AV software instead of going through the process of whitelisting their processes and fixing security issues with their application. In addition, a team might be using outdated software, such as Java, that has known vulnerabilities, with most security teams blocking this. Containerization flips the script because an application team builds their images; that is, if needed, they can install the software and libraries they want, including outdated and vulnerable software.</p>
			<p>Fourth, we <a id="_idIndexMarker861"/>come to patching. Most translational server environments<a id="_idIndexMarker862"/> have regular patching schedules, such as applying OS patches every month. Because of this, known vulnerabilities are regularly removed from your environment. Containerization, by default, makes a task such as monthly patching not a thing. One of the core concepts with containers is that your images should be static and can only change with a re-deployment. </p>
			<p>For example, an application team deploys a pod running a currently patched Ubuntu-based image. They then leave it untouched for six months. Now, the Ubuntu-based image is out of date and needs to be updated. You can, of course, connect to the pod and run <strong class="source-inline">apply patches</strong> by running <strong class="source-inline">apt upgrade</strong> but your changes will be wiped out as soon as that pod gets rescheduled. You need to rely on application teams to keep the images up to date by redeploying the application on a set schedule, and we all know how that will work out, as they don't want to change anything if it's working. It's important to note that this problem is solved by adding image scanning to your pipeline, and we'll be covering this topic later in this chapter.</p>
			<p>Last, but not least, is limiting access in a traditional enterprise environment. Access to production servers is limited, with application teams not being allowed access. But, with Kubernetes, it is typical for organizations to get started on their Kubernetes journey to give developers access to the production clusters for speed and efficiency.</p>
			<p>In the next section, we'll dive into how we start solving these issues, mainly focusing on OPA Gatekeeper and Rancher CIS scans.</p>
			<h1 id="_idParaDest-201"><a id="_idTextAnchor200"/>How do I enforce standards and security policies in Kubernetes?</h1>
			<p>Of course, now that <a id="_idIndexMarker863"/>we know about all <a id="_idIndexMarker864"/>these security issues/limitations, we need to ask what can we do about them?</p>
			<p>First is the AV software issue, with the question being, why do we need AV software in the first place? We need it because we need to detect when rogue software runs in our environment. For example, a hacker compromises a web server by finding a vulnerability that gives<a id="_idIndexMarker865"/> them <strong class="bold">Remote Code Execution</strong> (<strong class="bold">RCE</strong>), also known<a id="_idIndexMarker866"/> as <strong class="bold">Arbitrary Code Execution</strong> (<strong class="bold">ACE</strong>). Then, the hacker will start installing a <strong class="bold">Remote Access Tool</strong> (<strong class="bold">RAT</strong>) to start<a id="_idIndexMarker867"/> moving laterally to other servers, trying to gain more access. Containerization addresses this issue by shrinking the attack surface. For example, it's tough to get a remote shell on a server if it doesn't have a shell. This is why it's expected that most container images contain only the absolute minimum software packages and libraries. Kubernetes also addresses this issue by running containers with non-privileged accounts. For example, we might run Apache as a non-root user. So, even if someone gains access to the pod, they wouldn't have permission to install additional software and libraries. This also includes if they were to find a way to break out of the container, they would still be running as an account with little to no permissions.</p>
			<p>The second is firewall rules, as discussed in the previous section. Kubernetes, by default, is open between pods but because you need to expose ports and services to the outside world explicitly, you get the benefit of being secure to the outside world by default. For example, if we are running an Apache server as a pod in our cluster, by default, we are not opening that pod directly to the world. But still, you are exposing it via an ingress-controller where you can <a id="_idIndexMarker868"/>enable security settings such <a id="_idIndexMarker869"/>as <strong class="bold">ModSecurity</strong>, which is a <strong class="bold">Web Application Firewall</strong> (<strong class="bold">WAF</strong>) that can protect you from cross-site scripting, SQL injections, and sessions. You can find out more about ModSecurity by visiting <a href="https://github.com/SpiderLabs/ModSecurity">https://github.com/SpiderLabs/ModSecurity</a>, and you can find the details around enabling ModSecurity with Ingress NGINX located at https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#modsecurity.</p>
			<p>The third<a id="_idIndexMarker870"/> issue is control of the<a id="_idIndexMarker871"/> deployed software. We would manage the software on the endpoints, or servers, in translational environments. Containerization moved this process from the endpoint into your build pipeline. This is done by integrating software such as Clair into your build scripts. The idea with Clair is that you run your <strong class="source-inline">docker build</strong> command, then pass the image over to Clair, where it will be downloaded and scanned for known vulnerabilities inside the image. Clair will <a id="_idIndexMarker872"/>create a report listing the vulnerabilities, <strong class="bold">CVE</strong> (<strong class="bold">Common Vulnerabilities and Exposures</strong>) number, and severity level. Depending <a id="_idIndexMarker873"/>on your <strong class="bold">continuous integration/continuous deployment</strong> (<strong class="bold">CI/CD</strong>) software, you can choose to block a build if the image has too many vulnerabilities.</p>
			<p>The fourth issue is application patching. Unfortunately, there isn't an easy way to solve this problem; the proper way is to regularly update your containers as part of your ongoing development process. But, as we know, regular patching of images can fall behind. So, what some people do is set up scheduled builds in their pipeline. For example, you might create a scheduled task to rebuild your application image every month using the current code versions and automatically deploy and test it in your environment. By doing this, you are <em class="italic">patching</em> your containers every month, just like we do with our servers.</p>
			<p>Finally, we have the issue of access. The easy way is to give everyone access to deploy into production and make any changes they want. But, this will provide you with unwanted problems and security, because it's always easier to just turn off protection when it's in your way than to fix the reason it's being blocked. To prevent this behavior, it is recommended to force all changes via a CI/CD pipeline to be tracked and controlled using tools such as GitHub/GitLab <strong class="bold">pull request</strong> (<strong class="bold">PR</strong>) approvals<a id="_idIndexMarker874"/> and not give anyone access to production outside cluster administrators. Rancher can address this issue using its Fleet product, which you can learn more about by visiting <a href="https://fleet.rancher.io">https://fleet.rancher.io</a>. In addition, as of Rancher v2.6, Fleet is built into Rancher itself.</p>
			<p>At this point, we should know about the basic concepts around translating traditional IT security requirements into their Kubernetes counterparts. In the next section, we'll be diving into OPA Gatekeeper to enforce our clusters' security standards.</p>
			<h1 id="_idParaDest-202"><a id="_idTextAnchor201"/>What is OPA Gatekeeper?</h1>
			<p>OPA is an open<a id="_idIndexMarker875"/> source policy engine that has been built for the cloud. In addition, OPA is a <strong class="bold">Cloud Native Computing Foundation</strong> (<strong class="bold">CNCF</strong>) graduated project like a number of <a id="_idIndexMarker876"/>the other tools we covered. OPA uses declarative language to enforce policies across your environment. The basic idea is everything should call OPA and ask, <em class="italic">Hey can I do XYZ?</em> At which point, OPA will evaluate the request against its policies to approve or reject the request. It is important to note that OPA is designed to be generic to be integrated with Kubernetes and other systems, such as Terraform, Docker, and SSH.</p>
			<p>Of course, the question comes up, what is Gatekeeper then? In short, OPA Gatekeeper is a Kubernetes controller that allows you to define your OPA policies as Kubernetes objects. This mainly includes constraints and constraint templates. This enables users to define their policies as YAML and apply them to their cluster just like another Kubernetes deployment. For the rest of this chapter, we'll focus on OPA Gatekeeper.</p>
			<p>Now that we know what OPA Gatekeeper is, the next question to answer is <em class="italic">How does it work?</em> The best way to answer that question is to follow a request through the process. Please see the following diagram to understand this process.</p>
			<div>
				<div id="_idContainer072" class="IMG---Figure">
					<img src="image/B18053_12_01.jpg" alt="Figure 12.1 – OPA Gatekeeper request flow diagram&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.1 – OPA Gatekeeper request flow diagram</p>
			<p>Let's look at these steps<a id="_idIndexMarker877"/> in detail next:</p>
			<ul>
				<li><strong class="bold">Step 1</strong>: A developer creates a request, and in this case, the request is for a new Deployment called <strong class="bold">webserver</strong> in the <strong class="bold">testing</strong> namespace.</li>
				<li><strong class="bold">Step 2</strong>: The developer submits the request to <strong class="bold">Kube-Apiserver</strong> as a YAML or JSON file.</li>
				<li><strong class="bold">Step 3</strong>: <strong class="bold">Kube-Apiserver</strong> receives the request and starts processing by verifying if the user has valid credentials, the request has valid syntax, and the user has permissions to access the requested resources. At this point, usually, <strong class="bold">Kube-Apiserver</strong> would respond to the developer accepting or denying the request. But, because we deployed OPA Gatekeeper to this cluster, the request follows a different path.</li>
				<li><strong class="bold">Step 4</strong>: <strong class="bold">Admission Controller</strong> takes the incoming requests and uses a set of rules called <strong class="source-inline">ValidatingAdmissionWebhook</strong> to route some requests to a defined webhook. It is important to note that not all requests are forwarded to the webhook. For example, a <strong class="source-inline">kubectl get pods</strong> request is a read-only request, so it would not be forwarded to the webhook. But, a request for creating a pod would be because it's a change to the environment. In this case, OPA Gatekeeper has added <strong class="source-inline">ValidatingAdmissionWebhook</strong> into <strong class="bold">Kube-Apiserver</strong>. </li>
				<li><strong class="bold">Step 5</strong>: The request <a id="_idIndexMarker878"/>is forwarded via the webhook to the OPA Gatekeeper service, which defaults to <a href="https://gatekeeper-webhook-service.cattle-gatekeeper-system:443">https://gatekeeper-webhook-service.cattle-gatekeeper-system:443</a> with Rancher's OPA Gatekeeper deployment. The forwarded request has the complete payload minus the user authentication. This includes items such as image paths, labels, and security context. At this point, the OPA Gatekeeper server pods take over and review the request to see if it violates any of the defined policies or constraints. For example, you might have a constraint requiring all namespaces to have a label such as <strong class="source-inline">billing-code</strong>, which you can use for charge-back to your application teams.</li>
				<li><strong class="bold">Step 6</strong>: Once OPA Gatekeeper reviews the request, it will approve or reject it. If we use the example in <em class="italic">Step 5</em>, if someone tries to deploy a namespace without the <strong class="source-inline">billing-code</strong> label, the creation will be blocked, and the rejection will be forwarded to the next step. But, assuming that the request was approved, OPA Gatekeeper will respond with an HTTP success code of <strong class="source-inline">200</strong>.</li>
				<li><strong class="bold">Step 7</strong>: At this point, <strong class="bold">Kube-Apiserver</strong> takes over the request and will use the HTTP success code to decide what it should do with the request. It is important to note that upstream OPA Gatekeeper is set to <strong class="source-inline">fail close by default</strong> by default. What this means is if the request is anything but <strong class="source-inline">200</strong>, it is assumed to be a denial, and the request will be rejected. Even valid deployments will be rejected if the OPA Gatekeeper pods are down or unavailable. This means your cluster is blocked, and no pod will spin up. So, Rancher's OPA Gatekeeper deployment switches the default policy to <strong class="source-inline">failurePolicy: Ignore</strong>, which states if the webhook request receives an error such as a timeout. The Admission Controller will fail to open, which means that the controller will assume the request would have been approved if OPA Gatekeeper is ever offline. You should review this setting with your security team and confirm if availability is more important than potentially allowing a deployment that doesn't meet the standards during an outage.</li>
			</ul>
			<p>Finally, at this point, the end user will receive a response to their request. Because of the steps listed previously, the user might see additional latency during a deployment. But, this usually is so quick that it becomes background noise for most environments. It is also important to note that this process applies to both end users and internal requests from other controllers inside the cluster, such as kube-scheduler. </p>
			<p>At this point, you should understand how a request flows through kube-apiserver into the Admission Controller, then forwarded on to OPA Gatekeeper, then finally back to the developer via kube-apiserver. In the next section, we are going to dive into the process of installing OPA Gatekeeper in your cluster.</p>
			<h1 id="_idParaDest-203"><a id="_idTextAnchor202"/>How to install OPA Gatekeeper from the marketplace</h1>
			<p>With Rancher, there are <a id="_idIndexMarker879"/>two main ways to deploy OPA Gatekeeper, these being via the App marketplace in Rancher and via the Rancher Helm Chart. Of course, you can deploy upstream OPA Gatekeeper directly without Rancher. It is typically recommended to deploy OPA Gatekeeper via the App marketplace simply for convenience. The steps for installing OPA Gatekeeper are listed in this section for each of the major Rancher releases.</p>
			<p>Before we discuss the installation steps, here's a list of the prerequisites<a id="_idIndexMarker880"/> to have ready for the installation:</p>
			<ul>
				<li>You should have the global role Administrator or Cluster Owner permissions to the cluster.</li>
				<li>OPA Gatekeeper requires Kubernetes v1.16 or higher.</li>
				<li>You should review the official support matrix at <a href="https://www.suse.com/suse-rancher/support-matrix/all-supported-versions/">https://www.suse.com/suse-rancher/support-matrix/all-supported-versions/</a> to confirm that you are deploying a fully <a id="_idIndexMarker881"/>compatible and validated system solution.</li>
			</ul>
			<p>To install <a id="_idIndexMarker882"/>OPA Gatekeeper in Rancher v2.4, follow<a id="_idIndexMarker883"/> these steps:</p>
			<ol>
				<li>In the Rancher UI, go to the <strong class="bold">Cluster</strong> dashboard.</li>
				<li>Go to the <strong class="bold">Tools</strong> menu and select <strong class="bold">OPA Gatekeeper</strong> from the drop-down menu; refer to <em class="italic">Figure 12.2</em>:</li>
			</ol>
			<div>
				<div id="_idContainer073" class="IMG---Figure">
					<img src="image/B18053_12_02.jpg" alt="Figure 12.2 – Rancher v2.4 installing OPA Gatekeeper from the Tools menu&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.2 – Rancher v2.4 installing OPA Gatekeeper from the Tools menu</p>
			<ol>
				<li value="3">It is normally recommended to use the default settings, which can be found at <a href="https://rancher.com/docs/rancher/v2.0-v2.4/en/cluster-admin/tools/opa-gatekeeper/">https://rancher.com/docs/rancher/v2.0-v2.4/en/cluster-admin/tools/opa-gatekeeper/</a>.</li>
			</ol>
			<div>
				<div id="_idContainer074" class="IMG---Figure">
					<img src="image/B18053_12_03.jpg" alt="Figure 12.3 – Rancher v2.4 OPA Gatekeeper install wizard&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.3 – Rancher v2.4 OPA Gatekeeper install wizard</p>
			<p>Next, let's <a id="_idIndexMarker884"/>look at the<a id="_idIndexMarker885"/> installation steps for Rancher v2.5:</p>
			<ol>
				<li value="1">In the Rancher UI, go to <strong class="bold">Cluster Explorer</strong>.</li>
				<li>Click on the <strong class="bold">Apps &amp; Marketplace</strong> option.</li>
				<li>Select the <strong class="bold">OPA Gatekeeper</strong> chart.</li>
			</ol>
			<div>
				<div id="_idContainer075" class="IMG---Figure">
					<img src="image/B18053_12_04.jpg" alt="Figure 12.4 – Rancher v2.5 installing OPA Gatekeeper from Apps &amp; Marketplace&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.4 – Rancher v2.5 installing OPA Gatekeeper from Apps &amp; Marketplace</p>
			<p>It is normally recommended to use the default settings, which can be found at <a href="https://rancher.com/docs/rancher/v2.5/en/opa-gatekeper/">https://rancher.com/docs/rancher/v2.5/en/opa-gatekeper/</a>.</p>
			<p>Now, we'll<a id="_idIndexMarker886"/> discuss the <a id="_idIndexMarker887"/>installation for Rancher v2.6:</p>
			<ol>
				<li value="1">In the Rancher UI, go to <strong class="bold">Cluster Management</strong>.</li>
				<li>On the <strong class="bold">Clusters</strong> page, go to the cluster where you want to enable OPA Gatekeeper and click <strong class="bold">Explore</strong>.</li>
				<li>In the left navigation bar, click <strong class="bold">Apps &amp; Marketplace</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer076" class="IMG---Figure">
					<img src="image/B18053_12_05.jpg" alt="Figure 12.5 – Rancher v2.6 installing OPA Gatekeeper from Apps &amp; Marketplace&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.5 – Rancher v2.6 installing OPA Gatekeeper from Apps &amp; Marketplace</p>
			<ol>
				<li value="4">Click <strong class="bold">Charts</strong>, then click <strong class="bold">OPA Gatekeeper</strong> and click <strong class="bold">Install</strong>.</li>
			</ol>
			<div>
				<div id="_idContainer077" class="IMG---Figure">
					<img src="image/B18053_12_06.jpg" alt="Figure 12.6 – OPA Gatekeeper Install page&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.6 – OPA Gatekeeper Install page</p>
			<ol>
				<li value="5">It is <a id="_idIndexMarker888"/>usually recommended to use the default settings, which<a id="_idIndexMarker889"/> can be found at <a href="https://rancher.com/docs/rancher/v2.6/en/opa-gatekeper/">https://rancher.com/docs/rancher/v2.6/en/opa-gatekeper/</a>.</li>
			</ol>
			<div>
				<div id="_idContainer078" class="IMG---Figure">
					<img src="image/B18053_12_07.jpg" alt="Figure 12.7 – Rancher v2.6 OPA Gatekeeper Install options&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 12.7 – Rancher v2.6 OPA Gatekeeper Install options</p>
			<p>At this point, we should have OPA Gatekeeper installed in our environment but without constraints, it won't do much. In the next section, we are going to cover some standard constraint templates that you can use to get started.</p>
			<h1 id="_idParaDest-204"><a id="_idTextAnchor203"/>Best practices and standard policies</h1>
			<p>Now that we have<a id="_idIndexMarker890"/> OPA Gatekeeper installed, it's time to start creating<a id="_idIndexMarker891"/> templates and applying them to your cluster. In this section, we are going to cover some of the most popular templates. It is important to note that most of these templates come from upstream OPA Gatekeeper.</p>
			<p>I like to deploy the first one called <strong class="source-inline">containerlimits</strong>, a template rule that ensures that all pods have CPU and memory limits set. You can find the template at <a href="https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general/containerlimits">https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general/containerlimits</a>. The main idea here is that, by default, all pods are given unlimited CPU and memory, meaning a single pod can steal all the resources on a node forcing out other pods and even causing nodes to lock up and then crash. This causes what I call a <em class="italic">runaway app</em> that will consume a node, cause it to crash, then move to another node and repeat the process until you run out of nodes. You can find an example of this kind of application at <a href="https://github.com/mattmattox/Kubernetes-Master-Class/tree/main/disaster-recovery/run-away-app">https://github.com/mattmattox/Kubernetes-Master-Class/tree/main/disaster-recovery/run-away-app</a>.</p>
			<p>This link also includes how to resolve a runaway app issue. This template makes sure that it's set to a valid value. It could be 1 MB of memory, meaning the pods will never be scheduled, or it could be 100 TB, meaning the pod will never be scheduled because there is no node big enough for it to start. This also has the benefit of giving you insight into the capacity <a id="_idIndexMarker892"/>required for your clusters, because if you see that <a id="_idIndexMarker893"/>your cluster is reporting 100% allocation, it means one of two things:</p>
			<ul>
				<li>Your limits are being set too high, and you are wasting resources.</li>
				<li>You need to start adding nodes, because you will run out of resources. </li>
			</ul>
			<p>OPA Gatekeeper can protect us from runaway apps by blocking pods/deployments that are missing CPU and memory limits, which means a runaway app can never make it into the cluster in the first place.</p>
			<p class="callout-heading">Note </p>
			<p class="callout">We'll be covering scaling in the next chapter.</p>
			<p>To apply this template, simply run the following command:</p>
			<pre class="source-code">kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/containerlimits/template.yaml </pre>
			<p>But, make sure you test this in a non-production cluster first.</p>
			<p>Another <a id="_idIndexMarker894"/>template I like to use is called <strong class="source-inline">requiredlabels</strong>, which is a template that allows you to force all namespaces to have a label. For <a id="_idIndexMarker895"/>example, you might want to move all namespaces to have a billing code so you can do show-back and charge-back. Or maybe, you want to force the namespaces to have a technical contact listed to make it easier to contact the application team when deployments are misbehaving.</p>
			<p>To apply this template, simply run the following command:</p>
			<pre class="source-code">kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/requiredlabels/template.yaml</pre>
			<p class="callout-heading">Note </p>
			<p class="callout">This will only apply to newly created namespaces, so you will have to go back and set the label for existing namespaces.</p>
			<p>Full details about this template can be found at <a href="https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general/requiredlabels">https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general/requiredlabels</a>.</p>
			<p>Finally, the template that I see many security teams asking for is <strong class="source-inline">httpsonly</strong>, which forces all ingresses to have the <strong class="source-inline">kubernetes.io/ingress.allow-http = false</strong> annotation, meaning all ingresses must have an SSL certificated defined in the ingress configuration under the <strong class="bold">TLS</strong> (<strong class="bold">Transport Layer Security</strong>) section. Many security teams require all traffic, including backend services, to be HTTPS only.</p>
			<p>To apply this template, simply run the following command:</p>
			<pre class="source-code">kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper-library/master/library/general/httpsonly/template.yaml</pre>
			<p>Full details about this template can be found at <a href="https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general/httpsonly">https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general/httpsonly</a>. It is important to note that, by default, Rancher clusters come with a self-signed certificate for ingresses to default to when another certificate is not defined.</p>
			<p>There are, of <a id="_idIndexMarker896"/>course, more templates that the open source <a id="_idIndexMarker897"/>community has created, which can be found at <a href="https://github.com/open-policy-agent/gatekeeper-library">https://github.com/open-policy-agent/gatekeeper-library</a>. I also recommend using these templates as a base for creating your custom templates.</p>
			<p>At this point, you should have OPA Gatekeeper installed in your cluster and some rules defined, allowing you to enforce your standards. In the next section, we'll be diving into taking the next step of locking down your cluster to prevent security-related issues.</p>
			<h1 id="_idParaDest-205"><a id="_idTextAnchor204"/>How do I scan my cluster for security issues?</h1>
			<p>Rancher has a <a id="_idIndexMarker898"/>Rancher CIS scan or Rancher-cis-benchmark tool built on top of kube-bench, an open source software from Aqua Security. kube-bench is designed to scan a Kubernetes cluster and review the settings on the components of Kubernetes such as kube-apiserver, etcd, and kubelet. kube-bench uses the CIS Benchmark report from the non-profit organization CIS, which creates a standard list of best practice settings for protecting your Kubernetes cluster. These reports are made after the most significant changes to Kubernetes and are designed to be as vendor-neutral as possible. You can learn <a id="_idIndexMarker899"/>more about CIS and its reports by going to <a href="https://learn.cisecurity.org">https://learn.cisecurity.org</a>. But, because this report is intended to be vendor-neutral, some settings don't apply to Rancher and its cluster. So, Rancher publishes a self-assessment and hardening guide that addresses all the items in the report. This assessment is designed so that it can be handed over to your security team/auditors when they start asking questions. </p>
			<p>But, it is important to note that, by default, Rancher and its cluster will not pass the CIS report without making changes to your environment and nodes, with some of these steps requiring manual steps. In the next section, we'll be diving into how to make Rancher pass the report.</p>
			<p>You can find <a id="_idIndexMarker900"/>Rancher's reports and assessment at <a href="https://rancher.com/docs/rancher/v2.5/en/security/rancher-2.5/">https://rancher.com/docs/rancher/v2.5/en/security/rancher-2.5/</a>. It is important to note that these guides change over time as Kubernetes and Rancher are upgraded, and additionally, as security issues are found; thus, it is recommended to review these assessments on a scheduled basis.</p>
			<h1 id="_idParaDest-206"><a id="_idTextAnchor205"/>How do I lock down my cluster?</h1>
			<p>In the previous <a id="_idIndexMarker901"/>section, we talked about the CIS scan and Rancher's self-assessments, but of course, the question of <em class="italic">What can I do about this report?</em> comes up, and Rancher's answer to this question is what Rancher calls its <strong class="bold">hardening guides</strong>. These<a id="_idIndexMarker902"/> guides cover the three Kubernetes distributions that Rancher owns: RKE, RKE2, and k3s. We won't be going into too much detail in this section, as Rancher already has this process documented. Here, we'll be linking to guides for each cluster type.</p>
			<p>For RKE clusters, the hardening guide is tied to the Rancher server and Kubernetes version. The following are the high-level steps:</p>
			<ol>
				<li value="1">Configuring the Linux kernel to safely handle <strong class="bold">Out-Of-Memory</strong> (<strong class="bold">OOM</strong>) and kernel panics.</li>
				<li>Creating a local user and group to be used by etcd to isolate the database from other processes to protect the data.</li>
				<li>Disabling the default service accounts being mounted to every pod.</li>
				<li>Enabling a <strong class="source-inline">NetworkPolicy</strong> default to limit all pod-to-pod traffic, requiring that you open rules as you need them.</li>
				<li>Turning on secret encryption wherein, by default, secrets are stored in etcd in plain text, but with etcd encryption enabled, the secrets will be encrypted at rest.</li>
				<li>Finally, ending by turning on <strong class="source-inline">PodSecurityPolicy</strong> to limit pod security settings, such as blocking pods from running as root.</li>
			</ol>
			<p>The complete guide can be found at <a href="https://rancher.com/docs/rancher/v2.5/en/security/rancher-2.5/1.6-hardening-2.5/">https://rancher.com/docs/rancher/v2.5/en/security/rancher-2.5/1.6-hardening-2.5/</a>.</p>
			<p>This process is much easier for RKE2 clusters, as RKE2 is secure by default, but you still need to apply a few changes, which are listed here:</p>
			<ol>
				<li value="1">Setting the same Linux kernel parameters as RKE.</li>
				<li>Creating an etcd user.</li>
				<li>Finally, we just need to turn on the CIS profile that we would like on the master servers by adding the <strong class="source-inline">profile: cis-1.5/6</strong> option.</li>
			</ol>
			<p>The complete <a id="_idIndexMarker903"/>guide can be found at <a href="https://docs.rke2.io/security/hardening_guide/">https://docs.rke2.io/security/hardening_guide/</a>.</p>
			<p>The hardening process for k3s clusters is similar to RKE2 but still requires a few extra steps:</p>
			<ol>
				<li value="1">Setting the same Linux kernel parameters as RKE2</li>
				<li>Skipping the etcd steps, as k3s doesn't use etcd by default</li>
				<li>Turning on <strong class="source-inline">PodSecurityPolicy</strong> to limit pod security settings, such as blocking pods from running as root</li>
			</ol>
			<p>It is important to note that k3s doesn't have the CIS profiles like RKE2 and is not secure by default as it's designed to be lightweight and fast.</p>
			<p>The complete guide can be found at <a href="https://rancher.com/docs/k3s/latest/en/security/hardening_guide/">https://rancher.com/docs/k3s/latest/en/security/hardening_guide/</a>.</p>
			<p>At this point, assuming you have followed the guides listed previously, you should be able to move to install the Rancher CIS scan and be able to pass it.</p>
			<h1 id="_idParaDest-207"><a id="_idTextAnchor206"/>Deploying Rancher CIS scan</h1>
			<p>The only recommended <a id="_idIndexMarker904"/>way of installing Rancher CIS scan is via <strong class="bold">Apps &amp; Marketplace</strong> inside Rancher. But first, let's cover some of the basic requirements:</p>
			<ul>
				<li>Rancher v2.4 or greater.</li>
				<li>Cluster owner permissions to the downstream cluster(s) or global role Administrator permissions.</li>
				<li>The downstream cluster must be an RKE, RKE2, EKS, or GKE cluster for full support. <p class="callout-heading">Note</p><p class="callout">A generic profile can be used for other clusters, but there might be false positives or other permissions issues.</p></li>
			</ul>
			<p>Here is how to<a id="_idIndexMarker905"/> install <strong class="source-inline">rancher-cis-benchmark</strong> with Rancher v2.4.x and v2.5.x via the Cluster Explorer:</p>
			<ol>
				<li value="1">In the Rancher UI, go to <strong class="bold">Cluster Explorer</strong>.</li>
				<li>Click <strong class="bold">Apps</strong>.</li>
				<li>Click <strong class="bold">rancher-cis-benchmark</strong>.</li>
				<li>Click <strong class="bold">Install</strong>.</li>
			</ol>
			<p>To install the CIS Benchmark with Rancher v2.6.x via the <strong class="bold">Cluster Management</strong> pane, do the following:</p>
			<ol>
				<li value="1">In the Rancher UI, go to <strong class="bold">Cluster Management</strong>.</li>
				<li>Navigate to the cluster where you will install the CIS Benchmark.</li>
				<li>In the left navigation bar, click <strong class="bold">Apps &amp; Marketplace</strong> | <strong class="bold">Charts</strong>.</li>
				<li>Click <strong class="bold">CIS Benchmark</strong>.</li>
				<li>Click <strong class="bold">Install</strong>.<p class="callout-heading">Note</p><p class="callout">For Rancher-created clusters, you should use the <em class="italic">default</em> settings. For generic clusters, please review the example settings at <a href="https://github.com/rancher/cis-operator/tree/master/examples">https://github.com/rancher/cis-operator/tree/master/examples</a>.</p></li>
			</ol>
			<p>At this point, you should have your cluster locked down, and Rancher's CIS scan running in your cluster to confirm that the cluster stays locked over time. In the next section, we're going to dive into some additional tools for protecting your cluster, including some paid solutions.</p>
			<h1 id="_idParaDest-208"><a id="_idTextAnchor207"/>Additional security tools for protecting a cluster</h1>
			<p>We have <a id="_idIndexMarker906"/>mostly been talking about OPA Gatekeeper in this chapter, as it is one of the most popular open source solutions. But, of course, there are other paid solutions, such as NeuVector, which provides image and cluster scanning.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">With <strong class="bold">SUSE</strong> (German: <strong class="bold">Software- und System-Entwicklung</strong>) buying NeuVector, it has been announced that<a id="_idIndexMarker907"/> NeuVector's container runtime security platform will be released to the public under the Apache 2.0 license on GitHub at <a href="https://github.com/neuvector/neuvector">https://github.com/neuvector/neuvector</a>. </p>
			<p>In addition, the Aqua Platform is ubiquitous for paying customers, as it is a closed source product that requires licensing.</p>
			<p>For NeuVector, I recommend watching the master class <em class="italic">PCI Compliance and Vulnerability Management for Kubernetes</em> on YouTube (<a href="https://www.youtube.com/watch?v=kSkX5MRmEkE">https://www.youtube.com/watch?v=kSkX5MRmEkE</a>) to learn more about NeuVector and how to integrate it into Rancher.</p>
			<p>I also recommend watching the master class <em class="italic">Kubernetes Master Class Preventive Security for Kubernetes Enterprise Deployments</em> for Aqua, found here: <a href="https://www.youtube.com/watch?v=2Phk7yyWezU">https://www.youtube.com/watch?v=2Phk7yyWezU</a>.</p>
			<p class="callout-heading">Note</p>
			<p class="callout">Both the YouTube videos are hosted on Rancher's YouTube channel and include links to their slides and scripts.</p>
			<h1 id="_idParaDest-209"><a id="_idTextAnchor208"/>Summary</h1>
			<p>This chapter taught us about some of the security and compliance issues that containers and Kubernetes have addressed. We went over what OPA Gatekeeper is and how it works. We then dove into some of the best practices and standard templates. We learned how OPA Gatekeeper enforces different rules for your cluster by deploying these templates. This is important because this skill is necessary to create your own rules that suit your environment and its requirements. We then covered how to lock down your cluster and ensure it stays locked down using Rancher CIS scans.</p>
			<p>The next chapter will cover how to bring scaling to your clusters for both pods and nodes, including all the limitations and concerns with scaling your clusters. </p>
		</div>
	</body></html>