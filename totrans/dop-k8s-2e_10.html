<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Kubernetes on AWS</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Using Kubernetes on the public cloud is flexible and scalable for your application. </span><span class="koboSpan" id="kobo.2.2">AWS is one of the most popular services in the public cloud industry. </span><span class="koboSpan" id="kobo.2.3">In this chapter, you'll learn what AWS is and how to set up Kubernetes on AWS along with the following topics:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.3.1">Understanding the public cloud</span></li>
<li><span class="koboSpan" id="kobo.4.1">Using and understanding AWS components</span></li>
<li><span class="koboSpan" id="kobo.5.1">Using Amazon EKS to set up a Kubernetes cluster on AWS</span></li>
<li><span class="koboSpan" id="kobo.6.1">Using EKS to manage Kubernetes</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Introduction to AWS</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">When you run your application on the public network, you need an infrastructure such as networks, Virtual Machines (VMs), and storage. </span><span class="koboSpan" id="kobo.2.2">Obviously, companies borrow or build their own data center to prepare those infrastructures, and then hire data center engineers and operators to monitor and manage those resources.</span></p>
<p><span class="koboSpan" id="kobo.3.1">However, purchasing and maintaining those assets requires a large capital expense as well as an operational expense for data center engineers/operators. </span><span class="koboSpan" id="kobo.3.2">You also need a lead time to fully set up those infrastructures, such as buying a server, mounting to a data center rack, cabling a network, and then the initial configuration/installation of the OS and so on.</span></p>
<p><span class="koboSpan" id="kobo.4.1">Consequently, rapidly allocating an infrastructure with appropriate resource capacity is one of the important factors that dictates the success of your business.</span></p>
<p><span class="koboSpan" id="kobo.5.1">To make infrastructure management easier and quicker, there's a lot that technology can do to help data centers, for example, for virtualization, </span><strong><span class="koboSpan" id="kobo.6.1">Software Defined Network</span></strong><span class="koboSpan" id="kobo.7.1"> (</span><strong><span class="koboSpan" id="kobo.8.1">SDN</span></strong><span class="koboSpan" id="kobo.9.1">) and </span><strong><span class="koboSpan" id="kobo.10.1">Storage Area Network</span></strong><span class="koboSpan" id="kobo.11.1"> (</span><strong><span class="koboSpan" id="kobo.12.1">SAN</span></strong><span class="koboSpan" id="kobo.13.1">). </span><span class="koboSpan" id="kobo.13.2">But combining this technology has some sensitive compatibility issues and is difficult to stabilize; therefore it's necessary to hire experts in this industry, which makes operation costs higher eventually.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Public cloud</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">There are some companies that have provided an online infrastructure service. </span><span class="koboSpan" id="kobo.2.2">AWS is a well known service that provides online infrastructure, which is called cloud or </span><strong><span class="koboSpan" id="kobo.3.1">public cloud</span></strong><span class="koboSpan" id="kobo.4.1">. </span><span class="koboSpan" id="kobo.4.2">Back in the year 2006, AWS officially launched the virtual machine service, which was called </span><strong><span class="koboSpan" id="kobo.5.1">Elastic Computing Cloud</span></strong><span class="koboSpan" id="kobo.6.1"> (</span><strong><span class="koboSpan" id="kobo.7.1">EC2</span></strong><span class="koboSpan" id="kobo.8.1">); an online object store service, which was called </span><strong><span class="koboSpan" id="kobo.9.1">Simple Storage Service</span></strong><span class="koboSpan" id="kobo.10.1"> (</span><strong><span class="koboSpan" id="kobo.11.1">S3</span></strong><span class="koboSpan" id="kobo.12.1">); and an online messaging queue service, which was called </span><strong><span class="koboSpan" id="kobo.13.1">Simple Queue Service</span></strong><span class="koboSpan" id="kobo.14.1"> (</span><strong><span class="koboSpan" id="kobo.15.1">SQS</span></strong><span class="koboSpan" id="kobo.16.1">).</span></p>
<p><span class="koboSpan" id="kobo.17.1">These services are simple enough, but from a data center management point of view, they relieve infrastructure pre-allocation and reduce read time, because of pay-as-you-go pricing models (paying hourly or yearly for usage to AWS). </span><span class="koboSpan" id="kobo.17.2">Consequently, AWS is getting so popular that many companies have switched from their own data centers to the public cloud.</span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.18.1">An antonym of the public cloud, your own data center is referred to as </span><strong><span class="koboSpan" id="kobo.19.1">on-premises</span></strong><span class="koboSpan" id="kobo.20.1">.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">API and infrastructure as code</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">One of the unique benefits of using a public cloud instead of on-premises data centers is that public cloud provides an API to control infrastructure. </span><span class="koboSpan" id="kobo.2.2">AWS provides command-line tools (</span><strong><span class="koboSpan" id="kobo.3.1">AWS CLI</span></strong><span class="koboSpan" id="kobo.4.1">) to control AWS infrastructure. </span><span class="koboSpan" id="kobo.4.2">For example, after signing up to AWS (</span><a href="https://aws.amazon.com/free/" target="_blank"><span class="URLPACKT"><span class="koboSpan" id="kobo.5.1">https://aws.amazon.com/free/</span></span></a><span class="koboSpan" id="kobo.6.1">), install AWS CLI (</span><a href="http://docs.aws.amazon.com/cli/latest/userguide/installing.html" target="_blank"><span class="URLPACKT"><span class="koboSpan" id="kobo.7.1">http://docs.aws.amazon.com/cli/latest/userguide/installing.html</span></span></a><span class="koboSpan" id="kobo.8.1">); then, if you want to launch one virtual machine (EC2 instance), use the AWS CLI as follows:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.9.1"><img src="assets/851f14a5-046d-4fc1-b37c-930e58b471f9.png" style="width:50.08em;height:27.50em;"/></span></div>
<p><span class="koboSpan" id="kobo.10.1">As you can see, it only </span><span><span class="koboSpan" id="kobo.11.1">takes</span></span><span><span class="koboSpan" id="kobo.12.1"> </span></span><span><span class="koboSpan" id="kobo.13.1">a few minutes to access your virtual machine after signing up to AWS. </span><span class="koboSpan" id="kobo.13.2">On the other hand, what if you set up your own on-premises data center from scratch? </span><span class="koboSpan" id="kobo.13.3">The following diagram shows a comparison of what happens if you use on-premises data centers or if you use the public cloud:</span></span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.14.1"><img class=" image-border" src="assets/8d22cf5f-a01a-4c42-8608-23e445209f95.png" style="width:27.17em;height:22.17em;"/></span></div>
<p><span class="koboSpan" id="kobo.15.1">As you can see, the public cloud is very simple and quick; this is why it's flexible and convenient, not only </span><span><span class="koboSpan" id="kobo.16.1">for</span></span><span><span class="koboSpan" id="kobo.17.1"> </span></span><span><span class="koboSpan" id="kobo.18.1">emerging, but also for permanent usage.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">AWS components</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">AWS has some components to configure network and storage. </span><span class="koboSpan" id="kobo.2.2">These are important for understanding how the public cloud works as well as how to configure Kubernetes.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">VPC and subnet</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">On AWS, first of all you need to create your own network. </span><span class="koboSpan" id="kobo.2.2">This is called a </span><strong><span class="koboSpan" id="kobo.3.1">Virtual Private Cloud</span></strong><span class="koboSpan" id="kobo.4.1"> (</span><span><strong><span class="koboSpan" id="kobo.5.1">VPC</span></strong><span class="koboSpan" id="kobo.6.1">),</span></span><span class="koboSpan" id="kobo.7.1"> which uses SDN technology. </span><span class="koboSpan" id="kobo.7.2">AWS allows you to create one or more VPC on AWS. </span><span class="koboSpan" id="kobo.7.3">Each VPC may connect with each other as required. </span><span class="koboSpan" id="kobo.7.4">When you create a VPC, just define one network CIDR block and AWS region, for example, the </span><kbd><span class="koboSpan" id="kobo.8.1">10.0.0.0/16</span></kbd> <span><span class="koboSpan" id="kobo.9.1">CIDR </span></span><span class="koboSpan" id="kobo.10.1">on </span><kbd><span class="koboSpan" id="kobo.11.1">us-east-1</span></kbd><span class="koboSpan" id="kobo.12.1">. </span><span class="koboSpan" id="kobo.12.2">No matter whether you have access to a public network or not, you can define any network address range (between </span><kbd><span class="koboSpan" id="kobo.13.1">/16</span></kbd><span class="koboSpan" id="kobo.14.1"> to </span><kbd><span class="koboSpan" id="kobo.15.1">/28</span></kbd><span class="koboSpan" id="kobo.16.1"> netmask range). </span><span class="koboSpan" id="kobo.16.2">VPC creation is very quick; once done creating a VPC, you need to create one or more subnets within the VPC.</span></p>
<p><span class="koboSpan" id="kobo.17.1">In the following example, one VPC is created via the AWS command line:</span></p>
<pre><strong><span class="koboSpan" id="kobo.18.1">//specify CIDR block as 10.0.0.0/16</span></strong><br/><strong><span class="koboSpan" id="kobo.19.1">//the result, it returns VPC ID as "vpc-0ca37d4650963adbb"</span></strong><br/><strong><span class="koboSpan" id="kobo.20.1">$ aws ec2 create-vpc --cidr-block 10.0.0.0/16</span></strong><br/><strong><span class="koboSpan" id="kobo.21.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.22.1">    "Vpc": {</span></strong><br/><strong><span class="koboSpan" id="kobo.23.1">        "CidrBlock": "10.0.0.0/16",</span></strong><br/><strong><span class="koboSpan" id="kobo.24.1">        "DhcpOptionsId": "dopt-3d901958",</span></strong><br/><strong><span class="koboSpan" id="kobo.25.1">        "State": "pending",</span></strong><br/><strong><span class="koboSpan" id="kobo.26.1">        "VpcId": "vpc-0ca37d4650963adbb",</span></strong><br/><strong><span class="koboSpan" id="kobo.27.1">...</span></strong></pre>
<p><span class="koboSpan" id="kobo.28.1">A subnet is a logical network block. </span><span class="koboSpan" id="kobo.28.2">This must belong to one VPC as well as one availability zone, for example, the </span><kbd><span class="koboSpan" id="kobo.29.1">vpc-0ca37d4650963adbb</span></kbd> <span><span class="koboSpan" id="kobo.30.1">VPC </span></span><span class="koboSpan" id="kobo.31.1">and </span><kbd><span class="koboSpan" id="kobo.32.1">us-east-1b</span></kbd><span class="koboSpan" id="kobo.33.1">. </span><span class="koboSpan" id="kobo.33.2">Then, the network CIDR must be within the VPC's CIDR. </span><span class="koboSpan" id="kobo.33.3">For example, if the VPC CIDR is </span><kbd><span class="koboSpan" id="kobo.34.1">10.0.0.0/16</span></kbd><span class="koboSpan" id="kobo.35.1"> (</span><kbd><span class="koboSpan" id="kobo.36.1">10.0.0.0</span></kbd><span class="koboSpan" id="kobo.37.1">–</span><kbd><span class="koboSpan" id="kobo.38.1">10.0.255.255</span></kbd><span class="koboSpan" id="kobo.39.1">), then one subnet CIDR could be </span><kbd><span class="koboSpan" id="kobo.40.1">10.0.1.0/24</span></kbd><span class="koboSpan" id="kobo.41.1"> (</span><kbd><span class="koboSpan" id="kobo.42.1">10.0.1.0</span></kbd><span class="koboSpan" id="kobo.43.1">–</span><kbd><span class="koboSpan" id="kobo.44.1">10.0.1.255</span></kbd><span class="koboSpan" id="kobo.45.1">).</span></p>
<p><span class="koboSpan" id="kobo.46.1">In the following example, we'll create two subnets on the </span><kbd><span class="koboSpan" id="kobo.47.1">us-east-1a</span></kbd><span class="koboSpan" id="kobo.48.1"> availability zone and another two subnets on the </span><kbd><span class="koboSpan" id="kobo.49.1">us-east-1b</span></kbd><span class="koboSpan" id="kobo.50.1"> </span><span><span class="koboSpan" id="kobo.51.1">availability</span></span><span class="koboSpan" id="kobo.52.1"> zone. </span><span class="koboSpan" id="kobo.52.2">Therefore, a total of four subnets </span><span><span class="koboSpan" id="kobo.53.1">will be created on </span></span><kbd><span class="koboSpan" id="kobo.54.1">vpc-0ca37d4650963adbb</span></kbd><span class="koboSpan" id="kobo.55.1"> according to the following steps:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.56.1">Create the first subnet, </span><kbd><span class="koboSpan" id="kobo.57.1">10.0.1.0/24</span></kbd><span class="koboSpan" id="kobo.58.1">, on the </span><kbd><span class="koboSpan" id="kobo.59.1">us-east-1a</span></kbd><span class="koboSpan" id="kobo.60.1"> availability zone:</span></li>
</ol>
<pre style="padding-left: 90px"><strong><span class="koboSpan" id="kobo.61.1">$ aws ec2 create-subnet --vpc-id vpc-0ca37d4650963adbb --cidr-block 10.0.1.0/24 --availability-zone us-east-1a</span></strong><br/><strong><span class="koboSpan" id="kobo.62.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.63.1">    "Subnet": {</span></strong><br/><strong><span class="koboSpan" id="kobo.64.1">        "AvailabilityZone": "us-east-1a",</span></strong><br/><strong><span class="koboSpan" id="kobo.65.1">        "AvailabilityZoneId": "use1-az6",</span></strong><br/><strong><span class="koboSpan" id="kobo.66.1">        "AvailableIpAddressCount": 251,</span></strong><br/><strong><span class="koboSpan" id="kobo.67.1">        "CidrBlock": "10.0.1.0/24",</span></strong><br/><strong><span class="koboSpan" id="kobo.68.1">        "DefaultForAz": false,</span></strong><br/><strong><span class="koboSpan" id="kobo.69.1">        "MapPublicIpOnLaunch": false,</span></strong><br/><strong><span class="koboSpan" id="kobo.70.1">        "State": "pending",</span></strong><br/><strong><span class="koboSpan" id="kobo.71.1">        "SubnetId": "subnet-09f8f7f06c27cb0a0",</span></strong><br/><strong><span class="koboSpan" id="kobo.72.1">        "VpcId": "vpc-0ca37d4650963adbb",</span></strong><br/><strong><span class="koboSpan" id="kobo.73.1">...</span></strong></pre>
<ol start="2">
<li><span class="koboSpan" id="kobo.74.1">Create a second subnet, </span><kbd><span class="koboSpan" id="kobo.75.1">10.0.2.0/24</span></kbd><span class="koboSpan" id="kobo.76.1">, on the </span><kbd><span class="koboSpan" id="kobo.77.1">us-east-1b</span></kbd><span class="koboSpan" id="kobo.78.1"> availability zone:</span></li>
</ol>
<pre style="padding-left: 90px"><strong><span class="koboSpan" id="kobo.79.1">$ aws ec2 create-subnet --vpc-id vpc-0ca37d4650963adbb --cidr-block 10.0.2.0/24 --availability-zone us-east-1b</span></strong><br/><strong><span class="koboSpan" id="kobo.80.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.81.1">    "Subnet": {</span></strong><br/><strong><span class="koboSpan" id="kobo.82.1">        "AvailabilityZone": "us-east-1b",</span></strong><br/><strong><span class="koboSpan" id="kobo.83.1">        "AvailabilityZoneId": "use1-az1",</span></strong><br/><strong><span class="koboSpan" id="kobo.84.1">        "AvailableIpAddressCount": 251,</span></strong><br/><strong><span class="koboSpan" id="kobo.85.1">        "CidrBlock": "10.0.2.0/24",</span></strong><br/><strong><span class="koboSpan" id="kobo.86.1">        "DefaultForAz": false,</span></strong><br/><strong><span class="koboSpan" id="kobo.87.1">        "MapPublicIpOnLaunch": false,</span></strong><br/><strong><span class="koboSpan" id="kobo.88.1">        "State": "pending",</span></strong><br/><strong><span class="koboSpan" id="kobo.89.1">        "SubnetId": "subnet-04b78ed9b5f96d76e",</span></strong><br/><strong><span class="koboSpan" id="kobo.90.1">        "VpcId": "vpc-0ca37d4650963adbb",</span></strong><br/><strong><span class="koboSpan" id="kobo.91.1">...</span></strong></pre>
<ol start="3">
<li><span class="koboSpan" id="kobo.92.1">Create a third subnet, </span><kbd><span class="koboSpan" id="kobo.93.1">10.0."3".0/24</span></kbd><span class="koboSpan" id="kobo.94.1">, on </span><kbd><span class="koboSpan" id="kobo.95.1">us-east-1b</span></kbd><span class="koboSpan" id="kobo.96.1"> again:</span></li>
</ol>
<pre style="padding-left: 90px"><strong><span class="koboSpan" id="kobo.97.1">$</span></strong> <strong><span class="koboSpan" id="kobo.98.1">aws ec2 create-subnet --vpc-id vpc-0ca37d4650963adbb --cidr-block 10.0.3.0/24 --availability-zone us-east-1b</span></strong><br/><strong><span class="koboSpan" id="kobo.99.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.100.1">    "Subnet": {</span></strong><br/><strong><span class="koboSpan" id="kobo.101.1">        "AvailabilityZone": "us-east-1b",</span></strong><br/><strong><span class="koboSpan" id="kobo.102.1">        "AvailabilityZoneId": "use1-az1",</span></strong><br/><strong><span class="koboSpan" id="kobo.103.1">        "AvailableIpAddressCount": 251,</span></strong><br/><strong><span class="koboSpan" id="kobo.104.1">        "CidrBlock": "10.0.3.0/24",</span></strong><br/><strong><span class="koboSpan" id="kobo.105.1">        "DefaultForAz": false,</span></strong><br/><strong><span class="koboSpan" id="kobo.106.1">        "MapPublicIpOnLaunch": false,</span></strong><br/><strong><span class="koboSpan" id="kobo.107.1">        "State": "pending",</span></strong><br/><strong><span class="koboSpan" id="kobo.108.1">        "SubnetId": "subnet-026058e32f09c28af",</span></strong><br/><strong><span class="koboSpan" id="kobo.109.1">        "VpcId": "vpc-0ca37d4650963adbb",</span></strong><br/><strong><span class="koboSpan" id="kobo.110.1">...</span><br/></strong></pre>
<ol start="4">
<li><span class="koboSpan" id="kobo.111.1">Create a fourth subnet, </span><kbd><span class="koboSpan" id="kobo.112.1">10.0.4.0/24</span></kbd><span class="koboSpan" id="kobo.113.1">, on </span><kbd><span class="koboSpan" id="kobo.114.1">us-east-1a</span></kbd><span class="koboSpan" id="kobo.115.1"> again:</span></li>
</ol>
<pre style="padding-left: 90px"><strong><span class="koboSpan" id="kobo.116.1">$ aws ec2 create-subnet --vpc-id vpc-0ca37d4650963adbb --cidr-block 10.0.4.0/24 --availability-zone us-east-1a</span><br/><span class="koboSpan" id="kobo.117.1">{</span><br/><span class="koboSpan" id="kobo.118.1">    "Subnet": {</span><br/><span class="koboSpan" id="kobo.119.1">        "AvailabilityZone": "us-east-1a",</span><br/><span class="koboSpan" id="kobo.120.1">        "AvailabilityZoneId": "use1-az6",</span><br/><span class="koboSpan" id="kobo.121.1">        "AvailableIpAddressCount": 251,</span><br/><span class="koboSpan" id="kobo.122.1">        "CidrBlock": "10.0.4.0/24",</span><br/><span class="koboSpan" id="kobo.123.1">        "DefaultForAz": false,</span><br/><span class="koboSpan" id="kobo.124.1">        "MapPublicIpOnLaunch": false,</span><br/><span class="koboSpan" id="kobo.125.1">        "State": "pending",</span><br/><span class="koboSpan" id="kobo.126.1">        "SubnetId": "subnet-08e16157c15cefcbc",</span><br/><span class="koboSpan" id="kobo.127.1">        "VpcId": "vpc-0ca37d4650963adbb",</span><br/><span class="koboSpan" id="kobo.128.1">...</span></strong></pre>
<p><span class="koboSpan" id="kobo.129.1">Let's make the first two subnets public-facing ones and the last two subnets private ones. </span><span class="koboSpan" id="kobo.129.2">This means the public-facing subnet can be accessible from the internet, which allows it to have a public IP address. </span><span class="koboSpan" id="kobo.129.3">On the other hand, the private subnet doesn't have a reachability from the internet. </span><span class="koboSpan" id="kobo.129.4">To do that, you need to set up gateways and routing tables.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Internet gateways and NAT-GW</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">In most cases, your VPC needs to have a connection with the public internet. </span><span class="koboSpan" id="kobo.2.2">In this case, you need to create an </span><strong><span class="koboSpan" id="kobo.3.1">Internet Gateway</span></strong><span class="koboSpan" id="kobo.4.1"> (</span><strong><span class="koboSpan" id="kobo.5.1">IGW</span></strong><span class="koboSpan" id="kobo.6.1">) to attach to your VPC.</span></p>
<p><span class="koboSpan" id="kobo.7.1">In the following example, an IGW is created and attached to </span><kbd><span class="koboSpan" id="kobo.8.1">vpc-0ca37d4650963adbb</span></kbd><span class="koboSpan" id="kobo.9.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.10.1">//create IGW, it returns IGW id as igw-01769bff334dcc035</span><br/><span class="koboSpan" id="kobo.11.1">$ aws ec2 create-internet-gateway</span><br/><span class="koboSpan" id="kobo.12.1">{</span><br/><span class="koboSpan" id="kobo.13.1">    "InternetGateway": {</span><br/><span class="koboSpan" id="kobo.14.1">        "Attachments": [],</span><br/><span class="koboSpan" id="kobo.15.1">        "InternetGatewayId": "igw-01769bff334dcc035",</span><br/><span class="koboSpan" id="kobo.16.1">        "Tags": []</span><br/><span class="koboSpan" id="kobo.17.1">    }</span><br/><span class="koboSpan" id="kobo.18.1">}   </span></strong><br/><strong><span class="koboSpan" id="kobo.19.1"> 
//attach igw-01769bff334dcc035 to vpc-0ca37d4650963adbb</span><br/><span class="koboSpan" id="kobo.20.1">$ aws ec2 attach-internet-gateway --vpc-id vpc-0ca37d4650963adbb --internet-gateway-id igw-01769bff334dcc035</span></strong></pre>
<p><span class="koboSpan" id="kobo.21.1">Once the IGW is attached, set a routing table (default gateway) for a subnet that points to the IGW. </span><span class="koboSpan" id="kobo.21.2">If a default gateway points to an IGW, this subnet is able to have a public IP address and access from/to the internet. </span><span class="koboSpan" id="kobo.21.3">Therefore, if the default gateway doesn't point to IGW, it's determined as a private subnet, which means no public access.</span></p>
<p><span class="koboSpan" id="kobo.22.1">In the following example, a routing table is created that points to IGW and is set to the public subnet:</span></p>
<pre><strong><span class="koboSpan" id="kobo.23.1">//create route table within vpc-0ca37d4650963adbb</span></strong><br/><strong><span class="koboSpan" id="kobo.24.1">//it returns route table id as rtb-0f45fc46edec61d8f</span></strong><br/><strong><span class="koboSpan" id="kobo.25.1">$ aws ec2 create-route-table --vpc-id vpc-0ca37d4650963adbb</span></strong><br/><strong><span class="koboSpan" id="kobo.26.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.27.1">    "RouteTable": {</span></strong><br/><strong><span class="koboSpan" id="kobo.28.1">        "Associations": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.29.1">        "PropagatingVgws": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.30.1">        "RouteTableId": "rtb-0f45fc46edec61d8f",</span></strong><br/><strong><span class="koboSpan" id="kobo.31.1">...</span></strong><br/> <br/><strong><span class="koboSpan" id="kobo.32.1">//then set default route (0.0.0.0/0) as igw-01769bff334dcc035</span><br/><span class="koboSpan" id="kobo.33.1">$ aws ec2 create-route --route-table-id rtb-0f45fc46edec61d8f --gateway-id igw-01769bff334dcc035 --destination-cidr-block 0.0.0.0/0</span><br/> </strong><br/><strong><span class="koboSpan" id="kobo.34.1">//finally, update public 2 subnets to use this route table</span><br/><span class="koboSpan" id="kobo.35.1">$ aws ec2 associate-route-table --route-table-id rtb-0f45fc46edec61d8f --subnet-id subnet-09f8f7f06c27cb0a0</span><br/><br/><span class="koboSpan" id="kobo.36.1">$ aws ec2 associate-route-table --route-table-id rtb-0f45fc46edec61d8f --subnet-id subnet-026058e32f09c28af</span><br/>   </strong><br/><strong><span class="koboSpan" id="kobo.37.1"> 
//public subnet can assign public IP when launch EC2
$ aws ec2 modify-subnet-attribute --subnet-id subnet-09f8f7f06c27cb0a0 --map-public-ip-on-launch</span><br/><br/><span class="koboSpan" id="kobo.38.1">$ aws ec2 modify-subnet-attribute --subnet-id subnet-026058e32f09c28af --map-public-ip-on-launch  </span></strong></pre>
<p><span class="koboSpan" id="kobo.39.1">On the other hand, the private subnet doesn't need a public IP address. </span><span class="koboSpan" id="kobo.39.2">However, a private subnet sometimes needs to access the internet, for example, to download some packages and access the AWS service. </span><span class="koboSpan" id="kobo.39.3">In this case, we still have an option to connect to the internet. This is called a </span><strong><span class="koboSpan" id="kobo.40.1">Network Address Translation Gateway</span></strong><span class="koboSpan" id="kobo.41.1"> (</span><strong><span class="koboSpan" id="kobo.42.1">NAT-GW</span></strong><span class="koboSpan" id="kobo.43.1">).</span></p>
<p><span class="koboSpan" id="kobo.44.1">A NAT-GW allows private subnets to access the public internet through the NAT-GW. </span><span class="koboSpan" id="kobo.44.2">Consequently, the NAT-GW must be located at a public subnet, and the private subnet routing table points to the NAT-GW as a default gateway. </span><span class="koboSpan" id="kobo.44.3">Note that in order to access a NAT-GW on the public network, it needs an </span><strong><span class="koboSpan" id="kobo.45.1">Elastic IP</span></strong><span class="koboSpan" id="kobo.46.1"> (</span><strong><span class="koboSpan" id="kobo.47.1">EIP</span></strong><span class="koboSpan" id="kobo.48.1">) attached to the NAT-GW.</span></p>
<p><span class="koboSpan" id="kobo.49.1">In the following example, a NAT-GW is created:</span></p>
<pre><strong><span class="koboSpan" id="kobo.50.1">//allocate EIP, it returns allocation id as eipalloc-044f4dbafe870a04a
$ aws ec2 allocate-address</span><br/><span class="koboSpan" id="kobo.51.1">{</span><br/><span class="koboSpan" id="kobo.52.1">    "PublicIp": "54.161.228.168",</span><br/><span class="koboSpan" id="kobo.53.1">    "AllocationId": "eipalloc-044f4dbafe870a04a",</span><br/><span class="koboSpan" id="kobo.54.1">    "PublicIpv4Pool": "amazon",</span><br/><span class="koboSpan" id="kobo.55.1">    "Domain": "vpc"</span><br/><span class="koboSpan" id="kobo.56.1">}</span><br/></strong><strong><br/><span class="koboSpan" id="kobo.57.1">      
//create NAT-GW on public subnet (subnet-09f8f7f06c27cb0a0)
//also assign EIP eipalloc-044f4dbafe870a04a
$ aws ec2 create-nat-gateway --subnet-id subnet-09f8f7f06c27cb0a0 --allocation-id eipalloc-044f4dbafe870a04a</span><br/><span class="koboSpan" id="kobo.58.1">{</span><br/><span class="koboSpan" id="kobo.59.1">    "NatGateway": {</span><br/><span class="koboSpan" id="kobo.60.1">        "CreateTime": "2018-12-09T20:17:33.000Z",</span><br/><span class="koboSpan" id="kobo.61.1">        "NatGatewayAddresses": [</span><br/><span class="koboSpan" id="kobo.62.1">            {</span><br/><span class="koboSpan" id="kobo.63.1">                "AllocationId": "eipalloc-044f4dbafe870a04a"</span><br/><span class="koboSpan" id="kobo.64.1">            }</span><br/><span class="koboSpan" id="kobo.65.1">        ],</span><br/><span class="koboSpan" id="kobo.66.1">        "NatGatewayId": "nat-05e34091f53f10172",</span><br/><span class="koboSpan" id="kobo.67.1">        "State": "pending",</span><br/><span class="koboSpan" id="kobo.68.1">        "SubnetId": "subnet-09f8f7f06c27cb0a0",</span><br/><span class="koboSpan" id="kobo.69.1">        "VpcId": "vpc-0ca37d4650963adbb"</span><br/><span class="koboSpan" id="kobo.70.1">    }</span><br/><span class="koboSpan" id="kobo.71.1">}</span><br/></strong></pre>
<div class="packt_tip"><span class="koboSpan" id="kobo.72.1">Unlike an IGW, you can deploy a NAT-GW on single </span><strong><span class="koboSpan" id="kobo.73.1">Availability Zone</span></strong><span class="koboSpan" id="kobo.74.1"> (</span><strong><span class="koboSpan" id="kobo.75.1">AZ</span></strong><span class="koboSpan" id="kobo.76.1">). </span><span class="koboSpan" id="kobo.76.2">If you need a high availability NAT-GW, you need to deploy a NAT-GW on each AZ. However, AWS charges you an additional hourly cost for an Elastic IP and NAT-GW. </span><span class="koboSpan" id="kobo.76.3">Therefore, if you wish to save costs, launch a single NAT-GW on a single AZ, as in the preceding example.</span></div>
<p><span class="koboSpan" id="kobo.77.1">Creating a NAT-GW takes a few minutes. </span><span class="koboSpan" id="kobo.77.2">Once it's created, update a private subnet routing table that points to the NAT-GW, and then any EC2 instances are able to access the internet; again, however, due to no public IP address on the private subnet, there's no chance of access from the public internet to the private subnet EC2 instances.</span></p>
<p><span class="koboSpan" id="kobo.78.1">In the following example, an update routing table for the private subnet points to a NAT-GW as the default gateway:</span></p>
<pre><strong><span class="koboSpan" id="kobo.79.1">//as same as public route, need to create a route table first
$ aws ec2 create-route-table --vpc-id vpc-0ca37d4650963adbb</span><br/><span class="koboSpan" id="kobo.80.1">{</span><br/><span class="koboSpan" id="kobo.81.1">    "RouteTable": {</span><br/><span class="koboSpan" id="kobo.82.1">        "Associations": [],</span><br/><span class="koboSpan" id="kobo.83.1">        "PropagatingVgws": [],</span><br/><span class="koboSpan" id="kobo.84.1">        "RouteTableId": "rtb-08572c332e7e4f14e",</span><br/><span class="koboSpan" id="kobo.85.1">...</span><br/>   </strong><br/> <strong><span class="koboSpan" id="kobo.86.1">//then assign default gateway as NAT-GW
$ aws ec2 create-route --route-table-id rtb-08572c332e7e4f14e --nat-gateway-id nat-05e34091f53f10172 --destination-cidr-block 0.0.0.0/0</span><br/><br/><span class="koboSpan" id="kobo.87.1">   //finally update private subnet routing table
$ aws ec2 associate-route-table --route-table-id rtb-08572c332e7e4f14e --subnet-id subnet-04b78ed9b5f96d76e</span><br/><br/><span class="koboSpan" id="kobo.88.1">$ aws ec2 associate-route-table --route-table-id rtb-08572c332e7e4f14e --subnet-id subnet-08e16157c15cefcbc</span><br/></strong></pre>
<p><span class="koboSpan" id="kobo.89.1">Overall, there are four subnets that have been configured as two public subnets and two private subnets. </span><span class="koboSpan" id="kobo.89.2">Each subnet has a default route to use IGW and NAT-GW as follows. </span><span class="koboSpan" id="kobo.89.3">Note that the ID varies because AWS assigns a unique identifier:</span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td>
<p class="CDPAlignCenter CDPAlign"><strong><span class="koboSpan" id="kobo.90.1">Types of subnet</span></strong></p>
</td>
<td class="CDPAlignCenter CDPAlign"><strong><span class="koboSpan" id="kobo.91.1">CIDR block</span></strong></td>
<td class="CDPAlignCenter CDPAlign"><strong><span class="koboSpan" id="kobo.92.1">Availability zone</span></strong></td>
<td class="CDPAlignCenter CDPAlign"><strong><span class="koboSpan" id="kobo.93.1">Subnet ID</span></strong></td>
<td class="CDPAlignCenter CDPAlign"><strong><span class="koboSpan" id="kobo.94.1">Route table ID</span></strong></td>
<td class="CDPAlignCenter CDPAlign"><strong><span class="koboSpan" id="kobo.95.1">Default gateway</span></strong></td>
<td class="CDPAlignCenter CDPAlign"><strong><span class="koboSpan" id="kobo.96.1">Assign Public IP while EC2 launches</span></strong></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.97.1">Public</span></td>
<td><span class="koboSpan" id="kobo.98.1">10.0.1.0/24</span></td>
<td><span class="koboSpan" id="kobo.99.1">us-east-1a</span></td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.100.1">subnet-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.101.1">09f8f7f06c27cb0a0</span></kbd></p>
</td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.102.1">rtb-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.103.1">0f45fc46edec61d8f</span></kbd></p>
</td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.104.1">igw-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.105.1">01769bff334dcc035</span></kbd><span class="koboSpan" id="kobo.106.1"> </span></p>
<p class="mce-root"><span class="koboSpan" id="kobo.107.1">(IGW)</span></p>
</td>
<td><span class="koboSpan" id="kobo.108.1">Yes</span></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.109.1">Private</span></td>
<td><span class="koboSpan" id="kobo.110.1">10.0.2.0/24</span></td>
<td><span class="koboSpan" id="kobo.111.1">us-east-1b</span></td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.112.1">subnet-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.113.1">04b78ed9b5f96d76e</span></kbd></p>
</td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.114.1">rtb-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.115.1">08572c332e7e4f14e</span></kbd></p>
</td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.116.1">nat-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.117.1">05e34091f53f10172</span></kbd><span class="koboSpan" id="kobo.118.1"> </span></p>
<p class="mce-root"><span class="koboSpan" id="kobo.119.1">(NAT-GW)</span></p>
</td>
<td><span class="koboSpan" id="kobo.120.1">No (default)</span></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.121.1">Public</span></td>
<td><span class="koboSpan" id="kobo.122.1">10.0.3.0/24</span></td>
<td><span class="koboSpan" id="kobo.123.1">us-east-1b</span></td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.124.1">subnet-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.125.1">026058e32f09c28af</span></kbd></p>
</td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.126.1">rtb-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.127.1">0f45fc46edec61d8f</span></kbd></p>
</td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.128.1">igw-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.129.1">01769bff334dcc035</span></kbd><span class="koboSpan" id="kobo.130.1"> </span></p>
<p class="mce-root"><span class="koboSpan" id="kobo.131.1">(IGW)</span></p>
</td>
<td><span class="koboSpan" id="kobo.132.1">Yes</span></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.133.1">Private</span></td>
<td><span class="koboSpan" id="kobo.134.1">10.0.4.0/24</span></td>
<td><span class="koboSpan" id="kobo.135.1">us-east-1a</span></td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.136.1">subnet-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.137.1">08e16157c15cefcbc</span></kbd></p>
</td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.138.1">rtb-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.139.1">08572c332e7e4f14e</span></kbd></p>
</td>
<td>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.140.1">nat-</span></kbd></p>
<p class="mce-root"><kbd><span class="koboSpan" id="kobo.141.1">05e34091f53f10172</span></kbd><span class="koboSpan" id="kobo.142.1"> </span></p>
<p class="mce-root"><span class="koboSpan" id="kobo.143.1">(NAT-GW)</span></p>
</td>
<td><span class="koboSpan" id="kobo.144.1">No (default)</span></td>
</tr>
</tbody>
</table>
<div class="packt_tip"><span class="koboSpan" id="kobo.145.1">Technically, you can still assign a public IP to a private subnet EC2 instance, but there's no default gateway to the internet (IGW). </span><span class="koboSpan" id="kobo.145.2">Therefore, a public IP will just be wasted and it won't have connectivity from the internet.</span></div>
<p><span class="koboSpan" id="kobo.146.1">Now if you launch an EC2 instance on the public subnet, it becomes public facing, so you can serve your application from this subnet.</span></p>
<p><span class="koboSpan" id="kobo.147.1">On the other hand, if you launch an EC2 instance on the private subnet, it can still access the internet through the NAT-GW, but there will be no access from the internet. </span><span class="koboSpan" id="kobo.147.2">However, it can still access it from the EC2 host on the public subnet. </span><span class="koboSpan" id="kobo.147.3">So, ideally, you can deploy internal services such as databases, middleware, and monitoring tools on the private subnet.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Security group</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Once VPC and subnets with related gateways/routes are ready, you can create EC2 instances. </span><span class="koboSpan" id="kobo.2.2">However, at least one access control needs to be created beforehand; this is called a </span><strong><span class="koboSpan" id="kobo.3.1">security group</span></strong><span class="koboSpan" id="kobo.4.1">. </span><span class="koboSpan" id="kobo.4.2">It can define ingress (incoming network access) and egress (outgoing network access) firewall rules.</span></p>
<p><span class="koboSpan" id="kobo.5.1">In the following example, a security group and a rule for </span><kbd><span class="koboSpan" id="kobo.6.1">public</span></kbd><span class="koboSpan" id="kobo.7.1"> subnet hosts are created that allows SSH from your machine's IP address, as well as open HTTP (</span><kbd><span class="koboSpan" id="kobo.8.1">80/tcp</span></kbd><span class="koboSpan" id="kobo.9.1">) world-wide:</span></p>
<pre><strong><span class="koboSpan" id="kobo.10.1">//create one security group for public subnet
$ aws ec2 create-security-group --vpc-id vpc-0ca37d4650963adbb --group-name public --description "public facing host"</span><br/><span class="koboSpan" id="kobo.11.1">{</span><br/><span class="koboSpan" id="kobo.12.1">    "GroupId": "sg-03973d9109a19e592"</span><br/><span class="koboSpan" id="kobo.13.1">}
 </span></strong><br/><strong><span class="koboSpan" id="kobo.14.1">   
//check your machine's public IP (if not sure, use 0.0.0.0/0 as temporary)
$ curl ifconfig.co
98.234.106.21
 </span></strong><br/><strong><span class="koboSpan" id="kobo.15.1">   
//public facing machine allows ssh only from your machine
$ aws ec2 authorize-security-group-ingress --group-id sg-03973d9109a19e592 --protocol tcp --port 22 --cidr 98.234.106.21/32</span><br/><span class="koboSpan" id="kobo.16.1">    
//public facing machine allow HTTP access from any host (0.0.0.0/0)
$ aws ec2 authorize-security-group-ingress --group-id sg-03973d9109a19e592 --protocol tcp --port 80 --cidr 0.0.0.0/0</span><br/>  </strong></pre>
<p><span class="koboSpan" id="kobo.17.1">Next, create a security group for a </span><kbd><span class="koboSpan" id="kobo.18.1">private</span></kbd><span class="koboSpan" id="kobo.19.1"> subnet host that allows SSH from the </span><kbd><span class="koboSpan" id="kobo.20.1">public</span></kbd><span class="koboSpan" id="kobo.21.1"> subnet host. </span><span class="koboSpan" id="kobo.21.2">In this case, specifying a public subnet security group ID (</span><kbd><span class="koboSpan" id="kobo.22.1">sg-03973d9109a19e592</span></kbd><span class="koboSpan" id="kobo.23.1">) instead of a CIDR block is convenient:</span></p>
<pre><strong><span class="koboSpan" id="kobo.24.1">//create security group for private subnet
$ aws ec2 create-security-group --vpc-id vpc-0ca37d4650963adbb --group-name private --description "private subnet host"</span><br/><span class="koboSpan" id="kobo.25.1">{</span><br/><span class="koboSpan" id="kobo.26.1">    "GroupId": "sg-0f4058a729e2c207e"</span><br/><span class="koboSpan" id="kobo.27.1">}</span><br/><br/><br/></strong><strong><span class="koboSpan" id="kobo.28.1">//private subnet allows ssh only from public subnet host security group
$ aws ec2 authorize-security-group-ingress --group-id sg-0f4058a729e2c207e --protocol tcp --port 22 --source-group sg-03973d9109a19e592 </span><br/><br/><br/><span class="koboSpan" id="kobo.29.1">//it also allows HTTP (80/TCP) from public subnet security group</span><br/><span class="koboSpan" id="kobo.30.1">$ aws ec2 authorize-security-group-ingress --group-id sg-0f4058a729e2c207e --protocol tcp --port 80 --source-group sg-03973d9109a19e592 </span></strong></pre>
<div class="packt_tip"><span><span class="koboSpan" id="kobo.31.1">When you define a security group for a </span></span><span class="koboSpan" id="kobo.32.1">public</span><span><span class="koboSpan" id="kobo.33.1"> subnet, it's highly recommended that it's reviewed by a security expert. </span><span class="koboSpan" id="kobo.33.2">This is because, once you deploy an EC2 instance onto the public subnet, it has a public IP address and then everyone including crackers and bots </span></span><span class="koboSpan" id="kobo.34.1">are</span><span><span class="koboSpan" id="kobo.35.1"> able to access your instances directly.</span></span></div>
<p><span class="koboSpan" id="kobo.36.1">Overall, there are two security groups that have been created, as follows:</span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td>
<p><strong><span class="koboSpan" id="kobo.37.1">Name</span></strong></p>
</td>
<td>
<p><strong><span class="koboSpan" id="kobo.38.1">Security group ID</span></strong></p>
</td>
<td>
<p><strong><span class="koboSpan" id="kobo.39.1">Allow ssh (22/TCP)</span></strong></p>
</td>
<td>
<p><strong><span class="koboSpan" id="kobo.40.1">Allow HTTP (80/TCP)</span></strong></p>
</td>
</tr>
<tr>
<td>
<p><span class="koboSpan" id="kobo.41.1">Public</span></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.42.1">sg-03973d9109a19e592</span></kbd></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.43.1">Your machine </span><kbd><span class="koboSpan" id="kobo.44.1">(98.234.106.21)</span></kbd></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.45.1">0.0.0.0/0</span></kbd></p>
</td>
</tr>
<tr>
<td>
<p><span class="koboSpan" id="kobo.46.1">Private</span></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.47.1">sg-0f4058a729e2c207e</span></kbd></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.48.1">public sg (sg-03973d9109a19e592)</span></kbd></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.49.1">public sg (sg-03973d9109a19e592)</span></kbd></p>
</td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">EC2 and EBS</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">EC2 is one important service in AWS that you can use to launch a VM on your VPC. </span><span class="koboSpan" id="kobo.2.2">Based on hardware spec (CPU, memory, and network), there are several types of EC2 instances that are available on AWS. </span><span class="koboSpan" id="kobo.2.3">When you launch an EC2 instance, you need to specify VPC, subnet, security group, and SSH keypair. </span><span class="koboSpan" id="kobo.2.4">Consequently, all of these must be created beforehand.</span></p>
<p><span class="koboSpan" id="kobo.3.1">Because of previous examples, the only last step is </span><kbd><span class="koboSpan" id="kobo.4.1">ssh-keypair</span></kbd><span class="koboSpan" id="kobo.5.1">. </span><span class="koboSpan" id="kobo.5.2">Let's make </span><kbd><span class="koboSpan" id="kobo.6.1">ssh-keypair</span></kbd><span class="koboSpan" id="kobo.7.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.8.1">//create keypair (aws_rsa, aws_rsa.pub)
$ ssh-keygen -f ~/.ssh/aws_rsa -N ""</span><br/> </strong><strong><span class="koboSpan" id="kobo.9.1">
//register aws_rsa.pub key to AWS
$ aws ec2 import-key-pair --key-name=my-key --public-key-material "`cat ~/.ssh/aws_rsa.pub`"</span><br/><span class="koboSpan" id="kobo.10.1">{</span><br/><span class="koboSpan" id="kobo.11.1">    "KeyFingerprint": "73:89:80:1f:cc:25:94:7a:ba:f4:b0:81:ae:d8:bb:92",</span><br/><span class="koboSpan" id="kobo.12.1">    "KeyName": "my-key"</span><br/><span class="koboSpan" id="kobo.13.1">}</span></strong><strong> </strong><br/><br/><strong><span class="koboSpan" id="kobo.14.1">//launch public facing host, using Amazon Linux (ami-009d6802948d06e52) on us-east-1
$ aws ec2 run-instances --image-id ami-009d6802948d06e52 --instance-type t2.nano --key-name my-key --security-group-ids sg-03973d9109a19e592 --subnet-id subnet-09f8f7f06c27cb0a0</span><br/></strong><strong><span class="koboSpan" id="kobo.15.1">
//launch private subnet host
$ aws ec2 run-instances --image-id ami-009d6802948d06e52 --instance-type t2.nano --key-name my-key --security-group-ids sg-0f4058a729e2c207e --subnet-id subnet-04b78ed9b5f96d76e  </span></strong></pre>
<p><span class="koboSpan" id="kobo.16.1">After a few minutes, check the EC2 instance's status on the AWS web console; this shows a </span><kbd><span class="koboSpan" id="kobo.17.1">public</span></kbd><span class="koboSpan" id="kobo.18.1"> subnet host that has a public IP address. </span><span class="koboSpan" id="kobo.18.2">On the other hand, a private subnet host doesn't have a public IP address:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.19.1"><img class=" image-border" src="assets/2fe63571-abd1-42bd-bc2e-a14fe5cf10cd.png"/></span></div>
<p><span class="koboSpan" id="kobo.20.1">Let's use your SSH private key to log in to the EC2 instance using the IPv4 public IP address, as follows:</span></p>
<pre><strong><span class="koboSpan" id="kobo.21.1">//add private keys to ssh-agent
$ ssh-add ~/.ssh/aws_rsa</span><br/><br/><span class="koboSpan" id="kobo.22.1">    
//ssh to the public subnet host with -A (forward ssh-agent) option
$ ssh -A ec2-user@54.208.77.168
...</span><br/><br/><span class="koboSpan" id="kobo.23.1">       __| __|_ )</span><br/><span class="koboSpan" id="kobo.24.1">       _| ( / Amazon Linux 2 AMI</span><br/><span class="koboSpan" id="kobo.25.1">      ___|\___|___|</span><br/><br/><span class="koboSpan" id="kobo.26.1">https://aws.amazon.com/amazon-linux-2/</span><br/><span class="koboSpan" id="kobo.27.1">1 package(s) needed for security, out of 5 available</span><br/><span class="koboSpan" id="kobo.28.1">Run "sudo yum update" to apply all updates.</span><br/><span class="koboSpan" id="kobo.29.1">[ec2-user@ip-10-0-1-41 ~]$</span><br/></strong></pre>
<p><span class="koboSpan" id="kobo.30.1">Now you're in the public subnet host (</span><kbd><span class="koboSpan" id="kobo.31.1">54.208.77.168</span></kbd><span class="koboSpan" id="kobo.32.1">), but this host also has an internal (private) IP address because it's deployed in the </span><kbd><span class="koboSpan" id="kobo.33.1">10.0.1.0/24</span></kbd><span class="koboSpan" id="kobo.34.1"> subnet, therefore the private address range must be </span><kbd><span class="koboSpan" id="kobo.35.1">10.0.1.1</span></kbd><span class="koboSpan" id="kobo.36.1">—</span><kbd><span class="koboSpan" id="kobo.37.1">10.0.1.254</span></kbd><span class="koboSpan" id="kobo.38.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.39.1">[ec2-user@ip-10-0-1-41 ~]$ ifconfig eth0</span></strong><br/><strong><span class="koboSpan" id="kobo.40.1">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 9001</span></strong><br/><strong><span class="koboSpan" id="kobo.41.1">        inet 10.0.1.41 netmask 255.255.255.0 broadcast 10.0.1.255</span></strong><br/><strong><span class="koboSpan" id="kobo.42.1">        inet6 fe80::cf1:1ff:fe9f:c7b2 prefixlen 64 scopeid 0x20&lt;link&gt;</span></strong><br/><strong><span class="koboSpan" id="kobo.43.1">...</span></strong></pre>
<p><span class="koboSpan" id="kobo.44.1">Let's install the </span><kbd><span class="koboSpan" id="kobo.45.1">nginx</span></kbd><span class="koboSpan" id="kobo.46.1"> web server on the public host as follows:</span></p>
<pre><strong><span class="koboSpan" id="kobo.47.1">$ amazon-linux-extras |grep nginx</span></strong><br/><strong><span class="koboSpan" id="kobo.48.1">  4 nginx1.12 available [ =1.12.2 ]</span></strong><br/><strong><span class="koboSpan" id="kobo.49.1">$ sudo amazon-linux-extras install nginx1.12</span></strong><br/><strong><span class="koboSpan" id="kobo.50.1">$ sudo systemctl start nginx</span></strong></pre>
<p><span class="koboSpan" id="kobo.51.1">Then, go back to your machine and check the website for </span><kbd><span class="koboSpan" id="kobo.52.1">54.208.77.168</span></kbd><span class="koboSpan" id="kobo.53.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.54.1">[ec2-user@ip-10-0-1-41 ~]$ exit</span><br/><span class="koboSpan" id="kobo.55.1">logout</span><br/><span class="koboSpan" id="kobo.56.1">Connection to 54.208.77.168 closed.</span><br/><br/><span class="koboSpan" id="kobo.57.1">$ curl -I 54.208.77.168</span><br/><span class="koboSpan" id="kobo.58.1">HTTP/1.1 200 OK</span><br/><span class="koboSpan" id="kobo.59.1">Server: nginx/1.12.2</span><br/><span class="koboSpan" id="kobo.60.1">... </span></strong> </pre>
<p><span class="koboSpan" id="kobo.61.1">In addition, within the same VPC, there's reachability for other availability zones; therefore, you can SSH from the EC2 host on the public subnet to the private subnet host (</span><kbd><span class="koboSpan" id="kobo.62.1">10.0.2.116</span></kbd><span class="koboSpan" id="kobo.63.1">). </span><span class="koboSpan" id="kobo.63.2">Note that we're using the </span><kbd><span class="koboSpan" id="kobo.64.1">ssh -A</span></kbd><span class="koboSpan" id="kobo.65.1"> option that forwards </span><kbd><span class="koboSpan" id="kobo.66.1">ssh-agent</span></kbd><span class="koboSpan" id="kobo.67.1">, so there's no need to create a </span><kbd><span class="koboSpan" id="kobo.68.1">~/.ssh/id_rsa</span></kbd><span class="koboSpan" id="kobo.69.1"> file on the EC2 host:</span></p>
<pre><strong><span class="koboSpan" id="kobo.70.1">[ec2-user@ip-10-0-1-41 ~]$ ssh 10.0.2.116</span><br/><span class="koboSpan" id="kobo.71.1">...</span><br/><br/><span class="koboSpan" id="kobo.72.1">       __| __|_ )</span><br/><span class="koboSpan" id="kobo.73.1">       _| ( / Amazon Linux 2 AMI</span><br/><span class="koboSpan" id="kobo.74.1">      ___|\___|___|</span><br/><br/><span class="koboSpan" id="kobo.75.1">https://aws.amazon.com/amazon-linux-2/</span><br/><span class="koboSpan" id="kobo.76.1">1 package(s) needed for security, out of 5 available</span><br/><span class="koboSpan" id="kobo.77.1">Run "sudo yum update" to apply all updates.</span><br/><span class="koboSpan" id="kobo.78.1">[ec2-user@ip-10-0-2-116 ~]$  </span></strong></pre>
<p><span class="koboSpan" id="kobo.79.1">In addition to EC2, there's another important functionality named disk management. </span><span class="koboSpan" id="kobo.79.2">AWS provides a flexible disk management service called </span><strong><span class="koboSpan" id="kobo.80.1">Elastic Block Store</span></strong><span class="koboSpan" id="kobo.81.1"> (</span><strong><span class="koboSpan" id="kobo.82.1">EBS</span></strong><span class="koboSpan" id="kobo.83.1">). </span><span class="koboSpan" id="kobo.83.2">You may create one or more persistent data storage that can attach to an EC2 instance. </span><span class="koboSpan" id="kobo.83.3">From an EC2 point of view, EBS is one of HDD/SSD. </span><span class="koboSpan" id="kobo.83.4">Once you terminate (delete) an EC2 instance, EBS and its contents may remain and then reattach to another EC2 instance.</span></p>
<p><span class="koboSpan" id="kobo.84.1">In the following example, one volume that has 40 GB capacity is created and then attached to a public subnet host (instance ID, </span><kbd><span class="koboSpan" id="kobo.85.1">i-0f2750f65dd857e54</span></kbd><span class="koboSpan" id="kobo.86.1">):</span></p>
<pre><strong><span class="koboSpan" id="kobo.87.1">//create 40GB disk at us-east-1a (as same as EC2 public subnet instance)
$ aws ec2 create-volume --availability-zone us-east-1a --size 40 --volume-type standard </span><br/><span class="koboSpan" id="kobo.88.1">{</span><br/><span class="koboSpan" id="kobo.89.1">    "CreateTime": "2018-12-09T22:13:41.000Z",</span><br/><span class="koboSpan" id="kobo.90.1">    "VolumeType": "standard",</span><br/><span class="koboSpan" id="kobo.91.1">    "SnapshotId": "",</span><br/><span class="koboSpan" id="kobo.92.1">    "VolumeId": "vol-006aada6fa87c0060",</span><br/><span class="koboSpan" id="kobo.93.1">    "AvailabilityZone": "us-east-1a",</span><br/><span class="koboSpan" id="kobo.94.1">    "Size": 40,</span><br/><span class="koboSpan" id="kobo.95.1">    "State": "creating",</span><br/><span class="koboSpan" id="kobo.96.1">    "Encrypted": false</span><br/><span class="koboSpan" id="kobo.97.1">}
 </span></strong><br/><span class="koboSpan" id="kobo.98.1">   
//attach to public subnet host as /dev/xvdh</span><strong><span class="koboSpan" id="kobo.99.1">
$ aws ec2 attach-volume --device xvdh --instance-id i-0f2750f65dd857e54 --volume-id vol-006aada6fa87c0060</span><br/><span class="koboSpan" id="kobo.100.1">{</span><br/><span class="koboSpan" id="kobo.101.1">    "State": "attaching",</span><br/><span class="koboSpan" id="kobo.102.1">    "InstanceId": "i-0f2750f65dd857e54",</span><br/><span class="koboSpan" id="kobo.103.1">    "AttachTime": "2018-12-09T22:15:32.134Z",</span><br/><span class="koboSpan" id="kobo.104.1">    "VolumeId": "vol-006aada6fa87c0060",</span><br/><span class="koboSpan" id="kobo.105.1">    "Device": "xvdh"</span><br/><span class="koboSpan" id="kobo.106.1">}</span><br/></strong></pre>
<p><span class="koboSpan" id="kobo.107.1">After attaching the EBS volume to the EC2 instance, the Linux kernel recognizes </span><kbd><span class="koboSpan" id="kobo.108.1">/dev/xvdh</span></kbd><span class="koboSpan" id="kobo.109.1"> as specified, and then you need to do partitioning in order to use this device, as follows:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.110.1"><img src="assets/455be1b3-53f8-42c3-ac89-885db824cd05.png" style="width:41.67em;height:48.58em;"/></span></p>
<p><span class="koboSpan" id="kobo.111.1">In this example, we made one partition as </span><kbd><span class="koboSpan" id="kobo.112.1">/dev/xvdh1</span></kbd><span class="koboSpan" id="kobo.113.1">, so you can create a filesystem in </span><kbd><span class="koboSpan" id="kobo.114.1">ext4</span></kbd><span class="koboSpan" id="kobo.115.1"> format on </span><kbd><span class="koboSpan" id="kobo.116.1">/dev/xvdh1</span></kbd><span class="koboSpan" id="kobo.117.1"> and then you can mount to use this device on an EC2 instance:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.118.1"><img src="assets/99c77560-f363-4c26-b0ec-f5ff734a8252.png" style="width:39.50em;height:29.33em;"/></span></div>
<p><span class="koboSpan" id="kobo.119.1">After unmounting the volume, you are free to detach this volume and then re-attach it whenever needed:</span></p>
<pre><strong><span class="koboSpan" id="kobo.120.1">$ aws ec2 detach-volume --volume-id vol-006aada6fa87c0060</span></strong><br/><strong><span class="koboSpan" id="kobo.121.1">{ </span></strong><br/><strong><span class="koboSpan" id="kobo.122.1">    "InstanceId": "i-0f2750f65dd857e54",</span></strong><br/><strong><span class="koboSpan" id="kobo.123.1">    "VolumeId": "vol-006aada6fa87c0060",</span></strong><br/><strong><span class="koboSpan" id="kobo.124.1">    "State": "detaching",</span></strong><br/><strong><span class="koboSpan" id="kobo.125.1">    "Device": "xvdh",</span></strong><br/><strong><span class="koboSpan" id="kobo.126.1">    "AttachTime": "2018-12-09T22:15:32.000Z"</span></strong><br/><strong><span class="koboSpan" id="kobo.127.1">}  </span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">ELB</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">AWS provides a powerful software-based load balancer called </span><strong><span class="koboSpan" id="kobo.3.1">classic load balancer</span></strong><span class="koboSpan" id="kobo.4.1">. </span><span class="koboSpan" id="kobo.4.2">This was known as </span><strong><span class="koboSpan" id="kobo.5.1">Elastic Load Balancer</span></strong><span class="koboSpan" id="kobo.6.1"> (</span><strong><span class="koboSpan" id="kobo.7.1">ELB</span></strong><span class="koboSpan" id="kobo.8.1">), which allows you to load balance network traffic to one or multiple EC2 instances. </span><span class="koboSpan" id="kobo.8.2">In addition, ELB can offload SSL/TLS encryption/decryption and it supports multi-availability zone.</span></p>
<div class="packt_infobox"><span><span class="koboSpan" id="kobo.9.1">So, why is it a classic load balancer in particular</span></span><span class="koboSpan" id="kobo.10.1">? </span><span class="koboSpan" id="kobo.10.2">This is because AWS introduced new types of load balancers: network load balancer (for L4) and application load balancer (for L7). </span><span class="koboSpan" id="kobo.10.3">Therefore, ELB became classic. </span><span class="koboSpan" id="kobo.10.4">However, while ELB is stable and robust, Amazon EKS will use load balancer by default, so we keep using ELB.</span></div>
<p><span class="koboSpan" id="kobo.11.1">In the following example, an ELB is created and associated with a public subnet host, </span><kbd><span class="koboSpan" id="kobo.12.1">nginx</span></kbd><span class="koboSpan" id="kobo.13.1"> (</span><kbd><span class="koboSpan" id="kobo.14.1">80/TCP</span></kbd><span class="koboSpan" id="kobo.15.1">). </span><span class="koboSpan" id="kobo.15.2">Because ELB also needs a security group, create a new one for this, first:</span></p>
<pre><strong><span class="koboSpan" id="kobo.16.1">// Create New Security Group for ELB</span><br/><span class="koboSpan" id="kobo.17.1">$ aws ec2 create-security-group --vpc-id vpc-0ca37d4650963adbb --group-name elb --description "elb sg"</span><br/><span class="koboSpan" id="kobo.18.1">{</span><br/><span class="koboSpan" id="kobo.19.1"> "GroupId": "sg-024f1c5315bac6b9e"</span><br/><span class="koboSpan" id="kobo.20.1">}</span><br/><br/><span class="koboSpan" id="kobo.21.1">// ELB opens TCP port 80 for all IP addresses (0.0.0.0/0)</span><br/><span class="koboSpan" id="kobo.22.1">$ aws ec2 authorize-security-group-ingress --group-id sg-024f1c5315bac6b9e --protocol tcp --port 80 --cidr 0.0.0.0/0</span><br/></strong><br/><strong><br/><span class="koboSpan" id="kobo.23.1">// create ELB on public subnets    
$ aws elb create-load-balancer --load-balancer-name public-elb --listeners Protocol=HTTP,LoadBalancerPort=80,InstanceProtocol=HTTP,InstancePort=80 --subnets subnet-09f8f7f06c27cb0a0 subnet-026058e32f09c28af --security-group sg-024f1c5315bac6b9e</span><br/><span class="koboSpan" id="kobo.24.1">{</span><br/><span class="koboSpan" id="kobo.25.1">    "DNSName": "public-elb-1952792388.us-east-1.elb.amazonaws.com"</span><br/><span class="koboSpan" id="kobo.26.1">}</span><br/><br/><span class="koboSpan" id="kobo.27.1">// Register an EC2 instance which runs nginx
$ aws elb register-instances-with-load-balancer --load-balancer-name public-elb --instances i-0f2750f65dd857e54</span><br/> 
<br/><span class="koboSpan" id="kobo.28.1">// You can access to ELB from your laptop</span><br/><span class="koboSpan" id="kobo.29.1">$ curl -I public-elb-1952792388.us-east-1.elb.amazonaws.com</span><br/><span class="koboSpan" id="kobo.30.1">HTTP/1.1 200 OK</span><br/><span class="koboSpan" id="kobo.31.1">Accept-Ranges: bytes</span><br/><span class="koboSpan" id="kobo.32.1">Content-Length: 3520</span><br/><span class="koboSpan" id="kobo.33.1">Content-Type: text/html</span><br/><span class="koboSpan" id="kobo.34.1">Date: Mon, 17 Dec 2018 06:05:45 GMT</span><br/><span class="koboSpan" id="kobo.35.1">ETag: "5bbfda61-dc0"</span><br/><span class="koboSpan" id="kobo.36.1">Last-Modified: Thu, 11 Oct 2018 23:18:57 GMT</span><br/><span class="koboSpan" id="kobo.37.1">Server: nginx/1.12.2</span><br/><span class="koboSpan" id="kobo.38.1">Connection: keep-alive
... </span></strong> </pre>
<p><span class="koboSpan" id="kobo.39.1">Overall, we've discussed how to configure AWS components. </span><span class="koboSpan" id="kobo.39.2">The following is a summary and diagram about major components and relationships:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.40.1">One VPC that has an </span><strong><span class="koboSpan" id="kobo.41.1">Internet Gateway</span></strong><span class="koboSpan" id="kobo.42.1"> (</span><strong><span class="koboSpan" id="kobo.43.1">IGW</span></strong><span class="koboSpan" id="kobo.44.1">)</span></li>
<li><span class="koboSpan" id="kobo.45.1">Two subnets (public and private) on </span><kbd><span class="koboSpan" id="kobo.46.1">us-east-1a</span></kbd></li>
<li><span class="koboSpan" id="kobo.47.1">Two subnets (public and private) on </span><kbd><span class="koboSpan" id="kobo.48.1">us-east-1b</span></kbd></li>
<li><span class="koboSpan" id="kobo.49.1">One NAT-GW</span></li>
<li><span class="koboSpan" id="kobo.50.1">One public EC2 instance on public subnet with EBS</span></li>
<li><span class="koboSpan" id="kobo.51.1">One private EC2 instance on private subnet</span></li>
<li><span class="koboSpan" id="kobo.52.1">ELB that forwards the traffic to a public EC2 instance</span></li>
</ul>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.53.1"><img class=" image-border" src="assets/842d8b03-f45c-405b-a3ac-e006629cce9d.png" style="width:41.42em;height:27.75em;"/></span></div>
<p class="mce-root"/>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Amazon EKS</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">We've discussed some AWS components that are quite easy for setting up networks, virtual machines, storage, and load balancers. </span><span class="koboSpan" id="kobo.2.2">Consequently, there are a variety of ways to set up Kubernetes on AWS such as kubeadm (</span><a href="https://github.com/kubernetes/kubeadm"><span class="koboSpan" id="kobo.3.1">https://github.com/kubernetes/kubeadm</span></a><span class="koboSpan" id="kobo.4.1">), kops (</span><a href="https://github.com/kubernetes/kops"><span class="koboSpan" id="kobo.5.1">https://github.com/kubernetes/kops</span></a><span class="koboSpan" id="kobo.6.1">), and kubespray (</span><a href="https://github.com/kubernetes-sigs/kubespray"><span class="koboSpan" id="kobo.7.1">https://github.com/kubernetes-sigs/kubespray</span></a><span class="koboSpan" id="kobo.8.1">).</span></p>
<p class="mce-root"><span class="koboSpan" id="kobo.9.1">In addition, since June 2018, AWS starts to provide a new Service, which is called Amazon Elastic Container Service for Kubernetes (</span><a href="https://aws.amazon.com/eks/"><span class="koboSpan" id="kobo.10.1">https://aws.amazon.com/eks/</span></a><span class="koboSpan" id="kobo.11.1">), in short </span><strong><span class="koboSpan" id="kobo.12.1">EKS</span></strong><span class="koboSpan" id="kobo.13.1">. </span><span class="koboSpan" id="kobo.13.2">This is similar to Google Kubernetes Engine (</span><a href="https://cloud.google.com/kubernetes-engine/"><span class="koboSpan" id="kobo.14.1">https://cloud.google.com/kubernetes-engine/</span></a><span class="koboSpan" id="kobo.15.1">) and Azure Kubernetes Service (</span><a href="https://docs.microsoft.com/en-us/azure/aks/"><span class="koboSpan" id="kobo.16.1">https://docs.microsoft.com/en-us/azure/aks/</span></a><span class="koboSpan" id="kobo.17.1">), the managed Kubernetes service.</span></p>
<div class="packt_infobox"><span class="koboSpan" id="kobo.18.1">AWS also provides another container orchestration service that's called Amazon </span><strong><span class="koboSpan" id="kobo.19.1">Elastic Container Service</span></strong><span class="koboSpan" id="kobo.20.1"> (</span><strong><span class="koboSpan" id="kobo.21.1">ECS</span></strong><span class="koboSpan" id="kobo.22.1">) </span><a href="https://aws.amazon.com/ecs/"><span class="koboSpan" id="kobo.23.1">https://aws.amazon.com/ecs/</span></a><span class="koboSpan" id="kobo.24.1">. </span><span class="koboSpan" id="kobo.24.2">AWS ECS isn't a Kubernetes service, but it's fully integrated into AWS components to launch your container application.</span></div>
<p class="mce-root"><span class="koboSpan" id="kobo.25.1">AWS EKS uses AWS components such as VPC, security groups, EC2 instance, EBS, ELB, IAM, and so on, to set up a Kubernetes cluster. </span><span class="koboSpan" id="kobo.25.2">This also manages </span><span><span class="koboSpan" id="kobo.26.1">the</span></span><span><span class="koboSpan" id="kobo.27.1"> Kubernetes cluster that patches and replaces the problematic component 24/7. </span><span class="koboSpan" id="kobo.27.2">As a result of the constant management, the user</span></span><span class="koboSpan" id="kobo.28.1"> will offload the efforts of installation, configuration and monitoring to the Kubenetes cluster, while only needing to pay AWS on an hourly basis.</span></p>
<p class="mce-root"><span class="koboSpan" id="kobo.29.1">It's beneficial for the user that AWS provides a fully tested combination of AWS components and Kubernetes versions. </span><span class="koboSpan" id="kobo.29.2">This means that the user can start to use the production grade of Kubernetes on AWS within minutes.</span></p>
<p class="mce-root"><span class="koboSpan" id="kobo.30.1">Let's explore AWS EKS to learn how AWS integrates Kubernetes into AWS components.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Deep dive into AWS EKS</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">AWS EKS has two main components. </span><span class="koboSpan" id="kobo.2.2">These components are as follows:</span></p>
<ul>
<li class="mce-root"><span class="koboSpan" id="kobo.3.1">Control plane</span></li>
<li class="mce-root"><span class="koboSpan" id="kobo.4.1">Worker nodes</span></li>
</ul>
<p><span class="koboSpan" id="kobo.5.1">Control Plane is the managed Kubernetes master by AWS, which includes an </span><kbd><span class="koboSpan" id="kobo.6.1">etcd</span></kbd><span class="koboSpan" id="kobo.7.1"> database. </span><span class="koboSpan" id="kobo.7.2">AWS helps to deploy the Kubernetes master on multiple availability zones. </span><span class="koboSpan" id="kobo.7.3">A user can monitor and access the control plane via the AWS Web Console or AWS CLI. </span><span class="koboSpan" id="kobo.7.4">As well as this, a user can gain access to Kubernetes API server via Kubernetes clients such as the </span><kbd><span class="koboSpan" id="kobo.8.1">kubectl</span></kbd><span class="koboSpan" id="kobo.9.1"> command.</span></p>
<p><span class="koboSpan" id="kobo.10.1">As of December 2018, AWS only provides a custom </span><strong><span class="koboSpan" id="kobo.11.1">Amazon Machine Images</span></strong><span class="koboSpan" id="kobo.12.1"> (</span><strong><span><span class="koboSpan" id="kobo.13.1">AMI</span></span></strong><span class="koboSpan" id="kobo.14.1">) for worker nodes. </span><span class="koboSpan" id="kobo.14.2">AWS provides neither Web Console nor AWS CLI to create and configure the worker nodes yet. </span><span class="koboSpan" id="kobo.14.3">Therefore, the user needs to use that AMI to launch EC2 instance(s) to configure worker nodes manually.</span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.15.1">Amazon and Weaveworks made an open source project named </span><kbd><span class="koboSpan" id="kobo.16.1">eksctl</span></kbd><span class="koboSpan" id="kobo.17.1"> (</span><a href="https://eksctl.io/"><span class="koboSpan" id="kobo.18.1">https://eksctl.io/</span></a><span class="koboSpan" id="kobo.19.1">). </span><span class="koboSpan" id="kobo.19.2">It's easier to deploy an EKS cluster than AWS CLI and some manual steps.</span><br/><span class="koboSpan" id="kobo.20.1">
If you have difficulty understanding AWS basics and EKS provisioning, it's recommended to use </span><kbd><span class="koboSpan" id="kobo.21.1">eksctl</span></kbd><span class="koboSpan" id="kobo.22.1"> instead.</span></div>
<p><span class="koboSpan" id="kobo.23.1">Fortunately, AWS provides a CloudFormation template that's easy to use to launch and configure worker nodes, so let's extend the previous example of VPC to set up Amazon EKS. </span><span class="koboSpan" id="kobo.23.2">To do that, you need to prepare the following settings beforehand:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.24.1">Set up the IAM Service Role (defines which AWS user can create EKS resources) as follows:</span></li>
</ul>
<pre style="padding-left: 90px" class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.25.1">$ aws iam create-role --role-name eksServiceRole --assume-role-policy-document '{ "Version": "2012-10-17", "Statement": [ { "Effect": "Allow", "Principal": { "Service": "eks.amazonaws.com" }, "Action": "sts:AssumeRole" } ] }'</span><br/></span><span class="s1"><span class="Apple-converted-space"><br/><span class="koboSpan" id="kobo.26.1">$ </span></span><span class="koboSpan" id="kobo.27.1">aws iam attach-role-policy --role-name eksServiceRole --policy-arn arn:aws:iam::aws:policy/AmazonEKSClusterPolicy</span><br/><br/></span><span class="s1"><span class="Apple-converted-space"><span class="koboSpan" id="kobo.28.1">$ </span></span><span class="koboSpan" id="kobo.29.1">aws iam attach-role-policy --role-name eksServiceRole --policy-arn arn:aws:iam::aws:policy/AmazonEKSServicePolicy</span></span></strong></pre>
<ul>
<li><span class="koboSpan" id="kobo.30.1">Set up the security group (assign to </span><kbd><span class="koboSpan" id="kobo.31.1">Control Plane</span></kbd><span class="koboSpan" id="kobo.32.1">, then worker nodes use this security group to allow access from </span><kbd><span class="koboSpan" id="kobo.33.1">Control Plane</span></kbd><span class="koboSpan" id="kobo.34.1">):</span></li>
</ul>
<pre style="padding-left: 90px"><strong><span class="koboSpan" id="kobo.35.1">$ aws ec2 create-security-group --vpc-id vpc-0ca37d4650963adbb --group-name eks-control-plane --description "EKS Control Plane"</span></strong><br/><strong><span class="koboSpan" id="kobo.36.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.37.1"> "GroupId": "sg-0fbac0a39bf64ba10"</span></strong><br/><strong><span class="koboSpan" id="kobo.38.1">}</span></strong></pre>
<ul>
<li><span class="koboSpan" id="kobo.39.1">Tag this to a private subnet (to tell Internal ELB that this is a private subnet):</span></li>
</ul>
<pre style="padding-left: 90px"><strong><span class="koboSpan" id="kobo.40.1">$ aws ec2 create-tags --resources subnet-04b78ed9b5f96d76e --tags Key=kubernetes.io/role/internal-elb,Value=1</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.41.1">$ aws ec2 create-tags --resources subnet-08e16157c15cefcbc --tags Key=kubernetes.io/role/internal-elb,Value=1</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Launching the EKS control plane</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">The EKS control plane is a managed Kubernetes master; you just need to use the AWS CLI to specify your IAM, subnets, and security group. </span><span class="koboSpan" id="kobo.2.2">This example also specifies the Kubernetes version as 1.10:</span></p>
<pre><strong><span class="koboSpan" id="kobo.3.1">// Note: specify all 4 subnets</span></strong><br/><strong><span class="koboSpan" id="kobo.4.1">$ aws eks create-cluster --name chap10 --role-arn arn:aws:iam::xxxxxxxxxxxx:role/eksServiceRole --resources-vpc-config subnetIds=subnet-09f8f7f06c27cb0a0,subnet-04b78ed9b5f96d76e,subnet-026058e32f09c28af,subnet-08e16157c15cefcbc,securityGroupIds=sg-0fbac0a39bf64ba10 --kubernetes-version 1.10</span></strong></pre>
<p><span class="koboSpan" id="kobo.5.1">This takes around 10 minutes to complete. </span><span class="koboSpan" id="kobo.5.2">You can check the status by typing </span><kbd><span class="koboSpan" id="kobo.6.1">aws eks describe-cluster --name chap10</span></kbd><span class="koboSpan" id="kobo.7.1">. </span><span class="koboSpan" id="kobo.7.2">Once your control plane status is </span><kbd><span class="koboSpan" id="kobo.8.1">ACTIVE</span></kbd><span class="koboSpan" id="kobo.9.1">, you can start to set up </span><kbd><span class="koboSpan" id="kobo.10.1">kubeconfig</span></kbd><span class="koboSpan" id="kobo.11.1"> to access your Kubernetes API server.</span></p>
<p><span class="koboSpan" id="kobo.12.1">However, AWS integrates Kubernetes API access control with AWS IAM credentials. </span><span class="koboSpan" id="kobo.12.2">So, you need to use </span><kbd><span class="koboSpan" id="kobo.13.1">aws-iam-authenticator</span></kbd><span class="koboSpan" id="kobo.14.1"> (</span><a href="https://github.com/kubernetes-sigs/aws-iam-authenticator"><span class="koboSpan" id="kobo.15.1">https://github.com/kubernetes-sigs/aws-iam-authenticator</span></a><span class="koboSpan" id="kobo.16.1">) to generate a token when you run the </span><kbd><span class="koboSpan" id="kobo.17.1">kubectl</span></kbd><span class="koboSpan" id="kobo.18.1"> command.</span></p>
<p><span class="koboSpan" id="kobo.19.1">This simply downloads an </span><kbd><span class="koboSpan" id="kobo.20.1">aws-iam-authenticator</span></kbd><span class="koboSpan" id="kobo.21.1"> binary and installs it to the default command search path (for example, </span><kbd><span class="koboSpan" id="kobo.22.1">/usr/local/bin</span></kbd><span class="koboSpan" id="kobo.23.1">), then verifies whether </span><kbd><span class="koboSpan" id="kobo.24.1">aws-iam-authenticator</span></kbd><span class="koboSpan" id="kobo.25.1"> works or not, using the following command:</span></p>
<pre><strong><span class="koboSpan" id="kobo.26.1">$ aws-iam-authenticator token -i chap10</span></strong></pre>
<p><span class="koboSpan" id="kobo.27.1">If you see the </span><kbd><span class="koboSpan" id="kobo.28.1">authenticator</span></kbd><span class="koboSpan" id="kobo.29.1"> token, run the AWS CLI to generate </span><kbd><span class="koboSpan" id="kobo.30.1">kubeconfig</span></kbd><span class="koboSpan" id="kobo.31.1">, as follows:</span></p>
<pre><strong><span class="koboSpan" id="kobo.32.1">$ aws eks update-kubeconfig --name chap10</span></strong></pre>
<p><span class="koboSpan" id="kobo.33.1">If you succeed in creating </span><kbd><span class="koboSpan" id="kobo.34.1">kubeconfig</span></kbd><span class="koboSpan" id="kobo.35.1">, you can check whether you can access the Kubernetes master using the </span><kbd><span class="koboSpan" id="kobo.36.1">kubectl</span></kbd><span class="koboSpan" id="kobo.37.1"> command, as follows:</span></p>
<pre><strong><span class="koboSpan" id="kobo.38.1">$ kubectl cluster-info</span></strong><br/><strong><span class="koboSpan" id="kobo.39.1">$ kubectl get svc</span></strong></pre>
<p><span class="koboSpan" id="kobo.40.1">At this moment, you don't see any Kubernetes nodes (</span><kbd><span class="koboSpan" id="kobo.41.1">kubectl get nodes</span></kbd><span class="koboSpan" id="kobo.42.1"> returns empty). </span><span class="koboSpan" id="kobo.42.2">So, you need one more step to add worker nodes (Kubernetes nodes).</span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.43.1">You must use the same IAM user that creates a control plane and access the API server with </span><kbd><span class="koboSpan" id="kobo.44.1">aws-iam-authenticator</span></kbd><span class="koboSpan" id="kobo.45.1">. </span><span class="koboSpan" id="kobo.45.2">For example, it won't work if you create an EKS control plane by the AWS root account and then access the API server through one of the IAM users. </span><span class="koboSpan" id="kobo.45.3">You can see an error such as </span><span class="packt_screen"><span class="koboSpan" id="kobo.46.1">You must be logged in to the server (Unauthorized)</span></span><span class="koboSpan" id="kobo.47.1"> when using kubectl.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Adding worker nodes</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">As discussed, AWS doesn't allow the AWS CLI to set up EKS worker nodes. </span><span class="koboSpan" id="kobo.2.2">Instead, use CloudFormation. This creates the necessary AWS component for worker nodes, such as security groups, AutoScaling groups, and IAM Instance Roles. </span><span class="koboSpan" id="kobo.2.3">Furthermore, the Kubernetes master needs an IAM Instance Role when a worker node joins the Kubernetes cluster. </span><span class="koboSpan" id="kobo.2.4">It's highly recommended to use the CloudFormation template to launch worker nodes.</span></p>
<p><span class="koboSpan" id="kobo.3.1">CloudFormation execution steps are simple and follow the AWS EKS documentation, </span><a href="https://docs.aws.amazon.com/eks/latest/userguide/launch-workers.html"><span class="koboSpan" id="kobo.4.1">https://docs.aws.amazon.com/eks/latest/userguide/launch-workers.html</span></a><span class="koboSpan" id="kobo.5.1">. </span><span class="koboSpan" id="kobo.5.2">Use the S3 template URL, </span><a href="https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2018-12-10/amazon-eks-nodegroup.yaml"><span class="koboSpan" id="kobo.6.1">https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2018-12-10/amazon-eks-nodegroup.yaml</span></a><span class="koboSpan" id="kobo.7.1">, and then specify the parameters as in the following example:</span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td><strong><span class="koboSpan" id="kobo.8.1">Parameter</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.9.1">Value</span></strong></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.10.1">Stack name</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.11.1">chap10-worker</span></kbd></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.12.1">ClusterName</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.13.1">chap10 (must be match to EKS control plane name)</span></kbd></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.14.1">ClusterControlPlaneSecurityGroup</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.15.1">sg-0fbac0a39bf64ba10 (eks-control-plane)</span></kbd></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.16.1">NodeGroupName</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.17.1">chap10 EKS worker node (any name)</span></kbd></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.18.1">NodeImageId</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.19.1">ami-027792c3cc6de7b5b (version 1.10.x)</span></kbd></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.20.1">KeyName</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.21.1">my-key</span></kbd></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.22.1">VpcId</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.23.1">vpc-0ca37d4650963adbb</span></kbd></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.24.1">Subnets</span></kbd></td>
<td>
<ul>
<li class="mce-root"><kbd><span class="koboSpan" id="kobo.25.1">subnet-04b78ed9b5f96d76e (10.0.2.0/24)</span></kbd></li>
<li class="mce-root"><kbd><span class="koboSpan" id="kobo.26.1">subnet-08e16157c15cefcbc (10.0.4.0/24)</span></kbd></li>
</ul>
<p><strong><span class="koboSpan" id="kobo.27.1">Note</span></strong><span class="koboSpan" id="kobo.28.1">: only private subnets</span></p>
</td>
</tr>
</tbody>
</table>
<p><span><span class="koboSpan" id="kobo.29.1">CloudFormation execution takes around five minutes to complete, and then you need to get the </span><kbd><span class="koboSpan" id="kobo.30.1">NodeInstanceRole</span></kbd><span class="koboSpan" id="kobo.31.1"> value from </span><span class="packt_screen"><span class="koboSpan" id="kobo.32.1">Outputs</span></span></span><span class="koboSpan" id="kobo.33.1">,</span><span><span class="packt_screen"><span class="koboSpan" id="kobo.34.1"> </span></span><span class="koboSpan" id="kobo.35.1">as follows:</span></span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.36.1"><img src="assets/c444c84d-3fe8-4ff8-8db2-ca05f93e4419.png"/></span></p>
<p><span class="koboSpan" id="kobo.37.1">Finally, you can add these nodes to your Kubernetes cluster by adding </span><kbd><span class="koboSpan" id="kobo.38.1">ConfigMap</span></kbd><span class="koboSpan" id="kobo.39.1">. </span><span class="koboSpan" id="kobo.39.2">You can download a </span><kbd><span class="koboSpan" id="kobo.40.1">ConfigMap</span></kbd><span class="koboSpan" id="kobo.41.1"> template from </span><a href="https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2018-12-10/aws-auth-cm.yaml"><span class="koboSpan" id="kobo.42.1">https://amazon-eks.s3-us-west-2.amazonaws.com/cloudformation/2018-12-10/aws-auth-cm.yaml</span></a><span class="koboSpan" id="kobo.43.1"> and then fill out the Instance Role ARN, as in this example:</span></p>
<pre class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.44.1">$ cat aws-auth-cm.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.45.1">apiVersion: v1</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.46.1">kind: ConfigMap</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.47.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.48.1">name: aws-auth</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.49.1">namespace: kube-system</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.50.1">data:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.51.1">mapRoles: |</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.52.1">- rolearn: arn:aws:iam::xxxxxxxxxxxx:role/chap10-worker-NodeInstanceRole-8AFV8TB4IOXA</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.53.1">username: system:node:{{EC2PrivateDNSName}}</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.54.1">groups:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.55.1">- system:bootstrappers</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.56.1">- system:nodes</span></span><span class="s1"><br/></span><span class="s1"><span class="Apple-converted-space">        <br/><br/></span></span><span class="s1"><span class="koboSpan" id="kobo.57.1">$ kubectl create -f aws-auth-cm.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.58.1">configmap "aws-auth" created</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.59.1">After a few minutes, the worker nodes will be registered to your Kubernetes master, as follows:</span></p>
<pre class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.60.1">$ kubectl get nodes</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.61.1">NAME </span><span class="Apple-converted-space">                        </span><span class="koboSpan" id="kobo.62.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.63.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.64.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.65.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.66.1">ip-10-0-2-218.ec2.internal </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.67.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.68.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.69.1">3m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.70.1">v1.10.3</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.71.1">ip-10-0-4-74.ec2.internal</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.72.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.73.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.74.1">3m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.75.1">v1.10.3</span><br/></span></strong><span class="s1"><strong><span class="koboSpan" id="kobo.76.1">...</span></strong><br/></span></pre>
<p><span class="koboSpan" id="kobo.77.1">Now you can start to use your own Kubernetes cluster on AWS. </span><span class="koboSpan" id="kobo.77.2">Deploy your application to take a look at this. </span><span class="koboSpan" id="kobo.77.3">Note that, based on the preceding instruction, we deployed the worker nodes on a private subnet, so if you want to deploy an internet-facing Kubernetes Service, you need to use </span><kbd><span class="koboSpan" id="kobo.78.1">type:LoadBalancer</span></kbd><span class="koboSpan" id="kobo.79.1">. </span><span class="koboSpan" id="kobo.79.2">We'll explore this in the next section.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Cloud provider on EKS</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">AWS EKS integrates Kubernetes cloud provider into AWS components, for instance, elastic load balancer and Elastic Block Store. </span><span class="koboSpan" id="kobo.2.2">This section explores how EKS integrates into AWS components.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Storage class</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">As of December 2018, if you deploy Kubernetes version 1.10, EKS doesn't create storage classes by default. </span><span class="koboSpan" id="kobo.2.2">On the other hand, in version 1.11 or above, EKS creates default storage classes automatically. </span><span class="koboSpan" id="kobo.2.3">Using the following command, you can check whether a storage class exists or not:</span></p>
<pre><strong><span class="koboSpan" id="kobo.3.1">$ kubectl get sc</span></strong><br/><strong><span class="koboSpan" id="kobo.4.1">No resources found.</span></strong></pre>
<p><span class="koboSpan" id="kobo.5.1">In this case, you need to create a storage class to make a storage class. </span><span class="koboSpan" id="kobo.5.2">Note that AWS EBS and EC2 are zone sensitive. </span><span class="koboSpan" id="kobo.5.3">Therefore, EBS and EC2 must be located on the same availability zone. </span><span class="koboSpan" id="kobo.5.4">Therefore, it's recommended to create </span><kbd><span class="koboSpan" id="kobo.6.1">StorageClass</span></kbd><span class="koboSpan" id="kobo.7.1"> for each availability zone as follows:</span></p>
<pre class="p1"><strong><span class="koboSpan" id="kobo.8.1">//Storage Class for us-east-1a</span></strong><br/><strong><span class="koboSpan" id="kobo.9.1">$ cat storage-class-us-east-1a.yaml </span></strong><br/><strong><span class="koboSpan" id="kobo.10.1">kind: StorageClass</span></strong><br/><strong><span class="koboSpan" id="kobo.11.1">apiVersion: storage.k8s.io/v1</span></strong><br/><strong><span class="koboSpan" id="kobo.12.1">metadata:</span></strong><br/><strong>  <span><span class="koboSpan" id="kobo.13.1">name: gp2-us-east-1a</span><br/></span><span class="koboSpan" id="kobo.14.1">provisioner: kubernetes.io/aws-ebs</span></strong><br/><strong><span class="koboSpan" id="kobo.15.1">parameters:</span></strong><br/><strong>  <span><span class="koboSpan" id="kobo.16.1">type: gp2</span><br/></span>  <span><span class="koboSpan" id="kobo.17.1">fsType: ext4 </span><br/></span>  <span><span class="koboSpan" id="kobo.18.1">zone: us-east-1a</span></span></strong><br/><br/><strong><span class="koboSpan" id="kobo.19.1">// Storage Class for us-east-1b</span></strong><br/><strong><span class="koboSpan" id="kobo.20.1">$ cat storage-class-us-east-1b.yaml </span></strong><br/><strong><span class="koboSpan" id="kobo.21.1">kind: StorageClass</span></strong><br/><strong><span class="koboSpan" id="kobo.22.1">apiVersion: storage.k8s.io/v1</span></strong><br/><strong><span class="koboSpan" id="kobo.23.1">metadata:</span></strong><br/><strong> <span><span class="koboSpan" id="kobo.24.1">name: gp2-us-east-1b</span><br/></span><span class="koboSpan" id="kobo.25.1">provisioner: kubernetes.io/aws-ebs</span></strong><br/><strong><span class="koboSpan" id="kobo.26.1">parameters:</span></strong><br/><strong> <span><span class="koboSpan" id="kobo.27.1">type: gp2</span><br/></span> <span><span class="koboSpan" id="kobo.28.1">fsType: ext4 </span><br/></span> </strong><span><strong><span class="koboSpan" id="kobo.29.1">zone: us-east-1b # only change this</span></strong></span><span><br/><br/><br/></span><strong><span class="koboSpan" id="kobo.30.1">$ kubectl create -f storage-class-us-east-1a.yaml </span></strong><br/><strong><span class="koboSpan" id="kobo.31.1">storageclass.storage.k8s.io "gp2-us-east-1a" created</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.32.1">$ kubectl create -f storage-class-us-east-1b.yaml </span></strong><br/><strong><span class="koboSpan" id="kobo.33.1">storageclass.storage.k8s.io "gp2-us-east-1b" created</span></strong><br/><br/><br/><strong><span class="koboSpan" id="kobo.34.1">// there are 2 StorageClass</span></strong><br/><strong><span class="koboSpan" id="kobo.35.1">$ kubectl get sc</span></strong><br/><strong><span class="koboSpan" id="kobo.36.1">NAME </span><span class="Apple-converted-space"> </span><span><span class="koboSpan" id="kobo.37.1">PROVISIONER </span></span><span class="Apple-converted-space"> </span><span><span class="koboSpan" id="kobo.38.1">AGE</span><br/></span><span class="koboSpan" id="kobo.39.1">gp2-us-east-1a </span><span class="Apple-converted-space"> </span><span><span class="koboSpan" id="kobo.40.1">kubernetes.io/aws-ebs </span></span><span class="Apple-converted-space"> </span><span><span class="koboSpan" id="kobo.41.1">6s</span><br/></span><span class="koboSpan" id="kobo.42.1">gp2-us-east-1b </span><span class="Apple-converted-space"> </span><span><span class="koboSpan" id="kobo.43.1">kubernetes.io/aws-ebs </span></span><span class="Apple-converted-space"> </span><span><span class="koboSpan" id="kobo.44.1">3s</span></span></strong></pre>
<p><kbd><span class="koboSpan" id="kobo.45.1">PersistentVolumeClaim</span></kbd><span class="koboSpan" id="kobo.46.1"> can then specify either </span><kbd><span class="koboSpan" id="kobo.47.1">gp2-us-east-1a</span></kbd><span class="koboSpan" id="kobo.48.1"> or </span><kbd><span class="koboSpan" id="kobo.49.1">gp2-us-east-1b</span></kbd><span class="koboSpan" id="kobo.50.1"> storage class to provision the persistent volume:</span></p>
<pre class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.51.1">$ cat pvc-a.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.52.1">apiVersion: v1</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.53.1">kind: PersistentVolumeClaim</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.54.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.55.1">name: pvc-a</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.56.1">spec:</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.57.1">storageClassName: "gp2-us-east-1a"</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.58.1">accessModes:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.59.1">- ReadWriteOnce</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.60.1">resources:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.61.1">requests:</span><br/></span></strong><span class="s1"><strong><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.62.1">storage: 10Gi</span></strong><br/></span><span class="s1"><span class="Apple-converted-space">      <br/><br/></span></span><strong><span class="s1"><span class="koboSpan" id="kobo.63.1">$ cat pvc-b.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.64.1">apiVersion: v1</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.65.1">kind: PersistentVolumeClaim</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.66.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.67.1">name: pvc-b</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.68.1">spec:</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.69.1">storageClassName: "gp2-us-east-1b" # only change this</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.70.1">accessModes:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.71.1">- ReadWriteOnce</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.72.1">resources:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.73.1">requests:</span><br/></span><span class="s1"><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.74.1">storage: 10Gi</span><br/><br/><br/></span><span class="s1"><span class="koboSpan" id="kobo.75.1">$ kubectl create -f pvc-a.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.76.1">persistentvolumeclaim "pvc-a" created</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.77.1">$ kubectl create -f pvc-b.yaml </span><br/></span></strong><span class="s1"><strong><span class="koboSpan" id="kobo.78.1">persistentvolumeclaim "pvc-b" created</span></strong><br/><br/><br/></span><strong><span class="s1"><span class="koboSpan" id="kobo.79.1">$ kubectl get pv</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.80.1">NAME </span><span class="Apple-converted-space">                                      </span><span class="koboSpan" id="kobo.81.1">CAPACITY </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.82.1">ACCESS MODES </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.83.1">RECLAIM POLICY </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.84.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.85.1">CLAIM </span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.86.1">STORAGECLASS </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.87.1">REASON</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.88.1">AGE</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.89.1">pvc-20508a71-0187-11e9-bf51-02a2ca4dacd8 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.90.1">10Gi </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.91.1">RWO</span><span class="Apple-converted-space">            </span><span class="koboSpan" id="kobo.92.1">Delete </span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.93.1">Bound </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.94.1">default/pvc-a </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.95.1">gp2-us-east-1a </span><span class="Apple-converted-space">            </span><span class="koboSpan" id="kobo.96.1">4m</span><br/></span></strong><span class="s1"><strong><span class="koboSpan" id="kobo.97.1">pvc-2235f412-0187-11e9-bf51-02a2ca4dacd8 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.98.1">10Gi </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.99.1">RWO</span><span class="Apple-converted-space">            </span><span class="koboSpan" id="kobo.100.1">Delete </span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.101.1">Bound </span><span class="Apple-converted-space">              </span><span class="koboSpan" id="kobo.102.1">4m</span></strong><br/><br/><br/></span><span class="s1"><strong><span class="koboSpan" id="kobo.103.1">// use AWS CLI to search EBS instances by following command</span></strong><br/></span><strong><span class="s1"><span class="koboSpan" id="kobo.104.1">$ aws ec2 describe-volumes --query "Volumes[*].{Id:VolumeId,AZ:AvailabilityZone,Tags:Tags[?Key=='kubernetes.io/created-for/pv/name'].Value}" --filter "Name=tag-key,Values=kubernetes.io/cluster/chap10"</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.105.1">[</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.106.1">{</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.107.1">"Id": "vol-0fdec40626aac7cc4",</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.108.1">"AZ": "us-east-1a",</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.109.1">"Tags": [</span><br/></span><span class="s1"><span class="Apple-converted-space">            </span><span class="koboSpan" id="kobo.110.1">"pvc-20508a71-0187-11e9-bf51-02a2ca4dacd8"</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.111.1">]</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.112.1">},</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.113.1">{</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.114.1">"Id": "vol-0d9ef53eedde70115",</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.115.1">"AZ": "us-east-1b",</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.116.1">"Tags": [</span><br/></span><span class="s1"><span class="Apple-converted-space">            </span><span class="koboSpan" id="kobo.117.1">"pvc-2235f412-0187-11e9-bf51-02a2ca4dacd8"</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.118.1">]</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.119.1">}</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.120.1">]</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.121.1">Note that worker nodes have a label of </span><kbd><span class="koboSpan" id="kobo.122.1">failure-domain.beta.kubernetes.io/zone</span></kbd><span class="koboSpan" id="kobo.123.1">, so you can specify a </span><kbd><span class="koboSpan" id="kobo.124.1">nodeSelector</span></kbd><span class="koboSpan" id="kobo.125.1"> to deploy the pod to the desired availability zone:</span></p>
<pre class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.126.1">$ kubectl get nodes --show-labels</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.127.1">NAME </span><span class="Apple-converted-space">                        </span><span class="koboSpan" id="kobo.128.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.129.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.130.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.131.1">VERSION </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.132.1">LABELS</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.133.1">ip-10-0-2-218.ec2.internal </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.134.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.135.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.136.1">4h</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.137.1">v1.10.3 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.138.1">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=t2.small,beta.kubernetes.io/os=linux,failure-domain.beta.kubernetes.io/region=us-east-1,failure-domain.beta.kubernetes.io/zone=us-east-1b,kubernetes.io/hostname=ip-10-0-2-218.ec2.internal</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.139.1">ip-10-0-4-74.ec2.internal</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.140.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.141.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.142.1">4h</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.143.1">v1.10.3 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.144.1">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/instance-type=t2.small,beta.kubernetes.io/os=linux,failure-domain.beta.kubernetes.io/region=us-east-1,failure-domain.beta.kubernetes.io/zone=us-east-1a,kubernetes.io/hostname=ip-10-0-4-74.ec2.internal</span></span></strong></pre>
<pre class="p1"><span class="s1"><strong><span class="koboSpan" id="kobo.145.1">// nodeSelector specifies us-east-1a, also pvc-a</span></strong><br/></span><strong><span class="s1"><span class="koboSpan" id="kobo.146.1">$ cat pod-us-east-1a.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.147.1">apiVersion: v1</span><br/><span class="koboSpan" id="kobo.148.1">kind: Pod</span><br/><span class="koboSpan" id="kobo.149.1">metadata: </span><br/><span class="koboSpan" id="kobo.150.1">  name: nginx</span><br/><span class="koboSpan" id="kobo.151.1">  labels:</span><br/><span class="koboSpan" id="kobo.152.1">    project: devops-with-kubernetes</span><br/><span class="koboSpan" id="kobo.153.1">    app: nginx</span><br/><span class="koboSpan" id="kobo.154.1">spec:</span><br/><span class="koboSpan" id="kobo.155.1">  containers:</span><br/><span class="koboSpan" id="kobo.156.1">  - name: nginx</span><br/><span class="koboSpan" id="kobo.157.1">    image: nginx</span><br/><span class="koboSpan" id="kobo.158.1">    volumeMounts:</span><br/><span class="koboSpan" id="kobo.159.1">      - mountPath: /var/log/nginx</span><br/><span class="koboSpan" id="kobo.160.1">        name: nginx-log</span><br/><span class="koboSpan" id="kobo.161.1">  volumes:</span><br/><span class="koboSpan" id="kobo.162.1">  - name: nginx-log</span><br/><span class="koboSpan" id="kobo.163.1">    persistentVolumeClaim:</span><br/><span class="koboSpan" id="kobo.164.1">      claimName: "pvc-a"</span><br/><span class="koboSpan" id="kobo.165.1">  nodeSelector:</span><br/><span class="koboSpan" id="kobo.166.1">    failure-domain.beta.kubernetes.io/zone: us-east-1a</span></span><span class="s1"><span class="Apple-converted-space">    <br/><br/></span></span><span class="s1"><span class="koboSpan" id="kobo.167.1">$ kubectl create -f pod-us-east-1a.yaml </span><br/></span></strong><span class="s1"><strong><span class="koboSpan" id="kobo.168.1">pod "nginx" created</span></strong><br/><br/></span><span class="s1"><strong><span class="koboSpan" id="kobo.169.1">// deploy to 10.0.4.0/24 subnet (us-east-1a)</span></strong><br/></span><strong><span class="s1"><span class="koboSpan" id="kobo.170.1">$ kubectl get pods -o wide</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.171.1">NAME</span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.172.1">READY </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.173.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.174.1">RESTARTS </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.175.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.176.1">IP</span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.177.1">NODE</span><br/></span></strong><span class="s1"><strong><span class="koboSpan" id="kobo.178.1">nginx </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.179.1">1/1 </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.180.1">Running </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.181.1">0</span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.182.1">18s </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.183.1">10.0.4.33 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.184.1">ip-10-0-4-74.ec2.internal</span></strong><br/><br/></span><span class="s1"><strong><span class="koboSpan" id="kobo.185.1">// successfully to mount PVC-a</span></strong> <br/></span><strong><span class="s1"><span class="koboSpan" id="kobo.186.1">$ kubectl exec -it nginx /bin/bash</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.187.1">root@nginx:/# df -h /var/log/nginx</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.188.1">Filesystem</span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.189.1">Size</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.190.1">Used Avail Use% Mounted on</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.191.1">/dev/xvdca</span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.192.1">9.8G </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.193.1">37M</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.194.1">9.2G </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.195.1">1% /var/log/nginx</span></span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Load balancer</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">EKS also integrates Kubernetes Service into classic load balancer (also known as ELB). </span><span class="koboSpan" id="kobo.2.2">When you create a Kubernetes Service by specifying </span><kbd><span class="koboSpan" id="kobo.3.1">type:LoadBalancer</span></kbd><span class="koboSpan" id="kobo.4.1">, EKS creates the Classic ELB instance and security group, and then associates between ELB and worker nodes automatically.</span></p>
<p><span class="koboSpan" id="kobo.5.1">In addition, you can </span><span><span class="koboSpan" id="kobo.6.1">either</span></span><span><span class="koboSpan" id="kobo.7.1"> </span></span><span><span class="koboSpan" id="kobo.8.1">create</span></span> <span><span class="koboSpan" id="kobo.9.1">an </span></span><span><span class="koboSpan" id="kobo.10.1">internet-facing (on the public subnet) or internal (on the private</span></span><span class="koboSpan" id="kobo.11.1"> subnet</span><span><span class="koboSpan" id="kobo.12.1">) l</span></span><span><span class="koboSpan" id="kobo.13.1">oad balancer</span></span><span><span class="koboSpan" id="kobo.14.1">. </span><span class="koboSpan" id="kobo.14.2">If you don't need to serve traffic to the external internet, you should use an internal load balancer for security reasons.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Internal load balancer</span></h1>
                </header>
            
            <article>
                
<p><span><span class="koboSpan" id="kobo.2.1">Let's create an internal load balancer for the previous </span><kbd><span class="koboSpan" id="kobo.3.1">nginx</span></kbd><span class="koboSpan" id="kobo.4.1"> pod. </span><span class="koboSpan" id="kobo.4.2">In order to use an internal load balancer, you need to add an annotation (</span><kbd><span class="koboSpan" id="kobo.5.1">service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0</span></kbd><span class="koboSpan" id="kobo.6.1">), as follows:</span></span></p>
<pre class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.7.1">$ cat internal-elb.yaml</span><br/></span></strong><strong><span class="s1"><span class="koboSpan" id="kobo.8.1">apiVersion: v1</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.9.1">kind: Service</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.10.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.11.1">name: nginx</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.12.1">annotations:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.13.1">service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.14.1">spec:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.15.1">ports:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.16.1">- protocol: TCP</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.17.1">port: 80</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.18.1">type: LoadBalancer</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.19.1">selector:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.20.1">project: devops-with-kubernetes</span><br/></span></strong><span class="s1"><strong><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.21.1">app: nginx</span></strong></span><span class="s1"><br/><br/></span><strong><span class="s1"><span class="koboSpan" id="kobo.22.1">$ kubectl create -f internal-elb.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.23.1">service "nginx" created</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.24.1">Then, the EKS Cloud provider will create and configure a classic ELB as in the following screenshot:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.25.1"><img src="assets/ee2077b8-085d-41de-a5c0-dd8f91cb9ff0.png" style="width:50.42em;height:17.42em;"/></span></p>
<p><span class="koboSpan" id="kobo.26.1">Since it's an internal ELB, you can't gain access to the ELB from outside of the AWS network, for example, from your laptop. </span><span class="koboSpan" id="kobo.26.2">However, it's useful to expose your application to the outside of the Kubernetes cluster within VPC.</span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.27.1">The AWS charges ELB per hour. </span><span class="koboSpan" id="kobo.27.2">If your Kubernetes Service serves within Kubernetes cluster pods, you may consider using </span><kbd><span class="koboSpan" id="kobo.28.1">type:ClusterIP</span></kbd><span class="koboSpan" id="kobo.29.1">.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Internet-facing load balancer</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Creating an internet-facing load balancer consists of the same steps as an internal load balancer, but there's no need for an annotation (</span><kbd><span class="koboSpan" id="kobo.3.1">service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0</span></kbd><span class="koboSpan" id="kobo.4.1">):</span></p>
<pre class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.5.1">$ cat external-elb.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.6.1">apiVersion: v1</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.7.1">kind: Service</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.8.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.9.1">name: nginx-external</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.10.1">spec:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.11.1">ports:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.12.1">- protocol: TCP</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.13.1">port: 80</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.14.1">type: LoadBalancer</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.15.1">selector:</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.16.1">project: devops-with-kubernetes</span><br/></span><span class="s1"><span class="Apple-converted-space"> </span><span class="koboSpan" id="kobo.17.1">app: nginx</span></span><span class="s1"><br/></span><span class="s1"><br/><span class="koboSpan" id="kobo.18.1">$ kubectl create -f external-elb.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.19.1">service "nginx-external" created</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.20.1">When you check the AWS Web Console, you can see that </span><span class="packt_screen"><span class="koboSpan" id="kobo.21.1">Scheme</span></span><span class="koboSpan" id="kobo.22.1"> is </span><span class="packt_screen"><span class="koboSpan" id="kobo.23.1">internet-facing</span></span><span class="koboSpan" id="kobo.24.1"> as follows: </span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.25.1"><img src="assets/b03609b5-46cc-4e08-abae-f62750bd4384.png" style="width:49.67em;height:17.67em;"/></span></p>
<p><span><span class="koboSpan" id="kobo.26.1">You can access the ELB from your laptop as well:</span></span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.27.1"><img src="assets/9f790dfd-bfdb-4ffe-86f4-f937f3e872a1.png" style="width:53.17em;height:15.33em;"/></span></p>
<p><span class="koboSpan" id="kobo.28.1">As you can see from the preceding screenshots, the EKS cloud provider is integrated into Kubernetes Service, which launches a classic ELB. </span><span><span><span class="koboSpan" id="kobo.29.1">This feature</span></span></span><span class="koboSpan" id="kobo.30.1"> is very powerful for scaling out the traffic volume that dispatches to multiple pods. </span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.31.1">EKS has also already begun</span><span><span class="koboSpan" id="kobo.32.1"> to support the use of </span></span><strong><span class="koboSpan" id="kobo.33.1">Network Load Balancer</span></strong> <span><span class="koboSpan" id="kobo.34.1">(</span></span><strong><span class="koboSpan" id="kobo.35.1">NLB</span></strong><span><span class="koboSpan" id="kobo.36.1">), the new version of L4 load balancer in AWS.</span></span></div>
<p class="mce-root"><span class="koboSpan" id="kobo.37.1">In order to use NLB, you need an additional annotation. </span><span class="koboSpan" id="kobo.37.2">This annotation is as follows:</span></p>
<pre class="p1"><span class="s1"><span class="koboSpan" id="kobo.38.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.39.1">name: nginx-external</span><br/><span class="koboSpan" id="kobo.40.1">  annotations:</span><br/>    <strong><span class="koboSpan" id="kobo.41.1">service.beta.kubernetes.io/aws-load-balancer-type: "nlb"</span></strong></span></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Updating the Kubernetes version on EKS</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">When Kubernetes releases a new version, EKS will follow and provide the latest version of Kubernetes for the user in a timely manner. </span><span class="koboSpan" id="kobo.2.2">In previous examples, we've used Kubernetes version 1.10. </span><span class="koboSpan" id="kobo.2.3">As of December 2018, EKS also supports version 1.11. </span><span class="koboSpan" id="kobo.2.4">Let's perform the upgrade to see how EKS handles cluster updates.</span></p>
<p><span class="koboSpan" id="kobo.3.1">The typical upgrade steps are as follows:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.4.1">Upgrade the Kubernetes master via the AWS CLI</span></li>
<li><span class="koboSpan" id="kobo.5.1">Create a new version of worker nodes via CloudFormation</span></li>
<li><span class="koboSpan" id="kobo.6.1">Add new worker nodes to the Kubernetes cluster (both old and new worker nodes co-exist at this time)</span></li>
<li><span class="koboSpan" id="kobo.7.1">Migrate pods from the old worker node to the new one</span></li>
</ol>
<p class="mce-root"><span class="koboSpan" id="kobo.8.1">Mostly, the worker nodes upgrade requires some manual steps. </span><span class="koboSpan" id="kobo.8.2">We'll explore this step by step.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Upgrading the Kubernetes master</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Upgrading the Kubernetes master involves the simple step of specifying your EKS name and desired new version, as shown in the following. </span><span class="koboSpan" id="kobo.2.2">This takes around 30 minutes to complete, based on the condition. </span><span class="koboSpan" id="kobo.2.3">Meanwhile, accessing Kubernetes API server (via </span><kbd><span class="koboSpan" id="kobo.3.1">kubectl</span></kbd><span class="koboSpan" id="kobo.4.1">) might fail. </span><span class="koboSpan" id="kobo.4.2">Although pods and Services won't be affected, you need to leave enough time to perform this operation:</span></p>
<pre><strong><span class="koboSpan" id="kobo.5.1">$ aws eks update-cluster-version --name chap10 --kubernetes-version 1.11</span></strong><br/><strong><span class="koboSpan" id="kobo.6.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.7.1">    "update": {</span></strong><br/><strong><span class="koboSpan" id="kobo.8.1">        "status": "InProgress", </span></strong><br/><strong><span class="koboSpan" id="kobo.9.1">        "errors": [], </span></strong><br/><strong><span class="koboSpan" id="kobo.10.1">        "params": [</span></strong><br/><strong><span class="koboSpan" id="kobo.11.1">            {</span></strong><br/><strong><span class="koboSpan" id="kobo.12.1">                "type": "Version", </span></strong><br/><strong><span class="koboSpan" id="kobo.13.1">                "value": "1.11"</span></strong><br/><strong><span class="koboSpan" id="kobo.14.1">            }, </span></strong><br/><strong><span class="koboSpan" id="kobo.15.1">            {</span></strong><br/><strong><span class="koboSpan" id="kobo.16.1">                "type": "PlatformVersion", </span></strong><br/><strong><span class="koboSpan" id="kobo.17.1">                "value": "eks.1"</span></strong><br/><strong><span class="koboSpan" id="kobo.18.1">            }</span></strong><br/><strong><span class="koboSpan" id="kobo.19.1">        ], </span></strong><br/><strong><span class="koboSpan" id="kobo.20.1">        "type": "VersionUpdate", </span></strong><br/><strong><span class="koboSpan" id="kobo.21.1">        "id": "09688495-4d12-4aa5-a2e8-dfafec1cee17", </span></strong><br/><strong><span class="koboSpan" id="kobo.22.1">        "createdAt": 1545007011.285</span></strong><br/><strong><span class="koboSpan" id="kobo.23.1">    }</span></strong><br/><strong><span class="koboSpan" id="kobo.24.1">}</span></strong></pre>
<p><span class="koboSpan" id="kobo.25.1">As you can see in the preceding code, the </span><kbd><span class="koboSpan" id="kobo.26.1">aws eks update-cluster-version</span></kbd><span class="koboSpan" id="kobo.27.1"> command returns update </span><kbd><span class="koboSpan" id="kobo.28.1">id</span></kbd><span class="koboSpan" id="kobo.29.1">. </span><span class="koboSpan" id="kobo.29.2">You can use this ID to check the upgrade status, as follows:</span></p>
<pre class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.30.1">$ aws eks describe-update --name chap10 --update-id 09688495-4d12-4aa5-a2e8-dfafec1cee17</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.31.1">{</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.32.1">"update": {</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.33.1">"status": "InProgress", </span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.34.1">"errors": [], </span><br/><span class="koboSpan" id="kobo.35.1">...</span><br/><span class="koboSpan" id="kobo.36.1">...</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.37.1">Once the status changes from </span><kbd><span class="koboSpan" id="kobo.38.1">InProgress</span></kbd><span class="koboSpan" id="kobo.39.1"> to </span><kbd><span class="koboSpan" id="kobo.40.1">Successful</span></kbd><span class="koboSpan" id="kobo.41.1">, you can see the newer version of the API server as follows:</span></p>
<pre class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.42.1">$ kubectl version --short</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.43.1">Client Version: v1.10.7</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.44.1">Server Version: v1.11.5-eks-6bad6d</span></span></strong></pre>
<div class="packt_tip"><span class="koboSpan" id="kobo.45.1">Based on differences between older and newer versions of Kubernetes, there are some additional migration steps that we might need to follow. </span><span class="koboSpan" id="kobo.45.2">For example, change the DNS service from </span><kbd><span class="koboSpan" id="kobo.46.1">kube-dns</span></kbd><span class="koboSpan" id="kobo.47.1"> to </span><kbd><span class="koboSpan" id="kobo.48.1">core-dns</span></kbd><span class="koboSpan" id="kobo.49.1">. </span><span class="koboSpan" id="kobo.49.2">You need to follow these steps if AWS EKS provides some instructions.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Upgrading worker nodes</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">After upgrading the Kubernetes master, you can start to upgrade the worker nodes. </span><span class="koboSpan" id="kobo.2.2">However, again, there's no AWS CLI support yet, so you need some manual steps to upgrade worker nodes:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.3.1">Create new worker nodes using the same steps as earlier using CloudFormation. </span><span class="koboSpan" id="kobo.3.2">However, here, you'll specify the new version of AMI, such as </span><kbd><span class="koboSpan" id="kobo.4.1">ami-0b4eb1d8782fc3aea</span></kbd><span class="koboSpan" id="kobo.5.1">. </span><span class="koboSpan" id="kobo.5.2">You can get an AMI ID list from the AWS documentation via </span><a href="https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html"><span class="koboSpan" id="kobo.6.1">https://docs.aws.amazon.com/eks/latest/userguide/eks-optimized-ami.html</span></a><span class="koboSpan" id="kobo.7.1">.</span></li>
<li><span class="koboSpan" id="kobo.8.1">Update a security group for both old and new worker nodes to allow network traffic between them. </span><span class="koboSpan" id="kobo.8.2">You can find a security group ID via the AWS CLI or AWS Web Console. </span><span class="koboSpan" id="kobo.8.3">For more details on this, please visit the AWS documentation: </span><a href="https://docs.aws.amazon.com/eks/latest/userguide/migrate-stack.html"><span class="koboSpan" id="kobo.9.1">https://docs.aws.amazon.com/eks/latest/userguide/migrate-stack.html</span></a><span class="koboSpan" id="kobo.10.1">.</span></li>
<li><span class="koboSpan" id="kobo.11.1">Update </span><kbd><span class="koboSpan" id="kobo.12.1">ConfigMap</span></kbd><span class="koboSpan" id="kobo.13.1"> to add (not replace) new worker nodes Instance ARNs, as in the following example:</span></li>
</ol>
<pre style="padding-left: 90px" class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.14.1">$ vi aws-auth-cm.yaml </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.15.1">apiVersion: v1</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.16.1">kind: ConfigMap</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.17.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.18.1">name: aws-auth</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.19.1">namespace: kube-system</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.20.1">data:</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.21.1">mapRoles: |</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.22.1"># </span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.23.1"># new version of Worker Nodes</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.24.1">#</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.25.1">- rolearn: arn:aws:iam::xxxxxxxxxxxx:role/chap10-v11-NodeInstanceRole-10YYF3AILTJOS</span><br/></span><span class="s1"><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.26.1">username: system:node:{{EC2PrivateDNSName}}</span><br/></span><span class="s1"><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.27.1">groups:</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.28.1">- system:bootstrappers</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.29.1">- system:nodes</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.30.1">#</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.31.1"># old version of Worker Nodes</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.32.1">#</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.33.1">- rolearn: arn:aws:iam::xxxxxxxxxxxx:role/chap10-worker-NodeInstanceRole-8AFV8TB4IOXA</span><br/></span><span class="s1"><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.34.1">username: system:node:{{EC2PrivateDNSName}}</span><br/></span><span class="s1"><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.35.1">groups:</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.36.1">- system:bootstrappers</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.37.1">- system:nodes</span><br/><br/></span><span class="s1"><span class="koboSpan" id="kobo.38.1">//apply command to update ConfigMap</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.39.1">$ kubectl apply -f aws-auth-cm.yaml </span></span><span class="s1"><br/><br/></span><span class="koboSpan" id="kobo.40.1">// you can see both 1.10 and 1.11 nodes</span></strong><br/><strong><span class="s1"><span class="koboSpan" id="kobo.41.1">$ kubectl get nodes</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.42.1">NAME </span><span class="Apple-converted-space">                        </span><span class="koboSpan" id="kobo.43.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.44.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.45.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.46.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.47.1">ip-10-0-2-122.ec2.internal </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.48.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.49.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.50.1">1m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.51.1">v1.11.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.52.1">ip-10-0-2-218.ec2.internal </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.53.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.54.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.55.1">6h</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.56.1">v1.10.3</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.57.1">...</span></span></strong></pre>
<ol start="4">
<li><span class="koboSpan" id="kobo.58.1">Taint and drain the old nodes to move the pod to the new node:</span></li>
</ol>
<pre style="padding-left: 90px" class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.59.1">// prevent to assign pod to older Nodes</span></span><span class="s1"><br/></span><span class="s1"><span class="koboSpan" id="kobo.60.1">$ kubectl taint nodes ip-10-0-2-218.ec2.internal key=value:NoSchedule</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.61.1">$ kubectl taint nodes ip-10-0-4-74.ec2.internal key=value:NoSchedule</span><br/><br/></span><span class="s1"><span class="koboSpan" id="kobo.62.1">// move Pod from older to newer Nodes</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.63.1">$ kubectl drain ip-10-0-2-218.ec2.internal --ignore-daemonsets --delete-local-data</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.64.1">$ kubectl drain ip-10-0-4-74.ec2.internal --ignore-daemonsets --delete-local-data</span><br/><br/></span><span class="s1"><span class="koboSpan" id="kobo.65.1">// Old worker node became SchedulingDisabled</span></span><span class="s1"><br/></span><span class="s1"><span class="koboSpan" id="kobo.66.1">$ kubectl get nodes</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.67.1">NAME </span><span class="Apple-converted-space">                        </span><span class="koboSpan" id="kobo.68.1">STATUS </span><span class="Apple-converted-space">                    </span><span class="koboSpan" id="kobo.69.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.70.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.71.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.72.1">ip-10-0-2-122.ec2.internal </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.73.1">Ready</span><span class="Apple-converted-space">                      </span><span class="koboSpan" id="kobo.74.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.75.1">7m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.76.1">v1.11.5</span><br/></span></strong><span class="s1"><strong><span class="koboSpan" id="kobo.77.1">ip-10-0-2-218.ec2.internal </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.78.1">Ready,SchedulingDisabled </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.79.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.80.1">7h</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.81.1">v1.10.3</span></strong><br/></span><strong><span class="s1"><span class="koboSpan" id="kobo.82.1">ip-10-0-4-74.ec2.internal</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.83.1">Ready,SchedulingDisabled </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.84.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.85.1">7h</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.86.1">v1.10.3</span></span></strong></pre>
<ol start="5">
<li><span class="koboSpan" id="kobo.87.1">Remove old nodes from the cluster and update </span><kbd><span class="koboSpan" id="kobo.88.1">ConfigMap</span></kbd><span class="koboSpan" id="kobo.89.1"> again:</span></li>
</ol>
<pre style="padding-left: 90px" class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.90.1">$ kubectl delete node ip-10-0-2-218.ec2.internal</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.91.1">node "ip-10-0-2-218.ec2.internal" deleted</span><br/></span><span class="s1"><br/><span class="koboSpan" id="kobo.92.1">$ kubectl delete node ip-10-0-4-74.ec2.internal</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.93.1">node "ip-10-0-4-74.ec2.internal" deleted</span><br/><br/></span><span class="s1"><span class="koboSpan" id="kobo.94.1">$ kubectl edit configmap aws-auth -n kube-system</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.95.1">configmap "aws-auth" edited</span><br/><br/></span><span class="s1"><span class="koboSpan" id="kobo.96.1">$ kubectl get nodes</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.97.1">NAME </span><span class="Apple-converted-space">                        </span><span class="koboSpan" id="kobo.98.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.99.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.100.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.101.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.102.1">ip-10-0-2-122.ec2.internal </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.103.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.104.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.105.1">15m </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.106.1">v1.11.5</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.107.1">Upgrading a Kubernetes version is an annoying topic for Kubernetes administrators. </span><span class="koboSpan" id="kobo.107.2">This is because of Kubernetes' release cycle (which usually occurs every three months) and the need to carry out enough compatibility testing.</span></p>
<p><span class="koboSpan" id="kobo.108.1">The EKS upgrade procedure requires AWS knowledge and understanding. </span><span class="koboSpan" id="kobo.108.2">This consists of many steps and involves some technical difficulty, but it should not be too difficult. </span><span class="koboSpan" id="kobo.108.3">Because EKS is still a newer service in AWS, it'll keep improving and providing easier options to the user in the future. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Summary</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">In this chapter, we discussed the public cloud. </span><span class="koboSpan" id="kobo.2.2">AWS is the most popular public cloud service and it gives APIs the ability to control AWS infrastructure programmatically.</span></p>
<p><span class="koboSpan" id="kobo.3.1">In addition, AWS EKS makes it easy to deploy Kubernetes on AWS. </span><span class="koboSpan" id="kobo.3.2">Furthermore, the control plane manages the master and </span><kbd><span class="koboSpan" id="kobo.4.1">etcd</span></kbd><span class="koboSpan" id="kobo.5.1"> with high availability design that offloads huge management efforts.</span></p>
<p><span class="koboSpan" id="kobo.6.1">On the other hand, you need to be aware of AWS basics such as availability zone awareness between pod (EC2) and persistent volume (EBS). </span><span class="koboSpan" id="kobo.6.2">In addition, you need intermediate AWS knowledge such as IAM credentials to gain access to an API server and use a worker node Instance Role ARN to register the cluster.</span></p>
<p><span><span class="koboSpan" id="kobo.7.1">In addition, using ALB as ingress controller is available as of December 2018 (</span></span><a href="https://aws.amazon.com/blogs/opensource/kubernetes-ingress-aws-alb-ingress-controller/"><span class="koboSpan" id="kobo.8.1">https://aws.amazon.com/blogs/opensource/kubernetes-ingress-aws-alb-ingress-controller/</span></a><span><span class="koboSpan" id="kobo.9.1">), but it also requires additional effort to configure this.</span></span></p>
<p><span class="koboSpan" id="kobo.10.1">Although AWS keeps improving functionality, open source tools such as </span><kbd><span class="koboSpan" id="kobo.11.1">eksctl</span></kbd><span class="koboSpan" id="kobo.12.1"> indicate EKS still requires more improvement for easier use of Kubernetes.</span></p>
<p><span class="koboSpan" id="kobo.13.1">In </span><a href="d4de05e3-eb24-4e8e-bfd3-e68819b5e66c.xhtml"><span class="koboSpan" id="kobo.14.1">Chapter 11</span></a><span class="koboSpan" id="kobo.15.1">, </span><em><span class="koboSpan" id="kobo.16.1">Kubernetes on GCP</span></em><span class="koboSpan" id="kobo.17.1">, we'll introduce Google Cloud Platform and Kubernetes Engine, which is a pioneer for making a hosted Kubernetes service on Cloud. </span><span class="koboSpan" id="kobo.17.2">This is more mature than AWS EKS.</span></p>


            </article>

            
        </section>
    </body></html>