<html><head></head><body>
<div id="_idContainer327">
<h1 class="chapter-number" id="_idParaDest-220"><a id="_idTextAnchor220"/><span class="koboSpan" id="kobo.1.1">11</span></h1>
<h1 id="_idParaDest-221"><a id="_idTextAnchor221"/><span class="koboSpan" id="kobo.2.1">Enabling Secure Inter-Service Communication with Tanzu Service Mesh</span></h1>
<p><span class="koboSpan" id="kobo.3.1">Enterprise software has changed significantly in the last few years. </span><span class="koboSpan" id="kobo.3.2">Some of you reading this may remember when most software was written as a single monolith by a small team of developers. </span><span class="koboSpan" id="kobo.3.3">The application had to be deployed, updated, started, stopped, and scaled as a </span><span class="No-Break"><span class="koboSpan" id="kobo.4.1">single unit.</span></span></p>
<p><span class="koboSpan" id="kobo.5.1">As software began to evolve in the early to mid-2000s, demands on software and software developers started to grow along </span><span class="No-Break"><span class="koboSpan" id="kobo.6.1">four axes:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.7.1">Time to value</span></strong><span class="koboSpan" id="kobo.8.1">: Teams were expected to deliver bug fixes, improvements, and new value-delivering features on </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">ever-shrinking timelines.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.10.1">Elasticity</span></strong><span class="koboSpan" id="kobo.11.1">: Teams needed to scale “hot” services independently and deploy individual features without having to build, test, and deploy the entire monolith all </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">at once.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.13.1">Fault-tolerance</span></strong><span class="koboSpan" id="kobo.14.1">: When an individual service failed or started to degrade, it shouldn’t affect other services, and the system should be able to work around the </span><span class="No-Break"><span class="koboSpan" id="kobo.15.1">problematic service.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.16.1">Programming languages and frameworks</span></strong><span class="koboSpan" id="kobo.17.1">: The technology landscape began to move too quickly for monolithic applications to keep up. </span><span class="koboSpan" id="kobo.17.2">Developers felt stifled and constrained by the older, less </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">agile technology.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.19.1">These demands led to </span><a id="_idIndexMarker982"/><span class="koboSpan" id="kobo.20.1">the near-universal adoption of design patterns such as microservices (</span><a href="https://en.wikipedia.org/wiki/Microservices"><span class="koboSpan" id="kobo.21.1">https://en.wikipedia.org/wiki/Microservices</span></a><span class="koboSpan" id="kobo.22.1">). </span><span class="koboSpan" id="kobo.22.2">Furthermore, as microservices came to predominate software development and teams became more independent and autonomous, new architecture paradigms began to emerge, specifically hybrid </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">and multi-cloud:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.24.1">Hybrid cloud</span></strong><span class="koboSpan" id="kobo.25.1">: This refers to deploying apps consisting of legacy VMs, Kubernetes services, serverless functions, and possibly other technologies such as </span><strong class="bold"><span class="koboSpan" id="kobo.26.1">Platform-as-a-Service</span></strong><span class="koboSpan" id="kobo.27.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.28.1">PaaS</span></strong><span class="koboSpan" id="kobo.29.1">) across an on-premises data center and the </span><span class="No-Break"><span class="koboSpan" id="kobo.30.1">public cloud.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.31.1">Multi-cloud</span></strong><span class="koboSpan" id="kobo.32.1">: This refers to deploying an application across multiple </span><strong class="bold"><span class="koboSpan" id="kobo.33.1">Virtual Private Clouds</span></strong><span class="koboSpan" id="kobo.34.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.35.1">VPCs</span></strong><span class="koboSpan" id="kobo.36.1">) across one or more </span><span class="No-Break"><span class="koboSpan" id="kobo.37.1">cloud providers.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.38.1">Google has some interesting material on these architectures </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">here: </span></span><a href="https://cloud.google.com/architecture/hybrid-and-multi-cloud-patterns-and-practices"><span class="No-Break"><span class="koboSpan" id="kobo.40.1">https://cloud.google.com/architecture/hybrid-and-multi-cloud-patterns-and-practices</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.41.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">For reasons we’ll discuss shortly, Tanzu Service Mesh is the ideal tool for teams tasked with securely and consistently delivering fixes and features while operating in complex </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">modern environments.</span></span></p>
<p><span class="koboSpan" id="kobo.44.1">In this chapter, we will cover </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">these topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.46.1">Why Tanzu </span><span class="No-Break"><span class="koboSpan" id="kobo.47.1">Service Mesh?</span></span></li>
<li><span class="koboSpan" id="kobo.48.1">Features and capabilities of Tanzu </span><span class="No-Break"><span class="koboSpan" id="kobo.49.1">Service Mesh</span></span></li>
<li><span class="koboSpan" id="kobo.50.1">How to get started with Tanzu </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">Service Mesh</span></span></li>
<li><span class="koboSpan" id="kobo.52.1">How to perform key day-2 operations on Tanzu </span><span class="No-Break"><span class="koboSpan" id="kobo.53.1">Service Mesh</span></span></li>
<li><span class="koboSpan" id="kobo.54.1">GSLB with NSX-T Advanced Load Balancer and Tanzu </span><span class="No-Break"><span class="koboSpan" id="kobo.55.1">Service Mesh</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.56.1">With that, let’s jump in and dive deep into why a team might need Tanzu </span><span class="No-Break"><span class="koboSpan" id="kobo.57.1">Service Mesh.</span></span></p>
<h1 id="_idParaDest-222"><a id="_idTextAnchor222"/><span class="koboSpan" id="kobo.58.1">Why Tanzu Service Mesh?</span></h1>
<p><span class="koboSpan" id="kobo.59.1">Tanzu Service Mesh is a tool built </span><a id="_idIndexMarker983"/><span class="koboSpan" id="kobo.60.1">expressly to enable the meaningful business outcomes we just described (fast time to value, elasticity, fault tolerance, and so on) while operating in the context of a hybrid or multi-cloud environment. </span><span class="koboSpan" id="kobo.60.2">Here are </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">some examples:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.62.1">How do we deliver a faster time to value when we have to update 100 dependent services whenever a core service moves from one cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.63.1">to another?</span></span></li>
<li><span class="koboSpan" id="kobo.64.1">Do we realize the full value of an elastic system if every cloud has a different process and toolset for deploying </span><span class="No-Break"><span class="koboSpan" id="kobo.65.1">and scaling?</span></span></li>
<li><span class="koboSpan" id="kobo.66.1">The same goes for detecting and remediating faults. </span><span class="koboSpan" id="kobo.66.2">Are we fully benefitting from a resilient system if we have to maintain different tools for monitoring, alerting, and remediating </span><span class="No-Break"><span class="koboSpan" id="kobo.67.1">across clouds?</span></span></li>
<li><span class="koboSpan" id="kobo.68.1">Let’s say that you were to invest the time and effort to centralize tooling and monitoring to work across multiple clouds. </span><span class="koboSpan" id="kobo.68.2">How do you keep your tech up to date as languages, frameworks, and technologies continue their inexorable forward march? </span><span class="koboSpan" id="kobo.68.3">Is the continued ongoing </span><span class="No-Break"><span class="koboSpan" id="kobo.69.1">investment worthwhile?</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.70.1">Tanzu Service Mesh</span><a id="_idIndexMarker984"/><span class="koboSpan" id="kobo.71.1"> sits squarely in the middle of this problem space, bringing the benefits of large, distributed microservice architectures to multi and hybrid cloud architectures. </span><span class="koboSpan" id="kobo.71.2">It may help to visualize the problem space: delivering business outcomes across clouds and on-premises, across multiple technologies </span><span class="No-Break"><span class="koboSpan" id="kobo.72.1">and frameworks:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer315">
<span class="koboSpan" id="kobo.73.1"><img alt="Figure 1﻿1.1 – Business outcomes across clouds and technologies" src="image/B18145_11_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.74.1">Figure 11.1 – Business outcomes across clouds and technologies</span></p>
<p><span class="koboSpan" id="kobo.75.1">Now that we’ve scratched the surface of why you would want to use this tool, let’s dive deep into the features and capabilities that enable </span><span class="No-Break"><span class="koboSpan" id="kobo.76.1">those </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.77.1">whys</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.78.1">.</span></span></p>
<h1 id="_idParaDest-223"><a id="_idTextAnchor223"/><span class="koboSpan" id="kobo.79.1">Features and capabilities of Tanzu Service Mesh</span></h1>
<p><span class="koboSpan" id="kobo.80.1">Here are eight concrete features that Tanzu Service Mesh provides. </span><span class="koboSpan" id="kobo.80.2">These features enable the specific capabilities necessary to accomplish what we described in the previous section: how we</span><a id="_idIndexMarker985"/><span class="koboSpan" id="kobo.81.1"> deliver tangible outcomes in a multi or hybrid </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">cloud environment:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.83.1">Out-of-the-box enablement of hybrid and multi-cloud architectures</span></strong><span class="koboSpan" id="kobo.84.1">: With a few clicks in the UI or API calls, you can onboard multiple different clouds and architectures (Kubernetes, legacy, serverless) into a single virtual space where you can quickly and easily stand up any of the various industry standard multi-cloud or hybrid </span><span class="No-Break"><span class="koboSpan" id="kobo.85.1">cloud architectures.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.86.1">Effortlessly move apps between clouds</span></strong><span class="koboSpan" id="kobo.87.1">: You can deploy your app in a different VPC, a different platform (VMs versus Kubernetes), or even an entirely different cloud provider without affecting dependent apps </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">and services.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.89.1">Automatic high availability</span></strong><span class="koboSpan" id="kobo.90.1">: You can deploy the same service to multiple clouds and the service mesh will automatically load balance between them. </span><span class="koboSpan" id="kobo.90.2">This includes transparently failing over from one cloud to another when the service fails in </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">one location.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.92.1">SLO tracking with AutoScaling</span></strong><span class="koboSpan" id="kobo.93.1">: Tanzu Service Mesh allows you to define </span><strong class="bold"><span class="koboSpan" id="kobo.94.1">Service-Level Objectives</span></strong><span class="koboSpan" id="kobo.95.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.96.1">SLOs</span></strong><span class="koboSpan" id="kobo.97.1">), track your error budget relative to the SLOs, and even autoscale services when SLOs aren’t </span><span class="No-Break"><span class="koboSpan" id="kobo.98.1">being met.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.99.1">End-to-end mTLS</span></strong><span class="koboSpan" id="kobo.100.1">: With zero operator effort or toil, Tanzu Service Mesh uses sidecars to secure all inter-service traffic in both directions. </span><span class="koboSpan" id="kobo.100.2">This allows for guaranteed client and server identity, which can be used to further secure </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">the services.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.102.1">Security policies and auditing</span></strong><span class="koboSpan" id="kobo.103.1">: With bi-directional TLS, client and server IDs are cryptographically guaranteed. </span><span class="koboSpan" id="kobo.103.2">This allows you to create airtight </span><em class="italic"><span class="koboSpan" id="kobo.104.1">allow</span></em><span class="koboSpan" id="kobo.105.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.106.1">deny</span></em><span class="koboSpan" id="kobo.107.1"> policies that dictate which services can communicate with </span><span class="No-Break"><span class="koboSpan" id="kobo.108.1">each other.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.109.1">Full workload visualization</span></strong><span class="koboSpan" id="kobo.110.1">: Tanzu Service Mesh gives a real-time visualization of all the services in the mesh, complete </span><span class="No-Break"><span class="koboSpan" id="kobo.111.1">with metrics.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.112.1">Tight control over deployments</span></strong><span class="koboSpan" id="kobo.113.1">: Tanzu Service Mesh gives you all the tools in the Istio toolbox to control rollouts of a service: traffic shaping, canary deploys, A/B testing, </span><span class="No-Break"><span class="koboSpan" id="kobo.114.1">and more.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.115.1">With those features, I hope </span><a id="_idIndexMarker986"/><span class="koboSpan" id="kobo.116.1">you now understand why you would use Tanzu Service Mesh. </span><span class="koboSpan" id="kobo.116.2">Now, let’s get our hands dirty and get started </span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">with it.</span></span></p>
<h1 id="_idParaDest-224"><a id="_idTextAnchor224"/><span class="koboSpan" id="kobo.118.1">How to get started with Tanzu Service Mesh</span></h1>
<p><span class="koboSpan" id="kobo.119.1">Tanzu Service Mesh </span><a id="_idIndexMarker987"/><span class="koboSpan" id="kobo.120.1">consists of controllers that install into your Kubernetes clusters as well as a central SaaS global control plane. </span><span class="koboSpan" id="kobo.120.2">The SaaS control plane does a </span><span class="No-Break"><span class="koboSpan" id="kobo.121.1">few things:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.122.1">Manages installation of Tanzu Service Mesh components onto </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">Kubernetes clusters</span></span></li>
<li><span class="koboSpan" id="kobo.124.1">Automatically updates those components </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">as necessary</span></span></li>
<li><span class="koboSpan" id="kobo.126.1">Sends global configuration down to those controllers (for example, the location of services on </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">other clusters)</span></span></li>
<li><span class="koboSpan" id="kobo.128.1">Manages and deploys policies on the </span><span class="No-Break"><span class="koboSpan" id="kobo.129.1">Kubernetes clusters</span></span></li>
<li><span class="koboSpan" id="kobo.130.1">Gathers metrics to enable visualization </span><span class="No-Break"><span class="koboSpan" id="kobo.131.1">and SLOs</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.132.1">To get started with Tanzu Service Mesh, let’s log into our VMware Cloud Services Console and select the </span><strong class="bold"><span class="koboSpan" id="kobo.133.1">Tanzu Service Mesh</span></strong><span class="koboSpan" id="kobo.134.1"> tile from the list </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">of services.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.136.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.137.1">Tanzu Service Mesh is the one product in this book that’s neither free to use nor provides a self-service avenue to enable a trial. </span><span class="koboSpan" id="kobo.137.2">If you don’t currently have a license for Tanzu Service Mesh, you’ll need to reach out to your VMware Account Executive to set up a trial. </span><span class="koboSpan" id="kobo.137.3">If that’s not possible, much of what we’ll cover in this section is also included in a free VMware hands-on lab for Tanzu Service Mesh located </span><span class="No-Break"><span class="koboSpan" id="kobo.138.1">here: </span></span><a href="https://labs.hol.vmware.com/HOL/catalogs/lab/8509"><span class="No-Break"><span class="koboSpan" id="kobo.139.1">https://labs.hol.vmware.com/HOL/catalogs/lab/8509</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.140.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.141.1">The VMware Cloud Services Console is located </span><span class="No-Break"><span class="koboSpan" id="kobo.142.1">here: </span></span><span class="No-Break"><span class="koboSpan" id="kobo.143.1">https://console.cloud.vmware.com/csp/gateway/portal/#/consumer/services/organization</span></span><span class="No-Break"><span class="koboSpan" id="kobo.144.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.145.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.146.1">Launch Service</span></strong><span class="koboSpan" id="kobo.147.1"> from the </span><strong class="bold"><span class="koboSpan" id="kobo.148.1">Tanzu Service Mesh</span></strong><span class="koboSpan" id="kobo.149.1"> tile, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer316">
<span class="koboSpan" id="kobo.151.1"><img alt="Figure 1﻿1.2 – Launching Tanzu Service Mesh" src="image/B18145_11_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.152.1">Figure 11.2 – Launching Tanzu Service Mesh</span></p>
<p><span class="koboSpan" id="kobo.153.1">Once we launch the </span><a id="_idIndexMarker988"/><span class="koboSpan" id="kobo.154.1">Tanzu Service Mesh app, we’re ready to onboard our </span><span class="No-Break"><span class="koboSpan" id="kobo.155.1">Kubernetes clusters.</span></span></p>
<h2 id="_idParaDest-225"><a id="_idTextAnchor225"/><span class="koboSpan" id="kobo.156.1">Onboarding Kubernetes clusters</span></h2>
<p><span class="koboSpan" id="kobo.157.1">This example</span><a id="_idIndexMarker989"/><span class="koboSpan" id="kobo.158.1"> requires two separate clusters with the ability to create </span><strong class="source-inline"><span class="koboSpan" id="kobo.159.1">LoadBalancer</span></strong><span class="koboSpan" id="kobo.160.1"> services. </span><span class="koboSpan" id="kobo.160.2">You can refer to the </span><em class="italic"><span class="koboSpan" id="kobo.161.1">Appendix</span></em><span class="koboSpan" id="kobo.162.1"> to explore your options for standing up Kubernetes clusters. </span><span class="koboSpan" id="kobo.162.2">For this exercise, I’d strongly recommend using one of the public cloud offerings (EKS, AKS, GKE, or TKG on the public cloud) simply because they make it very easy to stand up </span><strong class="source-inline"><span class="koboSpan" id="kobo.163.1">LoadBalancer</span></strong><span class="koboSpan" id="kobo.164.1"> services, which are a must-have for </span><span class="No-Break"><span class="koboSpan" id="kobo.165.1">this exercise.</span></span></p>
<p><span class="koboSpan" id="kobo.166.1">Here are the steps to onboard </span><span class="No-Break"><span class="koboSpan" id="kobo.167.1">your clusters:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.168.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.169.1">New Workflow</span></strong><span class="koboSpan" id="kobo.170.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.171.1">Onboard </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.172.1">New Cluster</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.173.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.174.1">In the dialog, give your cluster a name (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">cluster-1</span></strong><span class="koboSpan" id="kobo.176.1">) and click </span><strong class="bold"><span class="koboSpan" id="kobo.177.1">Generate Security Token</span></strong><span class="koboSpan" id="kobo.178.1">. </span><span class="koboSpan" id="kobo.178.2">This will generate some credentials that your Kubernetes cluster will use to connect to the SaaS </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">control plane.</span></span></li>
<li><span class="koboSpan" id="kobo.180.1">From your terminal, make </span><a id="_idIndexMarker990"/><span class="koboSpan" id="kobo.181.1">sure that you have kubectl pointed to your </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">first cluster:</span></span><pre class="console"><span class="koboSpan" id="kobo.183.1">
ubuntu@ip-172-31-33-59 ~&gt; kubectl config get-contexts</span></pre><pre class="console"><span class="koboSpan" id="kobo.184.1">
CURRENT   NAME          CLUSTER             AUTHINFO                    NAMESPACE</span></pre><pre class="console"><span class="koboSpan" id="kobo.185.1">
*         user@eks-tsm-1.us-west-2.eksctl.io               eks-tsm-1.us-west-2.eksctl.io                            acmedemo-tkg@eks-tsm-1.us-west-2.eksctl.io</span></pre><pre class="console"><span class="koboSpan" id="kobo.186.1">
          user@eks-tsm-2.us-west-2.eksctl.io               eks-tsm-2.us-west-2.eksctl.io                            acmedemo-tkg@eks-tsm-2.us-west-2.eksctl.io</span></pre></li>
<li><span class="koboSpan" id="kobo.187.1">Then, copy each of the kubectl commands from the UI into </span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">your terminal:</span></span><pre class="console"><span class="koboSpan" id="kobo.189.1">
ubuntu@ip-172-31-33-59 ~&gt; kubectl apply -f  'https://prod-4.nsxservicemesh.vmware.com/tsm/v1alpha2/projects/default/clusters/onboarding-manifest?tenant=b011ef56-1670-4d99-9179-0000000000000'</span></pre><pre class="console"><span class="koboSpan" id="kobo.190.1">
namespace/vmware-system-tsm created</span></pre><pre class="console"><span class="koboSpan" id="kobo.191.1">
customresourcedefinition.apiextensions.k8s.io/aspclusters.allspark.vmware.com created</span></pre><pre class="console"><span class="koboSpan" id="kobo.192.1">
customresourcedefinition.apiextensions.k8s.io/clusters.client.cluster.tsm.tanzu.vmware.com created</span></pre><pre class="console"><span class="koboSpan" id="kobo.193.1">
customresourcedefinition.apiextensions.k8s.io/tsmclusters.tsm.vmware.com created</span></pre><pre class="console"><span class="koboSpan" id="kobo.194.1">
customresourcedefinition.apiextensions.k8s.io/clusterhealths.client.cluster.tsm.tanzu.vmware.com created</span></pre><pre class="console"><span class="koboSpan" id="kobo.195.1">
configmap/tsm-agent-operator created</span></pre><pre class="console"><span class="koboSpan" id="kobo.196.1">
serviceaccount/tsm-agent-operator-deployer created</span></pre><pre class="console"><span class="koboSpan" id="kobo.197.1">
clusterrole.rbac.authorization.k8s.io/tsm-agent-operator-cluster-role created</span></pre><pre class="console"><span class="koboSpan" id="kobo.198.1">
role.rbac.authorization.k8s.io/vmware-system-tsm-namespace-admin-role created</span></pre><pre class="console"><span class="koboSpan" id="kobo.199.1">
clusterrolebinding.rbac.authorization.k8s.io/tsm-agent-operator-crb created</span></pre><pre class="console"><span class="koboSpan" id="kobo.200.1">
rolebinding.rbac.authorization.k8s.io/tsm-agent-operator-rb created</span></pre><pre class="console"><span class="koboSpan" id="kobo.201.1">
deployment.apps/tsm-agent-operator created</span></pre><pre class="console"><span class="koboSpan" id="kobo.202.1">
job.batch/update-scc-job created</span></pre><pre class="console"><span class="koboSpan" id="kobo.203.1">
ubuntu@ip-172-31-33-59 ~&gt; kubectl -n vmware-system-tsm create secret generic cluster-token --from-literal=token=eyJhb…</span></pre><pre class="console"><span class="koboSpan" id="kobo.204.1">
secret/cluster-token created</span></pre></li>
</ol>
<p><span class="koboSpan" id="kobo.205.1">The first command</span><a id="_idIndexMarker991"/><span class="koboSpan" id="kobo.206.1"> installs the control plane components. </span><span class="koboSpan" id="kobo.206.2">These components will turn around and install Istio locally, as well as check in with the global SaaS control plane to check </span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">for updates.</span></span></p>
<p><span class="koboSpan" id="kobo.208.1">The second command creates a Kubernetes secret that will be used to authenticate to the global SaaS </span><span class="No-Break"><span class="koboSpan" id="kobo.209.1">control plane.</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.210.1">Finally, click the green </span><strong class="bold"><span class="koboSpan" id="kobo.211.1">Install Tanzu Service Mesh</span></strong><span class="koboSpan" id="kobo.212.1"> button. </span><span class="koboSpan" id="kobo.212.2">That will instruct the components running on your Kubernetes cluster to pull down and install the Istio data </span><span class="No-Break"><span class="koboSpan" id="kobo.213.1">plane components.</span></span></li>
<li><span class="koboSpan" id="kobo.214.1">Repeat this entire process for your second </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">Kubernetes cluster.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.216.1">At this point, you should have Tanzu Service Mesh up and running on both of your clusters and they should be visible in the Tanzu Service Mesh UI in the </span><strong class="bold"><span class="koboSpan" id="kobo.217.1">Clusters</span></strong><span class="koboSpan" id="kobo.218.1"> pane. </span><span class="koboSpan" id="kobo.218.2">You should see something like what’s shown in the following screenshot. </span><span class="koboSpan" id="kobo.218.3">You’ll notice that we have four nodes</span><a id="_idIndexMarker992"/><span class="koboSpan" id="kobo.219.1"> on each cluster but no </span><span class="No-Break"><span class="koboSpan" id="kobo.220.1">services yet:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer317">
<span class="koboSpan" id="kobo.221.1"><img alt="Figure 1﻿1.3 – Two clusters onboarded" src="image/B18145_11_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.222.1">Figure 11.3 – Two clusters onboarded</span></p>
<p><span class="koboSpan" id="kobo.223.1">Next, we’ll need to create a namespace in each cluster that we’ll use as our Global Namespace in Tanzu </span><span class="No-Break"><span class="koboSpan" id="kobo.224.1">Service Mesh.</span></span></p>
<h2 id="_idParaDest-226"><a id="_idTextAnchor226"/><span class="koboSpan" id="kobo.225.1">Creating a Tanzu Service Mesh Global Namespace</span></h2>
<p><span class="koboSpan" id="kobo.226.1">A </span><strong class="bold"><span class="koboSpan" id="kobo.227.1">Global Namespace</span></strong><span class="koboSpan" id="kobo.228.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.229.1">GNS</span></strong><span class="koboSpan" id="kobo.230.1">) is a</span><a id="_idIndexMarker993"/><span class="koboSpan" id="kobo.231.1"> logical namespace in Tanzu Service Mesh that can span multiple clusters. </span><span class="koboSpan" id="kobo.231.2">In our case, we’ll create a Global Namespace called </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">acme</span></strong><span class="koboSpan" id="kobo.233.1"> in each cluster. </span><span class="koboSpan" id="kobo.233.2">Now, all the services in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.234.1">acme</span></strong><span class="koboSpan" id="kobo.235.1"> namespace on cluster 1 can see all the services in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">acme</span></strong><span class="koboSpan" id="kobo.237.1"> namespace on cluster 2, and vice versa. </span><span class="koboSpan" id="kobo.237.2">Here’s how we go about creating the GNS across our two </span><span class="No-Break"><span class="koboSpan" id="kobo.238.1">onboarded clusters:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.239.1">Go ahead and create </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">the namespaces:</span></span><pre class="console"><span class="koboSpan" id="kobo.241.1">
ubuntu@ip-172-31-33-59 ~&gt; kubectl config use-context   acmedemo-tkg@eks-tsm-1.us-west-2.eksctl.io # target the 1st cluster</span></pre><pre class="console"><span class="koboSpan" id="kobo.242.1">
Switched to context "acmedemo-tkg@eks-tsm-1.us-west-2.eksctl.io".</span></pre><pre class="console"><span class="koboSpan" id="kobo.243.1">
ubuntu@ip-172-31-33-59 ~&gt; kubectl create ns acme</span></pre><pre class="console"><span class="koboSpan" id="kobo.244.1">
namespace/acme created</span></pre><pre class="console"><span class="koboSpan" id="kobo.245.1">
ubuntu@ip-172-31-33-59 ~&gt; kubectl config use-context  acmedemo-tkg@eks-tsm-2.us-west-2.eksctl.io # target the 1st cluster</span></pre><pre class="console"><span class="koboSpan" id="kobo.246.1">
Switched to context "acmedemo-tkg@eks-tsm-2.us-west-2.eksctl.io".</span></pre><pre class="console"><span class="koboSpan" id="kobo.247.1">
ubuntu@ip-172-31-33-59 ~&gt; kubectl create ns acme</span></pre><pre class="console"><span class="koboSpan" id="kobo.248.1">
namespace/acme created</span></pre></li>
<li><span class="koboSpan" id="kobo.249.1">Next, we must create the logical GNS in the Tanzu Service Mesh UI. </span><span class="koboSpan" id="kobo.249.2">Here are the steps at a </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">high level:</span></span><ol><li><span class="koboSpan" id="kobo.251.1">Select </span><strong class="bold"><span class="koboSpan" id="kobo.252.1">New Workflow</span></strong><span class="koboSpan" id="kobo.253.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.254.1">New </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.255.1">Global Namespace</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">.</span></span></li><li><span class="koboSpan" id="kobo.257.1">Enter the name of the Global Namespace. </span><span class="koboSpan" id="kobo.257.2">I </span><span class="No-Break"><span class="koboSpan" id="kobo.258.1">used </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.259.1">acme-gns</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.260.1">.</span></span></li><li><span class="koboSpan" id="kobo.261.1">Select a domain for the GNS. </span><span class="koboSpan" id="kobo.261.2">This will be how services find each other, so I’d recommend against something that may need to resolve via DNS (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.262.1">acme.com</span></strong><span class="koboSpan" id="kobo.263.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.264.1">mygns.net</span></strong><span class="koboSpan" id="kobo.265.1">). </span><span class="koboSpan" id="kobo.265.2">Instead, I chose to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.266.1">devsecops-acme.gns</span></strong><span class="koboSpan" id="kobo.267.1"> as something that won’t be confused with a public domain name. </span><span class="koboSpan" id="kobo.267.2">For future steps to work without additional changes, I’d recommend using the same domain for </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">your GNS.</span></span></li><li><span class="koboSpan" id="kobo.269.1">You should see</span><a id="_idIndexMarker994"/><span class="koboSpan" id="kobo.270.1"> something like </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">the following:</span></span></li></ol></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer318">
<span class="koboSpan" id="kobo.272.1"><img alt="Figure 1﻿1.4 – Naming and selecting a unique domain" src="image/B18145_11_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.273.1">Figure 11.4 – Naming and selecting a unique domain</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.274.1">Next, we’ll need to map the </span><strong class="source-inline"><span class="koboSpan" id="kobo.275.1">acme</span></strong><span class="koboSpan" id="kobo.276.1"> namespace within each of our two clusters to this GNS on the </span><strong class="bold"><span class="koboSpan" id="kobo.277.1">Namespace Mapping</span></strong><span class="koboSpan" id="kobo.278.1"> screen, as per the </span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer319">
<span class="koboSpan" id="kobo.280.1"><img alt="Figure 1﻿1.5 – Global Namespace Mapping" src="image/B18145_11_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.281.1">Figure 11.5 – Global Namespace Mapping</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.282.1">For the remaining </span><a id="_idIndexMarker995"/><span class="koboSpan" id="kobo.283.1">screens, you can accept the defaults. </span><span class="koboSpan" id="kobo.283.2">In the end, you should see your GNS in the </span><strong class="bold"><span class="koboSpan" id="kobo.284.1">GNS Overview</span></strong><span class="koboSpan" id="kobo.285.1"> tab in </span><span class="No-Break"><span class="koboSpan" id="kobo.286.1">the UI:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer320">
<span class="koboSpan" id="kobo.287.1"><img alt="Figure 1﻿1.6 – New GNS" src="image/B18145_11_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.288.1">Figure 11.6 – New GNS</span></p>
<p><span class="koboSpan" id="kobo.289.1">Now that our GNS is up and running, it’s time to deploy some services to our clusters that will communicate over</span><a id="_idIndexMarker996"/> <span class="No-Break"><span class="koboSpan" id="kobo.290.1">the GNS.</span></span></p>
<h2 id="_idParaDest-227"><a id="_idTextAnchor227"/><span class="koboSpan" id="kobo.291.1">Installing services</span></h2>
<p><span class="koboSpan" id="kobo.292.1">The files in the following steps will install a simple microservice-based application called </span><em class="italic"><span class="koboSpan" id="kobo.293.1">Acme Fitness</span></em><span class="koboSpan" id="kobo.294.1">. </span><span class="koboSpan" id="kobo.294.2">If you chose </span><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">devsecops-acme.gns</span></strong><span class="koboSpan" id="kobo.296.1"> as your domain, you can deploy these files as-is; otherwise, you’ll need to </span><a id="_idIndexMarker997"/><span class="koboSpan" id="kobo.297.1">update the internal references to reflect your domain name. </span><span class="koboSpan" id="kobo.297.2">The manifests can be found </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">here: </span></span><a href="https://github.com/PacktPublishing/DevSecOps-in-Practice-with-VMware-Tanzu/tree/main/chapter-12"><span class="No-Break"><span class="koboSpan" id="kobo.299.1">https://github.com/PacktPublishing/DevSecOps-in-Practice-with-VMware-Tanzu/tree/main/chapter-12</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.300.1">:</span></span></p>
<p><span class="koboSpan" id="kobo.301.1">Make sure you’re pointing to your first Kubernetes cluster and deploying the YAML manifest for </span><strong class="source-inline"><span class="koboSpan" id="kobo.302.1">cluster-1</span></strong><span class="koboSpan" id="kobo.303.1">. </span><span class="koboSpan" id="kobo.303.2">It’s important to note </span><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">-n acme</span></strong><span class="koboSpan" id="kobo.305.1"> at the end of the commands. </span><span class="koboSpan" id="kobo.305.2">You need to explicitly declare that these services are to be deployed to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.306.1">acme</span></strong><span class="koboSpan" id="kobo.307.1"> namespace. </span><span class="koboSpan" id="kobo.307.2">This will install a </span><span class="No-Break"><span class="koboSpan" id="kobo.308.1">few things:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.309.1">Secrets that apps will use to talk to their </span><span class="No-Break"><span class="koboSpan" id="kobo.310.1">data services.</span></span></li>
<li><span class="koboSpan" id="kobo.311.1">Several data services (MongoDB, Redis, and </span><span class="No-Break"><span class="koboSpan" id="kobo.312.1">so on).</span></span></li>
<li><span class="koboSpan" id="kobo.313.1">Some </span><span class="No-Break"><span class="koboSpan" id="kobo.314.1">microservice-based applications.</span></span></li>
<li><span class="koboSpan" id="kobo.315.1">A gateway, which is like a virtual L7 load balancer that tells Tanzu Service Mesh where to route certain incoming requests. </span><span class="koboSpan" id="kobo.315.2">In our case, this is the only external-facing application running on the cluster, so we’ll route all requests coming in from outside the cluster to our frontend service, which we have </span><span class="No-Break"><span class="koboSpan" id="kobo.316.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">shopping</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.318.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.319.1">Then, switch to </span><strong class="source-inline"><span class="koboSpan" id="kobo.320.1">cluster-2</span></strong><span class="koboSpan" id="kobo.321.1"> and deploy that manifest. </span><span class="koboSpan" id="kobo.321.2">Here are the commands I used to deploy the services into both of my </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">Kubernetes clusters:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.323.1">
ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt; kubectl config use-context  acmedemo-tkg@eks-tsm-1.us-west-2.eksctl.io # target the 1st cluster
Switched to context "acmedemo-tkg@eks-tsm-1.us-west-2.eksctl.io".
</span><span class="koboSpan" id="kobo.323.2">ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt; kubectl get all -n acme
No resources found in acme namespace.
</span><span class="koboSpan" id="kobo.323.3">ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt; kubectl apply -f ./cluster1.yaml -n acme
secret/redis-pass created
secret/order-mongo-pass created
secret/users-mongo-pass created
gateway.networking.istio.io/acme-gateway created
virtualservice.networking.istio.io/acme created
service/cart-redis created
deployment.apps/cart-redis created
service/cart created
deployment.apps/cart created
service/shopping created
deployment.apps/shopping created
service/order-mongo created
deployment.apps/order-mongo created
service/order created
deployment.apps/order created
service/payment created
deployment.apps/payment created
configmap/users-initdb-config created
service/users-mongo created
deployment.apps/users-mongo created
service/users created
deployment.apps/users created
ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt; kubectl config use-context  acmedemo-tkg@eks-tsm-2.us-west-2.eksctl.io # target the 2nd cluster
Switched to context "acmedemo-tkg@eks-tsm-2.us-west-2.eksctl.io".
</span><span class="koboSpan" id="kobo.323.4">ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt; kubectl apply -f ./cluster2.yaml -n acme
secret/catalog-mongo-pass created
configmap/catalog-initdb-config created
service/catalog-mongo created
deployment.apps/catalog-mongo created
service/catalog created
deployment.apps/catalog created
ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt;</span></pre>
<h2 id="_idParaDest-228"><a id="_idTextAnchor228"/><span class="koboSpan" id="kobo.324.1">Accessing the application</span></h2>
<p><span class="koboSpan" id="kobo.325.1">Now that we’ve installed the </span><a id="_idIndexMarker998"/><span class="koboSpan" id="kobo.326.1">services across two clusters, let’s verify that the app is up and running. </span><span class="koboSpan" id="kobo.326.2">Switch your kubectl context back to the first cluster and get the details of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">istio-ingressgateway</span></strong><span class="koboSpan" id="kobo.328.1"> service in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.329.1">istio-system</span></strong><span class="koboSpan" id="kobo.330.1"> namespace. </span><span class="koboSpan" id="kobo.330.2">If you’re running on EKS, you might get the hostname of a load balancer; otherwise, you may see an IPv4 address. </span><span class="koboSpan" id="kobo.330.3">Grab the hostname or external IP and plug it into your browser using </span><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">http</span></strong><span class="koboSpan" id="kobo.332.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.333.1">not </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.334.1">https</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.335.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.336.1">Here’s how I got the service. </span><span class="koboSpan" id="kobo.336.2">Notice that I’m pointed at the first cluster and I’m on EKS, so I’m getting a load balancer hostname as my </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.337.1">external IP</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.338.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.339.1">
ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt; kubectl get svc -n istio-system istio-ingressgateway
NAME                   TYPE           CLUSTER-IP    EXTERNAL-IP                       PORT(S)                AGE
istio-ingressgateway   LoadBalancer   10.100.7.70   a075e7d12da464c16a17e0aa0435fdbe-2ff7515fc9cc6551.elb.us-west-2.amazonaws.com   15021:30588/TCP,80:31893/TCP,443:31157/TCP   22h
ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt;</span></pre>
<p><span class="koboSpan" id="kobo.340.1">And here’s what you’d expect to see in the browser. </span><span class="koboSpan" id="kobo.340.2">If the yoga mat and water bottle images appear, then you</span><a id="_idIndexMarker999"/><span class="koboSpan" id="kobo.341.1"> know everything is working. </span><span class="koboSpan" id="kobo.341.2">The page itself is hosted in cluster 1 and the catalog is hosted in </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">cluster 2!</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer321">
<span class="koboSpan" id="kobo.343.1"><img alt="Figure 1﻿1.7 – Acme Fitness deployed across two clusters" src="image/B18145_11_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.344.1">Figure 11.7 – Acme Fitness deployed across two clusters</span></p>
<p><span class="koboSpan" id="kobo.345.1">Next, we’ll need to generate some inter-service traffic so that the Tanzu Service Mesh UI can visualize all </span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">the connections.</span></span></p>
<h2 id="_idParaDest-229"><a id="_idTextAnchor229"/><span class="koboSpan" id="kobo.347.1">Generating application traffic</span></h2>
<p><span class="koboSpan" id="kobo.348.1">Here are some things you </span><a id="_idIndexMarker1000"/><span class="koboSpan" id="kobo.349.1">can do to make sure that all the services get </span><span class="No-Break"><span class="koboSpan" id="kobo.350.1">some traffic:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.351.1">Click the login button next to the </span><span class="No-Break"><span class="koboSpan" id="kobo.352.1">shopping cart.</span></span></li>
<li><span class="koboSpan" id="kobo.353.1">Log in with the following credentials – username: </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">dwight</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.355.1">password: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.356.1">vmware1!</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.358.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.359.1">Catalog</span></strong><span class="koboSpan" id="kobo.360.1"> link at the top of </span><span class="No-Break"><span class="koboSpan" id="kobo.361.1">the screen.</span></span></li>
<li><span class="koboSpan" id="kobo.362.1">Browse to </span><span class="No-Break"><span class="koboSpan" id="kobo.363.1">an item.</span></span></li>
<li><span class="koboSpan" id="kobo.364.1">Add it to </span><span class="No-Break"><span class="koboSpan" id="kobo.365.1">your cart.</span></span></li>
<li><span class="koboSpan" id="kobo.366.1">Click the </span><strong class="bold"><span class="koboSpan" id="kobo.367.1">Shopping </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.368.1">Cart</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.369.1"> button.</span></span></li>
<li><span class="koboSpan" id="kobo.370.1">Click </span><strong class="bold"><span class="koboSpan" id="kobo.371.1">Proceed </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.372.1">to Checkout</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.373.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.374.1">Go through the checkout process. </span><span class="koboSpan" id="kobo.374.2">Any 16-digit number will work for a credit </span><span class="No-Break"><span class="koboSpan" id="kobo.375.1">card number.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.376.1">Now, we can return to</span><a id="_idIndexMarker1001"/><span class="koboSpan" id="kobo.377.1"> the GNS screen for our </span><strong class="source-inline"><span class="koboSpan" id="kobo.378.1">acme-gns</span></strong><span class="koboSpan" id="kobo.379.1"> in the Tanzu Service Mesh UI. </span><span class="koboSpan" id="kobo.379.2">You should see all the services spread across the two clusters, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.380.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer322">
<span class="koboSpan" id="kobo.381.1"><img alt="Figure 1﻿1.8 – Tanzu Service Mesh service visualization" src="image/B18145_11_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.382.1">Figure 11.8 – Tanzu Service Mesh service visualization</span></p>
<p><span class="koboSpan" id="kobo.383.1">At this point, you have successfully done </span><span class="No-Break"><span class="koboSpan" id="kobo.384.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.385.1">Stood up a new </span><span class="No-Break"><span class="koboSpan" id="kobo.386.1">Service Mesh</span></span></li>
<li><span class="koboSpan" id="kobo.387.1">Onboarded </span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">multiple clusters</span></span></li>
<li><span class="koboSpan" id="kobo.389.1">Federated them into </span><span class="No-Break"><span class="koboSpan" id="kobo.390.1">a GNS</span></span></li>
<li><span class="koboSpan" id="kobo.391.1">Deployed a </span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">distributed app</span></span></li>
<li><span class="koboSpan" id="kobo.393.1">Verified the app’s functionality and </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">cross-cluster communications</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.395.1">That’s an impressive list </span><a id="_idIndexMarker1002"/><span class="koboSpan" id="kobo.396.1">for day one. </span><span class="koboSpan" id="kobo.396.2">Now, let’s move on to some operations you may consider after you’ve accomplished your </span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">day-1 checklist.</span></span></p>
<h1 id="_idParaDest-230"><a id="_idTextAnchor230"/><span class="koboSpan" id="kobo.398.1">How to perform key day-2 operations on Tanzu Service Mesh</span></h1>
<p><span class="koboSpan" id="kobo.399.1">At this point, we have a</span><a id="_idIndexMarker1003"/><span class="koboSpan" id="kobo.400.1"> distributed application successfully working across two Kubernetes clusters. </span><span class="koboSpan" id="kobo.400.2">If you were doing this in a real production environment, there are some </span><em class="italic"><span class="koboSpan" id="kobo.401.1">day-2</span></em><span class="koboSpan" id="kobo.402.1"> concerns you’d want to address. </span><span class="koboSpan" id="kobo.402.2">For example, it’s great that the catalog service can run on a separate cluster, but what if that cluster goes down? </span><span class="koboSpan" id="kobo.402.3">How could we load balance across instances on </span><span class="No-Break"><span class="koboSpan" id="kobo.403.1">multiple clusters?</span></span></p>
<p><span class="koboSpan" id="kobo.404.1">Furthermore, we’re living in </span><a id="_idIndexMarker1004"/><span class="koboSpan" id="kobo.405.1">a world where deployment, upkeep, measuring, and </span><a id="_idIndexMarker1005"/><span class="koboSpan" id="kobo.406.1">monitoring of services are often the responsibility of </span><strong class="bold"><span class="koboSpan" id="kobo.407.1">Site Reliability Engineers</span></strong><span class="koboSpan" id="kobo.408.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.409.1">SREs</span></strong><span class="koboSpan" id="kobo.410.1">). </span><span class="koboSpan" id="kobo.410.2">If you were the SRE for Acme Fitness, you would have already identified </span><strong class="bold"><span class="koboSpan" id="kobo.411.1">Service-Level Indicators</span></strong><span class="koboSpan" id="kobo.412.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.413.1">SLIs</span></strong><span class="koboSpan" id="kobo.414.1">) and </span><a id="_idIndexMarker1006"/><span class="koboSpan" id="kobo.415.1">defined SLOs for your services. </span><span class="koboSpan" id="kobo.415.2">Tanzu Service Mesh greatly simplifies this by allowing you to define your SLIs and SLOs right in the Tanzu Service Mesh UI and measure how your services are meeting those SLOs using </span><span class="No-Break"><span class="koboSpan" id="kobo.416.1">real-time metrics.</span></span></p>
<h2 id="_idParaDest-231"><a id="_idTextAnchor231"/><span class="koboSpan" id="kobo.417.1">Enabling service high availability</span></h2>
<p><span class="koboSpan" id="kobo.418.1">First, let’s address making a service highly </span><a id="_idIndexMarker1007"/><span class="koboSpan" id="kobo.419.1">available. </span><span class="koboSpan" id="kobo.419.2">In our example app, most of the services are on </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">cluster-1</span></strong><span class="koboSpan" id="kobo.421.1">, while the catalog and its data store are on </span><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">cluster-2</span></strong><span class="koboSpan" id="kobo.423.1">. </span><span class="koboSpan" id="kobo.423.2">Tanzu Service Mesh lets us stand up additional instances of a service across multiple clusters and automatically load balances between all the instances as they </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">come online.</span></span></p>
<p><span class="koboSpan" id="kobo.425.1">For our purposes, let’s just deploy another instance of the catalog service onto </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">cluster-1</span></strong><span class="koboSpan" id="kobo.427.1">. </span><span class="koboSpan" id="kobo.427.2">We can do that very easily by targeting </span><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">cluster-1</span></strong><span class="koboSpan" id="kobo.429.1"> and applying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.430.1">cluster-2</span></strong><span class="koboSpan" id="kobo.431.1"> deployment manifest, </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">like so:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.433.1">
ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt; kubectl config use-context  acmedemo-tkg@eks-tsm-1.us-west-2.eksctl.io # target cluster 1
Switched to context "acmedemo-tkg@eks-tsm-1.us-west-2.eksctl.io".
</span><span class="koboSpan" id="kobo.433.2">ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt; kubectl apply -f ./cluster2.yaml -n acme # this will land the catalog service on cluster 1
secret/catalog-mongo-pass created
configmap/catalog-initdb-config created
service/catalog-mongo created
deployment.apps/catalog-mongo created
service/catalog created
deployment.apps/catalog created
ubuntu@ip-172-31-33-59 ~/c/D/chapter-12 (main)&gt;</span></pre>
<p><span class="koboSpan" id="kobo.434.1">Now, if we go back to the</span><a id="_idIndexMarker1008"/><span class="koboSpan" id="kobo.435.1"> app and access the catalog a few times, we should see a visualization like the one shown in the following screenshot. </span><span class="koboSpan" id="kobo.435.2">Notice how Tanzu Service Mesh automatically load balances between the two catalog instances: one in </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">cluster-1</span></strong><span class="koboSpan" id="kobo.437.1"> and the other </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.439.1">cluster-2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.440.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer323">
<span class="koboSpan" id="kobo.441.1"><img alt="Figure 1﻿1.9 – Automatic load balancing across multiple clusters" src="image/B18145_11_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.442.1">Figure 11.9 – Automatic load balancing across multiple clusters</span></p>
<p><span class="koboSpan" id="kobo.443.1">Next, let’s track </span><span class="No-Break"><span class="koboSpan" id="kobo.444.1">some</span></span><span class="No-Break"><a id="_idIndexMarker1009"/></span><span class="No-Break"><span class="koboSpan" id="kobo.445.1"> SLOs.</span></span></p>
<h2 id="_idParaDest-232"><a id="_idTextAnchor232"/><span class="koboSpan" id="kobo.446.1">Defining and measuring SLOs</span></h2>
<p><span class="koboSpan" id="kobo.447.1">For this task, we’ll walk through the desired outcome and the steps we follow to achieve that outcome. </span><span class="koboSpan" id="kobo.447.2">We’ll show</span><a id="_idIndexMarker1010"/><span class="koboSpan" id="kobo.448.1"> some screenshots</span><a id="_idIndexMarker1011"/><span class="koboSpan" id="kobo.449.1"> along the way so we can double-check our work. </span><span class="koboSpan" id="kobo.449.2">Then, we’ll talk about what the various </span><span class="No-Break"><span class="koboSpan" id="kobo.450.1">fields represent.</span></span></p>
<h3><span class="koboSpan" id="kobo.451.1">Desired outcome</span></h3>
<p><span class="koboSpan" id="kobo.452.1">Let’s say that we’re the SREs for Acme Fitness and we have an SLO for the catalog service that it be up and healthy 99.99% of the time, sometimes called </span><em class="italic"><span class="koboSpan" id="kobo.453.1">four nines uptime</span></em><span class="koboSpan" id="kobo.454.1">. </span><span class="koboSpan" id="kobo.454.2">In our case, we define </span><em class="italic"><span class="koboSpan" id="kobo.455.1">healthy</span></em><span class="koboSpan" id="kobo.456.1"> as having 90% of our requests complete within </span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">100 milliseconds.</span></span></p>
<p><span class="koboSpan" id="kobo.458.1">Let’s go into the</span><a id="_idIndexMarker1012"/><span class="koboSpan" id="kobo.459.1"> Tanzu Service Mesh UI and define this SLO so that we can have Tanzu Service Mesh accurately measure how well we’re meeting </span><span class="No-Break"><span class="koboSpan" id="kobo.460.1">this SLO.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.461.1">Site Reliability Engineering</span></p>
<p class="callout"><span class="koboSpan" id="kobo.462.1">If you’re not familiar with the concepts of SREs, SLOs, and SLIs, I’d strongly recommend reading the </span><em class="italic"><span class="koboSpan" id="kobo.463.1">Site Reliability Engineering</span></em><span class="koboSpan" id="kobo.464.1"> book. </span><span class="koboSpan" id="kobo.464.2">You can get an eBook or hard copy from the usual sources, or you can read it for</span><a id="_idIndexMarker1013"/><span class="koboSpan" id="kobo.465.1"> free online from the Google SRE </span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">website: </span></span><a href="https://sre.google/"><span class="No-Break"><span class="koboSpan" id="kobo.467.1">https://sre.google/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.468.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.469.1">Implementing the SLO</span></h3>
<p><span class="koboSpan" id="kobo.470.1">From the Tanzu Service</span><a id="_idIndexMarker1014"/><span class="koboSpan" id="kobo.471.1"> Mesh UI, navigate to </span><strong class="bold"><span class="koboSpan" id="kobo.472.1">New Workflow</span></strong><span class="koboSpan" id="kobo.473.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.474.1">New SLO Policy</span></strong><span class="koboSpan" id="kobo.475.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.476.1">Monitored SLO</span></strong><span class="koboSpan" id="kobo.477.1">. </span><span class="koboSpan" id="kobo.477.2">This will launch </span><a id="_idIndexMarker1015"/><span class="koboSpan" id="kobo.478.1">a wizard. </span><span class="koboSpan" id="kobo.478.2">You can fill in the first screen’s form values </span><span class="No-Break"><span class="koboSpan" id="kobo.479.1">as follows:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.480.1">SLO </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.481.1">Name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.482.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">acme-catalog-health</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.484.1">Policy Scope</span></strong><span class="koboSpan" id="kobo.485.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.486.1">GNS </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">Policy</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">, GNS=</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">acme-gns</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.490.1">Service Level Indicators</span></strong><span class="koboSpan" id="kobo.491.1">: p90 Latency is less than </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">100 ms</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.493.1">Service Level Objective</span></strong><span class="koboSpan" id="kobo.494.1">: The service should be healthy 99.99% of </span><span class="No-Break"><span class="koboSpan" id="kobo.495.1">the time</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.496.1">Click </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.497.1">Next</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.498.1">On the second screen, select the </span><em class="italic"><span class="koboSpan" id="kobo.499.1">catalog</span></em><span class="koboSpan" id="kobo.500.1"> service and click next. </span><span class="koboSpan" id="kobo.500.2">You could choose to apply this SLO to multiple services if you </span><span class="No-Break"><span class="koboSpan" id="kobo.501.1">want to.</span></span></p>
<p><span class="koboSpan" id="kobo.502.1">Finally, you’ll be shown a summary like this one. </span><span class="koboSpan" id="kobo.502.2">Notice that it calculates the approximate monthly budget of time your service can be outside of the healthy range. </span><span class="koboSpan" id="kobo.502.3">As the service goes into an unhealthy state over a month, the budget will </span><span class="No-Break"><span class="koboSpan" id="kobo.503.1">be updated:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer324">
<span class="koboSpan" id="kobo.504.1"><img alt="Figure 1﻿1.10 – SLO details" src="image/B18145_11_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.505.1">Figure 11.10 – SLO details</span></p>
<p><span class="koboSpan" id="kobo.506.1">Now, you can view your</span><a id="_idIndexMarker1016"/><span class="koboSpan" id="kobo.507.1"> services’ performance relative to their SLOs by navigating to </span><strong class="bold"><span class="koboSpan" id="kobo.508.1">Policies</span></strong><span class="koboSpan" id="kobo.509.1"> | </span><strong class="bold"><span class="koboSpan" id="kobo.510.1">SLOs</span></strong><span class="koboSpan" id="kobo.511.1"> and clicking on the</span><a id="_idIndexMarker1017"/><span class="koboSpan" id="kobo.512.1"> name of your SLO. </span><span class="koboSpan" id="kobo.512.2">Here’s one I set up previously with an unreasonable latency threshold of 5 ms. </span><span class="koboSpan" id="kobo.512.3">This was to demonstrate what things look like when you don’t meet your </span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">error budget:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer325">
<span class="koboSpan" id="kobo.514.1"><img alt="Figure 1﻿1.11 – SLO in the red" src="image/B18145_11_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.515.1">Figure 11.11 – SLO in the red</span></p>
<p><span class="koboSpan" id="kobo.516.1">This shows us that we have</span><a id="_idIndexMarker1018"/><span class="koboSpan" id="kobo.517.1"> an error budget of 4 minutes and 19 seconds for the month to be in an unhealthy state, and we’ve already exceeded that budget by just over 3 minutes. </span><span class="koboSpan" id="kobo.517.2">SLOs are incredibly </span><a id="_idIndexMarker1019"/><span class="koboSpan" id="kobo.518.1">powerful tools for SREs and they’re very easy to set up and maintain in Tanzu Service Mesh. </span><span class="koboSpan" id="kobo.518.2">Now, let’s move on to some other day-2 tasks that might be </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">of interest.</span></span></p>
<h2 id="_idParaDest-233"><a id="_idTextAnchor233"/><span class="koboSpan" id="kobo.520.1">Other day-2 operations for further research</span></h2>
<p><span class="koboSpan" id="kobo.521.1">To comprehensively </span><a id="_idIndexMarker1020"/><span class="koboSpan" id="kobo.522.1">cover all the day-2 functionality wrapped up in Tanzu Service Mesh would potentially double the length of this book; so, with that in mind, here’s a list of some items for further exploration, along with links to the </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">relevant documentation:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.524.1">Actionable SLOs</span></strong><span class="koboSpan" id="kobo.525.1">: You can configure your SLO to perform auto-healing actions when an SLI falls out of range. </span><span class="koboSpan" id="kobo.525.2">For example, when latency gets too high, Tanzu Service Mesh can </span><a id="_idIndexMarker1021"/><span class="koboSpan" id="kobo.526.1">autoscale the service to better handle the </span><span class="No-Break"><span class="koboSpan" id="kobo.527.1">load: </span></span><a href="https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/slos-with-tsm/GUID-1B9A2D61-D264-44FB-8A06-40277AD42A8E.html"><span class="No-Break"><span class="koboSpan" id="kobo.528.1">https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/slos-with-tsm/GUID-1B9A2D61-D264-44FB-8A06-40277AD42A8E.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.529.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.530.1">Onboard some External Services</span></strong><span class="koboSpan" id="kobo.531.1">: Some services live outside of Kubernetes but need to participate in the </span><span class="No-Break"><span class="koboSpan" id="kobo.532.1">mesh: </span></span><a href="https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/using-tanzu-service-mesh-guide/GUID-F7DC3814-0C3B-42E8-94A1-64B4B182D783.html"><span class="No-Break"><span class="koboSpan" id="kobo.533.1">https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/using-tanzu-service-mesh-guide/GUID-F7DC3814-0C3B-42E8-94A1-64B4B182D783.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.534.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.535.1">Create a Public Service</span></strong><span class="koboSpan" id="kobo.536.1">: This is a service that is reachable from the internet or a network outside the scope of the service mesh, such as an on-premises corporate </span><span class="No-Break"><span class="koboSpan" id="kobo.537.1">network: </span></span><a href="https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/using-tanzu-service-mesh-guide/GUID-58A3FA7C-4EFC-44B2-B37B-D2152CB16359.html"><span class="No-Break"><span class="koboSpan" id="kobo.538.1">https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/using-tanzu-service-mesh-guide/GUID-58A3FA7C-4EFC-44B2-B37B-D2152CB16359.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.539.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.540.1">Now that we’ve thoroughly</span><a id="_idIndexMarker1022"/><span class="koboSpan" id="kobo.541.1"> covered some day-2 tasks, let’s dive deep into one particularly important one, </span><strong class="bold"><span class="koboSpan" id="kobo.542.1">Global Server Load </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.543.1">Balancing</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.544.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.545.1">GSLB</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.546.1">).</span></span></p>
<h1 id="_idParaDest-234"><a id="_idTextAnchor234"/><span class="koboSpan" id="kobo.547.1">GSLB with NSX-T Advanced Load Balancer and Tanzu Service Mesh</span></h1>
<p><span class="koboSpan" id="kobo.548.1">One</span><a id="_idIndexMarker1023"/><span class="koboSpan" id="kobo.549.1"> particular day-2 task that is worthy of its own section is implementing GSLB with Tanzu Service Mesh and NSX </span><a id="_idIndexMarker1024"/><span class="koboSpan" id="kobo.550.1">Advanced </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">Load Balancer.</span></span></p>
<h2 id="_idParaDest-235"><a id="_idTextAnchor235"/><span class="koboSpan" id="kobo.552.1">NSX Advanced Load Balancer</span></h2>
<p><strong class="bold"><span class="koboSpan" id="kobo.553.1">NSX Advanced Load Balancer</span></strong><span class="koboSpan" id="kobo.554.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.555.1">NSX-ALB</span></strong><span class="koboSpan" id="kobo.556.1">) is a product </span><a id="_idIndexMarker1025"/><span class="koboSpan" id="kobo.557.1">that, while not technically part of the Tanzu portfolio, complements it very well. </span><span class="koboSpan" id="kobo.557.2">You can learn more about it, especially as it pertains to GSLB, </span><span class="No-Break"><span class="koboSpan" id="kobo.558.1">here: </span></span><span class="No-Break"><span class="koboSpan" id="kobo.559.1">https://avinetworks.com/docs/20.1/gslb-architecture-terminology-object-model/#gslbsites</span></span><span class="No-Break"><span class="koboSpan" id="kobo.560.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.561.1">In short, NSX-ALB is a powerful software load balancer that’s completely API-driven, allowing for tight integrations with other API-driven technologies such as Kubernetes or Tanzu Service Mesh. </span><span class="koboSpan" id="kobo.561.2">In addition to enabling the usual functions of an enterprise load balancer such as VIPs, traffic policies, and WAF, it also provides a robust DNS implementation, which </span><a id="_idIndexMarker1026"/><span class="koboSpan" id="kobo.562.1">makes it especially useful for GSLB. </span><span class="koboSpan" id="kobo.562.2">The following is a rough diagram of how Tanzu Service Mesh and NSX-ALB work alongside your corporate DNS (or public DNS) to provide access to services across data centers, multiple regions, and different </span><span class="No-Break"><span class="koboSpan" id="kobo.563.1">cloud providers:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer326">
<span class="koboSpan" id="kobo.564.1"><img alt="Figure 1﻿1.12 – NSX Advanced Load Balancer and Tanzu Service Mesh" src="image/B18145_11_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.565.1">Figure 11.12 – NSX Advanced Load Balancer and Tanzu Service Mesh</span></p>
<p><span class="koboSpan" id="kobo.566.1">Before we can fully understand how Tanzu Service Mesh works with NSX-ALB’s GSLB, let’s quickly describe how NSX-ALB does GSLB on </span><span class="No-Break"><span class="koboSpan" id="kobo.567.1">its own.</span></span></p>
<h2 id="_idParaDest-236"><a id="_idTextAnchor236"/><span class="koboSpan" id="kobo.568.1">Detour – GSLB without Tanzu Service Mesh</span></h2>
<p><span class="koboSpan" id="kobo.569.1">NSX ALB enables GSLB by implementing a DNS that will return the IP of a working instance of the service. </span><span class="koboSpan" id="kobo.569.2">Here’s the sequence </span><span class="No-Break"><span class="koboSpan" id="kobo.570.1">of events:</span></span></p>
<ol>
<li value="1"><span class="koboSpan" id="kobo.571.1">The client asks their local DNS server for an IP address </span><span class="No-Break"><span class="koboSpan" id="kobo.572.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">shopping.gslb.acme.com</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.574.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.575.1">The local DNS forwards to the authoritative DNS server for </span><strong class="source-inline"><span class="koboSpan" id="kobo.576.1">gslb.acme.com</span></strong><span class="koboSpan" id="kobo.577.1">, which lives in the New York </span><span class="No-Break"><span class="koboSpan" id="kobo.578.1">data center.</span></span></li>
<li><span class="koboSpan" id="kobo.579.1">The authoritative DNS</span><a id="_idIndexMarker1027"/><span class="koboSpan" id="kobo.580.1"> server, depending on the GSLB load balancing strategy and the health of the service instances, will return one of three IP addresses: the instance in the New York data center, the instance in the London data center, or the instance in AWS Oregon. </span><span class="koboSpan" id="kobo.580.2">Let’s say it returns </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">20.30.40.50</span></strong><span class="koboSpan" id="kobo.582.1">, which is the IP address of the NSX ALB Service Engines in the New York </span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">data center.</span></span></li>
<li><span class="koboSpan" id="kobo.584.1">The client makes an HTTPS request to </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">20.30.40.50</span></strong><span class="koboSpan" id="kobo.586.1"> with an SNI header </span><span class="No-Break"><span class="koboSpan" id="kobo.587.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">shopping.gslb.acme.com.</span></strong></span></li>
<li><span class="koboSpan" id="kobo.589.1">The NSX ALB Service Engine knows that requests with that particular SNI get routed to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.590.1">shopping</span></strong><span class="koboSpan" id="kobo.591.1"> service in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">acme</span></strong><span class="koboSpan" id="kobo.593.1"> namespace in the Kubernetes cluster running locally in the </span><span class="No-Break"><span class="koboSpan" id="kobo.594.1">data center.</span></span></li>
<li><span class="koboSpan" id="kobo.595.1">The client successfully orders his </span><span class="No-Break"><span class="koboSpan" id="kobo.596.1">yoga mat.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.597.1">Now, let’s layer in Tanzu </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">Service Mesh.</span></span></p>
<h2 id="_idParaDest-237"><a id="_idTextAnchor237"/><span class="koboSpan" id="kobo.599.1">GSLB with NSX-ALB and Tanzu Service Mesh</span></h2>
<p><span class="koboSpan" id="kobo.600.1">Everything from the </span><a id="_idIndexMarker1028"/><span class="koboSpan" id="kobo.601.1">previous section still applies, but</span><a id="_idIndexMarker1029"/><span class="koboSpan" id="kobo.602.1"> rather than an operator manually setting up </span><a id="_idIndexMarker1030"/><span class="koboSpan" id="kobo.603.1">GSLB for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.604.1">shopping</span></strong><span class="koboSpan" id="kobo.605.1"> service, she registers it in the service mesh as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">public</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.607.1">service (</span></span><a href="https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/using-tanzu-service-mesh-guide/GUID-58A3FA7C-4EFC-44B2-B37B-D2152CB16359.html"><span class="No-Break"><span class="koboSpan" id="kobo.608.1">https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/using-tanzu-service-mesh-guide/GUID-58A3FA7C-4EFC-44B2-B37B-D2152CB16359.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.609.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.610.1">Then, she integrates Tanzu </span><a id="_idIndexMarker1031"/><span class="koboSpan" id="kobo.611.1">Service Mesh with her NSX ALB instances. </span><span class="koboSpan" id="kobo.611.2">Finally, Tanzu Service Mesh automatically begins to configure GSLB. </span><span class="koboSpan" id="kobo.611.3">Wherever the </span><strong class="source-inline"><span class="koboSpan" id="kobo.612.1">shopping</span></strong><span class="koboSpan" id="kobo.613.1"> service is deployed in the GNS, Tanzu </span><a id="_idIndexMarker1032"/><span class="koboSpan" id="kobo.614.1">Service Mesh will configure the GSLB DNS resolver to point to a cluster containing that </span><a id="_idIndexMarker1033"/><span class="koboSpan" id="kobo.615.1">service. </span><span class="koboSpan" id="kobo.615.2">You can read about this process in detail </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">here: </span></span><a href="https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/using-tanzu-service-mesh-guide/GUID-896EA3FA-17EA-49E2-B981-5C9634E45512.html"><span class="No-Break"><span class="koboSpan" id="kobo.617.1">https://docs.vmware.com/en/VMware-Tanzu-Service-Mesh/services/using-tanzu-service-mesh-guide/GUID-896EA3FA-17EA-49E2-B981-5C9634E45512.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.618.1">.</span></span></p>
<h1 id="_idParaDest-238"><a id="_idTextAnchor238"/><span class="koboSpan" id="kobo.619.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.620.1">In this chapter, we onboarded onto Tanzu Service Mesh, deployed a real-world application, discussed day-2 operations, and even covered GSLB, a very advanced topic. </span><span class="koboSpan" id="kobo.620.2">In the next chapter, we’ll attempt to put all the pieces together and paint a picture of what “good” looks like when using the entire Tanzu portfolio. </span><span class="koboSpan" id="kobo.620.3">I hope </span><span class="No-Break"><span class="koboSpan" id="kobo.621.1">you’ll continue!</span></span></p>
</div>
</body></html>