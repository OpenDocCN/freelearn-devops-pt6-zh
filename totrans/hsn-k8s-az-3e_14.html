<html><head></head><body>
		<div>
			<div id="_idContainer264" class="Content">
			</div>
		</div>
		<div id="_idContainer265" class="Content">
			<h1 id="_idParaDest-106">9. <a id="_idTextAnchor108"/>Azure Active Directory pod-managed identities in AKS</h1>
		</div>
		<div id="_idContainer286" class="Content">
			<p>In the previous chapter, <em class="italics">Chapter 8, Role-based access control in AKS</em>, you integrated your AKS cluster with <strong class="bold">Azure Active Directory</strong> (<strong class="bold">Azure AD</strong>). You then assigned Kubernetes roles to users and groups in Azure AD. In this chapter, you will explore how you can integrate your applications running on AKS with Azure AD, and you will learn how you can give your pods an identity in Azure so they can interact with other Azure resources.</p>
			<p>In Azure, application identities use a functionality called service principals. A service principal is the equivalent of a service account in the cloud. An application can use a service principal to authenticate to Azure AD and get access to resources. Those resources could be either Azure resources such as Azure Blob Storage or Azure Key Vault, or they could be applications that you developed that are integrated with Azure AD.</p>
			<p>There are two ways to authenticate a service principal: you can either use a password or a combination of a certificate and a private key. Although these are secure ways to authenticate your applications, managing passwords or certificates and the rotation associated with them can be cumbersome.</p>
			<p>Managed identities in Azure are a functionality that makes authenticating to a service principal easier. It works by assigning an identity to a compute resource in Azure, such as a virtual machine or an Azure function. Those compute resources can authenticate using that managed identity by calling an endpoint that only that machine can reach. This is a secure type of authentication that does not require you to manage passwords or certificates.</p>
			<p>Azure AD pod-managed identities allow you to assign managed identities to pods in Kubernetes. Since pods in Kubernetes run on virtual machines, by default, each pod would be able to access the managed identity endpoint and authenticate using that identity. Using Azure AD pod-managed identities, pods can no longer reach the internal endpoint for the virtual machine, and rather only get access to identities assigned to that specific pod.</p>
			<p>In this chapter, you'll configure an Azure AD pod-managed identity on an AKS cluster and use it to get access to Azure Blob Storage. In the next chapter, you will then use these Azure AD pod-managed identities to get access to Azure Key Vault and manage Kubernetes secrets.</p>
			<p>The following topics will be covered briefly in this chapter:</p>
			<ul>
				<li>An overview of Azure AD pod-managed identities</li>
				<li><a id="_idTextAnchor109"/>Setting up a new cluster with Azure AD pod-managed identities</li>
				<li>Linking an identity to your cluster</li>
				<li>Using a pod with managed identity</li>
			</ul>
			<p>Let's start with an overview of Azure AD pod-managed identities.</p>
			<h2 id="_idParaDest-107"><a id="_idTextAnchor110"/>An overview of Azure AD pod-managed identities</h2>
			<p>The goal of this section is to describe Azure managed identities and Azure AD pod-managed identities.</p>
			<p>As explained in the introduction, managed identities in Azure are a way to securely authenticate applications running inside Azure. There are two types of managed identities in Azure. The difference between them is how they are linked to resources:</p>
			<ul>
				<li><strong class="bold">System assigned</strong>: This type of managed identity is linked 1:1 to the resource (such as a virtual machine) itself. This managed identity also shares the lifecycle of the resource, meaning that once the resource is deleted, the managed identity is also deleted.</li>
				<li><strong class="bold">User assigned</strong>: User-assigned managed identities are standalone Azure resources. A user-assigned managed identity can be linked to multiple resources. When a resource is deleted, the managed identity is not deleted. </li>
			</ul>
			<p>Both types of managed identities work the same way once they are created and linked to a resource. This is how managed identities work from an application perspective:</p>
			<ol>
				<li>Your application running in Azure requests a token to the <strong class="bold">Instance Metadata Service</strong> (<strong class="bold">IMDS</strong>). The IMDS is only available to that resource itself, at a non-routable IP address (<strong class="inline">169.254.169.254</strong>).</li>
				<li>The IMDS will request a token from Azure AD. It uses a certificate that is configured for your managed identity and is only known by the IMDS.</li>
				<li>Azure AD will return a token to the IMDS, which will, in turn, return that token to your application.</li>
				<li>Your application can use this token to authenticate to other resources, for instance, Azure Blob Storage.</li>
			</ol>
			<div>
				<div id="_idContainer266" class="IMG---Figure">
					<img src="image/B17338_09_01.jpg" alt="Managed identity workflow in an Azure virtual machine"/>
				</div>
			</div>
			<p class="figure">Figure 9.1: Managed identity in an Azure virtual machine</p>
			<p>When running multiple pods on a single virtual machine in a Kubernetes cluster, by default each pod can reach the IMDS endpoint. This means that each pod could get access to the identities configured for that virtual machine.</p>
			<p>The Azure AD pod-managed identities add-on for AKS configures your cluster in such a way that pods can no longer access the IMDS endpoint directly to request an access token. It configures your cluster in such a way that pods trying to access to IMDS endpoint (1) will connect to a DaemonSet running on the cluster. This DaemonSet is called the <strong class="bold">node managed identity</strong> (<strong class="bold">NMI</strong>). The NMI will verify which identities that pod should have access to. If the pod is configured to have access to the requested identity, then the DaemonSet will connect to the IMDS (2 to 5) to get the token, and then deliver the token to the pod (6). The pods can then use this token to access Azure resources (7).</p>
			<div>
				<div id="_idContainer267" class="IMG---Figure">
					<img src="image/B17338_09_02.jpg" alt="Azure AD pod-managed identity workflow"/>
				</div>
			</div>
			<p class="figure">Figure 9.2: Azure AD pod-managed identity</p>
			<p>This way, you can control which pods on your cluster have access to certain identities.</p>
			<p>Azure AD pod-managed identities were initially developed as an open-source project by Microsoft on GitHub. More recently, Microsoft has released Azure AD pod-managed identities as an AKS add-on. The benefit of using Azure AD pod-managed identities as an AKS add-on is that the functionality is supported by Microsoft and the software will be updated automatically as part of regular cluster operations.</p>
			<h4>Note</h4>
			<p class="callout">At the time of writing, the Azure AD pod-managed identities add-on is in preview. Currently, it is also not supported for Windows containers. Using preview functionality for product use cases is not recommended.</p>
			<p>Now that you know how Azure AD pod-managed identities work, let's set it up on an AKS cluster in the next section.</p>
			<h2 id="_idParaDest-108"><a id="_idTextAnchor111"/>Setting up a new cluster with Azure AD pod-managed identities</h2>
			<p>As mentioned in the previous section, there are two ways to set up Azure AD pod-managed identities in AKS. It can either be done using the open-source project on GitHub, or by setting it up as an AKS add-on. By using the add-on, you'll get a supported configuration, which is why you'll set up a cluster using the add-on in this section.</p>
			<p>At the time of writing, it is not yet possible to enable the Azure AD pod-managed identities add-on on an existing cluster, which is why in the following instructions you'll delete your existing cluster and create a new one with the add-on installed. By the time you are reading this, it might be possible to enable this add-on on an existing cluster without recreating your cluster.</p>
			<p>Also, because the functionality is in preview at the time of this writing, you'll have to register for the preview. That'll be the first step in this section:</p>
			<ol>
				<li value="1">Start by opening Cloud Shell and registering for the preview of Azure AD pod-managed identities:<p class="snippet">az feature register --name EnablePodIdentityPreview \</p><p class="snippet">  --namespace Microsoft.ContainerService</p></li>
				<li>You'll also need a preview extension of the Azure CLI, which you can install using the following command:<p class="snippet">az extension add --name aks-preview</p></li>
				<li>Now you can go ahead and delete your existing cluster. This is required to ensure you have enough core quota available in Azure. You can do this using the following command:<p class="snippet">az aks delete -n handsonaks -g rg-handsonaks --yes</p></li>
				<li>Once your previous cluster is deleted, you'll have to wait until the pod identity preview is registered on your subscription. You can use the following command to verify this status:<p class="snippet">az feature show --name EnablePodIdentityPreview \</p><p class="snippet">  --namespace Microsoft.ContainerService -o table</p><p>Wait until the status shows as registered, as shown in <em class="italics">Figure 9.3</em>:</p><div id="_idContainer268" class="IMG---Figure"><img src="image/B17338_09_03.jpg" alt="Verifying that the pod identity preview is registered on your subscription"/></div><p class="figure">Figure 9.3: Waiting for the feature to be registered</p></li>
				<li>If the feature is registered and your old cluster is deleted, you need to refresh the registration of the namespace before creating a new cluster. Let's first refresh the registration of the namespace:<p class="snippet">az provider register --namespace Microsoft.ContainerService</p></li>
				<li>And now you can create a new cluster using the Azure AD pod-managed identities add-on. You can use the following command to create a new cluster with the add-on enabled:<p class="snippet">az aks create -g rg-handsonaks -n handsonaks \</p><p class="snippet">  --enable-managed-identity --enable-pod-identity \</p><p class="snippet">  --network-plugin azure --node-vm-size Standard_DS2_v2 \</p><p class="snippet">  --node-count 2 --generate-ssh-keys</p></li>
				<li>This will take a couple of minutes to finish. Once the command finishes, obtain the credentials to access your cluster and verify you can access your cluster using the following commands:<p class="snippet">az aks get-credentials -g rg-handsonaks \</p><p class="snippet">  -n handsonaks --overwrite-existing</p><p class="snippet">kubectl get nodes</p><p>This should return an output similar to <em class="italics">Figure 9.4</em>:</p></li>
			</ol>
			<div>
				<div id="_idContainer269" class="IMG---Figure">
					<img src="image/B17338_09_04.jpg" alt="Obtaining the credentials to access your new cluster and verifying that you can access your new cluster "/>
				</div>
			</div>
			<p class="figure">Figure 9.4: Getting cluster credentials and verifying access</p>
			<p>Now you have a new AKS cluster with Azure AD pod-managed identities enabled. In the next section, you will create a managed identity and link it to your cluster. </p>
			<h2 id="_idParaDest-109"><a id="_idTextAnchor112"/>Linking an identity to your cluster</h2>
			<p>In the previous section, you created a new cluster with Azure AD pod-managed identities enabled. Now you are ready to create a managed identity and link it to your cluster. Let's get started:</p>
			<ol>
				<li value="1">To start, you will create a new managed identity using the Azure portal. In the Azure portal, look for <strong class="inline">managed identity</strong> in the search bar, as shown in <em class="italics">Figure 9.5</em>:<div id="_idContainer270" class="IMG---Figure"><img src="image/B17338_09_05.jpg" alt="Search for Managed identity in the Azure search bar"/></div><p class="figure">Figure 9.5: Navigating to Managed Identities in the Azure portal</p></li>
				<li>In the resulting pane, click the <span class="P---Screen-Text">+ New</span> button at the top. To organize the resources for this chapter together, it's recommended to create a new resource group. In the resulting pane, click the <span class="P---Screen-Text">Create new</span> button to create a new resource group. Call it <strong class="inline">aad-pod-id</strong>, as shown in <em class="italics">Figure 9.6</em>:<div id="_idContainer271" class="IMG---Figure"><img src="image/B17338_09_06.jpg" alt="Creating a new resource group called aad-pod-id"/></div><p class="figure">Figure 9.6: Creating a new resource group</p></li>
				<li>Now, select the region you created your cluster in as the region for your managed identity and give it a name (<strong class="inline">aad-pod-id</strong> in this example), as shown in <em class="italics">Figure 9.7</em>. To finish, click the <span class="P---Screen-Text">Review + create</span> button and in the final window click the <span class="P---Screen-Text">Create</span> button to create your managed identity:<div id="_idContainer272" class="IMG---Figure"><img src="image/B17338_09_07.jpg" alt="Providing instance details for creating a new managed identity"/></div><p class="figure">Figure 9.7: Providing Instance details for the managed identity</p></li>
				<li>Once the managed identity has been created, hit the <span class="P---Screen-Text">Go to resource</span> button to go to the resource. Here, you will need to copy the client ID and the resource ID. They will be used later in this chapter. Copy and paste the values somewhere that you can access later. First, you will need the client ID of the managed identity. You can find that in the <span class="P---Screen-Text">Overview</span> pane of the managed identity, as shown in <em class="italics">Figure 9.8</em>:<div id="_idContainer273" class="IMG---Figure"><img src="image/B17338_09_08.jpg" alt="Fetching the client ID from the managed identity overview page"/></div><p class="figure">Figure 9.8: Getting the client ID of the managed identity</p></li>
				<li>Finally, you will also need the resource ID of the managed identity. You can find that in the Properties pane of the managed identity, as shown in <em class="italics">Figure 9.9</em>:<div id="_idContainer274" class="IMG---Figure"><img src="image/B17338_09_09.jpg" alt="Fetching resource ID from the managed identity Properties page"/></div><p class="figure">Figure 9.9: Getting the resource ID of the managed identity</p></li>
				<li>Now you are ready to link the managed identity to your AKS cluster. To do this, you will run a command in Cloud Shell, and afterward you will be able to verify that the identity is available in your cluster. Let's start with linking the identity. Make sure to replace <strong class="inline">&lt;Managed identity resource ID&gt;</strong> with the resource you copied earlier:<p class="snippet">az aks pod-identity add --resource-group rg-handsonaks \</p><p class="snippet">  --cluster-name handsonaks --namespace default \</p><p class="snippet">  --name access-blob-id \</p><p class="snippet">  --identity-resource-id &lt;Managed identity resource ID&gt;</p></li>
				<li>You can verify that your identity was successfully linked to your cluster by running the following command:<p class="snippet">kubectl get azureidentity</p><p>This should give you an output similar to <em class="italics">Figure 9.10</em>:</p></li>
			</ol>
			<div>
				<div id="_idContainer275" class="IMG---Figure">
					<img src="image/B17338_09_10.jpg" alt="Verifying that your identity was successfully linked to your cluster"/>
				</div>
			</div>
			<p class="figure">Figure 9.10: Verifying the availability of the identity in the cluster</p>
			<p>This means that the identity is now available for you to use in your cluster. How you do this will be explained in the next section.</p>
			<h2 id="_idParaDest-110"><a id="_idTextAnchor113"/>Using a pod with managed identity</h2>
			<p>In the previous section, you created a managed identity and linked it to your cluster. In this section, you will create a new blob storage account and give the managed identity you created permission over this storage account. Then, you will create a new pod in your cluster that can use that managed identity to interact with that storage account. Let's get started by creating a new storage account:</p>
			<ol>
				<li value="1">To create a new storage account, look for <strong class="inline">storage accounts</strong> in the Azure search bar, as shown in <em class="italics">Figure 9.11</em>:<div id="_idContainer276" class="IMG---Figure"><img src="image/B17338_09_11.jpg" alt="Searching for storage accounts in the Azure search bar"/></div><p class="figure">Figure 9.11: Looking for storage accounts in the Azure search bar</p><p>In the resulting pane, click the <span class="P---Screen-Text">+ New</span> button at the top of the screen as shown in <em class="italics">Figure 9.12</em>:</p><div id="_idContainer277" class="IMG---Figure"><img src="image/B17338_09_12.jpg" alt="Creating a new storage account"/></div><p class="figure">Figure 9.12: Creating a new storage account</p><p>Select the <strong class="inline">aad-pod-id</strong> resource group you created earlier, give the account a unique name, and select the same region as your cluster. To optimize costs, it is recommended that you select the <span class="P---Screen-Text">Standard</span> performance, <span class="P---Screen-Text">StorageV2</span> as the Account kind, and <span class="P---Screen-Text">Locally-redundant storage (LRS)</span> for Replication, as shown in <em class="italics">Figure 9.13</em>:</p><div id="_idContainer278" class="IMG---Figure"><img src="image/B17338_09_13.jpg" alt="Configuring your new storage account by providing Subscription details and Instance details"/></div><p class="figure">Figure 9.13: Configuring your new storage account</p></li>
				<li>After you have provided all the values, click <span class="P---Screen-Text">Review + create</span> and then the <span class="P---Screen-Text">Create</span> button on the resulting screen. This will take about a minute to create. Once the storage account is created, click the <span class="P---Screen-Text">Go to resource</span> button to move on to the next step.</li>
				<li>First, you will give the managed identity access to the storage account. To do this, click <span class="P---Screen-Text">Access Control (IAM)</span> in the left-hand navigation bar, click <span class="P---Screen-Text">+ Add</span> and <span class="P---Screen-Text">Add role assignment</span>. Then select the <span class="P---Screen-Text">Storage Blob Data Contributor</span> role, select <span class="P---Screen-Text">User assigned managed identity</span> in the <span class="P---Screen-Text">Assign access to</span> dropdown, and select the <span class="P---Screen-Text">access-blob-id</span> managed identity you created, as shown in <em class="italics">Figure 9.14</em>. Finally, hit the <span class="P---Screen-Text">Save</span> button at the bottom of the screen:<div id="_idContainer279" class="IMG---Figure"><img src="image/B17338_09_14.jpg" alt="In the IAM pane of the storage account, providing the managed identity with access to the storage account  "/></div><p class="figure">Figure 9.14: Providing access to the storage account for the managed identity</p></li>
				<li>Next, you will upload a random file to this storage account. Later, you will try to access this file from within a Kubernetes pod to verify you have access to the storage account. To do this, go back to the <span class="P---Screen-Text">Overview</span> pane of the storage account. There, click on <span class="P---Screen-Text">Containers</span>, as shown in <em class="italics">Figure 9.15</em>:<div id="_idContainer280" class="IMG---Figure"><img src="image/B17338_09_15.jpg" alt="Navigating to Containers from the Overview pane of the storage account"/></div><p class="figure">Figure 9.15: Clicking on Containers in the overview pane</p></li>
				<li>Then hit the <span class="P---Screen-Text">+ Container</span> button at the top of the screen. Give the container a name, such as <strong class="inline">uploadedfiles</strong>. Make sure to set Public access level to <span class="P---Screen-Text">Private (no anonymous access)</span>, and then click the <span class="P---Screen-Text">Create</span> button at the bottom of the screen, as shown in <em class="italics">Figure 9.16</em>:<div id="_idContainer281" class="IMG---Figure"><img src="image/B17338_09_16.jpg" alt="Creating a new container called uploadedfiles"/></div><p class="figure">Figure 9.16: Creating a new blob storage container</p></li>
				<li>Finally, upload a random file into this storage container. To do this, click on the container name, and then click the <span class="P---Screen-Text">Upload</span> button at the top of the screen. Select a random file from your computer and click <span class="P---Screen-Text">Upload</span> as shown in <em class="italics">Figure 9.17</em>:<div id="_idContainer282" class="IMG---Figure"><img src="image/B17338_09_17.jpg" alt="Uploading a new file to Blob Storage"/></div><p class="figure">Figure 9.17: Uploading a new file to blob storage</p></li>
				<li>Now that you have a file in blob storage, and your managed identity has access to this storage account, you can go ahead and try connecting to it from Kubernetes. To do this, you will create a new deployment using the Azure CLI container image. This deployment will contain a link to the managed identity that was created earlier. The deployment file is provided in the code files for this chapter as <strong class="inline">deployment-with-identity.yaml</strong>:<p class="snippet">1   apiVersion: apps/v1</p><p class="snippet">2   kind: Deployment</p><p class="snippet">3   metadata:</p><p class="snippet">4     name: access-blob</p><p class="snippet">5   spec:</p><p class="snippet">6     selector:</p><p class="snippet">7       matchLabels:</p><p class="snippet">8         app: access-blob</p><p class="snippet">9     template:</p><p class="snippet">10      metadata:</p><p class="snippet">11        labels:</p><p class="snippet">12          app: access-blob</p><p class="snippet">13          aadpodidbinding: access-blob-id</p><p class="snippet">14      spec:</p><p class="snippet">15        containers:</p><p class="snippet">16        - name: azure-cli</p><p class="snippet">17          image: mcr.microsoft.com/azure-cli</p><p class="snippet">18          command: [ "/bin/bash", "-c", "sleep inf" ]</p><p>There are a few things to draw attention to in the definition of this deployment:</p><ul><li><strong class="bold">Line 13</strong>: This is where you link the pod (created by the deployment) with the managed identity. Any pod with that label will be able to access the managed identity.</li><li><strong class="bold">Line 16-18</strong>: Here, you define which container will be created in this pod. As you can see, the image (<strong class="inline">mcr.microsoft.com/azure-cli</strong>) is referring to the Azure CLI, and you're running a <strong class="inline">sleep</strong> command in this container to make sure the container doesn't continuously restart.</li></ul></li>
				<li>You can create this deployment using the following command:<p class="snippet">kubectl create -f deployment-with-identity.yaml</p></li>
				<li>Watch the pods until the <strong class="inline">access-blob</strong> pod is in the <strong class="bold">Running</strong> state. Then copy and paste the name of the <strong class="inline">access-blob</strong> pod and <strong class="inline">exec</strong> into it using the following command:<p class="snippet">kubectl exec -it &lt;access-blob pod name&gt; -- sh</p></li>
				<li>Once you are connected to the pod, you can authenticate to the Azure API using the following command. Replace <strong class="inline">&lt;client ID of managed identity&gt;</strong> with the client ID you copied earlier:<p class="snippet">az login --identity -u &lt;client ID of managed identity&gt; \</p><p class="snippet">  --allow-no-subscription -o table</p><p>This should return you an output similar to <em class="italics">Figure 9.18</em>:</p><div id="_idContainer283" class="IMG---Figure"><img src="image/B17338_09_18.jpg" alt="Logging into the Azure CLI using the client ID of the managed identity"/></div><p class="figure">Figure 9.18: Logging in to the Azure CLI using the Azure AD pod-managed identity</p></li>
				<li>Now, you can try accessing the blob storage account and download the file. You can do this by executing the following command:<p class="snippet">az storage blob download --account-name &lt;storage account name&gt; \</p><p class="snippet"> --container-name &lt;container name&gt; --auth-mode login \</p><p class="snippet"> --file &lt;filename&gt; --name &lt;filename&gt; -o table</p><p>This should return you an output similar to <em class="italics">Figure 9.19</em>:</p><div id="_idContainer284" class="IMG---Figure"><img src="image/B17338_09_19.jpg" alt="Downloading a blob file using the managed identity"/></div><p class="figure">Figure 9.19: Downloading a blob file using the managed identity</p></li>
				<li>You can now exit the container using the <strong class="inline">exit</strong> command.</li>
				<li>If you would like to verify that pods that don't have a managed identity configured and cannot download the file, you can use the file called <strong class="inline">deployment-without-identity.yaml</strong>:<p class="snippet">1   apiVersion: apps/v1</p><p class="snippet">2   kind: Deployment</p><p class="snippet">3   metadata:</p><p class="snippet">4     name: no-access-blob</p><p class="snippet">5   spec:</p><p class="snippet">6     selector:</p><p class="snippet">7       matchLabels:</p><p class="snippet">8         app: no-access-blob</p><p class="snippet">9     template:</p><p class="snippet">10      metadata:</p><p class="snippet">11        labels:</p><p class="snippet">12          app: no-access-blob</p><p class="snippet">13      spec:</p><p class="snippet">14        containers:</p><p class="snippet">15        - name: azure-cli</p><p class="snippet">16          image: mcr.microsoft.com/azure-cli</p><p class="snippet">17          command: [ "/bin/bash", "-c", "sleep inf" ]</p><p>As you can see, this deployment isn't similar to the deployment you created earlier in the chapter. The difference here is that the pod definition doesn't contain the label with the Azure AD pod-managed identity. This means that this pod won't be able to log in to Azure using any managed identity. You can create this deployment using the following:</p><p class="snippet">kubectl create -f deployment-without-identity.yaml</p></li>
				<li>Watch the pods until the <strong class="inline">no-access-blob</strong> pod is in the <strong class="bold">Running</strong> state. Then copy and paste the name of the <strong class="inline">access-blob</strong> pod and <strong class="inline">exec</strong> into it using the following command:<p class="snippet">kubectl exec -it &lt;no-access-blob pod name&gt; -- sh</p></li>
				<li>Once you are connected to the pod, you can try to authenticate to the Azure API using the following command, which should fail:<p class="snippet">az login --identity -u &lt;client ID of managed identity&gt; \</p><p class="snippet">  --allow-no-subscription -o table</p><p>This should return an output similar to <em class="italics">Figure 9.20</em>:</p><div id="_idContainer285" class="IMG---Figure"><img src="image/B17338_09_20.jpg" alt="Authentication error for the deployment with a pod identity"/></div><p class="figure">Figure 9.20: The new pod cannot authenticate using the managed identity</p></li>
				<li>Finally, you can exit the container using the <strong class="inline">exit</strong> command.</li>
			</ol>
			<p>This has successfully shown you how to use Azure AD pod-managed identities to connect to blob storage from within your Kubernetes cluster. A deployment with an identity label could log in to the Azure CLI and then access blob storage. A deployment without this identity label didn't get permission to log in to the Azure CLI, and hence was also not able to access blob storage. </p>
			<p>This has concluded this chapter. Let's make sure to delete the resources you created for this chapter:</p>
			<p class="snippet">az aks pod-identity delete --resource-group rg-handsonaks \</p>
			<p class="snippet">  --cluster-name handsonaks --namespace default \</p>
			<p class="snippet">  --name access-blob-id </p>
			<p class="snippet">az group delete -n aad-pod-id --yes</p>
			<p class="snippet">kubectl delete -f</p>
			<p>You can keep the cluster you created in this chapter since in the next chapter you will use Azure AD pod-managed identities to access Key Vault secrets.</p>
			<h2 id="_idParaDest-111"><a id="_idTextAnchor114"/>Summary</h2>
			<p>In this chapter, you've continued your exploration of security in AKS. Whereas <em class="italics">Chapter 8, Role-based access control in AKS</em>, focused on identities for users, this chapter focused on identities for pods and applications running in pods. You learned about managed identities in Azure and how you can use Azure AD pod-managed identities in Azure to assign those managed identities to pods.</p>
			<p>You created a new cluster with the Azure AD pod-managed identities add-on enabled. You then created a new managed identity and linked that to your cluster. In the final section, you gave this identity permissions over a blob storage account and finally verified that pods with the managed identity were able to log in to Azure and download files, but pods without the managed identity couldn't log in to Azure.</p>
			<p>In the next chapter, you'll learn more about Kubernetes secrets. You'll learn about the built-in secrets and then also learn how you can securely connect Kubernetes to Azure Key Vault, and even use Azure AD pod-managed identities to do this.</p>
		</div>
	</body></html>