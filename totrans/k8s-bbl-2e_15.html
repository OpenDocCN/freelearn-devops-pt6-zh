<html><head></head><body>
  <div class="Basic-Text-Frame" id="_idContainer300">
    <h1 class="chapterNumber">15</h1>
    <h1 class="chapterTitle" id="_idParaDest-506">Kubernetes Clusters on Google Kubernetes Engine</h1>
    <p class="normal">In this chapter, we will launch a <a id="_idIndexMarker1323"/>Kubernetes cluster on <strong class="keyWord">Google Cloud Platform </strong>(<strong class="keyWord">GCP</strong>), the first of the three public cloud providers we will cover over the next few chapters.</p>
    <p class="normal">By the end of this chapter, you will have signed up for the Google Cloud Platform, launched a Kubernetes workload <a id="_idIndexMarker1324"/>using <strong class="keyWord">Google Kubernetes Engine</strong> (<strong class="keyWord">GKE</strong>), and gained an understanding of GKE’s features.</p>
    <p class="normal">We will be covering the following topics in this chapter:</p>
    <ul>
      <li class="bulletList">What are Google Cloud Platform and Google Kubernetes Engine?</li>
      <li class="bulletList">Preparing your local environment</li>
      <li class="bulletList">Launching your first Google Kubernetes Engine cluster</li>
      <li class="bulletList">Deploying a workload and interacting with your cluster</li>
      <li class="bulletList">More about cluster nodes</li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-507">Technical requirements</h1>
    <p class="normal">To follow along with this chapter, you will need a Google Cloud Platform account with a valid payment method attached.</p>
    <div class="note">
      <p class="normal">Following the instructions in this chapter will incur a financial cost. It is, therefore, important that you terminate any resources you launch once you have finished using them. All prices quoted in this chapter are correct at the time of writing, and we recommend that you review the current costs before you launch any resources.</p>
    </div>
    <h1 class="heading-1" id="_idParaDest-508">What are Google Cloud Platform and Google Kubernetes Engine?</h1>
    <p class="normal">Before we roll up our sleeves and look at signing up for a Google Cloud Platform account and installing the tools, we will need to launch our GKE-powered cluster. We should also discuss Google Kubernetes Engine and how it came to be.</p>
    <div class="note">
      <p class="normal">Henceforth, I will refer to Google Cloud Platform as GCP and Google Kubernetes Engine as GKE in the body text of the chapter.</p>
    </div>
    <h2 class="heading-2" id="_idParaDest-509">Google Cloud Platform</h2>
    <p class="normal">Of the “<strong class="keyWord">big three</strong>” public cloud providers, GCP is<a id="_idIndexMarker1325"/> the newest. In the following two <a id="_idIndexMarker1326"/>chapters, we <a id="_idIndexMarker1327"/>will examine <strong class="keyWord">Amazon Web Services</strong> (<strong class="keyWord">AWS</strong>) and <strong class="keyWord">Microsoft Azure</strong>.</p>
    <p class="normal">Google’s foray into public cloud technology started differently from the other two providers. In April 2008, Google launched the public preview of its Google App Engine, which was the first component of its cloud offering. As a service, App Engine is still available at the time of writing, in mid-2024. The service allows developers to deploy their applications in Google-managed runtimes, including PHP, Java, Ruby, Python, Node.js, and C#, along with Google’s programming language, Go, which was open sourced in 2009.</p>
    <p class="normal">The following service under the <a id="_idIndexMarker1328"/>GCP banner arrived in May 2010: <strong class="keyWord">Google Cloud Storage</strong>, followed by <strong class="keyWord">Google BigQuery</strong> and a <a id="_idIndexMarker1329"/>preview version of its Prediction API. A year later, in October 2011, <strong class="keyWord">Google Cloud SQL</strong> was<a id="_idIndexMarker1330"/> launched. Then, in June 2012, the <strong class="keyWord">Google Compute Engine</strong> preview <a id="_idIndexMarker1331"/>was launched.</p>
    <p class="normal">As you can see, four years had passed, and we then had what most would consider the core services that go into making a public cloud service.</p>
    <p class="normal">However, most of the services were still in preview; it wouldn’t be until 2013 that many of these core services would move out of preview and <a id="_idIndexMarker1332"/>become <strong class="keyWord">generally available</strong> (<strong class="keyWord">GA</strong>). This meant that it was possible to safely run production workloads at scale and, more importantly, with a <strong class="keyWord">Service-Level Agreement</strong> (<strong class="keyWord">SLA</strong>), which is critical for<a id="_idIndexMarker1333"/> both <strong class="keyWord">small and medium-sized enterprises</strong> (<strong class="keyWord">SMEs</strong>) and large enterprise companies in adopting the service. All of this was just a year before Google would launch Kubernetes.</p>
    <p class="normal">Toward the end of 2014, Google brought out the first alpha version of GKE.</p>
    <h2 class="heading-2" id="_idParaDest-510">Google Kubernetes Engine</h2>
    <p class="normal">Given that <a id="_idIndexMarker1334"/>Kubernetes was developed at Google and Google had vast experience running container workloads at scale with the Borg project, it came as no surprise that Google was one of the first public cloud providers to offer its own Kubernetes offering in GKE.</p>
    <p class="normal">After Kubernetes v1 came out and was then handed over to the <strong class="keyWord">Cloud Native Computing Foundation</strong> (<strong class="keyWord">CNCF</strong>) to maintain in July 2015, it was only a month later that the GKE service became GA.</p>
    <p class="normal">The GKE service lets you launch and manage a CNCF-certified Kubernetes cluster, powered by GCP’s native compute, storage, and network services. It also allows deep integration with the platform’s monitoring, identity, and access management functionality.</p>
    <div class="note">
      <p class="normal">We will look at the differences between the various Cloud-based Kubernetes offerings, and why you should use them, at the end of <em class="chapterRef">Chapter 17</em>.</p>
    </div>
    <p class="normal">Now that we know a little bit of the history behind the service, we can sign up and install some of the management tools we will use to launch our cluster.</p>
    <h1 class="heading-1" id="_idParaDest-511">Preparing your local environment</h1>
    <p class="normal">The <a id="_idIndexMarker1335"/>first thing we need to do is get you access to GCP. To do this, you must either sign up for an account or log in to your existing one. Let’s learn how.</p>
    <p class="normal">To sign up for a GCP account, you will need to visit <a href="https://cloud.google.com/"><span class="url">https://cloud.google.com/</span></a>. Here, you should be greeted by a page that looks something like the following:</p>
    <figure class="mediaobject"><img alt="A screenshot of a web page&#10;&#10;Description automatically generated" src="image/B22019_15_01.png"/></figure>
    <p class="packt_figref">Figure 15.1: The Google Cloud home page</p>
    <p class="normal">If<a id="_idIndexMarker1336"/> you already use a Google service such as Gmail or YouTube or have an Android phone, you will possess a Google account. You can use this account to enroll, as shown in <em class="italic">Figure 15.1</em>. I am already logged in to my own Google account, as indicated by the avatar on the top-right-hand side of the screenshot.</p>
    <div class="note">
      <p class="normal">At the time of writing, Google offers $300 of credits for you to use over 90 days. You must still enter a valid payment method to take advantage of the free credits. Google does this to ensure that it is not an automated bot signing up for the account, abusing the credits they offer. Once the credits have been used or expired, you will be given the option to upgrade your account to a paid account. For more details on this offer, see the following link: <a href="https://cloud.google.com/free/docs/free-cloud-features"><span class="url">https://cloud.google.com/free/docs/free-cloud-features</span></a>.</p>
    </div>
    <p class="normal">If you want to take advantage of the free credits, follow this link: <a href="https://cloud.google.com/free/docs/free-cloud-features#try-it-for-yourself"><span class="url">https://cloud.google.com/free/docs/free-cloud-features#try-it-for-yourself</span></a>. Click on <strong class="screenText">Get started for free</strong>; if you qualify for the offer, follow the onscreen prompts, ensuring that you read the terms and conditions. Once you have enrolled, you will be taken to the GCP console. Alternatively, if you already have a GCP account, you can log in to the GCP console directly at <a href="https://console.cloud.google.com/"><span class="url">https://console.cloud.google.com/</span></a>.</p>
    <p class="normal">Now that we have an account, let’s learn how to create a project where we will launch our resources.</p>
    <h2 class="heading-2" id="_idParaDest-512">Creating a project</h2>
    <p class="normal">GCP has a <a id="_idIndexMarker1337"/>concept whereby resources are launched into projects. If you have just signed up for an account, then a “My First Project” project will have been created for you as part of the enrollment process.</p>
    <p class="normal">If you are using an existing account, I recommend creating a new project to launch your GKE cluster. To do this, click on the <strong class="screenText">Select</strong> menu, which is located in the top bar just to the right of the GCP logo at the top left of the page.</p>
    <p class="normal">This will display all the projects you can access and allow you to create a new project. To do so, follow these steps:</p>
    <ol>
      <li class="numberedList" value="1">Click on <strong class="screenText">NEW PROJECT</strong>.</li>
      <li class="numberedList">You will be asked to do the following:<ul>
          <li class="bulletList level-2">Give your new project a name.</li>
          <li class="bulletList level-2">Select an organization to attach the project to.</li>
          <li class="bulletList level-2">Select the location; this is either an organization or a folder to store the project in.</li>
        </ul>
      </li>
      <li class="numberedList">Once details from the previous step have been entered, click the <strong class="screenText">CREATE</strong> button.</li>
    </ol>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_02.png"/></figure>
    <p class="packt_figref">Figure 15.2: Creating a new project</p>
    <p class="normal">Now that we have a place to launch our resources, we can look at installing the GCP command-line tool.</p>
    <h2 class="heading-2" id="_idParaDest-513">Installing the GCP command-line interface</h2>
    <p class="normal">Here, we are going to <a id="_idIndexMarker1338"/>cover the GCP <strong class="keyWord">Command-Line Interface</strong> (<strong class="keyWord">CLI</strong>) on your local machine. Don’t worry if you do not want to or are unable to install it, as there is a way to run the CLI in the cloud. But let’s start with my operating system of choice, macOS.</p>
    <h3 class="heading-3" id="_idParaDest-514">Installing on macOS</h3>
    <p class="normal">If <a id="_idIndexMarker1339"/>you are like me and you do a lot of work on <a id="_idIndexMarker1340"/>macOS using Terminal, there is a high likelihood that you have installed and used Homebrew at some point.</p>
    <div class="note">
      <p class="normal">For the most up-to-date installation instructions<a id="_idIndexMarker1341"/> for Homebrew, see the project’s website at <a href="https://brew.sh/"><span class="url">https://brew.sh/</span></a>.</p>
    </div>
    <p class="normal">With Homebrew installed, you will be able to install the GCP CLI using the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>brew install --cask google-cloud-sdk
</code></pre>
    <p class="normal">You can test the installation by running the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud version
</code></pre>
    <p class="normal">If <a id="_idIndexMarker1342"/>everything goes as planned, you should <a id="_idIndexMarker1343"/>see something like the following output:</p>
    <figure class="mediaobject"><img alt="A screen shot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_03.png"/></figure>
    <p class="packt_figref">Figure 15.3: Checking the version number on macOS</p>
    <p class="normal">If you are having problems, you can check the documentation linked above; for information on the GCP CLI installation, see:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>brew info --cask google-cloud-sdk
</code></pre>
    <p class="normal">Once you have the GCP CLI installed and working, you can move on to the <em class="italic">Initialization</em> section of this chapter.</p>
    <h3 class="heading-3" id="_idParaDest-515">Installing on Windows</h3>
    <p class="normal">There <a id="_idIndexMarker1344"/>are a few options for installing <a id="_idIndexMarker1345"/>the GCP CLI on Windows. The first is to open a PowerShell session and run the following command to install it using Chocolatey.</p>
    <div class="note">
      <p class="normal">Like Homebrew on macOS, Chocolatey<a id="_idIndexMarker1346"/> is a package manager that lets you easily and consistently install a wide variety of packages on Windows via PowerShell, using the same command syntax rather than having to worry about the numerous installation methods that exist on Windows – see <a href="https://chocolatey.org/"><span class="url">https://chocolatey.org/</span></a> for more information.</p>
    </div>
    <p class="normal">If you don’t have<a id="_idIndexMarker1347"/> Chocolatey installed, then you<a id="_idIndexMarker1348"/> can run the following command in a PowerShell session that has been launched with administrative privileges:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
</code></pre>
    <p class="normal">Once Chocolatey is installed, or if you already have it installed, run the following:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>choco install --ignore-checksum gcloudsdk
</code></pre>
    <p class="normal">The other way to install it is to download the installer from the following URL:</p>
    <p class="normal"><a href="https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe&#13;"><span class="url">https://dl.google.com/dl/cloudsdk/channels/rapid/GoogleCloudSDKInstaller.exe</span></a></p>
    <p class="normal">Once downloaded, run the executable by double-clicking on it and following the onscreen prompts.</p>
    <p class="normal">Once installed, open a new PowerShell window and run the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud version
</code></pre>
    <p class="normal">If everything goes as planned, you should see something like the output shown in the screenshot from the macOS version in the previous section. Again, once installed and working, you can move on to the <em class="italic">Initialization</em> section of this chapter.</p>
    <h3 class="heading-3" id="_idParaDest-516">Installing on Linux</h3>
    <p class="normal">While the<a id="_idIndexMarker1349"/> Google Cloud CLI packages are <a id="_idIndexMarker1350"/>available for most distributions, we would need a lot more space to cover the various package managers here, so instead, we will use the global installation script provided by Google.</p>
    <p class="normal">To run this, you need to use the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>curl https://sdk.cloud.google.com | bash
</code></pre>
    <p class="normal">The script will ask you several questions during the installation. For most people, answering <code class="inlineCode">Yes</code> will be fine. Once the GCP CLI is installed, run the command below to reload your session so that it picks up all of the changes made by the installer:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span><span class="hljs-con-built_in">exec</span> -l <span class="hljs-con-variable">$SHELL</span>
</code></pre>
    <p class="normal">As per the<a id="_idIndexMarker1351"/> macOS and Windows installations, which we have <a id="_idIndexMarker1352"/>covered in the previous sections, you can run the following command to find out details on the GCP CLI version that has been installed:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud version
</code></pre>
    <p class="normal">You may have noticed from the three installations that, while the installation method differs, we use the same <code class="inlineCode">gcloud</code> command once the package has been installed and get the same results. From here, it shouldn’t matter which operating system you are running, as the commands will apply to all three.</p>
    <h3 class="heading-3" id="_idParaDest-517">Cloud Shell</h3>
    <p class="normal">Before we started installing the<a id="_idIndexMarker1353"/> Google Cloud CLI, I did mention that there was a fourth option. That option is Google Cloud Shell, built into the Google Cloud console. To access this, click on the <strong class="screenText">Shell</strong> icon, which can be found on the right of the top menu.</p>
    <p class="normal">Once configured, you should see what looks to be a web-based terminal from which you can run the following:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud version
</code></pre>
    <p class="normal">The output differs slightly here, as Google has provided the full suite of supporting tools. However, you will notice from the following screen that the versions do match the ones we installed locally:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_04.png"/></figure>
    <p class="packt_figref">Figure 15.4: Using the GCP Cloud Shell</p>
    <p class="normal">If you are using <a id="_idIndexMarker1354"/>Google Cloud Shell, you can skip the initialization step below, as this has already been done for you.</p>
    <h3 class="heading-3" id="_idParaDest-518">Initialization</h3>
    <p class="normal">If you have<a id="_idIndexMarker1355"/> chosen to install the client locally, you will need to take one final step to link it to your GCP account. To do this, run the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud init
</code></pre>
    <p class="normal">This will immediately run a quick network diagnostic to ensure that the client has the connectivity it needs to run. Once the diagnostic has passed, you will be prompted with the following question:</p>
    <pre class="programlisting con"><code class="hljs-con">You must log in to continue. Would you like to log in (Y/n)?
</code></pre>
    <p class="normal">Answering <code class="inlineCode">Y</code> will open a browser window. If it doesn’t, then copy and paste the provided URL into your browser where, once you have selected the account you wish to use, you will be presented with an overview of the permissions that the client requests, as seen in the following screen:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_05.png"/></figure>
    <p class="packt_figref">Figure 15.5: Reviewing the permissions</p>
    <p class="normal">If you are happy to<a id="_idIndexMarker1356"/> grant the permissions, click the <strong class="screenText">Allow</strong> button. Back on your terminal, you will get confirmation of the user you are logged in as. Then, you will be asked to pick a cloud project to use. The list will only contain the unique ID of the project, not the friendly name that you saw or set up in Google Cloud Console earlier. If you have more than one project, please pick the correct one.</p>
    <p class="normal">Should you need to update the project that the client uses at any point, you can run the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud config <span class="hljs-con-built_in">set</span> project PROJECT_ID
</code></pre>
    <p class="normal">Make sure you replace <code class="inlineCode">PROJECT_ID</code> with the unique ID of the project you wish to switch to.</p>
    <p class="normal">Now that you have installed the Google Cloud CLI and have configured your account, you are ready to launch your GKE cluster.</p>
    <h1 class="heading-1" id="_idParaDest-519">Launching your first Google Kubernetes Engine cluster</h1>
    <p class="normal">As<a id="_idIndexMarker1357"/> the cluster will take a few minutes to deploy fully, let’s run the command to initiate the process and then discuss in more detail what happens while it launches.</p>
    <p class="normal">Before we launch our cluster, we must ensure that the <code class="inlineCode">container.googleapis.com</code> service is enabled. To do this, run the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud services <span class="hljs-con-built_in">enable</span> container.googleapis.com
</code></pre>
    <p class="normal">We then need to install a plugin that will allow us to authenticate against the cluster using <code class="inlineCode">kubectl</code>; to do this, run the following:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud components install gke-gcloud-auth-plugin
</code></pre>
    <p class="normal">Once the service and plugin have been enabled, the command to launch a two-node cluster called <code class="inlineCode">myfirstgkecluster</code>, which will be hosted in a single zone in the Central US region, is as follows:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud container clusters create myfirstgkecluster --num-nodes=2 --zone=us-central1-a
</code></pre>
    <p class="normal">After <a id="_idIndexMarker1358"/>about five minutes, you should see something that looks like the following output:</p>
    <figure class="mediaobject"><img alt="A computer screen shot of a computer program&#10;&#10;Description automatically generated" src="image/B22019_15_06.png"/></figure>
    <p class="packt_figref">Figure 15.6: Launching the cluster</p>
    <p class="normal">Once the<a id="_idIndexMarker1359"/> cluster has launched, you should be able to follow the URL in the output and view it in Google Cloud Console, as seen below:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_07.png"/></figure>
    <p class="packt_figref">Figure 15.7: Viewing the cluster in Google Cloud Console</p>
    <div class="note">
      <p class="normal">You can access the Google Cloud Console<a id="_idIndexMarker1360"/> at <a href="https://console.cloud.google.com/"><span class="url">https://console.cloud.google.com/</span></a>.</p>
    </div>
    <p class="normal">Now that our cluster is up and running, we can deploy a workload and then examine Google Cloud Console in more detail.</p>
    <h1 class="heading-1" id="_idParaDest-520">Deploying a workload and interacting with your cluster</h1>
    <p class="normal">One of the<a id="_idIndexMarker1361"/> things to note from the <a id="_idIndexMarker1362"/>feedback when we launched our cluster by running:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud container clusters create myfirstgkecluster --num-nodes=2 --zone=us-central1-a
</code></pre>
    <p class="normal">was the following line in the output:</p>
    <pre class="programlisting con"><code class="hljs-con">kubeconfig entry generated for myfirstgkecluster.
</code></pre>
    <p class="normal">As you may have guessed, this has downloaded and configured all the necessary information to connect your local copy of <code class="inlineCode">kubectl</code> to the newly deployed GKE cluster.</p>
    <p class="normal">You can confirm this by running the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl get nodes
</code></pre>
    <p class="normal">The output you get from the command should show two nodes with a prefix of <code class="inlineCode">gke</code>, so it should appear something like the following Terminal output:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_08.png"/></figure>
    <p class="packt_figref">Figure 15.8: Using kubectl to list the nodes</p>
    <p class="normal">If your <a id="_idIndexMarker1363"/>GKE cluster nodes are listed when running the preceding <a id="_idIndexMarker1364"/>output and you are happy to proceed with the current <code class="inlineCode">kubectl</code> configuration you are using, you can skip the next section of the chapter and move straight on to the <em class="italic">Launching an example workload</em> section.</p>
    <p class="normal">The <em class="italic">Further reading</em> section at the end of this chapter also provides a link to the official GKE documentation.</p>
    <h2 class="heading-2" id="_idParaDest-521">Configuring your local client</h2>
    <p class="normal">If you need to<a id="_idIndexMarker1365"/> configure another or your <code class="inlineCode">kubectl</code> installation to connect to your cluster, the GCP CLI has a command.</p>
    <div class="note">
      <p class="normal">Running the following command is based on the assumption that you have the GCP CLI installed and configured. If you don’t, please follow the instructions in the <em class="italic">Installing the GCP command-line interface </em>section of this chapter.</p>
    </div>
    <p class="normal">The command you need to run to download the credentials and configure <code class="inlineCode">kubectl</code> is as follows:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud container clusters get-credentials myfirstgkecluster --zone=us-central1-a
</code></pre>
    <p class="normal">You can run the following commands if you need to switch to or from another configuration (or context as it is known). The first command lists the current context:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl config current-context
</code></pre>
    <p class="normal">The following command lists the names of all of the contexts that you have configured:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl config get-contexts -o name
</code></pre>
    <p class="normal">Once you<a id="_idIndexMarker1366"/> know the name of the context that you need to use, you can run the following command, making sure to replace <code class="inlineCode">CONTEXT_NAME</code> with the name of the context that you change it to, as in the following:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl config use-context CONTEXT_NAME
</code></pre>
    <p class="normal">Now that your <code class="inlineCode">kubectl</code> client is configured to talk to and interact with your GKE cluster, we can launch an example workload.</p>
    <h3 class="heading-3" id="_idParaDest-522">Launching an example workload</h3>
    <p class="normal">The example workload <a id="_idIndexMarker1367"/>we will launch is the PHP/Redis Guestbook example used throughout the official Kubernetes documentation. The first step in launching the workload is to create the Redis Leader deployment and service. To do this, we use the following commands:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/kubernetes-engine-samples/main/quickstarts/guestbook/redis-leader-deployment.yaml
<span class="hljs-con-meta">$ </span>kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/kubernetes-engine-samples/main/quickstarts/guestbook/redis-leader-service.yaml
</code></pre>
    <p class="normal">Next up, we need to repeat the process but, this time, to launch the Redis Follower deployment and service, as shown here:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/kubernetes-engine-samples/main/quickstarts/guestbook/redis-follower-deployment.yaml
<span class="hljs-con-meta">$ </span>kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/kubernetes-engine-samples/main/quickstarts/guestbook/redis-follower-service.yaml
</code></pre>
    <p class="normal">Now that we have Redis up and running, it is time to launch the frontend deployment and service; this is the application itself:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/kubernetes-engine-samples/main/quickstarts/guestbook/frontend-deployment.yaml
<span class="hljs-con-meta">$ </span>kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/kubernetes-engine-samples/main/quickstarts/guestbook/frontend-service.yaml
</code></pre>
    <p class="normal">After a few minutes, you should be able to run the following command to get information on the service you have just launched:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl get service frontend
</code></pre>
    <p class="normal">The output of the command should give you an external IP address that looks like the following Terminal output:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_09.png"/></figure>
    <p class="packt_figref">Figure 15.9: Getting information on the frontend service</p>
    <p class="normal">Now that we have launched our application, copy the <code class="inlineCode">EXTERNAL-IP</code> value and put the IP address into your browser; make sure you use <code class="inlineCode">http://EXTERNAL-IP</code> rather than <code class="inlineCode">https://EXTERNAL-IP</code>, as the Guestbook listens on port <code class="inlineCode">80</code> and not <code class="inlineCode">443</code>.</p>
    <p class="normal">You should be presented<a id="_idIndexMarker1368"/> with the simple Guestbook application when you open the address in your browser. Try submitting a few messages, as shown in the following screen:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_10.png"/></figure>
    <p class="packt_figref">Figure 15.10: The Guestbook application with a few test messages</p>
    <p class="normal">Now that we have launched our basic workload, let’s return to and explore Google Cloud Console.</p>
    <h2 class="heading-2" id="_idParaDest-523">Exploring Google Cloud Console</h2>
    <p class="normal">We have already seen our cluster in <a id="_idIndexMarker1369"/>Google Cloud Console, so next, click on the <strong class="screenText">Workloads</strong> link, which is in the left-hand menu of the <strong class="screenText">Kubernetes Engine</strong> section.</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_11.png"/></figure>
    <p class="packt_figref">Figure 15.11: Viewing the workload in the console</p>
    <p class="normal">As you can see from the preceding screen, the three deployments are listed, along with confirmation of the namespace they are in and the cluster that the workload belongs to.</p>
    <p class="normal">If we had more than one cluster with multiple namespaces and deployments, we could use the filter to drill down into our GKE workloads.</p>
    <h3 class="heading-3" id="_idParaDest-524">Workloads</h3>
    <p class="normal">Clicking <a id="_idIndexMarker1370"/>on the <strong class="screenText">frontend</strong> deployment will let you view more information:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_12.png"/></figure>
    <p class="packt_figref">Figure 15.12: Getting an overview of the frontend deployment</p>
    <p class="normal">On this page, you will be able to drill<a id="_idIndexMarker1371"/> further down into your deployment using the tabs below the deployment name, as follows:</p>
    <ul>
      <li class="bulletList"><strong class="screenText">OVERVIEW</strong>: This view gives you an overview of the selected workload. As you can see from the previous screenshot, you can see the CPU, memory, and disk utilization, along with other information.</li>
      <li class="bulletList"><strong class="screenText">DETAILS</strong>: This lists more information about the environment and workload itself. Here, you can find out when it was created, annotations, labels (as well as details about the replicas), the update strategy, and Pod information.</li>
      <li class="bulletList"><strong class="screenText">OBSERVABILITY</strong>: Here, you can view all metrics on your workload’s infrastructure.</li>
      <li class="bulletList"><strong class="screenText">REVISION HISTORY</strong>: Here, you will find a list of all the workload revisions. This is useful if your deployment is updated frequently and you need to keep track of when the deployment was updated.</li>
      <li class="bulletList"><strong class="screenText">EVENTS</strong>: If you have any problems with your workload, this is the place to look. All events, such as scaling, pod availability, and other errors, will be listed here.</li>
      <li class="bulletList"><strong class="screenText">LOGS</strong>: This is a searchable list of the logs from all containers running the pod.</li>
      <li class="bulletList"><strong class="screenText">APP ERRORS</strong>: Here, you will find any application errors.</li>
      <li class="bulletList"><strong class="screenText">YAML</strong>: This is an exportable <a id="_idIndexMarker1372"/>YAML file containing the full deployment configuration.</li>
    </ul>
    <p class="normal">This information is available for all the deployments across all the GKE clusters you have launched within the project.</p>
    <h3 class="heading-3" id="_idParaDest-525">Gateways, Services, and Ingress</h3>
    <p class="normal">In this section, we will look at<a id="_idIndexMarker1373"/> the <strong class="screenText">Gateways, Services and Ingress</strong> section. As you may have already guessed, this lists all the services launched across your GKE clusters. You can do this by clicking on <strong class="keyWord">Gateways, Services and Ingress</strong>.</p>
    <p class="normal">When you first go to this section, it will default to the <strong class="screenText">GATEWAYS</strong> tab, but we haven’t launched a gateway, so you need to click on the <strong class="screenText">SERVICES</strong> tab. When this loads, you will be presented with a screen that looks like the following:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer&#10;&#10;Description automatically generated" src="image/B22019_15_13.png"/></figure>
    <p class="packt_figref">Figure 15.13: Viewing the services in the console</p>
    <p class="normal">As you can see, the three services we launched are listed. However, the <strong class="screenText">frontend</strong> service has an <strong class="screenText">External load balancer</strong> type and a public IP address listed, as opposed to the <strong class="screenText">redis-leader</strong> and <strong class="screenText">redis-follower</strong> services, which only have a <strong class="screenText">Cluster IP</strong>.</p>
    <p class="normal">This is because, of the three services, we only want the frontend service to be accessible publicly, as only our frontend service uses the two Redis services.</p>
    <p class="normal">When the external load balancer was launched, as we were running our cluster in a public cloud provider, the Kubernetes scheduler knew to contact the Google Cloud API and launch a load balancer for use. It then configured it to talk back to our cluster nodes, exposing the workload; this deployment runs on port <strong class="screenText">80</strong> externally, and traffic is passed back to port <strong class="screenText">31740</strong> on the nodes.</p>
    <p class="normal">As before, clicking on one of the<a id="_idIndexMarker1374"/> three running services will give you several pieces of information:</p>
    <ul>
      <li class="bulletList"><strong class="screenText">OVERVIEW</strong>: This view gives you a summary of the service configuration and utilization.</li>
      <li class="bulletList"><strong class="screenText">DETAILS</strong>: Here, you can find more details on the service and a link to view the load balancer resource that has been launched within our Google Cloud project.</li>
      <li class="bulletList"><strong class="screenText">EVENTS</strong>: As before, you can find any events affecting the service here. This is useful for troubleshooting.</li>
      <li class="bulletList"><strong class="screenText">LOGS</strong>: This is a repeat of the logs shown in the <strong class="screenText">Workloads</strong> section.</li>
      <li class="bulletList"><strong class="screenText">APP ERRORS</strong>: You will be able to find any application errors here.</li>
      <li class="bulletList"><strong class="screenText">YAML</strong>: Again, this is a way to export the complete service configuration as a YAML file.</li>
    </ul>
    <p class="normal">While this covers the basic workload we launched, GKE offers plenty of other options and features. Let’s quickly work through the functionality hidden behind the other items in the left-hand menu.</p>
    <h3 class="heading-3" id="_idParaDest-526">Other GKE features</h3>
    <p class="normal">There are two types of features supported by GKE; the ones listed below are the standard ones. There are also Enterprise features that can be enabled when you run GKE Enterprise, which we will discuss at the end of this section:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Clusters</strong>: Here, you<a id="_idIndexMarker1375"/> can manage your clusters; you will see the cluster we launched using the GCP CLI and have the option of creating more clusters, using the guided web interface.</li>
      <li class="bulletList"><strong class="keyWord">Workloads</strong>: As <a id="_idIndexMarker1376"/>already covered, you will find the workloads you have deployed to your clusters.</li>
      <li class="bulletList"><strong class="keyWord">Applications</strong>: This will show you any applications<a id="_idIndexMarker1377"/> you have deployed from the Marketplace, which we will cover in a moment.</li>
      <li class="bulletList"><strong class="keyWord">Secrets and ConfigMaps</strong>: Here, you <a id="_idIndexMarker1378"/>can securely manage your <a id="_idIndexMarker1379"/>Secrets and ConfigMaps.</li>
      <li class="bulletList"><strong class="keyWord">Storage</strong>: You can view any persistent storage<a id="_idIndexMarker1380"/> claims you have configured here and manage storage classes.</li>
      <li class="bulletList"><strong class="keyWord">Object Browser</strong>: Think of this as <a id="_idIndexMarker1381"/>an explorer for the K8s and GCP API; clicking through it gives you an overview of all the possible APIs and endpoints you can interact with and what objects/resources are currently deployed.</li>
    </ul>
    <p class="normal">The following services bring native Google services into GKE:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Backup for GKE</strong>: Here, you can use GCP’s backup service, which is outside the GKE offering, to back<a id="_idIndexMarker1382"/> up your GKE-hosted workloads and applications. Personally, when I run a Kubernetes workload in the cloud, the data within it is ephemeral. For services such as databases, where I would want to have backups, they run in an SLA-backed, cloud-native service outside of my cluster – but if, for whatever reason, you can’t do that, then this service has you covered.</li>
      <li class="bulletList"><strong class="keyWord">Gateways, Services and Ingress</strong>: We have<a id="_idIndexMarker1383"/> already covered this option.</li>
      <li class="bulletList"><strong class="keyWord">Network Function Optimizer</strong>: You can link your GKE workloads to other GCP resources’ private networking here. This <a id="_idIndexMarker1384"/>allows you to extend your cluster network so that services like Google Cloud databases can be accessed privately by your cluster resources.</li>
      <li class="bulletList"><strong class="keyWord">Marketplace</strong>: Here, you will find<a id="_idIndexMarker1385"/> pre-packaged applications to run in your GKE cluster. They are published by various software vendors and include both free and commercial offerings.</li>
    </ul>
    <p class="normal">As mentioned, the features above are available in the standard edition of GKE; this edition is like rolling your own Kubernetes deployment, except Google takes care of the node deployment and management plan for you.</p>
    <p class="normal">Then, there is the Enterprise edition; as you might have guessed, this introduces additional features that an enterprise deploying Kubernetes may require, such as managed services meshes and security, compliance, and role-based access control options. These features come at an extra cost but are essential for larger organizations that may work in more regulated industries.</p>
    <h3 class="heading-3" id="_idParaDest-527">Deleting your cluster</h3>
    <p class="normal">Once you finish with your cluster, you can remove<a id="_idIndexMarker1386"/> it by running the following commands. The first removes the service we created, and the second terminates the cluster itself:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl delete service frontend
<span class="hljs-con-meta">$ </span>gcloud container clusters delete myfirstgkecluster --zone=us-central1-a
</code></pre>
    <p class="normal">It will take a few minutes to remove the cluster; please ensure that you wait until this process finishes.</p>
    <div class="note">
      <p class="normal">This should also delete any services launched by your workloads, such as load balancers. However, I recommend double-checking the Google Cloud Console for any orphaned services or resources to ensure that you do not incur unexpected costs.</p>
    </div>
    <p class="normal">We have been using the <code class="inlineCode">--zone=us-central1-a</code> flag, which launches our cluster in a single availability zone in the US Central region. Let’s discuss what other cluster options are available.</p>
    <h1 class="heading-1" id="_idParaDest-528">More about cluster nodes</h1>
    <p class="normal">At the end of the previous section, I mentioned availability zones and regions. Before we discuss some of the cluster deployment options, we should get a slightly better understanding of what we mean by availability zones and regions:</p>
    <ul>
      <li class="bulletList"><strong class="keyWord">Region</strong>: A region<a id="_idIndexMarker1387"/> is made up of zones. Zones have great low-latency network connectivity to other zones within the same region. This gives you a way of deploying highly available, always-on, fault-tolerant workloads.</li>
      <li class="bulletList"><strong class="keyWord">Availability zone</strong>: Think of <a id="_idIndexMarker1388"/>availability zones as separate data centers within a region. The zones have diverse networks and power, meaning that if a single zone has an issue and you run your workload across multiple zones, your workload shouldn’t be impacted.</li>
    </ul>
    <p class="normal">The one thing to note with zones is that you might find that not all machine types are available across all zones within a region. Therefore, please check before attempting to deploy your workload.</p>
    <p class="normal">Google best practices recommend that you deploy your workload across the maximum number of zones within a single region for optimum performance and availability.</p>
    <p class="normal">However, it is possible to split your workloads across multiple regions by using Multi Cluster Ingress – all you have to do is account for and allow the increased latency between regions for shared services, such as databases. For more information on Multi Cluster Ingress, see the <em class="italic">Further reading</em> section at the end of the chapter.</p>
    <p class="normal">Let’s get back to looking at launching a cluster in a single region across multiple zones, by examining the command we used to launch the test cluster at the start of the chapter:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud container clusters create myfirstgkecluster --num-nodes=2 --zone=us-central1-a
</code></pre>
    <p class="normal">As we know, it will launch<a id="_idIndexMarker1389"/> two nodes but only in a single zone. We have only passed one using the <code class="inlineCode">-zone</code> flag, which, in our case, was the <code class="inlineCode">us-central1</code> region and zone <code class="inlineCode">a</code>.</p>
    <p class="normal">Let’s run the following command but use the <code class="inlineCode">--region</code> flag rather than the <code class="inlineCode">--zone</code> one:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud container clusters create myfirstgkecluster --num-nodes=2 --region=us-central1
</code></pre>
    <p class="normal">Once launched, run the following:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>kubectl get nodes
</code></pre>
    <p class="normal">This should output something that looks like the following:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer program&#10;&#10;Description automatically generated" src="image/B22019_15_14.png"/></figure>
    <p class="packt_figref">Figure 15.14: Viewing the nodes running in a region</p>
    <p class="normal">As you can see, we have two nodes in each zone, giving us a total cluster size of six nodes. This is because when you define a region by default, your cluster is spread across three zones. You can override this using the <code class="inlineCode">--node-locations</code> flag.</p>
    <p class="normal">This makes our command look like the following if we wanted to deploy a cluster from scratch; as you can see, we now have a comma-separated list of availability zones:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud container clusters create myfirstgkecluster --num-nodes=2 --region=us-central1 --node-locations us-central1-a,us-central1-b,us-central1-c,us-central1-f
</code></pre>
    <p class="normal">We are still using the <code class="inlineCode">us-central1</code> region but deploying to the <code class="inlineCode">a</code>, <code class="inlineCode">b</code>, <code class="inlineCode">c</code>, and <code class="inlineCode">f</code> zones.</p>
    <p class="normal">Given that we already<a id="_idIndexMarker1390"/> have a cluster running, we can run the following command to update the cluster, adding the new availability zone and two new nodes:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud container clusters update myfirstgkecluster --min-nodes=2 --region=us-central1 --node-locations us-central1-a,us-central1-b,us-central1-c,us-central1-f
</code></pre>
    <p class="normal">Running the <code class="inlineCode">kubectl get nodes</code> command now shows the following:</p>
    <figure class="mediaobject"><img alt="A screenshot of a computer program&#10;&#10;Description automatically generated" src="image/B22019_15_15.png"/></figure>
    <p class="packt_figref">Figure 15.15: Our cluster now running across four availability zones</p>
    <p class="normal">As you can see, Google has made deploying your clusters straightforward across multiple zones. This means that you can deploy your workload across a fully redundant cluster with minimal effort; given the complexity involved in replicating this type of deployment manually using virtual machines and networks, the ease is very welcome.</p>
    <p class="normal">To remove clusters deployed using the <code class="inlineCode">--region</code> flag, you should use the following command:</p>
    <pre class="programlisting con"><code class="hljs-con"><span class="hljs-con-meta">$ </span>gcloud container clusters delete myfirstgkecluster --region=us-central1
</code></pre>
    <p class="normal">At the time of writing, the simple two-node cluster we launched at the start of the chapter costs around $55 per month, and the price increases to around $347 per month for the eight-node cluster we just launched. For more cost information, see the Google Cloud Pricing Calculator link in the <em class="italic">Further reading</em> section.</p>
    <p class="normal">This concludes our look at GKE. Before we move on to the next public cloud provider, let’s summarize what we have covered.</p>
    <h1 class="heading-1" id="_idParaDest-529">Summary</h1>
    <p class="normal">In this chapter, we discussed the origins of GCP and the GKE service, before walking through how to sign up for an account and how to install and configure the Google Cloud command-line tool.</p>
    <p class="normal">We then launched a simple two-node cluster using a single command, and then we deployed and interacted with a workload, using the <code class="inlineCode">kubectl</code> command and Google Cloud Console.</p>
    <p class="normal">Finally, again using only a single command, we redeployed our cluster to take advantage of multiple availability zones, quickly scaling to a fully redundant and highly available eight-node cluster that runs across four availability zones.</p>
    <p class="normal">I am sure you will agree that Google has done an excellent job of making deploying and maintaining a complex infrastructure configuration a relatively trivial and quick task.</p>
    <p class="normal">Also, once your workloads are deployed, you can manage them the same way you would if your cluster were deployed elsewhere – we really haven’t had to make any allowances for our cluster being run on GCP.</p>
    <p class="normal">The next chapter will examine deploying a Kubernetes cluster in AWS using Amazon Elastic Kubernetes Service, Amazon’s fully managed Kubernetes offering.</p>
    <h1 class="heading-1" id="_idParaDest-530">Further reading</h1>
    <p class="normal">Here are links to more information on some of the topics and tools that we have covered in this chapter:</p>
    <ul>
      <li class="bulletList">Google Kubernetes Engine: <a href="https://cloud.google.com/kubernetes-engine/&#13;"><span class="url">https://cloud.google.com/kubernetes-engine/</span></a></li>
      <li class="bulletList">Google Kubernetes Engine Documentation: <a href="https://cloud.google.com/kubernetes-engine/docs&#13;"><span class="url">https://cloud.google.com/kubernetes-engine/docs</span></a></li>
      <li class="bulletList">Google Cloud Pricing Calculator: <a href="https://cloud.google.com/products/calculator&#13;"><span class="url">https://cloud.google.com/products/calculator</span></a></li>
      <li class="bulletList">The Guestbook Sample Application: <a href="https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/tree/main/quickstarts/guestbook"><span class="url">https://github.com/GoogleCloudPlatform/kubernetes-engine-samples/tree/main/quickstarts/guestbook</span></a></li>
      <li class="bulletList">The Google Cloud Kubernetes comic: <a href="https://cloud.google.com/kubernetes-engine/kubernetes-comic&#13;"><span class="url">https://cloud.google.com/kubernetes-engine/kubernetes-comic</span></a></li>
      <li class="bulletList">Regional Clusters: <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/regional-clusters&#13;"><span class="url">https://cloud.google.com/kubernetes-engine/docs/concepts/regional-clusters</span></a></li>
      <li class="bulletList">Multi Cluster Ingress: <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/multi-cluster-ingress&#13;"><span class="url">https://cloud.google.com/kubernetes-engine/docs/concepts/multi-cluster-ingress</span></a></li>
    </ul>
    <h1 class="heading-1" id="_idParaDest-531">Join our community on Discord</h1>
    <p class="normal">Join our community’s Discord space for discussions with the authors and other readers:</p>
    <p class="normal"><a href="https://packt.link/cloudanddevops"><span class="url">https://packt.link/cloudanddevops</span></a></p>
    <p class="normal"><img alt="" src="image/QR_Code119001106479081656.png"/></p>
  </div>
</body></html>