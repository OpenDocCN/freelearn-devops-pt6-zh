<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Kubernetes on GCP</span></h1>
                </header>
            
            <article>
                
<p><strong><span class="koboSpan" id="kobo.2.1">Google Cloud Platform</span></strong><span class="koboSpan" id="kobo.3.1"> (</span><strong><span class="koboSpan" id="kobo.4.1">GCP</span></strong><span class="koboSpan" id="kobo.5.1">) is becoming popular in the public cloud industry that's provided by Google. </span><span class="koboSpan" id="kobo.5.2">GCP has concepts that are similar to those provided by AWS, such as VPC, Compute Engine, Persistent Disk, Load Balancing, and several managed services. </span><span class="koboSpan" id="kobo.5.3">In this chapter, you'll learn about GCP and how to set up Kubernetes on GCP through the following topics:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.6.1">Understanding GCP</span></li>
<li><span class="koboSpan" id="kobo.7.1">Using and understanding GCP components</span></li>
<li><span class="koboSpan" id="kobo.8.1">Using </span><span><strong><span class="koboSpan" id="kobo.9.1">Google Kubernetes Engine</span></strong><span class="koboSpan" id="kobo.10.1"> (</span><strong><span class="koboSpan" id="kobo.11.1">GKE</span></strong><span class="koboSpan" id="kobo.12.1">)</span></span><span class="koboSpan" id="kobo.13.1">, the hosted Kubernetes service</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Introduction to GCP</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">GCP was officially launched in 2011. </span><span class="koboSpan" id="kobo.2.2">Unlike AWS, GCP initially provided </span><strong><span class="koboSpan" id="kobo.3.1">PaaS</span></strong><span class="koboSpan" id="kobo.4.1"> (</span><strong><span class="koboSpan" id="kobo.5.1">Platform as a Service</span></strong><span class="koboSpan" id="kobo.6.1">). </span><span><span class="koboSpan" id="kobo.7.1">Consequently, you can deploy</span></span><span class="koboSpan" id="kobo.8.1"> your </span><span><span class="koboSpan" id="kobo.9.1">application directly instead of launching a VM. </span><span class="koboSpan" id="kobo.9.2">After that,</span></span><span class="koboSpan" id="kobo.10.1"> GCP added some services and </span><span><span class="koboSpan" id="kobo.11.1">functionalities.</span></span></p>
<p><span class="koboSpan" id="kobo.12.1">The most important service for Kubernetes users is GKE, which is a hosted Kubernetes service. </span><span class="koboSpan" id="kobo.12.2">So, you can get some relief from Kubernetes installation, upgrades, and management. </span><span class="koboSpan" id="kobo.12.3">This has a pay–as–you–go style approach to using the Kubernetes cluster. </span><span class="koboSpan" id="kobo.12.4">GKE is also a very active service that keeps providing new versions of Kubernetes in a timely manner and keeps coming up with new features and management tools for Kubernetes as well.</span></p>
<p><span class="koboSpan" id="kobo.13.1">Let's take a look at what kind of foundation and services GCP provides and then we'll explore GKE.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">GCP components</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">GCP provides a web console and </span><strong><span class="koboSpan" id="kobo.3.1">Command-Line Interface</span></strong><span class="koboSpan" id="kobo.4.1"> (</span><strong><span class="koboSpan" id="kobo.5.1">CLI</span></strong><span class="koboSpan" id="kobo.6.1">). </span><span class="koboSpan" id="kobo.6.2">Both make it easy and straightforward to control the GCP infrastructure, but Google accounts (such as Gmail) are required for use. </span><span class="koboSpan" id="kobo.6.3">Once you have a Google account, go to the GCP sign-up page (</span><a href="https://cloud.google.com/free/" target="_blank"><span class="URLPACKT"><span class="koboSpan" id="kobo.7.1">https://cloud.google.com/free/</span></span></a><span class="koboSpan" id="kobo.8.1">) to set up your GCP account.</span></p>
<p><span class="koboSpan" id="kobo.9.1">If you want to control the GCP component via CLI, you need to install the Cloud SDK (</span><a href="https://cloud.google.com/sdk/gcloud/" target="_blank"><span class="URLPACKT"><span class="koboSpan" id="kobo.10.1">https://cloud.google.com/sdk/gcloud/</span></span></a><span class="koboSpan" id="kobo.11.1">), which is similar to the AWS CLI that you can use to list, create, update, and delete GCP resources. </span><span class="koboSpan" id="kobo.11.2">After installing the Cloud SDK, you need to configure it with the following commands to associate it to a GCP account:</span></p>
<pre><strong><span class="koboSpan" id="kobo.12.1">$ gcloud init</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">VPC</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">VPC in GCP is quite a different policy compared with AWS. </span><span class="koboSpan" id="kobo.2.2">First of all, you don't need to set the CIDR prefix to VPC. </span><span class="koboSpan" id="kobo.2.3">In other words, you can't set CIDR to VPC. </span><span class="koboSpan" id="kobo.2.4">Instead, you just add one or some subnets to the VPC. </span><span class="koboSpan" id="kobo.2.5">Because you have to set certain CIDR blocks with a subnet, GCP VPC is therefore identified as a logical group of subnets, and subnets within VPC can communicate with each other.</span></p>
<p><span class="koboSpan" id="kobo.3.1">Note that GCP VPC has two subnet modes, either </span><kbd><span class="koboSpan" id="kobo.4.1">auto</span></kbd><span class="koboSpan" id="kobo.5.1"> or </span><kbd><span class="koboSpan" id="kobo.6.1">custom</span></kbd><span class="koboSpan" id="kobo.7.1">. </span><span class="koboSpan" id="kobo.7.2">If you choose </span><kbd><span class="koboSpan" id="kobo.8.1">auto</span></kbd><span class="koboSpan" id="kobo.9.1">, it will create some subnets on each region with predefined CIDR blocks. </span><span class="koboSpan" id="kobo.9.2">For example, type the following command:</span></p>
<pre><strong><span class="koboSpan" id="kobo.10.1">$ gcloud compute networks create my-auto-network --subnet-mode auto</span></strong></pre>
<p><span class="koboSpan" id="kobo.11.1">This will create 18 subnets as shown in the following screenshot (because, as of December 2018, GCP has 18 regions):</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.12.1"><img class=" image-border" src="assets/97317dd4-0e8e-4acf-9ad8-f10b520f604b.png" style="width:52.67em;height:50.75em;"/></span></div>
<p><span class="koboSpan" id="kobo.13.1">Auto mode VPC is probably good to start with. </span><span class="koboSpan" id="kobo.13.2">However, in auto mode, you can't specify the CIDR prefix and 18 subnets from all regions might not fit your use case. </span><span class="koboSpan" id="kobo.13.3">For example, connect to your on–premise data center via VPN. </span><span class="koboSpan" id="kobo.13.4">Another example is creating subnets on a specific region only.</span></p>
<p><span class="koboSpan" id="kobo.14.1">In this case, choose custom mode VPC, then you can create subnets with the desired CIDR prefix manually. </span><span class="koboSpan" id="kobo.14.2">Type the following command to create a custom mode VPC:</span></p>
<pre><strong><span class="koboSpan" id="kobo.15.1">//create custom mode VPC which is named my-custom-network</span><br/><span class="koboSpan" id="kobo.16.1">$ gcloud compute networks create my-custom-network --subnet-mode custom</span></strong></pre>
<p><span class="koboSpan" id="kobo.17.1">Because custom mode VPC won't create any subnets, as shown in the following screenshot, let's add subnets onto this custom mode VPC:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.18.1"><img class=" image-border" src="assets/48ae1c35-e025-405c-863c-1d5a2005af64.png" style="width:41.67em;height:2.50em;"/></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Subnets</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">In GCP, subnets are always found across multiple zones (availability zones) within a region. </span><span class="koboSpan" id="kobo.2.2">In other words, you can't create subnets on a single zone like AWS. </span><span class="koboSpan" id="kobo.2.3">You always need to specify entire regions when creating a subnet.</span></p>
<p><span class="koboSpan" id="kobo.3.1">In addition, unlike AWS, there are no significant concepts of public and private subnets (in AWS, a public subnet has a default route as IGW; on the other hand, a private subnet has a default route as the NAT gateway). </span><span class="koboSpan" id="kobo.3.2">This is because all subnets in GCP have a route to an internet gateway.</span></p>
<p><span class="koboSpan" id="kobo.4.1">Instead of subnet-level access control, GCP uses host (instance)-level access control using </span><strong><span class="koboSpan" id="kobo.5.1">network tags</span></strong><span class="koboSpan" id="kobo.6.1"> to ensure network </span><span><span class="koboSpan" id="kobo.7.1">security</span></span><span><span class="koboSpan" id="kobo.8.1">. </span><span class="koboSpan" id="kobo.8.2">This will be described in more detail in the following section.</span></span></p>
<p><span class="koboSpan" id="kobo.9.1">It might make network administrators nervous; however, GCP best practice gives you a much more simplified and scalable VPC administration because you can add subnets at any time to expand entire network blocks.</span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.10.1">Technically, you can launch a VM instance and set it up as a NAT gateway or HTTP proxy, and then create a custom priority route for the private subnet that points to the NAT/proxy instance to achieve an AWS–like private subnet.</span><br/><span class="koboSpan" id="kobo.11.1">
Please refer to the following online document for details: </span><a href="https://cloud.google.com/compute/docs/vpc/special-configurations" target="_blank"><span class="URLPACKT"><span class="koboSpan" id="kobo.12.1">https://cloud.google.com/compute/docs/vpc/special-configurations</span></span></a><span class="URLPACKT"><span class="koboSpan" id="kobo.13.1">.</span></span></div>
<p><span class="koboSpan" id="kobo.14.1">One more thing: an interesting and unique concept of GCP VPC is that you can add different CIDR prefix network blocks to a single VPC. </span><span class="koboSpan" id="kobo.14.2">For example, if you have custom mode VPC, then add the following three subnets:</span></p>
<ul>
<li><kbd><span class="koboSpan" id="kobo.15.1">subnet-a</span></kbd><span class="koboSpan" id="kobo.16.1"> (</span><kbd><span class="koboSpan" id="kobo.17.1">10.0.1.0/24</span></kbd><span class="koboSpan" id="kobo.18.1">) from </span><kbd><span class="koboSpan" id="kobo.19.1">us-west1</span></kbd></li>
<li><kbd><span class="koboSpan" id="kobo.20.1">subnet-b</span></kbd><span class="koboSpan" id="kobo.21.1"> (</span><kbd><span class="koboSpan" id="kobo.22.1">172.16.1.0/24</span></kbd><span class="koboSpan" id="kobo.23.1">) from </span><kbd><span class="koboSpan" id="kobo.24.1">us-east1</span></kbd></li>
<li><kbd><span class="koboSpan" id="kobo.25.1">subnet-c</span></kbd><span class="koboSpan" id="kobo.26.1"> (</span><kbd><span class="koboSpan" id="kobo.27.1">192.168.1.0/24</span></kbd><span class="koboSpan" id="kobo.28.1">) from </span><kbd><span class="koboSpan" id="kobo.29.1">asia-northeast1</span></kbd></li>
</ul>
<p><span class="koboSpan" id="kobo.30.1">The following commands will create three subnets from three different regions with different CIDR prefixes:</span></p>
<pre><strong><span class="koboSpan" id="kobo.31.1">$ gcloud compute networks subnets create subnet-a --network=my-custom-network --range=10.0.1.0/24 --region=us-west1</span><br/><span class="koboSpan" id="kobo.32.1">$ gcloud compute networks subnets create subnet-b --network=my-custom-network --range=172.16.1.0/24 --region=us-east1</span><br/><span class="koboSpan" id="kobo.33.1">$ gcloud compute networks subnets create subnet-c --network=my-custom-network --range=192.168.1.0/24 --region=asia-northeast1</span></strong></pre>
<p><span class="koboSpan" id="kobo.34.1">The result will be the following web console. </span><span class="koboSpan" id="kobo.34.2">If you're familiar with AWS VPC, you won't believe these combinations of CIDR prefixes are available within a single VPC! </span><span class="koboSpan" id="kobo.34.3">This means that, whenever you need to expand a network, you can assign another CIDR prefix to the VPC:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.35.1"><img class=" image-border" src="assets/4f340bc1-8c47-4343-b178-3c6e925027de.png" style="width:43.33em;height:9.08em;"/></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Firewall rules</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">As </span><span><span class="koboSpan" id="kobo.3.1">previously</span></span><span><span class="koboSpan" id="kobo.4.1"> mentioned, the GCP</span></span><span class="koboSpan" id="kobo.5.1"> firewall </span><span><span class="koboSpan" id="kobo.6.1">rule is important for achieving network security. </span><span class="koboSpan" id="kobo.6.2">However, the GCP firewall is more simple and flexible than an AWS</span></span> <strong><span class="koboSpan" id="kobo.7.1">Security Group</span></strong> <span><span class="koboSpan" id="kobo.8.1">(</span></span><strong><span class="koboSpan" id="kobo.9.1">SG</span></strong><span><span class="koboSpan" id="kobo.10.1">). </span><span class="koboSpan" id="kobo.10.2">For example, in AWS, when you launch an EC2 instance, you have to</span></span><span class="koboSpan" id="kobo.11.1"> assign </span><span><span class="koboSpan" id="kobo.12.1">at least one SG that is tightly coupled with EC2 and SG. </span><span class="koboSpan" id="kobo.12.2">On the</span></span><span class="koboSpan" id="kobo.13.1"> other </span><span><span class="koboSpan" id="kobo.14.1">hand, in GCP, you can't assign any firewall rules directly. </span><span class="koboSpan" id="kobo.14.2">Instead, firewall rule and VM instance are loosely coupled via a</span></span> <strong><span class="koboSpan" id="kobo.15.1">network tag</span></strong><span><span class="koboSpan" id="kobo.16.1">. </span><span class="koboSpan" id="kobo.16.2">Consequently, there's no direct association between the firewall rule and VM instance.</span></span></p>
<p><span><span class="koboSpan" id="kobo.17.1">The following diagram is a comparison between AWS security groups and GCP firewall rules. </span><span class="koboSpan" id="kobo.17.2">EC2 requires</span></span><span class="koboSpan" id="kobo.18.1"> a security </span><span><span class="koboSpan" id="kobo.19.1">group, while the GCP VM instance just sets a tag. </span><span class="koboSpan" id="kobo.19.2">This is irrespective of whether the corresponding firewall has the same tag or not:</span></span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.20.1"><img class=" image-border" src="assets/0a5b3849-c025-48c3-90df-8aebfbdb6ba5.png" style="width:39.50em;height:14.17em;"/></span></div>
<p><span class="koboSpan" id="kobo.21.1">For example, create a firewall rule for a public host (use the </span><kbd><span class="koboSpan" id="kobo.22.1">public</span></kbd> <span><span class="koboSpan" id="kobo.23.1">network tag</span></span><span class="koboSpan" id="kobo.24.1">) and a private host (use the </span><kbd><span class="koboSpan" id="kobo.25.1">private</span></kbd> <span><span class="koboSpan" id="kobo.26.1">network tag</span></span><span class="koboSpan" id="kobo.27.1">), as given in the following command:</span></p>
<pre><strong><span class="koboSpan" id="kobo.28.1">//create ssh access for public host</span><br/><span class="koboSpan" id="kobo.29.1">$ gcloud compute firewall-rules create public-ssh --network=my-custom-network --allow="tcp:22" --source-ranges="0.0.0.0/0" --target-tags="public"</span><br/></strong><strong><br/><span class="koboSpan" id="kobo.30.1">//create http access (80/tcp for public host)</span><br/><span class="koboSpan" id="kobo.31.1">$ gcloud compute firewall-rules create public-http --network=my-custom-network --allow="tcp:80" --source-ranges="0.0.0.0/0" --target-tags="public"</span><br/></strong><strong><br/><span class="koboSpan" id="kobo.32.1">//create ssh access for private host (allow from host which has "public" tag)
$ gcloud compute firewall-rules create private-ssh --network=my-custom-network --allow="tcp:22" --source-tags="public" --target-tags="private"</span><br/><br/><span class="koboSpan" id="kobo.33.1">//create icmp access for internal each other (allow from host which has either "public" or "private")</span><br/><span class="koboSpan" id="kobo.34.1">$ gcloud compute firewall-rules create internal-icmp --network=my-custom-network --allow="icmp" --source-tags="public,private"</span></strong></pre>
<p><span class="koboSpan" id="kobo.35.1">This creates four firewall rules as shown in the following screenshot. </span><span class="koboSpan" id="kobo.35.2">Let's create VM instances to use either the </span><kbd><span class="koboSpan" id="kobo.36.1">public</span></kbd><span class="koboSpan" id="kobo.37.1"> or </span><kbd><span class="koboSpan" id="kobo.38.1">private</span></kbd><span class="koboSpan" id="kobo.39.1"> network tag to see how it works:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.40.1"><img class=" image-border" src="assets/2fe8b575-2875-4f41-aebf-8fe951dacc08.png" style="width:52.92em;height:18.92em;"/></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">VM instances</span></h1>
                </header>
            
            <article>
                
<p><span><span class="koboSpan" id="kobo.2.1">In GCP, a </span></span><span class="koboSpan" id="kobo.3.1">VM instance is quite similar to AWS EC2. </span><span class="koboSpan" id="kobo.3.2">You can choose from a variety of machine (instance) types that have different hardware configurations; you can also choose a </span><span><span class="koboSpan" id="kobo.4.1">Linux-or Windows-based OS or your customized OS</span></span><span class="koboSpan" id="kobo.5.1">.</span></p>
<p><span class="koboSpan" id="kobo.6.1">As mentioned when talking about firewall rules, you can specify any number of network tags. </span><span class="koboSpan" id="kobo.6.2">A tag doesn't necessarily need to be created beforehand. </span><span class="koboSpan" id="kobo.6.3">This means you can launch VM instances with network tags first, even though a firewall rule isn't created. </span><span class="koboSpan" id="kobo.6.4">It's still valid, but no firewall rule is applied in this case. </span><span class="koboSpan" id="kobo.6.5">Then you can create a firewall rule with a network tag. </span><span class="koboSpan" id="kobo.6.6">Eventually a firewall rule will be applied to the VM instances afterward. </span><span class="koboSpan" id="kobo.6.7">This is why VM instances and firewall rules are loosely coupled, which provides flexibility to the user:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.7.1"><img class=" image-border" src="assets/fcdc88af-8f5c-4ec0-9fe9-3cda5752836e.png" style="width:25.50em;height:13.42em;"/></span></div>
<p><span class="koboSpan" id="kobo.8.1">Before launching a VM instance, you need to create an </span><kbd><span class="koboSpan" id="kobo.9.1">ssh</span></kbd><span class="koboSpan" id="kobo.10.1"> public key first in the same way as AWS EC2. </span><span class="koboSpan" id="kobo.10.2">The easiest way to do this is to run the following command to create and register a new key:</span></p>
<pre><strong><span class="koboSpan" id="kobo.11.1">//this command create new ssh key pair</span><br/><span class="koboSpan" id="kobo.12.1">$ gcloud compute config-ssh</span><br/><br/><br/></strong><strong><span class="koboSpan" id="kobo.13.1">//key will be stored as ~/.ssh/google_compute_engine(.pub)</span><br/><span class="koboSpan" id="kobo.14.1">$ cd ~/.ssh</span><br/><span class="koboSpan" id="kobo.15.1">$ ls -l google_compute_engine*</span><br/><span class="koboSpan" id="kobo.16.1">-rw-------  1 saito  admin  1766 Aug 23 22:58 google_compute_engine</span><br/><span class="koboSpan" id="kobo.17.1">-rw-r--r--  1 saito  admin   417 Aug 23 22:58 google_compute_engine.pub</span></strong></pre>
<p><span class="koboSpan" id="kobo.18.1">Now let's get started by launching a VM instance on GCP.</span></p>
<p><span class="koboSpan" id="kobo.19.1">Deploy two instances on both </span><kbd><span class="koboSpan" id="kobo.20.1">subnet-a</span></kbd><span class="koboSpan" id="kobo.21.1"> and </span><kbd><span class="koboSpan" id="kobo.22.1">subnet-b</span></kbd><span class="koboSpan" id="kobo.23.1"> as public instances (use the </span><kbd><span class="koboSpan" id="kobo.24.1">public</span></kbd><span class="koboSpan" id="kobo.25.1"> network tag) and then launch another instance on the </span><kbd><span class="koboSpan" id="kobo.26.1">subnet-a</span></kbd><span class="koboSpan" id="kobo.27.1"> as a private instance (with a </span><kbd><span class="koboSpan" id="kobo.28.1">private</span></kbd><span class="koboSpan" id="kobo.29.1"> network tag):</span></p>
<pre><strong><span class="koboSpan" id="kobo.30.1">//create public instance ("public" tag) on subnet-a</span><br/><span class="koboSpan" id="kobo.31.1">$ gcloud compute instances create public-on-subnet-a --machine-type=f1-micro --network=my-custom-network --subnet=subnet-a --zone=us-west1-a --tags=public</span><br/><br/><span class="koboSpan" id="kobo.32.1">//create public instance ("public" tag) on subnet-b</span><br/><span class="koboSpan" id="kobo.33.1">$ gcloud compute instances create public-on-subnet-b --machine-type=f1-micro --network=my-custom-network --subnet=subnet-b --zone=us-east1-c --tags=public</span><br/><br/><span class="koboSpan" id="kobo.34.1">//create private instance ("private" tag) on subnet-a with larger size (g1-small)</span><br/><span class="koboSpan" id="kobo.35.1">$ gcloud compute instances create private-on-subnet-a --machine-type=g1-small --network=my-custom-network --subnet=subnet-a --zone=us-west1-a --tags=private</span><br/><br/><span class="koboSpan" id="kobo.36.1">//Overall, there are 3 VM instances has been created in this example as below</span><br/><span class="koboSpan" id="kobo.37.1">$ gcloud compute instances list</span><br/><span class="koboSpan" id="kobo.38.1">NAME                                           ZONE           MACHINE_TYPE  PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP      STATUS</span><br/><span class="koboSpan" id="kobo.39.1">public-on-subnet-b                             us-east1-c     f1-micro                   172.16.1.2   35.196.228.40    RUNNING</span><br/><span class="koboSpan" id="kobo.40.1">private-on-subnet-a                            us-west1-a     g1-small                   10.0.1.2     104.199.121.234  RUNNING</span><br/><span class="koboSpan" id="kobo.41.1">public-on-subnet-a                             us-west1-a     f1-micro                   10.0.1.3     35.199.171.31    RUNNING</span></strong></pre>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.42.1"><img class=" image-border" src="assets/0cd9490b-d1af-4132-afbd-ba3d53d07580.png" style="width:33.92em;height:22.42em;"/></span></div>
<p><span class="koboSpan" id="kobo.43.1">You can log in to those machines to check whether a firewall rule works as expected. </span><span class="koboSpan" id="kobo.43.2">First of all, you need to add an </span><kbd><span class="koboSpan" id="kobo.44.1">ssh</span></kbd><span class="koboSpan" id="kobo.45.1"> key to </span><kbd><span class="koboSpan" id="kobo.46.1">ssh-agent</span></kbd><span class="koboSpan" id="kobo.47.1"> on your machine:</span></p>
<pre><strong><span class="koboSpan" id="kobo.48.1">$ ssh-add ~/.ssh/google_compute_engine</span><br/><span class="koboSpan" id="kobo.49.1">Enter passphrase for /Users/saito/.ssh/google_compute_engine:</span><br/><span class="koboSpan" id="kobo.50.1">Identity added: /Users/saito/.ssh/google_compute_engine</span><br/><span class="koboSpan" id="kobo.51.1">(/Users/saito/.ssh/google_compute_engine)</span></strong></pre>
<p><span class="koboSpan" id="kobo.52.1">Then, check whether an ICMP firewall rule can reject traffic from external because ICMP </span><span><span class="koboSpan" id="kobo.53.1">only </span></span><span class="koboSpan" id="kobo.54.1">allows public or private tagged hosts, so the ping packet from your machine won't reach the public instance; this is shown in the following screenshot:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.55.1"><img src="assets/02c0efda-8a8c-4e20-b29d-8729532187ef.png" style="width:49.50em;height:15.58em;"/></span></div>
<p><span class="koboSpan" id="kobo.56.1">On the other hand, the public </span><kbd><span class="koboSpan" id="kobo.57.1">host</span></kbd><span class="koboSpan" id="kobo.58.1"> allows </span><kbd><span class="koboSpan" id="kobo.59.1">ssh</span></kbd><span class="koboSpan" id="kobo.60.1"> from your machine, because the </span><kbd><span class="koboSpan" id="kobo.61.1">public-ssh</span></kbd><span class="koboSpan" id="kobo.62.1"> rule allows any (</span><kbd><span class="koboSpan" id="kobo.63.1">0.0.0.0/0</span></kbd><span class="koboSpan" id="kobo.64.1">):</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.65.1"><img src="assets/36ba01e0-a9da-4aa0-b7df-b178105b1d00.png" style="width:58.58em;height:23.17em;"/></span></div>
<p><span class="koboSpan" id="kobo.66.1">Of course, this host can ping and </span><kbd><span class="koboSpan" id="kobo.67.1">ssh</span></kbd><span class="koboSpan" id="kobo.68.1"> to private hosts on </span><kbd><span class="koboSpan" id="kobo.69.1">subnet-a</span></kbd><span class="koboSpan" id="kobo.70.1"> (</span><kbd><span class="koboSpan" id="kobo.71.1">10.0.1.2</span></kbd><span class="koboSpan" id="kobo.72.1">) through a private IP address, because of the </span><kbd><span class="koboSpan" id="kobo.73.1">internal-icmp</span></kbd><span class="koboSpan" id="kobo.74.1"> and </span><kbd><span class="koboSpan" id="kobo.75.1">private-ssh</span></kbd><span class="koboSpan" id="kobo.76.1"> rules.</span></p>
<p><span class="koboSpan" id="kobo.77.1">Let's </span><kbd><span class="koboSpan" id="kobo.78.1">ssh</span></kbd><span class="koboSpan" id="kobo.79.1"> to a private host and then install </span><kbd><span class="koboSpan" id="kobo.80.1">tomcat8</span></kbd><span class="koboSpan" id="kobo.81.1"> and the </span><kbd><span class="koboSpan" id="kobo.82.1">tomcat8-examples</span></kbd><span class="koboSpan" id="kobo.83.1"> package (this will install the </span><kbd><span class="koboSpan" id="kobo.84.1">/examples/</span></kbd><span class="koboSpan" id="kobo.85.1"> application for Tomcat):</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.86.1"><img src="assets/8cc8f7df-7014-4a20-8ae5-3cb01c96a344.png" style="width:60.75em;height:30.08em;"/></span></div>
<p><span class="koboSpan" id="kobo.87.1">Remember that </span><kbd><span class="koboSpan" id="kobo.88.1">subnet-a</span></kbd><span class="koboSpan" id="kobo.89.1"> is a </span><kbd><span class="koboSpan" id="kobo.90.1">10.0.1.0/24</span></kbd><span class="koboSpan" id="kobo.91.1"> CIDR prefix, but </span><kbd><span class="koboSpan" id="kobo.92.1">subnet-b</span></kbd><span class="koboSpan" id="kobo.93.1"> is a </span><kbd><span class="koboSpan" id="kobo.94.1">172.16.1.0/24</span></kbd><span class="koboSpan" id="kobo.95.1"> CIDR prefix. </span><span class="koboSpan" id="kobo.95.2">However, within the same VPC, there's connectivity with each other. </span><span class="koboSpan" id="kobo.95.3">This is the great benefit of using GCP as you can expand a network address block whenever this is required.</span></p>
<p><span class="koboSpan" id="kobo.96.1">Now install </span><kbd><span class="koboSpan" id="kobo.97.1">nginx</span></kbd><span class="koboSpan" id="kobo.98.1"> to public hosts (</span><kbd><span class="koboSpan" id="kobo.99.1">public-on-subnet-a</span></kbd><span class="koboSpan" id="kobo.100.1"> and </span><kbd><span class="koboSpan" id="kobo.101.1">public-on-subnet-b</span></kbd><span class="koboSpan" id="kobo.102.1">):</span></p>
<pre><strong><span class="koboSpan" id="kobo.103.1">//logout from VM instance, then back to your machine</span><br/><span class="koboSpan" id="kobo.104.1">$ exit</span><br/><br/><span class="koboSpan" id="kobo.105.1">//install nginx from your machine via ssh</span><br/><span class="koboSpan" id="kobo.106.1">$ ssh 35.196.228.40 "sudo apt-get -y install nginx"</span><br/><span class="koboSpan" id="kobo.107.1">$ ssh 35.199.171.31 "sudo apt-get -y install nginx"</span><br/></strong><strong><br/><span class="koboSpan" id="kobo.108.1">//check whether firewall rule (public-http) work or not</span><br/><span class="koboSpan" id="kobo.109.1">$ curl -I http://35.196.228.40/</span><br/><span class="koboSpan" id="kobo.110.1">HTTP/1.1 200 OK</span><br/><span class="koboSpan" id="kobo.111.1">Server: nginx/1.10.3</span><br/><span class="koboSpan" id="kobo.112.1">Date: Sun, 27 Aug 2017 07:07:01 GMT</span><br/><span class="koboSpan" id="kobo.113.1">Content-Type: text/html</span><br/><span class="koboSpan" id="kobo.114.1">Content-Length: 612</span><br/><span class="koboSpan" id="kobo.115.1">Last-Modified: Fri, 25 Aug 2017 05:48:28 GMT</span><br/><span class="koboSpan" id="kobo.116.1">Connection: keep-alive</span><br/><span class="koboSpan" id="kobo.117.1">ETag: "599fba2c-264"</span><br/><span class="koboSpan" id="kobo.118.1">Accept-Ranges: bytes</span></strong></pre>
<p><span class="koboSpan" id="kobo.119.1">However, at this moment, you can't access Tomcat on a private host even if it has a public IP address. </span><span class="koboSpan" id="kobo.119.2">This is because a private host doesn't yet have any firewall rule that allows </span><kbd><span class="koboSpan" id="kobo.120.1">8080/tcp</span></kbd><span class="koboSpan" id="kobo.121.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.122.1">$ curl http://104.199.121.234:8080/examples/</span><br/><span class="koboSpan" id="kobo.123.1">curl: (7) Failed to connect to 104.199.121.234 port 8080: Operation timed out</span></strong></pre>
<p><span><span class="koboSpan" id="kobo.124.1">Rather than </span></span><span class="koboSpan" id="kobo.125.1">simply</span><span><span class="koboSpan" id="kobo.126.1"> </span></span><span><span class="koboSpan" id="kobo.127.1">creating a firewall rule for Tomcat, we'll set up a LoadBalancer to be configured for both nginx and Tomcat in the next section.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Load balancing</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">GCP provides several types of load balancer as follows:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.3.1">Layer 4 TCP LoadBalancer</span></li>
<li><span class="koboSpan" id="kobo.4.1">Layer 4 UDP LoadBalancer</span></li>
<li><span class="koboSpan" id="kobo.5.1">Layer 7 HTTP(S) LoadBalancer</span></li>
</ul>
<p><span class="koboSpan" id="kobo.6.1">The Layer 4 LoadBalancers (</span><span><span class="koboSpan" id="kobo.7.1">both TCP and UDP) </span></span><span class="koboSpan" id="kobo.8.1">are </span><span><span class="koboSpan" id="kobo.9.1">similar to AWS Classic ELB. </span><span class="koboSpan" id="kobo.9.2">On the other hand, the Layer 7 HTTP(S) LoadBalancer has content (context)-based routing. </span><span class="koboSpan" id="kobo.9.3">For example, the URL/image will forward to </span><kbd><span class="koboSpan" id="kobo.10.1">instance-a</span></kbd><span class="koboSpan" id="kobo.11.1">; everything else will forward to </span><kbd><span class="koboSpan" id="kobo.12.1">instance-b</span></kbd><span class="koboSpan" id="kobo.13.1">. </span><span class="koboSpan" id="kobo.13.2">So, it's more like an application-level LoadBalancer.</span></span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.14.1">AWS also provides </span><strong><span class="koboSpan" id="kobo.15.1">Application Load Balancer</span></strong><span class="koboSpan" id="kobo.16.1"> (</span><strong><span class="koboSpan" id="kobo.17.1">ALB</span></strong><span class="koboSpan" id="kobo.18.1"> or </span><strong><span class="koboSpan" id="kobo.19.1">ELBv2</span></strong><span class="koboSpan" id="kobo.20.1">), which is quite similar to the GCP Layer 7 HTTP(S) LoadBalancer. </span><span class="koboSpan" id="kobo.20.2">For details, please visit </span><span class="URLPACKT"><a href="https://aws.amazon.com/blogs/aws/new-aws-application-load-balancer/" target="_blank"><span class="koboSpan" id="kobo.21.1">https://aws.amazon.com/blogs/aws/new-aws-application-load-balancer/</span></a><span class="koboSpan" id="kobo.22.1">.</span></span></div>
<p><span class="koboSpan" id="kobo.23.1">In order to set up LoadBalancer, and unlike AWS ELB, there are several steps you'll need to follow in order to configure some items beforehand:</span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td>
<p><strong><span class="koboSpan" id="kobo.24.1">Configuration item</span></strong></p>
</td>
<td>
<p><strong><span class="koboSpan" id="kobo.25.1">Purpose</span></strong></p>
</td>
</tr>
<tr>
<td>
<p><span class="koboSpan" id="kobo.26.1">Instance group</span></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.27.1">Determine a group of VM instances or a VM template (OS image).</span></p>
</td>
</tr>
<tr>
<td>
<p><span class="koboSpan" id="kobo.28.1">Health check</span></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.29.1">Set health threshold (interval, timeout, and so on) to determine instance group health status.</span></p>
</td>
</tr>
<tr>
<td>
<p><span class="koboSpan" id="kobo.30.1">Backend service</span></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.31.1">Set load threshold (maximum CPU or requests per second) and session affinity (sticky session) to the instance group and associate it to health check.</span></p>
</td>
</tr>
<tr>
<td>
<p><kbd><span class="koboSpan" id="kobo.32.1">url-maps</span></kbd><span class="koboSpan" id="kobo.33.1"> (LoadBalancer)</span></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.34.1">This is an actual place-holder to represent an L7 LoadBalancer that associates backend services and targets the HTTP(S) proxy.</span></p>
</td>
</tr>
<tr>
<td>
<p><span class="koboSpan" id="kobo.35.1">Target HTTP(S) proxy</span></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.36.1">This is a connector that makes relationships between frontend forwarding rules to LoadBalancer.</span></p>
</td>
</tr>
<tr>
<td>
<p><span class="koboSpan" id="kobo.37.1">Frontend forwarding rule</span></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.38.1">Associate between the Target HTTP proxy and IP address (ephemeral or static) and port number.</span></p>
</td>
</tr>
<tr>
<td>
<p><span class="koboSpan" id="kobo.39.1">External IP (static)</span></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.40.1">(Optional) allocate a static external IP address for LoadBalancer.</span></p>
</td>
</tr>
</tbody>
</table>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mce-root"/>
<p class="mceNonEditable"/>
<p><span class="koboSpan" id="kobo.41.1">The following diagram is for all of the preceding components' association that constructs the L7 LoadBalancer:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.42.1"><img class=" image-border" src="assets/68866627-0b45-493e-94c7-85512e92fdb2.png" style="width:42.00em;height:29.75em;"/></span></div>
<p><span class="koboSpan" id="kobo.43.1">Let's set up an instance group first. </span><span class="koboSpan" id="kobo.43.2">In this example, there are three instance groups to create: one for the private hosted Tomcat instance (</span><kbd><span class="koboSpan" id="kobo.44.1">8080/tcp</span></kbd><span class="koboSpan" id="kobo.45.1">) and another two instance groups for public HTTP instances for each zone.</span></p>
<p><span class="koboSpan" id="kobo.46.1">To do that, execute the following commands to group three of them:</span></p>
<pre><strong><span class="koboSpan" id="kobo.47.1">//create instance groups for HTTP instances and tomcat instance</span><br/><span class="koboSpan" id="kobo.48.1">$ gcloud compute instance-groups unmanaged create http-ig-us-west --zone us-west1-a</span><br/><span class="koboSpan" id="kobo.49.1">$ gcloud compute instance-groups unmanaged create http-ig-us-east --zone us-east1-c</span><br/><span class="koboSpan" id="kobo.50.1">$ gcloud compute instance-groups unmanaged create tomcat-ig-us-west --zone us-west1-a</span><br/><br/><span class="koboSpan" id="kobo.51.1">//because tomcat uses 8080/tcp, create a new named port as tomcat:8080</span><br/><span class="koboSpan" id="kobo.52.1">$ gcloud compute instance-groups unmanaged set-named-ports tomcat-ig-us-west --zone us-west1-a --named-ports tomcat:8080</span><br/><br/><span class="koboSpan" id="kobo.53.1">//register an existing VM instance to correspond instance group</span><br/><span class="koboSpan" id="kobo.54.1">$ gcloud compute instance-groups unmanaged add-instances http-ig-us-west --instances public-on-subnet-a --zone us-west1-a</span><br/><span class="koboSpan" id="kobo.55.1">$ gcloud compute instance-groups unmanaged add-instances http-ig-us-east --instances public-on-subnet-b --zone us-east1-c</span><br/><span class="koboSpan" id="kobo.56.1">$ gcloud compute instance-groups unmanaged add-instances tomcat-ig-us-west --instances private-on-subnet-a --zone us-west1-a</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Health check</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Let's set the standard settings by executing the following commands:</span></p>
<pre><strong><span class="koboSpan" id="kobo.3.1">//create health check for http (80/tcp) for "/"</span><br/><span class="koboSpan" id="kobo.4.1">$ gcloud compute health-checks create http my-http-health-check --check-interval 5 --healthy-threshold 2 --unhealthy-threshold 3 --timeout 5 --port 80 --request-path /
</span></strong>
<strong><span class="koboSpan" id="kobo.5.1">//create health check for Tomcat (8080/tcp) for "/examples/"</span><br/><span class="koboSpan" id="kobo.6.1">$ gcloud compute health-checks create http my-tomcat-health-check --check-interval 5 --healthy-threshold 2 --unhealthy-threshold 3 --timeout 5 --port 8080 --request-path /examples/</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Backend service</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">First of all, we need to create a </span><kbd><span class="koboSpan" id="kobo.3.1">backend</span></kbd><span class="koboSpan" id="kobo.4.1"> service that specifies </span><kbd><span class="koboSpan" id="kobo.5.1">health check</span></kbd><span class="koboSpan" id="kobo.6.1">. </span><span class="koboSpan" id="kobo.6.2">Then, we must add each instance group with a threshold: CPU utilization up to 80% and the maximum capacity set to 100% for both HTTP and Tomcat:</span></p>
<pre><strong><span class="koboSpan" id="kobo.7.1">//create backend service for http (default) and named port tomcat (8080/tcp)</span><br/><span class="koboSpan" id="kobo.8.1">$ gcloud compute backend-services create my-http-backend-service --health-checks my-http-health-check --protocol HTTP --global</span><br/><span class="koboSpan" id="kobo.9.1">$ gcloud compute backend-services create my-tomcat-backend-service --health-checks my-tomcat-health-check --protocol HTTP --port-name tomcat --global
</span><br/><br/><span class="koboSpan" id="kobo.10.1">//add http instance groups (both us-west1 and us-east1) to http backend service</span><br/><span class="koboSpan" id="kobo.11.1">$ gcloud compute backend-services add-backend my-http-backend-service --instance-group http-ig-us-west --instance-group-zone us-west1-a --balancing-mode UTILIZATION --max-utilization 0.8 --capacity-scaler 1 --global</span><br/><span class="koboSpan" id="kobo.12.1">$ gcloud compute backend-services add-backend my-http-backend-service --instance-group http-ig-us-east --instance-group-zone us-east1-c --balancing-mode UTILIZATION --max-utilization 0.8 --capacity-scaler 1 --global
</span><br/><br/><span class="koboSpan" id="kobo.13.1">//also add tomcat instance group to tomcat backend service</span><br/><span class="koboSpan" id="kobo.14.1">$ gcloud compute backend-services add-backend my-tomcat-backend-service --instance-group tomcat-ig-us-west --instance-group-zone us-west1-a --balancing-mode UTILIZATION --max-utilization 0.8 --capacity-scaler 1 --global</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Creating a LoadBalancer</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">The LoadBalancer needs to bind both </span><kbd><span class="koboSpan" id="kobo.3.1">my-http-backend-service</span></kbd><span class="koboSpan" id="kobo.4.1"> and </span><kbd><span class="koboSpan" id="kobo.5.1">my-tomcat-backend-service</span></kbd><span class="koboSpan" id="kobo.6.1">. </span><span class="koboSpan" id="kobo.6.2">In this scenario, only </span><kbd><span class="koboSpan" id="kobo.7.1">/examples</span></kbd><span class="koboSpan" id="kobo.8.1"> and </span><kbd><span class="koboSpan" id="kobo.9.1">/examples/*</span></kbd><span class="koboSpan" id="kobo.10.1"> will be traffic forwarded to </span><kbd><span class="koboSpan" id="kobo.11.1">my-tomcat-backend-service</span></kbd><span class="koboSpan" id="kobo.12.1">. </span><span class="koboSpan" id="kobo.12.2">Other than that, every URI forwards traffic to </span><kbd><span class="koboSpan" id="kobo.13.1">my-http-backend-service</span></kbd><span class="koboSpan" id="kobo.14.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.15.1">//create load balancer(url-map) to associate my-http-backend-service as default</span><br/><span class="koboSpan" id="kobo.16.1">$ gcloud compute url-maps create my-loadbalancer --default-service my-http-backend-service
</span><br/><br/><span class="koboSpan" id="kobo.17.1">//add /examples and /examples/* mapping to my-tomcat-backend-service</span><br/><span class="koboSpan" id="kobo.18.1">$ gcloud compute url-maps add-path-matcher my-loadbalancer --default-service my-http-backend-service --path-matcher-name tomcat-map --path-rules /examples=my-tomcat-backend-service,/examples/*=my-tomcat-backend-service
</span><br/><br/></strong><strong><span class="koboSpan" id="kobo.19.1">//create target-http-proxy that associate to load balancer(url-map)
$ gcloud compute target-http-proxies create my-target-http-proxy --url-map=my-loadbalancer
</span><br/><br/><span class="koboSpan" id="kobo.20.1">//allocate static global ip address and check assigned address</span><br/><span class="koboSpan" id="kobo.21.1">$ gcloud compute addresses create my-loadbalancer-ip --global</span><br/><span class="koboSpan" id="kobo.22.1">$ gcloud compute addresses describe my-loadbalancer-ip --global</span><br/><span class="koboSpan" id="kobo.23.1">address: 35.186.192.6</span><br/><br/><span class="koboSpan" id="kobo.24.1">creationTimestamp: '2018-12-08T13:40:16.661-08:00'</span><br/><br/></strong><strong><span class="koboSpan" id="kobo.25.1">...</span><br/><span class="koboSpan" id="kobo.26.1">...</span><br/><span class="koboSpan" id="kobo.27.1">//create forwarding rule that associate static IP to target-http-proxy</span><br/><span class="koboSpan" id="kobo.28.1">$ gcloud compute forwarding-rules create my-frontend-rule --global --target-http-proxy my-target-http-proxy --address 35.186.192.6 --ports 80</span><br/></strong></pre>
<div class="packt_tip"><span class="koboSpan" id="kobo.29.1">If you don't specify an </span><kbd><span class="koboSpan" id="kobo.30.1">--address</span></kbd><span class="koboSpan" id="kobo.31.1"> option, ephemeral external IP address will be created and assigned.</span></div>
<p><span class="koboSpan" id="kobo.32.1">Finally, the LoadBalancer has been created. </span><span class="koboSpan" id="kobo.32.2">However, one missing configuration remains. </span><span class="koboSpan" id="kobo.32.3">Private hosts don't have any firewall rules to allow Tomcat traffic (</span><kbd><span class="koboSpan" id="kobo.33.1">8080/tcp</span></kbd><span class="koboSpan" id="kobo.34.1">). </span><span class="koboSpan" id="kobo.34.2">This is why, when you see the LoadBalancer status, a healthy status of </span><kbd><span class="koboSpan" id="kobo.35.1">my-tomcat-backend-service</span></kbd><span class="koboSpan" id="kobo.36.1"> is kept down (</span><kbd><span class="koboSpan" id="kobo.37.1">0</span></kbd><span class="koboSpan" id="kobo.38.1">):</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.39.1"><img class=" image-border" src="assets/5755c23c-61b4-4733-bbc7-7eae6bc32179.png" style="width:53.08em;height:26.58em;"/></span></div>
<p class="mce-root"/>
<p><span class="koboSpan" id="kobo.40.1">In this case, you need to add one more firewall rule that allows connection from LoadBalancer to a private subnet (use the </span><kbd><span class="koboSpan" id="kobo.41.1">private</span></kbd><span class="koboSpan" id="kobo.42.1"> network tag for this). </span><span class="koboSpan" id="kobo.42.2">According to the GCP documentation (</span><a href="https://cloud.google.com/load-balancing/docs/health-checks#https_ssl_proxy_tcp_proxy_and_internal_load_balancing" target="_blank"><span class="URLPACKT"><span class="koboSpan" id="kobo.43.1">https://cloud.google.com/compute/docs/load-balancing/health-checks#https_ssl_proxy_tcp_proxy_and_internal_load_balancing</span></span></a><span class="koboSpan" id="kobo.44.1">), the health check heart-beat will come from the address range </span><kbd><span class="koboSpan" id="kobo.45.1">35.191.0.0/16</span></kbd><span class="koboSpan" id="kobo.46.1"> to </span><span><kbd><span class="koboSpan" id="kobo.47.1">130.211.0.0/22</span></kbd><span class="koboSpan" id="kobo.48.1">:</span></span></p>
<pre><strong><span class="koboSpan" id="kobo.49.1">//add one more Firewall Rule that allow Load Balancer to Tomcat (8080/tcp)</span><br/></strong>
<strong><span class="koboSpan" id="kobo.50.1">$ gcloud compute firewall-rules create private-tomcat --network=my-custom-network --source-ranges 35.191.0.0/16,130.211.0.0/22 --target-tags private --allow tcp:8080</span></strong></pre>
<p><span class="koboSpan" id="kobo.51.1">After a few minutes, the </span><kbd><span class="koboSpan" id="kobo.52.1">my-tomcat-backend-service</span></kbd><span class="koboSpan" id="kobo.53.1"> healthy status will be up to (</span><kbd><span class="koboSpan" id="kobo.54.1">1</span></kbd><span class="koboSpan" id="kobo.55.1">); now you can access the LoadBalancer from a web browser. </span><span class="koboSpan" id="kobo.55.2">When accessing </span><kbd><span class="koboSpan" id="kobo.56.1">/</span></kbd><span class="koboSpan" id="kobo.57.1">, it should route to </span><kbd><span class="koboSpan" id="kobo.58.1">my-http-backend-service</span></kbd><span class="koboSpan" id="kobo.59.1">, which has the </span><kbd><span class="koboSpan" id="kobo.60.1">nginx</span></kbd><span class="koboSpan" id="kobo.61.1"> application on public hosts:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.62.1"><img src="assets/6a75d782-df8d-431e-b30f-3c83aa1c8ff0.png" style="width:49.92em;height:18.50em;"/></span></div>
<p><span class="koboSpan" id="kobo.63.1">On the other hand, if you access the </span><kbd><span class="koboSpan" id="kobo.64.1">/examples/</span></kbd><span class="koboSpan" id="kobo.65.1"> URL with the same LoadBalancer IP address, it will route to </span><kbd><span class="koboSpan" id="kobo.66.1">my-tomcat-backend-service</span></kbd><span class="koboSpan" id="kobo.67.1">, which is a Tomcat application on a private host, as shown in the following screenshot:</span></p>
<div class="packt_figure CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.68.1"><img src="assets/14f4d40d-f84a-42d2-b478-cd3db4b8ac28.png" style="width:47.00em;height:12.17em;"/></span></div>
<p><span class="koboSpan" id="kobo.69.1">Overall, there are some steps that need to be performed in order to set up a LoadBalancer, but it's useful to integrate different HTTP applications onto a single LoadBalancer to deliver your service efficiently with minimal resources.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Persistent Disk</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">GCE also has a storage service called </span><strong><span class="koboSpan" id="kobo.3.1">Persistent Disk</span></strong><span class="koboSpan" id="kobo.4.1"> (</span><strong><span class="koboSpan" id="kobo.5.1">PD</span></strong><span class="koboSpan" id="kobo.6.1">) that's quite similar to AWS EBS. </span><span class="koboSpan" id="kobo.6.2">You can allocate the desired size and types (either standard or SSD) on each zone and attach/detach VM instances anytime.</span></p>
<p><span class="koboSpan" id="kobo.7.1">Let's create one PD and then attach it to the VM instance. </span><span class="koboSpan" id="kobo.7.2">Note that, when attaching a PD to the VM instance, both must be in the same zones. </span><span class="koboSpan" id="kobo.7.3">This limitation is the same as AWS EBS. </span><span class="koboSpan" id="kobo.7.4">So, before creating PD, check the VM instance location once again:</span></p>
<pre><strong><span class="koboSpan" id="kobo.8.1">$ gcloud compute instances list</span><br/><span class="koboSpan" id="kobo.9.1">NAME                                           ZONE           MACHINE_TYPE  PREEMPTIBLE  INTERNAL_IP  EXTERNAL_IP      STATUS</span><br/><span class="koboSpan" id="kobo.10.1">public-on-subnet-b                             us-east1-c     f1-micro                   172.16.1.2   35.196.228.40    RUNNING</span><br/><span class="koboSpan" id="kobo.11.1">private-on-subnet-a                            us-west1-a     g1-small                   10.0.1.2     104.199.121.234  RUNNING</span><br/><span class="koboSpan" id="kobo.12.1">public-on-subnet-a                             us-west1-a     f1-micro                   10.0.1.3     35.199.171.31    RUNNING</span></strong></pre>
<p><span class="koboSpan" id="kobo.13.1">Let's choose </span><kbd><span class="koboSpan" id="kobo.14.1">us-west1-a</span></kbd><span class="koboSpan" id="kobo.15.1"> and then attach it to </span><kbd><span class="koboSpan" id="kobo.16.1">public-on-subnet-a</span></kbd><span class="koboSpan" id="kobo.17.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.18.1">//create 20GB PD on us-west1-a with standard type</span><br/><span class="koboSpan" id="kobo.19.1">$ gcloud compute disks create my-disk-us-west1-a --zone us-west1-a --type pd-standard --size 20
</span><br/><br/></strong><strong><span class="koboSpan" id="kobo.20.1">//after a few seconds, check status, you can see existing boot disks as well</span><br/><span class="koboSpan" id="kobo.21.1">$ gcloud compute disks list</span><br/><span class="koboSpan" id="kobo.22.1">NAME                                           ZONE           SIZE_GB  TYPE         STATUS</span><br/><span class="koboSpan" id="kobo.23.1">public-on-subnet-b                             us-east1-c     10       pd-standard  READY</span><br/><span class="koboSpan" id="kobo.24.1">my-disk-us-west1-a                             us-west1-a     20       pd-standard  READY</span><br/><span class="koboSpan" id="kobo.25.1">private-on-subnet-a                            us-west1-a     10       pd-standard  READY</span><br/><span class="koboSpan" id="kobo.26.1">public-on-subnet-a                             us-west1-a     10       pd-standard  READY</span><br/><br/><br/></strong><strong><span class="koboSpan" id="kobo.27.1">
//attach PD(my-disk-us-west1-a) to the VM instance(public-on-subnet-a)</span><br/><span class="koboSpan" id="kobo.28.1">$ gcloud compute instances attach-disk public-on-subnet-a --disk my-disk-us-west1-a --zone us-west1-a
</span><br/><br/><br/></strong><strong><span class="koboSpan" id="kobo.29.1">//login to public-on-subnet-a to see the status</span><br/><span class="koboSpan" id="kobo.30.1">$ ssh 35.199.171.31</span><br/><span class="koboSpan" id="kobo.31.1">Linux public-on-subnet-a 4.9.0-3-amd64 #1 SMP Debian 4.9.30-2+deb9u3 (2017-08-06) x86_64</span><br/><br/><span class="koboSpan" id="kobo.32.1">The programs included with the Debian GNU/Linux system are free software;</span><br/><span class="koboSpan" id="kobo.33.1">the exact distribution terms for each program are described in the</span><br/><span class="koboSpan" id="kobo.34.1">individual files in /usr/share/doc/*/copyright.
</span><br/><span class="koboSpan" id="kobo.35.1">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br/><span class="koboSpan" id="kobo.36.1">permitted by applicable law.</span><br/><span class="koboSpan" id="kobo.37.1">Last login: Fri Aug 25 03:53:24 2017 from 107.196.102.199</span><br/><span class="koboSpan" id="kobo.38.1">saito@public-on-subnet-a:~$ sudo su</span><br/><span class="koboSpan" id="kobo.39.1">root@public-on-subnet-a:/home/saito# dmesg | tail</span><br/><span class="koboSpan" id="kobo.40.1">[ 7377.421190] systemd[1]: apt-daily-upgrade.timer: Adding 25min 4.773609s random time.</span><br/><span class="koboSpan" id="kobo.41.1">[ 7379.202172] systemd[1]: apt-daily-upgrade.timer: Adding 6min 37.770637s random time.</span><br/><span class="koboSpan" id="kobo.42.1">[243070.866384] scsi 0:0:2:0: Direct-Access     Google   PersistentDisk   1    PQ: 0 ANSI: 6</span><br/><span class="koboSpan" id="kobo.43.1">[243070.875665] sd 0:0:2:0: [sdb] 41943040 512-byte logical blocks: (21.5 GB/20.0 GiB)</span><br/><span class="koboSpan" id="kobo.44.1">[243070.883461] sd 0:0:2:0: [sdb] 4096-byte physical blocks</span><br/><span class="koboSpan" id="kobo.45.1">[243070.889914] sd 0:0:2:0: Attached scsi generic sg1 type 0</span><br/><span class="koboSpan" id="kobo.46.1">[243070.900603] sd 0:0:2:0: [sdb] Write Protect is off</span><br/><span class="koboSpan" id="kobo.47.1">[243070.905834] sd 0:0:2:0: [sdb] Mode Sense: 1f 00 00 08</span><br/><span class="koboSpan" id="kobo.48.1">[243070.905938] sd 0:0:2:0: [sdb] Write cache: enabled, read cache: enabled, doesn't support DPO or FUA</span><br/><span class="koboSpan" id="kobo.49.1">[243070.925713] sd 0:0:2:0: [sdb] Attached SCSI disk</span></strong></pre>
<p><span class="koboSpan" id="kobo.50.1">You may see that the PD has been attached at </span><kbd><span class="koboSpan" id="kobo.51.1">/dev/sdb</span></kbd><span class="koboSpan" id="kobo.52.1">. </span><span class="koboSpan" id="kobo.52.2">Similar to AWS EBS, you have to format this disk. </span><span class="koboSpan" id="kobo.52.3">Because this is a Linux OS operation, the steps are exactly the same as described in </span><a href="f55d3fa8-e791-4473-83ba-ed8c4f848a90.xhtml"><span class="ChapterrefPACKT"><span class="koboSpan" id="kobo.53.1">Chapter 10</span></span></a><span class="koboSpan" id="kobo.54.1">, </span><em><span class="koboSpan" id="kobo.55.1">Kubernetes on AWS</span></em><span class="koboSpan" id="kobo.56.1">.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Google Kubernetes Engine (GKE)</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Overall, some GCP have introduced in previous sections. </span><span class="koboSpan" id="kobo.2.2">Now you can start to set up Kubernetes on GCP VM instances using those components. </span><span class="koboSpan" id="kobo.2.3">You can even use open-source Kubernetes provisioning tools such as </span><span class="KeyPACKT"><a href="https://github.com/kubernetes/kops"><span class="koboSpan" id="kobo.3.1">kops</span></a><span class="koboSpan" id="kobo.4.1"> and </span><a href="https://github.com/kubernetes-sigs/kubespray"><span class="koboSpan" id="kobo.5.1">kubespray</span></a></span><span class="koboSpan" id="kobo.6.1"> too.</span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.7.1">Google Cloud provides GKE On-Prem (</span><a href="https://cloud.google.com/gke-on-prem/"><span class="koboSpan" id="kobo.8.1">https://cloud.google.com/gke-on-prem/</span></a><span class="koboSpan" id="kobo.9.1">), which allows the user to set up GKE on their own data center resources. </span><span><span class="koboSpan" id="kobo.10.1">As of January 2019, this is an alpha version and not open to everyone yet.</span></span></div>
<p><span class="koboSpan" id="kobo.11.1">However, GCP has a managed Kubernetes service called GKE. </span><span class="koboSpan" id="kobo.11.2">Under the hood, this uses some GCP components such as VPC, VM instances, PD, firewall rules, and LoadBalancers.</span></p>
<p><span class="koboSpan" id="kobo.12.1">Of course, as usual you can use the </span><kbd><span class="KeyPACKT"><span class="koboSpan" id="kobo.13.1">kubectl</span></span></kbd><span class="koboSpan" id="kobo.14.1"> command to control your Kubernetes cluster on GKE, which includes the Cloud SDK. </span><span class="koboSpan" id="kobo.14.2">If you haven't installed the </span><kbd><span class="koboSpan" id="kobo.15.1">kubectl</span></kbd><span class="koboSpan" id="kobo.16.1"> command on your machine yet, type the following command to install it via the Cloud SDK:</span></p>
<pre><strong><span class="koboSpan" id="kobo.17.1">//install kubectl command</span><br/><span class="koboSpan" id="kobo.18.1">$ gcloud components install kubectl</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Setting up your first Kubernetes cluster on GKE</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">You can set up a Kubernetes cluster on GKE using the </span><kbd><span class="koboSpan" id="kobo.3.1">gcloud</span></kbd><span class="koboSpan" id="kobo.4.1"> command. </span><span class="koboSpan" id="kobo.4.2">This needs to specify several parameters to determine some configurations. </span><span class="koboSpan" id="kobo.4.3">One important parameter is the network. </span><span class="koboSpan" id="kobo.4.4">Here, you have to specify which VPC and subnet you'll deploy. </span><span class="koboSpan" id="kobo.4.5">Although GKE supports multiple zones to deploy, you need to specify at least one zone for the Kubernetes master node. </span><span class="koboSpan" id="kobo.4.6">This time, it uses the following parameters to launch a GKE cluster:</span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td>
<p><strong><span class="koboSpan" id="kobo.5.1">Parameter</span></strong></p>
</td>
<td>
<p><strong><span class="koboSpan" id="kobo.6.1">Description</span></strong></p>
</td>
<td>
<p><strong><span class="koboSpan" id="kobo.7.1">Value</span></strong></p>
</td>
</tr>
<tr>
<td>
<p><kbd><span class="koboSpan" id="kobo.8.1">--machine-type</span></kbd></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.9.1">VM instance type for Kubernetes Node</span></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.10.1">f1-micro</span></kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd><span class="koboSpan" id="kobo.11.1">--num-nodes</span></kbd></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.12.1">Initial number of Kubernetes nodes</span></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.13.1">3</span></kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd><span class="koboSpan" id="kobo.14.1">--network</span></kbd></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.15.1">Specify GCP VPC</span></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.16.1">my-custom-network</span></kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd><span class="koboSpan" id="kobo.17.1">--subnetwork</span></kbd></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.18.1">Specify GCP Subnet if VPC is a custom mode</span></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.19.1">subnet-c</span></kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd><span class="koboSpan" id="kobo.20.1">--zone</span></kbd></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.21.1">Specify a single zone</span></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.22.1">asia-northeast1-a</span></kbd></p>
</td>
</tr>
<tr>
<td>
<p><kbd><span class="koboSpan" id="kobo.23.1">--tags</span></kbd></p>
</td>
<td>
<p><span class="koboSpan" id="kobo.24.1">Network tags that will be assigned to Kubernetes nodes</span></p>
</td>
<td>
<p><kbd><span class="koboSpan" id="kobo.25.1">private</span></kbd></p>
</td>
</tr>
</tbody>
</table>
<p><span class="koboSpan" id="kobo.26.1"> </span></p>
<p><span class="koboSpan" id="kobo.27.1">In this scenario, you need to type the following commands to launch a Kubernetes cluster on GCP. </span><span class="koboSpan" id="kobo.27.2">It may take a few minutes to complete because, behind the scenes, it'll launch several VM instances and set up the Kubernetes master and nodes. </span><span class="koboSpan" id="kobo.27.3">Note that the Kubernetes master and etcd will be fully managed by GCP. </span><span class="koboSpan" id="kobo.27.4">This means that the master node and etcd don't consume your VM instances:</span></p>
<pre><strong><span class="koboSpan" id="kobo.28.1">$ gcloud container clusters create my-k8s-cluster --machine-type f1-micro --num-nodes 3 --network my-custom-network --subnetwork subnet-c --zone asia-northeast1-a --tags private</span><br/></strong><strong><br/><span class="koboSpan" id="kobo.29.1">//after a few minutes, check node status</span><br/><span class="s1"><span class="koboSpan" id="kobo.30.1">NAME</span><span class="Apple-converted-space">                                            </span><span class="koboSpan" id="kobo.31.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.32.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.33.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.34.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.35.1">gke-my-k8s-cluster-default-pool-bcae4a66-mlhw </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.36.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.37.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.38.1">2m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.39.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.40.1">gke-my-k8s-cluster-default-pool-bcae4a66-tn74 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.41.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.42.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.43.1">2m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.44.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.45.1">gke-my-k8s-cluster-default-pool-bcae4a66-w5l6 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.46.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.47.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.48.1">2m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.49.1">v1.10.9-gke.5</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.50.1">Note that we specify the </span><kbd><span class="koboSpan" id="kobo.51.1">--tags private</span></kbd><span class="koboSpan" id="kobo.52.1"> option so that a Kubernetes node VM instance has a network tag of </span><kbd><span class="koboSpan" id="kobo.53.1">private</span></kbd><span class="koboSpan" id="kobo.54.1">. </span><span class="koboSpan" id="kobo.54.2">Therefore, it behaves the same as other regular VM instances that have </span><kbd><span class="koboSpan" id="kobo.55.1">private</span></kbd><span class="koboSpan" id="kobo.56.1"> tags. </span><span class="koboSpan" id="kobo.56.2">Consequently, you can't SSH from the public internet and you can't HTTP from the internet either. </span><span class="koboSpan" id="kobo.56.3">However, you can ping and SSH from another VM instance that has a </span><kbd><span class="koboSpan" id="kobo.57.1">public</span></kbd><span class="koboSpan" id="kobo.58.1"> network tag.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Node pool</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">When launching the Kubernetes cluster, you can specify the number of nodes using the </span><kbd><span class="koboSpan" id="kobo.3.1">--num-nodes</span></kbd><span class="koboSpan" id="kobo.4.1"> option. </span><span class="koboSpan" id="kobo.4.2">GKE manages a Kubernetes node as a n</span><span class="KeyPACKT"><span class="koboSpan" id="kobo.5.1">ode pool</span></span><span class="koboSpan" id="kobo.6.1">. </span><span class="koboSpan" id="kobo.6.2">This means you can manage one or more node pools that are attached to your Kubernetes cluster.</span></p>
<p><span class="koboSpan" id="kobo.7.1">What if you need to add or delete nodes? </span><span class="koboSpan" id="kobo.7.2">GKE let's you resize the node pool by performing the following command to change Kubernetes node from 3 to 5:</span></p>
<pre><strong><span class="koboSpan" id="kobo.8.1">//run resize command to change number of nodes to 5</span><br/><span class="koboSpan" id="kobo.9.1">$ gcloud container clusters resize my-k8s-cluster --size 5 --zone asia-northeast1-a</span><br/></strong><br/><strong><span class="koboSpan" id="kobo.10.1">//after a few minutes later, you may see additional nodes
$ kubectl get nodes</span><br/><span class="s1"><span class="koboSpan" id="kobo.11.1">NAME</span><span class="Apple-converted-space">                                            </span><span class="koboSpan" id="kobo.12.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.13.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.14.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.15.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.16.1">gke-my-k8s-cluster-default-pool-bcae4a66-j8zz </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.17.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.18.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.19.1">32s </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.20.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.21.1">gke-my-k8s-cluster-default-pool-bcae4a66-jnnw </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.22.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.23.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.24.1">32s </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.25.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.26.1">gke-my-k8s-cluster-default-pool-bcae4a66-mlhw </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.27.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.28.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.29.1">4m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.30.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.31.1">gke-my-k8s-cluster-default-pool-bcae4a66-tn74 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.32.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.33.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.34.1">4m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.35.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.36.1">gke-my-k8s-cluster-default-pool-bcae4a66-w5l6 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.37.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.38.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.39.1">4m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.40.1">v1.10.9-gke.5</span></span> </strong></pre>
<p><span class="koboSpan" id="kobo.41.1">Increasing the number of nodes will help if you need to scale out your node capacity. </span><span class="koboSpan" id="kobo.41.2">However, in this scenario, it still uses the smallest instance type (</span><kbd><span class="koboSpan" id="kobo.42.1">f1-micro</span></kbd><span class="koboSpan" id="kobo.43.1">, which has only 0.6 GB memory). </span><span class="koboSpan" id="kobo.43.2">It might not help if a single container needs more than 0.6 GB of memory. </span><span class="koboSpan" id="kobo.43.3">In this case you need to scale up, which means you need to add a larger VM instance type.</span></p>
<p><span class="koboSpan" id="kobo.44.1">In this case, you have to add another set of node pools onto your cluster. </span><span class="koboSpan" id="kobo.44.2">This is because, within the same node pool, all VM instances are configured the same. </span><span class="koboSpan" id="kobo.44.3">Consequently, you can't change the instance type in the same node pool.</span></p>
<p><span class="koboSpan" id="kobo.45.1">Add a new node pool that has two new sets of </span><kbd><span class="koboSpan" id="kobo.46.1">g1-small</span></kbd><span class="koboSpan" id="kobo.47.1"> (1.7 GB memory) VM instance types to the cluster. </span><span class="koboSpan" id="kobo.47.2">Then you can expand Kubernetes nodes with a different hardware configuration.</span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.48.1">By default, there are some quotas that can create a number limit for VM instances within one region (for example, up to eight CPU cores on </span><kbd><span class="koboSpan" id="kobo.49.1">us-west1</span></kbd><span class="koboSpan" id="kobo.50.1">). </span><span class="koboSpan" id="kobo.50.2">If you wish to increase this quota, you must change your account to a paid one and then request a quota change to GCP. </span><span class="koboSpan" id="kobo.50.3">For more details, please read the online documentation from </span><a href="https://cloud.google.com/compute/quotas" target="_blank"><span class="URLPACKT"><span class="koboSpan" id="kobo.51.1">https://cloud.google.com/compute/quotas</span></span></a><span class="koboSpan" id="kobo.52.1"> and </span><span class="URLPACKT"><a href="https://cloud.google.com/free/docs/frequently-asked-questions#how-to-upgrade" target="_blank"><span class="koboSpan" id="kobo.53.1">https://cloud.google.com/free/docs/frequently-asked-questions#how-to-upgrade</span></a></span><span class="koboSpan" id="kobo.54.1">.</span></div>
<p><span class="koboSpan" id="kobo.55.1">Run the following command to add an additional node pool that has two instances of a </span><kbd><span class="koboSpan" id="kobo.56.1">g1-small</span></kbd><span class="koboSpan" id="kobo.57.1"> instance:</span></p>
<pre><strong><span class="koboSpan" id="kobo.58.1">//create and add node pool which is named "large-mem-pool"
</span><br/><span class="koboSpan" id="kobo.59.1">$ gcloud container node-pools create large-mem-pool --cluster my-k8s-cluster --machine-type g1-small --num-nodes 2 --tags private --zone asia-northeast1-a
</span><br/></strong><strong><span class="koboSpan" id="kobo.60.1">
//after a few minustes, large-mem-pool instances has been added</span><br/><span class="koboSpan" id="kobo.61.1">$ kubectl get nodes</span><br/><span class="s1"><span class="koboSpan" id="kobo.62.1">NAME</span><span class="Apple-converted-space">                                              </span><span class="koboSpan" id="kobo.63.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.64.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.65.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.66.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.67.1">gke-my-k8s-cluster-default-pool-bcae4a66-j8zz </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.68.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.69.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.70.1">5m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.71.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.72.1">gke-my-k8s-cluster-default-pool-bcae4a66-jnnw </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.73.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.74.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.75.1">5m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.76.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.77.1">gke-my-k8s-cluster-default-pool-bcae4a66-mlhw </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.78.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.79.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.80.1">9m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.81.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.82.1">gke-my-k8s-cluster-default-pool-bcae4a66-tn74 </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.83.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.84.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.85.1">9m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.86.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.87.1">gke-my-k8s-cluster-default-pool-bcae4a66-w5l6 </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.88.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.89.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.90.1">9m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.91.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.92.1">gke-my-k8s-cluster-large-mem-pool-66e3a44a-jtdn </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.93.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.94.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.95.1">46s </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.96.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.97.1">gke-my-k8s-cluster-large-mem-pool-66e3a44a-qpbr </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.98.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.99.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.100.1">44s </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.101.1">v1.10.9-gke.5</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.102.1">Now you have a total of seven CPU cores and 6.4 GB memory in your cluster, which has more capacity. </span><span class="koboSpan" id="kobo.102.2">However, due to larger hardware types, the Kubernetes scheduler will probably assign a pod to </span><kbd><span class="koboSpan" id="kobo.103.1">large-mem-pool</span></kbd><span class="koboSpan" id="kobo.104.1"> first because it has enough memory capacity.</span></p>
<p><span class="koboSpan" id="kobo.105.1">However, you may want to preserve the </span><kbd><span class="koboSpan" id="kobo.106.1">large-mem-pool</span></kbd><span class="koboSpan" id="kobo.107.1"> node in case a big application needs a large memory size (for example, a Java application). </span><span class="koboSpan" id="kobo.107.2">Therefore, you may want to differentiate </span><kbd><span class="koboSpan" id="kobo.108.1">default-pool</span></kbd><span class="koboSpan" id="kobo.109.1"> and </span><kbd><span class="koboSpan" id="kobo.110.1">large-mem-pool</span></kbd><span class="koboSpan" id="kobo.111.1">.</span></p>
<p><span class="koboSpan" id="kobo.112.1">In this case, the Kubernetes label, </span><kbd><span class="KeyPACKT"><span class="koboSpan" id="kobo.113.1">beta.kubernetes.io/instance-type</span></span></kbd><span class="koboSpan" id="kobo.114.1">, helps to distinguish an instance type of node. </span><span class="koboSpan" id="kobo.114.2">Therefore, use </span><kbd><span class="koboSpan" id="kobo.115.1">nodeSelector</span></kbd><span class="koboSpan" id="kobo.116.1"> to specify a desired node for the pod. </span><span class="koboSpan" id="kobo.116.2">For example, the following </span><kbd><span class="koboSpan" id="kobo.117.1">nodeSelector</span></kbd><span class="koboSpan" id="kobo.118.1"> parameter will force the use of the </span><kbd><span class="koboSpan" id="kobo.119.1">f1-micro</span></kbd><span class="koboSpan" id="kobo.120.1"> node for the </span><kbd><span class="koboSpan" id="kobo.121.1">nginx</span></kbd><span class="koboSpan" id="kobo.122.1"> application:</span></p>
<pre><strong><span class="koboSpan" id="kobo.123.1">//nodeSelector specifies f1-micro</span><br/><span class="koboSpan" id="kobo.124.1">$ cat nginx-pod-selector.yml</span><br/><span class="koboSpan" id="kobo.125.1">apiVersion: v1</span><br/><span class="koboSpan" id="kobo.126.1">kind: Pod</span><br/><span class="koboSpan" id="kobo.127.1">metadata:</span><br/><span class="koboSpan" id="kobo.128.1"> name: nginx</span><br/><span class="koboSpan" id="kobo.129.1">spec:</span><br/><span class="koboSpan" id="kobo.130.1"> containers:</span><br/><span class="koboSpan" id="kobo.131.1"> - name: nginx</span><br/><span class="koboSpan" id="kobo.132.1">   image: nginx</span><br/><span class="koboSpan" id="kobo.133.1"> nodeSelector:</span><br/><span class="koboSpan" id="kobo.134.1">  beta.kubernetes.io/instance-type: f1-micro
</span><br/><br/><span class="koboSpan" id="kobo.135.1">//deploy pod</span><br/><span class="koboSpan" id="kobo.136.1">$ kubectl create -f nginx-pod-selector.yml</span><br/><span class="koboSpan" id="kobo.137.1">pod "nginx" created</span><br/><br/></strong>
<strong><span class="koboSpan" id="kobo.138.1">//it uses default pool</span><br/><span class="s1"><span class="koboSpan" id="kobo.139.1">NAME</span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.140.1">READY </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.141.1">STATUS</span><span class="Apple-converted-space">              </span><span class="koboSpan" id="kobo.142.1">RESTARTS </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.143.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.144.1">IP</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.145.1">NODE</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.146.1">nginx </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.147.1">0/1 </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.148.1">ContainerCreating </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.149.1">0</span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.150.1">10s </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.151.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.152.1">gke-my-k8s-cluster-default-pool-bcae4a66-jnnw</span></span></strong></pre>
<div class="packt_tip"><span class="koboSpan" id="kobo.153.1">If you want to specify a particular label instead of </span><kbd><span class="koboSpan" id="kobo.154.1">beta.kubernetes.io/instance-type</span></kbd><span class="koboSpan" id="kobo.155.1">, use the </span><kbd><span class="koboSpan" id="kobo.156.1">--node-labels</span></kbd><span class="koboSpan" id="kobo.157.1"> option to create a node pool. </span><span class="koboSpan" id="kobo.157.2">That assigns your desired label to the node pool. </span><span class="koboSpan" id="kobo.157.3">For more details, please read the following online document: </span><span class="URLPACKT"><a href="https://cloud.google.com/sdk/gcloud/reference/container/node-pools/create" target="_blank"><span class="koboSpan" id="kobo.158.1">https://cloud.google.com/sdk/gcloud/reference/container/node-pools/create</span></a><span class="koboSpan" id="kobo.159.1">.</span></span></div>
<p><span class="koboSpan" id="kobo.160.1">Of course, you can feel free to remove a node pool if you no longer need it. </span><span class="koboSpan" id="kobo.160.2">To do that, run the following command to delete </span><kbd><span class="koboSpan" id="kobo.161.1">default-pool</span></kbd><span class="koboSpan" id="kobo.162.1"> (</span><kbd><span class="koboSpan" id="kobo.163.1">f1-micro</span></kbd><span class="koboSpan" id="kobo.164.1"> x 5 instances). </span><span class="koboSpan" id="kobo.164.2">This operation will involve pod migration (terminate the pod on </span><kbd><span class="koboSpan" id="kobo.165.1">default-pool</span></kbd><span class="koboSpan" id="kobo.166.1"> and relaunch it on </span><kbd><span class="koboSpan" id="kobo.167.1">large-mem-pool</span></kbd><span class="koboSpan" id="kobo.168.1">) automatically if there are some pods running at </span><kbd><span class="koboSpan" id="kobo.169.1">default-pool</span></kbd><span class="koboSpan" id="kobo.170.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.171.1">//list Node Pool</span><br/><span class="koboSpan" id="kobo.172.1">$ gcloud container node-pools list --cluster my-k8s-cluster --zone asia-northeast1-a</span><br/></strong><strong><span class="s1"><span class="koboSpan" id="kobo.173.1">NAME</span><span class="Apple-converted-space">            </span><span class="koboSpan" id="kobo.174.1">MACHINE_TYPE</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.175.1">DISK_SIZE_GB</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.176.1">NODE_VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.177.1">default-pool</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.178.1">f1-micro</span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.179.1">100 </span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.180.1">1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.181.1">large-mem-pool</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.182.1">g1-small</span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.183.1">100 </span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.184.1">1.10.9-gke.5</span><br/></span></strong><strong><br/><br/><span class="koboSpan" id="kobo.185.1">//delete default-pool</span><br/><span class="koboSpan" id="kobo.186.1">$ gcloud container node-pools delete default-pool --cluster my-k8s-cluster --zone asia-northeast1-a
</span><br/></strong><br/><strong><span class="koboSpan" id="kobo.187.1">//after a few minutes, default-pool nodes x 5 has been deleted</span><br/><span class="koboSpan" id="kobo.188.1">$ kubectl get nodes</span><br/><span class="s1"><span class="koboSpan" id="kobo.189.1">NAME</span><span class="Apple-converted-space">                                              </span><span class="koboSpan" id="kobo.190.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.191.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.192.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.193.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.194.1">gke-my-k8s-cluster-large-mem-pool-66e3a44a-jtdn </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.195.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.196.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.197.1">9m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.198.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.199.1">gke-my-k8s-cluster-large-mem-pool-66e3a44a-qpbr </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.200.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.201.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.202.1">9m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.203.1">v1.10.9-gke.5</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.204.1">You may have noticed that all of the preceding operations happened in a single zone (</span><kbd><span class="koboSpan" id="kobo.205.1">asia-northeast1-a</span></kbd><span class="koboSpan" id="kobo.206.1">). </span><span class="koboSpan" id="kobo.206.2">Therefore, if the </span><kbd><span class="koboSpan" id="kobo.207.1">asia-northeast1-a</span></kbd><span class="koboSpan" id="kobo.208.1"> zone gets an outage, your cluster will be down. </span><span class="koboSpan" id="kobo.208.2">In order to avoid zone failure, you may consider setting up a multi-zone cluster.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Multi-zone clusters</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">GKE supports multi-zone clusters, </span><span><span><span class="koboSpan" id="kobo.3.1">which </span></span></span><span class="koboSpan" id="kobo.4.1">allows you to launch Kubernetes nodes on multiple zones, but within the same region. </span><span class="koboSpan" id="kobo.4.2">In previous examples, Kubernetes nodes have been provisioned at </span><kbd><span class="koboSpan" id="kobo.5.1">asia-northeast1-a</span></kbd><span class="koboSpan" id="kobo.6.1"> only, so let's re-provision a cluster that has </span><kbd><span class="koboSpan" id="kobo.7.1">asia-northeast1-a</span></kbd><span class="koboSpan" id="kobo.8.1">, </span><kbd><span class="koboSpan" id="kobo.9.1">asia-northeast1-b</span></kbd><span class="koboSpan" id="kobo.10.1">, and </span><kbd><span class="koboSpan" id="kobo.11.1">asia-northeast1-c</span></kbd><span class="koboSpan" id="kobo.12.1"> in a total of three zones.</span></p>
<p><span class="koboSpan" id="kobo.13.1">It's very simple; you just use the </span><kbd><span class="koboSpan" id="kobo.14.1">--node-locations</span></kbd><span class="koboSpan" id="kobo.15.1"> parameter to specify three zones when creating a new cluster. </span></p>
<p><span class="koboSpan" id="kobo.16.1">Let's delete the previous cluster and create a new one with the </span><kbd><span class="koboSpan" id="kobo.17.1">--node-locations</span></kbd><span class="koboSpan" id="kobo.18.1"> option:</span></p>
<pre><strong><span class="koboSpan" id="kobo.19.1">//delete cluster first
$ gcloud container clusters delete my-k8s-cluster --zone asia-northeast1-a</span><br/><span class="s1"><span class="koboSpan" id="kobo.20.1">The following clusters will be deleted.</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.21.1"> - [my-k8s-cluster] in [asia-northeast1-a]</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.22.1">Do you want to continue (Y/n)?</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.23.1">y</span><br/></span></strong><span class="koboSpan" id="kobo.24.1">...</span><br/><span class="koboSpan" id="kobo.25.1">...</span><br/><strong>   
<br/><span class="koboSpan" id="kobo.26.1">//create a new cluster with --node-locations option with 2 nodes per zones
$ gcloud container clusters create my-k8s-cluster --machine-type f1-micro --num-nodes 2 --network my-custom-network --subnetwork subnet-c --tags private --zone asia-northeast1-a --node-locations asia-northeast1-a,asia-northeast1-b,asia-northeast1-c</span></strong><strong> </strong></pre>
<p><span class="koboSpan" id="kobo.27.1">This example will create two nodes per zone (</span><kbd><span class="koboSpan" id="kobo.28.1">asia-northeast1-a</span></kbd><span class="koboSpan" id="kobo.29.1">, </span><kbd><span class="koboSpan" id="kobo.30.1">b</span></kbd><span class="koboSpan" id="kobo.31.1">, and </span><kbd><span class="koboSpan" id="kobo.32.1">c</span></kbd><span class="koboSpan" id="kobo.33.1">). </span><span class="koboSpan" id="kobo.33.2">Consequently, a total of six nodes will be added:</span></p>
<pre><strong><span class="koboSpan" id="kobo.34.1">$ kubectl get nodes</span><br/><span class="s1"><span class="koboSpan" id="kobo.35.1">NAME</span><span class="Apple-converted-space">                                            </span><span class="koboSpan" id="kobo.36.1">STATUS</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.37.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.38.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.39.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.40.1">gke-my-k8s-cluster-default-pool-58e4e9a4-74hc </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.41.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.42.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.43.1">43s </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.44.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.45.1">gke-my-k8s-cluster-default-pool-58e4e9a4-8jft </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.46.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.47.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.48.1">1m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.49.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.50.1">gke-my-k8s-cluster-default-pool-f7baf2e1-lk7j </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.51.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.52.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.53.1">1m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.54.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.55.1">gke-my-k8s-cluster-default-pool-f7baf2e1-zktg </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.56.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.57.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.58.1">1m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.59.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.60.1">gke-my-k8s-cluster-default-pool-fa5a04a5-bbj5 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.61.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.62.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.63.1">1m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.64.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.65.1">gke-my-k8s-cluster-default-pool-fa5a04a5-d35z </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.66.1">Ready </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.67.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.68.1">1m</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.69.1">v1.10.9-gke.5</span></span></strong></pre>
<div class="packt_tip"><span class="koboSpan" id="kobo.70.1">You may also distinguish node zones with the </span><kbd><span class="koboSpan" id="kobo.71.1">failure-domain.beta.kubernetes.io/zone</span></kbd> <span><span class="koboSpan" id="kobo.72.1">Kubernetes label </span></span><span class="koboSpan" id="kobo.73.1">so that you can specify the desired zones to deploy a pod.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Cluster upgrade</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Once you start to manage Kubernetes, you may encounter difficulties when upgrading Kubernetes clusters. </span><span class="koboSpan" id="kobo.2.2">Due to the fact that the Kubernetes project is very aggressive, there's a new release </span><span><span class="koboSpan" id="kobo.3.1">around every three months</span></span><span><span class="koboSpan" id="kobo.4.1">, such as version 1.11.0 (released on June 27</span></span><sup><span class="koboSpan" id="kobo.5.1">th</span></sup> <span><span class="koboSpan" id="kobo.6.1">2018), </span></span><span class="koboSpan" id="kobo.7.1">1.12.0 (released </span><span><span class="koboSpan" id="kobo.8.1">on September 27</span></span><sup><span class="koboSpan" id="kobo.9.1">th</span></sup> <span><span class="koboSpan" id="kobo.10.1">2018), and 1.13.0 (released on December 3</span><sup><span class="koboSpan" id="kobo.11.1">rd</span></sup><span class="koboSpan" id="kobo.12.1"> 2018).</span></span></p>
<p><span class="koboSpan" id="kobo.13.1">GKE also keeps adding new version support in a timely manner. </span><span class="koboSpan" id="kobo.13.2">This allows us to upgrade both master and nodes via the </span><kbd><span class="koboSpan" id="kobo.14.1">gcloud</span></kbd><span class="koboSpan" id="kobo.15.1"> command. </span><span class="koboSpan" id="kobo.15.2">You can run the following command to see which Kubernetes version is supported by GKE:</span></p>
<pre><strong><span class="koboSpan" id="kobo.16.1">$ gcloud container get-server-config</span><br/><span class="koboSpan" id="kobo.17.1">Fetching server config for us-west1-b</span><br/><br/><span class="koboSpan" id="kobo.18.1">defaultClusterVersion: 1.10.9-gke.5</span><br/><span class="koboSpan" id="kobo.19.1">defaultImageType: COS</span><br/><span class="koboSpan" id="kobo.20.1">validImageTypes:</span><br/><span class="koboSpan" id="kobo.21.1">- COS_CONTAINERD</span><br/><span class="koboSpan" id="kobo.22.1">- COS</span><br/><span class="koboSpan" id="kobo.23.1">- UBUNTU</span><br/><span class="koboSpan" id="kobo.24.1">validMasterVersions:</span><br/><span class="koboSpan" id="kobo.25.1">- 1.11.4-gke.8</span><br/><span class="koboSpan" id="kobo.26.1">- 1.11.3-gke.18</span><br/><span class="koboSpan" id="kobo.27.1">- 1.11.2-gke.20</span><br/><span class="koboSpan" id="kobo.28.1">- 1.11.2-gke.18</span><br/><span class="koboSpan" id="kobo.29.1">- 1.10.9-gke.7</span><br/><span class="koboSpan" id="kobo.30.1">- 1.10.9-gke.5</span><br/><span class="koboSpan" id="kobo.31.1">- 1.10.7-gke.13</span><br/><span class="koboSpan" id="kobo.32.1">- 1.10.7-gke.11</span><br/><span class="koboSpan" id="kobo.33.1">- 1.10.6-gke.13</span><br/><span class="koboSpan" id="kobo.34.1">- 1.10.6-gke.11</span><br/><span class="koboSpan" id="kobo.35.1">- 1.9.7-gke.11</span><br/><span class="koboSpan" id="kobo.36.1">validNodeVersions:</span><br/><span class="koboSpan" id="kobo.37.1">- 1.11.4-gke.8</span><br/><span class="koboSpan" id="kobo.38.1">- 1.11.3-gke.18</span><br/><span class="koboSpan" id="kobo.39.1">- 1.11.2-gke.20</span><br/><span class="koboSpan" id="kobo.40.1">- 1.11.2-gke.18</span><br/><span class="koboSpan" id="kobo.41.1">- 1.11.2-gke.15</span><br/><span class="koboSpan" id="kobo.42.1">- 1.11.2-gke.9</span><br/><span class="koboSpan" id="kobo.43.1">- 1.10.9-gke.7</span><br/><span class="koboSpan" id="kobo.44.1">- 1.10.9-gke.5</span><br/><span class="koboSpan" id="kobo.45.1">- 1.10.9-gke.3</span><br/><span class="koboSpan" id="kobo.46.1">- 1.10.9-gke.0</span><br/><span class="koboSpan" id="kobo.47.1">- 1.10.7-gke.13</span><br/><span class="koboSpan" id="kobo.48.1">- 1.10.7-gke.11</span><br/><span class="koboSpan" id="kobo.49.1">...</span><br/></strong></pre>
<p><span class="koboSpan" id="kobo.50.1">So, you can see that the latest supported Kubernetes version is </span><kbd><span class="koboSpan" id="kobo.51.1">1.11.4-gke.8</span></kbd><span class="koboSpan" id="kobo.52.1"> on both master and node at the time of writing. </span><span class="koboSpan" id="kobo.52.2">Since the previous example installed is version </span><kbd><span class="koboSpan" id="kobo.53.1">1.10.9-gke.5</span></kbd><span class="koboSpan" id="kobo.54.1">, let's update this to </span><kbd><span class="koboSpan" id="kobo.55.1">1.11.4-gke.8</span></kbd><span class="koboSpan" id="kobo.56.1">. </span><span class="koboSpan" id="kobo.56.2">First of all, you need to upgrade </span><kbd><span class="koboSpan" id="kobo.57.1">master</span></kbd><span class="koboSpan" id="kobo.58.1"> first:</span></p>
<pre><strong><span class="koboSpan" id="kobo.59.1">//upgrade master using --master option</span><br/><span class="koboSpan" id="kobo.60.1">$ gcloud container clusters upgrade my-k8s-cluster --zone asia-northeast1-a --cluster-version 1.11.4-gke.8 --master</span><br/><br/><span class="koboSpan" id="kobo.61.1">Master of cluster [my-k8s-cluster] will be upgraded from version </span><br/><span class="koboSpan" id="kobo.62.1">[1.10.9-gke.5] to version [1.11.4-gke.8]. </span><span class="koboSpan" id="kobo.62.2">This operation is </span><br/><span class="koboSpan" id="kobo.63.1">long-running and will block other operations on the cluster (including</span><br/><span class="koboSpan" id="kobo.64.1"> delete) until it has run to completion.</span><br/><br/><span class="koboSpan" id="kobo.65.1">Do you want to continue (Y/n)? </span><span class="koboSpan" id="kobo.65.2">y</span><br/><br/><span class="koboSpan" id="kobo.66.1">Upgrading my-k8s-cluster...done.</span><br/><span class="koboSpan" id="kobo.67.1">Updated [https://container.googleapis.com/v1/projects/devops-with-kubernetes/zones/asia-northeast1-a/clusters/my-k8s-cluster].</span></strong></pre>
<p><span class="koboSpan" id="kobo.68.1">This takes around 10 minutes depending on the environment. </span><span class="koboSpan" id="kobo.68.2">After that, you can verify </span><kbd><span class="koboSpan" id="kobo.69.1">MASTER_VERSION</span></kbd><span class="koboSpan" id="kobo.70.1"> via the following command:</span></p>
<pre><strong><span class="koboSpan" id="kobo.71.1">//master upgrade has been successfully to done</span><br/><span class="koboSpan" id="kobo.72.1">$ gcloud container clusters list --zone asia-northeast1-a</span><br/><span class="s1"><span class="koboSpan" id="kobo.73.1">NAME</span><span class="Apple-converted-space">            </span><span class="koboSpan" id="kobo.74.1">LOCATION </span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.75.1">MASTER_VERSION</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.76.1">MASTER_IP</span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.77.1">MACHINE_TYPE</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.78.1">NODE_VERSION</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.79.1">NUM_NODES</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.80.1">STATUS</span><br/><br/></span><span class="s1"><span class="koboSpan" id="kobo.81.1">my-k8s-cluster</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.82.1">asia-northeast1-a</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.83.1">1.11.4-gke.8</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.84.1">35.243.78.166</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.85.1">f1-micro</span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.86.1">1.10.9-gke.5 *</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.87.1">6</span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.88.1">RUNNING</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.89.1">Now you can start to upgrade all nodes to version </span><kbd><span class="koboSpan" id="kobo.90.1">1.11.4-gke.8</span></kbd><span class="koboSpan" id="kobo.91.1">. </span><span class="koboSpan" id="kobo.91.2">Because GKE tries to perform a rolling upgrade, it'll perform the following steps on each node, one by one:</span></p>
<ol>
<li><span class="koboSpan" id="kobo.92.1">De-register a target node from the cluster</span></li>
<li><span class="koboSpan" id="kobo.93.1">Delete old VM instances</span></li>
<li><span class="koboSpan" id="kobo.94.1">Provision a new VM instance</span></li>
</ol>
<ol start="4">
<li><span class="koboSpan" id="kobo.95.1">Set up the node with the </span><kbd><span class="koboSpan" id="kobo.96.1">1.11.4-gke.8</span></kbd><span class="koboSpan" id="kobo.97.1"> version</span></li>
<li><span class="koboSpan" id="kobo.98.1">Register to </span><kbd><span class="koboSpan" id="kobo.99.1">master</span></kbd></li>
</ol>
<p><span class="koboSpan" id="kobo.100.1">Therefore, a node upgrade takes much longer than a master upgrade:</span></p>
<pre><strong><span class="koboSpan" id="kobo.101.1">//node upgrade (not specify --master)</span><br/><span class="s1"><span class="koboSpan" id="kobo.102.1">$ gcloud container clusters upgrade my-k8s-cluster --zone asia-northeast1-a --cluster-version 1.11.4-gke.8</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.103.1">All nodes (6 nodes) of cluster [my-k8s-cluster] will be upgraded from </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.104.1">version [1.10.9-gke.5] to version [1.11.4-gke.8]. </span><span class="koboSpan" id="kobo.104.2">This operation is </span><br/></span><span class="s1"><span class="koboSpan" id="kobo.105.1">long-running and will block other operations on the cluster (including</span></span><span class="s1"><span class="koboSpan" id="kobo.106.1"> delete) until it has run to completion.</span><br/><br/></span><span class="s1"><span class="koboSpan" id="kobo.107.1">Do you want to continue (Y/n)?</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.108.1">y</span></span></strong></pre>
<p><span><span class="koboSpan" id="kobo.109.1">During</span></span><span class="koboSpan" id="kobo.110.1"> the rolling </span><span><span class="koboSpan" id="kobo.111.1">upgrade, you can see the node status as follows; this</span></span><span class="koboSpan" id="kobo.112.1"> </span><span><span class="koboSpan" id="kobo.113.1">example shows the </span></span><span class="koboSpan" id="kobo.114.1">halfway point of a </span><span><span class="koboSpan" id="kobo.115.1">rolling update. </span><span class="koboSpan" id="kobo.115.2">Here, </span></span><span><span class="koboSpan" id="kobo.116.1">two nodes have upgraded to </span><kbd><span class="koboSpan" id="kobo.117.1">1.11.4-gke.8</span></kbd><span class="koboSpan" id="kobo.118.1">, one node is about to upgrade, and the remaining three nodes are pending:</span></span></p>
<pre class="p1"><strong><span class="s1"><span class="koboSpan" id="kobo.119.1">$ kubectl get nodes</span><br/><span class="koboSpan" id="kobo.120.1">NAME</span><span class="Apple-converted-space">                                            </span><span class="koboSpan" id="kobo.121.1">STATUS </span><span class="Apple-converted-space">                    </span><span class="koboSpan" id="kobo.122.1">ROLES </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.123.1">AGE </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.124.1">VERSION</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.125.1">gke-my-k8s-cluster-default-pool-58e4e9a4-74hc </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.126.1">Ready</span><span class="Apple-converted-space">                      </span><span class="koboSpan" id="kobo.127.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.128.1">18m </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.129.1">v1.11.4-gke.8</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.130.1">gke-my-k8s-cluster-default-pool-58e4e9a4-8jft </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.131.1">Ready</span><span class="Apple-converted-space">                      </span><span class="koboSpan" id="kobo.132.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.133.1">19m </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.134.1">v1.11.4-gke.8</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.135.1">gke-my-k8s-cluster-default-pool-f7baf2e1-lk7j </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.136.1">Ready</span><span class="Apple-converted-space">                      </span><span class="koboSpan" id="kobo.137.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.138.1">19m </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.139.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.140.1">gke-my-k8s-cluster-default-pool-f7baf2e1-zktg </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.141.1">Ready</span><span class="Apple-converted-space">                      </span><span class="koboSpan" id="kobo.142.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.143.1">19m </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.144.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.145.1">gke-my-k8s-cluster-default-pool-fa5a04a5-bbj5 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.146.1">Ready,SchedulingDisabled </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.147.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.148.1">19m </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.149.1">v1.10.9-gke.5</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.150.1">gke-my-k8s-cluster-default-pool-fa5a04a5-d35z </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.151.1">Ready</span><span class="Apple-converted-space">                      </span><span class="koboSpan" id="kobo.152.1">&lt;none&gt;</span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.153.1">19m </span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.154.1">v1.10.9-gke.5</span></span> </strong> </pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Kubernetes cloud provider</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">GKE also integrates </span><span><span class="koboSpan" id="kobo.3.1">out-of-</span></span><span><span class="koboSpan" id="kobo.4.1">the-</span></span><span class="koboSpan" id="kobo.5.1">box </span><span><span class="koboSpan" id="kobo.6.1">Kubernetes</span></span><span class="koboSpan" id="kobo.7.1"> cloud </span><span><span class="koboSpan" id="kobo.8.1">providers, which</span></span><span><span class="koboSpan" id="kobo.9.1"> deeply integrate with the GCP infrastructure, for example, the overlay network by VPC route,</span></span> <kbd><span class="koboSpan" id="kobo.10.1">StorageClass</span></kbd> <span><span class="koboSpan" id="kobo.11.1">by Persistent Disk, and Service by L4 LoadBalancer. </span><span class="koboSpan" id="kobo.11.2">One of the best integrations is provided by the ingress controller by L7 LoadBalancer. </span><span class="koboSpan" id="kobo.11.3">Let's take a look at how this works.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">StorageClass</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Similarly to EKS on AWS, GKE also sets up </span><kbd><span class="koboSpan" id="kobo.3.1">StorageClass</span></kbd><span class="koboSpan" id="kobo.4.1"> by default; this uses Persistent Disk:</span></p>
<pre><strong><span class="koboSpan" id="kobo.5.1">$ kubectl get storageclass</span><br/><span class="koboSpan" id="kobo.6.1">NAME                 TYPE</span><br/><span class="koboSpan" id="kobo.7.1">standard (default)   kubernetes.io/gce-pd</span><br/></strong><strong><br/><span class="koboSpan" id="kobo.8.1">$ kubectl describe storageclass standard</span><br/><br/><span class="s1"><span class="koboSpan" id="kobo.9.1">Name:</span><span class="Apple-converted-space">                  </span><span class="koboSpan" id="kobo.10.1">standard</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.11.1">IsDefaultClass:</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.12.1">Yes</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.13.1">Annotations: </span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.14.1">storageclass.beta.kubernetes.io/is-default-class=true</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.15.1">Provisioner: </span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.16.1">kubernetes.io/gce-pd</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.17.1">Parameters:</span><span class="Apple-converted-space">            </span><span class="koboSpan" id="kobo.18.1">type=pd-standard</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.19.1">AllowVolumeExpansion:</span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.20.1">&lt;unset&gt;</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.21.1">MountOptions:</span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.22.1">&lt;none&gt;</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.23.1">ReclaimPolicy: </span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.24.1">Delete</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.25.1">VolumeBindingMode: </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.26.1">Immediate</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.27.1">Events:</span><span class="Apple-converted-space">                </span><span class="koboSpan" id="kobo.28.1">&lt;none&gt;</span></span></strong></pre>
<p><span class="koboSpan" id="kobo.29.1">Consequently, when creating a persistent volume claim, this </span><span><span class="koboSpan" id="kobo.30.1">will </span></span><span><span class="koboSpan" id="kobo.31.1">automatically </span></span><span><span class="koboSpan" id="kobo.32.1">allocate the GCP Persistent Disk as the Kubernetes Persistent Volume. </span><span class="koboSpan" id="kobo.32.2">For more information on persistent volume claim and Dynamic Provisioning,</span></span><span class="koboSpan" id="kobo.33.1"> please refer </span><span><span class="koboSpan" id="kobo.34.1">to</span></span> <a href="c3083748-0f68-488f-87e0-f8c61deeeb80.xhtml"><span class="ChapterrefPACKT"><span class="koboSpan" id="kobo.35.1">Chapter 4</span></span></a><span><span class="koboSpan" id="kobo.36.1">,</span></span> <em><span class="koboSpan" id="kobo.37.1">Managing Stateful Workloads</span></em><span class="koboSpan" id="kobo.38.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.39.1">$ cat pvc-gke.yml</span><br/><span class="s1"><span class="koboSpan" id="kobo.40.1">apiVersion: v1</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.41.1">kind: PersistentVolumeClaim</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.42.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.43.1">name: pvc-gke-1</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.44.1">spec:</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.45.1">storageClassName: "standard"</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.46.1">accessModes:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.47.1">- ReadWriteOnce</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.48.1">resources:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.49.1">requests:</span><br/></span><span class="s1"><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.50.1">storage: 10Gi</span></span></strong><br/><strong><br/><span class="koboSpan" id="kobo.51.1">   
//create Persistent Volume Claim
$ kubectl create -f pvc-gke.yml 
persistentvolumeclaim "pvc-gke-1" created
 </span></strong><br/>   
<strong><span class="koboSpan" id="kobo.52.1">//check Persistent Volume
$ kubectl get pv
NAME                                       CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS    CLAIM               STORAGECLASS   REASON    AGE
pvc-bc04e717-8c82-11e7-968d-42010a920fc3   10Gi       RWO           Delete          Bound     default/pvc-gke-1   standard                 2s
</span></strong><br/>    
<strong><span class="koboSpan" id="kobo.53.1">//check via gcloud command
$ gcloud compute disks list 
NAME                                                             ZONE               SIZE_GB  TYPE         STATUS
gke-my-k8s-cluster-d2e-pvc-bc04e717-8c82-11e7-968d-42010a920fc3  asia-northeast1-a  10       pd-standard  READY  </span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">L4 LoadBalancer</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Similarly to AWS cloud provider, GKE also supports using the L4 LoadBalancer for Kubernetes Services. </span><span class="koboSpan" id="kobo.2.2">Just specify </span><kbd><span class="koboSpan" id="kobo.3.1">Service.spec.type</span></kbd><span class="koboSpan" id="kobo.4.1"> as the LoadBalancer, and then GKE will set up and configure the L4 LoadBalancer automatically.</span></p>
<p><span class="koboSpan" id="kobo.5.1">Note that the corresponding firewall rule between the L4 LoadBalancer and the Kubernetes node can be created by the cloud provider automatically. </span><span class="koboSpan" id="kobo.5.2">This is simple but powerful enough if you want to </span><span><span class="koboSpan" id="kobo.6.1">quickly </span></span><span><span class="koboSpan" id="kobo.7.1">expose your application to the internet:</span></span></p>
<pre><strong><span class="koboSpan" id="kobo.8.1">$ cat grafana.yml</span><br/><span class="s1"><span class="koboSpan" id="kobo.9.1">apiVersion: apps/v1</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.10.1">kind: Deployment</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.11.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.12.1">name: grafana</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.13.1">spec:</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.14.1">replicas: 1</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.15.1">selector:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.16.1">matchLabels:</span><br/></span><span class="s1"><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.17.1">project: devops-with-kubernetes</span><br/></span><span class="s1"><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.18.1">app: grafana</span><br/></span><span class="s1"><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.19.1">template:</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.20.1">metadata:</span><br/></span><span class="s1"><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.21.1">labels:</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.22.1">project: devops-with-kubernetes</span><br/></span><span class="s1"><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.23.1">app: grafana</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.24.1">spec:</span><br/></span><span class="s1"><span class="Apple-converted-space">     </span><span class="koboSpan" id="kobo.25.1">containers:</span><br/></span><span class="s1"><span class="Apple-converted-space">       </span><span class="koboSpan" id="kobo.26.1">- image: grafana/grafana</span><br/></span><span class="s1"><span class="Apple-converted-space">         </span><span class="koboSpan" id="kobo.27.1">name: grafana</span><br/></span><span class="s1"><span class="Apple-converted-space">         </span><span class="koboSpan" id="kobo.28.1">ports:</span><br/></span><span class="s1"><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.29.1">- containerPort: 3000</span></span><span class="koboSpan" id="kobo.30.1">
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
spec:
  ports:
    - port: 80
      targetPort: 3000
  type: LoadBalancer
  selector:</span><br/><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.31.1">project: devops-with-kubernetes</span><br/></span><span class="s1"><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.32.1">app: grafana</span></span> </strong><br/><strong><br/></strong>   
<strong><span class="koboSpan" id="kobo.33.1">//deploy grafana with Load Balancer service
$ kubectl create -f grafana.yml 
deployment.apps "grafana" created</span></strong><br/><strong><span class="koboSpan" id="kobo.34.1">service "grafana" created</span></strong><br/><br/>    
<strong><span class="koboSpan" id="kobo.35.1">//check L4 Load balancer IP address
$ kubectl get svc grafana</span><br/></strong><strong><span class="s1"><span class="koboSpan" id="kobo.36.1">NAME</span><span class="Apple-converted-space">      </span><span class="koboSpan" id="kobo.37.1">TYPE </span><span class="Apple-converted-space">          </span><span class="koboSpan" id="kobo.38.1">CLUSTER-IP </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.39.1">EXTERNAL-IP </span><span class="Apple-converted-space">    </span><span class="koboSpan" id="kobo.40.1">PORT(S)</span><span class="Apple-converted-space">        </span><span class="koboSpan" id="kobo.41.1">AGE</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.42.1">grafana </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.43.1">LoadBalancer </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.44.1">10.59.244.97 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.45.1">35.243.118.88 </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.46.1">80:31213/TCP </span><span class="Apple-converted-space">  </span><span class="koboSpan" id="kobo.47.1">1m</span></span></strong><strong><br/><br/><span class="koboSpan" id="kobo.48.1">   
//can reach via GCP L4 Load Balancer</span><br/></strong><strong><span class="s1"><span class="koboSpan" id="kobo.49.1">$ curl -I 35.243.118.88</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.50.1">HTTP/1.1 302 Found</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.51.1">Content-Type: text/html; charset=utf-8</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.52.1">Location: /login</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.53.1">Set-Cookie: grafana_sess=186d81bd66d150d5; Path=/; HttpOnly</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.54.1">Set-Cookie: redirect_to=%252F; Path=/; HttpOnly</span><br/></span><span class="s1"><span class="koboSpan" id="kobo.55.1">Date: Sun, 09 Dec 2018 02:25:48 GMT</span></span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">L7 LoadBalancer (ingress)</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">GKE also supports Kubernetes ingress, which can set up the GCP L7 LoadBalancer to dispatch HTTP requests to the target service based on the URL. </span><span class="koboSpan" id="kobo.2.2">You just need to set up one or more NodePort services and then create ingress rules to point to the services. </span><span class="koboSpan" id="kobo.2.3">Behind the scenes, Kubernetes automatically creates and configures the following firewall rules; </span><kbd><span class="koboSpan" id="kobo.3.1">health check</span></kbd><span class="koboSpan" id="kobo.4.1">, </span><kbd><span class="koboSpan" id="kobo.5.1">backend</span></kbd><span class="koboSpan" id="kobo.6.1"> service, </span><kbd><span class="koboSpan" id="kobo.7.1">forwarding rule</span></kbd><span class="koboSpan" id="kobo.8.1">, and </span><kbd><span class="koboSpan" id="kobo.9.1">url-maps</span></kbd><span class="koboSpan" id="kobo.10.1">.</span></p>
<p><span class="koboSpan" id="kobo.11.1">Let's create same examples that use nginx and Tomcat to deploy to the Kubernetes cluster first. </span><span class="koboSpan" id="kobo.11.2">These use Kubernetes Services that bind to NodePort instead of LoadBalancer:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.12.1"><img src="assets/55796cc8-048e-4061-8a10-17f60728d29b.png" style="width:45.92em;height:27.50em;"/></span></div>
<p><span class="koboSpan" id="kobo.13.1">At present, you can't access Kubernetes Service because there are as yet no firewall rules that allow access to it from the internet. </span><span class="koboSpan" id="kobo.13.2">Consequently, let's create Kubernetes ingress to point to these services.</span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.14.1">You can use </span><kbd><span class="koboSpan" id="kobo.15.1">kubectl port-forward &lt;pod name&gt; &lt;your machine available port&gt;&lt;: service port number&gt;</span></kbd><span class="koboSpan" id="kobo.16.1"> to access the pod via the Kubernetes API server. </span><span class="koboSpan" id="kobo.16.2">For the preceding case, use </span><kbd><span class="koboSpan" id="kobo.17.1">kubectl port-forward tomcat-670632475-l6h8q 10080:8080</span></kbd><span class="koboSpan" id="kobo.18.1">. </span><span class="koboSpan" id="kobo.18.2">After that, open your web browser to </span><kbd><span class="koboSpan" id="kobo.19.1">http://localhost:10080/</span></kbd><span class="koboSpan" id="kobo.20.1"> and then you can directly </span><span><span class="koboSpan" id="kobo.21.1">access the Tomcat pod.</span></span></div>
<p><span class="koboSpan" id="kobo.22.1">Kubernetes ingress definition is quite similar to GCP backend service definition as it needs to specify a combination of URL path, Kubernetes service name, and service port number. </span><span class="koboSpan" id="kobo.22.2">In this scenario, the </span><kbd><span class="koboSpan" id="kobo.23.1">/</span></kbd><span class="koboSpan" id="kobo.24.1"> and </span><kbd><span class="koboSpan" id="kobo.25.1">/*</span></kbd> <span><span class="koboSpan" id="kobo.26.1">URLs </span></span><span class="koboSpan" id="kobo.27.1">point to the </span><kbd><span class="koboSpan" id="kobo.28.1">nginx</span></kbd><span class="koboSpan" id="kobo.29.1"> service, while the </span><kbd><span class="koboSpan" id="kobo.30.1">/examples</span></kbd><span class="koboSpan" id="kobo.31.1"> and </span><kbd><span class="koboSpan" id="kobo.32.1">/examples/*</span></kbd><span class="koboSpan" id="kobo.33.1"> </span><span><span class="koboSpan" id="kobo.34.1">URLs </span></span><span class="koboSpan" id="kobo.35.1">also point to the Tomcat service, as follows:</span></p>
<pre><strong><span class="koboSpan" id="kobo.36.1">$ cat nginx-tomcat-ingress.yaml 
apiVersion: extensions/v1beta1
kind: Ingress
metadata:</span><br/><span class="koboSpan" id="kobo.37.1">  name: nginx-tomcat-ingress</span><br/><span class="koboSpan" id="kobo.38.1">spec:
  rules:
  - http:
      paths:
      - path: /
        backend:
          serviceName: nginx
          servicePort: 80
      - path: /examples
        backend:
          serviceName: tomcat
          servicePort: 8080
      - path: /examples/*
        backend:
          serviceName: tomcat
          servicePort: 8080
  </span></strong><br/> <br/><strong><span class="koboSpan" id="kobo.39.1"> 
$ kubectl create -f nginx-tomcat-ingress.yaml 
ingress "nginx-tomcat-ingress" created  </span></strong></pre>
<p><span class="koboSpan" id="kobo.40.1">It takes around 10 to 15 minutes to fully configure GCP components such as </span><kbd><span class="koboSpan" id="kobo.41.1">health check</span></kbd><span class="koboSpan" id="kobo.42.1">, </span><kbd><span class="koboSpan" id="kobo.43.1">forwarding rule</span></kbd><span class="koboSpan" id="kobo.44.1">, </span><kbd><span class="koboSpan" id="kobo.45.1">backend</span></kbd><span class="koboSpan" id="kobo.46.1"> services, and </span><kbd><span class="koboSpan" id="kobo.47.1">url-maps</span></kbd><span class="koboSpan" id="kobo.48.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.49.1">$ kubectl get ing
NAME                   HOSTS     ADDRESS           PORTS     AGE
nginx-tomcat-ingress   *         107.178.253.174   80        1m  </span></strong></pre>
<p><span class="koboSpan" id="kobo.50.1">You can also check the status on the web console, as follows:</span></p>
<div class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.51.1"><img src="assets/5486e313-b1e0-4b4c-aa00-deca29c6cddc.png" style="width:68.42em;height:45.67em;"/></span></div>
<p><span class="koboSpan" id="kobo.52.1">Once you've completed setting up of the L7 LoadBalancer, you can access the public IP LoadBalancer address (</span><kbd><span class="koboSpan" id="kobo.53.1">http://107.178.253.174/</span></kbd><span class="koboSpan" id="kobo.54.1">) to see the nginx page. </span><span class="koboSpan" id="kobo.54.2">As well as accessing </span><kbd><span><span class="koboSpan" id="kobo.55.1">http://107.178.253.174/examples/</span></span></kbd><span class="koboSpan" id="kobo.56.1">, you can see the </span><kbd><span class="koboSpan" id="kobo.57.1">tomcat example</span></kbd><span class="koboSpan" id="kobo.58.1"> page.</span></p>
<div class="packt_infobox"><span><span class="koboSpan" id="kobo.59.1">GKE returns </span><span class="packt_screen"><span class="koboSpan" id="kobo.60.1">404 Not found</span></span><span class="koboSpan" id="kobo.61.1"> until GKE is fully complete in order to configure the LoadBalancer.</span></span></div>
<p><span class="koboSpan" id="kobo.62.1">In the preceding steps, we created and assigned an ephemeral IP address for the L7 LoadBalancer. </span><span class="koboSpan" id="kobo.62.2">However, the best practice when using L7 LoadBalancer is to assign a static IP address instead, because you can also associate DNS (FQDN) to the static IP address.</span></p>
<p><span class="koboSpan" id="kobo.63.1">To do that, update the ingress setting to add an annotation named </span><kbd><span class="KeyPACKT"><span class="koboSpan" id="kobo.64.1">kubernetes.io/ingress.global-static-ip-name</span></span></kbd><span class="koboSpan" id="kobo.65.1"> to associate a GCP static IP address name, as follows:</span></p>
<pre><strong><span class="koboSpan" id="kobo.66.1">//allocate static IP as my-nginx-tomcat
$ gcloud compute addresses create my-nginx-tomcat --global
 </span></strong><br/><strong><span class="koboSpan" id="kobo.67.1">   
//check assigned IP address
$ gcloud compute addresses list 
NAME             REGION  ADDRESS         STATUS
my-nginx-tomcat          35.186.227.252  IN_USE
 </span></strong><br/><strong><span class="koboSpan" id="kobo.68.1">   
//add annotations definition
$ cat nginx-tomcat-static-ip-ingress.yaml 
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: nginx-tomcat-ingress
  annotations:
    kubernetes.io/ingress.global-static-ip-name: my-nginx- </span></strong><br/><strong><span class="koboSpan" id="kobo.69.1">tomcat
spec:
  rules:
  - http:
      paths:
      - path: /
        backend:
          serviceName: nginx
          servicePort: 80
      - path: /examples
        backend:
          serviceName: tomcat
          servicePort: 8080
      - path: /examples/*
        backend:
          serviceName: tomcat
          servicePort: 8080
 </span></strong><br/><strong><span class="koboSpan" id="kobo.70.1">   
//apply command to update Ingress
$ kubectl apply -f nginx-tomcat-static-ip-ingress.yaml 
</span></strong><br/><strong><span class="koboSpan" id="kobo.71.1">    
//check Ingress address that associate to static IP
$ kubectl get ing
NAME                   HOSTS     ADDRESS          PORTS     AGE
nginx-tomcat-ingress   *         35.186.227.252   80        48m  </span></strong></pre>
<p><span class="koboSpan" id="kobo.72.1">So, now you can access the ingress via a static IP address such as </span><kbd><span class="koboSpan" id="kobo.73.1">http://35.186.227.252/</span></kbd><span class="koboSpan" id="kobo.74.1"> (</span><kbd><span class="koboSpan" id="kobo.75.1">nginx</span></kbd><span class="koboSpan" id="kobo.76.1">) and </span><kbd><span class="koboSpan" id="kobo.77.1">http://35.186.227.252/examples/</span></kbd><span class="koboSpan" id="kobo.78.1"> (Tomcat) instead of an ephemeral IP address. </span><span class="koboSpan" id="kobo.78.2">This benefits to the user and preserves the static IP address. </span><span class="koboSpan" id="kobo.78.3">For example, when you recreate an ingress, the IP address won't be changed. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Summary</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">In this chapter, we discussed Google Cloud Platform. </span><span class="koboSpan" id="kobo.2.2">Its basic concept is similar to AWS, but some policies and concepts are different. </span><span class="koboSpan" id="kobo.2.3">This is particularly the case for Google Container Engine, as this is a very powerful service for using Kubernetes as production grade. </span><span class="koboSpan" id="kobo.2.4">Kubernetes cluster and node management is quite easy to install and upgrade. </span><span class="koboSpan" id="kobo.2.5">The cloud provider is also fully integrated with GCP (especially ingress, as this can configure the L7 LoadBalancer with one command). </span><span class="koboSpan" id="kobo.2.6">Consequently, it's highly recommended you try GKE if you plan to use Kubernetes on the public cloud.</span></p>
<p><a href="89891610-4ca4-4216-9d76-2613d186421c.xhtml"><span class="koboSpan" id="kobo.3.1">Chapter 12</span></a><span class="koboSpan" id="kobo.4.1">, </span><em><span class="koboSpan" id="kobo.5.1">Kubernetes on Azure</span></em><span class="koboSpan" id="kobo.6.1">, will explore one more public cloud service named Microsoft Azure, which also provides a managed Kubernetes service.</span></p>


            </article>

            
        </section>
    </body></html>