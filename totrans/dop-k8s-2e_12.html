<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Kubernetes on Azure</span></h1>
                </header>
            
            <article>
                
<p class="mce-root"><span class="koboSpan" id="kobo.2.1">Just like AWS and GCP, Microsoft Azure's public cloud also has a hosted offering, which is Kubernetes. </span><span class="koboSpan" id="kobo.2.2">The </span><strong><span class="koboSpan" id="kobo.3.1">Azure </span><span><span class="koboSpan" id="kobo.4.1">Kubernetes</span></span><span class="koboSpan" id="kobo.5.1"> Service</span></strong><span class="koboSpan" id="kobo.6.1"> (</span><strong><span class="koboSpan" id="kobo.7.1">AKS</span></strong><span class="koboSpan" id="kobo.8.1">) was introduced in 2017. </span><span class="koboSpan" id="kobo.8.2">Users of Azure can manage, deploy, and scale their containerized applications on AKS without worrying about the underlying infrastructure.</span></p>
<p><span class="koboSpan" id="kobo.9.1">In this chapter, we'll start by giving an introduction to Azure and then go through the major services that AKS uses. </span><span class="koboSpan" id="kobo.9.2">We'll then learn how to launch an AKS cluster and play with it:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.10.1">Introduction to Azure</span></li>
<li><span class="koboSpan" id="kobo.11.1">Fundamental services in Azure</span></li>
<li><span class="koboSpan" id="kobo.12.1">Setting up AKS</span></li>
<li><span class="koboSpan" id="kobo.13.1">Azure cloud providers</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Introduction to Azure</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Like GCP, Microsoft Azure provides </span><strong><span class="koboSpan" id="kobo.3.1">Platform as a Service</span></strong><span class="koboSpan" id="kobo.4.1"> (</span><strong><span class="koboSpan" id="kobo.5.1">PaaS</span></strong><span class="koboSpan" id="kobo.6.1">). </span><span class="koboSpan" id="kobo.6.2">Users can deploy their applications to the Azure app service without having to know about detailed settings and VM management. </span><span class="koboSpan" id="kobo.6.3">Since 2010, Azure has been serving Microsoft software and third-party software to many users. </span><span class="koboSpan" id="kobo.6.4">Each </span><span><span class="koboSpan" id="kobo.7.1">Azure </span></span><span class="koboSpan" id="kobo.8.1">service provides different pricing tiers. </span><span class="koboSpan" id="kobo.8.2">In Azure, these pricing tiers are also called </span><em><span class="koboSpan" id="kobo.9.1">SKUs</span></em><span class="koboSpan" id="kobo.10.1"> (</span><a href="https://en.wikipedia.org/wiki/Stock_keeping_unit"><span class="koboSpan" id="kobo.11.1">https://en.wikipedia.org/wiki/Stock_keeping_unit</span></a><span class="koboSpan" id="kobo.12.1">). </span></p>
<p><span class="koboSpan" id="kobo.13.1">The </span><strong><span class="koboSpan" id="kobo.14.1">Azure Kubernetes Service</span></strong><span class="koboSpan" id="kobo.15.1"> (</span><strong><span class="koboSpan" id="kobo.16.1">AKS</span></strong><span class="koboSpan" id="kobo.17.1">) was announced in 2017 as the new support for their original container orchestrator solution, </span><strong><span class="koboSpan" id="kobo.18.1">Azure Container Service</span></strong><span class="koboSpan" id="kobo.19.1"> (</span><strong><span class="koboSpan" id="kobo.20.1">ACS</span></strong><span class="koboSpan" id="kobo.21.1">). </span><span class="koboSpan" id="kobo.21.2">Since then, container solutions in Azure focused more on Kubernetes support rather than other container orchestrators, such as Docker Enterprise and Mesosphere DC/OS. </span><span class="koboSpan" id="kobo.21.3">As a Kubernetes cloud provider, AKS provides some native support, such as Azure active directory for RBAC, Azure disks for storage class, Azure load balancers for services, and HTTP application routing for ingress.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Resource groups</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">A r</span><strong><span class="koboSpan" id="kobo.3.1">esource group</span></strong><span class="koboSpan" id="kobo.4.1"> in Azure is a set of resources </span><span><span class="koboSpan" id="kobo.5.1">that represent a logical group</span></span><span class="koboSpan" id="kobo.6.1">. </span><span class="koboSpan" id="kobo.6.2">You can deploy and delete all the resources inside a group at once.</span><strong><span class="koboSpan" id="kobo.7.1"> Azure resource manager</span></strong><span class="koboSpan" id="kobo.8.1"> is a tool that's used to help you manage your resource groups. </span><span class="koboSpan" id="kobo.8.2">In line with the spirit of infrastructure as code (</span><a href="https://en.wikipedia.org/wiki/Infrastructure_as_code"><span class="koboSpan" id="kobo.9.1">https://en.wikipedia.org/wiki/Infrastructure_as_code</span></a><span class="koboSpan" id="kobo.10.1">), Azure provides a </span><strong><span class="koboSpan" id="kobo.11.1">resource manager template</span></strong><span class="koboSpan" id="kobo.12.1">, which is a file in JSON format that defines the configuration and the dependencies of the desired resources. </span><span class="koboSpan" id="kobo.12.2">Users can deploy the template to multiple resource groups for different environments repeatedly and consistently. </span></p>
<p><span class="koboSpan" id="kobo.13.1">Let's see how these things look in the Azure portal. </span><span class="koboSpan" id="kobo.13.2">First, you'll need to have an Azure account. </span><span class="koboSpan" id="kobo.13.3">If you don't have one, go to </span><a href="https://azure.microsoft.com/features/azure-portal/"><span class="koboSpan" id="kobo.14.1">https://azure.microsoft.com/features/azure-portal/</span></a><span class="koboSpan" id="kobo.15.1"> and sign up to get a free account. </span><span class="koboSpan" id="kobo.15.2">The Azure free account offers you 12 months of popular free services and $200 credit for 30 days. </span><span><span class="koboSpan" id="kobo.16.1">Credit card information is needed for account registration, but you won't be charged unless you upgrade your account type.</span></span></p>
<p><span class="koboSpan" id="kobo.17.1">After logging in, click on </span><span class="packt_screen"><span class="koboSpan" id="kobo.18.1">Create a resource</span></span><span class="koboSpan" id="kobo.19.1"> on the sidebar and go to </span><span class="packt_screen"><span class="koboSpan" id="kobo.20.1">Get started</span></span><span class="koboSpan" id="kobo.21.1">. </span><span class="koboSpan" id="kobo.21.2">We'll see a web app there; click on it and input the app name. </span><span class="koboSpan" id="kobo.21.3">For resource creation, you'll need to specify the </span><span class="packt_screen"><span class="koboSpan" id="kobo.22.1">Resource Group</span></span><span class="koboSpan" id="kobo.23.1">. </span><span class="koboSpan" id="kobo.23.2">We can either use an existing one or create a new one. </span><span class="koboSpan" id="kobo.23.3">Let's create a new one for now, as we don't have any resource groups yet. </span><span class="koboSpan" id="kobo.23.4">Change the </span><span class="packt_screen"><span class="koboSpan" id="kobo.24.1">Runtime Stack</span></span><span class="koboSpan" id="kobo.25.1"> to your application runtime if needed. </span><span class="koboSpan" id="kobo.25.2">The screenshot for this is as follows:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.26.1"><img src="assets/34e44eb5-6cee-4034-ba74-561c0857afad.png" style="width:69.67em;height:55.25em;"/></span></p>
<p><span><span class="koboSpan" id="kobo.27.1">At the bottom of the page, beside the </span><span class="packt_screen"><span class="koboSpan" id="kobo.28.1">Create</span></span><span class="koboSpan" id="kobo.29.1"> button, there is an </span><span class="packt_screen"><span class="koboSpan" id="kobo.30.1">Automation options</span></span><span class="koboSpan" id="kobo.31.1"> button. </span><span class="koboSpan" id="kobo.31.2">If we click that, we'll </span></span><span class="koboSpan" id="kobo.32.1">see that a resource template is created </span><span><span class="koboSpan" id="kobo.33.1">automatically</span></span><span><span class="koboSpan" id="kobo.34.1">.</span></span> <span><span class="koboSpan" id="kobo.35.1">If we click </span><span class="packt_screen"><span class="koboSpan" id="kobo.36.1">Deploy</span></span><span class="koboSpan" id="kobo.37.1">, the custom parameters defined by the template will be shown. </span><span class="koboSpan" id="kobo.37.2">For now, we will just click on</span></span> <span class="packt_screen"><span class="koboSpan" id="kobo.38.1">Create</span></span> <span><span class="koboSpan" id="kobo.39.1">directly. </span><span class="koboSpan" id="kobo.39.2">Here is a screenshot of the resource template:</span></span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.40.1"><img src="assets/9c540cdf-d148-4dc5-8e4a-8947a9355356.png"/></span></p>
<p><span class="koboSpan" id="kobo.41.1">After clicking </span><span class="packt_screen"><span class="koboSpan" id="kobo.42.1">Create</span></span><span class="koboSpan" id="kobo.43.1">, the console will bring us to the following view for us to explore. </span><span class="koboSpan" id="kobo.43.2">Let's go to our newly created resource group, </span><kbd><span class="koboSpan" id="kobo.44.1">devops-app</span></kbd><span class="koboSpan" id="kobo.45.1">, under the </span><span class="packt_screen"><span class="koboSpan" id="kobo.46.1">Recent</span></span> <span class="packt_screen"><span class="koboSpan" id="kobo.47.1">resources</span></span><span class="koboSpan" id="kobo.48.1"> tab:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.49.1"><img src="assets/3e89ab68-bb39-46fd-abc3-dcc4549b6666.png" style="width:65.75em;height:50.33em;"/></span></p>
<p><span class="koboSpan" id="kobo.50.1">In this resource group, we can see that there's one application running in the </span><span class="packt_screen"><span class="koboSpan" id="kobo.51.1">App Services</span></span><span class="koboSpan" id="kobo.52.1"> and one service plan. </span><span class="koboSpan" id="kobo.52.2">We can also see lots of functionalities in the sidebar. </span><span class="koboSpan" id="kobo.52.3">The resource group aims to give users a comprehensive view of a group of resources, so we don't need to go to a different console to find them:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.53.1"><img src="assets/a7f3fdb9-61df-4a95-8a39-b39850d8b759.png"/></span></p>
<p><span class="koboSpan" id="kobo.54.1">If we click on </span><span><span><span class="koboSpan" id="kobo.55.1">the</span></span></span> <kbd><span class="koboSpan" id="kobo.56.1">devops-app</span></kbd> <span><span><span class="packt_screen"><span class="koboSpan" id="kobo.57.1">Resource group</span></span></span></span><span class="koboSpan" id="kobo.58.1">, it'll bring us to the app service console, which is the PaaS offering in Azure:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.59.1"><img src="assets/3273794e-e707-49ec-8e76-8b0cfdf074e0.png" style="width:73.17em;height:52.92em;"/></span></p>
<p><span class="koboSpan" id="kobo.60.1">At this point, the sample web app has been deployed to the Azure app service. </span><span class="koboSpan" id="kobo.60.2">If we visit the endpoint specified in the URL (which in this case is </span><a href="https://devops-app.azurewebsites.net/"><span class="koboSpan" id="kobo.61.1">https://devops-app.azurewebsites.net/</span></a><span class="koboSpan" id="kobo.62.1">), we can find it:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.63.1"><img src="assets/ed27caa1-f71c-4ab3-86ff-0deb3099e3cd.png" style="width:70.25em;height:33.33em;"/></span></p>
<p><span class="koboSpan" id="kobo.64.1">We could also upload our own web app, or integrate with our version control software, such as GitHub or Bitbucket, and build our whole pipeline with Azure. </span><span class="koboSpan" id="kobo.64.2">For more information, please visit the deployment center page (</span><a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-continuous-deployment"><span class="koboSpan" id="kobo.65.1">https://docs.microsoft.com/en-us/azure/app-service/deploy-continuous-deployment</span></a><span class="koboSpan" id="kobo.66.1">).</span></p>
<p class="mce-root"><span><span class="koboSpan" id="kobo.67.1">We can also easily delete resource groups in the </span><span class="packt_screen"><span class="koboSpan" id="kobo.68.1">Resource groups</span></span><span class="koboSpan" id="kobo.69.1"> console:</span></span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.70.1"><img src="assets/a19f2512-3930-4952-9348-87bc18657af1.png"/></span></p>
<p><span class="koboSpan" id="kobo.71.1">After confirmation, the related resources will be cleaned up:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.72.1"><img src="assets/750d3964-3702-4c9f-b965-fc1f7e67f6b6.png"/></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Azure virtual network</span></h1>
                </header>
            
            <article>
                
<p class="mce-root"><span class="koboSpan" id="kobo.2.1">The Azure </span><strong><span class="koboSpan" id="kobo.3.1">Virtual Network</span></strong><span class="koboSpan" id="kobo.4.1"> (</span><strong><span class="koboSpan" id="kobo.5.1">VNet</span></strong><span class="koboSpan" id="kobo.6.1">) creates an isolated private network segment in Azure. </span><span class="koboSpan" id="kobo.6.2">This concept is similar to VPC in AWS and GCP. </span><span class="koboSpan" id="kobo.6.3">Users specify a range of </span><span><span class="koboSpan" id="kobo.7.1">contiguous </span></span><span><span><span class="koboSpan" id="kobo.8.1">IPs (that is, CIDR: </span><a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing"><span class="koboSpan" id="kobo.9.1">https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing</span></a><span class="koboSpan" id="kobo.10.1">)</span></span></span><span class="koboSpan" id="kobo.11.1"> and locations (otherwise known as regions in AWS). </span><span class="koboSpan" id="kobo.11.2">We can find a full list of locations at </span><a href="https://azure.microsoft.com/global-infrastructure/locations/"><span class="koboSpan" id="kobo.12.1">https://azure.microsoft.com/global-infrastructure/locations/</span></a><span class="koboSpan" id="kobo.13.1">. </span><span class="koboSpan" id="kobo.13.2">We can also create multiple subnets inside a virtual network, or enable an Azure firewall upon creation. </span><span class="koboSpan" id="kobo.13.3">The Azure firewall is a network security service with high availability and scalability. </span><span class="koboSpan" id="kobo.13.4">It can control and filter traffic with user-specified rules. </span><span class="koboSpan" id="kobo.13.5">It also provides inbound DNAT and outbound SNAT support. </span><span class="koboSpan" id="kobo.13.6">Depending on the platform you're using, you can install the Azure CLI (the documentation for which can be found here: </span><a href="https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest"><span class="koboSpan" id="kobo.14.1">https://docs.microsoft.com/en-us/cli/azure/?view=azure-cli-latest</span></a><span class="koboSpan" id="kobo.15.1">) via the </span><span><span class="koboSpan" id="kobo.16.1">instructions at the following link:</span></span><span class="koboSpan" id="kobo.17.1"> </span><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest"><span class="koboSpan" id="kobo.18.1">https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest</span></a><span class="koboSpan" id="kobo.19.1">. </span><span class="koboSpan" id="kobo.19.2">Alternatively, you can use </span><span><span class="koboSpan" id="kobo.20.1">cloud shell</span></span> <span><span class="koboSpan" id="kobo.21.1">(</span></span><a href="https://shell.azure.com/"><span class="koboSpan" id="kobo.22.1">https://shell.azure.com/</span></a><span class="koboSpan" id="kobo.23.1">) directly. Azure cloud shell is a cloud-based admin shell that you can use to manage your cloud resources, which already has the Azure CLI installed.</span><span><span class="koboSpan" id="kobo.24.1"> </span></span></p>
<p class="mce-root"><span><span class="koboSpan" id="kobo.25.1">In the following example, we'll demonstrate how to use the Azure CLI to create an Azure virtual network via an Azure cloud shell. </span></span><span class="koboSpan" id="kobo.26.1">Simply log in to your account and attach cloud storage to persist the data. </span><span class="koboSpan" id="kobo.26.2">Then, we're good to go: </span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.27.1"><img src="assets/c1977197-b1a1-48eb-83d5-467273385610.png" style="width:44.50em;height:17.92em;"/></span></p>
<p><span class="koboSpan" id="kobo.28.1">After clicking the </span><span class="packt_screen"><span class="koboSpan" id="kobo.29.1">Create</span></span><span class="koboSpan" id="kobo.30.1"> button and waiting for a few seconds, a cloud shell console will be launched in your browser:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.31.1"><img src="assets/ec96efff-d94c-40eb-b3d0-6f73400be4e3.png" style="width:33.25em;height:22.42em;"/></span></p>
<p><span class="koboSpan" id="kobo.32.1">The Azure CLI commands start with </span><kbd><span class="koboSpan" id="kobo.33.1">az</span></kbd><span class="koboSpan" id="kobo.34.1"> as the group name. </span><span class="koboSpan" id="kobo.34.2">You could type </span><kbd><span class="koboSpan" id="kobo.35.1">az --help</span></kbd><span class="koboSpan" id="kobo.36.1"> to see a list of subgroups or use </span><kbd><span class="koboSpan" id="kobo.37.1">az $subgroup_name --help</span></kbd><span class="koboSpan" id="kobo.38.1"> any time to find more information about a subcommand for a subgroup. </span><span class="koboSpan" id="kobo.38.2">A subgroup might contain multiple subgroups. </span><span class="koboSpan" id="kobo.38.3">At the end of the command is the operation that you want to carry out with the resource and a set of parameters about the configuration. </span><span class="koboSpan" id="kobo.38.4">This looks as follows:</span></p>
<pre><strong><span class="koboSpan" id="kobo.39.1"># az $subgroup1 [$subgroup2 ...] $commands [$parameters]</span></strong></pre>
<p><span><span class="koboSpan" id="kobo.40.1">In the following example, we'll create a virtual network named </span><kbd><span class="koboSpan" id="kobo.41.1">devops-vnet</span></kbd><span class="koboSpan" id="kobo.42.1">. </span><span class="koboSpan" id="kobo.42.2">First, we'll have to create a new resource group, since we deleted the only one we had in the previous section. </span><span class="koboSpan" id="kobo.42.3">Now, let's create a resource group called </span><kbd><span class="koboSpan" id="kobo.43.1">devops</span></kbd><span class="koboSpan" id="kobo.44.1"> in the central US</span></span><span><span class="koboSpan" id="kobo.45.1"> </span></span><span><span class="koboSpan" id="kobo.46.1">location</span></span><span><span class="koboSpan" id="kobo.47.1">:</span></span></p>
<pre><span class="koboSpan" id="kobo.48.1"># </span><strong><span class="koboSpan" id="kobo.49.1">az group create --name devops --location centralus</span></strong><br/><strong><span class="koboSpan" id="kobo.50.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.51.1">  "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.52.1">  "location": "centralus",</span></strong><br/><strong><span class="koboSpan" id="kobo.53.1">  "managedBy": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.54.1">  "name": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.55.1">  "properties": {</span></strong><br/><strong><span class="koboSpan" id="kobo.56.1">    "provisioningState": "Succeeded"</span></strong><br/><strong><span class="koboSpan" id="kobo.57.1">  },</span></strong><br/><strong><span class="koboSpan" id="kobo.58.1">  "tags": null</span></strong><br/><strong><span class="koboSpan" id="kobo.59.1">}</span></strong></pre>
<p><span class="koboSpan" id="kobo.60.1">In the preceding command, the subgroup name is </span><kbd><span class="koboSpan" id="kobo.61.1">group</span></kbd><span class="koboSpan" id="kobo.62.1"> and the operation command is </span><kbd><span class="koboSpan" id="kobo.63.1">create</span></kbd><span class="koboSpan" id="kobo.64.1">. </span><span class="koboSpan" id="kobo.64.2">Next, we'll use </span><kbd><span class="koboSpan" id="kobo.65.1">network.vnet</span></kbd><span class="koboSpan" id="kobo.66.1"> subgroups to create our virtual network resources with the CIDR </span><kbd><span class="koboSpan" id="kobo.67.1">10.0.0.0/8</span></kbd><span class="koboSpan" id="kobo.68.1">, and leave the rest of the settings as their default values:</span></p>
<pre><strong><span class="koboSpan" id="kobo.69.1"># az network vnet create --name devops-vnet --resource-group devops --subnet-name default --address-prefixes 10.0.0.0/8</span></strong><br/><strong><span class="koboSpan" id="kobo.70.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.71.1">  "newVNet": {</span></strong><br/><strong><span class="koboSpan" id="kobo.72.1">    "addressSpace": {</span></strong><br/><strong><span class="koboSpan" id="kobo.73.1">      "addressPrefixes": [</span></strong><br/><strong><span class="koboSpan" id="kobo.74.1">        "10.0.0.0/8"</span></strong><br/><strong><span class="koboSpan" id="kobo.75.1">      ]</span></strong><br/><strong><span class="koboSpan" id="kobo.76.1">    },</span></strong><br/><strong><span class="koboSpan" id="kobo.77.1">    "ddosProtectionPlan": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.78.1">    "dhcpOptions": {</span></strong><br/><strong><span class="koboSpan" id="kobo.79.1">      "dnsServers": []</span></strong><br/><strong><span class="koboSpan" id="kobo.80.1">    },</span></strong><br/><strong><span class="koboSpan" id="kobo.81.1">    "enableDdosProtection": false,</span></strong><br/><strong><span class="koboSpan" id="kobo.82.1">    "enableVmProtection": false,</span></strong><br/><strong><span class="koboSpan" id="kobo.83.1">    "etag": "W/\"a93c56be-6eab-4391-8fca-25e11625c6e5\"",</span></strong><br/><strong><span class="koboSpan" id="kobo.84.1">    "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/virtualNetworks/devops-vnet",</span></strong><br/><strong><span class="koboSpan" id="kobo.85.1">    "location": "centralus",</span></strong><br/><strong><span class="koboSpan" id="kobo.86.1">    "name": "devops-vnet",</span></strong><br/><strong><span class="koboSpan" id="kobo.87.1">    "provisioningState": "Succeeded",</span></strong><br/><strong><span class="koboSpan" id="kobo.88.1">    "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.89.1">    "resourceGuid": "f5b9de39-197c-440f-a43f-51964ee9e252",</span></strong><br/><strong><span class="koboSpan" id="kobo.90.1">    "subnets": [</span></strong><br/><strong><span class="koboSpan" id="kobo.91.1">      {</span></strong><br/><strong><span class="koboSpan" id="kobo.92.1">        "addressPrefix": "10.0.0.0/24",</span></strong><br/><strong><span class="koboSpan" id="kobo.93.1">        "addressPrefixes": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.94.1">        "delegations": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.95.1">        "etag": "W/\"a93c56be-6eab-4391-8fca-25e11625c6e5\"",</span></strong><br/><strong><span class="koboSpan" id="kobo.96.1">        "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/virtualNetworks/devops-vnet/subnets/default",</span></strong><br/><strong><span class="koboSpan" id="kobo.97.1">        "interfaceEndpoints": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.98.1">        "ipConfigurationProfiles": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.99.1">        "ipConfigurations": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.100.1">        "name": "default",</span></strong><br/><strong><span class="koboSpan" id="kobo.101.1">        "networkSecurityGroup": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.102.1">        "provisioningState": "Succeeded",</span></strong><br/><strong><span class="koboSpan" id="kobo.103.1">        "purpose": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.104.1">        "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.105.1">        "resourceNavigationLinks": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.106.1">        "routeTable": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.107.1">        "serviceAssociationLinks": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.108.1">        "serviceEndpointPolicies": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.109.1">        "serviceEndpoints": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.110.1">        "type": "Microsoft.Network/virtualNetworks/subnets"</span></strong><br/><strong><span class="koboSpan" id="kobo.111.1">      }</span></strong><br/><strong><span class="koboSpan" id="kobo.112.1">    ],</span></strong><br/><strong><span class="koboSpan" id="kobo.113.1">    "tags": {},</span></strong><br/><strong><span class="koboSpan" id="kobo.114.1">    "type": "Microsoft.Network/virtualNetworks",</span></strong><br/><strong><span class="koboSpan" id="kobo.115.1">    "virtualNetworkPeerings": []</span></strong><br/><strong><span class="koboSpan" id="kobo.116.1">  }</span></strong><br/><strong><span class="koboSpan" id="kobo.117.1">}</span></strong></pre>
<p class="mce-root"><span><span class="koboSpan" id="kobo.118.1">We could always view a list of our settings using</span></span> <kbd><span class="koboSpan" id="kobo.119.1">az</span></kbd> <span><span class="koboSpan" id="kobo.120.1">with the </span></span><kbd><span class="koboSpan" id="kobo.121.1">list</span></kbd> <span><span class="koboSpan" id="kobo.122.1">command, such as </span><kbd><span class="koboSpan" id="kobo.123.1">az network vnet list</span></kbd></span><span class="koboSpan" id="kobo.124.1">, or go to the Azure portal to check it out:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.125.1"><img src="assets/0438a145-36fa-4913-8f55-f2d44d14b3b1.png" style="width:66.50em;height:52.42em;"/></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Network security groups</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">A network security group is associated with a virtual network and contains a set of security rules. </span><span class="koboSpan" id="kobo.2.2">A security rule defines the policies of the inbound and outbound traffic of subnets or virtual machines. </span><span><span class="koboSpan" id="kobo.3.1">Using the network security group, a user can define whether the inbound traffic is allowed to access the resources of a group, and also whether the outbound traffic is allowed.</span></span><span class="koboSpan" id="kobo.4.1"> A security rule contains the following:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.5.1">A priority (t</span><span><span class="koboSpan" id="kobo.6.1">his can range from 100 to 4096; the lower the number, the higher the priority</span></span><span class="koboSpan" id="kobo.7.1">)</span></li>
<li><span class="koboSpan" id="kobo.8.1">A source or destination (a CIDR block, a group of IPs, or another security group)</span></li>
</ul>
<ul>
<li><span class="koboSpan" id="kobo.9.1">A protocol (TCP/UDP/ICMP)</span></li>
<li><span class="koboSpan" id="kobo.10.1">A direction (inbound/outbound)</span></li>
<li><span class="koboSpan" id="kobo.11.1">A port range</span></li>
<li><span class="koboSpan" id="kobo.12.1">An action (allow/deny)</span></li>
</ul>
<p><span class="koboSpan" id="kobo.13.1">Let's create a network security group called </span><kbd><span class="koboSpan" id="kobo.14.1">test-nsg</span></kbd><span class="koboSpan" id="kobo.15.1">. </span><span class="koboSpan" id="kobo.15.2">Note that the user-defined rules are attached after the security group is created:</span></p>
<pre><strong><span class="koboSpan" id="kobo.16.1"># az network nsg create --name test-nsg --resource-group devops --location centralus</span></strong><br/><strong><span class="koboSpan" id="kobo.17.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.18.1">  "NewNSG": {</span></strong><br/><strong><span class="koboSpan" id="kobo.19.1">    "defaultSecurityRules": [</span></strong><br/><strong><span class="koboSpan" id="kobo.20.1">      {</span></strong><br/><strong><span class="koboSpan" id="kobo.21.1">        "access": "Allow",</span></strong><br/><strong><span class="koboSpan" id="kobo.22.1">        "description": "Allow inbound traffic from all VMs in VNET",</span></strong><br/><strong><span class="koboSpan" id="kobo.23.1">        "destinationAddressPrefix": "VirtualNetwork",</span></strong><br/><strong><span class="koboSpan" id="kobo.24.1">        "name": "AllowVnetInBound",</span></strong><br/><strong><span class="koboSpan" id="kobo.25.1">        "priority": 65000,</span></strong><br/><strong><span class="koboSpan" id="kobo.26.1">        "sourceAddressPrefix": "VirtualNetwork",</span></strong><br/><strong><span class="koboSpan" id="kobo.27.1">        ...</span></strong><br/><strong><span class="koboSpan" id="kobo.28.1">        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"</span></strong><br/><strong><span class="koboSpan" id="kobo.29.1">      },</span></strong><br/><strong><span class="koboSpan" id="kobo.30.1">      {</span></strong><br/><strong><span class="koboSpan" id="kobo.31.1">        "access": "Allow",</span></strong><br/><strong><span class="koboSpan" id="kobo.32.1">        "description": "Allow inbound traffic from azure load balancer",</span></strong><br/><strong><span class="koboSpan" id="kobo.33.1">        "destinationAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.34.1">        "name": "AllowAzureLoadBalancerInBound",</span></strong><br/><strong><span class="koboSpan" id="kobo.35.1">        "priority": 65001,</span></strong><br/><strong><span class="koboSpan" id="kobo.36.1">        "sourceAddressPrefix": "AzureLoadBalancer",</span></strong><br/><strong><span class="koboSpan" id="kobo.37.1">        ...</span></strong><br/><strong><span class="koboSpan" id="kobo.38.1">        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"</span></strong><br/><strong><span class="koboSpan" id="kobo.39.1">      },</span></strong><br/><strong><span class="koboSpan" id="kobo.40.1">      {</span></strong><br/><strong><span class="koboSpan" id="kobo.41.1">        "access": "Deny",</span></strong><br/><strong><span class="koboSpan" id="kobo.42.1">        "description": "Deny all inbound traffic",</span></strong><br/><strong><span class="koboSpan" id="kobo.43.1">        "destinationAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.44.1">        "name": "DenyAllInBound",</span></strong><br/><strong><span class="koboSpan" id="kobo.45.1">        "priority": 65500,</span></strong><br/><strong><span class="koboSpan" id="kobo.46.1">        "sourceAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.47.1">        ...</span></strong><br/><strong><span class="koboSpan" id="kobo.48.1">        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"</span></strong><br/><strong><span class="koboSpan" id="kobo.49.1">      },</span></strong><br/><strong><span class="koboSpan" id="kobo.50.1">      {</span></strong><br/><strong><span class="koboSpan" id="kobo.51.1">        "access": "Allow",</span></strong><br/><strong><span class="koboSpan" id="kobo.52.1">        "description": "Allow outbound traffic from all VMs to all VMs in VNET",</span></strong><br/><strong><span class="koboSpan" id="kobo.53.1">        "destinationAddressPrefix": "VirtualNetwork",</span></strong><br/><strong><span class="koboSpan" id="kobo.54.1">        "name": "AllowVnetOutBound",</span></strong><br/><strong><span class="koboSpan" id="kobo.55.1">        "priority": 65000,</span></strong><br/><strong><span class="koboSpan" id="kobo.56.1">       "sourceAddressPrefix": "VirtualNetwork",</span></strong><br/><strong><span class="koboSpan" id="kobo.57.1">        ...</span></strong><br/><strong><span class="koboSpan" id="kobo.58.1">        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"</span></strong><br/><strong><span class="koboSpan" id="kobo.59.1">      },</span></strong><br/><strong><span class="koboSpan" id="kobo.60.1">      {</span></strong><br/><strong><span class="koboSpan" id="kobo.61.1">        "access": "Allow",</span></strong><br/><strong><span class="koboSpan" id="kobo.62.1">        "description": "Allow outbound traffic from all VMs to Internet",</span></strong><br/><strong><span class="koboSpan" id="kobo.63.1">        "destinationAddressPrefix": "Internet",</span></strong><br/><strong><span class="koboSpan" id="kobo.64.1">        "name": "AllowInternetOutBound",</span></strong><br/><strong><span class="koboSpan" id="kobo.65.1">        "priority": 65001,</span></strong><br/><strong><span class="koboSpan" id="kobo.66.1">        "sourceAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.67.1">        ...</span></strong><br/><strong><span class="koboSpan" id="kobo.68.1">        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"</span></strong><br/><strong><span class="koboSpan" id="kobo.69.1">      },</span></strong><br/><strong><span class="koboSpan" id="kobo.70.1">      {</span></strong><br/><strong><span class="koboSpan" id="kobo.71.1">        "access": "Deny",</span></strong><br/><strong><span class="koboSpan" id="kobo.72.1">        "description": "Deny all outbound traffic",</span></strong><br/><strong><span class="koboSpan" id="kobo.73.1">        "destinationAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.74.1">        "name": "DenyAllOutBound",</span></strong><br/><strong><span class="koboSpan" id="kobo.75.1">        "priority": 65500,</span></strong><br/><strong><span class="koboSpan" id="kobo.76.1">        "sourceAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.77.1">        ...</span></strong><br/><strong><span class="koboSpan" id="kobo.78.1">        "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"</span></strong><br/><strong><span class="koboSpan" id="kobo.79.1">      }</span></strong><br/><strong><span class="koboSpan" id="kobo.80.1">    ],</span></strong><br/><strong><span class="koboSpan" id="kobo.81.1">    "id": "...test-nsg",</span></strong><br/><strong><span class="koboSpan" id="kobo.82.1">    "location": "centralus",</span></strong><br/><strong><span class="koboSpan" id="kobo.83.1">    "name": "test-nsg",</span></strong><br/><strong><span class="koboSpan" id="kobo.84.1">    "networkInterfaces": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.85.1">    "provisioningState": "Succeeded",</span></strong><br/><strong><span class="koboSpan" id="kobo.86.1">    "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.87.1">    "resourceGuid": "9e0e3d0f-e99f-407d-96a6-8e96cf99ecfc",</span></strong><br/><strong><span class="koboSpan" id="kobo.88.1">    "securityRules": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.89.1">    "subnets": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.90.1">    "tags": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.91.1">    "type": "Microsoft.Network/networkSecurityGroups"</span></strong><br/><strong><span class="koboSpan" id="kobo.92.1">  }</span></strong><br/><strong><span class="koboSpan" id="kobo.93.1">}</span></strong></pre>
<p><span class="koboSpan" id="kobo.94.1">We find that Azure creates a set of default rules for each network security group. </span><span class="koboSpan" id="kobo.94.2">It denies all inbound traffic and allows access to outbound traffic by default. </span><span class="koboSpan" id="kobo.94.3">We can see that the source and destination cannot be a CIDR block, but instead have to be a service tag such as </span><kbd><span class="koboSpan" id="kobo.95.1">VirtualNetwork</span></kbd><span class="koboSpan" id="kobo.96.1">. </span><span class="koboSpan" id="kobo.96.2">These service tags are actually a set of predefined IP address prefixes. </span><span class="koboSpan" id="kobo.96.3">Azure manages the service tags and publishes them weekly. </span><span class="koboSpan" id="kobo.96.4">You can find the published service tags in the Microsoft download center (</span><a href="https://www.microsoft.com/en-us/download/details.aspx?id=56519"><span class="koboSpan" id="kobo.97.1">https://www.microsoft.com/en-us/download/details.aspx?id=56519</span></a><span class="koboSpan" id="kobo.98.1">):</span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td><strong><span class="koboSpan" id="kobo.99.1">Direction</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.100.1">Priority</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.101.1">Source</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.102.1">Source ports</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.103.1">Destination</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.104.1">Dest ports</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.105.1">Protocol</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.106.1">Access</span></strong></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.107.1">Inbound</span></td>
<td><kbd><span class="koboSpan" id="kobo.108.1">65000</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.109.1">VirtualNetwork</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.110.1">0</span></kbd><span class="koboSpan" id="kobo.111.1">-</span><kbd><span class="koboSpan" id="kobo.112.1">65535</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.113.1">VirtualNetwork</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.114.1">0</span></kbd><span><span class="koboSpan" id="kobo.115.1">-</span></span><kbd><span class="koboSpan" id="kobo.116.1">65535</span></kbd></td>
<td><span class="koboSpan" id="kobo.117.1">All</span></td>
<td>
<p class="mce-root"><span class="koboSpan" id="kobo.118.1">Allow</span></p>
</td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.119.1">Inbound</span></td>
<td><kbd><span class="koboSpan" id="kobo.120.1">65001</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.121.1">AzureLoadBalancer</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.122.1">0</span></kbd><span><span class="koboSpan" id="kobo.123.1">-</span></span><kbd><span class="koboSpan" id="kobo.124.1">65535</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.125.1">0.0.0.0/0</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.126.1">0</span></kbd><span><span class="koboSpan" id="kobo.127.1">-</span></span><kbd><span class="koboSpan" id="kobo.128.1">65535</span></kbd></td>
<td><span class="koboSpan" id="kobo.129.1">All</span></td>
<td>
<p class="mce-root"><span class="koboSpan" id="kobo.130.1">Allow</span></p>
</td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.131.1">Inbound</span></td>
<td><kbd><span class="koboSpan" id="kobo.132.1">65500</span></kbd></td>
<td><kbd><span><span class="koboSpan" id="kobo.133.1">0.0.0.0/0</span></span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.134.1">0</span></kbd><span><span class="koboSpan" id="kobo.135.1">-</span></span><kbd><span class="koboSpan" id="kobo.136.1">65535</span></kbd></td>
<td><kbd><span><span class="koboSpan" id="kobo.137.1">0.0.0.0/0</span></span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.138.1">0</span></kbd><span><span class="koboSpan" id="kobo.139.1">-</span></span><kbd><span class="koboSpan" id="kobo.140.1">65535</span></kbd></td>
<td><span class="koboSpan" id="kobo.141.1">All</span></td>
<td><span class="koboSpan" id="kobo.142.1">Deny</span></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.143.1">Outbound</span></td>
<td><kbd><span class="koboSpan" id="kobo.144.1">65000</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.145.1">VirtualNetwork</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.146.1">0</span></kbd><span><span class="koboSpan" id="kobo.147.1">-</span></span><kbd><span class="koboSpan" id="kobo.148.1">65535</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.149.1">VirtualNetwork</span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.150.1">0</span></kbd><span><span class="koboSpan" id="kobo.151.1">-</span></span><kbd><span class="koboSpan" id="kobo.152.1">65535</span></kbd></td>
<td><span class="koboSpan" id="kobo.153.1">All</span></td>
<td><span class="koboSpan" id="kobo.154.1">Allow</span></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.155.1">Outbound</span></td>
<td><kbd><span><span class="koboSpan" id="kobo.156.1">0.0.0.0/0</span></span></kbd></td>
<td><kbd><span><span class="koboSpan" id="kobo.157.1">0-65535</span></span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.158.1">0</span></kbd><span><span class="koboSpan" id="kobo.159.1">-</span></span><kbd><span class="koboSpan" id="kobo.160.1">65535</span></kbd></td>
<td><kbd><span><span class="koboSpan" id="kobo.161.1">Internet</span></span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.162.1">0</span></kbd><span><span class="koboSpan" id="kobo.163.1">-</span></span><kbd><span class="koboSpan" id="kobo.164.1">65535</span></kbd></td>
<td><span><span class="koboSpan" id="kobo.165.1">All</span></span></td>
<td><span class="koboSpan" id="kobo.166.1">Allow</span></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.167.1">Outbound</span></td>
<td><kbd><span><span class="koboSpan" id="kobo.168.1">0.0.0.0/0</span></span></kbd></td>
<td><kbd><span><span class="koboSpan" id="kobo.169.1">0-65535</span></span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.170.1">0</span></kbd><span><span class="koboSpan" id="kobo.171.1">-</span></span><kbd><span class="koboSpan" id="kobo.172.1">65535</span></kbd></td>
<td><kbd><span><span class="koboSpan" id="kobo.173.1">0.0.0.0/0</span></span></kbd></td>
<td><kbd><span class="koboSpan" id="kobo.174.1">0</span></kbd><span><span class="koboSpan" id="kobo.175.1">-</span></span><kbd><span class="koboSpan" id="kobo.176.1">65535</span></kbd></td>
<td><span><span class="koboSpan" id="kobo.177.1">All</span></span></td>
<td>
<p class="mce-root"><span><span class="koboSpan" id="kobo.178.1">Deny</span></span></p>
</td>
</tr>
</tbody>
</table>
<p><span class="koboSpan" id="kobo.179.1"> </span></p>
<p><span><span class="koboSpan" id="kobo.180.1">We can now create a network security group that accepts all rules and has the highest priority,</span></span><span class="koboSpan" id="kobo.181.1"> and attach it to the NSG we just created:</span></p>
<pre><strong><span class="koboSpan" id="kobo.182.1"># az network nsg rule create --name test-nsg --priority 100 --resource-group devops --nsg-name test-nsg</span></strong><br/><strong><span class="koboSpan" id="kobo.183.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.184.1">  "access": "Allow",</span></strong><br/><strong><span class="koboSpan" id="kobo.185.1">  "description": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.186.1">  "destinationAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.187.1">  "destinationAddressPrefixes": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.188.1">  "destinationApplicationSecurityGroups": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.189.1">  "destinationPortRange": "80",</span></strong><br/><strong><span class="koboSpan" id="kobo.190.1">  "destinationPortRanges": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.191.1">  "direction": "Inbound",</span></strong><br/><strong><span class="koboSpan" id="kobo.192.1">  "etag": "W/\"65e33e31-ec3c-4eea-8262-1cf5eed371b1\"",</span></strong><br/><strong><span class="koboSpan" id="kobo.193.1">  "id": "/subscriptions/.../resourceGroups/devops/providers/Microsoft.Network/networkSecurityGroups/test-nsg/securityRules/test-nsg",</span></strong><br/><strong><span class="koboSpan" id="kobo.194.1">  "name": "test-nsg",</span></strong><br/><strong><span class="koboSpan" id="kobo.195.1">  "priority": 100,</span></strong><br/><strong><span class="koboSpan" id="kobo.196.1">  "protocol": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.197.1">  "provisioningState": "Succeeded",</span></strong><br/><strong><span class="koboSpan" id="kobo.198.1">  "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.199.1">  "sourceAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.200.1">  "sourceAddressPrefixes": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.201.1">  "sourceApplicationSecurityGroups": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.202.1">  "sourcePortRange": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.203.1">  "sourcePortRanges": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.204.1">  "type": "Microsoft.Network/networkSecurityGroups/securityRules"</span></strong><br/><strong><span class="koboSpan" id="kobo.205.1">}</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Application security groups</span></h1>
                </header>
            
            <article>
                
<p class="CDPAlignLeft CDPAlign"><span class="koboSpan" id="kobo.2.1">Application security groups are a logical collection of VM NICs, which can be a source of destinations in the network security group rules. </span><span class="koboSpan" id="kobo.2.2">They make network security groups even more flexible. </span><span class="koboSpan" id="kobo.2.3">For example, let's assume that we have two VMs that will access the PostgreSQL database via </span><kbd><span class="koboSpan" id="kobo.3.1">5432</span></kbd><span class="koboSpan" id="kobo.4.1"> ports. </span><span><span class="koboSpan" id="kobo.5.1">We want to make sure that only those VMs have access to the database:</span></span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.6.1"><img src="assets/45569aa3-6d64-4810-804b-8343bb44ff42.png" style="width:21.50em;height:10.42em;"/></span></p>
<p><span><span class="koboSpan" id="kobo.7.1">We can create two application security groups named </span></span><kbd><span class="koboSpan" id="kobo.8.1">web</span></kbd><span><span class="koboSpan" id="kobo.9.1"> and </span></span><kbd><span class="koboSpan" id="kobo.10.1">db</span></kbd><span><span class="koboSpan" id="kobo.11.1">. </span><span class="koboSpan" id="kobo.11.2">Then, we join the VMs to the web group and the database to the db group, and create the following network security group rules:</span></span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td style="width: 11%"><strong><span class="koboSpan" id="kobo.12.1">Direction</span></strong></td>
<td style="width: 9%"><strong><span class="koboSpan" id="kobo.13.1">Priority</span></strong></td>
<td style="width: 8%"><strong><span class="koboSpan" id="kobo.14.1">Source</span></strong></td>
<td style="width: 13.1362%"><strong><span class="koboSpan" id="kobo.15.1">Source ports</span></strong></td>
<td style="width: 14.8638%"><strong><span class="koboSpan" id="kobo.16.1">Destination</span></strong></td>
<td style="width: 20%"><strong><span class="koboSpan" id="kobo.17.1">Dest ports</span></strong></td>
<td style="width: 10%"><strong><span class="koboSpan" id="kobo.18.1">Protocol</span></strong></td>
<td style="width: 8%"><strong><span class="koboSpan" id="kobo.19.1">Access</span></strong></td>
</tr>
<tr>
<td style="width: 11%"><span class="koboSpan" id="kobo.20.1">Inbound</span></td>
<td style="width: 9%"><span class="koboSpan" id="kobo.21.1">120</span></td>
<td style="width: 8%"><span class="koboSpan" id="kobo.22.1">*</span></td>
<td style="width: 13.1362%"><span><span class="koboSpan" id="kobo.23.1">*</span></span></td>
<td style="width: 14.8638%"><kbd><span class="koboSpan" id="kobo.24.1">db</span></kbd></td>
<td style="width: 20%"><kbd><span class="koboSpan" id="kobo.25.1">0</span></kbd><span class="koboSpan" id="kobo.26.1">-</span><kbd><span class="koboSpan" id="kobo.27.1">65535</span></kbd></td>
<td style="width: 10%"><span class="koboSpan" id="kobo.28.1">All</span></td>
<td style="width: 8%">
<p class="mce-root"><span class="koboSpan" id="kobo.29.1">Deny</span></p>
</td>
</tr>
<tr>
<td style="width: 11%"><span class="koboSpan" id="kobo.30.1">Inbound</span></td>
<td style="width: 9%"><span class="koboSpan" id="kobo.31.1">110</span></td>
<td style="width: 8%"><kbd><span class="koboSpan" id="kobo.32.1">web</span></kbd></td>
<td style="width: 13.1362%"><span><span class="koboSpan" id="kobo.33.1">*</span></span></td>
<td style="width: 14.8638%"><kbd><span class="koboSpan" id="kobo.34.1">db</span></kbd></td>
<td style="width: 20%"><kbd><span class="koboSpan" id="kobo.35.1">5432</span></kbd></td>
<td style="width: 10%"><span class="koboSpan" id="kobo.36.1">TCP</span></td>
<td style="width: 8%">
<p class="mce-root"><span class="koboSpan" id="kobo.37.1">Allow</span></p>
</td>
</tr>
</tbody>
</table>
<p><span class="koboSpan" id="kobo.38.1"> </span></p>
<p><span class="koboSpan" id="kobo.39.1">According to this table, the priority of the second rule is higher than the first one. </span><span class="koboSpan" id="kobo.39.2">Only the web group has access to the db group with port </span><kbd><span class="koboSpan" id="kobo.40.1">5432</span></kbd><span class="koboSpan" id="kobo.41.1">. </span><span class="koboSpan" id="kobo.41.2">All other inbound traffic will be denied.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Subnets</span></h1>
                </header>
            
            <article>
                
<p><span><span class="koboSpan" id="kobo.2.1">A subnet can be associated to a network security group. </span><span class="koboSpan" id="kobo.2.2">A subnet can also be associated with a route table so that it has specific routes.</span></span></p>
<div class="packt_infobox"><span><span class="koboSpan" id="kobo.3.1">Just like AWS, Azure also provides</span></span><span class="koboSpan" id="kobo.4.1"> route table resources </span><span><span class="koboSpan" id="kobo.5.1">for route management. </span><span class="koboSpan" id="kobo.5.2">By default, Azure already provides default routing for virtual networks and subnets. </span><span class="koboSpan" id="kobo.5.3">We don't need to worry about the routes when we use the AKS service. </span></span></div>
<p><span><span class="koboSpan" id="kobo.6.1">When creating a virtual network, a </span><kbd><span class="koboSpan" id="kobo.7.1">default</span></kbd><span class="koboSpan" id="kobo.8.1"> subnet will be created by</span></span><span class="koboSpan" id="kobo.9.1"> default</span><span><span class="koboSpan" id="kobo.10.1">:</span></span></p>
<pre><strong><span class="koboSpan" id="kobo.11.1"># az network vnet subnet list --vnet-name devops-vnet --resource-group devops</span></strong><br/><strong><span class="koboSpan" id="kobo.12.1">[</span></strong><br/><strong><span class="koboSpan" id="kobo.13.1">  {</span></strong><br/><strong><span class="koboSpan" id="kobo.14.1">    "addressPrefix": "10.0.0.0/24",</span></strong><br/><strong><span class="koboSpan" id="kobo.15.1">    "addressPrefixes": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.16.1">    "delegations": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.17.1">    "etag": "W/\"a93c56be-6eab-4391-8fca-25e11625c6e5\"",</span></strong><br/><strong><span class="koboSpan" id="kobo.18.1">    "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/virtualNetworks/devops-vnet/subnets/default",</span></strong><br/><strong><span class="koboSpan" id="kobo.19.1">    "interfaceEndpoints": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.20.1">    "ipConfigurationProfiles": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.21.1">    "ipConfigurations": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.22.1">    "name": "default",</span></strong><br/><strong><span class="koboSpan" id="kobo.23.1">    "networkSecurityGroup": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.24.1">    "provisioningState": "Succeeded",</span></strong><br/><strong><span class="koboSpan" id="kobo.25.1">    "purpose": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.26.1">    "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.27.1">    "resourceNavigationLinks": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.28.1">    "routeTable": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.29.1">    "serviceAssociationLinks": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.30.1">    "serviceEndpointPolicies": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.31.1">    "serviceEndpoints": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.32.1">    "type": "Microsoft.Network/virtualNetworks/subnets"</span></strong><br/><strong><span class="koboSpan" id="kobo.33.1">  }</span></strong><br/><strong><span class="koboSpan" id="kobo.34.1">]</span></strong></pre>
<p><span><span class="koboSpan" id="kobo.35.1">Other than the default subnet, let's create one more subnet with the prefix </span><kbd><span class="koboSpan" id="kobo.36.1">10.0.1.0/24</span></kbd><span class="koboSpan" id="kobo.37.1">. </span><span class="koboSpan" id="kobo.37.2">Note that the CIDR of the subnet needs to be in the same CIDR prefix network block as the VNet in which the subnet is located:</span></span></p>
<pre><strong><span class="koboSpan" id="kobo.38.1"># az network vnet subnet create --address-prefixes 10.0.1.0/24 --name test --vnet-name devops-vnet --resource-group devops</span></strong><br/><strong><span class="koboSpan" id="kobo.39.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.40.1">  "addressPrefix": "10.0.1.0/24",</span></strong><br/><strong><span class="koboSpan" id="kobo.41.1">  "addressPrefixes": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.42.1">  "delegations": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.43.1">  "etag": "W/\"9f7e284f-fd31-4bd3-ad09-f7dc75bb7c68\"",</span></strong><br/><strong><span class="koboSpan" id="kobo.44.1">  "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/virtualNetworks/devops-vnet/subnets/test",</span></strong><br/><strong><span class="koboSpan" id="kobo.45.1">  "interfaceEndpoints": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.46.1">  "ipConfigurationProfiles": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.47.1">  "ipConfigurations": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.48.1">  "name": "test",</span></strong><br/><strong><span class="koboSpan" id="kobo.49.1">  "networkSecurityGroup": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.50.1">  "provisioningState": "Succeeded",</span></strong><br/><strong><span class="koboSpan" id="kobo.51.1">  "purpose": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.52.1">  "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.53.1">  "resourceNavigationLinks": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.54.1">  "routeTable": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.55.1">  "serviceAssociationLinks": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.56.1">  "serviceEndpointPolicies": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.57.1">  "serviceEndpoints": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.58.1">  "type": "Microsoft.Network/virtualNetworks/subnets"</span></strong><br/><strong><span class="koboSpan" id="kobo.59.1">}</span></strong></pre>
<p><span class="koboSpan" id="kobo.60.1">We can now list the subnets in this VNet:</span></p>
<pre><strong><span class="koboSpan" id="kobo.61.1"># az network vnet subnet list --vnet-name devops-vnet --resource-group devops | jq .[].name</span></strong><br/><strong><span class="koboSpan" id="kobo.62.1">"default"</span></strong><br/><strong><span class="koboSpan" id="kobo.63.1">"test"</span></strong></pre>
<div class="packt_infobox"><kbd><span class="koboSpan" id="kobo.64.1">jq</span></kbd><span class="koboSpan" id="kobo.65.1"> (</span><a href="https://stedolan.github.io/jq/"><span class="koboSpan" id="kobo.66.1">https://stedolan.github.io/jq/</span></a><span class="koboSpan" id="kobo.67.1">):</span><strong><br/></strong><br/>
<kbd><span class="koboSpan" id="kobo.68.1">jq</span></kbd><span class="koboSpan" id="kobo.69.1"> is a JSON command-line processor that is installed in the cloud shell by default. </span><span class="koboSpan" id="kobo.69.2">It's a very convenient tool to list the desired fields inside a JSON output. </span><span class="koboSpan" id="kobo.69.3">If you're not familiar with </span><kbd><span class="koboSpan" id="kobo.70.1">jq</span></kbd><span class="koboSpan" id="kobo.71.1">, take a look at the manual at the following link: </span><a href="https://stedolan.github.io/jq/manual/"><span class="koboSpan" id="kobo.72.1">https://stedolan.github.io/jq/manual/</span></a><span class="koboSpan" id="kobo.73.1">.</span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Azure virtual machines</span></h1>
                </header>
            
            <article>
                
<p><strong><span class="koboSpan" id="kobo.2.1">Virtual Machines</span></strong><span class="koboSpan" id="kobo.3.1"> (</span><strong><span class="koboSpan" id="kobo.4.1">VM</span></strong><span class="koboSpan" id="kobo.5.1">) in Azure are like Amazon EC2s. </span><span class="koboSpan" id="kobo.5.2">To launch an instance, we have to know which VM image we want to launch. </span><span class="koboSpan" id="kobo.5.3">We can use the </span><kbd><span class="koboSpan" id="kobo.6.1">az vm image list</span></kbd><span class="koboSpan" id="kobo.7.1"> command to list a set of images that we can use. </span><span class="koboSpan" id="kobo.7.2">In the following example, we'll use a CentOS image:</span></p>
<pre><strong><span class="koboSpan" id="kobo.8.1"># az vm image list --output table</span></strong><br/><strong><span class="koboSpan" id="kobo.9.1">You are viewing an offline list of images, use --all to retrieve an up-to-date list</span></strong><br/><strong><span class="koboSpan" id="kobo.10.1">Offer Publisher Sku Urn UrnAlias Version</span></strong><br/><strong><span class="koboSpan" id="kobo.11.1">------------- ---------------------- ------------------ -----------------------------------------</span></strong><br/><strong><span class="koboSpan" id="kobo.12.1">CentOS OpenLogic 7.5 OpenLogic:CentOS:7.5:latest CentOS latest</span></strong><br/><strong><span class="koboSpan" id="kobo.13.1">CoreOS CoreOS Stable CoreOS:CoreOS:Stable:latest CoreOS latest</span></strong><br/><strong><span class="koboSpan" id="kobo.14.1">Debian credativ 8 credativ:Debian:8:latest Debian latest</span></strong><br/><strong><span class="koboSpan" id="kobo.15.1">openSUSE-Leap SUSE 42.3 SUSE:openSUSE-Leap:42.3:latest openSUSE-Leap latest</span></strong><br/><strong><span class="koboSpan" id="kobo.16.1">RHEL RedHat 7-RAW RedHat:RHEL:7-RAW:latest RHEL latest</span></strong><br/><strong><span class="koboSpan" id="kobo.17.1">SLES SUSE 12-SP2 SUSE:SLES:12-SP2:latest SLES latest</span></strong><br/><strong><span class="koboSpan" id="kobo.18.1">UbuntuServer Canonical 16.04-LTS Canonical:UbuntuServer:16.04-LTS:latest UbuntuLTS latest</span></strong><br/><strong><span class="koboSpan" id="kobo.19.1">WindowsServer MicrosoftWindowsServer 2019-Datacenter MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest Win2019Datacenter latest</span></strong><br/><strong><span class="koboSpan" id="kobo.20.1">WindowsServer MicrosoftWindowsServer 2016-Datacenter MicrosoftWindowsServer:WindowsServer:2016-Datacenter:latest Win2016Datacenter latest</span></strong><br/><strong><span class="koboSpan" id="kobo.21.1">WindowsServer MicrosoftWindowsServer 2012-R2-Datacenter MicrosoftWindowsServer:WindowsServer:2012-R2-Datacenter:latest Win2012R2Datacenter latest</span></strong><br/><strong><span class="koboSpan" id="kobo.22.1">WindowsServer MicrosoftWindowsServer 2012-Datacenter MicrosoftWindowsServer:WindowsServer:2012-Datacenter:latest Win2012Datacenter latest</span></strong><br/><strong><span class="koboSpan" id="kobo.23.1">WindowsServer MicrosoftWindowsServer 2008-R2-SP1 MicrosoftWindowsServer:WindowsServer:2008-R2-SP1:latest Win2008R2SP1 latest</span></strong></pre>
<p><span class="koboSpan" id="kobo.24.1">Then, we could use </span><kbd><span class="koboSpan" id="kobo.25.1">az vm create</span></kbd><span class="koboSpan" id="kobo.26.1"> to launch our VM. </span><span class="koboSpan" id="kobo.26.2">Specifying </span><kbd><span class="koboSpan" id="kobo.27.1">--generate-ssh-keys</span></kbd><span class="koboSpan" id="kobo.28.1"> will create an ssh for you to access:</span></p>
<pre><strong><span class="koboSpan" id="kobo.29.1"># az vm create --resource-group devops --name newVM --image CentOS --admin-username centos-user --generate-ssh-keys</span></strong><br/><strong><span class="koboSpan" id="kobo.30.1">SSH key files '/home/chloe/.ssh/id_rsa' and '/home/chloe/.ssh/id_rsa.pub' have been generated under ~/.ssh to allow SSH access to the VM. </span><span class="koboSpan" id="kobo.30.2">If using machines without permanent storage, back up your keys to a safelocation.</span></strong><br/><strong><span class="koboSpan" id="kobo.31.1"> - Running ..</span></strong><br/><strong><span class="koboSpan" id="kobo.32.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.33.1">  "fqdns": "",</span></strong><br/><strong><span class="koboSpan" id="kobo.34.1">  "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Compute/virtualMachines/newVM",</span></strong><br/><strong><span class="koboSpan" id="kobo.35.1">  "location": "centralus",</span></strong><br/><strong><span class="koboSpan" id="kobo.36.1">  "macAddress": "00-0D-3A-96-6B-A2",</span></strong><br/><strong><span class="koboSpan" id="kobo.37.1">  "powerState": "VM running",</span></strong><br/><strong><span class="koboSpan" id="kobo.38.1">  "privateIpAddress": "10.0.0.4",</span></strong><br/><strong><span class="koboSpan" id="kobo.39.1">  "publicIpAddress": "40.77.97.79",</span></strong><br/><strong><span class="koboSpan" id="kobo.40.1">  "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.41.1">  "zones": ""</span></strong><br/><strong><span class="koboSpan" id="kobo.42.1">}</span></strong></pre>
<p><span class="koboSpan" id="kobo.43.1">We can see that the </span><kbd><span class="koboSpan" id="kobo.44.1">publicIpAddress</span></kbd><span class="koboSpan" id="kobo.45.1"> of the newly created VM is </span><kbd><span class="koboSpan" id="kobo.46.1">40.77.97.79</span></kbd><span class="koboSpan" id="kobo.47.1">. </span><span class="koboSpan" id="kobo.47.2">Let's connect to it with the username we specified earlier:</span></p>
<pre><strong><span class="koboSpan" id="kobo.48.1"># ssh centos-user@40.77.97.79</span></strong><br/><strong><span class="koboSpan" id="kobo.49.1">The authenticity of host '40.77.97.79 (40.77.97.79)' can't be established.</span></strong><br/><strong><span class="koboSpan" id="kobo.50.1">ECDSA key fingerprint is SHA256:LAvnQH94bY7NaIoNgDLM5iMHT1LMRseFwu2HPqicTuo.</span></strong><br/><strong><span class="koboSpan" id="kobo.51.1">Are you sure you want to continue connecting (yes/no)? </span><span class="koboSpan" id="kobo.51.2">yes</span></strong><br/><strong><span class="koboSpan" id="kobo.52.1">Warning: Permanently added '40.77.97.79' (ECDSA) to the list of known hosts.</span></strong><br/><strong><span class="koboSpan" id="kobo.53.1">[centos-user@newVM ~]$</span></strong></pre>
<p><span class="koboSpan" id="kobo.54.1">It isn't appropriate to allow SSH into the instance all the time. </span><span class="koboSpan" id="kobo.54.2">Let's take a look at how to fix this. </span><span class="koboSpan" id="kobo.54.3">First, we'll have to know the network interfaces that attach to this VM:</span></p>
<pre><strong><span class="koboSpan" id="kobo.55.1"># az vm get-instance-view --name newVM --resource-group devops</span></strong><br/><strong><span class="koboSpan" id="kobo.56.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.57.1"> ...</span></strong><br/><strong><span class="koboSpan" id="kobo.58.1"> "networkProfile": {</span></strong><br/><strong><span class="koboSpan" id="kobo.59.1">    "networkInterfaces": [</span></strong><br/><strong><span class="koboSpan" id="kobo.60.1">      {</span></strong><br/><strong><span class="koboSpan" id="kobo.61.1">        "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/networkInterfaces/newVMVMNic",</span></strong><br/><strong><span class="koboSpan" id="kobo.62.1">        "primary": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.63.1">        "resourceGroup": "devops"</span></strong><br/><strong><span class="koboSpan" id="kobo.64.1">      }</span></strong><br/><strong><span class="koboSpan" id="kobo.65.1">    ]</span></strong><br/><strong><span class="koboSpan" id="kobo.66.1">  },</span></strong><br/><strong><span class="koboSpan" id="kobo.67.1">  ...</span></strong><br/><strong><span class="koboSpan" id="kobo.68.1">}</span></strong></pre>
<p><span class="koboSpan" id="kobo.69.1">After we find the </span><kbd><span class="koboSpan" id="kobo.70.1">id</span></kbd><span class="koboSpan" id="kobo.71.1"> of the NIC, we can find the associated network security group based on the NIC ID:</span></p>
<pre><strong><span class="koboSpan" id="kobo.72.1"># az network nic show --ids /subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/networkInterfaces/newVMVMNic | jq .networkSecurityGroup</span></strong><br/><strong><span class="koboSpan" id="kobo.73.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.74.1">  "defaultSecurityRules": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.75.1">  "etag": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.76.1">  "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/networkSecurityGroups/newVMNSG",</span></strong><br/><strong><span class="koboSpan" id="kobo.77.1">  "location": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.78.1">  "name": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.79.1">  "networkInterfaces": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.80.1">  "provisioningState": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.81.1">  "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.82.1">  "resourceGuid": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.83.1">  "securityRules": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.84.1">  "subnets": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.85.1">  "tags": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.86.1">  "type": null</span></strong><br/><strong><span class="koboSpan" id="kobo.87.1">}</span></strong><br/><br/></pre>
<p><span class="koboSpan" id="kobo.88.1">Here, we can see that the name of the NSG is </span><kbd><span class="koboSpan" id="kobo.89.1">newVMNSG</span></kbd><span class="koboSpan" id="kobo.90.1">. </span><span class="koboSpan" id="kobo.90.2">Let's list the rules that attach to this NSG:</span></p>
<pre><strong><span class="koboSpan" id="kobo.91.1"># az network nsg rule list --resource-group devops --nsg-name newVMNSG</span></strong><br/><strong><span class="koboSpan" id="kobo.92.1">[</span></strong><br/><strong><span class="koboSpan" id="kobo.93.1">  {</span></strong><br/><strong><span class="koboSpan" id="kobo.94.1">    "access": "Allow",</span></strong><br/><strong><span class="koboSpan" id="kobo.95.1">    "description": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.96.1">    "destinationAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.97.1">    "destinationAddressPrefixes": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.98.1">    "destinationApplicationSecurityGroups": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.99.1">    "destinationPortRange": "22",</span></strong><br/><strong><span class="koboSpan" id="kobo.100.1">    "destinationPortRanges": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.101.1">    "direction": "Inbound",</span></strong><br/><strong><span class="koboSpan" id="kobo.102.1">    "etag": "W/\"9ab6b2d7-c915-4abd-9c02-a65049a62f02\"",</span></strong><br/><strong><span class="koboSpan" id="kobo.103.1">    "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/networkSecurityGroups/newVMNSG/securityRules/default-allow-ssh",</span></strong><br/><strong><span class="koboSpan" id="kobo.104.1">    "name": "default-allow-ssh",</span></strong><br/><strong><span class="koboSpan" id="kobo.105.1">    "priority": 1000,</span></strong><br/><strong><span class="koboSpan" id="kobo.106.1">    "protocol": "Tcp",</span></strong><br/><strong><span class="koboSpan" id="kobo.107.1">    "provisioningState": "Succeeded",</span></strong><br/><strong><span class="koboSpan" id="kobo.108.1">    "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.109.1">    "sourceAddressPrefix": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.110.1">    "sourceAddressPrefixes": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.111.1">    "sourceApplicationSecurityGroups": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.112.1">    "sourcePortRange": "*",</span></strong><br/><strong><span class="koboSpan" id="kobo.113.1">    "sourcePortRanges": [],</span></strong><br/><strong><span class="koboSpan" id="kobo.114.1">    "type": "Microsoft.Network/networkSecurityGroups/securityRules"</span></strong><br/><strong><span class="koboSpan" id="kobo.115.1">  }</span></strong><br/><strong><span class="koboSpan" id="kobo.116.1">]</span></strong></pre>
<p><span class="koboSpan" id="kobo.117.1">There is a </span><kbd><span class="koboSpan" id="kobo.118.1">default-allow-ssh</span></kbd><span class="koboSpan" id="kobo.119.1"> rule with the ID </span><kbd><span class="koboSpan" id="kobo.120.1">/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/networkSecurityGroups/newVMNSG/securityRules/default-allow-ssh</span></kbd><span class="koboSpan" id="kobo.121.1"> attached to the NSG. </span><span class="koboSpan" id="kobo.121.2">Let's delete it:</span></p>
<pre><strong><span class="koboSpan" id="kobo.122.1"># az network nsg rule delete --ids "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/networkSecurityGroups/newVMNSG/securityRules/default-allow-ssh"</span></strong></pre>
<p><span class="koboSpan" id="kobo.123.1">As soon as we delete the rule, we can no longer access the VM via SSH:</span></p>
<pre><strong><span class="koboSpan" id="kobo.124.1"># ssh centos-user@40.77.97.79</span></strong><br/><strong><span class="koboSpan" id="kobo.125.1">...</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Storage account</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">A storage account is a home for the storage objects provided by Azure storage solutions, such as files, tables, and disks. </span><span class="koboSpan" id="kobo.2.2">Users can create one or multiple storage accounts based on their usage.</span></p>
<p><span class="koboSpan" id="kobo.3.1">There are three types of storage accounts:</span></p>
<ul>
<li><span class="koboSpan" id="kobo.4.1">General-purpose v2 accounts</span></li>
<li><span class="koboSpan" id="kobo.5.1">General-purpose v1 accounts</span></li>
<li><span class="koboSpan" id="kobo.6.1">Blob storage accounts</span></li>
</ul>
<p><span class="koboSpan" id="kobo.7.1">v1 is the legacy type of storage account and blob storage accounts only allow us to use blob storage. </span><span class="koboSpan" id="kobo.7.2">v2 accounts are the most recommended account type in Azure right now. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Load balancers</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">The functionality of load balancers in Azure is similar to other public cloud offerings, which are used to route traffic to the backend. </span><span class="koboSpan" id="kobo.2.2">They also provide a health check to the endpoint and </span><span><span class="koboSpan" id="kobo.3.1">drain the</span></span><span><span class="koboSpan" id="kobo.4.1"> </span></span><span><span class="koboSpan" id="kobo.5.1">connection if they find any unhealthy backends. </span><span class="koboSpan" id="kobo.5.2">The main difference between Azure load balancers to other load balancers is that Azure load balancers can have multiple IP addresses and multiple ports. </span><span class="koboSpan" id="kobo.5.3">This means that AKS doesn't need to create a new load balancer when a new LoadBalancer Service is created. </span><span class="koboSpan" id="kobo.5.4">Instead, it creates a new frontend IP inside the load balancer.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Azure disks</span></h1>
                </header>
            
            <article>
                
<p class="mce-root"><span class="koboSpan" id="kobo.2.1">There are two types of Azure disks: managed disks and unmanaged disks. Before Azure managed disks, users had to create storage accounts to use unmanaged disks. </span><span class="koboSpan" id="kobo.2.2">A storage account might exceed the scalability target (</span><a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-scalability-targets"><span class="koboSpan" id="kobo.3.1">https://docs.microsoft.com/en-us/azure/storage/common/storage-scalability-targets</span></a><span class="koboSpan" id="kobo.4.1">) and impact the performance of I/O. </span><span class="koboSpan" id="kobo.4.2">With managed disks, we don't need to create storage accounts by ourselves; Azure manages the accounts behind the scene. </span><span class="koboSpan" id="kobo.4.3">There are different types of performance tiers: </span><span><span class="koboSpan" id="kobo.5.1">standard HDD disks, standard SSD disks, and Premium SSD disks. </span><span class="koboSpan" id="kobo.5.2">HDD disks (</span><a href="https://en.wikipedia.org/wiki/Hard_disk_drive"><span class="koboSpan" id="kobo.6.1">https://en.wikipedia.org/wiki/Hard_disk_drive</span></a><span class="koboSpan" id="kobo.7.1">) are a cost-effective option, while SSDs (</span><a href="https://en.wikipedia.org/wiki/Solid-state_drive"><span class="koboSpan" id="kobo.8.1">https://en.wikipedia.org/wiki/Solid-state_drive</span></a><span class="koboSpan" id="kobo.9.1">) have better performance. </span><span class="koboSpan" id="kobo.9.2">For an I/O-intensive workload, the Premium tier is the best option. </span><span class="koboSpan" id="kobo.9.3">With premium SSD disks attaching to the VM, the VM can reach up to 80,000 IOPS and 2,000 MB/s for disk throughput. </span></span><span><span class="koboSpan" id="kobo.10.1">Azure disks also offer four types of replication:</span></span></p>
<ul>
<li><strong><span class="koboSpan" id="kobo.11.1">Locally-Redundant Storage (LRS)</span></strong><span class="koboSpan" id="kobo.12.1">: Data is only persisted in one single zone</span></li>
<li><strong><span class="koboSpan" id="kobo.13.1">Zone-Redundant Storage (ZRS)</span></strong><span class="koboSpan" id="kobo.14.1">: Data is persisted across three zones</span></li>
<li><strong><span class="koboSpan" id="kobo.15.1">Geo-Redundant Storage (GRS)</span></strong><span class="koboSpan" id="kobo.16.1">: Cross-regional replication</span></li>
<li><strong><span class="koboSpan" id="kobo.17.1">Read-Access Geo-Redundant Storage (RA-GRS)</span></strong><span class="koboSpan" id="kobo.18.1">: Cross-regional replication with read replica</span></li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Azure Kubernetes service</span></h1>
                </header>
            
            <article>
                
<p class="CDPAlignLeft CDPAlign"><span><span class="koboSpan" id="kobo.2.1">Azure Kubernetes service is a hosted Kubernetes service in Azure. </span><span class="koboSpan" id="kobo.2.2">A cluster contains a set of nodes (such as Azure VMs). </span><span class="koboSpan" id="kobo.2.3">Just like a normal Kubernetes node, kube-proxy and kubelet are installed on the node. </span><span class="koboSpan" id="kobo.2.4">kube-proxy, which communicates with the Azure virtual NIC, manages the route in and out for services and pods. </span><span class="koboSpan" id="kobo.2.5">kubelet receives the request from the master, schedules the pods, and reports the metrics. </span><span class="koboSpan" id="kobo.2.6">In Azure, we could mount various Azure storage options such as Azure disk and Azure files as the </span><strong><span class="koboSpan" id="kobo.3.1">Persistent Volume</span></strong><span class="koboSpan" id="kobo.4.1"> (</span><strong><span class="koboSpan" id="kobo.5.1">PV</span></strong><span class="koboSpan" id="kobo.6.1">) for persisting the data for containers. </span><span class="koboSpan" id="kobo.6.2">An illustration of this is shown here:</span></span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.7.1"><img src="assets/27c939a1-a801-42c4-8239-1a2f2d8fc04f.png" style="width:39.42em;height:18.92em;"/></span></p>
<div class="packt_infobox"><span><span class="packt_screen"><span class="koboSpan" id="kobo.8.1">Want to build a cluster from scratch? </span></span><br/><span class="koboSpan" id="kobo.9.1">
If you would prefer to build a cluster on your own, be sure to check out the AKS-engine project (</span></span><a href="https://github.com/Azure/aks-engine"><span class="koboSpan" id="kobo.10.1">https://github.com/Azure/aks-engine</span></a><span><span class="koboSpan" id="kobo.11.1">), which builds Kubernetes infrastructure in Azure using the </span></span><span><span class="koboSpan" id="kobo.12.1">Azure resource manager. </span></span></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Setting up your first Kubernetes cluster on AKS</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">An AKS cluster can be launched in its own VPC (basic networking configuration) or in an existing VPC (advanced networking configuration); both can be launched via Azure CLI. </span><span class="koboSpan" id="kobo.2.2">There are a set of arguments that we can specify during cluster creation, which include the following:</span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td><strong><span class="koboSpan" id="kobo.3.1">Arguments</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.4.1">Description</span></strong></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.5.1">--name</span></kbd></td>
<td><span class="koboSpan" id="kobo.6.1">The cluster name.</span></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.7.1">--enable-addons</span></kbd></td>
<td><span class="koboSpan" id="kobo.8.1">Enables the Kubernetes addons module in a comma-separated list.</span></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.9.1">--generate-ssh-keys</span></kbd></td>
<td><span class="koboSpan" id="kobo.10.1">Generates SSH key files if they do not already exist.</span></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.11.1">--node-count</span></kbd></td>
<td><span class="koboSpan" id="kobo.12.1">The number of nodes. </span><span class="koboSpan" id="kobo.12.2">The default value is three.</span></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.13.1">--network-policy</span></kbd></td>
<td><span class="koboSpan" id="kobo.14.1">(Preview) Enables or disables the network policy. </span><span class="koboSpan" id="kobo.14.2">The default is that it is disabled.</span></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.15.1">--vnet-subnet-id</span></kbd></td>
<td><span class="koboSpan" id="kobo.16.1">The subnet ID in a VNet to deploy the cluster.</span></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.17.1">--node-vm-size</span></kbd></td>
<td><span class="koboSpan" id="kobo.18.1">The size of the VMs. </span><span class="koboSpan" id="kobo.18.2">The default is </span><kbd><span class="koboSpan" id="kobo.19.1">Standard_DS2_v2</span></kbd><span class="koboSpan" id="kobo.20.1">.</span></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.21.1">--service-cidr</span></kbd></td>
<td><span><span class="koboSpan" id="kobo.22.1">A CIDR notation IP range from which to assign service cluster IPs.</span></span></td>
</tr>
<tr>
<td><kbd><span class="koboSpan" id="kobo.23.1">--max-pods</span></kbd></td>
<td><span class="koboSpan" id="kobo.24.1">The default is </span><kbd><span class="koboSpan" id="kobo.25.1">110</span></kbd><span class="koboSpan" id="kobo.26.1"> or </span><kbd><span class="koboSpan" id="kobo.27.1">30</span></kbd><span class="koboSpan" id="kobo.28.1"> for an advanced network configuration (using an existing VNet).</span></td>
</tr>
</tbody>
</table>
<p><span class="koboSpan" id="kobo.29.1">In the following example, we'll first create a cluster with two nodes and enable </span><kbd><span class="koboSpan" id="kobo.30.1">addons</span></kbd><span class="koboSpan" id="kobo.31.1"> for monitoring to enable Azure monitor for the cluster, and </span><kbd><span class="koboSpan" id="kobo.32.1">http_application_routing</span></kbd><span class="koboSpan" id="kobo.33.1"> to enable HTTP application routing for ingress:</span></p>
<pre><strong><span class="koboSpan" id="kobo.34.1">// create an AKS cluster with two nodes</span></strong><br/><strong><span class="koboSpan" id="kobo.35.1"># az aks create --resource-group devops --name myAKS --node-count 2 --enable-addons monitoring,http_application_routing --generate-ssh-keys</span></strong><br/><strong><span class="koboSpan" id="kobo.36.1">Running...</span></strong><br/><strong><span class="koboSpan" id="kobo.37.1"># az aks list --resource-group devops</span></strong><br/><strong><span class="koboSpan" id="kobo.38.1">[</span></strong><br/><strong> <span class="sBrace structure-1"><span class="koboSpan" id="kobo.39.1">{</span><span> </span><span> </span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.40.1">"aadProfile"</span></span><span class="sColon"><span class="koboSpan" id="kobo.41.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.42.1">null</span></span><span class="sComma"><span class="koboSpan" id="kobo.43.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.44.1">"addonProfiles"</span></span><span class="sColon"><span class="koboSpan" id="kobo.45.1">:</span></span><span class="sBrace structure-2"><span class="koboSpan" id="kobo.46.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.47.1">"httpApplicationRouting"</span></span><span class="sColon"><span class="koboSpan" id="kobo.48.1">:</span></span><span class="sBrace structure-3"><span class="koboSpan" id="kobo.49.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.50.1">"config"</span></span><span class="sColon"><span class="koboSpan" id="kobo.51.1">:</span></span><span class="sBrace structure-4"><span class="koboSpan" id="kobo.52.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.53.1">"HTTPApplicationRoutingZoneName"</span></span><span class="sColon"><span class="koboSpan" id="kobo.54.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.55.1">"cef42743fd964970b357.centralus.aksapp.io"</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sBrace structure-4"><span class="koboSpan" id="kobo.56.1">}</span></span><span class="sComma"><span class="koboSpan" id="kobo.57.1">,</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.58.1">"enabled"</span></span><span class="sColon"><span class="koboSpan" id="kobo.59.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.60.1">true</span></span><br/><span>  </span><span>  </span><span class="sBrace structure-3"><span class="koboSpan" id="kobo.61.1">}</span></span><span class="sComma"><span class="koboSpan" id="kobo.62.1">,</span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.63.1">"omsagent"</span></span><span class="sColon"><span class="koboSpan" id="kobo.64.1">:</span></span><span class="sBrace structure-3"><span class="koboSpan" id="kobo.65.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.66.1">"config"</span></span><span class="sColon"><span class="koboSpan" id="kobo.67.1">:</span></span><span class="sBrace structure-4"><span class="koboSpan" id="kobo.68.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.69.1">"logAnalyticsWorkspaceResourceID"</span></span><span class="sColon"><span class="koboSpan" id="kobo.70.1">:</span></span><span class="sObjectV"><span class="error"><span class="koboSpan" id="kobo.71.1">...</span></span></span><br/><span>  </span><span>  </span><span>  </span><span class="sBrace structure-4"><span class="koboSpan" id="kobo.72.1">}</span></span><span class="sComma"><span class="koboSpan" id="kobo.73.1">,</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.74.1">"enabled"</span></span><span class="sColon"><span class="koboSpan" id="kobo.75.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.76.1">true</span></span><br/><span>  </span><span>  </span><span class="sBrace structure-3"><span class="koboSpan" id="kobo.77.1">}</span></span><br/><span>  </span><span class="sBrace structure-2"><span class="koboSpan" id="kobo.78.1">}</span></span><span class="sComma"><span class="koboSpan" id="kobo.79.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.80.1">"agentPoolProfiles"</span></span><span class="sColon"><span class="koboSpan" id="kobo.81.1">:</span></span><span class="sBracket structure-2"><span class="koboSpan" id="kobo.82.1">[</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span class="sBrace structure-3"><span class="koboSpan" id="kobo.83.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.84.1">"count"</span></span><span class="sColon"><span class="koboSpan" id="kobo.85.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.86.1">2</span></span><span class="sComma"><span class="koboSpan" id="kobo.87.1">,</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.88.1">"maxPods"</span></span><span class="sColon"><span class="koboSpan" id="kobo.89.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.90.1">110</span></span><span class="sComma"><span class="koboSpan" id="kobo.91.1">,</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.92.1">"name"</span></span><span class="sColon"><span class="koboSpan" id="kobo.93.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.94.1">"nodepool1"</span></span><span class="sComma"><span class="koboSpan" id="kobo.95.1">,</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.96.1">"osDiskSizeGb"</span></span><span class="sColon"><span class="koboSpan" id="kobo.97.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.98.1">30</span></span><span class="sComma"><span class="koboSpan" id="kobo.99.1">,</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.100.1">"osType"</span></span><span class="sColon"><span class="koboSpan" id="kobo.101.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.102.1">"Linux"</span></span><span class="sComma"><span class="koboSpan" id="kobo.103.1">,</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.104.1">"storageProfile"</span></span><span class="sColon"><span class="koboSpan" id="kobo.105.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.106.1">"ManagedDisks"</span></span><span class="sComma"><span class="koboSpan" id="kobo.107.1">,</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.108.1">"vmSize"</span></span><span class="sColon"><span class="koboSpan" id="kobo.109.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.110.1">"Standard_DS2_v2"</span></span><br/><span>  </span><span>  </span><span class="sBrace structure-3"><span class="koboSpan" id="kobo.111.1">}</span></span><br/><span>  </span><span class="sBracket structure-2"><span class="koboSpan" id="kobo.112.1">]</span></span><span class="sComma"><span class="koboSpan" id="kobo.113.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.114.1">"dnsPrefix"</span></span><span class="sColon"><span class="koboSpan" id="kobo.115.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.116.1">"myAKS-devops-f82579"</span></span><span class="sComma"><span class="koboSpan" id="kobo.117.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.118.1">"enableRbac"</span></span><span class="sColon"><span class="koboSpan" id="kobo.119.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.120.1">true</span></span><span class="sComma"><span class="koboSpan" id="kobo.121.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.122.1">"fqdn"</span></span><span class="sColon"><span class="koboSpan" id="kobo.123.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.124.1">"myaks-devops-f82579-077667ba.hcp.centralus.azmk8s.io"</span></span><span class="sComma"><span class="koboSpan" id="kobo.125.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.126.1">"id"</span></span><span class="sColon"><span class="koboSpan" id="kobo.127.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.128.1">"/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourcegroups/devops/providers/Microsoft.ContainerService/managedClusters/myAKS"</span></span><span class="sComma"><span class="koboSpan" id="kobo.129.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.130.1">"kubernetesVersion"</span></span><span class="sColon"><span class="koboSpan" id="kobo.131.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.132.1">"1.9.11"</span></span><span class="sComma"><span class="koboSpan" id="kobo.133.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.134.1">"linuxProfile"</span></span><span class="sColon"><span class="koboSpan" id="kobo.135.1">:</span></span><span class="sBrace structure-2"><span class="koboSpan" id="kobo.136.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.137.1">"adminUsername"</span></span><span class="sColon"><span class="koboSpan" id="kobo.138.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.139.1">"azureuser"</span></span><span class="sComma"><span class="koboSpan" id="kobo.140.1">,</span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.141.1">"ssh"</span></span><span class="sColon"><span class="koboSpan" id="kobo.142.1">:</span></span><span class="sBrace structure-3"><span class="koboSpan" id="kobo.143.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.144.1">"publicKeys"</span></span><span class="sColon"><span class="koboSpan" id="kobo.145.1">:</span></span><span class="sBracket structure-4"><span class="koboSpan" id="kobo.146.1">[</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span>  </span><span>  </span><span class="sBrace structure-5"><span class="koboSpan" id="kobo.147.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span>  </span><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.148.1">"keyData"</span></span><span class="sColon"><span class="koboSpan" id="kobo.149.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.150.1">"ssh-rsa xxx"</span></span><br/><span>  </span><span>  </span><span>  </span><span>  </span><span class="sBrace structure-5"><span class="koboSpan" id="kobo.151.1">}</span></span><br/><span>  </span><span>  </span><span>  </span><span class="sBracket structure-4"><span class="koboSpan" id="kobo.152.1">]</span></span><br/><span>  </span><span>  </span><span class="sBrace structure-3"><span class="koboSpan" id="kobo.153.1">}</span></span><br/><span>  </span><span class="sBrace structure-2"><span class="koboSpan" id="kobo.154.1">}</span></span><span class="sComma"><span class="koboSpan" id="kobo.155.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.156.1">"location"</span></span><span class="sColon"><span class="koboSpan" id="kobo.157.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.158.1">"centralus"</span></span><span class="sComma"><span class="koboSpan" id="kobo.159.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.160.1">"name"</span></span><span class="sColon"><span class="koboSpan" id="kobo.161.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.162.1">"myAKS"</span></span><span class="sComma"><span class="koboSpan" id="kobo.163.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.164.1">"networkProfile"</span></span><span class="sColon"><span class="koboSpan" id="kobo.165.1">:</span></span><span class="sBrace structure-2"><span class="koboSpan" id="kobo.166.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.167.1">"dnsServiceIp"</span></span><span class="sColon"><span class="koboSpan" id="kobo.168.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.169.1">"10.0.0.10"</span></span><span class="sComma"><span class="koboSpan" id="kobo.170.1">,</span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.171.1">"dockerBridgeCidr"</span></span><span class="sColon"><span class="koboSpan" id="kobo.172.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.173.1">"172.17.0.1/16"</span></span><span class="sComma"><span class="koboSpan" id="kobo.174.1">,</span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.175.1">"networkPlugin"</span></span><span class="sColon"><span class="koboSpan" id="kobo.176.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.177.1">"kubenet"</span></span><span class="sComma"><span class="koboSpan" id="kobo.178.1">,</span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.179.1">"networkPolicy"</span></span><span class="sColon"><span class="koboSpan" id="kobo.180.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.181.1">null</span></span><span class="sComma"><span class="koboSpan" id="kobo.182.1">,</span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.183.1">"podCidr"</span></span><span class="sColon"><span class="koboSpan" id="kobo.184.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.185.1">"10.244.0.0/16"</span></span><span class="sComma"><span class="koboSpan" id="kobo.186.1">,</span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.187.1">"serviceCidr"</span></span><span class="sColon"><span class="koboSpan" id="kobo.188.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.189.1">"10.0.0.0/16"</span></span><br/><span>  </span><span class="sBrace structure-2"><span class="koboSpan" id="kobo.190.1">}</span></span><span class="sComma"><span class="koboSpan" id="kobo.191.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.192.1">"nodeResourceGroup"</span></span><span class="sColon"><span class="koboSpan" id="kobo.193.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.194.1">"MC_devops_myAKS_centralus"</span></span><span class="sComma"><span class="koboSpan" id="kobo.195.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.196.1">"provisioningState"</span></span><span class="sColon"><span class="koboSpan" id="kobo.197.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.198.1">"Succeeded"</span></span><span class="sComma"><span class="koboSpan" id="kobo.199.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.200.1">"resourceGroup"</span></span><span class="sColon"><span class="koboSpan" id="kobo.201.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.202.1">"devops"</span></span><span class="sComma"><span class="koboSpan" id="kobo.203.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.204.1">"servicePrincipalProfile"</span></span><span class="sColon"><span class="koboSpan" id="kobo.205.1">:</span></span><span class="sBrace structure-2"><span class="koboSpan" id="kobo.206.1">{</span><span> </span><span> </span></span><br/><span>  </span><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.207.1">"clientId"</span></span><span class="sColon"><span class="koboSpan" id="kobo.208.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.209.1">"db016e5d-b3e5-4e22-a844-1dad5d16fec1"</span></span><br/><span>  </span><span class="sBrace structure-2"><span class="koboSpan" id="kobo.210.1">}</span></span><span class="sComma"><span class="koboSpan" id="kobo.211.1">,</span></span><br/><span>  </span><span class="sObjectK"><span class="koboSpan" id="kobo.212.1">"type"</span></span><span class="sColon"><span class="koboSpan" id="kobo.213.1">:</span></span><span class="sObjectV"><span class="koboSpan" id="kobo.214.1">"Microsoft.ContainerService/ManagedClusters"</span></span><br/><span class="sBrace structure-1"><span class="koboSpan" id="kobo.215.1">}</span></span></strong><br/><strong><span class="koboSpan" id="kobo.216.1">]</span></strong></pre>
<p><span class="koboSpan" id="kobo.217.1">After the cluster is launched, we can use the get-credentials subcommand to configure our </span><kbd><span class="koboSpan" id="kobo.218.1">kubeconfig</span></kbd><span class="koboSpan" id="kobo.219.1">. </span><span class="koboSpan" id="kobo.219.2">The context name will be the cluster name, which in this case is </span><kbd><span class="koboSpan" id="kobo.220.1">myAKS</span></kbd><span class="koboSpan" id="kobo.221.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.222.1">// configure local kubeconfig to access the cluster</span></strong><br/><strong><span class="koboSpan" id="kobo.223.1"># az aks get-credentials --resource-group devops --name myAKS</span></strong><br/><strong><span class="koboSpan" id="kobo.224.1">Merged "myAKS" as current context in /home/chloe/.kube/config</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.225.1">// check current context</span></strong><br/><strong><span class="koboSpan" id="kobo.226.1"># kubectl config current-context</span></strong><br/><strong><span class="koboSpan" id="kobo.227.1">myAKS</span></strong></pre>
<p><span class="koboSpan" id="kobo.228.1">Let's see whether the nodes have joined the cluster. </span><span class="koboSpan" id="kobo.228.2">Make sure that all of the nodes are in the </span><kbd><span class="koboSpan" id="kobo.229.1">Ready</span></kbd><span class="koboSpan" id="kobo.230.1"> state:</span></p>
<pre><strong><span class="koboSpan" id="kobo.231.1"># kubectl get nodes</span></strong><br/><strong><span class="koboSpan" id="kobo.232.1">NAME STATUS ROLES AGE VERSION</span></strong><br/><strong><span class="koboSpan" id="kobo.233.1">aks-nodepool1-37748545-0 Ready agent 12m v1.9.11</span></strong><br/><strong><span class="koboSpan" id="kobo.234.1">aks-nodepool1-37748545-1 Ready agent 12m v1.9.11</span></strong></pre>
<p><span class="koboSpan" id="kobo.235.1">Let's try to deploy a </span><kbd><span class="koboSpan" id="kobo.236.1">ReplicaSet</span></kbd><span class="koboSpan" id="kobo.237.1"> via the example we used in </span><kbd><span class="koboSpan" id="kobo.238.1">Chapter3</span></kbd><span class="koboSpan" id="kobo.239.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.240.1"># kubectl create -f chapter3/3-2-3_Service/3-2-3_rs1.yaml</span></strong><br/><strong><span class="koboSpan" id="kobo.241.1">replicaset.apps/nginx-1.12 created</span></strong></pre>
<p><span class="koboSpan" id="kobo.242.1">Create a service to access the </span><kbd><span class="koboSpan" id="kobo.243.1">ReplicaSet</span></kbd><span class="koboSpan" id="kobo.244.1">. </span><span class="koboSpan" id="kobo.244.2">We will use the </span><kbd><span class="koboSpan" id="kobo.245.1">chapter3/3-2-3_Service/3-2-3_service.yaml</span></kbd><span class="koboSpan" id="kobo.246.1"> file and add the </span><kbd><span class="koboSpan" id="kobo.247.1">type: LoadBalancer</span></kbd><span class="koboSpan" id="kobo.248.1"> line in the </span><kbd><span class="koboSpan" id="kobo.249.1">spec</span></kbd><span class="koboSpan" id="kobo.250.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.251.1">kind: Service</span></strong><br/><strong><span class="koboSpan" id="kobo.252.1">apiVersion: v1</span></strong><br/><strong><span class="koboSpan" id="kobo.253.1">metadata:</span></strong><br/><strong><span class="koboSpan" id="kobo.254.1">  name: nginx-service</span></strong><br/><strong><span class="koboSpan" id="kobo.255.1">spec:</span></strong><br/><strong><span class="koboSpan" id="kobo.256.1">  selector:</span></strong><br/><strong><span class="koboSpan" id="kobo.257.1">    project: chapter3</span></strong><br/><strong><span class="koboSpan" id="kobo.258.1">    service: web</span></strong><br/><strong><span class="koboSpan" id="kobo.259.1">  type: LoadBalancer</span></strong><br/><strong><span class="koboSpan" id="kobo.260.1">  ports:</span></strong><br/><strong><span class="koboSpan" id="kobo.261.1">    - protocol: TCP</span></strong><br/><strong><span class="koboSpan" id="kobo.262.1">      port: 80</span></strong><br/><strong><span class="koboSpan" id="kobo.263.1">      targetPort: 80</span></strong><br/><strong><span class="koboSpan" id="kobo.264.1">      name: http</span></strong></pre>
<p><span class="koboSpan" id="kobo.265.1">We can then watch the service </span><span><span class="koboSpan" id="kobo.266.1">until the </span><kbd><span class="koboSpan" id="kobo.267.1">EXTERNAL-IP</span></kbd><span class="koboSpan" id="kobo.268.1"> changes to an external IP address.</span></span><span class="koboSpan" id="kobo.269.1"> Here, we get </span><kbd><span class="koboSpan" id="kobo.270.1">40.122.78.184</span></kbd><span class="koboSpan" id="kobo.271.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.272.1">// watch the external ip from &lt;pending&gt; to IP</span></strong><br/><strong><span class="koboSpan" id="kobo.273.1"># kubectl get svc --watch</span></strong><br/><strong><span class="koboSpan" id="kobo.274.1">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE</span></strong><br/><strong><span class="koboSpan" id="kobo.275.1">kubernetes ClusterIP 10.0.0.1 &lt;none&gt; 443/TCP 6h</span></strong><br/><strong><span class="koboSpan" id="kobo.276.1">nginx-service LoadBalancer 10.0.139.13 40.122.78.184 80:31011/TCP 1m</span></strong></pre>
<p><span class="koboSpan" id="kobo.277.1">Let's visit the site!</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.278.1"><img src="assets/261dd126-0f77-457d-bae6-f0bfb5885faf.png" style="width:38.50em;height:12.92em;"/></span></p>
<p><span class="koboSpan" id="kobo.279.1">In the preceding example, we have demonstrated how to deploy an nginx service to AKS and use its load balancer. </span><span class="koboSpan" id="kobo.279.2">How about if we already have a set of resources in an existing VNet, and we want to launch an AKS cluster inside the VNet to communicate with existing resources? </span><span class="koboSpan" id="kobo.279.3">Then, we need to use advanced networking in AKS. </span><span class="koboSpan" id="kobo.279.4">The fundamental difference between basic and advanced networking is that basic networking uses kubenet (</span><a href="https://github.com/vplauzon/aks/tree/master/aks-kubenet"><span class="koboSpan" id="kobo.280.1">https://github.com/vplauzon/aks/tree/master/aks-kubenet</span></a><span class="koboSpan" id="kobo.281.1">) as a network plugin, while advanced networking uses the Azure CNI plugin (</span><a href="https://github.com/Azure/azure-container-networking/tree/master/cni"><span class="koboSpan" id="kobo.282.1">https://github.com/Azure/azure-container-networking/tree/master/cni</span></a><span class="koboSpan" id="kobo.283.1">). Compared to basic networking, advanced networking has more limitations. </span><span class="koboSpan" id="kobo.283.2">For example, the default maximum number of pods on a node is 30, instead of 110. </span><span class="koboSpan" id="kobo.283.3">This is because only 30 additional IP addresses are configured by Azure CNI for the NIC on a node. </span><span class="koboSpan" id="kobo.283.4">The pod IPs are the secondary IPs on the NICs, so the private IPs are assigned the pods that are accessible inside the virtual network. </span><span class="koboSpan" id="kobo.283.5">When using kubenet, the cluster IPs are assigned to the pods, which don't belong to the virtual network but are instead managed by AKS. </span><span class="koboSpan" id="kobo.283.6">The cluster IPs won't be accessible outside of the cluster. </span><span class="koboSpan" id="kobo.283.7">Unless you have special requirements, such as if you want to gain access to the pods from outside the cluster or you want connectivity between existing resources and the cluster, the b</span><span><span class="koboSpan" id="kobo.284.1">asic networking configuration should be able to fulfill most scenarios. </span></span></p>
<p><span class="koboSpan" id="kobo.285.1">Let's see how we can create an AKS cluster with advanced networking. </span><span class="koboSpan" id="kobo.285.2">We need to specify the existing subnet for the cluster. </span><span class="koboSpan" id="kobo.285.3">First, let's list the subnet IDs in the VNet </span><kbd><span class="koboSpan" id="kobo.286.1">devops-vnet</span></kbd><span><span class="koboSpan" id="kobo.287.1"> file that</span></span><span class="koboSpan" id="kobo.288.1"> we created earlier:</span></p>
<pre><strong><span class="koboSpan" id="kobo.289.1"># az network vnet subnet list --vnet-name devops-vnet --resource-group devops | jq .[].id</span></strong><br/><strong><span class="koboSpan" id="kobo.290.1">"/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/virtualNetworks/devops-vnet/subnets/default"</span></strong><br/><strong><span class="koboSpan" id="kobo.291.1">"/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/virtualNetworks/devops-vnet/subnets/test"</span></strong></pre>
<p><span class="koboSpan" id="kobo.292.1">Let's use the default subnet. </span><span class="koboSpan" id="kobo.292.2">Note that one subnet should only locate one AKS cluster in advanced networking. </span><span class="koboSpan" id="kobo.292.3">Also, the service CIDR we specified, which is used to assign cluster IPs, cannot overlap the subnet CIDR in which the cluster is located:</span></p>
<pre><strong><span class="koboSpan" id="kobo.293.1"># az aks create --resource-group devops --name myAdvAKS --network-plugin azure --vnet-subnet-id /subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourceGroups/devops/providers/Microsoft.Network/virtualNetworks/devops-vnet/subnets/default --service-cidr 10.2.0.0/24 --node-count 1 --enable-addons monitoring,http_application_routing --generate-ssh-keys</span></strong><br/><strong><span class="koboSpan" id="kobo.294.1"> - Running ..</span></strong><br/><strong><span class="koboSpan" id="kobo.295.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.296.1">  "aadProfile": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.297.1">  "addonProfiles": {</span></strong><br/><strong><span class="koboSpan" id="kobo.298.1">      "httpApplicationRouting": {</span></strong><br/><strong><span class="koboSpan" id="kobo.299.1">        "config": {</span></strong><br/><strong><span class="koboSpan" id="kobo.300.1">          "HTTPApplicationRoutingZoneName": "cef42743fd964970b357.centralus.aksapp.io"</span></strong><br/><strong><span class="koboSpan" id="kobo.301.1">        },</span></strong><br/><strong><span class="koboSpan" id="kobo.302.1">        "enabled": true</span></strong><br/><strong><span class="koboSpan" id="kobo.303.1">      },</span></strong><br/><strong><span class="koboSpan" id="kobo.304.1">      "omsagent": {</span></strong><br/><strong><span class="koboSpan" id="kobo.305.1">        "config": {</span></strong><br/><strong><span class="koboSpan" id="kobo.306.1">          "logAnalyticsWorkspaceResourceID":</span></strong><br/><strong><span class="koboSpan" id="kobo.307.1">        },</span></strong><br/><strong><span class="koboSpan" id="kobo.308.1">        "enabled": true</span></strong><br/><strong><span class="koboSpan" id="kobo.309.1">      }</span></strong><br/><strong><span class="koboSpan" id="kobo.310.1">   },</span></strong><br/><strong><span class="koboSpan" id="kobo.311.1">  "agentPoolProfiles": [</span></strong><br/><strong><span class="koboSpan" id="kobo.312.1">    {</span></strong><br/><strong><span class="koboSpan" id="kobo.313.1">      "count": 1,</span></strong><br/><strong><span class="koboSpan" id="kobo.314.1">      "maxPods": 30,</span></strong><br/><strong><span class="koboSpan" id="kobo.315.1">      "name": "nodepool1",</span></strong><br/><strong><span class="koboSpan" id="kobo.316.1">...</span></strong><br/><strong><span class="koboSpan" id="kobo.317.1">      "vmSize": "Standard_DS2_v2"</span></strong><br/><strong><span class="koboSpan" id="kobo.318.1">    }</span></strong><br/><strong><span class="koboSpan" id="kobo.319.1">  ],</span></strong><br/><strong><span class="koboSpan" id="kobo.320.1">  "dnsPrefix": "myAdvAKS-devops-f82579",</span></strong><br/><strong><span class="koboSpan" id="kobo.321.1">  "enableRbac": true,</span></strong><br/><strong><span class="koboSpan" id="kobo.322.1">  "fqdn": "myadveks-devops-f82579-059d5b24.hcp.centralus.azmk8s.io",</span></strong><br/><strong><span class="koboSpan" id="kobo.323.1">  "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourcegroups/devops/providers/Microsoft.ContainerService/managedClusters/myAdvAKS",</span></strong><br/><strong><span class="koboSpan" id="kobo.324.1">  "kubernetesVersion": "1.9.11",</span></strong><br/><strong><span class="koboSpan" id="kobo.325.1">  "linuxProfile": {</span></strong><br/><strong><span class="koboSpan" id="kobo.326.1">    "adminUsername": "azureuser",</span></strong><br/><strong><span class="koboSpan" id="kobo.327.1">    "ssh": {</span></strong><br/><strong><span class="koboSpan" id="kobo.328.1">      "publicKeys": [</span></strong><br/><strong><span class="koboSpan" id="kobo.329.1">        ...</span></strong><br/><strong><span class="koboSpan" id="kobo.330.1">      ]</span></strong><br/><strong><span class="koboSpan" id="kobo.331.1">    }</span></strong><br/><strong><span class="koboSpan" id="kobo.332.1">  },</span></strong><br/><strong><span class="koboSpan" id="kobo.333.1">  "location": "centralus",</span></strong><br/><strong><span class="koboSpan" id="kobo.334.1">  "name": "myAdvAKS",</span></strong><br/><strong><span class="koboSpan" id="kobo.335.1">  "networkProfile": {</span></strong><br/><strong><span class="koboSpan" id="kobo.336.1">    "dnsServiceIp": "10.0.0.10",</span></strong><br/><strong><span class="koboSpan" id="kobo.337.1">    "dockerBridgeCidr": "172.17.0.1/16",</span></strong><br/><strong><span class="koboSpan" id="kobo.338.1">    "networkPlugin": "azure",</span></strong><br/><strong><span class="koboSpan" id="kobo.339.1">    "networkPolicy": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.340.1">    "podCidr": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.341.1">    "serviceCidr": "10.2.0.0/24"</span></strong><br/><strong><span class="koboSpan" id="kobo.342.1">  },</span></strong><br/><strong><span class="koboSpan" id="kobo.343.1">  "nodeResourceGroup": "MC_devops_myAdvAKS_centralus",</span></strong><br/><strong><span class="koboSpan" id="kobo.344.1">  "provisioningState": "Succeeded",</span></strong><br/><strong><span class="koboSpan" id="kobo.345.1">  "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.346.1">  "servicePrincipalProfile": {</span></strong><br/><strong><span class="koboSpan" id="kobo.347.1">    "clientId": "db016e5d-b3e5-4e22-a844-1dad5d16fec1",</span></strong><br/><strong><span class="koboSpan" id="kobo.348.1">    "secret": null</span></strong><br/><strong><span class="koboSpan" id="kobo.349.1">  },</span></strong><br/><strong><span class="koboSpan" id="kobo.350.1">  "tags": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.351.1">  "type": "Microsoft.ContainerService/ManagedClusters"</span></strong><br/><strong><span class="koboSpan" id="kobo.352.1">}</span></strong></pre>
<p><span class="koboSpan" id="kobo.353.1">Remember to configure </span><kbd><span class="koboSpan" id="kobo.354.1">kubeconfig</span></kbd><span class="koboSpan" id="kobo.355.1">:</span></p>
<pre><strong><span class="koboSpan" id="kobo.356.1"># az aks get-credentials --resource-group devops --name myAdvAKS</span></strong><br/><strong><span class="koboSpan" id="kobo.357.1">Merged "myAdvAKS" as current context in /home/chloe/.kube/config</span></strong></pre>
<p><span><span class="koboSpan" id="kobo.358.1">If we repeat the preceding code for </span><kbd><span class="koboSpan" id="kobo.359.1">chapter3/3-2-3_Service/3-2-3_rs1.yaml</span></kbd><span class="koboSpan" id="kobo.360.1"> and </span><kbd><span class="koboSpan" id="kobo.361.1">chapter3/3-2-3_Service/3-2-3_service.yaml</span></kbd><span class="koboSpan" id="kobo.362.1">, we should be able to achieve the same result.</span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Node pools</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Just like GKE, a node pool is a group of VMs of the same size. </span><span class="koboSpan" id="kobo.2.2">At the time of writing this book, multiple node pool support is on its way. </span><span class="koboSpan" id="kobo.2.3">Follow the discussion at </span><a href="https://github.com/Azure/AKS/issues/759"><span class="koboSpan" id="kobo.3.1">https://github.com/Azure/AKS/issues/759</span></a><span class="koboSpan" id="kobo.4.1">, or watch for the official announcement. </span></p>
<div class="packt_infobox"><span class="koboSpan" id="kobo.5.1">Azure offers virtual machine scale sets as its autoscaling group solution. </span><span class="koboSpan" id="kobo.5.2">In Kubernetes 1.12, VMSS support became generally available. </span><span class="koboSpan" id="kobo.5.3">With VMSS, the VMs can be scaled out by VM metrics. </span><span class="koboSpan" id="kobo.5.4">For more information, check out the official documentation: </span><a href="https://kubernetes.io/blog/2018/10/08/support-for-azure-vmss-cluster-autoscaler-and-user-assigned-identity/"><span class="koboSpan" id="kobo.6.1">https://kubernetes.io/blog/2018/10/08/support-for-azure-vmss-cluster-autoscaler-and-user-assigned-identity/</span></a><a href="https://kubernetes.io/blog/2018/10/08/support-for-azure-vmss-cluster-autoscaler-and-user-assigned-identity/"><span class="koboSpan" id="kobo.7.1">.</span></a><a href="https://kubernetes.io/blog/2018/10/08/support-for-azure-vmss--cluster-autoscaler-and-user-assigned-identity/"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Cluster upgrade</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Before you upgrade the cluster, make sure your subscription has enough resources, since nodes will be replaced by rolling deployments. </span><span class="koboSpan" id="kobo.2.2">The additional node will be added to the cluster. </span><span class="koboSpan" id="kobo.2.3">To check the quota limit, use the </span><kbd><span class="koboSpan" id="kobo.3.1">az vm list-usage --location $location</span></kbd><span class="koboSpan" id="kobo.4.1"> command.</span></p>
<p><span class="koboSpan" id="kobo.5.1">Let's see which Kubernetes version we're using:</span></p>
<pre><strong><span class="koboSpan" id="kobo.6.1"># az aks show --resource-group devops --name myAKS | jq .kubernetesVersion</span></strong><br/><strong><span class="koboSpan" id="kobo.7.1">"1.9.11"</span></strong></pre>
<p><span class="koboSpan" id="kobo.8.1">The Azure CLI provides the </span><kbd><span class="koboSpan" id="kobo.9.1">get-upgrades</span></kbd><span class="koboSpan" id="kobo.10.1"> subcommand to check which version the cluster can upgrade to:</span></p>
<pre><strong><span class="koboSpan" id="kobo.11.1"># az aks get-upgrades --name myAKS --resource-group devops</span></strong><br/><strong><span class="koboSpan" id="kobo.12.1">{</span></strong><br/><strong><span class="koboSpan" id="kobo.13.1">  "agentPoolProfiles": [</span></strong><br/><strong><span class="koboSpan" id="kobo.14.1">    {</span></strong><br/><strong><span class="koboSpan" id="kobo.15.1">      "kubernetesVersion": "1.9.11",</span></strong><br/><strong><span class="koboSpan" id="kobo.16.1">      "name": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.17.1">      "osType": "Linux",</span></strong><br/><strong><span class="koboSpan" id="kobo.18.1">      "upgrades": [</span></strong><br/><strong><span class="koboSpan" id="kobo.19.1">        "1.10.8",</span></strong><br/><strong><span class="koboSpan" id="kobo.20.1">        "1.10.9"</span></strong><br/><strong><span class="koboSpan" id="kobo.21.1">      ]</span></strong><br/><strong><span class="koboSpan" id="kobo.22.1">    }</span></strong><br/><strong><span class="koboSpan" id="kobo.23.1">  ],</span></strong><br/><strong><span class="koboSpan" id="kobo.24.1">  "controlPlaneProfile": {</span></strong><br/><strong><span class="koboSpan" id="kobo.25.1">    "kubernetesVersion": "1.9.11",</span></strong><br/><strong><span class="koboSpan" id="kobo.26.1">    "name": null,</span></strong><br/><strong><span class="koboSpan" id="kobo.27.1">    "osType": "Linux",</span></strong><br/><strong><span class="koboSpan" id="kobo.28.1">    "upgrades": [</span></strong><br/><strong><span class="koboSpan" id="kobo.29.1">      "1.10.8",</span></strong><br/><strong><span class="koboSpan" id="kobo.30.1">      "1.10.9"</span></strong><br/><strong><span class="koboSpan" id="kobo.31.1">    ]</span></strong><br/><strong><span class="koboSpan" id="kobo.32.1">  },</span></strong><br/><strong><span class="koboSpan" id="kobo.33.1">  "id": "/subscriptions/f825790b-ac24-47a3-89b8-9b4b3974f0d5/resourcegroups/devops/providers/Microsoft.ContainerService/managedClusters/myAKS/upgradeprofiles/default",</span></strong><br/><strong><span class="koboSpan" id="kobo.34.1">  "name": "default",</span></strong><br/><strong><span class="koboSpan" id="kobo.35.1">  "resourceGroup": "devops",</span></strong><br/><strong><span class="koboSpan" id="kobo.36.1">  "type": "Microsoft.ContainerService/managedClusters/upgradeprofiles"</span></strong><br/><strong><span class="koboSpan" id="kobo.37.1">}</span></strong></pre>
<p><span class="koboSpan" id="kobo.38.1">This shows that we can upgrade to versions 1.10.8 and 1.10.9. </span><span class="koboSpan" id="kobo.38.2">In Azure, minor versions cannot be skipped, meaning we can't upgrade from 1.9.11 to 1.11.x. </span><span class="koboSpan" id="kobo.38.3">We have to upgrade the cluster to 1.10 first, and then upgrade to 1.11. </span><span class="koboSpan" id="kobo.38.4">Upgrading from AKS is extremely easy, just like from GKE. </span><span class="koboSpan" id="kobo.38.5">Let's say that we want to upgrade to 1.10.9:</span></p>
<pre><strong><span class="koboSpan" id="kobo.39.1"># az aks upgrade --name myAKS --resource-group devops --kubernetes-version 1.10.9</span></strong></pre>
<p><span class="koboSpan" id="kobo.40.1">After the operation is done, we can check the current version of the cluster. </span><span class="koboSpan" id="kobo.40.2">The cluster has now been upgraded to the desired version:</span></p>
<pre><strong><span class="koboSpan" id="kobo.41.1"># az aks show --resource-group devops --name myAKS --output table</span></strong><br/><strong><span class="koboSpan" id="kobo.42.1">Name Location ResourceGroup KubernetesVersion ProvisioningState Fqdn</span></strong><br/><strong><span class="koboSpan" id="kobo.43.1">------ ---------- --------------- ------------------- ------------------- ----------------------------------------------------</span></strong><br/><strong><span class="koboSpan" id="kobo.44.1">myAKS centralus devops 1.10.9 Succeeded myaks-devops-f82579-077667ba.hcp.centralus.azmk8s.io</span></strong></pre>
<p><span class="koboSpan" id="kobo.45.1">The nodes should be upgraded to 1.10.9 as well:</span></p>
<pre><strong><span class="koboSpan" id="kobo.46.1"># kubectl get nodes</span></strong><br/><strong><span class="koboSpan" id="kobo.47.1">NAME STATUS ROLES AGE VERSION</span></strong><br/><strong><span class="koboSpan" id="kobo.48.1">aks-nodepool1-37748545-2 Ready agent 6m v1.10.9</span></strong><br/><strong><span class="koboSpan" id="kobo.49.1">aks-nodepool1-37748545-3 Ready agent 6m v1.10.9</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Monitoring and logging</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">We deployed the monitoring addons when we created the cluster. </span><span class="koboSpan" id="kobo.2.2">This lets us observe cluster metrics and </span><span><span class="koboSpan" id="kobo.3.1">logs</span></span><span><span class="koboSpan" id="kobo.4.1"> </span></span><span><span class="koboSpan" id="kobo.5.1">easily via Azure monitoring. </span><span class="koboSpan" id="kobo.5.2">Let's visit the Kubernetes services in the Azure portal. </span><span class="koboSpan" id="kobo.5.3">You'll find the Monitoring tag with the insights, metrics, and logs sub-tabs.</span></span></p>
<p><span class="koboSpan" id="kobo.6.1">The insights page shows the general cluster metrics, such as the node CPU, the memory utilization, and the node's general health:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.7.1"><img src="assets/f57daa80-6e68-48f2-a061-29c55561bfad.png" style="width:74.67em;height:40.17em;"/></span></p>
<p><span class="koboSpan" id="kobo.8.1">You can also observe the container information from insights:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.9.1"><img src="assets/6db7761b-7654-460f-8292-715b38dcc1eb.png" style="width:72.33em;height:37.17em;"/></span></p>
<p><span class="koboSpan" id="kobo.10.1">You can find all the resource metrics that are supported on the Metrics page. </span><span class="koboSpan" id="kobo.10.2">For the AKS cluster, it'll show some core metrics (</span><a href="https://kubernetes.io/docs/tasks/debug-application-cluster/core-metrics-pipeline/"><span class="koboSpan" id="kobo.11.1">https://kubernetes.io/docs/tasks/debug-application-cluster/core-metrics-pipeline/</span></a><span class="koboSpan" id="kobo.12.1">). </span><span class="koboSpan" id="kobo.12.2">This is handy because it means we don't need to launch another monitoring system, such as Prometheus:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.13.1"><img src="assets/3bf0080e-55e5-4b5f-bc9b-ff980df4373a.png"/></span></p>
<p><span class="koboSpan" id="kobo.14.1">On the logs page, you can find cluster logs in Azure log analytics. </span><span class="koboSpan" id="kobo.14.2">You can run a query to search the logs via the supported syntax. </span><span class="koboSpan" id="kobo.14.3">For more information, you can find the Azure monitoring documentation at </span><a href="https://docs.microsoft.com/en-us/azure/azure-monitor/log-query/log-query-overview"><span class="koboSpan" id="kobo.15.1">https://docs.microsoft.com/en-us/azure/azure-monitor/log-query/log-query-overview</span></a><span class="koboSpan" id="kobo.16.1">:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.17.1"><img src="assets/04d132c3-f1d5-4c96-bd35-2ae51a05f7d2.png"/></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Kubernetes cloud provider</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Just like other cloud providers, the cloud controller manager for Azure (</span><a href="https://github.com/kubernetes/cloud-provider-azure"><span class="koboSpan" id="kobo.3.1">https://github.com/kubernetes/cloud-provider-azure</span></a><span class="koboSpan" id="kobo.4.1">) implements a bunch of integrations with Kubernetes. </span><span class="koboSpan" id="kobo.4.2">Azure cloud controller manager interacts with Azure and </span><span><span class="koboSpan" id="kobo.5.1">provides a seamless user experience. </span></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Role-based access control</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">AKS is integrated with Azure active directory (</span><a href="https://azure.microsoft.com/en-ca/services/active-directory/"><span class="koboSpan" id="kobo.3.1">https://azure.microsoft.com/en-ca/services/active-directory/</span></a><span class="koboSpan" id="kobo.4.1">) via OpenID connect tokens (</span><a href="https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens"><span class="koboSpan" id="kobo.5.1">https://kubernetes.io/docs/reference/access-authn-authz/authentication/#openid-connect-tokens</span></a><span class="koboSpan" id="kobo.6.1">). </span><span class="koboSpan" id="kobo.6.2">The </span><strong><span class="koboSpan" id="kobo.7.1">Role-Based Access Control</span></strong><span class="koboSpan" id="kobo.8.1"> (</span><strong><span class="koboSpan" id="kobo.9.1">RBAC</span></strong><span class="koboSpan" id="kobo.10.1">) feature can only be enabled during cluster creation, so let's start over to create an RBAC-enabled cluster.</span></p>
<p><span class="koboSpan" id="kobo.11.1">Before creating the cluster, we'll have to prepare two application registrations in the Azure active directory first. </span><span class="koboSpan" id="kobo.11.2">The first acts as a server for the users' group membership. </span><span class="koboSpan" id="kobo.11.3">The second is like a client that integrates with kubectl. </span><span class="koboSpan" id="kobo.11.4">Let's go to the Azure active registry service in the Azure portal first. </span><span class="koboSpan" id="kobo.11.5">Go to the </span><span class="packt_screen"><span class="koboSpan" id="kobo.12.1">Properties</span></span><span class="koboSpan" id="kobo.13.1"> tab and record the </span><span class="packt_screen"><span class="koboSpan" id="kobo.14.1">Directory ID</span></span><span class="koboSpan" id="kobo.15.1">. </span><span class="koboSpan" id="kobo.15.2">We'll need this later when we create the cluster:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.16.1"><img src="assets/6177fa43-1dab-4b5e-926b-cc4504dd4f50.png" style="width:69.00em;height:58.50em;"/></span></p>
<p><span class="koboSpan" id="kobo.17.1">Let's go to the </span><span class="packt_screen"><span class="koboSpan" id="kobo.18.1">Application registrations</span></span><span class="koboSpan" id="kobo.19.1"> of the Azure active registry service in the Azure portal first. </span><span class="koboSpan" id="kobo.19.2">The tab on the side shows two application registration options. </span><span class="koboSpan" id="kobo.19.3">One is the original design and the other is the preview version for the new console. </span><span class="koboSpan" id="kobo.19.4">Their functionalities are basically the same. </span><span class="koboSpan" id="kobo.19.5">We'll show the GA version first and the preview version after:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.20.1"><img src="assets/e73b3c05-b8e1-41c8-bf3b-a18d59701a1a.png"/></span></p>
<p><span class="koboSpan" id="kobo.21.1">In the </span><span class="packt_screen"><span class="koboSpan" id="kobo.22.1">App registrations</span></span><span class="koboSpan" id="kobo.23.1"> page, click </span><span class="packt_screen"><span class="koboSpan" id="kobo.24.1">New application registration</span></span><span class="koboSpan" id="kobo.25.1">. </span><span class="koboSpan" id="kobo.25.2">Add a name with any URL. </span></p>
<div class="packt_tip"><span class="koboSpan" id="kobo.26.1">You can also try an operation via </span><kbd><span class="koboSpan" id="kobo.27.1">az ad app create --display-name myAKSAD --identifier-uris http://myAKSAD</span></kbd><span class="koboSpan" id="kobo.28.1">. </span></div>
<p><span class="koboSpan" id="kobo.29.1">Here, we use </span><kbd><span class="koboSpan" id="kobo.30.1">myAKSAD</span></kbd><span class="koboSpan" id="kobo.31.1"> as the name. </span><span class="koboSpan" id="kobo.31.2">After creation, we record the </span><span class="packt_screen"><span class="koboSpan" id="kobo.32.1">APPLICATION ID</span></span><span class="koboSpan" id="kobo.33.1"> first. </span><span class="koboSpan" id="kobo.33.2">Here, we get </span><kbd><span class="koboSpan" id="kobo.34.1">c7d828e7-bca0-4771-8f9d-50b9e1ea0afc</span></kbd><span class="koboSpan" id="kobo.35.1">. </span><span class="koboSpan" id="kobo.35.2">After that, click </span><span class="packt_screen"><span class="koboSpan" id="kobo.36.1">Manifest</span></span><span class="koboSpan" id="kobo.37.1"> and change the </span><kbd><span class="koboSpan" id="kobo.38.1">groupMemebershipClaims</span></kbd><span class="koboSpan" id="kobo.39.1"> to </span><kbd><span class="koboSpan" id="kobo.40.1">All</span></kbd><span class="koboSpan" id="kobo.41.1">, which will </span><span><span class="koboSpan" id="kobo.42.1">get the group claims in the JWT token for all users that belong:</span></span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.43.1"><img src="assets/d0b69bc5-c68d-4f4e-8d9b-a2a2ed96c47c.png"/></span></p>
<p><span class="koboSpan" id="kobo.44.1">After saving the settings, go to these </span><span class="packt_screen"><span class="koboSpan" id="kobo.45.1">Settings</span></span><span class="koboSpan" id="kobo.46.1"> page then the </span><span class="packt_screen"><span class="koboSpan" id="kobo.47.1">Keys</span></span><span class="koboSpan" id="kobo.48.1"> page to create a key. </span><span class="koboSpan" id="kobo.48.2">Here, we specified expires as one year. </span><span class="koboSpan" id="kobo.48.3">This value was generated by the portal directly. </span><span class="koboSpan" id="kobo.48.4">We'll need this password later when we create the cluster:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.49.1"><img src="assets/740c5961-a7e7-442a-8e95-dd235a007df4.png"/></span></p>
<p><span class="koboSpan" id="kobo.50.1">Next, we'll define a set of </span><span><span class="koboSpan" id="kobo.51.1">applications and delegated </span></span><span class="koboSpan" id="kobo.52.1">permissions for this registration. </span><span class="koboSpan" id="kobo.52.2">Hit the </span><span class="packt_screen"><span class="koboSpan" id="kobo.53.1">Required permissions</span></span><span class="koboSpan" id="kobo.54.1"> tab and click </span><span class="packt_screen"><span class="koboSpan" id="kobo.55.1">Add</span></span><span class="koboSpan" id="kobo.56.1">, before selecting </span><span class="packt_screen"><span class="koboSpan" id="kobo.57.1">Microsoft Graph</span></span><span class="koboSpan" id="kobo.58.1">. </span><span class="koboSpan" id="kobo.58.2">Here, we'll select </span><strong><span class="packt_screen"><span class="koboSpan" id="kobo.59.1">Read directory data</span></span></strong><span class="koboSpan" id="kobo.60.1"> under the </span><span class="packt_screen"><span class="koboSpan" id="kobo.61.1">Application permission</span></span><span class="koboSpan" id="kobo.62.1">s category and</span><strong><span class="koboSpan" id="kobo.63.1"> </span></strong><span class="packt_screen"><span class="koboSpan" id="kobo.64.1">Sign in</span></span> <span class="packt_screen"><span class="koboSpan" id="kobo.65.1">and read user profile</span></span><span class="koboSpan" id="kobo.66.1"> and </span><span class="packt_screen"><span class="koboSpan" id="kobo.67.1">Read directory dat</span></span><strong><span class="packt_screen"><span class="koboSpan" id="kobo.68.1">a</span></span></strong><span class="koboSpan" id="kobo.69.1"> under the delegated permissions so that the server can read the directory data and verify the users. </span><span class="koboSpan" id="kobo.69.2">After clicking the Save button, we'll see the following screen in the Required permissions page:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.70.1"><img src="assets/d9a1efc2-4a7e-4d20-bd0f-568636b2caad.png" style="width:31.33em;height:12.42em;"/></span></p>
<p class="CDPAlignLeft CDPAlign"><span class="koboSpan" id="kobo.71.1">As the admin, we can grant permission for all users in this directory by clicking the </span><span class="packt_screen"><span class="koboSpan" id="kobo.72.1">Grant permission</span></span><span class="koboSpan" id="kobo.73.1"> button. </span><span class="koboSpan" id="kobo.73.2">This will make a window pop up that will double-check this with you. </span><span class="koboSpan" id="kobo.73.3">Click </span><span class="packt_screen"><span class="koboSpan" id="kobo.74.1">Yes</span></span><span class="koboSpan" id="kobo.75.1"> to continue.</span></p>
<p><span class="koboSpan" id="kobo.76.1">It's now time to create a second application registration for the client. </span><span class="koboSpan" id="kobo.76.2">The name we used here is </span><kbd><span class="koboSpan" id="kobo.77.1">myAKSADClient</span></kbd><span class="koboSpan" id="kobo.78.1">. </span><span class="koboSpan" id="kobo.78.2">Record its Application ID after creation. </span><span class="koboSpan" id="kobo.78.3">Here, we get </span><kbd><span class="koboSpan" id="kobo.79.1">b4309673-464e-4c95-adf9-afeb27cc8d4c</span></kbd><span class="koboSpan" id="kobo.80.1">:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.81.1"><img src="assets/f5cb6563-0fa8-429b-8eba-a2643c58dd88.png" style="width:21.25em;height:42.92em;"/></span></p>
<p><span class="koboSpan" id="kobo.82.1">For the required permissions, the client just needs to access the application, search the delegated permissions, and find the Access permission with the display name that you created for the server. </span><span class="koboSpan" id="kobo.82.2">Don't forget to hit the </span><span class="packt_screen"><span class="koboSpan" id="kobo.83.1">Grant permission</span></span><span class="koboSpan" id="kobo.84.1"> button after you are done:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.85.1"><img src="assets/87d75bf6-a5aa-47d6-a95b-4af0091e0f19.png" style="width:62.42em;height:24.50em;"/></span></p>
<p><span class="koboSpan" id="kobo.86.1">Right now, it's time to create our AKS cluster with Azure AD integration. </span><span class="koboSpan" id="kobo.86.2">Make sure that you have recorded the following information from the previous operations:</span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td><strong><span class="koboSpan" id="kobo.87.1">Information we recorded</span></strong></td>
<td><strong><span class="koboSpan" id="kobo.88.1">Corresponding argument in aks create</span></strong></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.89.1">The server application ID</span></td>
<td><kbd><span class="koboSpan" id="kobo.90.1">--aad-server-app-id</span></kbd></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.91.1">The server application key (password)</span></td>
<td><kbd><span class="koboSpan" id="kobo.92.1">--aad-server-app-secret</span></kbd></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.93.1">The client application ID</span></td>
<td><kbd><span class="koboSpan" id="kobo.94.1">--aad-client-app-id</span></kbd></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.95.1">The directory ID</span></td>
<td><kbd><span class="koboSpan" id="kobo.96.1">--aad-tenant-id</span></kbd></td>
</tr>
</tbody>
</table>
<p><span class="koboSpan" id="kobo.97.1"> </span></p>
<p><span class="koboSpan" id="kobo.98.1">It is now time to launch the cluster:</span></p>
<pre><strong><span class="koboSpan" id="kobo.99.1"># az aks create --resource-group devops --name myADAKS --generate-ssh-keys --aad-server-app-id c7d828e7-bca0-4771-8f9d-50b9e1ea0afc --aad-server-app-secret 'A/IqLPieuCqJzL9vPEI5IqCn0IaEyn5Zq/lgfovNn9g=' --aad-client-app-id b4309673-464e-4c95-adf9-afeb27cc8d4c --aad-tenant-id d41d3fd1-f004-45cf-a77b-09a532556331 --node-count 1 --enable-addons monitoring,http_application_routing --generate-ssh-keys</span></strong></pre>
<p><span class="koboSpan" id="kobo.100.1">In Kubernetes, a role binding or a cluster role binding binds the role to a group of users. </span><span class="koboSpan" id="kobo.100.2">A role or cluster role defines a set of permissions.</span></p>
<p><span class="koboSpan" id="kobo.101.1">After the cluster is successfully launched, to integrate with OpenID, we'll have to create the role binding or cluster role binding first. </span><span class="koboSpan" id="kobo.101.2">Here, we'll use the existing cluster role in the cluster, which is </span><kbd><span class="koboSpan" id="kobo.102.1">cluster-admin</span></kbd><span class="koboSpan" id="kobo.103.1">. </span><span class="koboSpan" id="kobo.103.2">We'll bind the users to the </span><kbd><span class="koboSpan" id="kobo.104.1">cluster-admin</span></kbd><span class="koboSpan" id="kobo.105.1"> cluster role so that the users can be authenticated and act as cluster admins:</span></p>
<pre><strong><span class="koboSpan" id="kobo.106.1">// login as admin first to get the access to create the bindings</span></strong><br/><strong><span class="koboSpan" id="kobo.107.1"># az aks get-credentials --resource-group devops --name myADAKS --admin</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.108.1">// list cluster roles</span></strong><br/><strong><span class="koboSpan" id="kobo.109.1"># kubectl get clusterrole</span></strong><br/><strong><span class="koboSpan" id="kobo.110.1">NAME AGE</span></strong><br/><strong><span class="koboSpan" id="kobo.111.1">admin 2h</span></strong><br/><strong><span class="koboSpan" id="kobo.112.1">cluster-admin 2h</span></strong><br/><strong><span class="koboSpan" id="kobo.113.1">...</span></strong></pre>
<p><span class="koboSpan" id="kobo.114.1">For a single user, we'll have to find the username. </span><span class="koboSpan" id="kobo.114.2">You can find the </span><span class="packt_screen"><span class="koboSpan" id="kobo.115.1">Object ID</span></span><span class="koboSpan" id="kobo.116.1"> for the target user under the users page in the Azure AD portal:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.117.1"><img src="assets/5e26469b-53ee-4008-bc31-5b79e6916f1a.png" style="width:44.75em;height:32.08em;"/></span></p>
<p><span class="koboSpan" id="kobo.118.1">Use user subjects and specify the </span><span class="packt_screen"><span class="koboSpan" id="kobo.119.1">Object ID</span></span><span class="koboSpan" id="kobo.120.1"> as the name, as shown here:</span></p>
<pre><strong><span class="koboSpan" id="kobo.121.1"># cat 12-3_user-clusterrolebinding.yaml</span></strong><br/><strong><span class="koboSpan" id="kobo.122.1">apiVersion: rbac.authorization.k8s.io/v1</span></strong><br/><strong><span class="koboSpan" id="kobo.123.1">kind: ClusterRoleBinding</span></strong><br/><strong><span class="koboSpan" id="kobo.124.1">metadata:</span></strong><br/><strong><span class="koboSpan" id="kobo.125.1"> name: azure-user-cluster-admins</span></strong><br/><strong><span class="koboSpan" id="kobo.126.1">roleRef:</span></strong><br/><strong><span class="koboSpan" id="kobo.127.1">  apiGroup: rbac.authorization.k8s.io</span></strong><br/><strong><span class="koboSpan" id="kobo.128.1">  kind: ClusterRole</span></strong><br/><strong><span class="koboSpan" id="kobo.129.1">  name: cluster-admin</span></strong><br/><strong><span class="koboSpan" id="kobo.130.1">subjects:</span></strong><br/><strong><span class="koboSpan" id="kobo.131.1">- apiGroup: rbac.authorization.k8s.io</span></strong><br/><strong><span class="koboSpan" id="kobo.132.1">  kind: User</span></strong><br/><strong><span class="koboSpan" id="kobo.133.1">  name: "8698dcf8-4d97-43be-aacd-eca1fc1495b6"</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.134.1"># kubectl create -f 12-3_user-clusterrolebinding.yaml</span></strong><br/><strong><span class="koboSpan" id="kobo.135.1">clusterrolebinding.rbac.authorization.k8s.io/azure-user-cluster-admins created</span></strong></pre>
<p><span class="koboSpan" id="kobo.136.1">After that, we can start over to access the cluster resources, as shown here:</span></p>
<pre><strong><span class="koboSpan" id="kobo.137.1">// (optional) clean up kubeconfig if needed.</span></strong><br/><strong><span class="koboSpan" id="kobo.138.1"># rm -f ~/.kube/config</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.139.1">// setup kubeconfig with non-admin</span></strong><br/><strong><span class="koboSpan" id="kobo.140.1"># az aks get-credentials --resource-group devops --name myADAKS </span></strong><br/><br/><strong><span class="koboSpan" id="kobo.141.1">// try get the nodes</span></strong><br/><strong><span class="koboSpan" id="kobo.142.1"># kubectl get nodes</span></strong><br/><strong><span class="koboSpan" id="kobo.143.1">To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code A6798XUFB to authenticate.</span></strong></pre>
<p><span class="koboSpan" id="kobo.144.1">It seems like we need to log in before listing any resources. </span><span class="koboSpan" id="kobo.144.2">Go to the </span><a href="https://microsoft.com/devicelogin"><span class="koboSpan" id="kobo.145.1">https://microsoft.com/devicelogin</span></a><span class="koboSpan" id="kobo.146.1"> </span><span><span class="koboSpan" id="kobo.147.1">page </span></span><span><span class="koboSpan" id="kobo.148.1">and input the code, as the prompt suggests:</span></span></p>
<p class="CDPAlignCenter CDPAlign"><span class="koboSpan" id="kobo.149.1"><img src="assets/03a87e70-3c62-41ed-b9b2-055dbcbd4c2c.png" style="width:22.25em;height:25.00em;"/></span></p>
<p><span class="koboSpan" id="kobo.150.1">Log in to your Microsoft account and return to the terminal. </span><span class="koboSpan" id="kobo.150.2">The integration looks great!</span></p>
<pre><strong><span class="koboSpan" id="kobo.151.1"># kubectl get nodes</span></strong><br/><strong><span class="koboSpan" id="kobo.152.1">To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code A6798XUFB to authenticate.</span></strong><br/><strong><span class="koboSpan" id="kobo.153.1">NAME STATUS ROLES AGE VERSION</span></strong><br/><strong><span class="koboSpan" id="kobo.154.1">aks-nodepool1-42766340-0 Ready agent 26m v1.9.11</span></strong></pre>
<p><span class="koboSpan" id="kobo.155.1">Rather than specifying a set of users, you could choose t</span><span><span class="koboSpan" id="kobo.156.1">o specify users as a group</span></span><span class="koboSpan" id="kobo.157.1"> via the Azure AD group object ID. </span><span class="koboSpan" id="kobo.157.2">Replace the subject in the cluster role binding configuration so that all the users in that group will have cluster admin access:</span></p>
<pre><strong><span class="koboSpan" id="kobo.158.1">- apiGroup: rbac.authorization.k8s.io</span></strong><br/><strong><span class="koboSpan" id="kobo.159.1">  kind: Group</span></strong><br/><strong><span class="koboSpan" id="kobo.160.1">  name: "$group_object_id"</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">StorageClass</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">When we launched AKS, it created two default storage classes for us, default and managed-premium:</span></p>
<pre><strong><span class="koboSpan" id="kobo.3.1"># kubectl get storageclass</span></strong><br/><strong><span class="koboSpan" id="kobo.4.1">NAME PROVISIONER AGE</span></strong><br/><strong><span class="koboSpan" id="kobo.5.1">default (default) kubernetes.io/azure-disk 4h</span></strong><br/><strong><span class="koboSpan" id="kobo.6.1">managed-premium kubernetes.io/azure-disk 11h</span></strong></pre>
<p><span class="koboSpan" id="kobo.7.1">If we take a look at the details of these storage classes, we find that they're of the </span><kbd><span class="koboSpan" id="kobo.8.1">Standard_LRS</span></kbd><span class="koboSpan" id="kobo.9.1"> and </span><kbd><span class="koboSpan" id="kobo.10.1">Premium_LRS</span></kbd><span class="koboSpan" id="kobo.11.1"> types:</span></p>
<pre><strong><span class="koboSpan" id="kobo.12.1"># kubectl describe storageclass default</span></strong><br/><strong><span class="koboSpan" id="kobo.13.1">Name: default</span></strong><br/><strong><span class="koboSpan" id="kobo.14.1">IsDefaultClass: Yes</span></strong><br/><strong><span class="koboSpan" id="kobo.15.1">Annotations: ...</span></strong><br/><strong><span class="koboSpan" id="kobo.16.1">,storageclass.beta.kubernetes.io/is-default-class=true</span></strong><br/><strong><span class="koboSpan" id="kobo.17.1">Provisioner: kubernetes.io/azure-disk</span></strong><br/><strong><span class="koboSpan" id="kobo.18.1">Parameters: cachingmode=None,kind=Managed,storageaccounttype=Standard_LRS</span></strong><br/><strong><span class="koboSpan" id="kobo.19.1">AllowVolumeExpansion: &lt;unset&gt;</span></strong><br/><strong><span class="koboSpan" id="kobo.20.1">MountOptions: &lt;none&gt;</span></strong><br/><strong><span class="koboSpan" id="kobo.21.1">ReclaimPolicy: Delete</span></strong><br/><strong><span class="koboSpan" id="kobo.22.1">VolumeBindingMode: Immediate</span></strong><br/><strong><span class="koboSpan" id="kobo.23.1">Events: &lt;none&gt;</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.24.1"># kubectl describe storageclass managed-premium</span></strong><br/><strong><span class="koboSpan" id="kobo.25.1">Name: managed-premium</span></strong><br/><strong><span class="koboSpan" id="kobo.26.1">IsDefaultClass: No</span></strong><br/><strong><span class="koboSpan" id="kobo.27.1">Annotations: ...</span></strong><br/><strong><span class="koboSpan" id="kobo.28.1">Provisioner: kubernetes.io/azure-disk</span></strong><br/><strong><span class="koboSpan" id="kobo.29.1">Parameters: kind=Managed,storageaccounttype=Premium_LRS</span></strong><br/><strong><span class="koboSpan" id="kobo.30.1">AllowVolumeExpansion: &lt;unset&gt;</span></strong><br/><strong><span class="koboSpan" id="kobo.31.1">MountOptions: &lt;none&gt;</span></strong><br/><strong><span class="koboSpan" id="kobo.32.1">ReclaimPolicy: Delete</span></strong><br/><strong><span class="koboSpan" id="kobo.33.1">VolumeBindingMode: Immediate</span></strong><br/><strong><span class="koboSpan" id="kobo.34.1">Events: &lt;none&gt;</span></strong></pre>
<p><span class="koboSpan" id="kobo.35.1">We can also create our own storage class to create persistent volumes </span><span><span class="koboSpan" id="kobo.36.1">dynamically</span></span><span><span class="koboSpan" id="kobo.37.1">. </span><span class="koboSpan" id="kobo.37.2">Let's say that we want to create a two-zone redundant storage with standard and premium types. </span><span class="koboSpan" id="kobo.37.3">We need to specify the location and the </span><kbd><span class="koboSpan" id="kobo.38.1">skuName</span></kbd><span class="koboSpan" id="kobo.39.1">:</span></span></p>
<pre><strong><span class="koboSpan" id="kobo.40.1">// create storage class with Premium and Standard ZRS</span></strong><br/><strong><span class="koboSpan" id="kobo.41.1"># cat chapter12/storageclass.yaml</span></strong><br/><strong><span class="koboSpan" id="kobo.42.1">kind: StorageClass</span></strong><br/><strong><span class="koboSpan" id="kobo.43.1">apiVersion: storage.k8s.io/v1</span></strong><br/><strong><span class="koboSpan" id="kobo.44.1">metadata:</span></strong><br/><strong><span class="koboSpan" id="kobo.45.1">  name: fastzrs</span></strong><br/><strong><span class="koboSpan" id="kobo.46.1">provisioner: kubernetes.io/azure-disk</span></strong><br/><strong><span class="koboSpan" id="kobo.47.1">parameters:</span></strong><br/><strong><span class="koboSpan" id="kobo.48.1">  skuName: Premium_ZRS</span></strong><br/><strong><span class="koboSpan" id="kobo.49.1">  location: centralus</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.50.1">---</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.51.1">kind: StorageClass</span></strong><br/><strong><span class="koboSpan" id="kobo.52.1">apiVersion: storage.k8s.io/v1</span></strong><br/><strong><span class="koboSpan" id="kobo.53.1">metadata:</span></strong><br/><strong><span class="koboSpan" id="kobo.54.1">  name: slowzrs</span></strong><br/><strong><span class="koboSpan" id="kobo.55.1">provisioner: kubernetes.io/azure-disk</span></strong><br/><strong><span class="koboSpan" id="kobo.56.1">parameters:</span></strong><br/><strong><span class="koboSpan" id="kobo.57.1">  skuName: Standard_ZRS</span></strong><br/><strong><span class="koboSpan" id="kobo.58.1">  location: centralus</span></strong><br/><br/><strong><span class="koboSpan" id="kobo.59.1">// create the storage class</span></strong><br/><strong><span class="koboSpan" id="kobo.60.1"># kubectl create -f chapter12/storageclass.yaml</span></strong><br/><strong><span class="koboSpan" id="kobo.61.1">storageclass.storage.k8s.io/fastzrs created</span></strong><br/><strong><span class="koboSpan" id="kobo.62.1">storageclass.storage.k8s.io/slowzrs created</span></strong></pre>
<p><span class="koboSpan" id="kobo.63.1">The mapping of the </span><kbd><span class="koboSpan" id="kobo.64.1">skuName</span></kbd><span class="koboSpan" id="kobo.65.1"> field and the storage types is shown here:</span></p>
<table style="border-collapse: collapse;width: 100%" border="1">
<tbody>
<tr>
<td><strong><span class="koboSpan" id="kobo.66.1">Class</span></strong></td>
<td><strong><span><span class="koboSpan" id="kobo.67.1">Replication</span></span></strong></td>
<td><strong><span><span class="koboSpan" id="kobo.68.1">skuName</span></span></strong></td>
</tr>
<tr>
<td><span class="koboSpan" id="kobo.69.1">Premium</span></td>
<td><span class="koboSpan" id="kobo.70.1">LRS</span></td>
<td><kbd><span><span class="koboSpan" id="kobo.71.1">Premium_LRS</span></span></kbd></td>
</tr>
<tr>
<td><span><span class="koboSpan" id="kobo.72.1">Premium</span></span></td>
<td><span class="koboSpan" id="kobo.73.1">ZRS</span></td>
<td><kbd><span><span class="koboSpan" id="kobo.74.1">Premium_ZRS</span></span></kbd></td>
</tr>
<tr>
<td><span><span class="koboSpan" id="kobo.75.1">Standard</span></span></td>
<td><span class="koboSpan" id="kobo.76.1">GRS</span></td>
<td><kbd><span><span class="koboSpan" id="kobo.77.1">Standard_GRS</span></span></kbd></td>
</tr>
<tr>
<td><span><span class="koboSpan" id="kobo.78.1">Standard</span></span></td>
<td><span class="koboSpan" id="kobo.79.1">LRS</span></td>
<td><kbd><span><span class="koboSpan" id="kobo.80.1">Standard_LRS</span></span></kbd></td>
</tr>
<tr>
<td><span><span class="koboSpan" id="kobo.81.1">Standard</span></span></td>
<td><span class="koboSpan" id="kobo.82.1">RAGRS</span></td>
<td><kbd><span><span class="koboSpan" id="kobo.83.1">Standard_RAGRS</span></span></kbd></td>
</tr>
<tr>
<td><span><span class="koboSpan" id="kobo.84.1">Standard</span></span></td>
<td><span class="koboSpan" id="kobo.85.1">ZRS</span></td>
<td><kbd><span><span class="koboSpan" id="kobo.86.1">Standard_ZRS</span></span></kbd></td>
</tr>
</tbody>
</table>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">L4 LoadBalancer</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">When you create an AKS cluster in basic networking, Azure will provision a load balancer called kubernetes in a dedicated resource group. </span><span class="koboSpan" id="kobo.2.2">When we create a service with a LoadBalancer type, AKS will provision a frontend IP and link to the service object automatically. </span><span class="koboSpan" id="kobo.2.3">This is how we could access </span><kbd><span class="koboSpan" id="kobo.3.1">nginx</span></kbd><span class="koboSpan" id="kobo.4.1"> using external IPs earlier in this chapter. </span><span class="koboSpan" id="kobo.4.2">There are a set of annotations you can set in your service, and the Azure cloud controller will provision it based on the specified annotations. </span><span class="koboSpan" id="kobo.4.3">You can find a list of supported annotations here: </span><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/cloudprovider/providers/azure/azure_loadbalancer.go"><span class="koboSpan" id="kobo.5.1">https://github.com/kubernetes/kubernetes/blob/master/pkg/cloudprovider/providers/azure/azure_loadbalancer.go</span></a><span class="koboSpan" id="kobo.6.1">. </span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Ingress controller</span></h1>
                </header>
            
            <article>
                
<p><span class="koboSpan" id="kobo.2.1">Azure supports HTTP application routing as an addon (the source code can be found at the following link: </span><a href="https://github.com/Azure/application-gateway-kubernetes-ingress"><span class="koboSpan" id="kobo.3.1">https://github.com/Azure/application-gateway-kubernetes-ingress</span></a><span class="koboSpan" id="kobo.4.1">). </span><span><span class="koboSpan" id="kobo.5.1">Earlier, we created the cluster with the </span></span><kbd><span class="koboSpan" id="kobo.6.1">http_application_routing under --enable-addons argument</span></kbd><span><span class="koboSpan" id="kobo.7.1"> </span></span><span><span class="koboSpan" id="kobo.8.1">argument</span></span><span><em><span class="koboSpan" id="kobo.9.1">.</span></em></span><span><span class="koboSpan" id="kobo.10.1"> AKS would have deployed a set of services to support ingress:</span></span></p>
<pre><strong><span class="koboSpan" id="kobo.11.1">// we could find a set of resources starting with the name addon-http-application-routing-...</span></strong><br/><strong><span class="koboSpan" id="kobo.12.1"># kubectl get pod -n kube-system</span></strong><br/><strong><span class="koboSpan" id="kobo.13.1">NAME READY STATUS RESTARTS AGE</span></strong><br/><strong><span class="koboSpan" id="kobo.14.1">addon-http-application-routing-default-http-backend-6584cdnpq69 1/1 Running 0 3h</span></strong><br/><strong><span class="koboSpan" id="kobo.15.1">addon-http-application-routing-external-dns-7dc8d9f794-4t28c 1/1 Running 0 3h</span></strong><br/><strong><span class="koboSpan" id="kobo.16.1">addon-http-application-routing-nginx-ingress-controller-78zs45d 1/1 Running 0 3h</span></strong><br/><strong><span class="koboSpan" id="kobo.17.1">...</span></strong></pre>
<div class="packt_tip"><span class="hljs-keyword"><span class="koboSpan" id="kobo.18.1">You can also enable ingress controller via the </span><span><kbd><span class="koboSpan" id="kobo.19.1">az aks enable-addons</span></kbd><span class="koboSpan" id="kobo.20.1"> command </span></span><span class="koboSpan" id="kobo.21.1">after the cluster is</span></span><span><span class="koboSpan" id="kobo.22.1"> created. </span></span></div>
<p><span class="koboSpan" id="kobo.23.1">We can reuse the ingress examples from </span><kbd><span class="koboSpan" id="kobo.24.1">Chapter6</span></kbd><span class="koboSpan" id="kobo.25.1">. </span><span class="koboSpan" id="kobo.25.2">What we have to do is specify </span><kbd><span class="koboSpan" id="kobo.26.1">annotation</span><span class="hljs-string"><span class="koboSpan" id="kobo.27.1">kubernetes.io/ingress.class:</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.28.1">addon-http-application-routing</span></span></kbd><span class="hljs-string"><span class="koboSpan" id="kobo.29.1"> </span></span><span class="koboSpan" id="kobo.30.1">in the </span><kbd><span class="koboSpan" id="kobo.31.1">ingress</span></kbd><span class="koboSpan" id="kobo.32.1"> resource and the host name that AKS created for routing your HTTP application. </span><span class="koboSpan" id="kobo.32.2">You can find the host name in the </span><kbd><span class="koboSpan" id="kobo.33.1">addonProfiles.httpApplicationRouting.config.HTTPApplicationRoutingZoneName</span></kbd><span class="koboSpan" id="kobo.34.1"> session when you create or list your cluster, or by using the </span><kbd><span class="koboSpan" id="kobo.35.1">az aks show --query</span></kbd><span class="koboSpan" id="kobo.36.1"> command to search for it:</span></p>
<pre><strong><span class="koboSpan" id="kobo.37.1">// search the routing zone name.</span></strong><br/><strong><span class="koboSpan" id="kobo.38.1"># az aks show --resource-group devops --name myADAKS --query addonProfiles.httpApplicationRouting.config.HTTPApplicationRoutingZoneName</span></strong><br/><strong><span class="koboSpan" id="kobo.39.1">"46de1b27375a4f7ebf30.centralus.aksapp.io"</span></strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title"><span class="koboSpan" id="kobo.1.1">Summary</span></h1>
                </header>
            
            <article>
                
<p><span><span><span class="koboSpan" id="kobo.2.1">Microsoft Azure is a powerful and enterprise-grade cloud computing platform. </span><span class="koboSpan" id="kobo.2.2">Beside AKS, it also provides various services in different fields, such as analytics, virtual reality, and much more. </span><span class="koboSpan" id="kobo.2.3">In this chapter, we touched the surface of Azure virtual network, subnets, and load balancing. </span><span class="koboSpan" id="kobo.2.4">We also learned how to </span></span></span><span><span><span><span class="koboSpan" id="kobo.3.1">deploy and administrate the Kubernetes service in Azure. </span><span class="koboSpan" id="kobo.3.2">We walked through how Azure provides Kubernetes resources via the cloud controller manager for Azure. </span><span class="koboSpan" id="kobo.3.3">We got to know how the cloud controller manager for Azure provides a seamless experience for Azure users, such as by </span></span></span></span><span><span><span class="koboSpan" id="kobo.4.1">creating an Azure load balancer when a LoadBalancer service in Kubernetes is requested or pre-creating an Azure disk storage class. </span></span></span></p>
<p class="mce-root"><span class="koboSpan" id="kobo.5.1">This is the last chapter of this book. </span><span class="koboSpan" id="kobo.5.2">We have tried to walk through both basic and more advanced concepts in this Kubernetes learning journey. </span><span class="koboSpan" id="kobo.5.3">Because Kubernetes is evolving rapidly, we strongly encourage you to join the Kubernetes community (</span><a href="https://kubernetes.io/community/"><span class="koboSpan" id="kobo.6.1">https://kubernetes.io/community/</span></a><span class="koboSpan" id="kobo.7.1">) to get inspired, discuss, and contribute!</span></p>


            </article>

            
        </section>
    </body></html>