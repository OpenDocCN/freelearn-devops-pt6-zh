<html><head></head><body>
		<div>
			<div id="_idContainer373" class="Content">
			</div>
		</div>
		<div id="_idContainer374" class="Content">
			<h1 id="_idParaDest-142">12. <a id="_idTextAnchor146"/>Connecting an application to an Azure database</h1>
		</div>
		<div id="_idContainer409" class="Content">
			<p>In previous chapters, you stored the state of your application in your cluster, either on a Redis cluster or on MariaDB. You might remember that both had some issues when it came to high availability. This chapter will take you through the process of connecting to a MySQL database managed by Azure.</p>
			<p>We will discuss the benefits of using a hosted database rather than running <strong class="bold">StatefulSets</strong> on Kubernetes. To create this hosted and managed database, you will make use of <strong class="bold">Azure Service Operator</strong> (<strong class="bold">ASO</strong>). ASO is a way to create Azure resources, such as a managed MySQL database, from within a Kubernetes cluster. In this chapter, you will learn more details about the ASO project, and you will set up and configure ASO on your cluster.</p>
			<p>You will then make use of ASO to create a MySQL database in Azure. You will use this managed database as part of a WordPress application. This will show you how you can connect an application to a managed database. This chapter is broken down into the following topics:</p>
			<ul>
				<li>Azure Service Operator</li>
				<li>Installing ASO on your cluster</li>
				<li>Creating a MySQL database using ASO</li>
				<li>Creating an application using the MySQL database</li>
			</ul>
			<p>Let's start by exploring ASO.</p>
			<h2 id="_idParaDest-143"><a id="_idTextAnchor147"/>Azure Service Operator</h2>
			<p>In this section, you will learn more about ASO. We will start by exploring the benefits of using a hosted database versus running StatefulSets on Kubernetes itself, and then learn more details about ASO.</p>
			<p>All the examples that you have gone through so far have been self-contained; that is, everything ran inside the Kubernetes cluster. Almost any production application has a state, which is generally stored in a database. While there is a great advantage to being mostly cloud-agnostic, this has a huge disadvantage when it comes to managing a stateful workload such as a database.</p>
			<p>When you are running your own database on top of a Kubernetes cluster, you need to take care of scalability, security, high availability, DR, and backup. Managed database services offered by cloud providers can offload you or your team from having to execute these tasks. For example, Azure Database for MySQL comes with enterprise-grade security and compliance, built-in high availability, and automated backups. The service scales within seconds. Finally, you also have the option to configure DR to a secondary region.</p>
			<p>It is a lot simpler to consume a production-grade database from Azure than it is to set up and manage your own on Kubernetes. In the next section, you will explore a way that Kubernetes can be used to create these databases on Azure.</p>
			<h3 id="_idParaDest-144"><a id="_idTextAnchor148"/>What is ASO?</h3>
			<p>As with most applications these days, much of the hard work has already been done for us by the open-source community (including those who work for Microsoft). Microsoft has realized that many users would like to use their managed services from Kubernetes and that they require an easier way of using the same methodologies that are used for Kubernetes deployment. The ASO project was created to solve this problem.</p>
			<p>ASO is a new project started in 2020 that succeeds the <strong class="bold">Open Service Broker for Azure</strong> (<strong class="bold">OSBA</strong>) project. OSBA was Microsoft's original implementation that allowed you to create Azure resources from within Kubernetes, but this project is no longer maintained and has been deprecated. ASO serves the same purpose and is actively maintained and developed.</p>
			<p>There are two parts to ASO: a set of <strong class="bold">CustomResourceDefinitions</strong> (<strong class="bold">CRDs</strong>) and a controller that manages those CRDs. The CRDs are a set of API extensions for Kubernetes that allow you to specify which Azure resources you want to create. There are CRDs for resource groups, virtual machines, MySQL databases, and more.</p>
			<p>Most APIs in ASO are still in either the alpha or beta stage, meaning they might change in the future. Please refer to the documentation at <a href="https://github.com/Azure/azure-service-operator">https://github.com/Azure/azure-service-operator</a> for an up-to-date resource definition, as the definitions used in this chapter might have changed.</p>
			<p>The controller is a pod that runs on your cluster and monitors the Kubernetes API for any objects that are created using these CRDs. It's this controller that will interface with the Azure API and create the resource you create using ASO.</p>
			<p>ASO depends on two other projects that you have already learned about in this book, namely <strong class="bold">Azure Active Directory</strong> (<strong class="bold">Azure AD</strong>) pod-managed identities and cert-manager. ASO uses Azure AD pod-managed identities to link a managed identity to the ASO pod. This also means that this managed identity needs to have permissions to create those resources. ASO uses cert-manager to get access to a certificate for the ASO pod to use.</p>
			<p>By default, ASO will store secrets such as connection strings in Kubernetes secrets. As you have learned in the preceding chapters, it's better to store secrets in Key Vault rather than in Kubernetes. ASO has the option to store secrets in Key Vault as well, and during the setup, you will configure ASO to store secrets in Key Vault.</p>
			<p>For a user perspective using ASO, <em class="italics">Figure 12.1</em> describes what happens when you create a resource:</p>
			<ol>
				<li>As a user, you submit a YAML definition for an Azure resource to the Kubernetes API. The Azure resources are defined in a CRD.</li>
				<li>The ASO pod is monitoring the Kubernetes API for changes to the Azure CRD objects. </li>
				<li>When changes are detected, ASO will create the resources in Azure.</li>
				<li>If a connection string was created as part of the resource creation, this connection string will be stored either as a Kubernetes secret (default) or in Key Vault (if configured).</li>
			</ol>
			<div>
				<div id="_idContainer375" class="IMG---Figure">
					<img src="image/B17338_12_01.jpg" alt="High-level process diagram of resource creation using ASO"/>
				</div>
			</div>
			<p class="figure">Figure 12.1: High-level process diagram of resource creation using ASO</p>
			<p>In this section, you've learned the basics of the ASO project. In the next section, you will go ahead and install ASO on your cluster.</p>
			<h2 id="_idParaDest-145"><a id="_idTextAnchor149"/>Installing ASO on your cluster</h2>
			<p>To install ASO on your cluster, you will need a cluster. At the end of the previous chapter, you deleted your cluster, so you will create a new one here. After that, you will need to create a managed identity and Key Vault. Both are best practices when setting up ASO, which is why this chapter will explain how to set up ASO this way. After the creation of these resources, you need to ensure that cert-manager is set up in your cluster. Once that is confirmed, you can install ASO using a Helm chart.</p>
			<p>Let's start with the first step, creating a new AKS cluster.</p>
			<h3 id="_idParaDest-146"><a id="_idTextAnchor150"/>Creating a new AKS cluster</h3>
			<p>Since you deleted your cluster at the end of the previous chapter, let's start by creating a new cluster. You can do all these steps using Cloud Shell. Let's get started:</p>
			<ol>
				<li value="1">First, you will create a new cluster. Since you will be making use of pod identities for the authorization of ASO, you will also enable the pod identity add-on on this new cluster. At the time of this writing, the pod identity add-on is in preview.<p>If you haven't registered for your subscription for this preview as explained in <em class="italics">Chapter 9</em>, <em class="italics">Azure Active Directory pod-managed identities in AKS</em>, please do so now using the following commands:</p><p class="snippet">az feature register --name EnablePodIdentityPreview \</p><p class="snippet">  --namespace Microsoft.ContainerService</p><p>You will also need a preview extension of the Azure CLI, which you can install using the following command:</p><p class="snippet">az extension add --name aks-preview</p><p>You will have to wait until the pod identity preview is registered on your subscription. You can use the following command to verify this status:</p><p class="snippet">az feature show --name EnablePodIdentityPreview \</p><p class="snippet">  --namespace Microsoft.ContainerService -o table</p><p>Wait until the status shows as registered, as shown in <em class="italics">Figure 12.2</em>:</p><div id="_idContainer376" class="IMG---Figure"><img src="image/B17338_09_03.jpg" alt="Output displaying the status as registered"/></div><p class="figure">Figure 12.2: Waiting for the feature to be registered</p><p>Once the feature is registered, you need to refresh the registration of the namespace before creating a new cluster. Let's first refresh the registration of the namespace:</p><p class="snippet">az provider register --namespace Microsoft.ContainerService</p></li>
				<li>Once you registered the preview provider, or if you had already done so as part of <em class="italics">Chapter 9</em>, <em class="italics">Azure Active Directory pod-managed identities in AKS</em>, you can create a new cluster using the following command:<p class="snippet">az aks create -g rg-handsonaks -n handsonaks \</p><p class="snippet">  --enable-managed-identity --enable-pod-identity \</p><p class="snippet">  --network-plugin azure --node-vm-size Standard_DS2_v2 \</p><p class="snippet">  --node-count 2 --generate-ssh-keys </p></li>
				<li>Once the command is finished, get the credentials to get access to your cluster using the following command:<p class="snippet">az aks get-credentials -g rg-handsonaks \</p><p class="snippet">  -n handsonaks --overwrite-existing</p></li>
			</ol>
			<p>You now have a new Kubernetes cluster with pod identities enabled. To continue the setup of ASO, let's now create a managed identity.</p>
			<h3 id="_idParaDest-147"><a id="_idTextAnchor151"/>Creating a managed identity</h3>
			<p>In this section, you will use the Azure portal to create a managed identity. You will then give permission to your AKS cluster to manage this managed identity and give the managed identity access to your subscription to create the resources. Let's start:</p>
			<ol>
				<li value="1">In the Azure search bar, look for <em class="italics">Managed Identities</em>, as shown in <em class="italics">Figure 12.3</em>:<div id="_idContainer377" class="IMG---Figure"><img src="image/B17338_12_03.jpg" alt="Searching for Managed Identity in the Azure search bar"/></div><p class="figure">Figure 12.3: Searching for Managed Identities</p></li>
				<li>In the resulting screen, click on <span class="P---Screen-Text">+ New</span> to create a new managed identity, as shown in <em class="italics">Figure 12.4</em>:<div id="_idContainer378" class="IMG---Figure"><img src="image/B17338_12_04.jpg" alt="Clicking on the Add new button to create a new managed identity"/></div><p class="figure">Figure 12.4: Creating a new managed identity</p></li>
				<li>To organize the resources for this chapter together, create a new resource group called ASO, as shown in <em class="italics">Figure 12.5</em>:<div id="_idContainer379" class="IMG---Figure"><img src="image/B17338_12_05.jpg" alt="Creating a new resource group"/></div><p class="figure">Figure 12.5: Creating a new resource group</p></li>
				<li>Provide the location and a name for your managed identity; use the name <strong class="inline">aso-mi</strong> as shown in <em class="italics">Figure 12.6</em> if you wish to follow the example here. Make sure to select the same region as the region of your cluster:<div id="_idContainer380" class="IMG---Figure"><img src="image/B17338_12_06.jpg" alt="Providing necessary details to create a managed identity"/></div><p class="figure">Figure 12.6: Providing Project and Instance details for creating the managed identity</p></li>
				<li>Click <span class="P---Screen-Text">Review + create</span> at the bottom of the screen and create the managed identity. </li>
				<li>Once the managed identity is created, you need to capture the client ID and resource ID for later use. Copy and paste this information in a location where you can access it later. You can get the client ID in the <span class="P---Screen-Text">Overview</span> pane, as shown in <em class="italics">Figure 12.7</em>:<div id="_idContainer381" class="IMG---Figure"><img src="image/B17338_12_07.jpg" alt="Getting the client ID details from the Managed Identity pane"/></div><p class="figure">Figure 12.7: Getting the client ID from the managed identity</p><p>You can get the resource ID in the Properties pane, as shown in <em class="italics">Figure 12.8</em>:</p><div id="_idContainer382" class="IMG---Figure"><img src="image/B17338_12_08.jpg" alt="Getting the Resource ID details from the Managed Identity pane"/></div><p class="figure">Figure 12.8: Getting the resource ID of the managed identity</p></li>
				<li>The next thing to do on the managed identity is to give our AKS cluster permissions to it. To do this, click on<a id="_idTextAnchor152"/> <span class="P---Screen-Text">Access control (IAM)</span> in the left pane, click on the <span class="P---Screen-Text">+ Add</span> button at the top of the screen, click <span class="P---Screen-Text">Add role assignment</span> from the dropdown menu, select the <span class="P---Screen-Text">Managed Identity Operator</span> role, select <span class="P---Screen-Text">User assigned managed identity</span> from the <span class="P---Screen-Text">Assign access to</span> dropdown menu, and select the <span class="P---Screen-Text">handsonaks-agentpool</span> identity and save. This process is shown in <em class="italics">Figure 12.9</em>:<div id="_idContainer383" class="IMG---Figure"><img src="image/B17338_12_09.jpg" alt="Giving AKS cluster permissions to access the managed identity"/></div><p class="figure">Figure 12.9: Giving AKS access to the managed identity</p></li>
				<li>You will now give Managed Identities permission to create resources on your subscription. To do this, look for <span class="P---Screen-Text">Subscriptions</span> in the Azure search bar, as shown in <em class="italics">Figure 12.10</em>, and then select your subscription:<div id="_idContainer384" class="IMG---Figure"><img src="image/B17338_12_10.jpg" alt="Searching for subscriptions in the Azure search bar"/></div><p class="figure">Figure 12.10: Looking for subscriptions in the Azure search bar</p></li>
				<li>In the <span class="P---Screen-Text">Subscription</span> pane, click on <span class="P---Screen-Text">Access control (IAM)</span>, click on the <span class="P---Screen-Text">+ Add</span> button at the top of the screen, click <span class="P---Screen-Text">Add role assignment</span>, select the <span class="P---Screen-Text">Contributor</span> role, select <span class="P---Screen-Text">User assigned managed identity</span> from the <span class="P---Screen-Text">Assign access to </span>dropdown menu, and select the <span class="P---Screen-Text">aso-mi</span> identity and save. This process is shown in <em class="italics">Figure 12.11</em>:</li>
			</ol>
			<div>
				<div id="_idContainer385" class="IMG---Figure">
					<img src="image/B17338_12_11.jpg" alt="Giving the aso-mi the contributor role at the subscription level"/>
				</div>
			</div>
			<p class="figure">Figure 12.11: Giving the aso-mi permissions to your subscription</p>
			<p>This completes the setup of the managed identity. In the next section, you will create a key vault and allow the managed identity you just created to create and read secrets. </p>
			<h3 id="_idParaDest-148"><a id="_idTextAnchor153"/>Creating a key vault</h3>
			<p>In this section, you will create the key vault that ASO will use to store connection strings and secrets. This is optional in the ASO setup process but recommended.</p>
			<ol>
				<li value="1">To start, look for key vaults in the Azure search bar, as shown in <em class="italics">Figure 12.12</em>:<div id="_idContainer386" class="IMG---Figure"><img src="image/B17338_12_12.jpg" alt="Searching for Key Vault in the Azure search bar"/></div><p class="figure">Figure 12.12: Looking for key vaults in the Azure search bar</p></li>
				<li>Click the <span class="P---Screen-Text">+ New</span> button at the top of the screen to create a new key vault. Select the ASO resource group you created earlier and give your key vault a name. Please note that your key vault name has to be unique, so consider adding extra characters to the name if it is not unique. Also, make sure to create the key vault in the same region as your AKS cluster. The resulting configuration is shown in <em class="italics">Figure 12.13</em>:<div id="_idContainer387" class="IMG---Figure"><img src="image/B17338_12_13.jpg" alt="Providing the necessary details to create a key vault"/></div><p class="figure">Figure 12.13: Key vault configuration</p></li>
				<li>Now select <span class="P---Screen-Text">Next: Access policy &gt;</span> to configure a new access policy. Here you will give the <span class="P---Screen-Text">aso-mi</span> managed identity you created in the previous section permission to do secret management in this key vault. To do this, start by clicking the<span class="P---Screen-Text"> + Add Access Policy</span> button, as shown in <em class="italics">Figure 12.14</em>:<div id="_idContainer388" class="IMG---Figure"><img src="image/B17338_12_14.jpg" alt="Clicking the Add access policy button"/></div><p class="figure">Figure 12.14: Clicking the + Add Access Policy button</p></li>
				<li>In the resulting popup, select the <span class="P---Screen-Text">Secret Management</span> template, then click on <span class="P---Screen-Text">None selected</span> to select your managed identity. In the resulting popup, look for the <span class="P---Screen-Text">aso-mi</span> managed identity, select it, and then click <span class="P---Screen-Text">Select</span> followed by clicking on <span class="P---Screen-Text">Add</span>, as shown in <em class="italics">Figure 12.15</em>:<div id="_idContainer389" class="IMG---Figure"><img src="image/B17338_12_15.jpg" alt="Adding the secret management permissions to the managed identity"/></div><p class="figure">Figure 12.15: Adding the secret management permissions to the managed identity</p></li>
				<li>This has configured the access policy in Key Vault. Now click the <span class="P---Screen-Text">Review + create</span> button, and in the last window hit <span class="P---Screen-Text">Create</span> to create the key vault. This should take a couple of minutes to complete.</li>
			</ol>
			<p>Once your key vault has been deployed, you are ready to start installing ASO, which will be explained in the next section.</p>
			<h3 id="_idParaDest-149"><a id="_idTextAnchor154"/>Setting up ASO on your cluster</h3>
			<p>Now that you have the required managed identity and Key Vault, you are ready to start deploying ASO on your cluster. You can do all these steps using Cloud Shell. Let's get started:</p>
			<ol>
				<li value="1">You created a new cluster in the <em class="italics">Creating a new AKS cluster</em> section. You will need to link the managed identity you created earlier to the cluster. The ASO components will be created in their own namespace, so you will also create a new namespace for this:<p class="snippet">kubectl create namespace azureoperator-system</p><p class="snippet">az aks pod-identity add --resource-group rg-handsonaks \</p><p class="snippet">  --cluster-name handsonaks --namespace azureoperator-system \</p><p class="snippet">  --name aso-identity-binding \</p><p class="snippet">  --identity-resource-id &lt;resource ID of managed identity&gt;</p></li>
				<li>Now you can install cert-manager on your cluster. You've done this once before in <em class="italics">Chapter 6</em>, <em class="italics">Securing your application with HTTPS</em>, but at the end of the chapter you were asked to remove this component. You can install it again using the following command:<p class="snippet">kubectl apply -f <a href="https://github.com/jetstack/cert-manager/releases/download/v1.1.0/cert-manager.yaml ">https://github.com/jetstack/cert-manager/releases/download/v1.1.0/cert-manager.yaml</a></p></li>
				<li>Track the deployment status of cert-manager using the following command:<p class="snippet">kubectl rollout status \</p><p class="snippet">  -n cert-manager deploy cert-manager-webhook</p><p>Wait until the rollout shows that it's successfully rolled out, as shown in <em class="italics">Figure 12.16</em>:</p><div id="_idContainer390" class="IMG---Figure"><img src="image/B17338_12_16.jpg" alt="Output verifying the roll-out status of cert-manager"/></div><p class="figure">Figure 12.16: Checking the rollout status of cert-manager</p></li>
				<li>Once cert-manager has fully rolled out, you can start the ASO installation. Start by adding the Helm repo for ASO using the following command:<p class="snippet">helm repo add azureserviceoperator \</p><p class="snippet"><a href="https://raw.githubusercontent.com/Azure/azure-service-operator/master/charts ">https://raw.githubusercontent.com/Azure/azure-service-operator/master/charts</a></p></li>
				<li>Next, you need to provide configuration values for your ASO installation. Open the <strong class="inline">values.yaml</strong> file that is part of the code sample that comes with this chapter using the following command:<p class="snippet">code values.yaml</p><p>Fill in all the required values in that file, as shown here:</p><p class="snippet">1   azureTenantID: "&lt;tenant ID&gt;"</p><p class="snippet">2   azureSubscriptionID: "&lt;subscription ID&gt;"</p><p class="snippet">3   azureOperatorKeyvault: "&lt;key vault name&gt;"</p><p class="snippet">4   azureClientID: "&lt;client ID&gt;"</p><p class="snippet">5   cloudEnvironment: AzurePublicCloud</p><p class="snippet">6   azureUseMI: true</p><p class="snippet">7   image:</p><p class="snippet">8     repository: mcr.microsoft.com/k8s/azureserviceoperator:0.1.16800</p><p class="snippet">9   installAadPodIdentity: true</p><p class="snippet">10  aad-pod-identity:</p><p class="snippet">11    azureIdentityBinding:</p><p class="snippet">12      name: aso-identity-binding</p><p class="snippet">13      selector: aso_manager_binding</p><p class="snippet">14    azureIdentity:</p><p class="snippet">15      enabled: True</p><p class="snippet">16      name: aso-identity</p><p class="snippet">17      type: 0</p><p class="snippet">18      resourceID: "&lt;resource ID&gt;"</p><p class="snippet">19      clientID: "&lt;client ID&gt;"</p><p>As shown in the previous code sample, you will need to provide your tenant ID, subscription ID, key vault name, client ID of the managed identity (twice), and resource ID of the managed identity. You can find the tenant ID and subscription ID with the following command:</p><p class="snippet">az account show</p><p>This will return an output similar to <em class="italics">Figure 12.17</em>, in which the tenant ID and subscription ID have been highlighted:</p><div id="_idContainer391" class="IMG---Figure"><img src="image/B17338_12_17.jpg" alt="Getting the subscription ID and tenant ID from the output"/></div><p class="figure">Figure 12.17: Getting the subscription ID and tenant ID</p></li>
				<li>Once you have the values filled in, you can install ASO using the following command:<p class="snippet">helm upgrade --install aso \</p><p class="snippet">  azureserviceoperator/azure-service-operator \</p><p class="snippet">  -n azureoperator-system --create-namespace \</p><p class="snippet">  -f values.yaml</p></li>
				<li>The installation process takes a couple of minutes. Wait until the following command returns a successful rollout:<p class="snippet">kubectl rollout status deploy \</p><p class="snippet">  -n azureoperator-system azureoperator-controller-manager</p><p>The output should look similar to <em class="italics">Figure 12.18</em>:</p><div id="_idContainer392" class="IMG---Figure"><img src="image/B17338_12_18.jpg" alt="Output verifying the status of the deployments for ASO"/></div><p class="figure">Figure 12.18: Checking the status of the deployments for ASO</p></li>
				<li>At the time of writing, there was an issue with the <strong class="inline">aadpodidbinding</strong> label on the deployment of <strong class="inline">azureoperator-controller-manager</strong>. This can, however, be fixed by applying a patch, to apply a new label to that deployment. The patch has been provided in the files for the chapter, specifically in the <strong class="inline">patch.yaml</strong> file:<p class="snippet">spec:</p><p class="snippet">  template:</p><p class="snippet">    metadata:</p><p class="snippet">      labels:</p><p class="snippet">        aadpodidbinding: aso-identity-binding</p><p>As you can see, the patch itself applies a new label to the pods in the deployment. You can apply the patch using the following command:</p><p class="snippet">kubectl patch deployment \</p><p class="snippet">  azureoperator-controller-manager \</p><p class="snippet">  -n azureoperator-system \</p><p class="snippet">  --patch "$(cat patch.yaml)"</p><p>This will ensure that you can use ASO in the next section.</p></li>
			</ol>
			<p>Now that ASO has been deployed on your cluster, you are ready to start deploying Azure resources using Kubernetes and ASO. You will do that in the next section.</p>
			<h2 id="_idParaDest-150"><a id="_idTextAnchor155"/>Deploying Azure Database for MySQL using ASO</h2>
			<p>In the previous section, you deployed ASO on your Kubernetes cluster. This means that now you can use the Kubernetes API to deploy Azure resources. In this section, you will create a MySQL database running on the Azure Database for MySQL service using YAML files that you will submit to Kubernetes using <strong class="inline">kubectl</strong>. Let's get started:</p>
			<ol>
				<li value="1">First, you need to create a resource group. The code for the resource group definition is also available in the code samples with this chapter. Create this file and save it as <strong class="inline">rg.yaml</strong>:<p class="snippet">apiVersion: azure.microsoft.com/v1alpha1</p><p class="snippet">kind: ResourceGroup</p><p class="snippet">metadata:</p><p class="snippet">  name: aso-resources</p><p class="snippet">spec:</p><p class="snippet">  location: &lt;cluster location&gt;</p><p>As you can see in the code for the resource, <strong class="inline">apiVersion</strong> refers to <strong class="inline">azure.microsoft.com</strong> and <strong class="inline">kind</strong> is <strong class="inline">ResourceGroup</strong>. Furthermore, you provide the details for the resource group, being its name and its location. Make sure to change <strong class="inline">location</strong> to the location of your cluster.</p><p>You can create this resource group using the following command:</p><p class="snippet">kubectl create -f rg.yaml</p><p>To monitor the process of the resource group creation, you can use the following command:</p><p class="snippet">kubectl get resourcegroup -w</p><p>This returns an output similar to <em class="italics">Figure 12.19</em>:</p><div id="_idContainer393" class="IMG---Figure"><img src="image/B17338_12_19.jpg" alt="Output confirming the successful creation of a new resource group"/></div><p class="figure">Figure 12.19: Monitoring the creation of a new resource group</p></li>
				<li>Let's also verify that the resource group was created in Azure. To do so, look for the resource group name (<strong class="inline">aso-resources</strong>, in this example) in the Azure search bar, as shown in <em class="italics">Figure 12.20</em>:<div id="_idContainer394" class="IMG---Figure"><img src="image/B17338_12_20.jpg" alt="Searching for the resource group in the Azure search bar"/></div><p class="figure">Figure 12.20: Searching for the resource group in the Azure portal</p><p>As you can see, the resource group is returned in the search results, meaning the resource group was successfully created.</p></li>
				<li>Now you can create the MySQL server. You won't create a virtual machine to run MySQL, but rather create a managed MySQL server on Azure. To create this, you can use the <strong class="inline">mysql-server.yaml</strong> file that is provided for you:<p class="snippet">1   apiVersion: azure.microsoft.com/v1alpha1</p><p class="snippet">2   kind: MySQLServer</p><p class="snippet">3   metadata:</p><p class="snippet">4     name: &lt;mysql-server-name&gt;</p><p class="snippet">5   spec:</p><p class="snippet">6     location: &lt;cluster location&gt;</p><p class="snippet">7     resourceGroup: aso-resources</p><p class="snippet">8     serverVersion: "8.0"</p><p class="snippet">9     sslEnforcement: Disabled</p><p class="snippet">10    createMode: Default</p><p class="snippet">11    sku:</p><p class="snippet">12      name: B_Gen5_1</p><p class="snippet">13      tier: Basic</p><p class="snippet">14      family: Gen5</p><p class="snippet">15      size: "5120"</p><p class="snippet">16      capacity: 1</p><p>This file contains specific configurations for the MySQL server. A number of elements are worth pointing out:</p><ul><li><strong class="bold">Line 2</strong>: Here you define that you will create a <strong class="inline">MySQLServer</strong> instance.</li><li><strong class="bold">Line 4</strong>: Here you give the server a name. This name has to be globally unique, so consider appending your initials to the server name.</li><li><strong class="bold">Line 6</strong>: The location of the MySQL server you will create. Make sure to change <strong class="inline">location</strong> to the location of your cluster.</li><li><strong class="bold">Line 9</strong>: <strong class="inline">sslEnforcement</strong> is disabled for this demo. This has been done to make the demo easier to follow. If you create a production cluster, it is highly recommended to enable <strong class="inline">sslEnforcement</strong>.</li><li><strong class="bold">Line 11-16</strong>: Here you define the size of the MySQL server. In this case, you are creating a basic server with 5 GB of capacity. If you plan to use this for production use cases, you will likely need a larger server.</li></ul><p>You can create the MySQL server using the following command:</p><p class="snippet">kubectl create -f mysql-server.yaml</p><p>This will take a couple of minutes to complete. You can follow the progress using the following command:</p><p class="snippet">kubectl get mysqlserver -w </p><p>This will return an output similar to <em class="italics">Figure 12.21</em>:</p><div id="_idContainer395" class="IMG---Figure"><img src="image/B17338_12_21.jpg" alt="Output confirming the successful creation of a new MySQL server"/></div><p class="figure">Figure 12.21: Monitoring the creation of the MySQL server</p><p>If you were to run into errors when creating the MySQL server, please refer to the ASO documentation at <a href="https://github.com/Azure/azure-service-operator/blob/master/docs/troubleshooting.md">https://github.com/Azure/azure-service-operator/blob/master/docs/troubleshooting.md</a>.</p><p>Once you get the message that the server has successfully been provisioned, you can exit out of this command by pressing <em class="italics">Ctrl + C</em>.</p></li>
				<li>After the MySQL server, you can create the MySQL database. The definition of the MySQL database has been provided in the <strong class="inline">mysql-database.yaml</strong> file:<p class="snippet">1   apiVersion: azure.microsoft.com/v1alpha1</p><p class="snippet">2   kind: MySQLDatabase</p><p class="snippet">3   metadata:</p><p class="snippet">4     name: wordpress-db</p><p class="snippet">5   spec:</p><p class="snippet">6     resourceGroup: aso-resources</p><p class="snippet">7     server: &lt;mysql-server-name&gt;</p><p>The definition of the database is providing a name and referring to the server you created earlier. To create the database, you can use the following command:</p><p class="snippet">kubectl create -f mysql-database.yaml</p><p>This will take a couple of seconds to complete. You can follow the progress using the following command:</p><p class="snippet">kubectl get mysqldatabase -w </p><p>This will return an output similar to <em class="italics">Figure 12.22</em>:</p><div id="_idContainer396" class="IMG---Figure"><img src="image/B17338_12_22.jpg" alt="Output confirming the successful creation of a MySQL database"/></div><p class="figure">Figure 12.22: Monitoring the creation of the MySQL database</p><p>Once you get the message that the database has successfully been provisioned, you can exit out of this command by pressing <em class="italics">Ctrl + C</em>.</p></li>
				<li>You can create a firewall rule that will allow traffic to your database. In this example, you will create a rule that will allow traffic from all sources. In a production environment, this is not recommended. For the recommended networking configurations for Azure Database for MySQL, please refer to the documentation: <a href="https://docs.microsoft.com/azure/mysql/flexible-server/concepts-networking">https://docs.microsoft.com/azure/mysql/flexible-server/concepts-networking</a>.The configuration for the firewall rule has been provided in the <strong class="inline">mysql-firewall.yaml</strong> file:<p class="snippet">1   apiVersion: azure.microsoft.com/v1alpha1</p><p class="snippet">2   kind: MySQLFirewallRule</p><p class="snippet">3   metadata:</p><p class="snippet">4     name: allow-all-mysql</p><p class="snippet">5   spec:</p><p class="snippet">6     resourceGroup: aso-resources</p><p class="snippet">7     server: &lt;mysql-server-name&gt;</p><p class="snippet">8     startIpAddress: 0.0.0.0</p><p class="snippet">9     endIpAddress: 255.255.255.255</p><p>As you can see, we refer to the MySQL server that was created earlier and allow traffic from all IP addresses (meaning from <strong class="inline">0.0.0.0</strong> to <strong class="inline">255.255.255.255</strong>).</p><p>To create the firewall rule, you can use the following command:</p><p class="snippet">kubectl create -f mysql-firewall.yaml</p><p>This will take a couple of seconds to complete. You can follow the progress using the following command:</p><p class="snippet">kubectl get mysqlfirewallrule -w </p><p>This will return an output similar to <em class="italics">Figure 12.23</em>:</p><div id="_idContainer397" class="IMG---Figure"><img src="image/B17338_12_23.jpg" alt="Output confirming the successful creation of a MySQL firewall rule"/></div><p class="figure">Figure 12.23: Monitoring the creation of the MySQL firewall rule</p><p>Once you get the message that the firewall rule has successfully been provisioned, you can exit out of this command by pressing <em class="italics">Ctrl + C</em>.</p></li>
				<li>Let's verify that all of this was successfully created in the Azure portal. To do so, start by searching for the MySQL server name (<strong class="inline">wp-helm-mysql</strong> in this example) in the Azure search bar as shown in <em class="italics">Figure 12.24</em>. Click on the server to go to the details:<div id="_idContainer398" class="IMG---Figure"><img src="image/B17338_12_24.jpg" alt="Searching for the MySQL server using the Azure search bar"/></div><p class="figure">Figure 12.24: Searching for the MySQL server in the Azure portal</p></li>
				<li>This will take you to the <span class="P---Screen-Text">Overview</span> pane of the MySQL server. Scroll down in this pane and expand the <span class="P---Screen-Text">Available resources</span> section. Here you should see that <span class="P---Screen-Text">wordpress-db</span> was created, as shown in <em class="italics">Figure 12.25</em>:<div id="_idContainer399" class="IMG---Figure"><img src="image/B17338_12_25.jpg" alt="The database created through ASO as shown in the Azure portal"/></div><p class="figure">Figure 12.25: The database created through ASO is shown in the Azure portal</p></li>
				<li>From the MySQL server pane, click on <span class="P---Screen-Text">Connection security</span> in the left-hand navigation to verify the firewall rule. You should see the firewall rule you created through ASO on this pane, as shown in <em class="italics">Figure 12.26</em>:</li>
			</ol>
			<div>
				<div id="_idContainer400" class="IMG---Figure">
					<img src="image/B17338_12_26.jpg" alt="The firewall rule created through ASO is set on the MySQL server"/>
				</div>
			</div>
			<p class="figure">Figure 12.26: The firewall rule created through ASO is set on the MySQL server</p>
			<p>This verifies that you were able to create a MySQL server with a database in Azure and configure its firewall settings.</p>
			<p>In this section, you've used ASO to create a MySQL server, as well as a database on that server, and then finally configured its firewall. You were able to do all of this using Kubernetes YAML files. ASO translated those YAML files to Azure and created the resources for you. Finally, you were able to confirm everything was created and configured in the Azure portal.</p>
			<p>In the next and final section, you will use this database to support the WordPress application. </p>
			<h2 id="_idParaDest-151"><a id="_idTextAnchor156"/>Creating an application using the MySQL database</h2>
			<p>You now have a MySQL database. To showcase that you can use this database to configure an application, you will use the WordPress application. You can install this using Helm and provide the connection information to your database in the Helm configuration:</p>
			<ol>
				<li value="1">To start, you will need the connection information to your database server. When you installed ASO on your cluster, you configured it to use Key Vault as a secret store rather than Kubernetes secrets. You will need this connection information to connect WordPress to your Azure MySQL database.Search for <strong class="inline">Key Vaults</strong> in the Azure search bar, as shown in <em class="italics">Figure 12.27</em>, click on <span class="P---Screen-Text">Key vaults</span>, and then select the key vault you created earlier in the chapter:<div id="_idContainer401" class="IMG---Figure"><img src="image/B17338_12_27.jpg" alt="Searching for Key Vault using the Azure search bar"/></div><p class="figure">Figure 12.27: Searching for key vaults in the Azure portal</p></li>
				<li>In the resulting pane, click on <span class="P---Screen-Text">Secrets</span> in the left-hand navigation and then click on the secret, as shown in <em class="italics">Figure 12.28</em>. The name of this secret follows the naming convention <strong class="inline">&lt;object type&gt;-&lt;Kubernetes namesapce&gt;-&lt;object name&gt;</strong>. <div id="_idContainer402" class="IMG---Figure"><img src="image/B17338_12_28.jpg" alt="The MySQL secret in the Azure portal"/></div><p class="figure">Figure 12.28: The MySQL secret in the Azure portal</p></li>
				<li>You will then get a view with multiple versions of your secret; click the current version as shown in <em class="italics">Figure 12.29</em>:<div id="_idContainer403" class="IMG---Figure"><img src="image/B17338_12_29.jpg" alt="Different versions of the secret in Key Vault"/></div><p class="figure">Figure 12.29: Different secret versions in your key vault</p><p>Now, copy the value of the secret, as shown in <em class="italics">Figure 12.30</em>:</p><div id="_idContainer404" class="IMG---Figure"><img src="image/B17338_12_30.jpg" alt="Clicking the Copy to clipboard button to copy the value of the secret"/></div><p class="figure">Figure 12.30: Copying the value of the secret to clipboard</p></li>
				<li>The secret contains several pieces of information related to your database connection that you will need for the Helm installation. It contains the fully qualified server name, the username, and the password. The values in the secret are Base64 encoded. To make working with this secret easier, a shell script has been provided that will give you the required decoded values. To run this script, use the following command:<p class="snippet">sh decode-secret.sh &lt;secret value&gt;</p><p>An example is shown in <em class="italics">Figure 12.31</em>:</p><div id="_idContainer405" class="IMG---Figure"><img src="image/B17338_12_31.jpg" alt="Running a script to generate decoded values of the secret"/></div><p class="figure">Figure 12.31: Decoding the secret</p></li>
				<li>You can use the values outputted by the previous step to configure Helm to use your Azure MySQL database. The following Helm command will set up WordPress on your cluster, but use an external database:<p class="snippet">helm repo add bitnami https://charts.bitnami.com/bitnami</p><p class="snippet">helm install wp bitnami/wordpress \</p><p class="snippet">  --set mariadb.enabled=false \ </p><p class="snippet">  --set externalDatabase.host='&lt;decoded host value&gt;' \</p><p class="snippet">  --set externalDatabase.user='&lt;decoded user value&gt;' \</p><p class="snippet">  --set externalDatabase.password='&lt;decoded password value&gt;' \</p><p class="snippet">  --set externalDatabase.database='wordpress-db' \</p><p class="snippet">  --set externalDatabase.port='3306'</p><p>As you can see, with this command, you disabled the MariaDB installation by setting the <strong class="inline">mariadb.enabled</strong> value to <strong class="inline">false</strong> and then provided the connection information to the external database.</p><p>To monitor the setup of WordPress, you can use the following command:</p><p class="snippet">kubectl get pods -w</p><p>This will take a couple of minutes to fully set up, and finally, you should see the WordPress pod in a running state and ready, as shown in <em class="italics">Figure 12.32</em>:</p><div id="_idContainer406" class="IMG---Figure"><img src="image/B17338_12_32.jpg" alt="Output displaying the WordPress pod in a running state"/></div><p class="figure">Figure 12.32: WordPress pod in a running state</p><p>Once the pod is running and ready, you can stop this command by pressing <em class="italics">Ctrl + C</em>. If you remember the WordPress deployment in <em class="italics">Chapter 3</em>, <em class="italics">Application deployment on AKS</em>, there was a second pod present in the WordPress installation hosting a MariaDB database. This pod is no longer there since we replaced it with an Azure MySQL database.</p></li>
				<li>Let's now finally connect to this WordPress application. You can get the public IP address of the WordPress website using the following command:<p class="snippet">kubectl get service</p><p>This will show you the public IP, as shown in <em class="italics">Figure 12.33</em>:</p><div id="_idContainer407" class="IMG---Figure"><img src="image/B17338_12_33.jpg" alt="Getting the public IP of the WordPress website from the output"/></div><p class="figure"> </p><p class="figure">Figure 12.33: Getting the public IP of the WordPress website</p><p>Enter this IP address in your web browser's address bar and hit <em class="italics">Enter</em>. You should be able to see the WordPress landing page with the default demo post, as shown in <em class="italics">Figure 12.34</em>:</p><div id="_idContainer408" class="IMG---Figure"><img src="image/B17338_12_34.jpg" alt="Browsing to the WordPress website"/></div><p class="figure"> Figure 12.34: Browsing to the WordPress website</p><p>You now have a fully functional WordPress website hosted on Kubernetes, with the database being backed by Azure Database for MySQL.</p></li>
				<li>This concluded the examples from this chapter. You created a number of resources and installed a number of cluster components. Let's also clean them up from the cluster using the following commands:<p class="snippet">helm uninstall wp</p><p class="snippet">kubectl delete -f mysql-firewall.yaml</p><p class="snippet">kubectl delete -f mysql-database.yaml</p><p class="snippet">kubectl delete -f mysql-server.yaml</p><p class="snippet">kubectl delete -f rg.yaml</p><p class="snippet">helm uninstall aso -n azureoperator-system</p><p class="snippet">az aks pod-identity delete --resource-group rg-handsonaks \</p><p class="snippet">  --cluster-name handsonaks --namespace azureoperator-system \</p><p class="snippet">  --name aso-identity-binding</p><p class="snippet">kubectl delete namespace azureoperator-system</p><p class="snippet">kubectl delete -f <a href="https://github.com/jetstack/cert-manager/releases/download/v1.1.0/cert-manager.yaml ">https://github.com/jetstack/cert-manager/releases/download/v1.1.0/cert-manager.yaml</a></p><p class="snippet">az group delete -n aso --yes</p></li>
			</ol>
			<p>You've been able to connect an application on Kubernetes to an Azure-managed MySQL database. You used the WordPress Helm chart and provided custom values to configure this Helm chart to make it connect to the managed database.</p>
			<h2 id="_idParaDest-152"><a id="_idTextAnchor157"/>Summary</h2>
			<p>This chapter introduced <strong class="bold">Azure Service Operator</strong> (<strong class="bold">ASO</strong>). ASO is an open-source project that makes it possible to create Azure services using Kubernetes. This allows you as the user to not have to switch between the Azure portal or CLI and Kubernetes resource definitions.</p>
			<p>In this chapter, you created a new AKS cluster and then installed ASO on this cluster. You then created a MySQL database on Azure using ASO. You verified that this database was available in Azure using the Azure portal.</p>
			<p>Finally, you created a WordPress application on your Kubernetes cluster that connected to the external database. You verified that the application was running and available as you've seen in previous chapters.</p>
			<p>In the next chapter, you will learn about other Azure integrations with AKS, namely Azure Security Center and Azure Defender for Kubernetes, which are used to monitor the security configuration of your cluster and mitigate threats.</p>
		</div>
	</body></html>