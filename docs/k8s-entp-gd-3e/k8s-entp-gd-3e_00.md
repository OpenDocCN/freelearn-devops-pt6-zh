# 序言

Kubernetes 已经风靡全球，成为 DevOps 团队开发、测试和运行应用程序的标准基础设施。大多数企业要么已经在使用它，要么计划在明年内使用它。从任何一个主要招聘网站上的职位发布可以看出，几乎每个大公司都有 Kubernetes 相关的职位空缺。Kubernetes 的快速普及导致与 Kubernetes 相关的职位在过去四年中增长了超过 2000%。

公司普遍面临的一个常见问题是缺乏企业级的 Kubernetes 知识。虽然 Kubernetes 已经不再是新技术（它刚刚迎来 10 周年！），但企业在构建能够可靠运行集群的团队方面仍然存在困难。它们还面临如何跨多个孤岛和技术栈整合 Kubernetes 工作负载的问题，这些问题在企业环境中很常见。虽然找到具备基础 Kubernetes 技能的人变得更加容易，但要找到具备企业集群所需的专业知识的人仍然是一个挑战。

# 本书适合谁阅读

我们编写本书是为了帮助 DevOps 团队将技能扩展到 Kubernetes 基础之外。本书的内容源自我们在多个企业环境中与集群合作的多年经验。

市面上有许多书籍介绍 Kubernetes 及其集群安装、创建部署（Deployments）和使用 Kubernetes 对象的基础知识。我们的计划是编写一本超越基本集群的书，为了保持书籍的合理长度，我们没有重新阐述 Kubernetes 的基础知识。读者在阅读本书之前应该有一定的 Kubernetes 和 DevOps 经验。

本书的主要焦点是扩展集群的企业功能，但书的第一部分将复习一些关键的 Docker 主题和 Kubernetes 对象。理解 Kubernetes 对象是非常重要的，这样你才能在后续更高级的章节中充分获得收获。

# 本书内容概述

*第一章*，*Docker 和容器基础*，介绍了 Docker 和 Kubernetes 为开发人员解决的问题。本章将带你了解 Docker，包括 Docker 守护进程、数据、安装以及如何使用 Docker 命令行工具（CLI）。

*第二章*，*使用 KinD 部署 Kubernetes*，介绍了如何使用 KinD 创建开发集群。KinD 是一个强大的工具，允许你创建从单节点集群到完整的多节点集群的各种集群。本章不仅介绍了基本的**KinD**集群，还解释了如何使用运行**HAProxy**的负载均衡器对工作节点进行负载均衡。通过本章的学习，你将理解 KinD 的工作原理以及如何创建一个自定义的多节点集群，后续章节中的练习将使用这个集群。

*第三章*，*Kubernetes 入门训练营*，提供了关于 Kubernetes 的复习内容。本章将覆盖集群中包含的大多数对象，这对于初学者来说非常有帮助。它将通过描述每个对象的功能和在集群中的作用来解释每个对象。这是一个复习篇，或者说是对象的“口袋指南”。它不包含每个对象的详尽细节（那需要另一本书）。

*第四章*，*服务、负载均衡和网络策略*，解释了如何使用服务公开 Kubernetes 部署。每种服务类型都将通过示例进行解释，并且您将学习如何使用第七层和第四层负载均衡器公开它们。在本章中，您将超越简单的 Ingress 控制器的基础知识，安装 **MetalLB**，为服务提供第四层访问。最后，您将学习如何通过使用 Kubernetes 网络策略在 pod 之间提供细粒度控制，从而增强集群内的安全性和合规性。

*第五章*，*外部 DNS 和全局负载均衡*，将使您了解两个增强企业集群的附加组件，通过安装一个名为`external-dns`的孵化器项目，为 MetalLB 所暴露的服务提供动态名称解析。您还将学习如何向您的集群添加**全局负载均衡器**，使用名为 **K8GB** 的项目，它提供原生 Kubernetes 全局负载均衡。

*第六章*，*将身份验证集成到您的集群*，回答了一个问题：“一旦构建了您的集群，用户将如何访问它？”在本章中，我们将详细介绍 OpenID Connect 的工作原理，以及为什么应该使用它来访问您的集群。您还将学习如何对您的流水线进行身份验证，最后，我们还将涵盖几种应该避免的反模式，并解释为什么应该避免它们。

*第七章*，*RBAC 策略和审计*，解释了一旦用户访问集群，您需要知道如何限制他们的访问。无论您是向用户提供整个集群还是只是一个命名空间，您都需要知道 Kubernetes 如何通过其**基于角色的访问控制**（RBAC）系统授权访问。在本章中，我们将详细介绍如何设计 RBAC 策略，如何调试它们，以及多租户的不同策略。

*第八章*，*管理机密*，集中讨论了 Kubernetes 世界中最难实现的问题之一：如何管理机密数据。首先，我们将看看在 Kubernetes 中管理机密的挑战。然后，我们将了解 HashiCorp 的 **Vault** 用于机密管理。最后，我们将使用 **Vault sidecar** 和流行的 **External Secrets Operator** 将我们的集群与 Vault 集成。

*第九章*，*使用 vClusters 构建多租户集群*，从单一集群开始，逐步实现将集群拆分为多个租户，采用 Loft 的 **vCluster** 项目。你将学习 vClusters 的工作原理，它们如何与主机集群交互，如何安全地访问它们，以及如何为你的租户自动化部署。我们还将基于 *第八章* 的学习，将管理的 Secrets 集成到我们的 vClusters 中！

*第十章*，*部署安全的 Kubernetes Dashboard*，讲解了 Kubernetes Dashboard，它通常是用户在集群启动并运行后尝试启动的第一个工具。关于安全性（或缺乏安全性）有许多误解。本章还讨论了集群中可能存在的其他 Web 应用程序，例如网络仪表盘、日志系统和监控仪表盘。本章重点讲解了如何设计仪表盘架构，如何正确地保障其安全，并通过实际案例展示了不当部署的示例，并解释了其中的原因。

*第十一章*，*使用 Open Policy Agent 扩展安全性*，为你提供了部署 **Open Policy Agent** 和 **GateKeeper** 的指导，帮助你实现一些 RBAC 无法完成的策略。我们将介绍如何部署 Gatekeeper，如何用 Rego 编写策略，并且如何使用 OPA 自带的测试框架来测试这些策略。

*第十二章*，*通过 Gatekeeper 实现节点安全性*，探讨了运行你 Pod 的节点安全性。我们将讨论如何安全地设计容器，使它们更难以被滥用，并且如何使用 GateKeeper 编写策略，防止你的容器访问它们不需要的资源。

*第十三章*，*KubeArmor 安全保护运行时环境*，介绍了安全性，它是每个人的责任，为应对攻击向量提供工具是运行一个安全且具有弹性的集群的关键。在本章中，你将学习如何使用一个名为 **KubeArmor** 的 CNCF 项目来保护你的容器运行时。KubeArmor 提供了一种简便的方法，通过易于理解的策略来锁定容器。

*第十四章*，*工作负载备份*，介绍了如何使用 **Velero** 创建集群工作负载的备份，以便灾难恢复或集群迁移。你将亲手操作，使用 MinIO 创建一个兼容 S3 的存储位置，备份示例工作负载和持久存储。然后，你会将备份恢复到一个全新的集群，以模拟集群迁移。

*第十五章*，*监控集群和工作负载*，探讨了如何使用**Prometheus**和**OpenSearch**来了解集群的健康状况。你将首先了解 Kubernetes 和 Prometheus 如何处理指标，然后我们将部署 Prometheus 堆栈以及**Alertmanager**和**Grafana**。你将学习如何确保堆栈的安全，并了解如何扩展堆栈以监控其他工作负载。在完成监控部分后，我们将转向使用 OpenSearch 进行日志聚合。我们将从探索 Kubernetes 中的日志工作原理开始，接着集成 OpenSearch，并最后使用**OpenUnison**来保护对 OpenSearch 的访问。

*第十六章*，*Istio 简介*，解释了许多企业使用服务网格为集群提供高级功能，如安全性、流量路由、身份验证、追踪和可观察性。本章将介绍 Istio——一个流行的开源网格及其架构，并介绍它所提供的最常用资源。你将通过一个示例应用程序将 Istio 部署到 KinD 集群，并学习如何使用一个名为 Kiali 的可观察性工具来观察应用程序的行为。

*第十七章*，*在 Istio 上构建和部署应用程序*，意识到一旦你部署了 Istio，你就会希望开发和部署使用它的应用程序！本章首先介绍单体应用和微服务的区别及其部署方式。接着，我们将一步步构建一个运行在 Istio 中的微服务，并深入讨论一些高级话题，如身份验证、授权以及服务到服务的身份验证。你还将学习如何利用 Kubernetes 中现有的角色，通过 OIDC 提供程序和 JSON Web 令牌来保护 Kiali 的访问。你还将学习如何使用 JWT 保护 Istio 服务，以及如何使用令牌交换来安全地访问不同的服务，从一个服务安全地移动到另一个服务。最后，我们将使用 OPA 创建一个自定义授权规则，并在 Istio 中进行配置。

*第十八章*，*构建多租户平台*，探讨了如何构建管道，如何自动化它们的创建，以及它们与 GitOps 的关系。我们将探讨用于驱动管道的对象之间的关系，如何建立系统之间的关系，并最终设计一个自服务工作流来自动化管道的部署。

*第十九章*，*构建开发者门户*，基于*第十八章*的设计，构建一个多租户平台，并使用本书中提到的许多工具。我们将从构建一个实验室开始，以运行我们的多租户集群。接下来，我们将部署 Kubernetes 到三个集群，并将它们与 GitLab、Vault、Argo CD、Harbor 和 OpenUnison 集成。最后，我们将介绍如何使用 OpenUnison 的自服务门户将新的 vCluster 租户进行入驻。

# 要充分利用本书

+   你应该具备 Linux 基础知识，了解基本命令、Git 等工具，并能够使用如 Vi 的文本编辑器。

+   本书的章节包含了理论与实践练习。我们认为，练习有助于巩固理论知识，但理解每个主题并不一定需要做这些练习。如果你想做书中的练习，你需要满足下表中的要求：

| **章节练习要求** | **版本** |
| --- | --- |
| Ubuntu 服务器 | 22.04 或更高版本 |

所有练习使用 Ubuntu，但大多数也适用于其他 Linux 发行版。

## 下载示例代码文件

本书的代码包托管在 GitHub 上：[`github.com/PacktPublishing/Kubernetes-An-Enterprise-Guide-Third-Edition`](https://github.com/PacktPublishing/Kubernetes-An-Enterprise-Guide-Third-Edition)。我们还提供了其他来自我们丰富的图书和视频目录的代码包，网址：[`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)。快去看看吧！

## 下载彩色图像

我们还提供了一个 PDF 文件，包含了本书中使用的截图/图表的彩色图像。你可以在这里下载：[`packt.link/gbp/9781835086957`](https://packt.link/gbp/9781835086957)。

## 补充内容

这是一个链接，指向 YouTube 频道（由作者 Marc Boorshtein 和 Scott Surovich 创建和管理），其中包含本书实验室的视频，因此在你开始动手之前，你可以先看到它们的演示：[`packt.link/N5qjd`](https://packt.link/N5qjd)。

## 使用的约定

本书中使用了多种文本约定。

`CodeInText`：表示文本中的代码词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟 URL、用户输入和 Twitter 用户名。例如：“`--name`选项将集群名称设置为`cluster01`，而`--config`指示安装程序使用`cluster01-kind.yaml`配置文件。”

代码块如下所示：

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: grafana
  name: grafana
  namespace: monitoring 
```

当我们希望引起你对代码块中特定部分的注意时，相关行或项目会以粗体显示：

```
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
**app:****grafana**
  name: grafana
  namespace: monitoring 
```

任何命令行输入或输出都会如下所示：

```
PS C:\Users\mlb> kubectl create ns not-going-to-work
namespace/not-going-to-work created 
```

**粗体**：表示新术语、重要词汇或屏幕上看到的词汇，例如在菜单或对话框中，也像这样在文本中出现。例如：“点击屏幕底部的**完成登录**按钮。”

警告或重要说明像这样显示。

提示和技巧像这样显示。

# 联系我们

我们总是欢迎读者的反馈。

**一般反馈**：发送电子邮件至 feedback@packtpub.com，并在邮件主题中注明书名。如果你对本书的任何部分有疑问，请通过 questions@packtpub.com 与我们联系。

**勘误表**：尽管我们已经尽力确保内容的准确性，但错误难免会发生。如果您在本书中发现任何错误，我们将非常感激您能向我们报告。请访问 [`www.packtpub.com/submit-errata`](http://www.packtpub.com/submit-errata)，选择您的书籍，点击“勘误提交表单”链接，并输入详细信息。

**盗版**：如果您在互联网上发现任何非法复制的我们的作品，无论是什么形式，我们将非常感激您能提供该位置地址或网站名称。请通过 copyright@packtpub.com 联系我们，并附上相关资料链接。

**如果您有兴趣成为作者**：如果您在某个领域拥有专长并有意写书或为书籍作贡献，请访问 [`authors.packtpub.com`](http://authors.packtpub.com)。

# 分享您的想法

一旦您阅读完 *Kubernetes - 企业指南（第三版）*，我们很想听听您的想法！请 [点击此处直接进入亚马逊评价页面](https://packt.link/r/1835086950)，分享您的反馈。

您的评价对我们以及技术社区都非常重要，将帮助我们确保提供优质的内容。

# 下载本书的免费 PDF 版本

感谢您购买本书！

您是否喜欢随时随地阅读，但又不能随身携带纸质书籍？

您购买的电子书是否与您选择的设备不兼容？

不用担心，现在购买每本 Packt 书籍时，您将免费获得该书的 DRM-free PDF 版本。

在任何地方、任何设备上阅读。直接从您最喜欢的技术书籍中搜索、复制和粘贴代码到您的应用程序中。

优惠不止于此，您还可以每天在邮箱中收到独家折扣、新闻通讯和精彩的免费内容。

按照这些简单的步骤即可享受福利：

1.  扫描二维码或访问以下链接：

![](img/B21165_Free_PDF_QR.png)

[`packt.link/free-ebook/9781835086957`](https://packt.link/free-ebook/9781835086957)

1.  提交您的购买证明。

1.  就是这样！我们将直接把您的免费 PDF 和其他福利发送到您的邮箱。
