# 前言

你好，欢迎！*Grafana 的可观察性*是一本关于 Grafana Labs 提供的可观察性和监控工具的书。Grafana Labs 是业界领先的开源工具提供商，致力于收集、存储和可视化来自 IT 系统的数据。本书主要面向将与这些系统交互的 IT 工程师，无论他们从事哪个领域的工作。

我们写这本书是因为我们在各个组织中看到了很多常见的问题：

+   设计时没有考虑扩展策略的系统，正在面临额外的数据负载或团队使用该系统的压力

+   组织中未能正确归因运营成本，导致成本分析和管理不善

+   事件管理流程将参与其中的人视作没有睡眠周期或副交感神经系统的机器人

在本书中，我们将使用 OpenTelemetry 演示应用程序来模拟真实世界的环境，并将收集到的数据发送到我们将创建的免费的 Grafana Cloud 账户。这将引导你通过 Grafana 工具来收集遥测数据，同时也让你亲身体验使用 Grafana 提供的管理和支持工具。这种方法将教你如何以一种让任何人都可以独立尝试和学习的方式运行 Grafana 工具。

这是 Grafana 的一个激动人心的时刻，它被认定为*2023 年 Gartner 可观察性魔力象限*中的远见者（[`www.gartner.com/en/documents/4500499`](https://www.gartner.com/en/documents/4500499)）。他们最近在两个趋势领域做出了变革：

+   **成本降低**：这使得 Grafana 成为可观察性领域首个推出工具的供应商，这些工具不仅帮助你理解成本，还能降低成本。

+   **人工智能**（**AI**）：Grafana 推出了生成性 AI 工具，帮助日常操作以简单而有效的方式进行，例如自动撰写事件总结。Grafana Labs 最近还收购了*Asserts.ai*，以简化根本原因分析并加速问题检测。

我们希望你喜欢和我们一起学习一些新东西，并且在过程中获得乐趣！

# 本书适合的人群

IT 工程师、支持团队和领导者可以获得关于如何将可观察性平台的巨大功能引入到他们组织的实际见解。本书将重点介绍以下领域的工程师：

+   **软件开发**：学习如何快速对应用程序进行仪器化并生成出色的可视化，使得应用程序能够轻松支持

+   **运维团队**（DevOps、运维、网站可靠性、平台或基础设施）：学习如何管理可观察性平台或其他关键基础设施平台，并像管理任何其他应用程序一样管理这些平台

+   **支持团队**：学习如何与开发和运维团队密切合作，建立良好的可视化和警报机制，以便快速响应客户需求和 IT 事件

本书还将明确阐述领导力在事件管理、成本管理以及为这个强大数据集建立准确数据模型中的作用。

# 本书涵盖的内容

*第一章*，*介绍可观测性和 Grafana 堆栈*，介绍了 Grafana 产品堆栈与整体可观测性之间的关系。您将了解目标受众以及这如何影响您的设计。我们将查看可观测性工具的路线图，并比较 Grafana 与其他解决方案的优劣。我们还将探讨架构部署模型，从自托管到云端解决方案。最终，您将获得关于“为什么选择 Grafana？”的答案。

*第二章*，*对应用程序和基础设施进行监控*，从高层次介绍了每种遥测类型的常见协议和最佳实践。您将了解多个编程语言中广泛使用的库，这些库使得对应用程序的监控变得简单。还将讨论从基础设施组件收集数据的常见协议和策略。本章提供了技术领域的高层次概述，旨在成为快速参考的重要资料。

*第三章*，*使用演示应用程序设置学习环境*，解释了如何安装和设置一个支持后续章节学习的环境。您还将学习如何探索演示应用程序产生的遥测数据，并为自己的服务添加监控。

*第四章*，*使用 Loki 查看日志*，带您通过工作示例理解 LogQL。然后，您将了解常见的日志格式及其优缺点。最后，您将了解 Loki 的重要架构设计，并掌握与其合作时的最佳实践。

*第五章*，*使用 Grafana Mimir 和 Prometheus 进行度量监控*，讨论了通过真实数据理解 PromQL 的工作示例。将讨论有关不同度量协议的详细信息。最后，您将了解支持 Mimir、Prometheus 和 Graphite 的重要架构设计，并掌握与这些工具合作时的最佳实践。

*第六章*，*使用 Grafana Tempo 跟踪技术细节*，展示了使用真实数据理解 TraceQL 的工作示例。将讨论有关不同追踪协议的详细信息。最后，您将了解 Tempo 的重要架构设计，并掌握与其合作时的最佳实践。

*第七章*，*使用 Kubernetes、AWS、GCP 和 Azure 查询基础设施*，描述了用于捕获基础设施遥测的设置和配置。你将了解 Kubernetes 的不同选项。此外，你还将研究允许 Grafana 从云供应商（如 AWS、GCP 和 Azure）查询数据的主要插件。你将了解如何处理大量遥测数据，尤其是在直接连接无法扩展的情况下。本章还将介绍如何在数据进入 Grafana 之前进行遥测数据的过滤和选择，以优化安全性和成本。

*第八章*，*使用仪表盘显示数据*，解释了如何在 Grafana UI 中设置你的第一个仪表盘。你还将学习如何以有效且有意义的方式展示你的遥测数据。本章还将教你如何管理 Grafana 仪表盘，以确保其有条理且安全。

*第九章*，*使用警报管理事件*，描述了如何使用警报管理器设置你的第一个 Grafana 警报。你将学习如何设计一种警报策略，将关键业务警报优先于普通通知。此外，你还将了解警报通知策略、不同的传递方式以及需要注意的事项。

*第十章*，*使用基础设施即代码进行自动化*，为你提供了自动化 Grafana 堆栈部署某些部分的工具和方法，同时引入标准和质量检查。你将深入了解 Grafana API，学习如何与 Terraform 配合使用，并了解如何通过验证保护变更。

*第十一章*，*构建可观测性平台架构*，将向你展示那些负责提供高效且易于使用的可观测性平台的人员，如何构建平台结构，以便能让你的内部客户满意。在我们所处的环境中，快速高效地提供这些平台服务至关重要，这样才能将更多的时间投入到客户面向的产品生产中。本章旨在基于已有的知识，帮助你快速启动并运行。

*第十二章*，*使用 Grafana 进行真实用户监控*，向你介绍前端应用程序的可观测性，使用 Grafana Faro 和 Grafana Cloud Frontend Observability 进行**真实用户监控**（**RUM**）。本章将讨论如何对前端浏览器应用程序进行监控。你将学习如何捕获前端遥测数据，并将其与后端遥测数据关联，以实现全栈可观测性。

*第十三章*，*通过 Grafana Pyroscope 和 k6 进行应用性能监控*，介绍了如何使用 Grafana Pyroscope 和 k6 进行应用性能分析和性能剖析。你将获得一个高层次的概览，讨论 k6 在烟雾测试、突发测试、压力测试和浸泡测试中的各个方面，以及如何使用 Pyroscope 在生产环境和测试环境中持续分析应用程序。

*第十四章*，*通过可观察性支持 DevOps 流程*，带领你了解 DevOps 流程以及如何利用 Grafana 通过可观察性提升这些流程。你将学习如何在开发阶段使用 Grafana 堆栈加速工程师的反馈循环。你将理解如何为工程师准备好在生产环境中操作产品。最后，你将学习何时以及如何实施 CLI 和自动化工具以增强开发工作流。

*第十五章*，*通过 Grafana 进行故障排除、实施最佳实践及更多内容*，通过讲解在生产环境中使用 Grafana 的最佳实践来结束本书。你还将学习一些有价值的故障排除技巧，以帮助你应对日常运营中的高流量系统。你还将了解与安全性和商业智能相关的遥测数据的其他注意事项。

# 充分利用本书

下表展示了本书中将使用的软件的操作系统要求：

| **本书涵盖的软件/硬件** | **操作系统要求** |
| --- | --- |
| Kubernetes v1.26 | 支持 Windows、macOS 或 Linux，配备双核 CPU 和 4GB 内存 |
| Docker v23 | 支持 Windows、macOS 或 Linux，配备双核 CPU 和 4GB 内存 |

**如果你使用的是本书的数字版本，我们建议你自己输入代码或通过本书的 GitHub 仓库获取代码（下一节将提供链接）。这样做将帮助你避免与复制和粘贴代码相关的潜在错误。**

# 下载示例代码文件

你可以从 GitHub 下载本书的示例代码文件，链接地址为 [`github.com/PacktPublishing/Observability-with-Grafana`](https://github.com/PacktPublishing/Observability-with-Grafana)。如果代码有更新，它将在 GitHub 仓库中更新。

我们还提供了来自我们丰富的书籍和视频目录中的其他代码包，链接地址为 [`github.com/PacktPublishing/`](https://github.com/PacktPublishing/)。欢迎查看！

# 行动中的代码

本书的《行动中的代码》视频可以在 [`packt.link/v59Jp`](https://packt.link/v59Jp) 上观看。

# 使用的约定

本书中使用了多种文本约定。

`文本中的代码`：表示文本中的代码词汇、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟网址、用户输入和 Twitter 用户名。举个例子：“用于获取此信息的函数是 `rate()` 函数。”

一段代码设置如下：

```
histogram_quantile(
    0.95, sum(
        rate(
            http_server_duration_milliseconds_bucket{}[$__rate_interval])
        ) by (le)
    )
```

任何命令行输入或输出如下所示：

```
$ helm upgrade owg open-telemetry/opentelemetry-collector -f OTEL-Collector.yaml
```

**粗体**：表示新术语、重要词汇，或您在屏幕上看到的词汇。例如，在菜单或对话框中的词汇通常显示为**粗体**。举个例子：“在仪表板的**设置**屏幕上，您可以添加或删除单个仪表板的标签。”

提示或重要说明

显示如下。

# 联系我们

我们始终欢迎读者的反馈。

**一般反馈**：如果您对本书的任何部分有疑问，请通过电子邮件联系我们 [customercare@packtpub.com](http://customercare@packtpub.com)，并在邮件主题中注明书名。

**勘误**：虽然我们已经尽一切努力确保内容的准确性，但错误难免发生。如果您在本书中发现错误，我们非常感激您能向我们报告。请访问 [www.packtpub.com/support/errata](http://www.packtpub.com/support/errata) 并填写表单。

**盗版**：如果您在互联网上发现我们作品的任何非法复制形式，我们将非常感激您提供该位置或网站名称。请通过 [copyright@packt.com](http://copyright@packt.com) 联系我们，并附上材料的链接。

**如果您有兴趣成为作者**：如果您在某个领域有专长，并且有兴趣撰写或为书籍做贡献，请访问 [authors.packtpub.com](http://authors.packtpub.com)。

# 分享您的想法

一旦您阅读了*《Grafana 可观察性》*，我们很想听听您的想法！[请点击这里直接前往本书的亚马逊评论页面并分享您的反馈](https://packt.link/r/1803248009)。

您的反馈对我们以及技术社区非常重要，能帮助我们确保提供优质的内容。

# 下载本书的免费 PDF 副本

感谢购买本书！

您喜欢随时随地阅读，但无法随身携带纸质书籍吗？

您的电子书购买无法与您选择的设备兼容吗？

不用担心，现在每本 Packt 书籍，您都可以免费获得该书的无 DRM PDF 版本。

在任何地方、任何设备上阅读。可以直接从您最喜欢的技术书籍中搜索、复制和粘贴代码到您的应用程序中。

福利还不止这些，您还可以获得独家折扣、时事通讯以及每日送达的精彩免费内容。

请按照以下简单步骤享受这些福利：

1.  扫描二维码或访问下面的链接

![](img/B18277_QR_Free_PDF.jpg)

[`packt.link/free-ebook/9781803248004`](https://packt.link/free-ebook/9781803248004)

1.  提交您的购买证明

1.  就这些！我们会直接将免费的 PDF 文件和其他福利发送到您的邮箱

# 第一部分：开始使用 Grafana 和可观测性

本书的这一部分将介绍 Grafana 和可观测性。你将了解遥测数据的生产者和消费者。你将探讨如何为应用程序和基础设施添加监控工具。接着，你将设置一个学习环境，并在接下来的章节中逐步增强，以提供使用 Grafana 实现可观测性的全面示例。

本部分包含以下章节：

+   *第一章**, 介绍可观测性和 Grafana 堆栈*

+   *第二章**, 为应用程序和基础设施添加监控工具*

+   *第三章**, 使用演示应用程序设置学习环境*
