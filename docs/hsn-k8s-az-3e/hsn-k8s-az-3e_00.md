# 第一章：《Azure 上的 Kubernetes 实战》第三版

使用 Azure Kubernetes 服务自动管理、扩展和部署容器化应用程序。

Nills Franssens

Shivakumar Gopalakrishnan

Gunther Lenz

### 《Azure 上的 Kubernetes 实战》第三版

版权所有 © 2021 Packt Publishing

*保留所有权利*。未经出版商事先书面许可，本书的任何部分不得以任何形式或通过任何方式复制、存储在检索系统中或传播，但在关键性文章或评论中嵌入简短引用除外。

在本书的编写过程中，已尽一切努力确保所呈现信息的准确性。然而，本书所包含的信息是无保修的，无论是明示的还是暗示的。无论是作者，还是 Packt Publishing 及其代理商和分销商，都不对因本书直接或间接造成的或声称造成的任何损害承担责任。

Packt Publishing 已尽力通过适当使用大写字母提供本书中提到的所有公司和产品的商标信息。然而，Packt Publishing 无法保证这些信息的准确性。

**作者：** Nills Franssens, Shivakumar Gopalakrishnan, 和 Gunther Lenz

**技术审阅：** Richard Hooper 和 Swaminathan Vetri

**总编辑：** Aditya Datar 和 Siddhant Jain

**编辑：** Ben Renow-Clarke

**生产编辑：** Deepak Chavan

**编辑委员会：** Vishal Bodwani, Ben Renow-Clarke, Arijit Sarkar, 和 Lucy Wan

**第一版出版时间：** 2019 年 3 月

**第二版出版时间：** 2020 年 5 月

**第三版出版时间：** 2021 年 5 月

**生产参考号：** 3210521

**ISBN：** 978-1-80107-994-5

由 Packt Publishing Ltd.出版

Livery Place, 35 Livery Street

英国伯明翰，B3 2PB。

*献给妈妈和爸爸。没有你们为我所做的一切，这本书是不可能完成的。我爱你们俩。*

*献给 Kelly。如果没有你，我今天不会是现在的我。*

**- Nills Franssens**

# 目录

## 前言  i

## 序言  1

## 第一章：基础知识 5

## 1. 容器和 Kubernetes 简介 7

### 带我们走到今天的软件演变 9

### 微服务  9

### 运行微服务的优点 10

### 运行微服务的缺点 11

### DevOps  12

### 容器基础 14

### 容器镜像 16

### Kubernetes 作为容器编排平台 20

### Kubernetes 中的 Pods 21

### Kubernetes 中的部署  22

### Kubernetes 中的服务  23

### Azure Kubernetes 服务  23

### 总结  25

## 2. 开始使用 Azure Kubernetes 服务  27

### 创建 AKS 集群的不同方式  28

### 开始使用 Azure 门户  29

### 创建您的第一个 AKS 集群  29

### 在 Azure 门户中快速概览您的集群  36

### 使用 Azure Cloud Shell 访问您的集群  40

### 部署并检查您的第一个示例应用程序  43

### 部署示例应用程序  44

### 总结  52

## 第二部分：在 AKS 上部署  53

## 3. 在 AKS 上部署应用程序  55

### 逐步部署示例访客簿应用程序  57

### 介绍应用程序  57

### 部署 Redis 主节点  58

### 检查部署情况  62

### 带有 ConfigMap 的 Redis 主节点  64

### 完成部署示例访客簿应用程序  71

### 暴露 Redis 主节点服务  72

### 部署 Redis 副本  75

### 部署并暴露前端  77

### 访客簿应用程序的实际运行  84

### 使用 Helm 安装复杂的 Kubernetes 应用程序  85

### 使用 Helm 安装 WordPress  86

### 总结  94

## 4. 构建可扩展应用程序  95

### 扩展您的应用程序  96

### 手动扩展您的应用程序  97

### 扩展访客簿前端组件  100

### 使用 HPA  102

### 扩展您的集群  107

### 手动扩展您的集群  107

### 使用集群自动扩展器扩展集群  109

### 升级您的应用程序  112

### 通过更改 YAML 文件进行升级 113

### 使用 kubectl edit 升级应用程序 118

### 使用 kubectl patch 升级应用程序 119

### 使用 Helm 升级应用程序 122

### 摘要 126

## 5. 处理 AKS 中常见的故障 127

### 处理节点故障 128

### 解决资源不足失败 135

### 修复存储挂载问题 139

### 启动 WordPress 安装 140

### 使用持久卷避免数据丢失 142

### 摘要 153

## 6. 使用 HTTPS 保护你的应用程序 155

### 将 Azure 应用程序网关设置为 Kubernetes 入口 156

### 创建新的应用程序网关 157

### 设置 AGIC 160

### 为 guestbook 应用程序添加入口规则 161

### 为入口添加 TLS 165

### 安装 cert-manager 166

### 安装证书颁发机构 168

### 创建 TLS 证书并保护入口 169

### 摘要 176

## 7. 监控 AKS 集群和应用程序 177

### 用于监控应用程序的命令 178

### kubectl get 命令 179

### kubectl describe 命令 181

### 调试应用程序 186

### 就绪和活性探针 196

### 构建两个 Web 容器 197

### 实验活性探针和就绪探针 201

### Kubernetes 报告的指标 205

### 节点状态和消耗 205

### Pod 消耗 207

### 使用 AKS 诊断工具 210

### Azure Monitor 指标和日志 213

### AKS 洞察 213

### 摘要 226

## 第三部分：保护你的 AKS 集群和工作负载 227

## 8\. AKS 中的基于角色的访问控制 229

### Kubernetes 中的 RBAC 解析 230

### 在 AKS 集群中启用 Azure AD 集成 232

### 在 Azure AD 中创建用户和组 235

### 在 AKS 中配置 RBAC 240

### 验证用户的 RBAC 245

### 总结 250

## 9\. AKS 中的 Azure Active Directory 管理的 Pod 身份 251

### Azure AD 管理的 Pod 身份概述 253

### 使用 Azure AD 管理的 Pod 身份设置新集群 256

### 将身份链接到集群 258

### 使用托管身份的 Pod 262

### 总结 271

## 10\. 在 AKS 中存储密钥 273

### Kubernetes 中的不同密钥类型 274

### 在 Kubernetes 中创建密钥 275

### 从文件创建密钥 275

### 使用 YAML 文件手动创建密钥 279

### 使用 kubectl 使用字面量创建通用密钥 281

### 使用密钥 282

### 将密钥作为环境变量 283

### 将密钥作为文件使用 285

### 安装 Azure Key Vault 提供程序用于 Secrets Store CSI 驱动程序 289

### 创建托管身份 291

### 创建 Key Vault 294

### 安装 Key Vault 的 CSI 驱动程序 300

### 使用 Azure Key Vault 提供程序用于 Secrets Store CSI 驱动程序 301

### 将 Key Vault 密钥挂载为文件 301

### 使用 Key Vault 密钥作为环境变量 305

### 总结 310

## 11\. AKS 中的网络安全 311

### AKS 中的网络和网络安全 312

### 控制平面网络 312

### 工作负载网络 315

### 控制平面网络安全 317

### 使用授权的 IP 范围保护控制平面 317

### 使用私有集群保护控制平面 321

### 工作负载网络安全 330

### 使用内部负载均衡器保护工作负载网络 330

### 使用网络安全组保护工作负载网络 336

### 使用网络策略保护工作负载网络 343

### 摘要 352

## 第四部分：与 Azure 托管服务集成 353

## 12. 将应用程序连接到 Azure 数据库 355

### Azure 服务操作员 356

### 什么是 ASO? 357

### 在集群上安装 ASO 359

### 创建新的 AKS 集群 359

### 创建托管身份 361

### 创建密钥保管库 367

### 在集群上设置 ASO 370

### 使用 ASO 部署 Azure MySQL 数据库 373

### 使用 MySQL 数据库创建应用程序 380

### 摘要 387

## 13. Kubernetes 的 Azure 安全中心 389

### 为 Kubernetes 设置 Azure 安全中心 391

### 部署违规工作负载 396

### 使用 Azure 安全得分分析配置 403

### 使用 Azure Defender 中和威胁 415

### 摘要 428

## 14. 无服务器函数 429

### 各种函数平台 431

### 设置先决条件 433

### Azure 容器注册表 433

### 创建虚拟机 436

### 创建一个 HTTP 触发的 Azure 函数 442

### 创建队列触发的函数 447

### 创建队列 448

### 创建队列触发的函数 451

### 功能的扩展测试 458

### 摘要 461

## 15. AKS 的持续集成与持续部署 463

### 容器和 Kubernetes 的 CI/CD 流程 464

### 设置 Azure 和 GitHub 466

### 设置 CI 流水线 473

### 设置 CD 流水线 485

### 总结 494

### 最终思考 495

## 索引 497
