- en: 13\. Azure Security Center for Kubernetes
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 13. Kubernetes 的 Azure 安全中心
- en: 'Kubernetes is a very powerful platform with a lot of configuration options.
    Configuring your workload the right way and making sure you follow best practices
    can be difficult. There are industry benchmarks that you can follow to get guidelines
    for how to deploy your workloads securely, such as the **Center for Internet Security**
    (**CIS**) Benchmarks for Kubernetes: https://www.cisecurity.org/benchmark/kubernetes/.'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes 是一个非常强大的平台，拥有大量配置选项。正确配置你的工作负载并确保遵循最佳实践可能是困难的。你可以遵循行业基准，以获得如何安全部署工作负载的指南，例如
    **互联网安全中心**（**CIS**）为 Kubernetes 提供的基准：https://www.cisecurity.org/benchmark/kubernetes/。
- en: Azure Security Center is a unified infrastructure security management platform.
    It provides continuous security monitoring and alerting for resources in Azure
    as well as for hybrid workloads. It offers protection for many Azure resources,
    including Kubernetes clusters. This will allow you to ensure your workloads are
    configured securely and protected.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 安全中心是一个统一的基础设施安全管理平台。它为 Azure 中的资源以及混合工作负载提供持续的安全监控和警报。它为许多 Azure 资源提供保护，包括
    Kubernetes 集群。这样，你可以确保你的工作负载配置安全并且受到保护。
- en: Azure Security Center offers two types of protection. First, it monitors your
    resource configuration and compares it to security best practices, and then gives
    you actionable recommendations to improve your security posture. Second, it also
    does threat protection by assessing your workloads and raising alerts when a potential
    threat is identified. This threat detection capability is part of a feature called
    Azure Defender within Azure Security Center.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: Azure 安全中心提供两种类型的保护。首先，它监控你的资源配置，并将其与安全最佳实践进行比较，然后为你提供可操作的建议来改善你的安全状况。其次，它还通过评估你的工作负载并在发现潜在威胁时发出警报来进行威胁保护。这一威胁检测功能是
    Azure 安全中心中的一个功能，名为 Azure Defender。
- en: When it comes to monitoring Kubernetes workloads, Azure Security Center can
    monitor both your cluster configuration as well as the configuration of the workloads
    running in your cluster. To monitor the configuration of the workloads in your
    cluster, Azure Security Center uses Microsoft Azure Policy for Kubernetes. This
    free add-on for **Azure Kubernetes Service** (**AKS**) will enable Azure Security
    Center to compare the configuration of your workloads against known best practices.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 在监控 Kubernetes 工作负载时，Azure 安全中心可以同时监控你的集群配置以及在集群中运行的工作负载的配置。为了监控集群中工作负载的配置，Azure
    安全中心使用微软 Azure Kubernetes 策略。这个免费的附加组件适用于 **Azure Kubernetes 服务**（**AKS**），它将使
    Azure 安全中心能够将你的工作负载配置与已知的最佳实践进行比较。
- en: Azure Defender also has specific threat detection capabilities for Kubernetes.
    It monitors a combination of Kubernetes audit logs, node logs, as well as cluster
    and workload configuration to identify potential threats. Examples of threats
    that can be discovered are crypto-miners, the creation of high-privileged roles,
    or exposing the Kubernetes dashboard.
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: Azure Defender 还为 Kubernetes 提供特定的威胁检测能力。它监控 Kubernetes 审计日志、节点日志以及集群和工作负载配置的组合，以识别潜在的威胁。可以发现的威胁示例包括加密矿工、高权限角色的创建或暴露
    Kubernetes 仪表板。
- en: In this chapter, you'll enable Azure Security Center, Azure Policy for Kubernetes,
    and Azure Defender for Kubernetes and monitor several sample applications against
    threats.
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，你将启用 Azure 安全中心、Azure Kubernetes 策略以及 Azure Kubernetes 防御器，并监控几个示例应用程序以防范威胁。
- en: 'In this chapter, we will cover the following topics:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下主题：
- en: Azure Security Center for Kubernetes
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Kubernetes 的 Azure 安全中心
- en: Azure Defender for Kubernetes
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Azure Defender for Kubernetes
- en: Deploying offending workloads
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 部署有问题的工作负载
- en: Analyzing configuration using Azure Secure Score
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 Azure 安全得分分析配置
- en: Neutralizing threats using Azure Defender
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 Azure Defender 中和威胁
- en: Let's start by setting up Azure Security Center for Kubernetes.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 我们首先来设置 Kubernetes 的 Azure 安全中心。
- en: Setting up Azure Security Center for Kubernetes
  id: totrans-14
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 为 Kubernetes 设置 Azure 安全中心
- en: We'll start this chapter by setting up Azure Security Center for Kubernetes.
    To enable Azure Security Center for Kubernetes, you need to enable Azure Policy
    for AKS on your cluster. This will enable Azure Security to monitor your workload
    configuration. To benefit from Azure Defender's threat protection, you will also
    need to enable Azure Defender for Kubernetes on your subscription.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将从为 Kubernetes 设置 Azure Security Center 开始。要启用 Azure Security Center for Kubernetes，您需要在集群上启用
    Azure Policy for AKS。这将允许 Azure Security 监控您的工作负载配置。为了利用 Azure Defender 的威胁防护，您还需要在订阅中启用
    Azure Defender for Kubernetes。
- en: Let's get started.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们开始吧。
- en: Search for your AKS cluster in the Azure search bar, as shown in *Figure 13.1*:![Looking
    for your cluster in the Azure search bar](img/B17338_13_01.jpg)
  id: totrans-17
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 Azure 搜索栏中查找您的 AKS 集群，如*图 13.1*所示：![在 Azure 搜索栏中查找您的集群](img/B17338_13_01.jpg)
- en: 'Figure 13.1: Looking for your cluster in the Azure search bar'
  id: totrans-18
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.1：在 Azure 搜索栏中查找您的集群
- en: You will now enable Azure Policy for AKS. To enable this, click the Policies
    button on the left-hand side and on the resulting pane, click on Enable add-on,
    as shown in *Figure 13.2*:![Enabling Azure Policy for your AKS cluster](img/B17338_13_02.jpg)
  id: totrans-19
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，您将为 AKS 启用 Azure Policy。要启用此功能，请点击左侧的 Policies 按钮，在弹出的面板中，点击 Enable add-on，如*图
    13.2*所示：![为您的 AKS 集群启用 Azure Policy](img/B17338_13_02.jpg)
- en: 'Figure 13.2: Enabling Azure Policy for AKS'
  id: totrans-20
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.2：为 AKS 启用 Azure Policy
- en: 'Enabling the add-on will take a couple of minutes to complete. After a while,
    you should see a message saying that the service is now enabled, as shown in *Figure
    13.3*:'
  id: totrans-21
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 启用插件需要几分钟时间来完成。稍后，您应该会看到一条消息，显示服务已经启用，如*图 13.3*所示：
- en: '![Notification stating that Azure Policy is enabled for your AKS cluster](img/B17338_13_03.jpg)'
  id: totrans-22
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![显示 Azure Policy 已为您的 AKS 集群启用的通知](img/B17338_13_03.jpg)'
- en: 'Figure 13.3: Azure Policy for AKS is now enabled'
  id: totrans-23
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.3：Azure Policy for AKS 已启用
- en: This has enabled Azure Policy for AKS. Next, you will enable Azure Defender
    to get the threat prevention ability from Azure Security Center. To do so, look
    up `security center` in the Azure portal's search bar, as shown in *Figure 13.4*:![Searching
    for security center in the Azure search bar](img/B17338_13_04.jpg)
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这已经为 AKS 启用了 Azure Policy。接下来，您将启用 Azure Defender，以便从 Azure Security Center
    获取威胁防护功能。为此，请在 Azure 门户的搜索栏中查找 `security center`，如*图 13.4*所示：![在 Azure 搜索栏中查找安全中心](img/B17338_13_04.jpg)
- en: 'Figure 13.4: Searching for security center in the Azure portal search bar'
  id: totrans-25
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.4：在 Azure 门户的搜索栏中搜索安全中心
- en: 'If this is the first time you are accessing Azure Security Center in your subscription,
    you''ll be greeted with a message as shown in *Figure 13.5*. To enable Azure Defender,
    click on Upgrade at the bottom of the screen:'
  id: totrans-26
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果这是您第一次在订阅中访问 Azure Security Center，您会看到如*图 13.5*所示的消息。要启用 Azure Defender，请点击屏幕底部的
    Upgrade：
- en: '![Enabling Azure Defender for your subscription](img/B17338_13_05.jpg)'
  id: totrans-27
  prefs: []
  type: TYPE_IMG
  zh: '![为您的订阅启用 Azure Defender](img/B17338_13_05.jpg)'
- en: 'Figure 13.5: Upgrading to Azure Defender'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.5：升级到 Azure Defender
- en: 'If you''re not accessing Azure Security Center in your subscription for the
    first time, you might not be greeted with this message to enable Azure Defender.
    To enable it, click on Pricing & settings on the left-hand side and select your
    subscription, as shown in *Figure 13.6*:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 如果您不是第一次在订阅中访问 Azure Security Center，可能不会看到启用 Azure Defender 的消息。要启用它，请点击左侧的
    Pricing & settings 并选择您的订阅，如*图 13.6*所示：
- en: '![Turning on Azure Defender for your subscription](img/B17338_13_06.jpg)'
  id: totrans-30
  prefs: []
  type: TYPE_IMG
  zh: '![为您的订阅启用 Azure Defender](img/B17338_13_06.jpg)'
- en: 'Figure 13.6: Manually upgrading to Azure Defender'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.6：手动升级到 Azure Defender
- en: 'In the resulting pane, select the right box with the title Azure Defender on
    and click the Save button at the top of the screen to enable Azure Defender. Optionally,
    you could tune which service you want to enable/disable Azure Defender for, as
    shown in *Figure 13.7*:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 在弹出的面板中，选择标题为 Azure Defender on 的框，并点击屏幕顶部的 Save 按钮以启用 Azure Defender。您也可以选择调节要启用/禁用
    Azure Defender 的服务，如*图 13.7*所示：
- en: '![Selecting the Azure Defender plan for your subscription](img/B17338_13_07.jpg)'
  id: totrans-33
  prefs: []
  type: TYPE_IMG
  zh: '![为您的订阅选择 Azure Defender 计划](img/B17338_13_07.jpg)'
- en: 'Figure 13.7: Turning on Azure Defender for your subscription'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.7：为您的订阅启用 Azure Defender
- en: Now that you have enabled Azure Security Center and Azure Defender, it will
    take up to 30 minutes for the system to configure the default policy and start
    detections.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 现在您已经启用了 Azure Security Center 和 Azure Defender，系统配置默认策略并开始检测需要最多 30 分钟时间。
- en: While you are waiting for this configuration to become effective, you will deploy
    several offending workloads on your cluster, which will trigger alerts in Azure
    Defender.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 在等待此配置生效期间，你将在你的集群上部署多个有问题的工作负载，这将在 Azure Defender 中触发警报。
- en: Deploying offending workloads
  id: totrans-37
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 部署有问题的工作负载
- en: 'To trigger recommendations and threat alerts in Azure Security Center, you
    will need to have offending workloads deployed on your cluster. In this section,
    you will deploy a number of workloads to your cluster that are either not configured
    according to best practices or even contain potentially malicious software such
    as crypto-miners. Let''s have a look at the examples of offending workloads you
    can find in the code samples for this chapter:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 要触发 Azure 安全中心的推荐和威胁警报，你需要在你的集群上部署有问题的工作负载。在本节中，你将部署一些可能未按照最佳实践配置甚至包含潜在恶意软件（如加密货币挖矿程序）的工作负载到你的集群中。让我们看一下本章节代码示例中的有问题的工作负载示例：
- en: '`crypto-miner.yaml`: This file contains a deployment that will create a crypto-miner
    on your cluster.'
  id: totrans-39
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`crypto-miner.yaml`: 此文件包含一个部署，将在你的集群上创建一个加密货币挖矿程序。'
- en: '[PRE0]'
  id: totrans-40
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This file is a regular deployment in Kubernetes. As you can see on *line 19*,
    the container image for this deployment will be a crypto-miner.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 这个文件是 Kubernetes 中的一个常规部署。正如你在*第 19 行*所见，此部署的容器镜像将是一个加密货币挖矿程序。
- en: Note
  id: totrans-42
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: Make sure to stop running the crypto-miner as soon as you are done with this
    chapter, as explained in the Neutralizing threats using Azure Defender section.
    There is no point in running the crypto-miner any longer than this example requires.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 确保在完成本章后立即停止运行加密货币挖矿程序，如*使用 Azure Defender 中和解中立化威胁*部分所述。没有必要让加密货币挖矿程序长时间运行超过本示例所需的时间。
- en: '`escalation.yaml`: This file contains a deployment that allows privilege escalations
    in the container. This means that a process in the container can get access to
    the host operating system. There are cases where this is desired behavior, but
    typically you don''t want this configuration.'
  id: totrans-44
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`escalation.yaml`: 此文件包含一个允许容器特权提升的部署。这意味着容器中的进程可以访问主机操作系统。有些情况下，这是期望的行为，但通常不希望这样配置。'
- en: '[PRE1]'
  id: totrans-45
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: As you can see in the preceding code sample, on *lines 20–21*, you configure
    the security context of the container with `securityContext`. You allow privilege
    escalation on *line 21*.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 正如在前面的代码示例中所见，在*第 20–21 行*，你使用 `securityContext` 配置了容器的安全上下文。你在*第 21 行*允许提权。
- en: '`host-volume.yaml`: This file contains a deployment with a directory on the
    host mounted in the container. This is not recommended because this way, the container
    can get access to the host.'
  id: totrans-47
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`host-volume.yaml`: 此文件包含一个在容器中挂载主机目录的部署。这不被推荐，因为这样容器可以访问主机。'
- en: '[PRE2]'
  id: totrans-48
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: This code sample contains a `volumeMount` field and a volume. As you can see
    in *lines 24–28*, the volume is using `hostPath`, meaning it mounts a volume on
    the node running the container.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: 这个代码示例包含一个 `volumeMount` 字段和一个卷。正如你在*第 24–28 行*所见，该卷使用 `hostPath`，意味着它在运行容器的节点上挂载一个卷。
- en: '`role.yaml`: A role with very broad permissions. It is recommended to approach
    roles in Kubernetes with the principle of least privilege to ensure permissions
    are tightly controlled. A role with broad permissions is first and foremost a
    bad configuration, but worse, could be a sign of compromise on your cluster.'
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`role.yaml`: 具有非常广泛权限的角色。建议在 Kubernetes 中采用最小特权原则来处理角色，以确保权限受到严格控制。具有广泛权限的角色首先是一个糟糕的配置，更糟的是，可能是集群受到威胁的迹象。'
- en: '[PRE3]'
  id: totrans-51
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: This instance of `ClusterRole` gives very broad permissions, as you can see
    in *lines 6–8*. This configuration gives anybody who gets assigned this role all
    permissions on all resources on all APIs in Kubernetes.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 这个 `ClusterRole` 实例赋予了非常广泛的权限，正如你在*第 6–8 行*所见。这种配置将任何被分配此角色的人赋予 Kubernetes 中所有
    API 的所有资源的所有权限。
- en: None of the deployments in these code samples contain resource requests and
    limits. As explained in *Chapter 3*, *Application deployment on AKS*, it is recommended
    to configure resource requests and limits, as these can prevent a workload from
    consuming too many resources.
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 这些代码示例中的任何部署都不包含资源请求和限制。正如*第三章*中*在 AKS 上部署应用*中所解释的那样，建议配置资源请求和限制，因为这些可以防止工作负载消耗过多资源。
- en: Finally, you will also deploy the Kubernetes dashboard on a public service.
    This is also highly discouraged, as this might inadvertently give attackers access
    to your cluster. You will see how Azure Defender detects this.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，你还将把 Kubernetes 仪表盘部署到公共服务上。这也是强烈不推荐的，因为这可能无意中让攻击者访问你的集群。你将看到 Azure Defender
    如何检测到这一点。
- en: Let's start deploying these files.
  id: totrans-55
  prefs: []
  type: TYPE_NORMAL
  zh: 现在开始部署这些文件。
- en: Open Cloud Shell in the Azure portal and navigating to the code samples for
    this chapter.
  id: totrans-56
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 Azure 门户中打开云 shell 并导航到本章的代码示例。
- en: Once there, execute the following commands to create the offending workloads.
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 到达后，执行以下命令来创建有问题的工作负载。
- en: '[PRE4]'
  id: totrans-58
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'This will create an output similar to *Figure 13.8*:'
  id: totrans-59
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将生成类似于*图 13.8*的输出：
- en: '![Creating offending workloads to trigger recommendations and threat alerts
    in Azure Security Center](img/B17338_13_08.jpg)'
  id: totrans-60
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![创建有问题的工作负载以触发 Azure 安全中心中的推荐和威胁警报](img/B17338_13_08.jpg)'
- en: 'Figure 13.8: Creating the offending workload'
  id: totrans-61
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.8：创建有问题的工作负载
- en: 'Now, deploy the Kubernetes dashboard using the following command:'
  id: totrans-62
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，使用以下命令部署 Kubernetes 仪表盘：
- en: '[PRE5]'
  id: totrans-63
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'This will create an output similar to *Figure 13.9*:'
  id: totrans-64
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将生成类似于*图 13.9*的输出：
- en: '![Deploying the Kubernetes dashboard](img/B17338_13_09.jpg)'
  id: totrans-65
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![部署 Kubernetes 仪表盘](img/B17338_13_09.jpg)'
- en: 'Figure 13.9: Creating the Kubernetes dashboard'
  id: totrans-66
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.9：创建 Kubernetes 仪表盘
- en: 'By default, the Kubernetes dashboard is not exposed through a load balancer.
    This is also the recommended configuration, because the dashboard gives broad
    access to your cluster. In this chapter, however, you will create this discouraged
    configuration to trigger a security alert in Azure Defender. To add a load balancer
    to the Kubernetes dashboard, use the following command:'
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 默认情况下，Kubernetes 仪表盘不会通过负载均衡器暴露。这也是推荐的配置，因为仪表盘可以广泛访问你的集群。然而，在本章中，你将创建这种不推荐的配置，以触发
    Azure Defender 中的安全警报。要将负载均衡器添加到 Kubernetes 仪表盘，请使用以下命令：
- en: '[PRE6]'
  id: totrans-68
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'This will patch the service and turn it into a service of the `LoadBalancer`
    type. Verify that this was patched successfully and get the public IP address
    of the service using the following command:'
  id: totrans-69
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将修补服务并将其转换为 `LoadBalancer` 类型的服务。使用以下命令验证此修补是否成功，并获取服务的公共 IP 地址：
- en: '[PRE7]'
  id: totrans-70
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'This will generate an output similar to *Figure 13.10*:'
  id: totrans-71
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将生成类似于*图 13.10*的输出：
- en: '![Adding a load balancer to the Kubernetes-dashboard service and fetching its
    public IP](img/B17338_13_10.jpg)'
  id: totrans-72
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![向 Kubernetes-dashboard 服务添加负载均衡器并获取其公共 IP](img/B17338_13_10.jpg)'
- en: 'Figure 13.10: Getting the public IP of the kubernetes-dashboard service'
  id: totrans-73
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.10：获取 kubernetes-dashboard 服务的公共 IP
- en: 'Verify that you can access this service by browsing to `https://<public IP>`.
    Depending on your browser configuration, you might get a certificate error, which
    you can bypass by selecting Continue to <public IP> (unsafe), as shown in *Figure
    13.11*:'
  id: totrans-74
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证你是否可以通过浏览器访问此服务，方法是浏览到 `https://<public IP>`。根据你的浏览器配置，你可能会遇到证书错误，可以通过选择“继续访问
    <public IP>（不安全）”来绕过此错误，如*图 13.11*所示：
- en: '![Navigating to the Kubernetes dashboard service and verifying that the connection
    isn’t secure](img/B17338_13_11.jpg)'
  id: totrans-75
  prefs: []
  type: TYPE_IMG
  zh: '![导航到 Kubernetes 仪表盘服务并验证连接是否不安全](img/B17338_13_11.jpg)'
- en: 'Figure 13.11: Security warning about the certificate on the Kubernetes dashboard
    service'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.11：Kubernetes 仪表盘服务的证书安全警告
- en: 'Once you have continued to the dashboard, you should get a sign-in screen as
    shown in *Figure 13.12*:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦继续进入仪表盘，你应该看到一个登录屏幕，如*图 13.12*所示：
- en: '![The Kubernetes dashboard login](img/B17338_13_12.jpg)'
  id: totrans-78
  prefs: []
  type: TYPE_IMG
  zh: '![Kubernetes 仪表盘登录](img/B17338_13_12.jpg)'
- en: 'Figure 13.12: The exposed Kubernetes dashboard'
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.12：暴露的 Kubernetes 仪表盘
- en: You won't sign in to the dashboard here, but if you wish to explore its capabilities,
    please refer to the Kubernetes documentation at https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 你在这里不会登录仪表盘，但如果你希望探索其功能，请参考 Kubernetes 文档，网址为 [https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/](https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/)。
- en: You now have five offending workloads running on your cluster. Some of these
    will cause configuration warnings in Azure Security Center; some others will even
    trigger a security alert. You will explore those in the next two sections of this
    chapter.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在在集群中运行着五个有问题的工作负载。其中一些会在 Azure 安全中心中引发配置警告；另一些甚至会触发安全警报。你将在本章的接下来的两节中探索这些问题。
- en: Analyzing configuration using Azure Secure Score
  id: totrans-82
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用 Azure Secure Score 分析配置
- en: In the previous section, you created several workloads that are purposefully
    misconfigured. In this section, you'll review the recommendations in Azure Security
    Center related to these workloads.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: 在上一节中，你创建了几个故意配置错误的工作负载。在这一节中，你将回顾与这些工作负载相关的 Azure 安全中心推荐。
- en: Note
  id: totrans-84
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: It can take up to 30 minutes after the workloads have been created for recommendations
    and alerts to show up.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 在工作负载创建后，可能需要最多 30 分钟时间，推荐和警报才会显示出来。
- en: After you have created the offending workloads, you will get security recommendations
    in Azure Security Center. To start, click on Secure Score in the left-hand navigation
    within Azure Security Center. This will show you a pane similar to *Figure 13.13*:![Checking
    your Secure Score in Azure Security Center after creating offending workloads](img/B17338_13_13.jpg)
  id: totrans-86
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在你创建了有问题的工作负载后，你将会在 Azure 安全中心中收到安全推荐。首先，在 Azure 安全中心的左侧导航中点击“安全评分”。这将显示一个类似于*图
    13.13*的面板：![在创建有问题的工作负载后查看 Azure 安全中心中的安全评分](img/B17338_13_13.jpg)
- en: 'Figure 13.13: Secure Score in Azure Security Center'
  id: totrans-87
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.13：Azure 安全中心中的安全评分
- en: What you see here is a summary of the security posture of your environment.
    In the example shown in *Figure 13.13*, you see that the overall secure score
    was 32%. If you manage multiple Azure subscriptions, this view can give you a
    quick bird's-eye view of the security configuration of your environment.
  id: totrans-88
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这里显示的是你环境的安全态势概述。在*图 13.13*所示的示例中，你可以看到整体安全评分为32%。如果你管理多个 Azure 订阅，这个视图可以为你提供一个快速的全局安全配置视图。
- en: Let's drill down into the configuration of the Kubernetes cluster by clicking
    on the Azure subscription 1 subscription at the bottom of *Figure 13.13*. This
    will bring you to a pane similar to *Figure 13.14*:![Secure Score and security
    recommendations for your Azure subscription](img/B17338_13_14.jpg)
  id: totrans-89
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们通过点击*图 13.13*底部的“Azure 订阅 1”订阅，深入了解 Kubernetes 集群的配置。这将带你进入一个与*图 13.14*类似的面板：![查看你的
    Azure 订阅的安全评分和安全推荐](img/B17338_13_14.jpg)
- en: 'Figure 13.14: Secure Score details for the subscription'
  id: totrans-90
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.14：订阅的安全评分详情
- en: This view contains more details about the secure score for this subscription.
    It again shows you the secure score, as well as the recommendation status and
    resource health. The bottom of the screen contains more details about the specific
    recommendations.
  id: totrans-91
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这个视图包含了有关该订阅的安全评分的更多细节。它再次向你展示安全评分、推荐状态和资源健康状况。屏幕底部包含了有关具体推荐的更多信息。
- en: Tune this screen to get more insight into the Kubernetes recommendations. To
    do this, disable the Group by controls option on the right-hand side of the screen,
    and set the Resource type filter to managed cluster, as shown in *Figure 13.15*:![Azure
    provides security recommendations and shows the health of the resource for your
    Kubernetes clusters](img/B17338_13_15.jpg)
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 调整此屏幕，以便深入了解 Kubernetes 推荐。为此，请在屏幕右侧禁用“按控件分组”选项，并将资源类型过滤器设置为“托管集群”，如*图 13.15*所示：![Azure
    提供 Kubernetes 集群的安全推荐并显示资源健康状况](img/B17338_13_15.jpg)
- en: 'Figure 13.15: Kubernetes recommendations in Azure Security Center'
  id: totrans-93
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.15：Azure 安全中心中的 Kubernetes 推荐
- en: 'You are now looking at a list of Kubernetes security recommendations recommended
    by Azure Security Center. The list is too exhaustive to cover completely in this
    chapter, but if you want to see more details about each recommendation, please
    refer to the AKS documentation for more detailed descriptions: https://docs.microsoft.com/azure/aks/policy-reference.'
  id: totrans-94
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 你现在正查看 Azure 安全中心推荐的 Kubernetes 安全推荐列表。该列表内容过于详细，无法在本章中完全涵盖，但如果你想了解每个推荐的更多细节，请参考
    AKS 文档以获取更详细的描述：[https://docs.microsoft.com/azure/aks/policy-reference](https://docs.microsoft.com/azure/aks/policy-reference)
- en: Let's, however, explore a number of the recommendations that were caused by
    the offending workloads you created earlier. Start by clicking on the recommendation
    called Container with privilege escalation should be avoided. This will bring
    you to a view similar to *Figure 13.16*:![Exploring the Container with privilege
    escalation should be avoided recommendation](img/B17338_13_16.jpg)
  id: totrans-95
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然而，让我们探索一些由你之前创建的有问题的工作负载导致的推荐。从点击名为“应该避免具有特权提升的容器”推荐开始。这将带你进入一个与*图 13.16*类似的视图：![探索“应该避免具有特权提升的容器”推荐](img/B17338_13_16.jpg)
- en: 'Figure 13.16: Details of the Container with privilege escalation should be
    avoided recommendation'
  id: totrans-96
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.16：“应该避免具有特权提升的容器”推荐详情
- en: 'As you can see, this recommendation contains a description of the recommendation
    itself, as well as a number of remediation steps to follow this recommendation.
    It also shows you the affected resource, which in this case is an AKS cluster.
    If you click on the cluster, you will even get more details about the offending
    workload, as shown in *Figure 13.17*:'
  id: totrans-97
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如你所见，这个推荐包含了对推荐项本身的描述，以及一系列需要遵循的修复步骤。它还展示了受影响的资源，在本例中是 AKS 集群。如果你点击集群，甚至可以看到更多关于问题工作负载的细节，如*图
    13.17*所示：
- en: '![Clicking on the cluster on the recommendation page gives you further details
    about the affected components](img/B17338_13_17.jpg)'
  id: totrans-98
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![点击推荐页面上的集群将为你提供更多关于受影响组件的细节](img/B17338_13_17.jpg)'
- en: 'Figure 13.17: Pods affected by the privilege escalation recommendation'
  id: totrans-99
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.17：受权限提升推荐影响的 Pods
- en: In this case, each of the pods you created triggered this recommendation, not
    just the one where privilege escalation was allowed. This shows you that Kubernetes
    allows this privilege escalation by default and you should implement the safeguard
    in all your deployments. This shows you the benefit of a security monitoring solution
    such as Azure Security Center, to monitor against potential side effects of the
    default configuration.
  id: totrans-100
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在这种情况下，你创建的每个 Pod 都触发了这个推荐，而不仅仅是允许权限提升的那个。这表明 Kubernetes 默认允许这种权限提升，因此你应该在所有部署中实施这一保护措施。这也展示了像
    Azure 安全中心这样的安全监控解决方案的优势，用于监控默认配置可能带来的潜在副作用。
- en: 'Let''s apply the suggested remediation to this issue. To solve the privilege
    escalation, you will need to configure the security context of the container to
    no longer allow privilege escalation. This can be done by updating each deployment
    using the following commands:'
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们应用建议的修复措施来解决这个问题。为了解决权限提升问题，你需要配置容器的安全上下文，以不再允许权限提升。这可以通过使用以下命令更新每个部署来实现：
- en: '[PRE8]'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: As you can see in the command, you are patching each deployment. In each patch,
    you are configuring the `securityContext` field and setting the `allowPrivilegeEscalation`
    field to `false`.
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如命令中所示，你正在为每个部署打补丁。在每个补丁中，你配置了`securityContext`字段，并将`allowPrivilegeEscalation`字段设置为`false`。
- en: 'After you have applied the patch, it will take Azure Security Center up to
    30 minutes to refresh the security recommendation. After that time passes, your
    cluster should show up as a healthy resource for this recommendation, as shown
    in *Figure 13.18*:'
  id: totrans-104
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在你应用补丁之后，Azure 安全中心可能需要最多 30 分钟来刷新安全推荐。时间过后，你的集群应该会显示为此推荐的健康资源，如*图 13.18*所示：
- en: '![After following the remediation steps the cluster if now listed as a healthy
    resource for this condition](img/B17338_13_18.jpg)'
  id: totrans-105
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![遵循修复步骤后，集群现在被列为该条件的健康资源](img/B17338_13_18.jpg)'
- en: 'Figure 13.18: Cluster is now healthy for the privilege escalation recommendation'
  id: totrans-106
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.18：集群现在对权限提升推荐是健康的
- en: Let's investigate another recommendation, namely the one called Usage of pod
    HostPath volume mounts should be restricted to a known list to restrict node access
    from compromised containers. Click on this recommendation to be shown more details,
    as shown in *Figure 13.19*:![Investigating the recommendation called “Usage of
    pod HostPath volume mounts should be restricted to a known list to restrict node
    access from compromised containers“](img/B17338_13_19.jpg)
  id: totrans-107
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们调查另一个推荐项，即名为“Pod HostPath 卷挂载的使用应限制在已知列表中，以限制受损容器对节点的访问”。点击此推荐项以查看更多细节，如*图
    13.19*所示：![调查名为“Pod HostPath 卷挂载的使用应限制在已知列表中，以限制受损容器对节点的访问”的推荐](img/B17338_13_19.jpg)
- en: 'Figure 13.19: More details about the HostPath recommendation'
  id: totrans-108
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.19：更多关于 HostPath 推荐的细节
- en: This recommendation shows you similar information to the previous one. However,
    the policy that triggered this recommendation can be tuned to allow certain `HostPath`
    to be accessed. Let's explore how to edit the policy to allow this.
  id: totrans-109
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这个推荐向你展示了类似于之前的推荐信息。然而，触发这个推荐的策略可以进行调整，以允许访问某些`HostPath`。让我们探索如何编辑策略以允许此操作。
- en: Go back to the Azure Security Center main pane and click on Security policy
    on the left-hand side. In the resulting pane, click on your subscription and then
    click on the ASC Default assignment shown in *Figure 13.20*:![Navigating to the
    security policy of your Azure subscription ](img/B17338_13_20.jpg)
  id: totrans-110
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回 Azure 安全中心主面板，在左侧点击“安全策略”。在弹出的面板中，点击你的订阅，然后点击显示在*图 13.20*中的 ASC 默认分配：![导航到你的
    Azure 订阅的安全策略](img/B17338_13_20.jpg)
- en: 'Figure 13.20: ASC default policy assignment'
  id: totrans-111
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.20：ASC 默认策略分配
- en: 'In the resulting pane, click on Parameters at the top of the screen. Look for
    Allowed host paths in the list of parameters and change that parameter to the
    following:'
  id: totrans-112
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在弹出的窗格中，点击屏幕顶部的“参数”选项。查找参数列表中的“允许的主机路径”，并将该参数更改为以下内容：
- en: '[PRE9]'
  id: totrans-113
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'The result is shown in *Figure 13.21*:'
  id: totrans-114
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 结果如 *图 13.21* 所示：
- en: '![Modifying the allowed host path for the ASC Default assignment](img/B17338_13_21.jpg)'
  id: totrans-115
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![修改 ASC 默认分配的允许主机路径](img/B17338_13_21.jpg)'
- en: 'Figure 13.21: Adding a path to the allowed host paths'
  id: totrans-116
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.21：将路径添加到允许的主机路径
- en: 'To apply the changes, click Review + save at the bottom of the screen and then
    click Save on the final screen:'
  id: totrans-117
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 要应用更改，请点击屏幕底部的“审查 + 保存”，然后在最后一个屏幕上点击“保存”：
- en: '![Clicking Save to confirm the modifications](img/B17338_13_22.jpg)'
  id: totrans-118
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![点击保存以确认修改](img/B17338_13_22.jpg)'
- en: 'Figure 13.22: Clicking Save to confirm the policy change'
  id: totrans-119
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.22：点击保存以确认策略更改
- en: It will now take about 30 minutes for the recommendation to be refreshed. After
    30 minutes, this recommendation will no longer be active, since you configured
    the `/tmp` path to be allowed.
  id: totrans-120
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 现在大约需要 30 分钟来刷新建议。30 分钟后，由于你已将 `/tmp` 路径设置为允许，此建议将不再有效。
- en: 'There''s one final recommendation worth highlighting in this list. That is
    Kubernetes Services Management API server should be configured with restricted
    access. If you remember, in *Chapter 11*, *Network security in AKS*, you configured
    authorized IP ranges on your cluster. This is recommended by Microsoft, and also
    shows up as an Azure Security Center recommendation. Click on that recommendation
    to get more details, as shown in *Figure 13.23*:'
  id: totrans-121
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这个列表中还有一个值得特别提到的建议。那就是 Kubernetes 服务管理 API 服务器应配置为限制访问。如果你记得的话，在 *第 11 章*，《AKS
    网络安全》中，你已经为你的集群配置了授权的 IP 范围。微软建议这样做，并且它也会出现在 Azure 安全中心的建议中。点击该建议以获取更多详细信息，如 *图
    13.23* 所示：
- en: '![Investigating the Kubernetes Services Management API server should be configured
    with restricted access recommendation](img/B17338_13_23.jpg)'
  id: totrans-122
  prefs: []
  type: TYPE_IMG
  zh: '![调查 Kubernetes 服务管理 API 服务器应配置为限制访问的建议](img/B17338_13_23.jpg)'
- en: 'Figure 13.23: Details explaining that authorized IP ranges should be enabled'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.23：详细说明应启用授权 IP 范围
- en: 'As you can see, again you get a description of the recommendation and remediation
    steps. The reason this recommendation is worth highlighting is that it contains
    a quick fix remediation within Azure Security Center. To quickly remediate this
    recommendation, select your AKS cluster and click Remediate at the bottom of the
    screen, as shown in *Figure 13.24*:'
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，你会再次看到建议和修复步骤的描述。之所以特别强调这个建议，是因为它在 Azure 安全中心内提供了一个快速修复方法。要快速修复此建议，选择你的
    AKS 集群，然后点击屏幕底部的“修复”按钮，如 *图 13.24* 所示：
- en: '![Remediating the authorized IP recommendation using the quick-fix Remediate
    button](img/B17338_13_24.jpg)'
  id: totrans-125
  prefs: []
  type: TYPE_IMG
  zh: '![使用快速修复按钮修复授权 IP 建议](img/B17338_13_24.jpg)'
- en: 'Figure 13.24: Remediating the authorized IP recommendation'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.24：修复授权 IP 建议
- en: This will show you a view similar to *Figure 13.25* where you could input the
    IP ranges you need to authorize access from.
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 这将显示一个类似 *图 13.25* 的视图，你可以在其中输入需要授权访问的 IP 范围。
- en: '![Setting up authorized IP ranges through Azure Security Center](img/B17338_13_25.jpg)'
  id: totrans-128
  prefs: []
  type: TYPE_IMG
  zh: '![通过 Azure 安全中心设置授权的 IP 范围](img/B17338_13_25.jpg)'
- en: 'Figure 13.25: Setting up authorized IP ranges through Azure Security Center'
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.25：通过 Azure 安全中心设置授权的 IP 范围
- en: You could configure this configuration from within Azure Security Center. Since
    you'll be using Cloud Shell in the next steps and next chapters and Cloud Shell
    does not have a fixed IP, it's not recommended to apply the remediation while
    working through this book. It is, however, worthwhile to show that Azure Security
    Center allows you to remediate certain configuration recommendations directly
    from within Security Center.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以从 Azure 安全中心内配置这个设置。由于在接下来的步骤和章节中你将使用 Cloud Shell，而 Cloud Shell 并没有固定的 IP，因此在本书中操作时不建议应用此修复方法。不过，值得一提的是，Azure
    安全中心允许你直接在安全中心内修复某些配置建议。
- en: 'You have now explored the recommendations and the secure score in Azure Security
    Center. If you want to learn more about this, please refer to the Azure documentation,
    which contains a YAML deployment example fully configured with all the recommendations:
    https://docs.microsoft.com/azure/security-center/kubernetes-workload-protections.'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在已经查看了Azure Security Center中的建议和安全分数。如果你想了解更多内容，请参考Azure文档，文档中包含了一个完整配置了所有建议的YAML部署示例：https://docs.microsoft.com/azure/security-center/kubernetes-workload-protections。
- en: Neutralizing threats using Azure Defender
  id: totrans-132
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 使用Azure Defender中和威胁
- en: Now that you've explored the configuration best practices using Azure Security
    Center and Secure Score, you will explore how to investigate and deal with security
    alerts and active threats. Some of the workloads you created should have triggered
    security alerts by now, which you can investigate in Azure Defender.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 现在你已经通过Azure Security Center和安全分数探索了配置最佳实践，你将探索如何调查和处理安全警报和主动威胁。你创建的一些工作负载应该已经触发了安全警报，你可以在Azure
    Defender中调查这些警报。
- en: 'Specifically, in the *Deploying offending workloads* section, you created three
    workloads that trigger security alerts in Azure Defender:'
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 具体来说，在*部署违规工作负载*部分，你创建了三个会触发Azure Defender安全警报的工作负载：
- en: '`crypto-miner.yaml`: By deploying this file, you created a crypto-miner on
    your cluster. This crypto-miner will generate two security alerts in Azure Defender
    as you will see in this section. One alert will be generated by monitoring the
    Kubernetes cluster itself, while another alert will be generated based on DNS
    traffic.'
  id: totrans-135
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`crypto-miner.yaml`：通过部署此文件，你在集群中创建了一个加密矿工。这个加密矿工将在Azure Defender中生成两个安全警报，如本节所示。一个警报将通过监控Kubernetes集群本身生成，另一个警报将基于DNS流量生成。'
- en: '`role.yaml`: This file contained a cluster-wide role with very broad permissions.
    This will generate a security alert in Azure Defender notifying you of the risk.'
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`role.yaml`：这个文件包含一个具有非常广泛权限的集群级角色。这将在Azure Defender中生成一个安全警报，通知你存在风险。'
- en: 'Kubernetes dashboard: You also created the Kubernetes dashboard and exposed
    this publicly. Azure Defender will also generate a security alert based on this.'
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: Kubernetes仪表板：你还创建了Kubernetes仪表板并公开了它。Azure Defender也会基于此生成一个安全警报。
- en: 'Let''s explore each of these security alerts in details:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们详细探索每一个安全警报：
- en: To start, in Azure Security Center, click on Azure Defender in the left-hand
    navigation bar. This will open the Azure Defender pane in Azure Security Center.
    This shows you your coverage, your security alerts, and the advanced protection
    options, as shown in *Figure 13.26*. In this section, you will focus on the four
    security alerts that were generated.![Azure Defender overview pane](img/B17338_13_26.jpg)
  id: totrans-139
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 首先，在Azure Security Center中，点击左侧导航栏中的Azure Defender。这将打开Azure Security Center中的Azure
    Defender面板，显示你的覆盖范围、安全警报和高级保护选项，如*图13.26*所示。在本节中，你将重点关注生成的四个安全警报。![Azure Defender概览面板](img/B17338_13_26.jpg)
- en: 'Figure 13.26: Azure Defender - Overview pane'
  id: totrans-140
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图13.26：Azure Defender - 概览面板
- en: To get more details about the security alerts, click anywhere on the Security
    alerts bar chart in the middle of the screen. That will take you to a new pane,
    as shown in *Figure 13.27*:![Clicking on the Security alerts bar chart provides
    details about the severity of the alert, their status, and the affected resource](img/B17338_13_27.jpg)
  id: totrans-141
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要查看有关安全警报的更多详细信息，请点击屏幕中间的安全警报柱状图。这将带你到一个新面板，如*图13.27*所示：![点击安全警报柱状图可查看警报的严重性、状态和受影响的资源的详细信息](img/B17338_13_27.jpg)
- en: 'Figure 13.27: Security alerts in Azure Defender'
  id: totrans-142
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图13.27：Azure Defender中的安全警报
- en: 'As you can see in *Figure 13.27*, four security alerts have been triggered:
    one for the exposed Kubernetes dashboard, two for the crypto-miner, and one for
    the high-privileged roles. Let''s explore each one in more detail.'
  id: totrans-143
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如*图13.27*所示，四个安全警报已被触发：一个是暴露的Kubernetes仪表板，两个是加密矿工，另一个是高权限角色。我们将更详细地探索每个警报。
- en: Let's start by exploring the Exposed Kubernetes dashboard detected alert. Click
    on the alert title to get more details. To see all the details, click on View
    full details in the resulting pane, as shown in *Figure 13.28*:![Clicking on View
    full details after selecting an alert will provide the details of the alert](img/B17338_13_28.jpg)
  id: totrans-144
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们首先探索检测到的暴露的Kubernetes仪表板警报。点击警报标题以获取更多详细信息。要查看所有细节，请点击结果面板中的“查看完整详情”，如*图13.28*所示：![点击查看完整详情后，将显示警报的详细信息](img/B17338_13_28.jpg)
- en: 'Figure 13.28: Getting full details of the alert'
  id: totrans-145
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图13.28：获取警报的完整详情
- en: 'This will take you to a new pane, as shown in *Figure 13.29*:'
  id: totrans-146
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将带你到一个新面板，如*图13.29*所示：
- en: '![Details of the Exposed Kubernetes Dashboard detected alert](img/B17338_13_29.jpg)'
  id: totrans-147
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![暴露的Kubernetes仪表板检测到的警报详细信息](img/B17338_13_29.jpg)'
- en: 'Figure 13.29: Details of the Exposed Kubernetes dashboard detected alert'
  id: totrans-148
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.29：暴露的Kubernetes仪表板检测到的警报详细信息
- en: This shows you a couple of information points. First, it classifies this alert
    as high severity, marks it as active, and also marks when it was first encountered.
    Next, you get a description of the alert, which in this case explains that the
    dashboard should not be exposed publicly. It also shows you the affected resource.
    Finally, you see which stage of the MITRE ATT&CK® tactics framework this attack
    targets. The MITRE ATT&CK® tactics framework is a framework describing multiple
    stages in a cyber-attack. For more information on MITRE ATT&CK® tactics, please
    refer to [https://attack.mitre.org/versions/v7/](https://attack.mitre.org/versions/v7/).
  id: totrans-149
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这显示了几个信息点。首先，它将此警报分类为高严重性，标记为活动状态，并标记首次出现的时间。接下来，你将看到警报的描述，在此案例中，它解释了仪表板不应公开暴露。它还显示了受影响的资源。最后，你会看到该攻击针对的是MITRE
    ATT&CK®战术框架中的哪个阶段。MITRE ATT&CK®战术框架描述了网络攻击的多个阶段。有关MITRE ATT&CK®战术的更多信息，请参阅[https://attack.mitre.org/versions/v7/](https://attack.mitre.org/versions/v7/)。
- en: 'On the right-hand side of the screen, you get more details about the alert.
    This contains the service name, the namespace, the port of the service, the target
    port exposed on the backend pods, and the affected Azure resource ID and subscription
    ID. If you click the Next: Take Action >> button at the bottom of the screen,
    you''ll be taken to a new pane, as shown in *Figure 13.30*:'
  id: totrans-150
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在屏幕的右侧，你将获得更多关于警报的详细信息。这些信息包括服务名称、命名空间、服务的端口、后端Pod上暴露的目标端口，以及受影响的Azure资源ID和订阅ID。如果你点击屏幕底部的“下一步：采取行动
    >>”按钮，你将进入一个新面板，如*图13.30*所示：
- en: '![The Take action pane provides information on how to mitigate the threat and
    how to prevent future attacks](img/B17338_13_30.jpg)'
  id: totrans-151
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![操作面板提供了关于如何缓解威胁和如何防止未来攻击的信息](img/B17338_13_30.jpg)'
- en: 'Figure 13.30: Security recommendations on the dashboard alert'
  id: totrans-152
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.30：仪表板警报的安全建议
- en: In the Take action pane, you get information on how to mitigate the threat and
    how to prevent future attacks like this. Notice how the Prevent future attacks
    section contains a link to the security recommendations you reviewed in the previous
    section.
  id: totrans-153
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在操作面板中，你可以获得关于如何缓解威胁和如何防止未来类似攻击的信息。请注意，“防止未来攻击”部分包含了你在前一节中查看的安全建议的链接。
- en: Let's take the suggested action and update the Kubernetes dashboard service
    so it is no longer of the `LoadBalancer` type using the following command. This
    command will remove the `nodePort` that Kubernetes set up to expose the service
    through the load balancer and change the type of the service back to the `ClusterIP`
    type, which is only available from within the cluster.
  id: totrans-154
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们采取建议的行动，使用以下命令更新Kubernetes仪表板服务，使其不再是`LoadBalancer`类型。此命令将删除Kubernetes设置的通过负载均衡器暴露服务的`nodePort`，并将服务类型更改回仅在集群内部可用的`ClusterIP`类型。
- en: '[PRE10]'
  id: totrans-155
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Finally, you see that you can optionally trigger automated responses or suppress
    similar alerts in the future in case this alert is a false positive.
  id: totrans-156
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 最后，你将看到可以选择触发自动响应或在未来抑制类似的警报，以防该警报是误报。
- en: Now that you have mitigated the threat, you can dismiss the alert. That way,
    others using the same subscription don't see this same alert. To dismiss the alert,
    click on the status on the left-hand side of the screen, select Dismissed, and
    click OK, as shown in *Figure 13.31*:![Dismissing the dashboard alert after the
    threat has been mitigated](img/B17338_13_31.jpg)
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在你已经缓解了威胁，可以关闭该警报。这样，使用相同订阅的其他人就不会看到相同的警报。要关闭警报，请点击屏幕左侧的状态，选择“已关闭”，然后点击“确定”，如*图13.31*所示：![在威胁已被缓解后关闭仪表板警报](img/B17338_13_31.jpg)
- en: 'Figure 13.31: Dismissing the dashboard alert'
  id: totrans-158
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图 13.31：关闭仪表板警报
- en: Let's move on to the next alert. Close the detail panes for the dashboard alert
    by pressing the X at the top of the screen. Let's now focus on the first Digital
    currency mining container detected alert. Select that alert and click on View
    full details as you did with the previous alert. This will take you to a pane
    similar to *Figure 13.32*:![Investigating the Digital currency mining container
    detected alert](img/B17338_13_32.jpg)
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们继续查看下一个警报。通过点击屏幕顶部的X关闭仪表盘警报的详细窗格。现在让我们关注第一个“数字货币挖掘容器检测警报”。选择该警报并像之前一样点击“查看完整详情”。这将带你进入一个与*图13.32*相似的窗格：![调查数字货币挖掘容器检测警报](img/B17338_13_32.jpg)
- en: 'Figure 13.32: Details of the Digital currency mining container detected alert'
  id: totrans-160
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图13.32：数字货币挖掘容器检测警报的详情
- en: This view contains similar details to the previous alert. As you can see, this
    alert is part of the Execution phase of the MITRE ATT&CK® tactics framework. On
    the right-hand side of the pane, you now see the name of the offending container,
    the image it's using, its namespace, and the name of the offending pod.
  id: totrans-161
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这个视图包含了与上一个警报类似的详细信息。正如你所看到的，这个警报属于MITRE ATT&CK®策略框架中的“执行”阶段。在窗格的右侧，你现在可以看到受影响容器的名称、它使用的镜像、它的命名空间以及受影响pod的名称。
- en: 'If you press the Next: Take Action >> button at the bottom of the screen, you''ll
    be taken to the Take action view on this alert, as shown in *Figure 13.33*:'
  id: totrans-162
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '如果你点击屏幕底部的“Next: Take Action >>”按钮，你将进入该警报的“Take action”视图，如*图13.33*所示：'
- en: '![The Take action pane provides information on how to mitigate the threat and
    how to prevent future attacks](img/B17338_13_33.jpg)'
  id: totrans-163
  prefs:
  - PREF_IND
  type: TYPE_IMG
  zh: '![Take action窗格提供有关如何缓解威胁和如何防止未来攻击的信息](img/B17338_13_33.jpg)'
- en: 'Figure 13.33: Security recommendations on the Digital currency mining container
    detected alert'
  id: totrans-164
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图13.33：数字货币挖掘容器检测警报的安全建议
- en: Here, again, you see similar details to the previous alert. In the Mitigate
    the threat section, you get a different description of how to mitigate this ongoing
    threat. Don't take any mitigating action yet, since you'll need to explore one
    more alert related to the crypto-miner.
  id: totrans-165
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在这里，你再次看到与上一个警报类似的详细信息。在“缓解威胁”部分，你会看到如何缓解当前威胁的不同描述。暂时不要采取任何缓解措施，因为你还需要查看与加密矿工相关的另一个警报。
- en: 'To explore that alert, close the detailed pane for the first crypto-miner alert
    by pressing the X at the top of the screen. Now select the second alert, which
    is called Digital currency mining activity (Preview). This is actually not a Kubernetes
    alert, but an alert based on DNS, as you can see in *Figure 13.34*:'
  id: totrans-166
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要查看该警报，首先通过点击屏幕顶部的X关闭第一个加密矿工警报的详细窗格。现在选择第二个警报，名为“数字货币挖掘活动（预览）”。这实际上不是一个Kubernetes警报，而是一个基于DNS的警报，正如*图13.34*所示：
- en: Note
  id: totrans-167
  prefs:
  - PREF_IND
  - PREF_H4
  type: TYPE_NORMAL
  zh: 注意
- en: '[PRE11]'
  id: totrans-168
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: This will resolve the alert. To actually mark it as resolved, you can dismiss
    the alert in the Azure portal. To do this, click on the status on the left-hand
    side of the screen, select the Dismissed status, and click OK, as shown in *Figure
    13.36*:![Dismissing the Digital currency mining activity (Preview) alert after
    the threat has been mitigated](img/B17338_13_36.jpg)
  id: totrans-169
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 这将解决警报。要真正标记为已解决，你可以在Azure门户中取消警报。为此，点击屏幕左侧的状态，选择“已取消”状态，然后点击“确定”，如*图13.36*所示：![在威胁缓解后取消数字货币挖掘活动（预览）警报](img/B17338_13_36.jpg)
- en: 'Figure 13.36: Dismissing the digital currency DNS alert'
  id: totrans-170
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 图13.36：取消数字货币DNS警报
- en: 'From the Security alerts pane, click on the last alert, which is called New
    high privileges role detected, and click on View full details in the resulting
    pane. This will bring you to a pane similar to *Figure 13.37*:'
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在安全警报窗格中，点击最后一个警报，名为“检测到新的高权限角色”，然后在出现的窗格中点击“查看完整详情”。这将带你进入一个与*图13.37*相似的窗格：
- en: '![Exploring the New high privileges role detected alert](img/B17338_13_37.jpg)'
  id: totrans-172
  prefs: []
  type: TYPE_IMG
  zh: '![探索新的高权限角色检测警报](img/B17338_13_37.jpg)'
- en: 'Figure 13.37: New high privileges role detected alert'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 图13.37：新的高权限角色检测警报
- en: This is a low-severity alert. As with the previous alerts, you get the description,
    the affected resource, and the phase in the MITRE ATT&CK® tactics framework, which
    is persistence in this case. This means that this potential attack is used by
    attackers to gain persistent access to your environment.
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个低严重性的警报。与之前的警报一样，你会看到描述、受影响的资源以及MITRE ATT&CK®策略框架中的阶段，在这种情况下是“持久性”阶段。这意味着攻击者可能利用此潜在攻击获得对环境的持久访问权限。
- en: 'On the right-hand side, you also get the alert details, with the role name,
    the namespace (which in this case is the whole cluster since it is a `ClusterRole`),
    and the rules this role gives access to. If you click the Next: Take Action >>
    button, you''ll get more information about the mitigation as well, as shown in
    *Figure 13.38*:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 在右侧，你还可以看到警报的详细信息，包括角色名称、命名空间（在本例中是整个集群，因为这是一个`ClusterRole`）以及该角色所授予的访问规则。如果你点击“下一步：采取行动
    >>”按钮，你将看到有关缓解措施的更多信息，如*图 13.38*所示：
- en: '![The Take action pane provides information on how to mitigate the threat and
    how to prevent future attacks](img/B17338_13_38.jpg)'
  id: totrans-176
  prefs: []
  type: TYPE_IMG
  zh: '![操作面板提供有关如何缓解威胁和防止未来攻击的信息](img/B17338_13_38.jpg)'
- en: 'Figure 13.38: Security recommendations on the new high privileges alert'
  id: totrans-177
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.38：新的高权限警报上的安全建议
- en: 'As you can see here, Azure recommends you review the role in the alerts and
    check any role bindings linked to this role. It is also recommended to grant more
    restricted privileges than the open permissions as provided in this role. Let''s
    also remove this threat from the cluster using the following command:'
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，Azure 建议你查看警报中的角色并检查与该角色关联的任何角色绑定。同时建议授予比该角色中提供的开放权限更为严格的权限。让我们使用以下命令从集群中移除这个威胁：
- en: '[PRE12]'
  id: totrans-179
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'This will delete the role from the cluster. You can also dismiss this alert,
    by clicking on the status on the left-hand side of the screen, selecting the Dismissed
    state, and clicking OK, as shown in *Figure 13.39*:'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: 这将从集群中删除该角色。你还可以通过点击屏幕左侧的状态，选择“已取消”状态，并点击确定来取消此警报，如*图 13.39*所示：
- en: '![Dismissing the high privileges role alert after the threat has been mitigated](img/B17338_13_39.jpg)'
  id: totrans-181
  prefs: []
  type: TYPE_IMG
  zh: '![在威胁缓解后取消高权限角色警报](img/B17338_13_39.jpg)'
- en: 'Figure 13.39: Dismissing the New high privileges alert'
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: 图 13.39：取消新的高权限警报
- en: 'This covers all the alerts that were generated by the resources you created
    earlier in this chapter. The resources linked to the alerts were already deleted
    as part of the remediation, but let''s also delete the other resources that were
    created in this chapter:'
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 这涵盖了本章中你之前创建的资源所生成的所有警报。与警报相关的资源已经在修复过程中被删除，但让我们也删除本章中创建的其他资源：
- en: '[PRE13]'
  id: totrans-184
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: And that concludes this chapter.
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 本章内容到此结束。
- en: Summary
  id: totrans-186
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 总结
- en: In this chapter, you explored Azure Security Center and Azure Defender. Azure
    Security Center is an infrastructure security monitoring platform. It provides
    both monitoring of security configuration as well as monitoring of any potential
    ongoing threats. To monitor workloads in a Kubernetes cluster, Azure Security
    Center makes use of Azure Policy for AKS.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: 本章中，你探索了 Azure 安全中心和 Azure Defender。Azure 安全中心是一个基础设施安全监控平台，提供安全配置监控以及潜在正在进行的威胁监控。为了监控
    Kubernetes 集群中的工作负载，Azure 安全中心利用了 Azure Policy for AKS。
- en: To start, you enabled Azure Policy for AKS. You then enabled Azure Security
    Center and Azure Defender on your subscription.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，你启用了 AKS 的 Azure Policy。然后你在订阅中启用了 Azure 安全中心和 Azure Defender。
- en: You then created five harmful workloads on your cluster. Some of those caused
    configuration recommendations in Azure Security Center. Some others even caused
    security alerts to be triggered in Azure Defender. You explored four security
    alerts and followed the mitigation steps recommended to resolve these alerts.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: 然后你在集群中创建了五个有害的工作负载。其中一些在 Azure 安全中心触发了配置建议，另一些甚至在 Azure Defender 中触发了安全警报。你查看了四个安全警报，并按照推荐的缓解步骤解决了这些警报。
