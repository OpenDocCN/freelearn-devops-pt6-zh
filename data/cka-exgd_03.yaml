- en: '3'
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: '3'
- en: Maintaining Kubernetes Clusters
  id: totrans-1
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 维护 Kubernetes 集群
- en: Kubernetes has been the most vibrant platform in the community over the past
    few years and it has maintained a good release cadence, which makes Kubernetes
    maintenance important in order to enable organizations that work with Kubernetes
    to take advantage of its latest features. This chapter introduces different approaches
    for maintaining a Kubernetes cluster while providing practical lessons on performing
    upgrades for Kubernetes clusters, etcd backup, and etcd restore. It covers 25%
    of the CKA exam content.
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 在过去几年里，Kubernetes 一直是社区中最具活力的平台，并保持了良好的发布节奏，这使得 Kubernetes 的维护变得尤为重要，以便与 Kubernetes
    合作的组织能够利用其最新功能。本章介绍了维护 Kubernetes 集群的不同方法，同时提供了进行 Kubernetes 集群升级、etcd 备份和 etcd
    恢复的实用教程。它涵盖了 CKA 考试内容的 25%。
- en: 'In this chapter, we’re going to cover the following main topics:'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将讨论以下主要主题：
- en: Demystifying Kubernetes cluster maintenance
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 解密 Kubernetes 集群维护
- en: Performing a version upgrade on a Kubernetes cluster using kubeadm
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 kubeadm 对 Kubernetes 集群进行版本升级
- en: Working with etcd
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 与 etcd 配合工作
- en: Backing up and restoring etcd
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 备份和恢复 etcd
- en: Demystifying Kubernetes cluster maintenance
  id: totrans-8
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 解密 Kubernetes 集群维护
- en: Before April 2021, Kubernetes had maintained quite a steady and sound cadence
    of quarterly releases throughout the year. Despite the strong growth and incredible
    popularity in the community, this was reduced to three releases per year. Fewer
    releases still mean that a regular maintenance window should be scheduled within
    the organization for the upgrade of security patches, and to take full advantage
    of enhancements and new features.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: 2021 年 4 月之前，Kubernetes 一直保持着全年每季度发布的稳定节奏。尽管在社区中的增长和广泛的流行，这一节奏被缩减为每年三次发布。更少的发布仍意味着应该在组织内部安排定期的维护窗口，以便升级安全补丁，并充分利用增强功能和新特性。
- en: 'A general maintenance window contains the upgraded Kubernetes cluster version.
    We can easily break the task to be performed into two parts:'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 一般的维护窗口包括升级的 Kubernetes 集群版本。我们可以将要执行的任务分为两部分：
- en: Upgrading the master node, which contains the control plane
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 升级主节点，主节点包含控制平面
- en: Upgrading the worker node
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 升级工作节点
- en: Upgrading the master node is simple if you have only one master node. However,
    most enterprise-grade customers may have a couple of master nodes for better resilience.
    We should be aware that working with an organization as a Kubernetes administrator
    is sometimes more challenging than working with other ones. A general reference
    of master node management would be the two typologies of high availability mentioned
    in [*Chapter 2*](B18201_02.xhtml#_idTextAnchor035), *Installing and Configuring
    Kubernetes Clusters*. The conventional way to upgrade the master node is to upgrade
    one at a time regardless of the number of master nodes in your current cluster.
    You will need to upgrade the kubeadm and kubectl versions.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 如果只有一个主节点，升级主节点是简单的。然而，大多数企业级客户可能会有多个主节点以增强弹性。我们应当意识到，作为 Kubernetes 管理员与组织合作有时比与其他组织合作更具挑战性。主节点管理的一般参考可以参见在[*第二章*](B18201_02.xhtml#_idTextAnchor035)《安装与配置
    Kubernetes 集群》中提到的高可用性两种类型。升级主节点的常规方式是无论当前集群中的主节点数量如何，都逐个升级。你需要升级 kubeadm 和 kubectl
    版本。
- en: When it comes to worker node upgrade, as we mentioned in the previous chapter,
    the worker node is where your workloads are actually running; therefore, you need
    to upgrade both the kubeadm and kubelet versions. Keep in mind that you need to
    upgrade one at a time when it comes to multiple worker nodes available in the
    current Kubernetes cluster.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 关于工作节点的升级，正如我们在上一章提到的，工作节点是实际运行你工作负载的地方；因此，你需要同时升级 kubeadm 和 kubelet 版本。请记住，当当前
    Kubernetes 集群中有多个工作节点时，你需要逐个升级。
- en: 'If you have a separate etcd cluster set up, you will need to upgrade the etcd
    store version, which is not covered in the CKA exam. In general, you need to check
    out the official documentation to know more about Kubernetes components and version
    compatibility here: [https://kubernetes.io/releases/version-skew-policy/](https://kubernetes.io/releases/version-skew-policy/).'
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你设置了一个独立的 etcd 集群，你需要升级 etcd 存储版本，这在 CKA 考试中没有涵盖。通常，你需要查阅官方文档，了解更多关于 Kubernetes
    组件和版本兼容性的信息，链接在此：[https://kubernetes.io/releases/version-skew-policy/](https://kubernetes.io/releases/version-skew-policy/)。
- en: 'Another general task for Kubernetes cluster maintenance is backup and restore
    with the etcd store. The etcd stores cluster data that includes cluster state
    information such as pod state data, node state data, and the configurations critical
    for Kubernetes. In most cases, as a Kubernetes administrator, you will need to
    perform the following two key tasks:'
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes集群维护的另一个常见任务是使用etcd存储进行备份和恢复。etcd存储着集群数据，包括集群状态信息，如pod状态数据、节点状态数据，以及Kubernetes所需的关键配置。通常情况下，作为Kubernetes管理员，你需要执行以下两个关键任务：
- en: Back up the etcd store regularly
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 定期备份etcd存储
- en: Restore the etcd from cluster failure
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从集群故障恢复etcd
- en: The following section will firstly walk you through the general process of upgrading
    the Kubernetes cluster with kubeadm. This is one of the most time-consuming questions
    in the actual CKA exam. Make sure you practice it a few times until you master
    the general upgrade process as well as how to perform upgrade tasks by following
    the official Kubernetes documentation. Note that update policies vary for managed
    Kubernetes distributions by cloud vendors. Please check their respective official
    documentation.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 以下部分将首先带你了解使用kubeadm升级Kubernetes集群的一般流程。这是实际CKA考试中最耗时的问题之一。确保你多练习几次，直到掌握一般的升级流程，并能够按照Kubernetes官方文档执行升级任务。请注意，云供应商的托管Kubernetes发行版的更新政策各不相同，请查阅它们各自的官方文档。
- en: Furthermore, we’ll take a look at how to back up and restore an etcd cluster.
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 此外，我们将了解如何备份和恢复etcd集群。
- en: Upgrading a Kubernetes cluster using kubeadm
  id: totrans-21
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用kubeadm升级Kubernetes集群
- en: 'Kubernetes versions follow semantic versioning, and are expressed in three
    parts:'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: Kubernetes版本遵循语义化版本控制，表达形式为三部分：
- en: Major version
  id: totrans-23
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 主版本
- en: Minor version
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 小版本
- en: Patch version
  id: totrans-25
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 补丁版本
- en: For example, Kubernetes version 1.23.3 means that it is Kubernetes 1.23 minor
    version with patch number 3\. Similarly, 1.22 and 1.21 are both minor versions
    like 1.23.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，Kubernetes版本1.23.3表示它是Kubernetes 1.23的小版本，补丁号为3。类似地，1.22和1.21也是类似1.23的小版本。
- en: At the time of writing this book, Kubernetes 1.19+ has one year of path support.
    That means for Kubernetes 1.23, released in January 2022, the end of support will
    be February 2023\. For Kubernetes 1.8 and older, the support patch was shortened
    to roughly 9 months instead. **Special interest group** (**SIG**) releases manage
    the Kubernetes release cycle, and the best way to keep track of the release schedule
    is to follow them at [https://github.com/kubernetes/sig-release/tree/master/releases](https://github.com/kubernetes/sig-release/tree/master/releases)
    and read the change log at [https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG](https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG)
    to keep up to date.
  id: totrans-27
  prefs: []
  type: TYPE_NORMAL
  zh: 在编写本书时，Kubernetes 1.19+有一年的路径支持。这意味着对于2022年1月发布的Kubernetes 1.23，支持结束时间是2023年2月。而对于Kubernetes
    1.8及更早版本，支持补丁的时间缩短至大约9个月。**兴趣小组**（**SIG**）负责管理Kubernetes的发布周期，跟踪发布计划的最佳方式是关注他们的[https://github.com/kubernetes/sig-release/tree/master/releases](https://github.com/kubernetes/sig-release/tree/master/releases)，并阅读[https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG](https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG)上的更改日志，保持最新。
- en: If you would like to upgrade a cluster to a targeted version, check out supported
    versions at [https://kubernetes.io/releases/version-skew-policy/#supported-versions](https://kubernetes.io/releases/version-skew-policy/#supported-versions).
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想将集群升级到目标版本，可以查看[https://kubernetes.io/releases/version-skew-policy/#supported-versions](https://kubernetes.io/releases/version-skew-policy/#supported-versions)上的受支持版本。
- en: Upgrading the master node
  id: totrans-29
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 升级主节点
- en: 'Before you upgrade the master node, make sure you know the purpose of your
    upgrade and have backed up any important components. It is recommended that you
    start with checking out the current version and then determining which version
    to upgrade to. Once decided, we’ll perform the following actions to upgrade the
    master node as depicted in *Figure 2.1*, including upgrading with kubeadm and
    interacting with Kubernetes nodes:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 在升级主节点之前，确保你了解升级的目的，并已备份任何重要组件。建议先检查当前版本，然后决定要升级到哪个版本。一旦决定，我们将执行以下操作来升级主节点，如*图
    2.1*所示，包括使用kubeadm进行升级并与Kubernetes节点交互：
- en: '![Figure 3.1 – Master node upgrade process  ](img/Figure_3.01_B18201.jpg)'
  id: totrans-31
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.1 – 主节点升级过程](img/Figure_3.01_B18201.jpg)'
- en: Figure 3.1 – Master node upgrade process
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.1 – 主节点升级过程
- en: 'Let’s start by checking out the current version with the following commands
    once we’re in the master node:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们进入主节点，就让我们开始检查当前版本，通过以下命令：
- en: '[PRE0]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'From the output, we know that we are currently on Kubernetes 2.23.2:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 从输出中，我们知道我们当前使用的是Kubernetes 2.23.2：
- en: '[PRE1]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Let’s check out the latest versions available with the following commands:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们通过以下命令查看可用的最新版本：
- en: '[PRE2]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Now we know the latest versions available:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 现在我们知道可用的最新版本：
- en: '![Figure 3.2 – Available versions   ](img/Figure_3.02_B18201.jpg)'
  id: totrans-40
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.2 – 可用版本](img/Figure_3.02_B18201.jpg)'
- en: Figure 3.2 – Available versions
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.2 – 可用版本
- en: 'Once we have made up our mind about which version we want to upgrade to, let’s
    start prepping for the upgrade process:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦我们决定了想要升级到哪个版本，就可以开始准备升级过程：
- en: 'We will start by upgrading kubeadm where we will need to use the following
    command to replace *x* in 1.23.x-00 with the latest patch version, which is 1.23.3
    in our case:'
  id: totrans-43
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们将从升级kubeadm开始，需要使用以下命令将1.23.x-00中的*x*替换为最新的补丁版本，在我们的情况下是1.23.3：
- en: '[PRE3]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'The output of the `apt-mark` command is the following:'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: '`apt-mark`命令的输出如下：'
- en: '[PRE4]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Now we can check the version of kubeadm with the `kubeadm version` command
    and see whether it’s 1.23.3:'
  id: totrans-47
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们可以使用`kubeadm version`命令检查kubeadm的版本，看看它是否是1.23.3：
- en: '[PRE5]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'We use the `kubeadm upgrade plan` command to check whether the current cluster
    can be upgraded and the available versions that it can be upgraded to:'
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们使用`kubeadm upgrade plan`命令检查当前集群是否可以升级，以及它可以升级到哪些可用版本：
- en: '[PRE6]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'As shown in *Figure 3.3*, I can upgrade the kubelet and control plane components
    such as the API server, scheduler, and controller manager from 1.23.2 to 1.23.3:'
  id: totrans-51
  prefs: []
  type: TYPE_NORMAL
  zh: 如*图 3.3*所示，我可以将kubelet和控制平面组件（如API服务器、调度器和控制器管理器）从1.23.2升级到1.23.3：
- en: '![Figure 3.3 – kubeadm upgrade plan  ](img/Figure_3.03_B18201.jpg)'
  id: totrans-52
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.3 – kubeadm 升级计划](img/Figure_3.03_B18201.jpg)'
- en: Figure 3.3 – kubeadm upgrade plan
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.3 – kubeadm 升级计划
- en: 'If we decide to take action to upgrade the current cluster from 1.23.2 to 1.23.3,
    we can use the following command. Note that after `apply`, you just replace 1.23.3
    for any future available versions that you wish to upgrade to:'
  id: totrans-54
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果我们决定采取行动，将当前集群从1.23.2升级到1.23.3，可以使用以下命令。请注意，在`apply`之后，你只需替换为任何未来的可用版本，升级到你希望的版本：
- en: '[PRE7]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Important Note
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: To perform the upgrade operation smoothly, we recommend you get root permission
    in the exam by running the `sudo su` command.
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: 为了顺利执行升级操作，我们建议你通过运行`sudo su`命令获取考试中的root权限。
- en: In your daily upgrade task, you can use `sudo` and input your password to perform
    this operation.
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 在日常升级任务中，你可以使用`sudo`并输入密码来执行此操作。
- en: 'Once you have given the command, you will get a message stating that the upgrade
    was a success:'
  id: totrans-59
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦执行命令，你会看到一条消息，表明升级成功：
- en: '![Figure 3.4 – Control plane successfully upgraded ](img/Figure_3.04_B18201.jpg)'
  id: totrans-60
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.4 – 控制平面成功升级](img/Figure_3.04_B18201.jpg)'
- en: Figure 3.4 – Control plane successfully upgraded
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.4 – 控制平面成功升级
- en: 'We then need to cordon the node, so we drain the workloads to prepare the node
    for maintenance. We cordon a node called `cloudmelonplaysrv` with the following
    command:'
  id: totrans-62
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后我们需要隔离节点，因此我们将清理工作负载以准备节点进行维护。我们用以下命令隔离一个名为`cloudmelonplaysrv`的节点：
- en: '[PRE8]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'It will display a bunch of pods being evicted, which means those pods are being
    eliminated from the cordoned worker nodes:'
  id: totrans-64
  prefs: []
  type: TYPE_NORMAL
  zh: 它将显示一堆正在被驱逐的Pod，意味着这些Pod正在从被隔离的工作节点中被移除：
- en: '![Figure 3.5 – Draining workloads on the node ](img/Figure_3.05_B18201.jpg)'
  id: totrans-65
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.5 – 在节点上清理工作负载](img/Figure_3.05_B18201.jpg)'
- en: Figure 3.5 – Draining workloads on the node
  id: totrans-66
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.5 – 在节点上清理工作负载
- en: If you’re using the `kubectl get no` command, the node will be marked as `schedulingDisabled`.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你正在使用`kubectl get no`命令，节点将被标记为`schedulingDisabled`。
- en: 'We use the following command to upgrade the kubelet and kubectl:'
  id: totrans-68
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们使用以下命令来升级kubelet和kubectl：
- en: '[PRE9]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Restart the kubelet:'
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重启kubelet：
- en: '[PRE10]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'Now we can uncordon the node and it will make the workloads schedulable again
    on the node that’s being upgraded, called `cloudmelonplaysrv`:'
  id: totrans-72
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在我们可以解锁该节点，这样正在升级的节点`cloudmelonplaysrv`上的工作负载就可以再次调度：
- en: '[PRE11]'
  id: totrans-73
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: This command will return the node that is now shown as `uncordoned`.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令将返回现在显示为`uncordoned`的节点。
- en: Upgrading the worker node
  id: totrans-75
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 升级工作节点
- en: 'Since the worker node is where your workloads are actually up and running,
    we need to perform an upgrade one at a time and then replicate the same operation
    to all the other worker nodes available in the current Kubernetes cluster. *Figure
    3.6* depicts the general upgrade workflow:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 由于工作节点是实际运行工作负载的地方，我们需要逐一升级，然后将相同的操作复制到当前Kubernetes集群中的所有其他工作节点上。*图 3.6*描绘了总体的升级工作流：
- en: '![Figure 3.6 – Draining workloads on the node ](img/Figure_3.06_B18201.jpg)'
  id: totrans-77
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.6 – 在节点上排空工作负载](img/Figure_3.06_B18201.jpg)'
- en: Figure 3.6 – Draining workloads on the node
  id: totrans-78
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.6 – 在节点上排空工作负载
- en: 'Let’s start with upgrading the kubeadm from 1.23.2 to 1.23.3 with the following
    command:'
  id: totrans-79
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 让我们从使用以下命令将kubeadm从1.23.2升级到1.23.3开始：
- en: '[PRE12]'
  id: totrans-80
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'For a worker node, we upgrade the kubelet, which also upgrades the local kubelet
    configuration, with the following command:'
  id: totrans-81
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于工作节点，我们升级kubelet，这也会升级本地kubelet配置，使用以下命令：
- en: '[PRE13]'
  id: totrans-82
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Similarly, we need to cordon the node so we drain the workloads to prepare
    the node for maintenance. Here, we are cordoning a node called `cloudmelonplayclient`
    using the following command:'
  id: totrans-83
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 同样，我们需要对节点进行cordon操作，这样我们就能将工作负载迁移出去，为节点的维护做准备。在这里，我们使用以下命令对一个名为`cloudmelonplayclient`的节点进行cordon操作：
- en: '[PRE14]'
  id: totrans-84
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: We can then use the `kubectl get no` command to check the node status. It will
    be marked as `schedulingDisabled`.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，我们可以使用`kubectl get no`命令来检查节点状态。它将标记为`schedulingDisabled`。
- en: 'We use the following command to upgrade the kubelet and kubectl just as we
    did for the master node:'
  id: totrans-86
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们使用以下命令来升级kubelet和kubectl，就像我们对主节点所做的那样：
- en: '[PRE15]'
  id: totrans-87
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Restart the kubelet for the changes to take effect:'
  id: totrans-88
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重启kubelet以使更改生效：
- en: '[PRE16]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: 'Finally, we can `uncordon` the node and it will make the workloads schedulable
    again on the node called `cloudmelonplayclient`. It will return the node that
    is now shown as `uncordoned`:'
  id: totrans-90
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，我们可以`uncordon`节点，它将使工作负载重新能够调度到名为`cloudmelonplayclient`的节点上。它将返回节点，显示为`uncordoned`状态：
- en: '[PRE17]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: We have now concluded the upgrade process for worker nodes. After the upgrade
    process, please make sure you use the `kubectl get nodes` command to make sure
    all the nodes have the `ready` status.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: 我们现在已经完成了工作节点的升级过程。在升级完成后，请确保使用`kubectl get nodes`命令，确保所有节点的状态为`ready`。
- en: Working with etcd
  id: totrans-93
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 与etcd协作
- en: Cluster data is stored in a key-value store in a Kubernetes cluster called etcd.
    The cluster data includes cluster state information such as pod state data, node
    state data, and configurations. As this data is critical for Kubernetes to orchestrate
    the workloads to the desired state, it stands to reason that it should be backed
    up periodically.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 集群数据存储在Kubernetes集群中的一个键值存储etcd中。集群数据包括集群状态信息，例如Pod状态数据、节点状态数据和配置。由于这些数据对于Kubernetes将工作负载编排到期望的状态至关重要，因此合理的做法是定期备份这些数据。
- en: 'To access the etcd cluster inside the Kubernetes cluster, we can run the following
    command:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: 要访问Kubernetes集群中的etcd集群，我们可以运行以下命令：
- en: '[PRE18]'
  id: totrans-96
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'This will list all the pods currently running in the `kube-system` namespace:'
  id: totrans-97
  prefs: []
  type: TYPE_NORMAL
  zh: 这将列出当前在`kube-system`命名空间中运行的所有Pod：
- en: '![Figure 3.7 – Check the current etcd pod status ](img/Figure_3.07_B18201.jpg)'
  id: totrans-98
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.7 – 检查当前etcd Pod状态](img/Figure_3.07_B18201.jpg)'
- en: Figure 3.7 – Check the current etcd pod status
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.7 – 检查当前etcd Pod状态
- en: In the following sections, we’ll take a closer look at the etcd cluster pod
    and learn all the related information that will be useful in the actual CKA exam.
  id: totrans-100
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的章节中，我们将更详细地了解etcd集群Pod，并学习所有与实际CKA考试中有用的相关信息。
- en: Exploring the ETCD cluster pod
  id: totrans-101
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 探索ETCD集群Pod
- en: 'To get a closer look at the etcd pod that we have, use the following command:'
  id: totrans-102
  prefs: []
  type: TYPE_NORMAL
  zh: 要更详细地查看我们当前的etcd Pod，请使用以下命令：
- en: '[PRE19]'
  id: totrans-103
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'For example, to get detailed information for an etcd pod called `etcd-cloudmelonplaysrv`,
    the command would be as follows:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，要获取名为`etcd-cloudmelonplaysrv`的etcd Pod的详细信息，命令如下：
- en: '[PRE20]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'It returns the following output:'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: 它返回以下输出：
- en: '![Figure 3.8 – Check the current etcd pod  ](img/Figure_3.08_B18201.jpg)'
  id: totrans-107
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.8 – 检查当前etcd Pod](img/Figure_3.08_B18201.jpg)'
- en: Figure 3.8 – Check the current etcd pod
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.8 – 检查当前etcd Pod
- en: 'In the figure, you can see the following important information about etcd:'
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 在图中，你可以看到关于etcd的以下重要信息：
- en: '[PRE21]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Among all the configurable parameters, the following will come in handy in
    your daily work with etcd:'
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 在所有可配置参数中，以下几项在你与etcd的日常工作中会非常有用：
- en: '`--advertise-client-urls` tells etcd to accept incoming requests from the clients.
    It accepts a list of URLs.'
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--advertise-client-urls`告诉etcd接受来自客户端的请求。它接受一个URL列表。'
- en: '`--cert-file` is where we specify the client server `TLS cert` file path.'
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--cert-file` 是我们指定客户端服务器 `TLS cert` 文件路径的地方。'
- en: '`--key-file` is where we specify the client server `TLS key` file path.'
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--key-file` 是我们指定客户端服务器 `TLS key` 文件路径的地方。'
- en: '`- -trusted-ca-file` is where we specify the client server `TLS trusted CA
    cert` file path.'
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--trusted-ca-file` 是我们指定客户端服务器 `TLS trusted CA cert` 文件路径的地方。'
- en: These are key flags that will authenticate your request from the client with
    secure communication. You will need them to check the etcd status, backup, and
    restore etcd cluster.
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 这些是用于通过安全通信验证客户端请求的关键标志。您需要它们来检查 etcd 状态、备份和恢复 etcd 集群。
- en: Important Note
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: 重要提示
- en: Access to etcd is equivalent to getting root permission in the cluster. We make
    sure the authentication request is only going through the API server.
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 访问 etcd 相当于获得集群中的 root 权限。我们确保身份验证请求仅通过 API 服务器进行。
- en: To know more about other configurable parameters, please check out [https://etcd.io/docs/v3.5/op-guide/configuration/](https://etcd.io/docs/v3.5/op-guide/configuration/).
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 要了解更多可配置的参数，请访问 [https://etcd.io/docs/v3.5/op-guide/configuration/](https://etcd.io/docs/v3.5/op-guide/configuration/)。
- en: Listing etcd cluster members
  id: totrans-120
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 列出 etcd 集群成员
- en: 'With the information that we acquired from the `kubectl describe pod` command,
    we can list the members of the etcd cluster:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 使用从 `kubectl describe pod` 命令获取的信息，我们可以列出 etcd 集群的成员：
- en: '[PRE22]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'It returns the information about members. In our case, we have only one result
    because we are working with a single master node. Our command will look like the
    following:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 它返回关于成员的信息。在我们的例子中，由于我们只使用一个主节点，因此只会有一个结果。我们的命令将如下所示：
- en: '[PRE23]'
  id: totrans-124
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: The output describes columns such as `ID` and `Status` of the etcd cluster,
    the etcd cluster name, and the peer and client address.
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 输出描述了诸如 `ID` 和 `Status` 等列，这些列显示了 etcd 集群的状态、集群名称、对等节点和客户端地址。
- en: 'You can form the output automatically in tabular form with `--write-out=table`.
    It will look like this:'
  id: totrans-126
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用 `--write-out=table` 自动将输出以表格形式呈现。它将看起来像这样：
- en: '![Figure 3.9 – The current etcd member list  ](img/Figure_3.09_B18201.jpg)'
  id: totrans-127
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.9 – 当前的 etcd 成员列表](img/Figure_3.09_B18201.jpg)'
- en: Figure 3.9 – The current etcd member list
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.9 – 当前的 etcd 成员列表
- en: Notice that the client address is the same as the value of the `--advertise-client-urls`
    URL in the output of `kubectl describe pod`.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，客户端地址与 `kubectl describe pod` 输出中的 `--advertise-client-urls` URL 的值相同。
- en: Checking the etcd cluster status
  id: totrans-130
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 检查 etcd 集群状态
- en: 'You can use the following command to check the etcd cluster status and write
    the output in tabular form. Note that using the correct etcdctl API version, we’re
    on API version 3 in the following example:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以使用以下命令来检查 etcd 集群状态并以表格形式输出结果。请注意，在使用正确的 etcdctl API 版本时，以下示例中我们使用的是 API
    版本 3：
- en: '[PRE24]'
  id: totrans-132
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'The following command is used to access an etcd pod from the Kubernetes cluster
    and check out the status of the etcd pod in the multi-node etcd cluster:'
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 以下命令用于从 Kubernetes 集群访问 etcd pod，并查看多节点 etcd 集群中 etcd pod 的状态：
- en: '[PRE25]'
  id: totrans-134
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'You can use the information that you acquired from `etcdctl member list` in
    this command:'
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在以下命令中使用从`etcdctl member list`获取的信息：
- en: '`ETCDCTL_API` is the etcdctl version.'
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`ETCDCTL_API` 是 etcdctl 的版本。'
- en: '`- - endpoints` are the client addresses of your etcd members if you have multiple
    master nodes.'
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--endpoints` 是您的 etcd 成员的客户端地址，如果您有多个主节点的话。'
- en: 'In this chapter, however, we are showing off a single master node and it contains
    only one etcd member. Therefore, this command to access an etcd pod called `etcd-cloudmelonplaysrv`
    from the Kubernetes cluster and check out the status of the etcd pod will look
    like this:'
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，在本章中，我们展示的是一个单一的主节点，并且它只包含一个 etcd 成员。因此，从 Kubernetes 集群访问名为 `etcd-cloudmelonplaysrv`
    的 etcd pod 并查看其状态的命令将如下所示：
- en: '[PRE26]'
  id: totrans-139
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'It will look like the following output:'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 输出将如下所示：
- en: '![Figure 3.10 – The current etcd member list  ](img/Figure_3.10_B18201.jpg)'
  id: totrans-141
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.10 – 当前的 etcd 成员列表](img/Figure_3.10_B18201.jpg)'
- en: Figure 3.10 – The current etcd member list
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.10 – 当前的 etcd 成员列表
- en: 'From the output of `kubectl describe pod < etcd-podname>`, we also learn that
    we have two `listen client` IPs:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: 从 `kubectl describe pod <etcd-podname>` 的输出中，我们还可以看到我们有两个 `listen client` IP：
- en: '[PRE27]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'As we’re checking the etcd cluster status inside the Kubernetes cluster, we
    can also use the internal endpoint address `https://127.0.0.1:2379` to check the
    etcd cluster status. The following command can be used to access an etcd pod named
    `etcd-cloudmelonplaysrv` from the Kubernetes cluster and check out the status
    of the etcd pod with the internal endpoint:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们检查 Kubernetes 集群内部的 etcd 集群状态时，我们还可以使用内部端点地址`https://127.0.0.1:2379`来检查 etcd
    集群状态。可以使用以下命令访问名为`etcd-cloudmelonplaysrv`的 etcd pod，并使用内部端点检查该 pod 的状态：
- en: '[PRE28]'
  id: totrans-146
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'And it returns the information regarding the etcd cluster:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 它会返回关于 etcd 集群的信息：
- en: '![Figure 3.11 – The current etcd member list  ](img/Figure_3.11_B18201.jpg)'
  id: totrans-148
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.11 – 当前的 etcd 成员列表](img/Figure_3.11_B18201.jpg)'
- en: Figure 3.11 – The current etcd member list
  id: totrans-149
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.11 – 当前的 etcd 成员列表
- en: In the following section, we’ll explore interacting with the etcd cluster from
    the client outside of the Kubernetes cluster.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: 在接下来的章节中，我们将探讨如何从 Kubernetes 集群外部的客户端与 etcd 集群交互。
- en: Installing etcd
  id: totrans-151
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 安装 etcd
- en: To access etcd outside of the Kubernetes cluster, you will need to install etcdctl.
    You can do so by following the instructions in this section. Please note, however,
    that this is not part of the CKA exam.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: 要在 Kubernetes 集群外部访问 etcd，您需要安装 etcdctl。您可以按照本节中的说明进行操作。但请注意，这不属于 CKA 考试的一部分。
- en: 'To get started, we’ll need to get the etcd binary:'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 要开始操作，我们需要获取 etcd 二进制文件：
- en: '[PRE29]'
  id: totrans-154
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'Once you finish the installation, you can use the following command to verify
    the current version:'
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 安装完成后，您可以使用以下命令验证当前版本：
- en: '[PRE30]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'The command returns the current etcdctl client version and the API version
    in the following manner:'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 命令返回当前的 etcdctl 客户端版本和 API 版本，格式如下：
- en: '![Figure 3.12 – Check the current etcdctl version outside of the Kubernetes
    cluster ](img/Figure_3.12_B18201.jpg)'
  id: totrans-158
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.12 – 检查 Kubernetes 集群外部的当前 etcdctl 版本](img/Figure_3.12_B18201.jpg)'
- en: Figure 3.12 – Check the current etcdctl version outside of the Kubernetes cluster
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.12 – 检查 Kubernetes 集群外部的当前 etcdctl 版本
- en: 'Similarly, you can use the following command to check the kubectl version in
    the Kubernetes cluster. When you’re using the `kubectl exec` command, it executes
    directly on the pod named `etcd-cloudmelonplaysrv` located in the `kube-system`
    namespace. We can use the following command to execute the `etcdctl version` Bash
    command to get the version of the etcd store:'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 同样，您可以使用以下命令检查 Kubernetes 集群中的 kubectl 版本。当您使用`kubectl exec`命令时，它会直接在名为`etcd-cloudmelonplaysrv`的
    pod 上执行，该 pod 位于`kube-system`命名空间中。我们可以使用以下命令执行`etcdctl version` Bash 命令，以获取 etcd
    存储的版本：
- en: '[PRE31]'
  id: totrans-161
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'The returned result is similar to the etcdctl client version and the API version:'
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 返回的结果类似于 etcdctl 客户端版本和 API 版本：
- en: '![Figure 3.13 – Check the current etcdctl version in the Kubernetes cluster
    ](img/Figure_3.13_B18201.jpg)'
  id: totrans-163
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.13 – 检查 Kubernetes 集群中的当前 etcdctl 版本](img/Figure_3.13_B18201.jpg)'
- en: Figure 3.13 – Check the current etcdctl version in the Kubernetes cluster
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.13 – 检查 Kubernetes 集群中的当前 etcdctl 版本
- en: 'Similarly, once you have etcdctl installed, you can check the etcd store status
    by running the following command and you’ll get the endpoint status:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 同样，一旦安装了 etcdctl，您可以通过运行以下命令检查 etcd 存储状态，并获取端点状态：
- en: '[PRE32]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: Backing up etcd
  id: totrans-167
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 备份 etcd
- en: 'With all the groundwork we have laid out in the previous sections, we can generalize
    the backup etcd process as follows:'
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 根据我们在前面章节中做的所有准备工作，我们可以将备份 etcd 过程概括如下：
- en: SSH to the etcd cluster node. It could be a separate node or the same as the
    master node. In the CKA exam, it’s likely you’ll be starting in the master node,
    where etcdctl is installed; thus, this step is optional.
  id: totrans-169
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: SSH 进入 etcd 集群节点。它可以是一个独立的节点，也可以与主节点相同。在 CKA 考试中，您很可能会从主节点开始，在该节点上安装了 etcdctl，因此这一步是可选的。
- en: Check out the etcd status. You could acquire the necessary information from
    the `kubectl describe <etcd-podname>` command.
  id: totrans-170
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 检查 etcd 状态。您可以通过`kubectl describe <etcd-podname>`命令获取必要的信息。
- en: Perform the etcd backup.
  id: totrans-171
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 执行 etcd 备份。
- en: Exit the master node. This may not be necessary in the actual CKA exam.
  id: totrans-172
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 退出主节点。在实际的 CKA 考试中，这一步可能不是必需的。
- en: 'The general process is captured in the following diagram:'
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 一般过程如下图所示：
- en: '![Figure 3.14 – Backup etcd process ](img/Figure_3.14_B18201.jpg)'
  id: totrans-174
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.14 – 备份 etcd 过程](img/Figure_3.14_B18201.jpg)'
- en: Figure 3.14 – Backup etcd process
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.14 – 备份 etcd 过程
- en: 'Now let’s look at the detailed process of how to back up etcd:'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 现在让我们看看备份 etcd 的详细过程：
- en: 'If you need to connect to the master node or the etcd cluster node, you can
    use the `ssh master-0` command or the `ssh username@<nodeIP>` command. Please
    note that this step is optional. Following is an example of a user named `packtuser`
    using `ssh` to connect to a node with the IP address `10.10.11.20`:'
  id: totrans-177
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果你需要连接到主节点或etcd集群节点，可以使用`ssh master-0`命令或`ssh username@<nodeIP>`命令。请注意，这一步是可选的。以下是一个名为`packtuser`的用户使用`ssh`连接到IP地址为`10.10.11.20`的节点的示例：
- en: '[PRE33]'
  id: totrans-178
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'Check the etcd status using the following command from outside the cluster:'
  id: totrans-179
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令从集群外部检查etcd状态：
- en: '[PRE34]'
  id: totrans-180
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: 'The output returned will be as follows:'
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 返回的输出将如下所示：
- en: '![Figure 3.15 – Check the etcd status from outside of the cluster ](img/Figure_3.15_B18201.jpg)'
  id: totrans-182
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.15 – 从集群外部检查etcd状态](img/Figure_3.15_B18201.jpg)'
- en: Figure 3.15 – Check the etcd status from outside of the cluster
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.15 – 从集群外部检查etcd状态
- en: 'Back up the etcd cluster using the `etcdctl snapshot save` command. It will
    look like this:'
  id: totrans-184
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`etcdctl snapshot save`命令备份etcd集群。它将像这样：
- en: '[PRE35]'
  id: totrans-185
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'You will need to authenticate from the API server with secure communication
    as you’re backing up from outside the Kubernetes cluster. For this, you can use
    the following command:'
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: 由于你是从Kubernetes集群外部进行备份操作，你需要从API服务器进行身份验证并使用安全通信。为此，你可以使用以下命令：
- en: '[PRE36]'
  id: totrans-187
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'The returned output shows that you have backed up the etcd store successfully:'
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 返回的输出显示你已成功备份了etcd存储：
- en: '![Figure 3.16 – Backup etcd store ](img/Figure_3.16_B18201.jpg)'
  id: totrans-189
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.16 – 备份etcd存储](img/Figure_3.16_B18201.jpg)'
- en: Figure 3.16 – Backup etcd store
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.16 – 备份etcd存储
- en: 'Verify the snapshot via the following command:'
  id: totrans-191
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令验证快照：
- en: '[PRE37]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'The following figure shows the status of the etcd cluster:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 以下图展示了etcd集群的状态：
- en: '![Figure 3.17 – Check the etcd store with the snapshot backup ](img/Figure_3.17_B18201.jpg)'
  id: totrans-194
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.17 – 使用快照备份检查etcd存储](img/Figure_3.17_B18201.jpg)'
- en: Figure 3.17 – Check the etcd store with the snapshot backup
  id: totrans-195
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.17 – 使用快照备份检查etcd存储
- en: Restoring etcd
  id: totrans-196
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 恢复etcd
- en: 'To restore etcd clusters, you can follow the process depicted in *Figure 3.18*.
    Note that if you have any API server instances running, you need to stop them
    before performing the restore operation. You may restart the API server instances
    after the etcd is restored:'
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 要恢复etcd集群，你可以按照*图3.18*中展示的过程进行操作。请注意，如果你有任何API服务器实例正在运行，你需要在执行恢复操作之前停止它们。etcd恢复后，你可以重新启动API服务器实例：
- en: SSH to the etcd cluster node.
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: SSH连接到etcd集群节点。
- en: Check the etcd status.
  id: totrans-199
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 检查etcd状态。
- en: Restore the etcd backup.
  id: totrans-200
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 恢复etcd备份。
- en: 'Exit the master node:'
  id: totrans-201
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 退出主节点：
- en: '![Figure 3.18 – Restore etcd process ](img/Figure_3.18_B18201.jpg)'
  id: totrans-202
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.18 – 恢复etcd过程](img/Figure_3.18_B18201.jpg)'
- en: Figure 3.18 – Restore etcd process
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.18 – 恢复etcd过程
- en: 'Once you have a snapshot present, you can restore etcd from the previous backup
    operation using the following command:'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 一旦你有了快照，你可以使用以下命令从之前的备份操作中恢复etcd：
- en: '[PRE38]'
  id: totrans-205
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'The returned output shows that the etcd store has been restored successfully:'
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 返回的输出显示etcd存储已成功恢复：
- en: '![Figure 3.19 – Restored etcd store with an existing snapshot ](img/Figure_3.19_B18201.jpg)'
  id: totrans-207
  prefs: []
  type: TYPE_IMG
  zh: '![图 3.19 – 使用现有快照恢复的etcd存储](img/Figure_3.19_B18201.jpg)'
- en: Figure 3.19 – Restored etcd store with an existing snapshot
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 图 3.19 – 使用现有快照恢复的etcd存储
- en: You have now completed the etcd restore process.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 你现在已经完成了etcd恢复过程。
- en: Note that this approach can be used if you want to restore the etcd cluster
    from a different patch version. It is important to back up etcd regularly, then
    perform the restore operation to recover the cluster data from a failed cluster.
    To learn more about etcd cluster backup and restore for Kubernetes, please check
    out [https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/).
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，如果你想从不同的补丁版本恢复etcd集群，可以使用此方法。定期备份etcd非常重要，然后执行恢复操作以从失败的集群中恢复集群数据。要了解更多关于Kubernetes的etcd集群备份和恢复，请查看[https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/)。
- en: Summary
  id: totrans-211
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 总结
- en: This chapter covers one of the most common jobs of a Kubernetes administrator
    – that is, maintaining and upgrading Kubernetes clusters. Similar to cluster installation,
    this is also one of the most time-consuming tasks in the CKA exam. Again, practice
    makes perfect. The HA topology for a Kubernetes cluster in [*Chapter 2*](B18201_02.xhtml#_idTextAnchor035)*,
    Installing and Configuring Kubernetes Cluster,* helps you understand what you
    are going to upgrade and how to do it. If needed, go back to [*Chapter 1*](B18201_01.xhtml#_idTextAnchor015)*,
    Kubernetes Overview*, and make sure that you have a good understanding of the
    Kubernetes components. This way, you will know how and what’s needed to upgrade
    the control plane and worker nodes.
  id: totrans-212
  prefs: []
  type: TYPE_NORMAL
  zh: 本章涵盖了 Kubernetes 管理员最常见的工作之一 - 维护和升级 Kubernetes 集群。与集群安装类似，这也是 CKA 考试中最耗时的任务之一。再次强调，熟能生巧。[*第
    2 章*](B18201_02.xhtml#_idTextAnchor035)*，安装和配置 Kubernetes 集群*中的 HA 拓扑将帮助您理解需要升级的内容以及如何执行。如果需要，请回顾[*第
    1 章*](B18201_01.xhtml#_idTextAnchor015)*，Kubernetes 概述*，确保对 Kubernetes 组件有充分的理解。这样，您将知道如何以及需要什么来升级控制平面和工作节点。
- en: Compared to cluster upgrades, backup and restore etcd is one of the best-in-value
    questions in the CKA exam as it is simple to answer with a high-value score. Thoroughly
    practicing what we’ve learned in this chapter will help you overcome any challenges
    in the exam.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 与集群升级相比，备份和恢复 etcd 在 CKA 考试中是价值最高的问题之一，因为回答简单且分数高。彻底练习本章所学内容将帮助您在考试中克服任何挑战。
- en: In the next chapter, we’ll talk about application scheduling and life cycle
    management, where we will revisit some important Kubernetes objects and concepts,
    and touch upon how they play out both in the CKA exam and in real life. Stay tuned!
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 在下一章中，我们将讨论应用程序调度和生命周期管理，我们将重新审视一些重要的 Kubernetes 对象和概念，并探讨它们在 CKA 考试和实际生活中的作用。请继续关注！
- en: Mock CKA scenario-based practice test
  id: totrans-215
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 模拟 CKA 场景实践测试
- en: 'You have two virtual machines, `master-0` and `worker-0`. Please complete the
    following mock scenarios:'
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 您有两台虚拟机，`master-0` 和 `worker-0`。请完成以下模拟场景：
- en: '**Scenario 1**'
  id: totrans-217
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '**场景 1**'
- en: SSH to the `master-0` node, check the current kubeadm version, and upgrade to
    the latest kubeadm version. Check out the current kubectl version, and upgrade
    to the latest kubectl version.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: SSH 到 `master-0` 节点，检查当前 kubeadm 版本，并升级到最新的 kubeadm 版本。检查当前 kubectl 版本，并升级到最新的
    kubectl 版本。
- en: '**Scenario 2**'
  id: totrans-219
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '**场景 2**'
- en: SSH to `worker-0` node, check out the current kubeadm version, and upgrade to
    the latest kubeadm version. Check out the current kubelet version, and upgrade
    to the latest kubelet version.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: SSH 到 `worker-0` 节点，查看当前 kubeadm 版本，并升级到最新的 kubeadm 版本。查看当前 kubelet 版本，并升级到最新的
    kubelet 版本。
- en: '**Scenario 3**'
  id: totrans-221
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '**场景 3**'
- en: SSH to the `master-0` node and back up the etcd store.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: SSH 到 `master-0` 节点并备份 etcd 存储。
- en: '**Scenario 4**'
  id: totrans-223
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: '**场景 4**'
- en: SSH to the `master-0` node and restore the etcd store to the previous backup.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: SSH 到 `master-0` 节点并将 etcd 存储恢复到之前的备份。
- en: You can find all the scenario resolutions in [*Appendix*](B18201_Appendix_A.xhtml#_idTextAnchor386)
    *- Mock CKA scenario-based practice test resolutions* of this book.
  id: totrans-225
  prefs: []
  type: TYPE_NORMAL
  zh: 您可以在本书的[*附录*](B18201_Appendix_A.xhtml#_idTextAnchor386)*- 模拟 CKA 场景实践测试解决方案*中找到所有场景的解决方法。
- en: FAQs
  id: totrans-226
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 常见问题解答
- en: '*Where can I find out about the compatible version of Kubernetes components
    with each release?*'
  id: totrans-227
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '*我在哪里可以找到每个发布版本的 Kubernetes 组件的兼容版本信息？*'
- en: 'Go to the Kubernetes official documentation to learn about the version skew
    policy: [https://kubernetes.io/releases/version-skew-policy/](https://kubernetes.io/releases/version-skew-policy/).'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 前往 Kubernetes 官方文档了解版本偏差策略：[https://kubernetes.io/releases/version-skew-policy/](https://kubernetes.io/releases/version-skew-policy/)。
- en: '*Where can I learn about the latest developments of the etcd store?*'
  id: totrans-229
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '*我在哪里可以了解 etcd 存储的最新发展？*'
- en: 'Go to [https://etcd.io/](https://etcd.io/), where you will find the latest
    developments of the etcd store. For daemons and guidance on how to get started
    with etcd, please go to the official documentation: [https://etcd.io/docs/](https://etcd.io/docs/).'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 前往 [https://etcd.io/](https://etcd.io/)，您将找到 etcd 存储的最新发展。有关守护程序和如何开始使用 etcd，请参阅官方文档：[https://etcd.io/docs/](https://etcd.io/docs/)。
- en: '*What is a recommended official Kubernetes article for upgrading a Kubernetes
    cluster?*'
  id: totrans-231
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '*升级 Kubernetes 集群的推荐官方 Kubernetes 文章是什么？*'
- en: 'I recommend bookmarking the article *Upgrading the kubeadm*, where you will
    find most key commands and processes: [https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/).'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 我建议将文章*《升级 kubeadm》*添加到书签中，在其中你将找到大部分关键命令和过程：[https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/)。
- en: '*What is a recommended official Kubernetes article for backup and restore etcd?*'
  id: totrans-233
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '*备份和恢复 etcd 的官方推荐 Kubernetes 文章是什么？*'
- en: 'I recommend bookmarking the article *Operating etcd clusters for Kubernetes*,
    where you will find all the key commands for etcd backup and restore: [https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/).'
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 我建议将文章*《为 Kubernetes 操作 etcd 集群》*添加到书签中，在其中你将找到所有关于 etcd 备份和恢复的关键命令：[https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/](https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/)。
- en: 'Part 2: Managing Kubernetes'
  id: totrans-235
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第 2 部分：Kubernetes 管理
- en: This part describes how to manage workloads deployed on top of Kubernetes, and
    how to manage the security and networking of Kubernetes clusters to fulfil enterprise
    requirements.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 本部分描述了如何管理部署在 Kubernetes 上的工作负载，以及如何管理 Kubernetes 集群的安全性和网络，以满足企业需求。
- en: 'This part of the book comprises the following chapters:'
  id: totrans-237
  prefs: []
  type: TYPE_NORMAL
  zh: 本书的这一部分包括以下章节：
- en: '[*Chapter 4*](B18201_04.xhtml#_idTextAnchor080)*, Application Scheduling and
    Lifecycle Management*'
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[*第 4 章*](B18201_04.xhtml#_idTextAnchor080)*, 应用调度与生命周期管理*'
- en: '[*Chapter 5*](B18201_05.xhtml#_idTextAnchor149)*, Demystifying Kubernetes Storage*'
  id: totrans-239
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[*第 5 章*](B18201_05.xhtml#_idTextAnchor149)*, 揭开 Kubernetes 存储的面纱*'
- en: '[*Chapter 6*](B18201_06.xhtml#_idTextAnchor192)*, Securing Kubernetes*'
  id: totrans-240
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[*第 6 章*](B18201_06.xhtml#_idTextAnchor192)*, Kubernetes 安全性*'
- en: '[*Chapter 7*](B18201_07.xhtml#_idTextAnchor235)*, Demystifying Kubernetes Networking*'
  id: totrans-241
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[*第 7 章*](B18201_07.xhtml#_idTextAnchor235)*, 揭开 Kubernetes 网络的面纱*'
